<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : Crypto.Cipher.Types.GF</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD-style</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Vincent Hanquez &lt;vincent@snarc.org&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : Stable</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : Excellent</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Slow Galois Field arithmetic for generic XTS and GCM implementation</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Crypto.Cipher.Types.GF
    (
    </span><span class="hl_comment"><span class="mpre">-- * XTS support</span></span><span class="mpre">
      xtsGFMul
    ) where

import Control.Applicative
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/crypto-cipher-types-0.0.9/Crypto/Cipher/Types/GF.hs&quot;, srcSpanStartLine = 17, srcSpanStartColumn = 8, srcSpanEndLine = 17, srcSpanEndColumn = 23}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre"> (ByteString)
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/crypto-cipher-types-0.0.9/Crypto/Cipher/Types/GF.hs&quot;, srcSpanStartLine = 18, srcSpanStartColumn = 18, srcSpanEndLine = 18, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre"> as B
import qualified Data.ByteString.Internal as B
import Data.Byteable
import Foreign.Storable
import Foreign.Ptr
import Data.Word
import Data.Bits

</span><span class="hl_comment"><span class="mpre">-- block size need to be 128 bits.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- FIXME: add support for big endian.</span></span><span class="mpre">
</span><a href="#loc_30_1_30_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_1_30_9&#39;)"><span class="mpre">xtsGFMul</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">
</span><a name="loc_30_1_30_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_1_30_9&#39;)"><span class="hl_fundecl"><span class="mpre">xtsGFMul</span></span></a><span class="mpre"> </span><a name="loc_30_10_30_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_10_30_11&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">
    | </span><span class="hl_varref"><span class="mpre">B.length</span></span><span class="mpre"> </span><a href="#loc_30_10_30_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_10_30_11&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">16</span></span><span class="mpre"> = </span><a href="Data.ByteString.Internal.html#loc_411_1_411_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_411_1_411_13&#39;)"><span class="hl_varref"><span class="mpre">B.unsafeCreate</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">B.length</span></span><span class="mpre"> </span><a href="#loc_30_10_30_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_10_30_11&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_31_57_31_60" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_31_57_31_60&#39;)"><span class="hl_vardecl"><span class="mpre">dst</span></span></a><span class="mpre"> -&gt;
                         </span><a href="Data.Byteable.html#loc_31_5_31_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Byteable.html#loc_31_5_31_16&#39;)"><span class="hl_varref"><span class="mpre">withBytePtr</span></span></a><span class="mpre"> </span><a href="#loc_30_10_30_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_10_30_11&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_32_43_32_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_32_43_32_46&#39;)"><span class="hl_vardecl"><span class="mpre">src</span></span></a><span class="mpre"> -&gt; do
                         (</span><a name="loc_33_27_33_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_33_27_33_29&#39;)"><span class="hl_vardecl"><span class="mpre">hi</span></span></a><span class="mpre">,</span><a name="loc_33_30_33_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_33_30_33_32&#39;)"><span class="hl_vardecl"><span class="mpre">lo</span></span></a><span class="mpre">) &lt;- </span><a href="#loc_38_9_38_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_9_38_11&#39;)"><span class="hl_varref"><span class="mpre">gf</span></span></a><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">peek</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_32_43_32_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_32_43_32_46&#39;)"><span class="hl_varref"><span class="mpre">src</span></span></a><span class="mpre">) </span><a href="Control.Applicative.html#loc_118_5_118_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_118_5_118_10&#39;)"><span class="hl_infix"><span class="mpre">&lt;*&gt;</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">peek</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_32_43_32_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_32_43_32_46&#39;)"><span class="hl_varref"><span class="mpre">src</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">8</span></span><span class="mpre">)
                         </span><span class="hl_varref"><span class="mpre">poke</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_31_57_31_60" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_31_57_31_60&#39;)"><span class="hl_varref"><span class="mpre">dst</span></span></a><span class="mpre">) </span><a href="#loc_33_30_33_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_33_30_33_32&#39;)"><span class="hl_varref"><span class="mpre">lo</span></span></a><span class="mpre">
                         </span><span class="hl_varref"><span class="mpre">poke</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_31_57_31_60" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_31_57_31_60&#39;)"><span class="hl_varref"><span class="mpre">dst</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">8</span></span><span class="mpre">) </span><a href="#loc_33_27_33_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_33_27_33_29&#39;)"><span class="hl_varref"><span class="mpre">hi</span></span></a><span class="mpre">
    | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">        = </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;unsupported block size in GF&quot;</span></span><span class="mpre">
  where </span><a href="#loc_38_9_38_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_9_38_11&#39;)"><span class="mpre">gf</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Word64</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Word64</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">Word64</span></span><span class="mpre">, </span><span class="hl_tyconref"><span class="mpre">Word64</span></span><span class="mpre">)
        </span><a name="loc_38_9_38_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_9_38_11&#39;)"><span class="hl_fundecl"><span class="mpre">gf</span></span></a><span class="mpre"> </span><a name="loc_38_12_38_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_12_38_17&#39;)"><span class="hl_vardecl"><span class="mpre">srcLo</span></span></a><span class="mpre"> </span><a name="loc_38_18_38_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_18_38_23&#39;)"><span class="hl_vardecl"><span class="mpre">srcHi</span></span></a><span class="mpre"> =
            ((if </span><a href="#loc_43_17_43_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_43_17_43_24&#39;)"><span class="hl_varref"><span class="mpre">carryLo</span></span></a><span class="mpre"> then (</span><span class="hl_infix"><span class="mpre">.|.</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">) else </span><span class="hl_varref"><span class="mpre">id</span></span><span class="mpre">) (</span><a href="#loc_38_18_38_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_18_38_23&#39;)"><span class="hl_varref"><span class="mpre">srcHi</span></span></a><span class="mpre"> </span><a href="Data.Bits.html#loc_200_5_200_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Bits.html#loc_200_5_200_11&#39;)"><span class="hl_infix"><span class="mpre">`shiftL`</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
            ,(if </span><a href="#loc_42_17_42_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_17_42_24&#39;)"><span class="hl_varref"><span class="mpre">carryHi</span></span></a><span class="mpre"> then </span><a href="Data.Bits.html#loc_87_5_87_8" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Bits.html#loc_87_5_87_8&#39;)"><span class="hl_varref"><span class="mpre">xor</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0x87</span></span><span class="mpre"> else </span><span class="hl_varref"><span class="mpre">id</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> (</span><a href="#loc_38_12_38_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_12_38_17&#39;)"><span class="hl_varref"><span class="mpre">srcLo</span></span></a><span class="mpre"> </span><a href="Data.Bits.html#loc_200_5_200_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Bits.html#loc_200_5_200_11&#39;)"><span class="hl_infix"><span class="mpre">`shiftL`</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
            )
          where </span><a name="loc_42_17_42_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_17_42_24&#39;)"><span class="hl_vardecl"><span class="mpre">carryHi</span></span></a><span class="mpre"> = </span><a href="#loc_38_18_38_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_18_38_23&#39;)"><span class="hl_varref"><span class="mpre">srcHi</span></span></a><span class="mpre"> </span><a href="Data.Bits.html#loc_167_5_167_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Bits.html#loc_167_5_167_12&#39;)"><span class="hl_infix"><span class="mpre">`testBit`</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">63</span></span><span class="mpre"> 
                </span><a name="loc_43_17_43_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_43_17_43_24&#39;)"><span class="hl_vardecl"><span class="mpre">carryLo</span></span></a><span class="mpre"> = </span><a href="#loc_38_12_38_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_12_38_17&#39;)"><span class="hl_varref"><span class="mpre">srcLo</span></span></a><span class="mpre"> </span><a href="Data.Bits.html#loc_167_5_167_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Bits.html#loc_167_5_167_12&#39;)"><span class="hl_infix"><span class="mpre">`testBit`</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">63</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">{-
        const uint64_t gf_mask = cpu_to_le64(0x8000000000000000ULL);
        uint64_t r = ((a-&gt;q[1] &amp; gf_mask) ? cpu_to_le64(0x87) : 0);
        a-&gt;q[1] = cpu_to_le64((le64_to_cpu(a-&gt;q[1]) &lt;&lt; 1) | (a-&gt;q[0] &amp; gf_mask ? 1 : 0));
        a-&gt;q[0] = cpu_to_le64(le64_to_cpu(a-&gt;q[0]) &lt;&lt; 1) ^ r;
-}</span></span><span class="mpre">
</span></div></body></html>