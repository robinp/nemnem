<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : Network.TLS.Sending</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD-style</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Vincent Hanquez &lt;vincent@snarc.org&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : unknown</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the Sending module contains calls related to marshalling packets according</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to the TLS state </span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Network.TLS.Sending (writePacket) where

import Control.Applicative
import Control.Monad.State
import Control.Concurrent.MVar
import Data.IORef

import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Sending.hs&quot;, srcSpanStartLine = 18, srcSpanStartColumn = 8, srcSpanEndLine = 18, srcSpanEndColumn = 23}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre"> (ByteString)
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Sending.hs&quot;, srcSpanStartLine = 19, srcSpanStartColumn = 18, srcSpanEndLine = 19, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre"> as B

import Network.TLS.Types (</span><a href="Network.TLS.Types.html#loc_44_6_44_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_44_6_44_10&#39;)"><span class="mpre">Role</span></a><span class="mpre">(..))
import Network.TLS.Cap
import Network.TLS.Struct
import Network.TLS.Record
import Network.TLS.Packet
import Network.TLS.Context.Internal
import Network.TLS.Parameters
import Network.TLS.State
import Network.TLS.Handshake.State
import Network.TLS.Cipher
import Network.TLS.Util

</span><span class="hl_comment"><span class="mpre">-- | &#39;makePacketData&#39; create a Header and a content bytestring related to a packet</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- this doesn&#39;t change any state</span></span><span class="mpre">
</span><a href="#loc_36_1_36_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_1_36_11&#39;)"><span class="mpre">makeRecord</span></a><span class="mpre"> :: </span><a href="Network.TLS.Struct.html#loc_150_6_150_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_150_6_150_12&#39;)"><span class="hl_tyconref"><span class="mpre">Packet</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Record.State.html#loc_57_9_57_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_57_9_57_16&#39;)"><span class="hl_tyconref"><span class="mpre">RecordM</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Record.Types.html#loc_47_6_47_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_47_6_47_12&#39;)"><span class="hl_tyconref"><span class="mpre">Record</span></span></a><span class="mpre"> </span><a href="Network.TLS.Record.Types.html#loc_51_6_51_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_51_6_51_15&#39;)"><span class="hl_tyconref"><span class="mpre">Plaintext</span></span></a><span class="mpre">)
</span><a name="loc_36_1_36_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_1_36_11&#39;)"><span class="hl_fundecl"><span class="mpre">makeRecord</span></span></a><span class="mpre"> </span><a name="loc_36_12_36_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_12_36_15&#39;)"><span class="hl_vardecl"><span class="mpre">pkt</span></span></a><span class="mpre"> = do
    </span><a name="loc_37_5_37_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_5_37_8&#39;)"><span class="hl_vardecl"><span class="mpre">ver</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Record.State.html#loc_79_1_79_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_79_1_79_17&#39;)"><span class="hl_varref"><span class="mpre">getRecordVersion</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Record</span></span><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_267_1_267_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_267_1_267_11&#39;)"><span class="hl_varref"><span class="mpre">packetType</span></span></a><span class="mpre"> </span><a href="#loc_36_12_36_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_12_36_15&#39;)"><span class="hl_varref"><span class="mpre">pkt</span></span></a><span class="mpre">) </span><a href="#loc_37_5_37_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_5_37_8&#39;)"><span class="hl_varref"><span class="mpre">ver</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Record.Types.html#loc_56_1_56_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_56_1_56_18&#39;)"><span class="hl_varref"><span class="mpre">fragmentPlaintext</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_39_9_39_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_9_39_27&#39;)"><span class="hl_varref"><span class="mpre">writePacketContent</span></span></a><span class="mpre"> </span><a href="#loc_36_12_36_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_12_36_15&#39;)"><span class="hl_varref"><span class="mpre">pkt</span></span></a><span class="mpre">)
  where </span><a name="loc_39_9_39_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_9_39_27&#39;)"><span class="hl_fundecl"><span class="mpre">writePacketContent</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_151_7_151_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_151_7_151_16&#39;)"><span class="hl_conref"><span class="mpre">Handshake</span></span></a><span class="mpre"> </span><a name="loc_39_39_39_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_39_39_42&#39;)"><span class="hl_vardecl"><span class="mpre">hss</span></span></a><span class="mpre">)    = </span><a href="Network.TLS.Packet.html#loc_335_1_335_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Packet.html#loc_335_1_335_17&#39;)"><span class="hl_varref"><span class="mpre">encodeHandshakes</span></span></a><span class="mpre"> </span><a href="#loc_39_39_39_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_39_39_42&#39;)"><span class="hl_varref"><span class="mpre">hss</span></span></a><span class="mpre">
        </span><a href="#loc_39_9_39_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_9_39_27&#39;)"><span class="hl_fundecl"><span class="mpre">writePacketContent</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_152_7_152_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_152_7_152_12&#39;)"><span class="hl_conref"><span class="mpre">Alert</span></span></a><span class="mpre"> </span><a name="loc_40_35_40_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_40_35_40_36&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre">)          = </span><a href="Network.TLS.Packet.html#loc_158_1_158_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Packet.html#loc_158_1_158_13&#39;)"><span class="hl_varref"><span class="mpre">encodeAlerts</span></span></a><span class="mpre"> </span><a href="#loc_40_35_40_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_40_35_40_36&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">
        </span><a href="#loc_39_9_39_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_9_39_27&#39;)"><span class="hl_fundecl"><span class="mpre">writePacketContent</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_153_7_153_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_153_7_153_23&#39;)"><span class="hl_conref"><span class="mpre">ChangeCipherSpec</span></span></a><span class="mpre">) = </span><a href="Network.TLS.Packet.html#loc_489_1_489_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Packet.html#loc_489_1_489_23&#39;)"><span class="hl_varref"><span class="mpre">encodeChangeCipherSpec</span></span></a><span class="mpre">
        </span><a href="#loc_39_9_39_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_9_39_27&#39;)"><span class="hl_fundecl"><span class="mpre">writePacketContent</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_154_7_154_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_154_7_154_14&#39;)"><span class="hl_conref"><span class="mpre">AppData</span></span></a><span class="mpre"> </span><a name="loc_42_37_42_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_37_42_38&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre">)        = </span><a href="#loc_42_37_42_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_37_42_38&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | marshall packet data</span></span><span class="mpre">
</span><a href="#loc_46_1_46_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_13&#39;)"><span class="mpre">encodeRecord</span></a><span class="mpre"> :: </span><a href="Network.TLS.Record.Types.html#loc_47_6_47_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_47_6_47_12&#39;)"><span class="hl_tyconref"><span class="mpre">Record</span></span></a><span class="mpre"> </span><a href="Network.TLS.Record.Types.html#loc_53_6_53_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_53_6_53_16&#39;)"><span class="hl_tyconref"><span class="mpre">Ciphertext</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Record.State.html#loc_57_9_57_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_57_9_57_16&#39;)"><span class="hl_tyconref"><span class="mpre">RecordM</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">
</span><a name="loc_46_1_46_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_13&#39;)"><span class="hl_fundecl"><span class="mpre">encodeRecord</span></span></a><span class="mpre"> </span><a name="loc_46_14_46_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_14_46_20&#39;)"><span class="hl_vardecl"><span class="mpre">record</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">B.concat</span></span><span class="mpre"> [ </span><a href="Network.TLS.Packet.html#loc_130_1_130_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Packet.html#loc_130_1_130_13&#39;)"><span class="hl_varref"><span class="mpre">encodeHeader</span></span></a><span class="mpre"> </span><a href="#loc_47_10_47_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_10_47_13&#39;)"><span class="hl_varref"><span class="mpre">hdr</span></span></a><span class="mpre">, </span><a href="#loc_47_15_47_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_15_47_22&#39;)"><span class="hl_varref"><span class="mpre">content</span></span></a><span class="mpre"> ]
  where (</span><a name="loc_47_10_47_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_10_47_13&#39;)"><span class="hl_vardecl"><span class="mpre">hdr</span></span></a><span class="mpre">, </span><a name="loc_47_15_47_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_15_47_22&#39;)"><span class="hl_vardecl"><span class="mpre">content</span></span></a><span class="mpre">) = </span><a href="Network.TLS.Record.Types.html#loc_88_1_88_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_88_1_88_12&#39;)"><span class="hl_varref"><span class="mpre">recordToRaw</span></span></a><span class="mpre"> </span><a href="#loc_46_14_46_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_14_46_20&#39;)"><span class="hl_varref"><span class="mpre">record</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | writePacket transform a packet into marshalled data related to current state</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- and updating state on the go</span></span><span class="mpre">
</span><a href="#loc_52_1_52_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_1_52_12&#39;)"><span class="mpre">writePacket</span></a><span class="mpre"> :: </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Struct.html#loc_150_6_150_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_150_6_150_12&#39;)"><span class="hl_tyconref"><span class="mpre">Packet</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Either</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_121_6_121_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_121_6_121_14&#39;)"><span class="hl_tyconref"><span class="mpre">TLSError</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">)
</span><a name="loc_52_1_52_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_1_52_12&#39;)"><span class="hl_fundecl"><span class="mpre">writePacket</span></span></a><span class="mpre"> </span><a name="loc_52_13_52_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_13_52_16&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a name="loc_52_17_52_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_17_52_20&#39;)"><span class="hl_specname"><span class="mpre">pkt</span></span></a><span class="mpre">@(</span><a href="Network.TLS.Struct.html#loc_151_7_151_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_151_7_151_16&#39;)"><span class="hl_conref"><span class="mpre">Handshake</span></span></a><span class="mpre"> </span><a name="loc_52_32_52_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_32_52_35&#39;)"><span class="hl_vardecl"><span class="mpre">hss</span></span></a><span class="mpre">) = do
    </span><a href="Control.Monad.html#loc_168_1_168_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_168_1_168_6&#39;)"><span class="hl_varref"><span class="mpre">forM_</span></span></a><span class="mpre"> </span><a href="#loc_52_32_52_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_32_52_35&#39;)"><span class="hl_varref"><span class="mpre">hss</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_53_18_53_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_18_53_20&#39;)"><span class="hl_vardecl"><span class="mpre">hs</span></span></a><span class="mpre"> -&gt; do
        case </span><a href="#loc_53_18_53_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_18_53_20&#39;)"><span class="hl_varref"><span class="mpre">hs</span></span></a><span class="mpre"> of
            </span><a href="Network.TLS.Struct.html#loc_262_7_262_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_262_7_262_15&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre"> </span><a name="loc_55_22_55_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_22_55_27&#39;)"><span class="hl_vardecl"><span class="mpre">fdata</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_52_13_52_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_13_52_16&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.State.html#loc_108_1_108_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_108_1_108_19&#39;)"><span class="hl_varref"><span class="mpre">updateVerifiedData</span></span></a><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_44_13_44_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_44_13_44_23&#39;)"><span class="hl_conref"><span class="mpre">ClientRole</span></span></a><span class="mpre"> </span><a href="#loc_55_22_55_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_22_55_27&#39;)"><span class="hl_varref"><span class="mpre">fdata</span></span></a><span class="mpre">
            _              -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
        let </span><a name="loc_57_13_57_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_57_13_57_20&#39;)"><span class="hl_vardecl"><span class="mpre">encoded</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Packet.html#loc_326_1_326_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Packet.html#loc_326_1_326_16&#39;)"><span class="hl_varref"><span class="mpre">encodeHandshake</span></span></a><span class="mpre"> </span><a href="#loc_53_18_53_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_18_53_20&#39;)"><span class="hl_varref"><span class="mpre">hs</span></span></a><span class="mpre">
        </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_52_13_52_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_13_52_16&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
            </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><a href="Network.TLS.State.html#loc_144_1_144_28" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_144_1_144_28&#39;)"><span class="hl_varref"><span class="mpre">certVerifyHandshakeMaterial</span></span></a><span class="mpre"> </span><a href="#loc_53_18_53_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_18_53_20&#39;)"><span class="hl_varref"><span class="mpre">hs</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_166_1_166_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_166_1_166_20&#39;)"><span class="hl_varref"><span class="mpre">addHandshakeMessage</span></span></a><span class="mpre"> </span><a href="#loc_57_13_57_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_57_13_57_20&#39;)"><span class="hl_varref"><span class="mpre">encoded</span></span></a><span class="mpre">
            </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><a href="Network.TLS.State.html#loc_115_1_115_28" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_115_1_115_28&#39;)"><span class="hl_varref"><span class="mpre">finishHandshakeTypeMaterial</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_273_1_273_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_273_1_273_16&#39;)"><span class="hl_varref"><span class="mpre">typeOfHandshake</span></span></a><span class="mpre"> </span><a href="#loc_53_18_53_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_18_53_20&#39;)"><span class="hl_varref"><span class="mpre">hs</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_172_1_172_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_172_1_172_22&#39;)"><span class="hl_varref"><span class="mpre">updateHandshakeDigest</span></span></a><span class="mpre"> </span><a href="#loc_57_13_57_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_57_13_57_20&#39;)"><span class="hl_varref"><span class="mpre">encoded</span></span></a><span class="mpre">
    </span><a href="#loc_70_1_70_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_1_70_14&#39;)"><span class="hl_varref"><span class="mpre">prepareRecord</span></span></a><span class="mpre"> </span><a href="#loc_52_13_52_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_13_52_16&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="#loc_36_1_36_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_1_36_11&#39;)"><span class="hl_varref"><span class="mpre">makeRecord</span></span></a><span class="mpre"> </span><a href="#loc_52_17_52_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_17_52_20&#39;)"><span class="hl_varref"><span class="mpre">pkt</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="Network.TLS.Record.Engage.html#loc_27_1_27_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Engage.html#loc_27_1_27_13&#39;)"><span class="hl_varref"><span class="mpre">engageRecord</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_46_1_46_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_13&#39;)"><span class="hl_varref"><span class="mpre">encodeRecord</span></span></a><span class="mpre">)
</span><a href="#loc_52_1_52_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_1_52_12&#39;)"><span class="hl_fundecl"><span class="mpre">writePacket</span></span></a><span class="mpre"> </span><a name="loc_62_13_62_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_13_62_16&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a name="loc_62_17_62_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_17_62_20&#39;)"><span class="hl_vardecl"><span class="mpre">pkt</span></span></a><span class="mpre"> = do
    </span><a name="loc_63_5_63_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_5_63_6&#39;)"><span class="hl_vardecl"><span class="mpre">d</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_70_1_70_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_1_70_14&#39;)"><span class="hl_varref"><span class="mpre">prepareRecord</span></span></a><span class="mpre"> </span><a href="#loc_62_13_62_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_13_62_16&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="#loc_36_1_36_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_1_36_11&#39;)"><span class="hl_varref"><span class="mpre">makeRecord</span></span></a><span class="mpre"> </span><a href="#loc_62_17_62_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_17_62_20&#39;)"><span class="hl_varref"><span class="mpre">pkt</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="Network.TLS.Record.Engage.html#loc_27_1_27_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Engage.html#loc_27_1_27_13&#39;)"><span class="hl_varref"><span class="mpre">engageRecord</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_46_1_46_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_13&#39;)"><span class="hl_varref"><span class="mpre">encodeRecord</span></span></a><span class="mpre">)
    </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><a href="#loc_62_17_62_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_17_62_20&#39;)"><span class="hl_varref"><span class="mpre">pkt</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_153_7_153_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_153_7_153_23&#39;)"><span class="hl_conref"><span class="mpre">ChangeCipherSpec</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_82_1_82_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_19&#39;)"><span class="hl_varref"><span class="mpre">switchTxEncryption</span></span></a><span class="mpre"> </span><a href="#loc_62_13_62_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_13_62_16&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_63_5_63_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_5_63_6&#39;)"><span class="hl_varref"><span class="mpre">d</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- before TLS 1.1, the block cipher IV is made of the residual of the previous block,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- so we use cstIV as is, however in other case we generate an explicit IV</span></span><span class="mpre">
</span><a href="#loc_70_1_70_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_1_70_14&#39;)"><span class="mpre">prepareRecord</span></a><span class="mpre"> :: </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Record.State.html#loc_57_9_57_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_57_9_57_16&#39;)"><span class="hl_tyconref"><span class="mpre">RecordM</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Either</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_121_6_121_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_121_6_121_14&#39;)"><span class="hl_tyconref"><span class="mpre">TLSError</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_70_1_70_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_1_70_14&#39;)"><span class="hl_fundecl"><span class="mpre">prepareRecord</span></span></a><span class="mpre"> </span><a name="loc_70_15_70_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_18&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a name="loc_70_19_70_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_19_70_20&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = do
    </span><a name="loc_71_5_71_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_5_71_8&#39;)"><span class="hl_vardecl"><span class="mpre">ver</span></span></a><span class="mpre">     &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_70_15_70_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_18&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Network.TLS.State.html#loc_168_1_168_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_168_1_168_22&#39;)"><span class="hl_varref"><span class="mpre">getVersionWithDefault</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">maximum</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Parameters.html#loc_113_7_113_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_113_7_113_24&#39;)"><span class="hl_varref"><span class="mpre">supportedVersions</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_87_7_87_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_87_7_87_19&#39;)"><span class="hl_varref"><span class="mpre">ctxSupported</span></span></a><span class="mpre"> </span><a href="#loc_70_15_70_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_18&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">)
    </span><a name="loc_72_5_72_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_5_72_12&#39;)"><span class="hl_vardecl"><span class="mpre">txState</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.MVar.html#loc_116_1_116_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_116_1_116_9&#39;)"><span class="hl_varref"><span class="mpre">readMVar</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_98_7_98_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_98_7_98_17&#39;)"><span class="hl_varref"><span class="mpre">ctxTxState</span></span></a><span class="mpre"> </span><a href="#loc_70_15_70_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_18&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
    let </span><a name="loc_73_9_73_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_9_73_11&#39;)"><span class="hl_vardecl"><span class="mpre">sz</span></span></a><span class="mpre"> = case </span><span class="hl_varref"><span class="mpre">stCipher</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_72_5_72_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_5_72_12&#39;)"><span class="hl_varref"><span class="mpre">txState</span></span></a><span class="mpre"> of
                  </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">     -&gt; </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
                  </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_75_24_75_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_24_75_30&#39;)"><span class="hl_vardecl"><span class="mpre">cipher</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Cipher.html#loc_56_7_56_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_56_7_56_17&#39;)"><span class="hl_varref"><span class="mpre">bulkIVSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Cipher.html#loc_86_7_86_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_86_7_86_17&#39;)"><span class="hl_varref"><span class="mpre">cipherBulk</span></span></a><span class="mpre"> </span><a href="#loc_75_24_75_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_24_75_30&#39;)"><span class="hl_varref"><span class="mpre">cipher</span></span></a><span class="mpre">
    if </span><a href="Network.TLS.Cap.html#loc_19_1_19_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cap.html#loc_19_1_19_19&#39;)"><span class="hl_varref"><span class="mpre">hasExplicitBlockIV</span></span></a><span class="mpre"> </span><a href="#loc_71_5_71_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_5_71_8&#39;)"><span class="hl_varref"><span class="mpre">ver</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_73_9_73_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_9_73_11&#39;)"><span class="hl_varref"><span class="mpre">sz</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
        then do </span><a name="loc_77_17_77_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_17_77_22&#39;)"><span class="hl_vardecl"><span class="mpre">newIV</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_211_1_211_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_211_1_211_12&#39;)"><span class="hl_varref"><span class="mpre">getStateRNG</span></span></a><span class="mpre"> </span><a href="#loc_70_15_70_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_18&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_73_9_73_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_9_73_11&#39;)"><span class="hl_varref"><span class="mpre">sz</span></span></a><span class="mpre">
                </span><a href="Network.TLS.Context.Internal.html#loc_195_1_195_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_195_1_195_11&#39;)"><span class="hl_varref"><span class="mpre">runTxState</span></span></a><span class="mpre"> </span><a href="#loc_70_15_70_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_18&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Control.Monad.State.Class.html#loc_85_1_85_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.State.Class.html#loc_85_1_85_7&#39;)"><span class="hl_varref"><span class="mpre">modify</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Record.State.html#loc_108_1_108_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_108_1_108_12&#39;)"><span class="hl_varref"><span class="mpre">setRecordIV</span></span></a><span class="mpre"> </span><a href="#loc_77_17_77_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_17_77_22&#39;)"><span class="hl_varref"><span class="mpre">newIV</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><a href="#loc_70_19_70_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_19_70_20&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre">)
        else </span><a href="Network.TLS.Context.Internal.html#loc_195_1_195_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_195_1_195_11&#39;)"><span class="hl_varref"><span class="mpre">runTxState</span></span></a><span class="mpre"> </span><a href="#loc_70_15_70_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_18&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_70_19_70_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_19_70_20&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre">

</span><a href="#loc_82_1_82_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_19&#39;)"><span class="mpre">switchTxEncryption</span></a><span class="mpre"> :: </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_82_1_82_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_19&#39;)"><span class="hl_fundecl"><span class="mpre">switchTxEncryption</span></span></a><span class="mpre"> </span><a name="loc_82_20_82_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_20_82_23&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> = do
    </span><a name="loc_83_5_83_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_5_83_7&#39;)"><span class="hl_vardecl"><span class="mpre">tx</span></span></a><span class="mpre">  &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_82_20_82_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_20_82_23&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Util.html#loc_53_1_53_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Util.html#loc_53_1_53_9&#39;)"><span class="hl_varref"><span class="mpre">fromJust</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;tx-state&quot;</span></span><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><a href="Control.Monad.State.Class.html#loc_95_1_95_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.State.Class.html#loc_95_1_95_5&#39;)"><span class="hl_varref"><span class="mpre">gets</span></span></a><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_76_7_76_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_76_7_76_24&#39;)"><span class="hl_varref"><span class="mpre">hstPendingTxState</span></span></a><span class="mpre">)
    (</span><a name="loc_84_6_84_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_6_84_9&#39;)"><span class="hl_vardecl"><span class="mpre">ver</span></span></a><span class="mpre">, </span><a name="loc_84_11_84_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_11_84_13&#39;)"><span class="hl_vardecl"><span class="mpre">cc</span></span></a><span class="mpre">) &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_82_20_82_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_20_82_23&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do </span><a name="loc_84_39_84_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_39_84_40&#39;)"><span class="hl_vardecl"><span class="mpre">v</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.State.html#loc_165_1_165_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_165_1_165_11&#39;)"><span class="hl_varref"><span class="mpre">getVersion</span></span></a><span class="mpre">
                                      </span><a name="loc_85_39_85_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_39_85_40&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.State.html#loc_204_1_204_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_204_1_204_16&#39;)"><span class="hl_varref"><span class="mpre">isClientContext</span></span></a><span class="mpre">
                                      </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_84_39_84_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_39_84_40&#39;)"><span class="hl_varref"><span class="mpre">v</span></span></a><span class="mpre">, </span><a href="#loc_85_39_85_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_39_85_40&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">)
    </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Control.Concurrent.MVar.html#loc_216_1_216_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.MVar.html#loc_216_1_216_12&#39;)"><span class="hl_varref"><span class="mpre">modifyMVar_</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Context.Internal.html#loc_98_7_98_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_98_7_98_17&#39;)"><span class="hl_varref"><span class="mpre">ctxTxState</span></span></a><span class="mpre"> </span><a href="#loc_82_20_82_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_20_82_23&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">) (\_ -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_83_5_83_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_5_83_7&#39;)"><span class="hl_varref"><span class="mpre">tx</span></span></a><span class="mpre">)
    </span><span class="hl_comment"><span class="mpre">-- set empty packet counter measure if condition are met</span></span><span class="mpre">
    </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><a href="#loc_84_6_84_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_6_84_9&#39;)"><span class="hl_varref"><span class="mpre">ver</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">TLS10</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_84_11_84_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_11_84_13&#39;)"><span class="hl_varref"><span class="mpre">cc</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_44_13_44_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_44_13_44_23&#39;)"><span class="hl_conref"><span class="mpre">ClientRole</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_90_9_90_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_9_90_14&#39;)"><span class="hl_varref"><span class="mpre">isCBC</span></span></a><span class="mpre"> </span><a href="#loc_83_5_83_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_5_83_7&#39;)"><span class="hl_varref"><span class="mpre">tx</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Context.Internal.html#loc_94_7_94_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_94_7_94_25&#39;)"><span class="hl_varref"><span class="mpre">ctxNeedEmptyPacket</span></span></a><span class="mpre"> </span><a href="#loc_82_20_82_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_20_82_23&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">) </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">
  where </span><a name="loc_90_9_90_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_9_90_14&#39;)"><span class="hl_fundecl"><span class="mpre">isCBC</span></span></a><span class="mpre"> </span><a name="loc_90_15_90_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_15_90_17&#39;)"><span class="hl_vardecl"><span class="mpre">tx</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">maybe</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre"> (\</span><a name="loc_90_34_90_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_34_90_35&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Cipher.html#loc_57_7_57_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_57_7_57_20&#39;)"><span class="hl_varref"><span class="mpre">bulkBlockSize</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Cipher.html#loc_86_7_86_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_86_7_86_17&#39;)"><span class="hl_varref"><span class="mpre">cipherBulk</span></span></a><span class="mpre"> </span><a href="#loc_90_34_90_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_34_90_35&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">) (</span><span class="hl_varref"><span class="mpre">stCipher</span></span><span class="mpre"> </span><a href="#loc_90_15_90_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_15_90_17&#39;)"><span class="hl_varref"><span class="mpre">tx</span></span></a><span class="mpre">)
</span></div></body></html>