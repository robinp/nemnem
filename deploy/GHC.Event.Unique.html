<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE Trustworthy #-}
{-# LANGUAGE BangPatterns, GeneralizedNewtypeDeriving, NoImplicitPrelude #-}
module GHC.Event.Unique
    (
      UniqueSource
    , Unique(..)
    , newSource
    , newUnique
    ) where

import Data.Int (Int64)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/Unique.hs&quot;, srcSpanStartLine = 12, srcSpanStartColumn = 8, srcSpanEndLine = 12, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Base&quot;"><span class="mpre">GHC.Base</span></span><span class="mpre">
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/Unique.hs&quot;, srcSpanStartLine = 13, srcSpanStartColumn = 8, srcSpanEndLine = 13, srcSpanEndColumn = 21}, srcInfoPoints = []}) &quot;GHC.Conc.Sync&quot;"><span class="mpre">GHC.Conc.Sync</span></span><span class="mpre"> (TVar, atomically, newTVarIO, readTVar, writeTVar)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/Unique.hs&quot;, srcSpanStartLine = 14, srcSpanStartColumn = 8, srcSpanEndLine = 14, srcSpanEndColumn = 15}, srcInfoPoints = []}) &quot;GHC.Num&quot;"><span class="mpre">GHC.Num</span></span><span class="mpre"> (Num(..))
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/Unique.hs&quot;, srcSpanStartLine = 15, srcSpanStartColumn = 8, srcSpanEndLine = 15, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Show&quot;"><span class="mpre">GHC.Show</span></span><span class="mpre"> (Show(..))

</span><span class="hl_comment"><span class="mpre">-- We used to use IORefs here, but Simon switched us to STM when we</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- found that our use of atomicModifyIORef was subject to a severe RTS</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- performance problem when used in a tight loop from multiple</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- threads: http://hackage.haskell.org/trac/ghc/ticket/3838</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- There seems to be no performance cost to using a TVar instead.</span></span><span class="mpre">

newtype </span><a name="loc_24_9_24_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_24_9_24_21&#39;)"><span class="hl_tycondecl"><span class="mpre">UniqueSource</span></span></a><span class="mpre"> = </span><a name="loc_24_24_24_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_24_24_24_26&#39;)"><span class="hl_condecl"><span class="mpre">US</span></span></a><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">TVar</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Int64</span></span><span class="mpre">)

newtype </span><a name="loc_26_9_26_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_26_9_26_15&#39;)"><span class="hl_tycondecl"><span class="mpre">Unique</span></span></a><span class="mpre"> = </span><a name="loc_26_18_26_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_26_18_26_24&#39;)"><span class="hl_condecl"><span class="mpre">Unique</span></span></a><span class="mpre"> { </span><a name="loc_26_27_26_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_26_27_26_34&#39;)"><span class="hl_fielddecl"><span class="mpre">asInt64</span></span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int64</span></span><span class="mpre"> }
    </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/Unique.hs&quot;, srcSpanStartLine = 27, srcSpanStartColumn = 5, srcSpanEndLine = 27, srcSpanEndColumn = 28}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/Unique.hs&quot;, srcSpanStartLine = 27, srcSpanStartColumn = 5, srcSpanEndLine = 27, srcSpanEndColumn = 13},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/Unique.hs&quot;, srcSpanStartLine = 27, src"><span class="mpre">deriving (Eq, Ord, Num)</span></span><span class="mpre">

instance </span><span class="hl_classref"><span class="mpre">Show</span></span><span class="mpre"> </span><a href="#loc_26_9_26_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_26_9_26_15&#39;)"><span class="hl_tyconref"><span class="mpre">Unique</span></span></a><span class="mpre"> where
    </span><span class="hl_vardecl"><span class="mpre">show</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_26_27_26_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_26_27_26_34&#39;)"><span class="hl_varref"><span class="mpre">asInt64</span></span></a><span class="mpre">

</span><a href="#loc_33_1_33_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_33_1_33_10&#39;)"><span class="mpre">newSource</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_24_9_24_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_24_9_24_21&#39;)"><span class="hl_tyconref"><span class="mpre">UniqueSource</span></span></a><span class="mpre">
</span><a name="loc_33_1_33_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_33_1_33_10&#39;)"><span class="hl_vardecl"><span class="mpre">newSource</span></span></a><span class="mpre"> = </span><a href="#loc_24_24_24_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_24_24_24_26&#39;)"><span class="hl_conref"><span class="mpre">US</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`fmap`</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">newTVarIO</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">

</span><a href="#loc_36_1_36_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_1_36_10&#39;)"><span class="mpre">newUnique</span></a><span class="mpre"> :: </span><a href="#loc_24_9_24_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_24_9_24_21&#39;)"><span class="hl_tyconref"><span class="mpre">UniqueSource</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_26_9_26_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_26_9_26_15&#39;)"><span class="hl_tyconref"><span class="mpre">Unique</span></span></a><span class="mpre">
</span><a name="loc_36_1_36_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_1_36_10&#39;)"><span class="hl_fundecl"><span class="mpre">newUnique</span></span></a><span class="mpre"> (</span><a href="#loc_24_24_24_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_24_24_24_26&#39;)"><span class="hl_conref"><span class="mpre">US</span></span></a><span class="mpre"> </span><a name="loc_36_15_36_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_15_36_18&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">atomically</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
  </span><a name="loc_37_3_37_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_3_37_4&#39;)"><span class="hl_vardecl"><span class="mpre">u</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_36_15_36_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_15_36_18&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre">
  let !</span><a name="loc_38_8_38_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_8_38_10&#39;)"><span class="hl_vardecl"><span class="mpre">u&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_37_3_37_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_3_37_4&#39;)"><span class="hl_varref"><span class="mpre">u</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_36_15_36_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_15_36_18&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre"> </span><a href="#loc_38_8_38_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_8_38_10&#39;)"><span class="hl_varref"><span class="mpre">u&#39;</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_26_18_26_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_26_18_26_24&#39;)"><span class="hl_conref"><span class="mpre">Unique</span></span></a><span class="mpre"> </span><a href="#loc_38_8_38_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_8_38_10&#39;)"><span class="hl_varref"><span class="mpre">u&#39;</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_36_1_36_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_1_36_10&#39;)"><span class="mpre">newUnique</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span></div></body></html>