<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE CPP, BangPatterns, Rank2Types #-}

#ifdef USE_MONO_PAT_BINDS
{-# LANGUAGE MonoPatBinds #-}
#endif

</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : Blaze.ByteString.Builder.Internal</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   : (c) 2010 Simon Meier</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD3-style (see LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Simon Meier &lt;iridcode@gmail.com&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : tested on GHC only</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Core types and functions for the &#39;Builder&#39; monoid and the &#39;Put&#39; monad.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Blaze.ByteString.Builder.Internal (

  </span><span class="hl_comment"><span class="mpre">-- * Build Steps</span></span><span class="mpre">
    BufRange(..)
  , BuildSignal
  , BuildStep
  , done
  , bufferFull
  , insertByteString

  </span><span class="hl_comment"><span class="mpre">-- * Builder</span></span><span class="mpre">
  , Builder
  , fromBuildStepCont
  , fromPut
  , flush

  </span><span class="hl_comment"><span class="mpre">-- * Put</span></span><span class="mpre">
  , Put
  , putBuilder
  , putBuildStepCont
  , putLiftIO

  </span><span class="hl_comment"><span class="mpre">-- * Writes</span></span><span class="mpre">
  , module Blaze.ByteString.Builder.Internal.Write
  , writeToByteString

  </span><span class="hl_comment"><span class="mpre">-- * Execution</span></span><span class="mpre">
  , toLazyByteString
  , toLazyByteStringWith
  , toByteString
  , toByteStringIO
  , toByteStringIOWith

  </span><span class="hl_comment"><span class="mpre">-- * Deafult Sizes</span></span><span class="mpre">
  , defaultFirstBufferSize
  , defaultMinimalBufferSize
  , defaultBufferSize
  , defaultMaximalCopySize
) where

#ifdef HAS_FOREIGN_UNSAFE_MODULE
import Foreign                   (withForeignPtr, sizeOf, </span><a href="Foreign.Marshal.Utils.html#loc_154_1_154_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_154_1_154_10&#39;)"><span class="mpre">copyBytes</span></a><span class="mpre">, plusPtr, minusPtr)
import Foreign.ForeignPtr.Unsafe (</span><a href="GHC.ForeignPtr.html#loc_420_1_420_22" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.ForeignPtr.html#loc_420_1_420_22&#39;)"><span class="mpre">unsafeForeignPtrToPtr</span></a><span class="mpre">)
#else
import Foreign                   (unsafeForeignPtrToPtr, withForeignPtr, sizeOf, </span><a href="Foreign.Marshal.Utils.html#loc_154_1_154_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_154_1_154_10&#39;)"><span class="mpre">copyBytes</span></a><span class="mpre">, plusPtr, minusPtr)
#endif

import Control.Monad (</span><a href="Control.Monad.html#loc_270_1_270_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_270_1_270_7&#39;)"><span class="mpre">unless</span></a><span class="mpre">)
import System.IO.Unsafe (</span><a href="GHC.IO.html#loc_182_1_182_23" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_182_1_182_23&#39;)"><span class="mpre">unsafeDupablePerformIO</span></a><span class="mpre">)

import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/Internal.hs&quot;, srcSpanStartLine = 68, srcSpanStartColumn = 18, srcSpanEndLine = 68, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre">               as S
import qualified Data.ByteString.Internal      as S
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/Internal.hs&quot;, srcSpanStartLine = 70, srcSpanStartColumn = 18, srcSpanEndLine = 70, srcSpanEndColumn = 38}, srcInfoPoints = []}) &quot;Data.ByteString.Lazy&quot;"><span class="mpre">Data.ByteString.Lazy</span></span><span class="mpre">          as L
import qualified Data.ByteString.Lazy.Internal as L

import Blaze.ByteString.Builder.Internal.Types
import Blaze.ByteString.Builder.Internal.Write

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Internal global constants.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Default size (~32kb) for the buffer that becomes a chunk of the output</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- stream once it is filled.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_84_1_84_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_1_84_18&#39;)"><span class="mpre">defaultBufferSize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_84_1_84_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_1_84_18&#39;)"><span class="hl_vardecl"><span class="mpre">defaultBufferSize</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">32</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1024</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><a href="#loc_85_11_85_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_11_85_19&#39;)"><span class="hl_varref"><span class="mpre">overhead</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- Copied from Data.ByteString.Lazy.</span></span><span class="mpre">
    where </span><a name="loc_85_11_85_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_11_85_19&#39;)"><span class="hl_vardecl"><span class="mpre">overhead</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">sizeOf</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">undefined</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | The minimal length (~4kb) a buffer must have before filling it and</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- outputting it as a chunk of the output stream.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This size determines when a buffer is spilled after a &#39;flush&#39; or a direct</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- bytestring insertion. It is also the size of the first chunk generated by</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;toLazyByteString&#39;.</span></span><span class="mpre">
</span><a href="#loc_94_1_94_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_1_94_25&#39;)"><span class="mpre">defaultMinimalBufferSize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_94_1_94_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_1_94_25&#39;)"><span class="hl_vardecl"><span class="mpre">defaultMinimalBufferSize</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">4</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1024</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><a href="#loc_95_11_95_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_11_95_19&#39;)"><span class="hl_varref"><span class="mpre">overhead</span></span></a><span class="mpre">
    where </span><a name="loc_95_11_95_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_11_95_19&#39;)"><span class="hl_vardecl"><span class="mpre">overhead</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">sizeOf</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">undefined</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | The default length (64) for the first buffer to be allocated when</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- converting a &#39;Builder&#39; to a lazy bytestring.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- See &#39;toLazyByteStringWith&#39; for further explanation.</span></span><span class="mpre">
</span><a href="#loc_102_1_102_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_1_102_23&#39;)"><span class="mpre">defaultFirstBufferSize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_102_1_102_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_1_102_23&#39;)"><span class="hl_vardecl"><span class="mpre">defaultFirstBufferSize</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">64</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The maximal number of bytes for that copying is cheaper than direct</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- insertion into the output stream. This takes into account the fragmentation</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- that may occur in the output buffer due to the early &#39;flush&#39; implied by the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- direct bytestring insertion.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @&#39;defaultMaximalCopySize&#39; = 2 * &#39;defaultMinimalBufferSize&#39;@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_112_1_112_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_23&#39;)"><span class="mpre">defaultMaximalCopySize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_112_1_112_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_23&#39;)"><span class="hl_vardecl"><span class="mpre">defaultMaximalCopySize</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><a href="#loc_94_1_94_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_1_94_25&#39;)"><span class="hl_varref"><span class="mpre">defaultMinimalBufferSize</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Flushing and running a Builder</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Prepend the chunk if it is non-empty.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_121_1_121_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_1_121_14&#39;)"><span class="mpre">nonEmptyChunk</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_121_1_121_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_1_121_14&#39;)"><span class="mpre">nonEmptyChunk</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
</span><a name="loc_121_1_121_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_1_121_14&#39;)"><span class="hl_fundecl"><span class="mpre">nonEmptyChunk</span></span></a><span class="mpre"> </span><a name="loc_121_15_121_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_15_121_17&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_121_18_121_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_18_121_21&#39;)"><span class="hl_vardecl"><span class="mpre">lbs</span></span></a><span class="mpre"> | </span><span class="hl_varref"><span class="mpre">S.null</span></span><span class="mpre"> </span><a href="#loc_121_15_121_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_15_121_17&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> = </span><a href="#loc_121_18_121_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_18_121_21&#39;)"><span class="hl_varref"><span class="mpre">lbs</span></span></a><span class="mpre">
                     | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> </span><a href="#loc_121_15_121_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_15_121_17&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="#loc_121_18_121_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_18_121_21&#39;)"><span class="hl_varref"><span class="mpre">lbs</span></span></a><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | Output all data written in the current buffer and start a new chunk.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The use of this function depends on how the resulting bytestrings are</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- consumed. &#39;flush&#39; is possibly not very useful in non-interactive scenarios.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- However, it is kept for compatibility with the builder provided by</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Data.Binary.Builder.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- When using &#39;toLazyByteString&#39; to extract a lazy &#39;L.ByteString&#39; from a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;Builder&#39;, this means that a new chunk will be started in the resulting lazy</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;L.ByteString&#39;. The remaining part of the buffer is spilled, if the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- reamining free space is smaller than the minimal desired buffer size.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_139_1_139_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_1_139_6&#39;)"><span class="mpre">flush</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_139_1_139_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_1_139_6&#39;)"><span class="mpre">flush</span></a><span class="mpre"> :: </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_139_1_139_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_1_139_6&#39;)"><span class="hl_vardecl"><span class="mpre">flush</span></span></a><span class="mpre"> = </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_124_1_124_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_124_1_124_18&#39;)"><span class="hl_varref"><span class="mpre">fromBuildStepCont</span></span></a><span class="mpre"> </span><a href="#loc_141_5_141_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_141_5_141_9&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre">
  where
    </span><a name="loc_141_5_141_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_141_5_141_9&#39;)"><span class="hl_fundecl"><span class="mpre">step</span></span></a><span class="mpre"> </span><a name="loc_141_10_141_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_141_10_141_11&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> !(</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> </span><a name="loc_141_23_141_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_141_23_141_25&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_60_1_60_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_60_1_60_17&#39;)"><span class="hl_varref"><span class="mpre">insertByteString</span></span></a><span class="mpre"> </span><a href="#loc_141_23_141_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_141_23_141_25&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">S.empty</span></span><span class="mpre"> </span><a href="#loc_141_10_141_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_141_10_141_11&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run a &#39;Builder&#39; with the given buffer sizes.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Use this function for integrating the &#39;Builder&#39; type with other libraries</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- that generate lazy bytestrings.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that the builders should guarantee that on average the desired chunk</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- size is attained. Builders may decide to start a new buffer and not</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- completely fill the existing buffer, if this is faster. However, they should</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- not spill too much of the buffer, if they cannot compensate for it.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- A call @toLazyByteStringWith bufSize minBufSize firstBufSize@ will generate</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- a lazy bytestring according to the following strategy. First, we allocate</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- a buffer of size @firstBufSize@ and start filling it. If it overflows, we</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- allocate a buffer of size @minBufSize@ and copy the first buffer to it in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- order to avoid generating a too small chunk. Finally, every next buffer will</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- be of size @bufSize@. This, slow startup strategy is required to achieve</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- good speed for short (&lt;200 bytes) resulting bytestrings, as for them the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- allocation cost is of a large buffer cannot be compensated. Moreover, this</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- strategy also allows us to avoid spilling too much memory for short</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- resulting bytestrings.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that setting @firstBufSize &gt;= minBufSize@ implies that the first buffer</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- is no longer copied but allocated and filled directly. Hence, setting</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @firstBufSize = bufSize@ means that all chunks will use an underlying buffer</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- of size @bufSize@. This is recommended, if you know that you always output</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- more than @minBufSize@ bytes.</span></span><span class="mpre">
</span><a href="#loc_181_1_181_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_1_181_21&#39;)"><span class="mpre">toLazyByteStringWith</span></a><span class="mpre">
    :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">           </span><span class="hl_comment"><span class="mpre">-- ^ Buffer size (upper-bounds the resulting chunk size).</span></span><span class="mpre">
    -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">           </span><span class="hl_comment"><span class="mpre">-- ^ Minimal free buffer space for continuing filling</span></span><span class="mpre">
                     </span><span class="hl_comment"><span class="mpre">-- the same buffer after a &#39;flush&#39; or a direct bytestring</span></span><span class="mpre">
                     </span><span class="hl_comment"><span class="mpre">-- insertion. This corresponds to the minimal desired</span></span><span class="mpre">
                     </span><span class="hl_comment"><span class="mpre">-- chunk size.</span></span><span class="mpre">
    -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">           </span><span class="hl_comment"><span class="mpre">-- ^ Size of the first buffer to be used and copied for</span></span><span class="mpre">
                     </span><span class="hl_comment"><span class="mpre">-- larger resulting sequences</span></span><span class="mpre">
    -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">       </span><span class="hl_comment"><span class="mpre">-- ^ Builder to run.</span></span><span class="mpre">
    -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- ^ Lazy bytestring to output after the builder is</span></span><span class="mpre">
                     </span><span class="hl_comment"><span class="mpre">-- finished.</span></span><span class="mpre">
    -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- ^ Resulting lazy bytestring</span></span><span class="mpre">
</span><a name="loc_181_1_181_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_1_181_21&#39;)"><span class="hl_fundecl"><span class="mpre">toLazyByteStringWith</span></span></a><span class="mpre"> </span><a name="loc_181_22_181_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_22_181_29&#39;)"><span class="hl_vardecl"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a name="loc_181_30_181_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_30_181_40&#39;)"><span class="hl_vardecl"><span class="mpre">minBufSize</span></span></a><span class="mpre"> </span><a name="loc_181_41_181_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_41_181_53&#39;)"><span class="hl_vardecl"><span class="mpre">firstBufSize</span></span></a><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_19_69_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_19_69_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><a name="loc_181_63_181_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_63_181_64&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">) </span><a name="loc_181_66_181_67" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_66_181_67&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> =
    </span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">S.inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_189_5_189_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_5_189_20&#39;)"><span class="hl_varref"><span class="mpre">fillFirstBuffer</span></span></a><span class="mpre"> (</span><a href="#loc_181_63_181_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_63_181_64&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_63_1_63_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_63_1_63_10&#39;)"><span class="hl_varref"><span class="mpre">buildStep</span></span></a><span class="mpre"> </span><a href="#loc_184_5_184_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_5_184_14&#39;)"><span class="hl_varref"><span class="mpre">finalStep</span></span></a><span class="mpre">))
  where
    </span><a name="loc_184_5_184_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_5_184_14&#39;)"><span class="hl_fundecl"><span class="mpre">finalStep</span></span></a><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> </span><a name="loc_184_25_184_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_25_184_27&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a href="#loc_184_25_184_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_25_184_27&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- fill a first very small buffer, if we need more space then copy it</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- to the new buffer of size &#39;minBufSize&#39;. This way we don&#39;t pay the</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- allocation cost of the big &#39;bufSize&#39; buffer, when outputting only</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- small sequences.</span></span><span class="mpre">
    </span><a name="loc_189_5_189_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_5_189_20&#39;)"><span class="hl_fundecl"><span class="mpre">fillFirstBuffer</span></span></a><span class="mpre"> !</span><a name="loc_189_22_189_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_22_189_27&#39;)"><span class="hl_vardecl"><span class="mpre">step0</span></span></a><span class="mpre">
      | </span><a href="#loc_181_30_181_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_30_181_40&#39;)"><span class="hl_varref"><span class="mpre">minBufSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_181_41_181_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_41_181_53&#39;)"><span class="hl_varref"><span class="mpre">firstBufSize</span></span></a><span class="mpre"> = </span><a href="#loc_219_5_219_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_5_219_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> </span><a href="#loc_181_41_181_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_41_181_53&#39;)"><span class="hl_varref"><span class="mpre">firstBufSize</span></span></a><span class="mpre"> </span><a href="#loc_189_22_189_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_22_189_27&#39;)"><span class="hl_varref"><span class="mpre">step0</span></span></a><span class="mpre">
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                  = do
          </span><a name="loc_192_11_192_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_11_192_16&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> &lt;- </span><a href="Data.ByteString.Internal.html#loc_489_1_489_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_489_1_489_17&#39;)"><span class="hl_varref"><span class="mpre">S.mallocByteString</span></span></a><span class="mpre"> </span><a href="#loc_181_41_181_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_41_181_53&#39;)"><span class="hl_varref"><span class="mpre">firstBufSize</span></span></a><span class="mpre">
          </span><span class="hl_varref"><span class="mpre">withForeignPtr</span></span><span class="mpre"> </span><a href="#loc_192_11_192_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_11_192_16&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_193_35_193_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_35_193_37&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> -&gt; do
              let !</span><a name="loc_194_20_194_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_20_194_22&#39;)"><span class="hl_vardecl"><span class="mpre">pe</span></span></a><span class="mpre">      = </span><a href="#loc_193_35_193_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_35_193_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_181_41_181_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_41_181_53&#39;)"><span class="hl_varref"><span class="mpre">firstBufSize</span></span></a><span class="mpre">
                  </span><a name="loc_195_19_195_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_19_195_23&#39;)"><span class="hl_fundecl"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a name="loc_195_24_195_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_24_195_27&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> = </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_192_11_192_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_11_192_16&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> (</span><a href="#loc_195_24_195_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_24_195_27&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_193_35_193_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_35_193_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">)
                  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_195_19_195_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_19_195_23&#39;)"><span class="mpre">mkbs</span></a><span class="mpre"> #-}</span></span><span class="mpre">
              </span><a name="loc_197_15_197_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_197_15_197_19&#39;)"><span class="hl_vardecl"><span class="mpre">next</span></span></a><span class="mpre"> &lt;- </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29&#39;)"><span class="hl_varref"><span class="mpre">runBuildStep</span></span></a><span class="mpre"> </span><a href="#loc_189_22_189_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_22_189_27&#39;)"><span class="hl_varref"><span class="mpre">step0</span></span></a><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> </span><a href="#loc_193_35_193_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_35_193_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><a href="#loc_194_20_194_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_20_194_22&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre">)
              case </span><a href="#loc_197_15_197_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_197_15_197_19&#39;)"><span class="hl_varref"><span class="mpre">next</span></span></a><span class="mpre"> of
                  </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a name="loc_199_24_199_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_199_24_199_27&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> _
                    | </span><a href="#loc_199_24_199_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_199_24_199_27&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_193_35_193_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_35_193_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_181_66_181_67" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_66_181_67&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
                    | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_195_19_195_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_19_195_23&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_199_24_199_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_199_24_199_27&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">) </span><a href="#loc_181_66_181_67" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_66_181_67&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">

                  </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_39_5_39_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_39_5_39_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre"> </span><a name="loc_203_30_203_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_30_203_37&#39;)"><span class="hl_vardecl"><span class="mpre">newSize</span></span></a><span class="mpre"> </span><a name="loc_203_38_203_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_38_203_41&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a name="loc_203_42_203_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_42_203_50&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre">  -&gt; do
                      let !</span><a name="loc_204_28_204_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_28_204_29&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">  = </span><a href="#loc_203_38_203_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_38_203_41&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_193_35_193_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_35_193_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">
                      </span><a href="#loc_219_5_219_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_5_219_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">max</span></span><span class="mpre"> (</span><a href="#loc_204_28_204_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_28_204_29&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><a href="#loc_203_30_203_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_30_203_37&#39;)"><span class="hl_varref"><span class="mpre">newSize</span></span></a><span class="mpre">) </span><a href="#loc_181_30_181_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_30_181_40&#39;)"><span class="hl_varref"><span class="mpre">minBufSize</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_63_1_63_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_63_1_63_10&#39;)"><span class="hl_varref"><span class="mpre">buildStep</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
                          \(</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> </span><a name="loc_206_38_206_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_38_206_43&#39;)"><span class="hl_vardecl"><span class="mpre">pfNew</span></span></a><span class="mpre"> </span><a name="loc_206_44_206_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_44_206_49&#39;)"><span class="hl_vardecl"><span class="mpre">peNew</span></span></a><span class="mpre">) -&gt; do
                              </span><a href="Foreign.Marshal.Utils.html#loc_154_1_154_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_154_1_154_10&#39;)"><span class="hl_varref"><span class="mpre">copyBytes</span></span></a><span class="mpre"> </span><a href="#loc_206_38_206_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_38_206_43&#39;)"><span class="hl_varref"><span class="mpre">pfNew</span></span></a><span class="mpre"> </span><a href="#loc_193_35_193_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_35_193_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><a href="#loc_204_28_204_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_28_204_29&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">
                              let !</span><a name="loc_208_36_208_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_208_36_208_39&#39;)"><span class="hl_vardecl"><span class="mpre">br&#39;</span></span></a><span class="mpre"> = </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> (</span><a href="#loc_206_38_206_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_38_206_43&#39;)"><span class="hl_varref"><span class="mpre">pfNew</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_204_28_204_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_28_204_29&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">) </span><a href="#loc_206_44_206_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_44_206_49&#39;)"><span class="hl_varref"><span class="mpre">peNew</span></span></a><span class="mpre">
                              </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29&#39;)"><span class="hl_varref"><span class="mpre">runBuildStep</span></span></a><span class="mpre"> </span><a href="#loc_203_42_203_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_42_203_50&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre"> </span><a href="#loc_208_36_208_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_208_36_208_39&#39;)"><span class="hl_varref"><span class="mpre">br&#39;</span></span></a><span class="mpre">

                  </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_43_5_43_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_43_5_43_21&#39;)"><span class="hl_conref"><span class="mpre">InsertByteString</span></span></a><span class="mpre"> </span><a name="loc_211_36_211_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_36_211_39&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a name="loc_211_40_211_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_40_211_42&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_211_43_211_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_43_211_51&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre">
                      | </span><a href="#loc_211_36_211_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_36_211_39&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_193_35_193_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_35_193_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> -&gt;
                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_121_1_121_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_1_121_14&#39;)"><span class="hl_varref"><span class="mpre">nonEmptyChunk</span></span></a><span class="mpre"> </span><a href="#loc_211_40_211_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_40_211_42&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">S.inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_219_5_219_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_5_219_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> </span><a href="#loc_181_22_181_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_22_181_29&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a href="#loc_211_43_211_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_43_211_51&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">)
                      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> -&gt;
                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_195_19_195_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_19_195_23&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_211_36_211_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_36_211_39&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">)
                              (</span><a href="#loc_121_1_121_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_1_121_14&#39;)"><span class="hl_varref"><span class="mpre">nonEmptyChunk</span></span></a><span class="mpre"> </span><a href="#loc_211_40_211_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_40_211_42&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">S.inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_219_5_219_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_5_219_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> </span><a href="#loc_181_22_181_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_22_181_29&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a href="#loc_211_43_211_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_43_211_51&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">))

    </span><span class="hl_comment"><span class="mpre">-- allocate and fill a new buffer</span></span><span class="mpre">
    </span><a name="loc_219_5_219_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_5_219_18&#39;)"><span class="hl_fundecl"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> !</span><a name="loc_219_20_219_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_20_219_24&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre"> !</span><a name="loc_219_26_219_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_26_219_31&#39;)"><span class="hl_vardecl"><span class="mpre">step0</span></span></a><span class="mpre"> = do
        </span><a name="loc_220_9_220_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_220_9_220_14&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> &lt;- </span><a href="Data.ByteString.Internal.html#loc_489_1_489_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_489_1_489_17&#39;)"><span class="hl_varref"><span class="mpre">S.mallocByteString</span></span></a><span class="mpre"> </span><a href="#loc_219_20_219_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_20_219_24&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">withForeignPtr</span></span><span class="mpre"> </span><a href="#loc_220_9_220_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_220_9_220_14&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_223_9_223_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_9_223_19&#39;)"><span class="hl_varref"><span class="mpre">fillBuffer</span></span></a><span class="mpre"> </span><a href="#loc_220_9_220_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_220_9_220_14&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">
      where
        </span><a name="loc_223_9_223_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_9_223_19&#39;)"><span class="hl_fundecl"><span class="mpre">fillBuffer</span></span></a><span class="mpre"> </span><a name="loc_223_20_223_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_20_223_25&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> !</span><a name="loc_223_27_223_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_27_223_31&#39;)"><span class="hl_vardecl"><span class="mpre">pbuf</span></span></a><span class="mpre"> = </span><a href="#loc_226_13_226_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_13_226_17&#39;)"><span class="hl_varref"><span class="mpre">fill</span></span></a><span class="mpre"> </span><a href="#loc_223_27_223_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_27_223_31&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre"> </span><a href="#loc_219_26_219_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_26_219_31&#39;)"><span class="hl_varref"><span class="mpre">step0</span></span></a><span class="mpre">
          where
            !</span><a name="loc_225_14_225_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_225_14_225_16&#39;)"><span class="hl_vardecl"><span class="mpre">pe</span></span></a><span class="mpre"> = </span><a href="#loc_223_27_223_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_27_223_31&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_219_20_219_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_20_219_24&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">
            </span><a name="loc_226_13_226_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_13_226_17&#39;)"><span class="hl_fundecl"><span class="mpre">fill</span></span></a><span class="mpre"> !</span><a name="loc_226_19_226_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_19_226_21&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> !</span><a name="loc_226_23_226_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_23_226_27&#39;)"><span class="hl_vardecl"><span class="mpre">step</span></span></a><span class="mpre"> = do
                </span><a name="loc_227_17_227_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_227_17_227_21&#39;)"><span class="hl_vardecl"><span class="mpre">next</span></span></a><span class="mpre"> &lt;- </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29&#39;)"><span class="hl_varref"><span class="mpre">runBuildStep</span></span></a><span class="mpre"> </span><a href="#loc_226_23_226_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_23_226_27&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> </span><a href="#loc_226_19_226_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_19_226_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><a href="#loc_225_14_225_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_225_14_225_16&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre">)
                let </span><a name="loc_228_21_228_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_21_228_25&#39;)"><span class="hl_fundecl"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a name="loc_228_26_228_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_26_228_29&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> = </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_223_20_223_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_20_223_25&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> (</span><a href="#loc_226_19_226_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_19_226_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_223_27_223_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_27_223_31&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre">) (</span><a href="#loc_228_26_228_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_26_228_29&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_226_19_226_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_19_226_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">)
                    </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_228_21_228_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_21_228_25&#39;)"><span class="mpre">mkbs</span></a><span class="mpre"> #-}</span></span><span class="mpre">
                case </span><a href="#loc_227_17_227_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_227_17_227_21&#39;)"><span class="hl_varref"><span class="mpre">next</span></span></a><span class="mpre"> of
                    </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a name="loc_231_26_231_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_26_231_29&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> _
                      | </span><a href="#loc_231_26_231_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_26_231_29&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_226_19_226_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_19_226_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_181_66_181_67" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_66_181_67&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
                      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_228_21_228_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_21_228_25&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_231_26_231_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_26_231_29&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">) </span><a href="#loc_181_66_181_67" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_66_181_67&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">

                    </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_39_5_39_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_39_5_39_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre"> </span><a name="loc_235_32_235_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_32_235_39&#39;)"><span class="hl_vardecl"><span class="mpre">newSize</span></span></a><span class="mpre"> </span><a name="loc_235_40_235_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_40_235_43&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a name="loc_235_44_235_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_44_235_52&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre">
                      | </span><a href="#loc_235_40_235_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_40_235_43&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_226_19_226_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_19_226_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> -&gt;
                          </span><a href="#loc_219_5_219_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_5_219_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">max</span></span><span class="mpre"> </span><a href="#loc_235_32_235_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_32_235_39&#39;)"><span class="hl_varref"><span class="mpre">newSize</span></span></a><span class="mpre"> </span><a href="#loc_181_22_181_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_22_181_29&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre">) </span><a href="#loc_235_44_235_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_44_235_52&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">
                      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> -&gt;
                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_228_21_228_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_21_228_25&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_235_40_235_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_40_235_43&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">)
                              (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">S.inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
                                  </span><a href="#loc_219_5_219_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_5_219_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">max</span></span><span class="mpre"> </span><a href="#loc_235_32_235_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_32_235_39&#39;)"><span class="hl_varref"><span class="mpre">newSize</span></span></a><span class="mpre"> </span><a href="#loc_181_22_181_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_22_181_29&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre">) </span><a href="#loc_235_44_235_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_44_235_52&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">)

                    </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_43_5_43_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_43_5_43_21&#39;)"><span class="hl_conref"><span class="mpre">InsertByteString</span></span></a><span class="mpre">  </span><a name="loc_243_39_243_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_39_243_42&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a name="loc_243_43_243_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_43_243_45&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_243_46_243_54" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_46_243_54&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre">
                      | </span><a href="#loc_243_39_243_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_39_243_42&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_226_19_226_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_19_226_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">                      -&gt;
                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_121_1_121_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_1_121_14&#39;)"><span class="hl_varref"><span class="mpre">nonEmptyChunk</span></span></a><span class="mpre"> </span><a href="#loc_243_43_243_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_43_243_45&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">S.inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_226_13_226_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_13_226_17&#39;)"><span class="hl_varref"><span class="mpre">fill</span></span></a><span class="mpre"> </span><a href="#loc_243_39_243_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_39_243_42&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a href="#loc_243_46_243_54" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_46_243_54&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">)
                      | </span><a href="#loc_181_30_181_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_30_181_40&#39;)"><span class="hl_varref"><span class="mpre">minBufSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><a href="#loc_225_14_225_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_225_14_225_16&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_243_39_243_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_39_243_42&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> -&gt;
                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_228_21_228_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_21_228_25&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_243_39_243_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_39_243_42&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">)
                              (</span><a href="#loc_121_1_121_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_1_121_14&#39;)"><span class="hl_varref"><span class="mpre">nonEmptyChunk</span></span></a><span class="mpre"> </span><a href="#loc_243_43_243_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_43_243_45&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">S.inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_226_13_226_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_13_226_17&#39;)"><span class="hl_varref"><span class="mpre">fill</span></span></a><span class="mpre"> </span><a href="#loc_243_39_243_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_39_243_42&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a href="#loc_243_46_243_54" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_46_243_54&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">))
                      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                      -&gt;
                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_228_21_228_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_21_228_25&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_243_39_243_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_39_243_42&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">)
                              (</span><a href="#loc_121_1_121_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_1_121_14&#39;)"><span class="hl_varref"><span class="mpre">nonEmptyChunk</span></span></a><span class="mpre"> </span><a href="#loc_243_43_243_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_43_243_45&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">S.inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_219_5_219_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_5_219_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> </span><a href="#loc_181_22_181_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_22_181_29&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a href="#loc_243_46_243_54" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_46_243_54&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">))


</span><span class="hl_comment"><span class="mpre">-- | Extract the lazy &#39;L.ByteString&#39; from the builder by running it with default</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- buffer sizes. Use this function, if you do not have any special</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- considerations with respect to buffer sizes.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @ &#39;toLazyByteString&#39; b = &#39;toLazyByteStringWith&#39; &#39;defaultBufferSize&#39; &#39;defaultMinimalBufferSize&#39; &#39;defaultFirstBufferSize&#39; b L.empty@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that @&#39;toLazyByteString&#39;@ is a &#39;Monoid&#39; homomorphism.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; toLazyByteString mempty          == mempty</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; toLazyByteString (x `mappend` y) == toLazyByteString x `mappend` toLazyByteString y</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- However, in the second equation, the left-hand-side is generally faster to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- execute.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_269_1_269_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_1_269_17&#39;)"><span class="mpre">toLazyByteString</span></a><span class="mpre"> :: </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
</span><a name="loc_269_1_269_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_1_269_17&#39;)"><span class="hl_fundecl"><span class="mpre">toLazyByteString</span></span></a><span class="mpre"> </span><a name="loc_269_18_269_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_18_269_19&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> = </span><a href="#loc_181_1_181_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_181_1_181_21&#39;)"><span class="hl_varref"><span class="mpre">toLazyByteStringWith</span></span></a><span class="mpre">
    </span><a href="#loc_84_1_84_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_1_84_18&#39;)"><span class="hl_varref"><span class="mpre">defaultBufferSize</span></span></a><span class="mpre"> </span><a href="#loc_94_1_94_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_1_94_25&#39;)"><span class="hl_varref"><span class="mpre">defaultMinimalBufferSize</span></span></a><span class="mpre"> </span><a href="#loc_102_1_102_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_1_102_23&#39;)"><span class="hl_varref"><span class="mpre">defaultFirstBufferSize</span></span></a><span class="mpre"> </span><a href="#loc_269_18_269_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_18_269_19&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">L.empty</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_269_1_269_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_1_269_17&#39;)"><span class="mpre">toLazyByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Pack the chunks of a lazy bytestring into a single strict bytestring.</span></span><span class="mpre">
</span><a href="#loc_275_1_275_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_275_1_275_11&#39;)"><span class="mpre">packChunks</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
</span><a name="loc_275_1_275_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_275_1_275_11&#39;)"><span class="hl_fundecl"><span class="mpre">packChunks</span></span></a><span class="mpre"> </span><a name="loc_275_12_275_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_275_12_275_15&#39;)"><span class="hl_vardecl"><span class="mpre">lbs</span></span></a><span class="mpre"> = do
    </span><a href="Data.ByteString.Internal.html#loc_411_1_411_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_411_1_411_13&#39;)"><span class="hl_varref"><span class="mpre">S.unsafeCreate</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">L.length</span></span><span class="mpre"> </span><a href="#loc_275_12_275_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_275_12_275_15&#39;)"><span class="hl_varref"><span class="mpre">lbs</span></span></a><span class="mpre">) (</span><a href="#loc_278_5_278_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_5_278_15&#39;)"><span class="hl_varref"><span class="mpre">copyChunks</span></span></a><span class="mpre"> </span><a href="#loc_275_12_275_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_275_12_275_15&#39;)"><span class="hl_varref"><span class="mpre">lbs</span></span></a><span class="mpre">)
  where
    </span><a name="loc_278_5_278_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_5_278_15&#39;)"><span class="hl_fundecl"><span class="mpre">copyChunks</span></span></a><span class="mpre"> !</span><a href="Data.ByteString.Lazy.Internal.html#loc_82_19_82_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_19_82_24&#39;)"><span class="hl_conref"><span class="mpre">L.Empty</span></span></a><span class="mpre">                         !</span><span class="hl_vardecl"><span class="mpre">_pf</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
    </span><a href="#loc_278_5_278_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_5_278_15&#39;)"><span class="hl_fundecl"><span class="mpre">copyChunks</span></span></a><span class="mpre"> !(</span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a name="loc_279_32_279_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_32_279_37&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a name="loc_279_38_279_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_38_279_39&#39;)"><span class="hl_vardecl"><span class="mpre">o</span></span></a><span class="mpre"> </span><a name="loc_279_40_279_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_40_279_41&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) </span><a name="loc_279_43_279_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_43_279_47&#39;)"><span class="hl_vardecl"><span class="mpre">lbs&#39;</span></span></a><span class="mpre">) !</span><a name="loc_279_50_279_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_50_279_52&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre">  = do
        </span><span class="hl_varref"><span class="mpre">withForeignPtr</span></span><span class="mpre"> </span><a href="#loc_279_32_279_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_32_279_37&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_280_33_280_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_280_33_280_37&#39;)"><span class="hl_vardecl"><span class="mpre">pbuf</span></span></a><span class="mpre"> -&gt;
            </span><a href="Foreign.Marshal.Utils.html#loc_154_1_154_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_154_1_154_10&#39;)"><span class="hl_varref"><span class="mpre">copyBytes</span></span></a><span class="mpre"> </span><a href="#loc_279_50_279_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_50_279_52&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> (</span><a href="#loc_280_33_280_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_280_33_280_37&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_279_38_279_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_38_279_39&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre">) </span><a href="#loc_279_40_279_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_40_279_41&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">
        </span><a href="#loc_278_5_278_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_5_278_15&#39;)"><span class="hl_varref"><span class="mpre">copyChunks</span></span></a><span class="mpre"> </span><a href="#loc_279_43_279_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_43_279_47&#39;)"><span class="hl_varref"><span class="mpre">lbs&#39;</span></span></a><span class="mpre"> (</span><a href="#loc_279_50_279_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_50_279_52&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_279_40_279_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_40_279_41&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Run the builder to construct a strict bytestring containing the sequence</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- of bytes denoted by the builder. This is done by first serializing to a lazy bytestring and then packing its</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- chunks to a appropriately sized strict bytestring.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; toByteString = packChunks . toLazyByteString</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that @&#39;toByteString&#39;@ is a &#39;Monoid&#39; homomorphism.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; toByteString mempty          == mempty</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; toByteString (x `mappend` y) == toByteString x `mappend` toByteString y</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- However, in the second equation, the left-hand-side is generally faster to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- execute.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_299_1_299_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_1_299_13&#39;)"><span class="mpre">toByteString</span></a><span class="mpre"> :: </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
</span><a name="loc_299_1_299_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_1_299_13&#39;)"><span class="hl_vardecl"><span class="mpre">toByteString</span></span></a><span class="mpre"> = </span><a href="#loc_275_1_275_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_275_1_275_11&#39;)"><span class="hl_varref"><span class="mpre">packChunks</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_269_1_269_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_1_269_17&#39;)"><span class="hl_varref"><span class="mpre">toLazyByteString</span></span></a><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | @toByteStringIOWith bufSize io b@ runs the builder @b@ with a buffer of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- at least the size @bufSize@ and executes the &#39;IO&#39; action @io@ whenever the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- buffer is full.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Compared to &#39;toLazyByteStringWith&#39; this function requires less allocation,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- as the output buffer is only allocated once at the start of the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- serialization and whenever something bigger than the current buffer size has</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to be copied into the buffer, which should happen very seldomly for the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- default buffer size of 32kb. Hence, the pressure on the garbage collector is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- reduced, which can be an advantage when building long sequences of bytes.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_322_1_322_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_1_322_19&#39;)"><span class="mpre">toByteStringIOWith</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">                      </span><span class="hl_comment"><span class="mpre">-- ^ Buffer size (upper bounds</span></span><span class="mpre">
                                               </span><span class="hl_comment"><span class="mpre">-- the number of bytes forced</span></span><span class="mpre">
                                               </span><span class="hl_comment"><span class="mpre">-- per call to the &#39;IO&#39; action).</span></span><span class="mpre">
                   -&gt; (</span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">)  </span><span class="hl_comment"><span class="mpre">-- ^ &#39;IO&#39; action to execute per</span></span><span class="mpre">
                                               </span><span class="hl_comment"><span class="mpre">-- full buffer, which is</span></span><span class="mpre">
                                               </span><span class="hl_comment"><span class="mpre">-- referenced by a strict</span></span><span class="mpre">
                                               </span><span class="hl_comment"><span class="mpre">-- &#39;S.ByteString&#39;.</span></span><span class="mpre">
                   -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">                  </span><span class="hl_comment"><span class="mpre">-- ^ &#39;Builder&#39; to run.</span></span><span class="mpre">
                   -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">                    </span><span class="hl_comment"><span class="mpre">-- ^ Resulting &#39;IO&#39; action.</span></span><span class="mpre">
</span><a name="loc_322_1_322_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_1_322_19&#39;)"><span class="hl_fundecl"><span class="mpre">toByteStringIOWith</span></span></a><span class="mpre"> </span><a name="loc_322_20_322_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_20_322_27&#39;)"><span class="hl_vardecl"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a name="loc_322_28_322_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_28_322_30&#39;)"><span class="hl_vardecl"><span class="mpre">io</span></span></a><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_19_69_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_19_69_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><a name="loc_322_40_322_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_40_322_41&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">) =
    </span><a href="#loc_327_5_327_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_327_5_327_15&#39;)"><span class="hl_varref"><span class="mpre">fillBuffer</span></span></a><span class="mpre"> </span><a href="#loc_322_20_322_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_20_322_27&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre"> (</span><a href="#loc_322_40_322_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_40_322_41&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_63_1_63_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_63_1_63_10&#39;)"><span class="hl_varref"><span class="mpre">buildStep</span></span></a><span class="mpre"> </span><a href="#loc_325_5_325_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_325_5_325_14&#39;)"><span class="hl_varref"><span class="mpre">finalStep</span></span></a><span class="mpre">))
  where
    </span><a name="loc_325_5_325_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_325_5_325_14&#39;)"><span class="hl_fundecl"><span class="mpre">finalStep</span></span></a><span class="mpre"> !(</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> </span><a name="loc_325_26_325_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_325_26_325_28&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a href="#loc_325_26_325_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_325_26_325_28&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">

    </span><a name="loc_327_5_327_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_327_5_327_15&#39;)"><span class="hl_fundecl"><span class="mpre">fillBuffer</span></span></a><span class="mpre"> !</span><a name="loc_327_17_327_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_327_17_327_21&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre"> </span><a name="loc_327_22_327_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_327_22_327_26&#39;)"><span class="hl_vardecl"><span class="mpre">step</span></span></a><span class="mpre"> = do
        </span><a href="Data.ByteString.Internal.html#loc_489_1_489_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_489_1_489_17&#39;)"><span class="hl_varref"><span class="mpre">S.mallocByteString</span></span></a><span class="mpre"> </span><a href="#loc_327_17_327_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_327_17_327_21&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_330_9_330_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_330_9_330_13&#39;)"><span class="hl_varref"><span class="mpre">fill</span></span></a><span class="mpre">
      where
        </span><a name="loc_330_9_330_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_330_9_330_13&#39;)"><span class="hl_fundecl"><span class="mpre">fill</span></span></a><span class="mpre"> </span><a name="loc_330_14_330_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_330_14_330_19&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> = do
            let !</span><a name="loc_331_18_331_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_18_331_20&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> = </span><a href="GHC.ForeignPtr.html#loc_420_1_420_22" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.ForeignPtr.html#loc_420_1_420_22&#39;)"><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span></a><span class="mpre"> </span><a href="#loc_330_14_330_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_330_14_330_19&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">
                !</span><a name="loc_332_18_332_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_332_18_332_20&#39;)"><span class="hl_vardecl"><span class="mpre">br</span></span></a><span class="mpre"> = </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> </span><a href="#loc_331_18_331_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_18_331_20&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> (</span><a href="#loc_331_18_331_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_18_331_20&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_327_17_327_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_327_17_327_21&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">)
                </span><span class="hl_comment"><span class="mpre">-- safe due to later reference of fpbuf</span></span><span class="mpre">
                </span><span class="hl_comment"><span class="mpre">-- BETTER than withForeignPtr, as we lose a tail call otherwise</span></span><span class="mpre">
            </span><a name="loc_335_13_335_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_335_13_335_19&#39;)"><span class="hl_vardecl"><span class="mpre">signal</span></span></a><span class="mpre"> &lt;- </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29&#39;)"><span class="hl_varref"><span class="mpre">runBuildStep</span></span></a><span class="mpre"> </span><a href="#loc_327_22_327_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_327_22_327_26&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_332_18_332_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_332_18_332_20&#39;)"><span class="hl_varref"><span class="mpre">br</span></span></a><span class="mpre">
            case </span><a href="#loc_335_13_335_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_335_13_335_19&#39;)"><span class="hl_varref"><span class="mpre">signal</span></span></a><span class="mpre"> of
                </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a name="loc_337_22_337_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_337_22_337_25&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> _ -&gt; </span><a href="#loc_322_28_322_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_28_322_30&#39;)"><span class="hl_varref"><span class="mpre">io</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_330_14_330_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_330_14_330_19&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> (</span><a href="#loc_337_22_337_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_337_22_337_25&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_331_18_331_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_18_331_20&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">)

                </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_39_5_39_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_39_5_39_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre"> </span><a name="loc_339_28_339_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_28_339_35&#39;)"><span class="hl_vardecl"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a name="loc_339_36_339_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_36_339_39&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a name="loc_339_40_339_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_40_339_48&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre">  -&gt; do
                    </span><a href="#loc_322_28_322_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_28_322_30&#39;)"><span class="hl_varref"><span class="mpre">io</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_330_14_330_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_330_14_330_19&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> (</span><a href="#loc_339_36_339_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_36_339_39&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_331_18_331_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_18_331_20&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">)
                    </span><a href="#loc_327_5_327_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_327_5_327_15&#39;)"><span class="hl_varref"><span class="mpre">fillBuffer</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">max</span></span><span class="mpre"> </span><a href="#loc_322_20_322_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_20_322_27&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a href="#loc_339_28_339_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_28_339_35&#39;)"><span class="hl_varref"><span class="mpre">minSize</span></span></a><span class="mpre">) </span><a href="#loc_339_40_339_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_40_339_48&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">

                </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_43_5_43_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_43_5_43_21&#39;)"><span class="hl_conref"><span class="mpre">InsertByteString</span></span></a><span class="mpre"> </span><a name="loc_343_34_343_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_343_34_343_37&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a name="loc_343_38_343_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_343_38_343_40&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_343_41_343_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_343_41_343_49&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre">  -&gt; do
                    </span><a href="#loc_322_28_322_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_28_322_30&#39;)"><span class="hl_varref"><span class="mpre">io</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_330_14_330_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_330_14_330_19&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> (</span><a href="#loc_343_34_343_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_343_34_343_37&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_331_18_331_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_18_331_20&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">)
                    </span><a href="Control.Monad.html#loc_270_1_270_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_270_1_270_7&#39;)"><span class="hl_varref"><span class="mpre">unless</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">S.null</span></span><span class="mpre"> </span><a href="#loc_343_38_343_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_343_38_343_40&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">) (</span><a href="#loc_322_28_322_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_28_322_30&#39;)"><span class="hl_varref"><span class="mpre">io</span></span></a><span class="mpre"> </span><a href="#loc_343_38_343_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_343_38_343_40&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">)
                    </span><a href="#loc_327_5_327_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_327_5_327_15&#39;)"><span class="hl_varref"><span class="mpre">fillBuffer</span></span></a><span class="mpre"> </span><a href="#loc_322_20_322_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_20_322_27&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a href="#loc_343_41_343_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_343_41_343_49&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run the builder with a &#39;defaultBufferSize&#39;d buffer and execute the given</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;IO&#39; action whenever the buffer is full or gets flushed.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @ &#39;toByteStringIO&#39; = &#39;toByteStringIOWith&#39; &#39;defaultBufferSize&#39;@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This is a &#39;Monoid&#39; homomorphism in the following sense.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; toByteStringIO io mempty          == return ()</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; toByteStringIO io (x `mappend` y) == toByteStringIO io x &gt;&gt; toByteStringIO io y</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_359_1_359_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_359_1_359_15&#39;)"><span class="mpre">toByteStringIO</span></a><span class="mpre"> :: (</span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">) -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_359_1_359_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_359_1_359_15&#39;)"><span class="hl_vardecl"><span class="mpre">toByteStringIO</span></span></a><span class="mpre"> = </span><a href="#loc_322_1_322_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_1_322_19&#39;)"><span class="hl_varref"><span class="mpre">toByteStringIOWith</span></span></a><span class="mpre"> </span><a href="#loc_84_1_84_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_1_84_18&#39;)"><span class="hl_varref"><span class="mpre">defaultBufferSize</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_359_1_359_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_359_1_359_15&#39;)"><span class="mpre">toByteStringIO</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run a &#39;Write&#39; to produce a strict &#39;S.ByteString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This is equivalent to @(&#39;toByteString&#39; . &#39;fromWrite&#39;)@, but is more</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- efficient because it uses just one appropriately-sized buffer.</span></span><span class="mpre">
</span><a href="#loc_366_1_366_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_366_1_366_18&#39;)"><span class="mpre">writeToByteString</span></a><span class="mpre"> :: </span><a href="Blaze.ByteString.Builder.Internal.Write.html#loc_98_6_98_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Write.html#loc_98_6_98_11&#39;)"><span class="hl_tyconref"><span class="mpre">Write</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
</span><a name="loc_366_1_366_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_366_1_366_18&#39;)"><span class="hl_fundecl"><span class="mpre">writeToByteString</span></span></a><span class="mpre"> !</span><a name="loc_366_20_366_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_366_20_366_21&#39;)"><span class="hl_vardecl"><span class="mpre">w</span></span></a><span class="mpre"> = </span><a href="GHC.IO.html#loc_182_1_182_23" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_182_1_182_23&#39;)"><span class="hl_varref"><span class="mpre">unsafeDupablePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
    </span><a name="loc_367_5_367_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_5_367_9&#39;)"><span class="hl_vardecl"><span class="mpre">fptr</span></span></a><span class="mpre"> &lt;- </span><a href="Data.ByteString.Internal.html#loc_489_1_489_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_489_1_489_17&#39;)"><span class="hl_varref"><span class="mpre">S.mallocByteString</span></span></a><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Write.html#loc_113_1_113_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Write.html#loc_113_1_113_9&#39;)"><span class="hl_varref"><span class="mpre">getBound</span></span></a><span class="mpre"> </span><a href="#loc_366_20_366_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_366_20_366_21&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre">)
    </span><a name="loc_368_5_368_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_5_368_8&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">withForeignPtr</span></span><span class="mpre"> </span><a href="#loc_367_5_367_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_5_367_9&#39;)"><span class="hl_varref"><span class="mpre">fptr</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_368_35_368_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_35_368_38&#39;)"><span class="hl_vardecl"><span class="mpre">ptr</span></span></a><span class="mpre"> -&gt; do
        </span><a name="loc_369_9_369_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_369_9_369_12&#39;)"><span class="hl_vardecl"><span class="mpre">end</span></span></a><span class="mpre"> &lt;- </span><a href="Blaze.ByteString.Builder.Internal.Write.html#loc_108_1_108_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Write.html#loc_108_1_108_9&#39;)"><span class="hl_varref"><span class="mpre">runWrite</span></span></a><span class="mpre"> </span><a href="#loc_366_20_366_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_366_20_366_21&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre"> </span><a href="#loc_368_35_368_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_35_368_38&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><a href="#loc_369_9_369_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_369_9_369_12&#39;)"><span class="hl_varref"><span class="mpre">end</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_368_35_368_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_35_368_38&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_400_1_400_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_400_1_400_15&#39;)"><span class="hl_varref"><span class="mpre">S.fromForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_367_5_367_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_5_367_9&#39;)"><span class="hl_varref"><span class="mpre">fptr</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><a href="#loc_368_5_368_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_5_368_8&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_366_1_366_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_366_1_366_18&#39;)"><span class="mpre">writeToByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Draft of new builder/put execution code</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">{- FIXME: Generalize this code such that it can replace the above clunky
 - implementations.

-- | A monad for lazily composing lazy bytestrings using continuations.
newtype LBSM a = LBSM { unLBSM :: (a, L.ByteString -&gt; L.ByteString) }

instance Monad LBSM where
    return x                       = LBSM (x, id)
    (LBSM (x,k)) &gt;&gt;= f             = let LBSM (x&#39;,k&#39;) = f x in LBSM (x&#39;, k . k&#39;)
    (LBSM (_,k)) &gt;&gt; (LBSM (x&#39;,k&#39;)) = LBSM (x&#39;, k . k&#39;)

-- | Execute a put and return the written buffers as the chunks of a lazy
-- bytestring.
toLazyByteString :: Put a -&gt; (a, L.ByteString)
toLazyByteString put =
    (fst result, k (bufToLBSCont (snd result) L.empty))
  where

    -- FIXME: Check with ByteString guys why allocation in inlinePerformIO is
    -- bad.

    -- initial buffer
    buf0 = S.inlinePerformIO $ allocBuffer defaultBufferSize
    -- run put, but don&#39;t force result =&gt; we&#39;re lazy enough
    LBSM (result, k) = runPut liftIO outputBuf outputBS put buf0
    -- convert a buffer to a lazy bytestring continuation
    bufToLBSCont = maybe id L.Chunk . unsafeFreezeNonEmptyBuffer
    -- lifting an io putsignal to a lazy bytestring monad
    liftIO io = LBSM (S.inlinePerformIO io, id)
    -- add buffer as a chunk prepare allocation of new one
    outputBuf minSize buf = LBSM
        ( S.inlinePerformIO $ allocBuffer (max minSize defaultBufferSize)
        , bufToLBSCont buf )
    -- add bytestring directly as a chunk; exploits postcondition of runPut
    -- that bytestrings are non-empty
    outputBS bs = LBSM ((), L.Chunk bs)


{-
-- | A Builder that traces a message
traceBuilder :: String -&gt; Builder
traceBuilder msg = fromBuildStepCont $ \k br@(BufRange op ope) -&gt; do
    putStrLn $ &quot;traceBuilder &quot; ++ show (op, ope) ++ &quot;: &quot; ++ msg
    k br

test2 :: Word8 -&gt; [S.ByteString]
test2 x = L.toChunks $ toLazyByteString2 $ fromBuilder $ mconcat
  [ traceBuilder &quot;before flush&quot;
  , fromWord8 48
  , flushBuilder
  , flushBuilder
  , traceBuilder &quot;after flush&quot;
  , fromWord8 x
  ]

-}

-}</span></span><span class="mpre">
</span></div></body></html>