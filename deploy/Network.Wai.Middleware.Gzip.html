<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE Rank2Types #-}
{-# LANGUAGE ScopedTypeVariables #-}
{-# LANGUAGE OverloadedStrings #-}
</span><span class="hl_comment"><span class="mpre">---------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module        : Network.Wai.Middleware.Gzip</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright     : Michael Snoyman</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License       : BSD3</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer    : Michael Snoyman &lt;michael@snoyman.com&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability     : Unstable</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability   : portable</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Automatic gzip compression of responses.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">---------------------------------------------------------</span></span><span class="mpre">
module Network.Wai.Middleware.Gzip
    ( gzip
    , GzipSettings
    , gzipFiles
    , GzipFiles (..)
    , gzipCheckMime
    , def
    , defaultCheckMime
    ) where

import Network.Wai
import Data.Maybe (</span><a href="Data.Maybe.html#loc_98_1_98_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_98_1_98_10&#39;)"><span class="mpre">fromMaybe</span></a><span class="mpre">, </span><a href="Data.Maybe.html#loc_80_1_80_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_80_1_80_7&#39;)"><span class="mpre">isJust</span></a><span class="mpre">)
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/Gzip.hs&quot;, srcSpanStartLine = 29, srcSpanStartColumn = 18, srcSpanEndLine = 29, srcSpanEndColumn = 39}, srcInfoPoints = []}) &quot;Data.ByteString.Char8&quot;"><span class="mpre">Data.ByteString.Char8</span></span><span class="mpre"> as S8
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/Gzip.hs&quot;, srcSpanStartLine = 30, srcSpanStartColumn = 18, srcSpanEndLine = 30, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre"> as S
import Data.Default.Class
import Network.HTTP.Types (</span><a href="Network.HTTP.Types.Status.html#loc_114_6_114_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.HTTP.Types.Status.html#loc_114_6_114_12&#39;)"><span class="mpre">Status</span></a><span class="mpre">, Header)
import Control.Monad.IO.Class (</span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="mpre">liftIO</span></a><span class="mpre">)
import Control.Monad.Trans.Resource (</span><a href="Control.Monad.Trans.Resource.html#loc_200_1_200_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.Resource.html#loc_200_1_200_13&#39;)"><span class="mpre">runResourceT</span></a><span class="mpre">)
import System.Directory (</span><a href="System.Directory.html#loc_726_1_726_14" onmouseover="nemnem.highlightLocalToRemote(&#39;System.Directory.html#loc_726_1_726_14&#39;)"><span class="mpre">doesFileExist</span></a><span class="mpre">, </span><a href="System.Directory.html#loc_267_1_267_25" onmouseover="nemnem.highlightLocalToRemote(&#39;System.Directory.html#loc_267_1_267_25&#39;)"><span class="mpre">createDirectoryIfMissing</span></a><span class="mpre">)
import Blaze.ByteString.Builder (</span><a href="Blaze.ByteString.Builder.ByteString.html#loc_94_1_94_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.ByteString.html#loc_94_1_94_15&#39;)"><span class="mpre">fromByteString</span></a><span class="mpre">)
import Control.Exception (</span><a href="Control.Exception.Base.html#loc_212_1_212_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_212_1_212_4&#39;)"><span class="mpre">try</span></a><span class="mpre">, SomeException)
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/Gzip.hs&quot;, srcSpanStartLine = 38, srcSpanStartColumn = 18, srcSpanEndLine = 38, srcSpanEndColumn = 26}, srcInfoPoints = []}) &quot;Data.Set&quot;"><span class="mpre">Data.Set</span></span><span class="mpre"> as Set
import Network.Wai.Internal
import qualified Data.Streaming.Blaze as B
import qualified Data.Streaming.Zlib as Z
import qualified Blaze.ByteString.Builder as Blaze
import Control.Monad (</span><a href="Control.Monad.html#loc_270_1_270_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_270_1_270_7&#39;)"><span class="mpre">unless</span></a><span class="mpre">)
import Data.Function (</span><a href="Data.Function.html#loc_32_1_32_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Function.html#loc_32_1_32_4&#39;)"><span class="mpre">fix</span></a><span class="mpre">)
import Control.Exception (</span><a href="GHC.IO.html#loc_304_1_304_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_304_1_304_8&#39;)"><span class="mpre">throwIO</span></a><span class="mpre">)
import qualified System.IO as IO
import Data.ByteString.Lazy.Internal (</span><a href="Data.ByteString.Lazy.Internal.html#loc_208_1_208_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_208_1_208_17&#39;)"><span class="mpre">defaultChunkSize</span></a><span class="mpre">)

data </span><a name="loc_49_6_49_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_49_6_49_18&#39;)"><span class="hl_tycondecl"><span class="mpre">GzipSettings</span></span></a><span class="mpre"> = </span><a name="loc_49_21_49_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_49_21_49_33&#39;)"><span class="hl_condecl"><span class="mpre">GzipSettings</span></span></a><span class="mpre">
    { </span><a name="loc_50_7_50_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_7_50_16&#39;)"><span class="hl_fielddecl"><span class="mpre">gzipFiles</span></span></a><span class="mpre"> :: </span><a href="#loc_54_6_54_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_6_54_15&#39;)"><span class="hl_tyconref"><span class="mpre">GzipFiles</span></span></a><span class="mpre">
    , </span><a name="loc_51_7_51_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_7_51_20&#39;)"><span class="hl_fielddecl"><span class="mpre">gzipCheckMime</span></span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
    }

data </span><a name="loc_54_6_54_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_6_54_15&#39;)"><span class="hl_tycondecl"><span class="mpre">GzipFiles</span></span></a><span class="mpre"> = </span><a name="loc_54_18_54_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_18_54_28&#39;)"><span class="hl_condecl"><span class="mpre">GzipIgnore</span></span></a><span class="mpre"> | </span><a name="loc_54_31_54_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_31_54_43&#39;)"><span class="hl_condecl"><span class="mpre">GzipCompress</span></span></a><span class="mpre"> | </span><a name="loc_54_46_54_61" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_46_54_61&#39;)"><span class="hl_condecl"><span class="mpre">GzipCacheFolder</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">FilePath</span></span><span class="mpre">
    </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/Gzip.hs&quot;, srcSpanStartLine = 55, srcSpanStartColumn = 5, srcSpanEndLine = 55, srcSpanEndColumn = 30}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/Gzip.hs&quot;, srcSpanStartLine = 55, srcSpanStartColumn = 5, srcSpanEndLine = 55, srcSpanEndColumn = 13},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai"><span class="mpre">deriving (Show, Eq, Read)</span></span><span class="mpre">

instance </span><a href="Data.Default.Class.html#loc_38_7_38_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Default.Class.html#loc_38_7_38_14&#39;)"><span class="hl_classref"><span class="mpre">Default</span></span></a><span class="mpre"> </span><a href="#loc_49_6_49_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_49_6_49_18&#39;)"><span class="hl_tyconref"><span class="mpre">GzipSettings</span></span></a><span class="mpre"> where
    </span><a href="Data.Default.Class.html#loc_40_5_40_8" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Default.Class.html#loc_40_5_40_8&#39;)"><span class="hl_vardecl"><span class="mpre">def</span></span></a><span class="mpre"> = </span><a href="#loc_49_21_49_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_49_21_49_33&#39;)"><span class="hl_conref"><span class="mpre">GzipSettings</span></span></a><span class="mpre"> </span><a href="#loc_54_18_54_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_18_54_28&#39;)"><span class="hl_conref"><span class="mpre">GzipIgnore</span></span></a><span class="mpre"> </span><a href="#loc_61_1_61_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_61_1_61_17&#39;)"><span class="hl_varref"><span class="mpre">defaultCheckMime</span></span></a><span class="mpre">

</span><a href="#loc_61_1_61_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_61_1_61_17&#39;)"><span class="mpre">defaultCheckMime</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
</span><a name="loc_61_1_61_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_61_1_61_17&#39;)"><span class="hl_fundecl"><span class="mpre">defaultCheckMime</span></span></a><span class="mpre"> </span><a name="loc_61_18_61_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_61_18_61_20&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> =
    </span><span class="hl_varref"><span class="mpre">S8.isPrefixOf</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;text/&quot;</span></span><span class="mpre"> </span><a href="#loc_61_18_61_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_61_18_61_20&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">||</span></span><span class="mpre"> </span><a href="#loc_64_5_64_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_5_64_8&#39;)"><span class="hl_varref"><span class="mpre">bs&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`Set.member`</span></span><span class="mpre"> </span><a href="#loc_65_5_65_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_5_65_15&#39;)"><span class="hl_varref"><span class="mpre">toCompress</span></span></a><span class="mpre">
  where
    </span><a name="loc_64_5_64_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_5_64_8&#39;)"><span class="hl_vardecl"><span class="mpre">bs&#39;</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fst</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">S.breakByte</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">59</span></span><span class="mpre"> </span><a href="#loc_61_18_61_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_61_18_61_20&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- semicolon</span></span><span class="mpre">
    </span><a name="loc_65_5_65_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_5_65_15&#39;)"><span class="hl_vardecl"><span class="mpre">toCompress</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">Set.fromList</span></span><span class="mpre">
        [ </span><span class="hl_string"><span class="mpre">&quot;application/json&quot;</span></span><span class="mpre">
        , </span><span class="hl_string"><span class="mpre">&quot;application/javascript&quot;</span></span><span class="mpre">
        , </span><span class="hl_string"><span class="mpre">&quot;application/ecmascript&quot;</span></span><span class="mpre">
        ]

</span><span class="hl_comment"><span class="mpre">-- | Use gzip to compress the body of the response.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Analyzes the \&quot;Accept-Encoding\&quot; header from the client to determine</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- if gzip is supported.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Possible future enhancements:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * Only compress if the response is above a certain size.</span></span><span class="mpre">
</span><a href="#loc_80_1_80_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_1_80_5&#39;)"><span class="mpre">gzip</span></a><span class="mpre"> :: </span><a href="#loc_49_6_49_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_49_6_49_18&#39;)"><span class="hl_tyconref"><span class="mpre">GzipSettings</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Middleware</span></span><span class="mpre">
</span><a name="loc_80_1_80_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_1_80_5&#39;)"><span class="hl_fundecl"><span class="mpre">gzip</span></span></a><span class="mpre"> </span><a name="loc_80_6_80_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_6_80_9&#39;)"><span class="hl_vardecl"><span class="mpre">set</span></span></a><span class="mpre"> </span><a name="loc_80_10_80_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_10_80_13&#39;)"><span class="hl_vardecl"><span class="mpre">app</span></span></a><span class="mpre"> </span><a name="loc_80_14_80_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_14_80_17&#39;)"><span class="hl_vardecl"><span class="mpre">env</span></span></a><span class="mpre"> </span><a name="loc_80_18_80_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_18_80_30&#39;)"><span class="hl_vardecl"><span class="mpre">sendResponse</span></span></a><span class="mpre"> = </span><a href="#loc_80_10_80_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_10_80_13&#39;)"><span class="hl_varref"><span class="mpre">app</span></span></a><span class="mpre"> </span><a href="#loc_80_14_80_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_14_80_17&#39;)"><span class="hl_varref"><span class="mpre">env</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_80_44_80_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_44_80_47&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> -&gt;
    case </span><a href="#loc_80_44_80_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_44_80_47&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre"> of
        </span><span class="warning" data-warning="PatPRec (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/Gzip.hs&quot;, srcSpanStartLine = 82, srcSpanStartColumn = 9, srcSpanEndLine = 82, srcSpanEndColumn = 22}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/Gzip.hs&quot;, srcSpanStartLine = 82, srcSpanStartColumn = 20, srcSpanEndLine = 82, srcSpanEndColumn = 21},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Mi"><span class="mpre">ResponseRaw{}</span></span><span class="mpre"> -&gt; </span><a href="#loc_80_18_80_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_18_80_30&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre"> </span><a href="#loc_80_44_80_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_44_80_47&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">
        </span><span class="warning" data-warning="PatPRec (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/Gzip.hs&quot;, srcSpanStartLine = 83, srcSpanStartColumn = 9, srcSpanEndLine = 83, srcSpanEndColumn = 23}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/Gzip.hs&quot;, srcSpanStartLine = 83, srcSpanStartColumn = 21, srcSpanEndLine = 83, srcSpanEndColumn = 22},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Mi"><span class="mpre">ResponseFile{}</span></span><span class="mpre"> | </span><a href="#loc_50_7_50_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_7_50_16&#39;)"><span class="hl_varref"><span class="mpre">gzipFiles</span></span></a><span class="mpre"> </span><a href="#loc_80_6_80_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_6_80_9&#39;)"><span class="hl_varref"><span class="mpre">set</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_54_18_54_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_18_54_28&#39;)"><span class="hl_conref"><span class="mpre">GzipIgnore</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_80_18_80_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_18_80_30&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre"> </span><a href="#loc_80_44_80_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_44_80_47&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">
        _ -&gt; if </span><span class="hl_string"><span class="mpre">&quot;gzip&quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`elem`</span></span><span class="mpre"> </span><a href="#loc_95_5_95_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_5_95_8&#39;)"><span class="hl_varref"><span class="mpre">enc</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">not</span></span><span class="mpre"> </span><a href="#loc_98_5_98_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_5_98_12&#39;)"><span class="hl_varref"><span class="mpre">isMSIE6</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">not</span></span><span class="mpre"> (</span><a href="#loc_99_5_99_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_5_99_14&#39;)"><span class="hl_varref"><span class="mpre">isEncoded</span></span></a><span class="mpre"> </span><a href="#loc_80_44_80_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_44_80_47&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">)
                then
                    case (</span><a href="#loc_80_44_80_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_44_80_47&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">, </span><a href="#loc_50_7_50_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_7_50_16&#39;)"><span class="hl_varref"><span class="mpre">gzipFiles</span></span></a><span class="mpre"> </span><a href="#loc_80_6_80_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_6_80_9&#39;)"><span class="hl_varref"><span class="mpre">set</span></span></a><span class="mpre">) of
                        (</span><a href="Network.Wai.Internal.html#loc_75_7_75_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Internal.html#loc_75_7_75_19&#39;)"><span class="hl_conref"><span class="mpre">ResponseFile</span></span></a><span class="mpre"> </span><a name="loc_87_39_87_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_39_87_40&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_87_41_87_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_41_87_43&#39;)"><span class="hl_vardecl"><span class="mpre">hs</span></span></a><span class="mpre"> </span><a name="loc_87_44_87_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_44_87_48&#39;)"><span class="hl_vardecl"><span class="mpre">file</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">, </span><a href="#loc_54_46_54_61" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_46_54_61&#39;)"><span class="hl_conref"><span class="mpre">GzipCacheFolder</span></span></a><span class="mpre"> </span><a name="loc_87_74_87_79" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_74_87_79&#39;)"><span class="hl_vardecl"><span class="mpre">cache</span></span></a><span class="mpre">) -&gt;
                            case </span><span class="hl_varref"><span class="mpre">lookup</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;content-type&quot;</span></span><span class="mpre"> </span><a href="#loc_87_41_87_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_41_87_43&#39;)"><span class="hl_varref"><span class="mpre">hs</span></span></a><span class="mpre"> of
                                </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_89_38_89_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_38_89_39&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre">
                                    | </span><a href="#loc_51_7_51_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_7_51_20&#39;)"><span class="hl_varref"><span class="mpre">gzipCheckMime</span></span></a><span class="mpre"> </span><a href="#loc_80_6_80_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_6_80_9&#39;)"><span class="hl_varref"><span class="mpre">set</span></span></a><span class="mpre"> </span><a href="#loc_89_38_89_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_38_89_39&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_102_1_102_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_1_102_13&#39;)"><span class="hl_varref"><span class="mpre">compressFile</span></span></a><span class="mpre"> </span><a href="#loc_87_39_87_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_39_87_40&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> </span><a href="#loc_87_41_87_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_41_87_43&#39;)"><span class="hl_varref"><span class="mpre">hs</span></span></a><span class="mpre"> </span><a href="#loc_87_44_87_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_44_87_48&#39;)"><span class="hl_varref"><span class="mpre">file</span></span></a><span class="mpre"> </span><a href="#loc_87_74_87_79" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_74_87_79&#39;)"><span class="hl_varref"><span class="mpre">cache</span></span></a><span class="mpre"> </span><a href="#loc_80_18_80_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_18_80_30&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre">
                                _ -&gt; </span><a href="#loc_80_18_80_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_18_80_30&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre"> </span><a href="#loc_80_44_80_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_44_80_47&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">
                        _ -&gt; </span><a href="#loc_147_1_147_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_1_147_10&#39;)"><span class="hl_varref"><span class="mpre">compressE</span></span></a><span class="mpre"> </span><a href="#loc_80_6_80_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_6_80_9&#39;)"><span class="hl_varref"><span class="mpre">set</span></span></a><span class="mpre"> </span><a href="#loc_80_44_80_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_44_80_47&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre"> </span><a href="#loc_80_18_80_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_18_80_30&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre">
                else </span><a href="#loc_80_18_80_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_18_80_30&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre"> </span><a href="#loc_80_44_80_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_44_80_47&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">
  where
    </span><a name="loc_95_5_95_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_5_95_8&#39;)"><span class="hl_vardecl"><span class="mpre">enc</span></span></a><span class="mpre"> = </span><a href="Data.Maybe.html#loc_98_1_98_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_98_1_98_10&#39;)"><span class="hl_varref"><span class="mpre">fromMaybe</span></span></a><span class="mpre"> [] </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> (</span><a href="#loc_191_1_191_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_1_191_12&#39;)"><span class="hl_varref"><span class="mpre">splitCommas</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">S8.unpack</span></span><span class="mpre">)
                    </span><span class="hl_infix"><span class="mpre">`fmap`</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">lookup</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;Accept-Encoding&quot;</span></span><span class="mpre"> (</span><a href="Network.Wai.Internal.html#loc_36_6_36_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Internal.html#loc_36_6_36_20&#39;)"><span class="hl_varref"><span class="mpre">requestHeaders</span></span></a><span class="mpre"> </span><a href="#loc_80_14_80_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_14_80_17&#39;)"><span class="hl_varref"><span class="mpre">env</span></span></a><span class="mpre">)
    </span><a name="loc_97_5_97_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_5_97_7&#39;)"><span class="hl_vardecl"><span class="mpre">ua</span></span></a><span class="mpre"> = </span><a href="Data.Maybe.html#loc_98_1_98_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_98_1_98_10&#39;)"><span class="hl_varref"><span class="mpre">fromMaybe</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;&quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">lookup</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;user-agent&quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.Wai.Internal.html#loc_36_6_36_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Internal.html#loc_36_6_36_20&#39;)"><span class="hl_varref"><span class="mpre">requestHeaders</span></span></a><span class="mpre"> </span><a href="#loc_80_14_80_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_14_80_17&#39;)"><span class="hl_varref"><span class="mpre">env</span></span></a><span class="mpre">
    </span><a name="loc_98_5_98_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_5_98_12&#39;)"><span class="hl_vardecl"><span class="mpre">isMSIE6</span></span></a><span class="mpre"> = </span><span class="hl_string"><span class="mpre">&quot;MSIE 6&quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`S.isInfixOf`</span></span><span class="mpre"> </span><a href="#loc_97_5_97_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_5_97_7&#39;)"><span class="hl_varref"><span class="mpre">ua</span></span></a><span class="mpre">
    </span><a name="loc_99_5_99_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_5_99_14&#39;)"><span class="hl_fundecl"><span class="mpre">isEncoded</span></span></a><span class="mpre"> </span><a name="loc_99_15_99_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_15_99_18&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> = </span><a href="Data.Maybe.html#loc_80_1_80_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_80_1_80_7&#39;)"><span class="hl_varref"><span class="mpre">isJust</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">lookup</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;Content-Encoding&quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.Wai.html#loc_187_1_187_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.html#loc_187_1_187_16&#39;)"><span class="hl_varref"><span class="mpre">responseHeaders</span></span></a><span class="mpre"> </span><a href="#loc_99_15_99_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_15_99_18&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">

</span><a href="#loc_102_1_102_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_1_102_13&#39;)"><span class="mpre">compressFile</span></a><span class="mpre"> :: </span><a href="Network.HTTP.Types.Status.html#loc_114_6_114_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.HTTP.Types.Status.html#loc_114_6_114_12&#39;)"><span class="hl_tyconref"><span class="mpre">Status</span></span></a><span class="mpre"> -&gt; [</span><span class="hl_tyconref"><span class="mpre">Header</span></span><span class="mpre">] -&gt; </span><span class="hl_tyconref"><span class="mpre">FilePath</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">FilePath</span></span><span class="mpre"> -&gt; (</span><a href="Network.Wai.Internal.html#loc_74_6_74_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Internal.html#loc_74_6_74_14&#39;)"><span class="hl_tyconref"><span class="mpre">Response</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_102_1_102_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_1_102_13&#39;)"><span class="hl_fundecl"><span class="mpre">compressFile</span></span></a><span class="mpre"> </span><a name="loc_102_14_102_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_14_102_15&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_102_16_102_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_16_102_18&#39;)"><span class="hl_vardecl"><span class="mpre">hs</span></span></a><span class="mpre"> </span><a name="loc_102_19_102_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_19_102_23&#39;)"><span class="hl_vardecl"><span class="mpre">file</span></span></a><span class="mpre"> </span><a name="loc_102_24_102_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_24_102_29&#39;)"><span class="hl_vardecl"><span class="mpre">cache</span></span></a><span class="mpre"> </span><a name="loc_102_30_102_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_30_102_42&#39;)"><span class="hl_vardecl"><span class="mpre">sendResponse</span></span></a><span class="mpre"> = do
    </span><a name="loc_103_5_103_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_5_103_6&#39;)"><span class="hl_vardecl"><span class="mpre">e</span></span></a><span class="mpre"> &lt;- </span><a href="System.Directory.html#loc_726_1_726_14" onmouseover="nemnem.highlightLocalToRemote(&#39;System.Directory.html#loc_726_1_726_14&#39;)"><span class="hl_varref"><span class="mpre">doesFileExist</span></span></a><span class="mpre"> </span><a href="#loc_134_5_134_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_5_134_12&#39;)"><span class="hl_varref"><span class="mpre">tmpfile</span></span></a><span class="mpre">
    if </span><a href="#loc_103_5_103_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_5_103_6&#39;)"><span class="hl_varref"><span class="mpre">e</span></span></a><span class="mpre">
        then </span><a href="#loc_130_5_130_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_5_130_11&#39;)"><span class="hl_varref"><span class="mpre">onSucc</span></span></a><span class="mpre">
        else do
            </span><a href="System.Directory.html#loc_267_1_267_25" onmouseover="nemnem.highlightLocalToRemote(&#39;System.Directory.html#loc_267_1_267_25&#39;)"><span class="hl_varref"><span class="mpre">createDirectoryIfMissing</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre"> </span><a href="#loc_102_24_102_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_24_102_29&#39;)"><span class="hl_varref"><span class="mpre">cache</span></span></a><span class="mpre">
            </span><a name="loc_108_13_108_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_108_13_108_14&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> &lt;- </span><a href="Control.Exception.Base.html#loc_212_1_212_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_212_1_212_4&#39;)"><span class="hl_varref"><span class="mpre">try</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
                 </span><a href="System.IO.html#loc_397_1_397_15" onmouseover="nemnem.highlightLocalToRemote(&#39;System.IO.html#loc_397_1_397_15&#39;)"><span class="hl_varref"><span class="mpre">IO.withBinaryFile</span></span></a><span class="mpre"> </span><a href="#loc_102_19_102_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_19_102_23&#39;)"><span class="hl_varref"><span class="mpre">file</span></span></a><span class="mpre"> </span><a href="GHC.IO.IOMode.html#loc_28_21_28_29" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.IOMode.html#loc_28_21_28_29&#39;)"><span class="hl_conref"><span class="mpre">IO.ReadMode</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_109_56_109_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_109_56_109_59&#39;)"><span class="hl_vardecl"><span class="mpre">inH</span></span></a><span class="mpre"> -&gt;
                 </span><a href="System.IO.html#loc_397_1_397_15" onmouseover="nemnem.highlightLocalToRemote(&#39;System.IO.html#loc_397_1_397_15&#39;)"><span class="hl_varref"><span class="mpre">IO.withBinaryFile</span></span></a><span class="mpre"> </span><a href="#loc_134_5_134_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_5_134_12&#39;)"><span class="hl_varref"><span class="mpre">tmpfile</span></span></a><span class="mpre"> </span><a href="GHC.IO.IOMode.html#loc_28_32_28_41" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.IOMode.html#loc_28_32_28_41&#39;)"><span class="hl_conref"><span class="mpre">IO.WriteMode</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_110_60_110_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_60_110_64&#39;)"><span class="hl_vardecl"><span class="mpre">outH</span></span></a><span class="mpre"> -&gt; do
                    </span><a name="loc_111_21_111_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_21_111_28&#39;)"><span class="hl_vardecl"><span class="mpre">deflate</span></span></a><span class="mpre"> &lt;- </span><a href="Data.Streaming.Zlib.html#loc_132_1_132_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_132_1_132_12&#39;)"><span class="hl_varref"><span class="mpre">Z.initDeflate</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">7</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Z.WindowBits</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">31</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- FIXME this code should write to a temporary file, then</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- rename to the final file</span></span><span class="mpre">
                    let </span><a name="loc_114_25_114_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_25_114_33&#39;)"><span class="hl_fundecl"><span class="mpre">goPopper</span></span></a><span class="mpre"> </span><a name="loc_114_34_114_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_34_114_40&#39;)"><span class="hl_vardecl"><span class="mpre">popper</span></span></a><span class="mpre"> = </span><a href="Data.Function.html#loc_32_1_32_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Function.html#loc_32_1_32_4&#39;)"><span class="hl_varref"><span class="mpre">fix</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_114_50_114_54" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_50_114_54&#39;)"><span class="hl_vardecl"><span class="mpre">loop</span></span></a><span class="mpre"> -&gt; do
                            </span><a name="loc_115_29_115_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_29_115_32&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_114_34_114_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_34_114_40&#39;)"><span class="hl_varref"><span class="mpre">popper</span></span></a><span class="mpre">
                            case </span><a href="#loc_115_29_115_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_29_115_32&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre"> of
                                </span><a href="Data.Streaming.Zlib.html#loc_194_18_194_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_194_18_194_24&#39;)"><span class="hl_conref"><span class="mpre">Z.PRDone</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
                                </span><a href="Data.Streaming.Zlib.html#loc_195_18_195_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_195_18_195_24&#39;)"><span class="hl_conref"><span class="mpre">Z.PRNext</span></span></a><span class="mpre"> </span><a name="loc_118_42_118_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_42_118_44&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> -&gt; do
                                    </span><span class="hl_varref"><span class="mpre">S.hPut</span></span><span class="mpre"> </span><a href="#loc_110_60_110_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_60_110_64&#39;)"><span class="hl_varref"><span class="mpre">outH</span></span></a><span class="mpre"> </span><a href="#loc_118_42_118_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_42_118_44&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
                                    </span><a href="#loc_114_50_114_54" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_50_114_54&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre">
                                </span><a href="Data.Streaming.Zlib.html#loc_196_18_196_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_196_18_196_25&#39;)"><span class="hl_conref"><span class="mpre">Z.PRError</span></span></a><span class="mpre"> </span><a name="loc_121_43_121_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_43_121_44&#39;)"><span class="hl_vardecl"><span class="mpre">e</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.IO.html#loc_304_1_304_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_304_1_304_8&#39;)"><span class="hl_varref"><span class="mpre">throwIO</span></span></a><span class="mpre"> </span><a href="#loc_121_43_121_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_43_121_44&#39;)"><span class="hl_varref"><span class="mpre">e</span></span></a><span class="mpre">
                    </span><a href="Data.Function.html#loc_32_1_32_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Function.html#loc_32_1_32_4&#39;)"><span class="hl_varref"><span class="mpre">fix</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_122_28_122_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_28_122_32&#39;)"><span class="hl_vardecl"><span class="mpre">loop</span></span></a><span class="mpre"> -&gt; do
                        </span><a name="loc_123_25_123_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_123_25_123_27&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">S.hGetSome</span></span><span class="mpre"> </span><a href="#loc_109_56_109_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_109_56_109_59&#39;)"><span class="hl_varref"><span class="mpre">inH</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_208_1_208_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_208_1_208_17&#39;)"><span class="hl_varref"><span class="mpre">defaultChunkSize</span></span></a><span class="mpre">
                        </span><a href="Control.Monad.html#loc_270_1_270_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_270_1_270_7&#39;)"><span class="hl_varref"><span class="mpre">unless</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">S.null</span></span><span class="mpre"> </span><a href="#loc_123_25_123_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_123_25_123_27&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
                            </span><a href="Data.Streaming.Zlib.html#loc_261_1_261_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_261_1_261_12&#39;)"><span class="hl_varref"><span class="mpre">Z.feedDeflate</span></span></a><span class="mpre"> </span><a href="#loc_111_21_111_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_21_111_28&#39;)"><span class="hl_varref"><span class="mpre">deflate</span></span></a><span class="mpre"> </span><a href="#loc_123_25_123_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_123_25_123_27&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_114_25_114_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_25_114_33&#39;)"><span class="hl_varref"><span class="mpre">goPopper</span></span></a><span class="mpre">
                            </span><a href="#loc_122_28_122_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_28_122_32&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre">
                    </span><a href="#loc_114_25_114_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_25_114_33&#39;)"><span class="hl_varref"><span class="mpre">goPopper</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.Streaming.Zlib.html#loc_271_1_271_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_271_1_271_14&#39;)"><span class="hl_varref"><span class="mpre">Z.finishDeflate</span></span></a><span class="mpre"> </span><a href="#loc_111_21_111_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_21_111_28&#39;)"><span class="hl_varref"><span class="mpre">deflate</span></span></a><span class="mpre">
            </span><span class="hl_varref"><span class="mpre">either</span></span><span class="mpre"> </span><a href="#loc_132_5_132_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_132_5_132_10&#39;)"><span class="hl_varref"><span class="mpre">onErr</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">const</span></span><span class="mpre"> </span><a href="#loc_130_5_130_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_5_130_11&#39;)"><span class="hl_varref"><span class="mpre">onSucc</span></span></a><span class="mpre">) (</span><a href="#loc_108_13_108_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_108_13_108_14&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Either</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">SomeException</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">) </span><span class="hl_comment"><span class="mpre">-- FIXME bad! don&#39;t catch all exceptions like that!</span></span><span class="mpre">
  where
    </span><a name="loc_130_5_130_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_5_130_11&#39;)"><span class="hl_vardecl"><span class="mpre">onSucc</span></span></a><span class="mpre"> = </span><a href="#loc_102_30_102_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_30_102_42&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.Wai.html#loc_99_1_99_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.html#loc_99_1_99_13&#39;)"><span class="hl_varref"><span class="mpre">responseFile</span></span></a><span class="mpre"> </span><a href="#loc_102_14_102_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_14_102_15&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> (</span><a href="#loc_185_1_185_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_185_1_185_11&#39;)"><span class="hl_varref"><span class="mpre">fixHeaders</span></span></a><span class="mpre"> </span><a href="#loc_102_16_102_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_16_102_18&#39;)"><span class="hl_varref"><span class="mpre">hs</span></span></a><span class="mpre">) </span><a href="#loc_134_5_134_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_5_134_12&#39;)"><span class="hl_varref"><span class="mpre">tmpfile</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">

    </span><a name="loc_132_5_132_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_132_5_132_10&#39;)"><span class="hl_fundecl"><span class="mpre">onErr</span></span></a><span class="mpre"> _ = </span><a href="#loc_102_30_102_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_30_102_42&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.Wai.html#loc_99_1_99_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.html#loc_99_1_99_13&#39;)"><span class="hl_varref"><span class="mpre">responseFile</span></span></a><span class="mpre"> </span><a href="#loc_102_14_102_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_14_102_15&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> </span><a href="#loc_102_16_102_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_16_102_18&#39;)"><span class="hl_varref"><span class="mpre">hs</span></span></a><span class="mpre"> </span><a href="#loc_102_19_102_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_19_102_23&#39;)"><span class="hl_varref"><span class="mpre">file</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- FIXME log the error message</span></span><span class="mpre">

    </span><a name="loc_134_5_134_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_5_134_12&#39;)"><span class="hl_vardecl"><span class="mpre">tmpfile</span></span></a><span class="mpre"> = </span><a href="#loc_102_24_102_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_24_102_29&#39;)"><span class="hl_varref"><span class="mpre">cache</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_char"><span class="mpre">&#39;/&#39;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><a href="#loc_135_5_135_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_5_135_9&#39;)"><span class="hl_varref"><span class="mpre">safe</span></span></a><span class="mpre"> </span><a href="#loc_102_19_102_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_19_102_23&#39;)"><span class="hl_varref"><span class="mpre">file</span></span></a><span class="mpre">
    </span><a name="loc_135_5_135_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_5_135_9&#39;)"><span class="hl_fundecl"><span class="mpre">safe</span></span></a><span class="mpre"> </span><a name="loc_135_10_135_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_10_135_11&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre">
        | </span><span class="hl_char"><span class="mpre">&#39;A&#39;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_135_10_135_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_10_135_11&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_135_10_135_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_10_135_11&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_char"><span class="mpre">&#39;Z&#39;</span></span><span class="mpre"> = </span><a href="#loc_135_10_135_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_10_135_11&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">
        | </span><span class="hl_char"><span class="mpre">&#39;a&#39;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_135_10_135_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_10_135_11&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_135_10_135_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_10_135_11&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_char"><span class="mpre">&#39;z&#39;</span></span><span class="mpre"> = </span><a href="#loc_135_10_135_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_10_135_11&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">
        | </span><span class="hl_char"><span class="mpre">&#39;0&#39;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_135_10_135_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_10_135_11&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_135_10_135_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_10_135_11&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_char"><span class="mpre">&#39;9&#39;</span></span><span class="mpre"> = </span><a href="#loc_135_10_135_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_10_135_11&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">
    </span><a href="#loc_135_5_135_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_5_135_9&#39;)"><span class="hl_fundecl"><span class="mpre">safe</span></span></a><span class="mpre"> </span><span class="hl_char"><span class="mpre">&#39;-&#39;</span></span><span class="mpre"> = </span><span class="hl_char"><span class="mpre">&#39;-&#39;</span></span><span class="mpre">
    </span><a href="#loc_135_5_135_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_5_135_9&#39;)"><span class="hl_fundecl"><span class="mpre">safe</span></span></a><span class="mpre"> </span><span class="hl_char"><span class="mpre">&#39;_&#39;</span></span><span class="mpre"> = </span><span class="hl_char"><span class="mpre">&#39;_&#39;</span></span><span class="mpre">
    </span><a href="#loc_135_5_135_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_5_135_9&#39;)"><span class="hl_fundecl"><span class="mpre">safe</span></span></a><span class="mpre"> _ = </span><span class="hl_char"><span class="mpre">&#39;_&#39;</span></span><span class="mpre">

</span><a href="#loc_147_1_147_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_1_147_10&#39;)"><span class="mpre">compressE</span></a><span class="mpre"> :: </span><a href="#loc_49_6_49_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_49_6_49_18&#39;)"><span class="hl_tyconref"><span class="mpre">GzipSettings</span></span></a><span class="mpre">
          -&gt; </span><a href="Network.Wai.Internal.html#loc_74_6_74_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Internal.html#loc_74_6_74_14&#39;)"><span class="hl_tyconref"><span class="mpre">Response</span></span></a><span class="mpre">
          -&gt; (</span><a href="Network.Wai.Internal.html#loc_74_6_74_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Internal.html#loc_74_6_74_14&#39;)"><span class="hl_tyconref"><span class="mpre">Response</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
          -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_147_1_147_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_1_147_10&#39;)"><span class="hl_fundecl"><span class="mpre">compressE</span></span></a><span class="mpre"> </span><a name="loc_147_11_147_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_11_147_14&#39;)"><span class="hl_vardecl"><span class="mpre">set</span></span></a><span class="mpre"> </span><a name="loc_147_15_147_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_15_147_18&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> </span><a name="loc_147_19_147_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_19_147_31&#39;)"><span class="hl_vardecl"><span class="mpre">sendResponse</span></span></a><span class="mpre"> =
    case </span><span class="hl_varref"><span class="mpre">lookup</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;content-type&quot;</span></span><span class="mpre"> </span><a href="#loc_180_9_180_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_9_180_11&#39;)"><span class="hl_varref"><span class="mpre">hs</span></span></a><span class="mpre"> of
        </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_149_14_149_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_14_149_15&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre"> | </span><a href="#loc_51_7_51_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_7_51_20&#39;)"><span class="hl_varref"><span class="mpre">gzipCheckMime</span></span></a><span class="mpre"> </span><a href="#loc_147_11_147_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_11_147_14&#39;)"><span class="hl_varref"><span class="mpre">set</span></span></a><span class="mpre"> </span><a href="#loc_149_14_149_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_14_149_15&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> -&gt;
            let </span><a name="loc_150_17_150_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_17_150_20&#39;)"><span class="hl_vardecl"><span class="mpre">hs&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_185_1_185_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_185_1_185_11&#39;)"><span class="hl_varref"><span class="mpre">fixHeaders</span></span></a><span class="mpre"> </span><a href="#loc_180_9_180_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_9_180_11&#39;)"><span class="hl_varref"><span class="mpre">hs</span></span></a><span class="mpre">
             in </span><a href="#loc_180_13_180_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_13_180_15&#39;)"><span class="hl_varref"><span class="mpre">wb</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_151_23_151_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_23_151_27&#39;)"><span class="hl_vardecl"><span class="mpre">body</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_147_19_147_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_19_147_31&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.Wai.html#loc_158_1_158_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.html#loc_158_1_158_15&#39;)"><span class="hl_varref"><span class="mpre">responseStream</span></span></a><span class="mpre"> </span><a href="#loc_180_6_180_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_6_180_7&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> </span><a href="#loc_150_17_150_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_17_150_20&#39;)"><span class="hl_varref"><span class="mpre">hs&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_151_70_151_79" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_70_151_79&#39;)"><span class="hl_vardecl"><span class="mpre">sendChunk</span></span></a><span class="mpre"> </span><a name="loc_151_80_151_85" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_80_151_85&#39;)"><span class="hl_vardecl"><span class="mpre">flush</span></span></a><span class="mpre"> -&gt; do
                    (</span><a name="loc_152_22_152_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_22_152_31&#39;)"><span class="hl_vardecl"><span class="mpre">blazeRecv</span></span></a><span class="mpre">, </span><span class="hl_vardecl"><span class="mpre">blazeFinish</span></span><span class="mpre">) &lt;- </span><a href="Data.Streaming.Blaze.html#loc_64_1_64_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Blaze.html#loc_64_1_64_13&#39;)"><span class="hl_varref"><span class="mpre">B.newBlazeRecv</span></span></a><span class="mpre"> </span><a href="Data.Streaming.Blaze.html#loc_61_1_61_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Blaze.html#loc_61_1_61_16&#39;)"><span class="hl_varref"><span class="mpre">B.defaultStrategy</span></span></a><span class="mpre">
                    </span><a name="loc_153_21_153_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_21_153_28&#39;)"><span class="hl_vardecl"><span class="mpre">deflate</span></span></a><span class="mpre"> &lt;- </span><a href="Data.Streaming.Zlib.html#loc_132_1_132_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_132_1_132_12&#39;)"><span class="hl_varref"><span class="mpre">Z.initDeflate</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Z.WindowBits</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">31</span></span><span class="mpre">)
                    let </span><a name="loc_154_25_154_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_25_154_36&#39;)"><span class="hl_fundecl"><span class="mpre">sendBuilder</span></span></a><span class="mpre"> </span><a name="loc_154_37_154_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_37_154_44&#39;)"><span class="hl_vardecl"><span class="mpre">builder</span></span></a><span class="mpre"> = do
                            </span><a name="loc_155_29_155_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_155_29_155_35&#39;)"><span class="hl_vardecl"><span class="mpre">popper</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_152_22_152_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_22_152_31&#39;)"><span class="hl_varref"><span class="mpre">blazeRecv</span></span></a><span class="mpre"> </span><a href="#loc_154_37_154_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_37_154_44&#39;)"><span class="hl_varref"><span class="mpre">builder</span></span></a><span class="mpre">
                            </span><a href="Data.Function.html#loc_32_1_32_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Function.html#loc_32_1_32_4&#39;)"><span class="hl_varref"><span class="mpre">fix</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_156_36_156_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_36_156_40&#39;)"><span class="hl_vardecl"><span class="mpre">loop</span></span></a><span class="mpre"> -&gt; do
                                </span><a name="loc_157_33_157_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_33_157_35&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_155_29_155_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_155_29_155_35&#39;)"><span class="hl_varref"><span class="mpre">popper</span></span></a><span class="mpre">
                                </span><a href="Control.Monad.html#loc_270_1_270_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_270_1_270_7&#39;)"><span class="hl_varref"><span class="mpre">unless</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">S.null</span></span><span class="mpre"> </span><a href="#loc_157_33_157_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_33_157_35&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
                                    </span><a href="#loc_161_25_161_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_25_161_31&#39;)"><span class="hl_varref"><span class="mpre">sendBS</span></span></a><span class="mpre"> </span><a href="#loc_157_33_157_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_33_157_35&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
                                    </span><a href="#loc_156_36_156_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_36_156_40&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre">
                        </span><a name="loc_161_25_161_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_25_161_31&#39;)"><span class="hl_fundecl"><span class="mpre">sendBS</span></span></a><span class="mpre"> </span><a name="loc_161_32_161_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_32_161_34&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> = </span><a href="Data.Streaming.Zlib.html#loc_261_1_261_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_261_1_261_12&#39;)"><span class="hl_varref"><span class="mpre">Z.feedDeflate</span></span></a><span class="mpre"> </span><a href="#loc_153_21_153_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_21_153_28&#39;)"><span class="hl_varref"><span class="mpre">deflate</span></span></a><span class="mpre"> </span><a href="#loc_161_32_161_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_32_161_34&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_166_25_166_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_25_166_38&#39;)"><span class="hl_varref"><span class="mpre">deflatePopper</span></span></a><span class="mpre">
                        </span><a name="loc_162_25_162_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_25_162_37&#39;)"><span class="hl_vardecl"><span class="mpre">flushBuilder</span></span></a><span class="mpre"> = do
                            </span><a href="#loc_154_25_154_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_25_154_36&#39;)"><span class="hl_varref"><span class="mpre">sendBuilder</span></span></a><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.html#loc_139_1_139_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.html#loc_139_1_139_6&#39;)"><span class="hl_varref"><span class="mpre">Blaze.flush</span></span></a><span class="mpre">
                            </span><a href="#loc_166_25_166_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_25_166_38&#39;)"><span class="hl_varref"><span class="mpre">deflatePopper</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.Streaming.Zlib.html#loc_282_1_282_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_282_1_282_13&#39;)"><span class="hl_varref"><span class="mpre">Z.flushDeflate</span></span></a><span class="mpre"> </span><a href="#loc_153_21_153_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_21_153_28&#39;)"><span class="hl_varref"><span class="mpre">deflate</span></span></a><span class="mpre">
                            </span><a href="#loc_151_80_151_85" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_80_151_85&#39;)"><span class="hl_varref"><span class="mpre">flush</span></span></a><span class="mpre">
                        </span><a name="loc_166_25_166_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_25_166_38&#39;)"><span class="hl_fundecl"><span class="mpre">deflatePopper</span></span></a><span class="mpre"> </span><a name="loc_166_39_166_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_39_166_45&#39;)"><span class="hl_vardecl"><span class="mpre">popper</span></span></a><span class="mpre"> = </span><a href="Data.Function.html#loc_32_1_32_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Function.html#loc_32_1_32_4&#39;)"><span class="hl_varref"><span class="mpre">fix</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_166_55_166_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_55_166_59&#39;)"><span class="hl_vardecl"><span class="mpre">loop</span></span></a><span class="mpre"> -&gt; do
                            </span><a name="loc_167_29_167_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_29_167_32&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_166_39_166_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_39_166_45&#39;)"><span class="hl_varref"><span class="mpre">popper</span></span></a><span class="mpre">
                            case </span><a href="#loc_167_29_167_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_29_167_32&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre"> of
                                </span><a href="Data.Streaming.Zlib.html#loc_194_18_194_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_194_18_194_24&#39;)"><span class="hl_conref"><span class="mpre">Z.PRDone</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
                                </span><a href="Data.Streaming.Zlib.html#loc_195_18_195_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_195_18_195_24&#39;)"><span class="hl_conref"><span class="mpre">Z.PRNext</span></span></a><span class="mpre"> </span><a name="loc_170_42_170_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_42_170_45&#39;)"><span class="hl_vardecl"><span class="mpre">bs&#39;</span></span></a><span class="mpre"> -&gt; do
                                    </span><a href="#loc_151_70_151_79" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_70_151_79&#39;)"><span class="hl_varref"><span class="mpre">sendChunk</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.ByteString.html#loc_94_1_94_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.ByteString.html#loc_94_1_94_15&#39;)"><span class="hl_varref"><span class="mpre">fromByteString</span></span></a><span class="mpre"> </span><a href="#loc_170_42_170_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_42_170_45&#39;)"><span class="hl_varref"><span class="mpre">bs&#39;</span></span></a><span class="mpre">
                                    </span><a href="#loc_166_55_166_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_55_166_59&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre">
                                </span><a href="Data.Streaming.Zlib.html#loc_196_18_196_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_196_18_196_25&#39;)"><span class="hl_conref"><span class="mpre">Z.PRError</span></span></a><span class="mpre"> </span><a name="loc_173_43_173_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_43_173_44&#39;)"><span class="hl_vardecl"><span class="mpre">e</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.IO.html#loc_304_1_304_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_304_1_304_8&#39;)"><span class="hl_varref"><span class="mpre">throwIO</span></span></a><span class="mpre"> </span><a href="#loc_173_43_173_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_43_173_44&#39;)"><span class="hl_varref"><span class="mpre">e</span></span></a><span class="mpre">

                    </span><a href="#loc_151_23_151_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_23_151_27&#39;)"><span class="hl_varref"><span class="mpre">body</span></span></a><span class="mpre"> </span><a href="#loc_154_25_154_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_25_154_36&#39;)"><span class="hl_varref"><span class="mpre">sendBuilder</span></span></a><span class="mpre"> </span><a href="#loc_162_25_162_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_25_162_37&#39;)"><span class="hl_varref"><span class="mpre">flushBuilder</span></span></a><span class="mpre">
                    </span><a href="#loc_154_25_154_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_25_154_36&#39;)"><span class="hl_varref"><span class="mpre">sendBuilder</span></span></a><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.html#loc_139_1_139_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.html#loc_139_1_139_6&#39;)"><span class="hl_varref"><span class="mpre">Blaze.flush</span></span></a><span class="mpre">
                    </span><a href="#loc_166_25_166_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_25_166_38&#39;)"><span class="hl_varref"><span class="mpre">deflatePopper</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.Streaming.Zlib.html#loc_271_1_271_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Streaming.Zlib.html#loc_271_1_271_14&#39;)"><span class="hl_varref"><span class="mpre">Z.finishDeflate</span></span></a><span class="mpre"> </span><a href="#loc_153_21_153_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_21_153_28&#39;)"><span class="hl_varref"><span class="mpre">deflate</span></span></a><span class="mpre">
        _ -&gt; </span><a href="#loc_147_19_147_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_19_147_31&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre"> </span><a href="#loc_147_15_147_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_15_147_18&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">
  where
    (</span><a name="loc_180_6_180_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_6_180_7&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre">, </span><a name="loc_180_9_180_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_9_180_11&#39;)"><span class="hl_vardecl"><span class="mpre">hs</span></span></a><span class="mpre">, </span><a name="loc_180_13_180_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_13_180_15&#39;)"><span class="hl_vardecl"><span class="mpre">wb</span></span></a><span class="mpre">) = </span><a href="Network.Wai.html#loc_198_1_198_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.html#loc_198_1_198_17&#39;)"><span class="hl_varref"><span class="mpre">responseToStream</span></span></a><span class="mpre"> </span><a href="#loc_147_15_147_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_15_147_18&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Remove Content-Length header, since we will certainly have a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- different length after gzip compression.</span></span><span class="mpre">
</span><a href="#loc_185_1_185_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_185_1_185_11&#39;)"><span class="mpre">fixHeaders</span></a><span class="mpre"> :: [</span><span class="hl_tyconref"><span class="mpre">Header</span></span><span class="mpre">] -&gt; [</span><span class="hl_tyconref"><span class="mpre">Header</span></span><span class="mpre">]
</span><a name="loc_185_1_185_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_185_1_185_11&#39;)"><span class="hl_vardecl"><span class="mpre">fixHeaders</span></span></a><span class="mpre"> =
    ((</span><span class="hl_string"><span class="mpre">&quot;Content-Encoding&quot;</span></span><span class="mpre">, </span><span class="hl_string"><span class="mpre">&quot;gzip&quot;</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">filter</span></span><span class="mpre"> </span><a href="#loc_188_5_188_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_5_188_14&#39;)"><span class="hl_varref"><span class="mpre">notLength</span></span></a><span class="mpre">
  where
    </span><a name="loc_188_5_188_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_5_188_14&#39;)"><span class="hl_fundecl"><span class="mpre">notLength</span></span></a><span class="mpre"> (</span><a name="loc_188_16_188_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_16_188_17&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre">, _) = </span><a href="#loc_188_16_188_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_16_188_17&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">/=</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;content-length&quot;</span></span><span class="mpre">

</span><a href="#loc_191_1_191_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_1_191_12&#39;)"><span class="mpre">splitCommas</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; [</span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">]
</span><a name="loc_191_1_191_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_1_191_12&#39;)"><span class="hl_fundecl"><span class="mpre">splitCommas</span></span></a><span class="mpre"> [] = []
</span><a href="#loc_191_1_191_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_1_191_12&#39;)"><span class="hl_fundecl"><span class="mpre">splitCommas</span></span></a><span class="mpre"> </span><a name="loc_192_13_192_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_13_192_14&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> =
    let (</span><a name="loc_193_10_193_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_10_193_11&#39;)"><span class="hl_vardecl"><span class="mpre">y</span></span></a><span class="mpre">, </span><a name="loc_193_13_193_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_13_193_14&#39;)"><span class="hl_vardecl"><span class="mpre">z</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">break</span></span><span class="mpre"> (</span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_char"><span class="mpre">&#39;,&#39;</span></span><span class="mpre">) </span><a href="#loc_192_13_192_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_13_192_14&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
     in </span><a href="#loc_193_10_193_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_10_193_11&#39;)"><span class="hl_varref"><span class="mpre">y</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a href="#loc_191_1_191_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_1_191_12&#39;)"><span class="hl_varref"><span class="mpre">splitCommas</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">dropWhile</span></span><span class="mpre"> (</span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_char"><span class="mpre">&#39; &#39;</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">drop</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> </span><a href="#loc_193_13_193_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_13_193_14&#39;)"><span class="hl_varref"><span class="mpre">z</span></span></a><span class="mpre">)
</span></div></body></html>