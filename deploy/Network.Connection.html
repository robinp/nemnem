<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE BangPatterns #-}
{-# LANGUAGE DeriveDataTypeable #-}
{-# LANGUAGE ScopedTypeVariables #-}
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : Network.Connection</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD-style</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Vincent Hanquez &lt;vincent@snarc.org&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : portable</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Simple connection abstraction</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Network.Connection
    (
    </span><span class="hl_comment"><span class="mpre">-- * Type for a connection</span></span><span class="mpre">
      Connection
    , connectionID
    , ConnectionParams(..)
    , TLSSettings(..)
    , ProxySettings(..)
    , SockSettings

    </span><span class="hl_comment"><span class="mpre">-- * Exceptions</span></span><span class="mpre">
    , LineTooLong(..)

    </span><span class="hl_comment"><span class="mpre">-- * Library initialization</span></span><span class="mpre">
    , initConnectionContext
    , ConnectionContext

    </span><span class="hl_comment"><span class="mpre">-- * Connection operation</span></span><span class="mpre">
    , connectFromHandle
    , connectTo
    , connectionClose

    </span><span class="hl_comment"><span class="mpre">-- * Sending and receiving data</span></span><span class="mpre">
    , connectionGet
    , connectionGetChunk
    , connectionGetChunk&#39;
    , connectionGetLine
    , connectionPut

    </span><span class="hl_comment"><span class="mpre">-- * TLS related operation</span></span><span class="mpre">
    , connectionSetSecure
    , connectionIsSecure
    ) where

import Control.Applicative
import Control.Concurrent.MVar
import Control.Monad (</span><a href="Control.Monad.html#loc_204_1_204_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_204_1_204_5&#39;)"><span class="mpre">join</span></a><span class="mpre">)
import qualified Control.Exception as E
import qualified System.IO.Error as E (</span><a href="System.IO.Error.html#loc_115_1_115_10" onmouseover="nemnem.highlightLocalToRemote(&#39;System.IO.Error.html#loc_115_1_115_10&#39;)"><span class="mpre">mkIOError</span></a><span class="mpre">, </span><a href="System.IO.Error.html#loc_198_1_198_13" onmouseover="nemnem.highlightLocalToRemote(&#39;System.IO.Error.html#loc_198_1_198_13&#39;)"><span class="mpre">eofErrorType</span></a><span class="mpre">)

import qualified Network.TLS as TLS
import qualified Network.TLS.Extra as TLS

import System.X509 (</span><a href="System.X509.Win32.html#loc_52_1_52_26" onmouseover="nemnem.highlightLocalToRemote(&#39;System.X509.Win32.html#loc_52_1_52_26&#39;)"><span class="mpre">getSystemCertificateStore</span></a><span class="mpre">)

import Network.Socks5
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 59, srcSpanStartColumn = 18, srcSpanEndLine = 59, srcSpanEndColumn = 25}, srcInfoPoints = []}) &quot;Network&quot;"><span class="mpre">Network</span></span><span class="mpre"> as N

import Data.Default.Class
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 62, srcSpanStartColumn = 8, srcSpanEndLine = 62, srcSpanEndColumn = 17}, srcInfoPoints = []}) &quot;Data.Data&quot;"><span class="mpre">Data.Data</span></span><span class="mpre">
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 63, srcSpanStartColumn = 8, srcSpanEndLine = 63, srcSpanEndColumn = 23}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre"> (ByteString)
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 64, srcSpanStartColumn = 18, srcSpanEndLine = 64, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre"> as B
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 65, srcSpanStartColumn = 18, srcSpanEndLine = 65, srcSpanEndColumn = 39}, srcInfoPoints = []}) &quot;Data.ByteString.Char8&quot;"><span class="mpre">Data.ByteString.Char8</span></span><span class="mpre"> as BC
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 66, srcSpanStartColumn = 18, srcSpanEndLine = 66, srcSpanEndColumn = 38}, srcInfoPoints = []}) &quot;Data.ByteString.Lazy&quot;"><span class="mpre">Data.ByteString.Lazy</span></span><span class="mpre"> as L

import qualified Crypto.Random.AESCtr as RNG

import System.Environment
import System.IO
import qualified Data.Map as M

import Network.Connection.Types

</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 76, srcSpanStartColumn = 1, srcSpanEndLine = 76, srcSpanEndColumn = 58}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 76, srcSpanStartColumn = 1, srcSpanEndLine = 76, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanSt"><span class="mpre">type Manager = MVar (M.Map TLS.SessionID TLS.SessionData)</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | This is the exception raised if we reached the user specified limit for</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the line in ConnectionGetLine.</span></span><span class="mpre">
data </span><a name="loc_80_6_80_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_6_80_17&#39;)"><span class="hl_tycondecl"><span class="mpre">LineTooLong</span></span></a><span class="mpre"> = </span><a name="loc_80_20_80_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_20_80_31&#39;)"><span class="hl_condecl"><span class="mpre">LineTooLong</span></span></a><span class="mpre"> </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 80, srcSpanStartColumn = 32, srcSpanEndLine = 80, srcSpanEndColumn = 56}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 80, srcSpanStartColumn = 32, srcSpanEndLine = 80, srcSpanEndColumn = 40},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpa"><span class="mpre">deriving (Show,Typeable)</span></span><span class="mpre">

instance </span><span class="hl_classref"><span class="mpre">E.Exception</span></span><span class="mpre"> </span><a href="#loc_80_6_80_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_6_80_17&#39;)"><span class="hl_tyconref"><span class="mpre">LineTooLong</span></span></a><span class="mpre">

</span><a href="#loc_85_1_85_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_1_85_25&#39;)"><span class="mpre">connectionSessionManager</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Manager</span></span><span class="mpre"> -&gt; </span><a href="Network.TLS.Session.html#loc_16_6_16_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Session.html#loc_16_6_16_20&#39;)"><span class="hl_tyconref"><span class="mpre">TLS.SessionManager</span></span></a><span class="mpre">
</span><a name="loc_85_1_85_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_1_85_25&#39;)"><span class="hl_fundecl"><span class="mpre">connectionSessionManager</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">mvar</span></span><span class="mpre"> = </span><span class="warning" data-warning="ExpRecConstr (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 85, srcSpanStartColumn = 33, srcSpanEndLine = 90, srcSpanEndColumn = 6}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 86, srcSpanStartColumn = 5, srcSpanEndLine = 86, srcSpanEndColumn = 6},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanS"><span class="mpre">TLS.SessionManager
    { TLS.sessionResume     = \sessionID -&gt; withMVar mvar (return . M.lookup sessionID)
    , TLS.sessionEstablish  = \sessionID sessionData -&gt;
                               modifyMVar_ mvar (return . M.insert sessionID sessionData)
    , TLS.sessionInvalidate = \sessionID -&gt; modifyMVar_ mvar (return . M.delete sessionID)
    }</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Initialize the library with shared parameters between connection.</span></span><span class="mpre">
</span><a href="#loc_94_1_94_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_1_94_22&#39;)"><span class="mpre">initConnectionContext</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Network.Connection.Types.html#loc_94_6_94_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_94_6_94_23&#39;)"><span class="hl_tyconref"><span class="mpre">ConnectionContext</span></span></a><span class="mpre">
</span><a name="loc_94_1_94_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_1_94_22&#39;)"><span class="hl_vardecl"><span class="mpre">initConnectionContext</span></span></a><span class="mpre"> = </span><a href="Network.Connection.Types.html#loc_94_26_94_43" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_94_26_94_43&#39;)"><span class="hl_conref"><span class="mpre">ConnectionContext</span></span></a><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><a href="System.X509.Win32.html#loc_52_1_52_26" onmouseover="nemnem.highlightLocalToRemote(&#39;System.X509.Win32.html#loc_52_1_52_26&#39;)"><span class="hl_varref"><span class="mpre">getSystemCertificateStore</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Create a final TLS &#39;ClientParams&#39; according to the destination and the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- TLSSettings.</span></span><span class="mpre">
</span><a href="#loc_99_1_99_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_1_99_14&#39;)"><span class="mpre">makeTLSParams</span></a><span class="mpre"> :: </span><a href="Network.Connection.Types.html#loc_94_6_94_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_94_6_94_23&#39;)"><span class="hl_tyconref"><span class="mpre">ConnectionContext</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ConnectionID</span></span><span class="mpre"> -&gt; </span><a href="Network.Connection.Types.html#loc_65_6_65_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_65_6_65_17&#39;)"><span class="hl_tyconref"><span class="mpre">TLSSettings</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Parameters.html#loc_43_6_43_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_43_6_43_18&#39;)"><span class="hl_tyconref"><span class="mpre">TLS.ClientParams</span></span></a><span class="mpre">
</span><a name="loc_99_1_99_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_1_99_14&#39;)"><span class="hl_fundecl"><span class="mpre">makeTLSParams</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">cg</span></span><span class="mpre"> </span><a name="loc_99_18_99_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_18_99_21&#39;)"><span class="hl_vardecl"><span class="mpre">cid</span></span></a><span class="mpre"> </span><a name="loc_99_22_99_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_22_99_24&#39;)"><span class="hl_specname"><span class="mpre">ts</span></span></a><span class="mpre">@(</span><span class="warning" data-warning="PatPRec (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 99, srcSpanStartColumn = 26, srcSpanEndLine = 99, srcSpanEndColumn = 46}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 99, srcSpanStartColumn = 44, srcSpanEndLine = 99, srcSpanEndColumn = 45},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanSta"><span class="mpre">TLSSettingsSimple {}</span></span><span class="mpre">) =
    </span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 100, srcSpanStartColumn = 5, srcSpanEndLine = 107, srcSpanEndColumn = 10}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 101, srcSpanStartColumn = 9, srcSpanEndLine = 101, srcSpanEndColumn = 10},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, src"><span class="mpre">(TLS.defaultParamsClient (fst cid) portString)
        { TLS.clientSupported = def { TLS.supportedCiphers = TLS.ciphersuite_all }
        , TLS.clientShared    = def
            { TLS.sharedCAStore         = globalCertificateStore cg
            , TLS.sharedValidationCache = validationCache
            </span><span class="hl_comment"><span class="mpre">-- , TLS.sharedSessionManager  = connectionSessionManager</span></span><span class="mpre">
            }
        }</span></span><span class="mpre">
  where </span><span class="hl_vardecl"><span class="mpre">validationCache</span></span><span class="mpre">
            | </span><a href="Network.Connection.Types.html#loc_67_16_67_51" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_67_16_67_51&#39;)"><span class="hl_varref"><span class="mpre">settingDisableCertificateValidation</span></span></a><span class="mpre"> </span><a href="#loc_99_22_99_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_22_99_24&#39;)"><span class="hl_varref"><span class="mpre">ts</span></span></a><span class="mpre"> =
                </span><span class="hl_conref"><span class="mpre">TLS.ValidationCache</span></span><span class="mpre"> (\_ _ _ -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">TLS.ValidationCachePass</span></span><span class="mpre">)
                                    (\_ _ _ -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">)
            | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = </span><a href="Data.Default.Class.html#loc_40_5_40_8" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Default.Class.html#loc_40_5_40_8&#39;)"><span class="hl_varref"><span class="mpre">def</span></span></a><span class="mpre">
        </span><span class="hl_vardecl"><span class="mpre">portString</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">BC.pack</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">snd</span></span><span class="mpre"> </span><a href="#loc_99_18_99_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_18_99_21&#39;)"><span class="hl_varref"><span class="mpre">cid</span></span></a><span class="mpre">
</span><a href="#loc_99_1_99_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_1_99_14&#39;)"><span class="hl_fundecl"><span class="mpre">makeTLSParams</span></span></a><span class="mpre"> _ </span><a name="loc_114_17_114_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_17_114_20&#39;)"><span class="hl_vardecl"><span class="mpre">cid</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_75_7_75_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_75_7_75_18&#39;)"><span class="hl_conref"><span class="mpre">TLSSettings</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">p</span></span><span class="mpre">) =
    </span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 115, srcSpanStartColumn = 5, srcSpanEndLine = 115, srcSpanEndColumn = 65}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcSpanStartLine = 115, srcSpanStartColumn = 7, srcSpanEndLine = 115, srcSpanEndColumn = 8},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/connection-0.2.3/Network/Connection.hs&quot;, srcS"><span class="mpre">p { TLS.clientServerIdentification = (fst cid, portString) }</span></span><span class="mpre">
 where </span><span class="hl_vardecl"><span class="mpre">portString</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">BC.pack</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">snd</span></span><span class="mpre"> </span><a href="#loc_114_17_114_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_17_114_20&#39;)"><span class="hl_varref"><span class="mpre">cid</span></span></a><span class="mpre">

</span><a href="#loc_119_1_119_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_12&#39;)"><span class="mpre">withBackend</span></a><span class="mpre"> :: (</span><a href="Network.Connection.Types.html#loc_26_6_26_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_26_6_26_23&#39;)"><span class="hl_tyconref"><span class="mpre">ConnectionBackend</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_119_1_119_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_12&#39;)"><span class="hl_fundecl"><span class="mpre">withBackend</span></span></a><span class="mpre"> </span><a name="loc_119_13_119_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_13_119_14&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> </span><a name="loc_119_15_119_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_15_119_19&#39;)"><span class="hl_vardecl"><span class="mpre">conn</span></span></a><span class="mpre"> = </span><a href="GHC.MVar.html#loc_116_1_116_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_116_1_116_9&#39;)"><span class="hl_varref"><span class="mpre">readMVar</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_85_7_85_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_85_7_85_24&#39;)"><span class="hl_varref"><span class="mpre">connectionBackend</span></span></a><span class="mpre"> </span><a href="#loc_119_15_119_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_15_119_19&#39;)"><span class="hl_varref"><span class="mpre">conn</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_119_13_119_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_13_119_14&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre">

</span><a href="#loc_122_1_122_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_14&#39;)"><span class="mpre">connectionNew</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">ConnectionID</span></span><span class="mpre"> -&gt; </span><a href="Network.Connection.Types.html#loc_26_6_26_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_26_6_26_23&#39;)"><span class="hl_tyconref"><span class="mpre">ConnectionBackend</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre">
</span><a name="loc_122_1_122_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_14&#39;)"><span class="hl_fundecl"><span class="mpre">connectionNew</span></span></a><span class="mpre"> </span><a name="loc_122_15_122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_15_122_18&#39;)"><span class="hl_vardecl"><span class="mpre">cid</span></span></a><span class="mpre"> </span><a name="loc_122_19_122_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_19_122_26&#39;)"><span class="hl_vardecl"><span class="mpre">backend</span></span></a><span class="mpre"> =
    </span><a href="Network.Connection.Types.html#loc_84_19_84_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_19_84_29&#39;)"><span class="hl_conref"><span class="mpre">Connection</span></span></a><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><a href="GHC.MVar.html#loc_70_1_70_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_70_1_70_8&#39;)"><span class="hl_varref"><span class="mpre">newMVar</span></span></a><span class="mpre"> </span><a href="#loc_122_19_122_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_19_122_26&#39;)"><span class="hl_varref"><span class="mpre">backend</span></span></a><span class="mpre">
               </span><a href="Control.Applicative.html#loc_118_5_118_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_118_5_118_10&#39;)"><span class="hl_infix"><span class="mpre">&lt;*&gt;</span></span></a><span class="mpre"> </span><a href="GHC.MVar.html#loc_70_1_70_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_70_1_70_8&#39;)"><span class="hl_varref"><span class="mpre">newMVar</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">B.empty</span></span><span class="mpre">)
               </span><a href="Control.Applicative.html#loc_118_5_118_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_118_5_118_10&#39;)"><span class="hl_infix"><span class="mpre">&lt;*&gt;</span></span></a><span class="mpre"> </span><a href="Control.Applicative.html#loc_115_5_115_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_115_5_115_9&#39;)"><span class="hl_varref"><span class="mpre">pure</span></span></a><span class="mpre"> </span><a href="#loc_122_15_122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_15_122_18&#39;)"><span class="hl_varref"><span class="mpre">cid</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Use an already established handle to create a connection object.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- if the TLS Settings is set, it will do the handshake with the server.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The SOCKS settings have no impact here, as the handle is already established</span></span><span class="mpre">
</span><a href="#loc_135_1_135_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_1_135_18&#39;)"><span class="mpre">connectFromHandle</span></a><span class="mpre"> :: </span><a href="Network.Connection.Types.html#loc_94_6_94_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_94_6_94_23&#39;)"><span class="hl_tyconref"><span class="mpre">ConnectionContext</span></span></a><span class="mpre">
                  -&gt; </span><a href="GHC.IO.Handle.Types.html#loc_100_6_100_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Types.html#loc_100_6_100_12&#39;)"><span class="hl_tyconref"><span class="mpre">Handle</span></span></a><span class="mpre">
                  -&gt; </span><a href="Network.Connection.Types.html#loc_38_6_38_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_38_6_38_22&#39;)"><span class="hl_tyconref"><span class="mpre">ConnectionParams</span></span></a><span class="mpre">
                  -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre">
</span><a name="loc_135_1_135_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_1_135_18&#39;)"><span class="hl_fundecl"><span class="mpre">connectFromHandle</span></span></a><span class="mpre"> </span><a name="loc_135_19_135_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_19_135_21&#39;)"><span class="hl_vardecl"><span class="mpre">cg</span></span></a><span class="mpre"> </span><a name="loc_135_22_135_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_22_135_23&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre"> </span><a name="loc_135_24_135_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_24_135_25&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> = </span><a href="#loc_136_11_136_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_11_136_23&#39;)"><span class="hl_varref"><span class="mpre">withSecurity</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_41_7_41_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_41_7_41_26&#39;)"><span class="hl_varref"><span class="mpre">connectionUseSecure</span></span></a><span class="mpre"> </span><a href="#loc_135_24_135_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_24_135_25&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">)
    where </span><a name="loc_136_11_136_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_11_136_23&#39;)"><span class="hl_fundecl"><span class="mpre">withSecurity</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">            = </span><a href="#loc_122_1_122_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_14&#39;)"><span class="hl_varref"><span class="mpre">connectionNew</span></span></a><span class="mpre"> </span><a href="#loc_138_11_138_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_11_138_14&#39;)"><span class="hl_varref"><span class="mpre">cid</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.Connection.Types.html#loc_26_26_26_42" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_26_26_26_42&#39;)"><span class="hl_conref"><span class="mpre">ConnectionStream</span></span></a><span class="mpre"> </span><a href="#loc_135_22_135_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_22_135_23&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre">
          </span><a href="#loc_136_11_136_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_11_136_23&#39;)"><span class="hl_fundecl"><span class="mpre">withSecurity</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_137_30_137_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_30_137_41&#39;)"><span class="hl_vardecl"><span class="mpre">tlsSettings</span></span></a><span class="mpre">) = </span><a href="#loc_312_1_312_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_312_1_312_13&#39;)"><span class="hl_varref"><span class="mpre">tlsEstablish</span></span></a><span class="mpre"> </span><a href="#loc_135_22_135_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_22_135_23&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> (</span><a href="#loc_99_1_99_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_1_99_14&#39;)"><span class="hl_varref"><span class="mpre">makeTLSParams</span></span></a><span class="mpre"> </span><a href="#loc_135_19_135_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_19_135_21&#39;)"><span class="hl_varref"><span class="mpre">cg</span></span></a><span class="mpre"> </span><a href="#loc_138_11_138_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_11_138_14&#39;)"><span class="hl_varref"><span class="mpre">cid</span></span></a><span class="mpre"> </span><a href="#loc_137_30_137_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_30_137_41&#39;)"><span class="hl_varref"><span class="mpre">tlsSettings</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_122_1_122_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_14&#39;)"><span class="hl_varref"><span class="mpre">connectionNew</span></span></a><span class="mpre"> </span><a href="#loc_138_11_138_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_11_138_14&#39;)"><span class="hl_varref"><span class="mpre">cid</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Network.Connection.Types.html#loc_27_26_27_39" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_27_26_27_39&#39;)"><span class="hl_conref"><span class="mpre">ConnectionTLS</span></span></a><span class="mpre">
          </span><a name="loc_138_11_138_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_11_138_14&#39;)"><span class="hl_vardecl"><span class="mpre">cid</span></span></a><span class="mpre"> = (</span><a href="Network.Connection.Types.html#loc_39_7_39_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_39_7_39_25&#39;)"><span class="hl_varref"><span class="mpre">connectionHostname</span></span></a><span class="mpre"> </span><a href="#loc_135_24_135_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_24_135_25&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">, </span><a href="Network.Connection.Types.html#loc_40_7_40_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_40_7_40_21&#39;)"><span class="hl_varref"><span class="mpre">connectionPort</span></span></a><span class="mpre"> </span><a href="#loc_135_24_135_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_24_135_25&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | connect to a destination using the parameter</span></span><span class="mpre">
</span><a href="#loc_144_1_144_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_1_144_10&#39;)"><span class="mpre">connectTo</span></a><span class="mpre"> :: </span><a href="Network.Connection.Types.html#loc_94_6_94_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_94_6_94_23&#39;)"><span class="hl_tyconref"><span class="mpre">ConnectionContext</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ The global context of this connection.</span></span><span class="mpre">
          -&gt; </span><a href="Network.Connection.Types.html#loc_38_6_38_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_38_6_38_22&#39;)"><span class="hl_tyconref"><span class="mpre">ConnectionParams</span></span></a><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- ^ The parameters for this connection (where to connect, and such).</span></span><span class="mpre">
          -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre">     </span><span class="hl_comment"><span class="mpre">-- ^ The new established connection on success.</span></span><span class="mpre">
</span><a name="loc_144_1_144_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_1_144_10&#39;)"><span class="hl_fundecl"><span class="mpre">connectTo</span></span></a><span class="mpre"> </span><a name="loc_144_11_144_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_11_144_13&#39;)"><span class="hl_vardecl"><span class="mpre">cg</span></span></a><span class="mpre"> </span><a name="loc_144_14_144_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_14_144_21&#39;)"><span class="hl_vardecl"><span class="mpre">cParams</span></span></a><span class="mpre"> = do
    </span><a name="loc_145_5_145_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_5_145_11&#39;)"><span class="hl_vardecl"><span class="mpre">conFct</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_149_9_149_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_9_149_18&#39;)"><span class="hl_varref"><span class="mpre">getConFct</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_42_7_42_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_42_7_42_25&#39;)"><span class="hl_varref"><span class="mpre">connectionUseSocks</span></span></a><span class="mpre"> </span><a href="#loc_144_14_144_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_14_144_21&#39;)"><span class="hl_varref"><span class="mpre">cParams</span></span></a><span class="mpre">)
    </span><a name="loc_146_5_146_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_5_146_6&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre">      &lt;- </span><a href="#loc_145_5_145_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_5_145_11&#39;)"><span class="hl_varref"><span class="mpre">conFct</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_39_7_39_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_39_7_39_25&#39;)"><span class="hl_varref"><span class="mpre">connectionHostname</span></span></a><span class="mpre"> </span><a href="#loc_144_14_144_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_14_144_21&#39;)"><span class="hl_varref"><span class="mpre">cParams</span></span></a><span class="mpre">) (</span><span class="hl_conref"><span class="mpre">N.PortNumber</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.Connection.Types.html#loc_40_7_40_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_40_7_40_21&#39;)"><span class="hl_varref"><span class="mpre">connectionPort</span></span></a><span class="mpre"> </span><a href="#loc_144_14_144_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_14_144_21&#39;)"><span class="hl_varref"><span class="mpre">cParams</span></span></a><span class="mpre">)
    </span><a href="#loc_135_1_135_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_1_135_18&#39;)"><span class="hl_varref"><span class="mpre">connectFromHandle</span></span></a><span class="mpre"> </span><a href="#loc_144_11_144_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_11_144_13&#39;)"><span class="hl_varref"><span class="mpre">cg</span></span></a><span class="mpre"> </span><a href="#loc_146_5_146_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_5_146_6&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> </span><a href="#loc_144_14_144_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_14_144_21&#39;)"><span class="hl_varref"><span class="mpre">cParams</span></span></a><span class="mpre">
  where
        </span><a name="loc_149_9_149_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_9_149_18&#39;)"><span class="hl_fundecl"><span class="mpre">getConFct</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">                            = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">N.connectTo</span></span><span class="mpre">
        </span><a href="#loc_149_9_149_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_9_149_18&#39;)"><span class="hl_fundecl"><span class="mpre">getConFct</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_56_7_56_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_56_7_56_17&#39;)"><span class="hl_conref"><span class="mpre">OtherProxy</span></span></a><span class="mpre"> </span><a name="loc_150_37_150_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_37_150_38&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre"> </span><a name="loc_150_39_150_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_39_150_40&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre">))            = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \_ _ -&gt; </span><span class="hl_varref"><span class="mpre">N.connectTo</span></span><span class="mpre"> </span><a href="#loc_150_37_150_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_37_150_38&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">N.PortNumber</span></span><span class="mpre"> </span><a href="#loc_150_39_150_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_39_150_40&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">)
        </span><a href="#loc_149_9_149_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_9_149_18&#39;)"><span class="hl_fundecl"><span class="mpre">getConFct</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_54_7_54_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_54_7_54_25&#39;)"><span class="hl_conref"><span class="mpre">SockSettingsSimple</span></span></a><span class="mpre"> </span><a name="loc_151_45_151_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_45_151_46&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre"> </span><a name="loc_151_47_151_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_47_151_48&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre">))    = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.Socks5.html#loc_123_1_123_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Socks5.html#loc_123_1_123_15&#39;)"><span class="hl_varref"><span class="mpre">socksConnectTo</span></span></a><span class="mpre"> </span><a href="#loc_151_45_151_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_45_151_46&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">N.PortNumber</span></span><span class="mpre"> </span><a href="#loc_151_47_151_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_47_151_48&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">)
        </span><a href="#loc_149_9_149_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_9_149_18&#39;)"><span class="hl_fundecl"><span class="mpre">getConFct</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_55_7_55_30" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_55_7_55_30&#39;)"><span class="hl_conref"><span class="mpre">SockSettingsEnvironment</span></span></a><span class="mpre"> </span><a name="loc_152_50_152_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_50_152_51&#39;)"><span class="hl_vardecl"><span class="mpre">v</span></span></a><span class="mpre">)) = do
            </span><span class="hl_comment"><span class="mpre">-- if we can&#39;t get the environment variable or that the variable cannot be parsed</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- we connect directly.</span></span><span class="mpre">
            let </span><a name="loc_155_17_155_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_155_17_155_21&#39;)"><span class="hl_vardecl"><span class="mpre">name</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">maybe</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;SOCKS_SERVER&quot;</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">id</span></span><span class="mpre"> </span><a href="#loc_152_50_152_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_50_152_51&#39;)"><span class="hl_varref"><span class="mpre">v</span></span></a><span class="mpre">
            </span><a name="loc_156_13_156_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_13_156_17&#39;)"><span class="hl_vardecl"><span class="mpre">evar</span></span></a><span class="mpre"> &lt;- </span><a href="Control.Exception.Base.html#loc_212_1_212_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_212_1_212_4&#39;)"><span class="hl_varref"><span class="mpre">E.try</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">getEnv</span></span><span class="mpre"> </span><a href="#loc_155_17_155_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_155_17_155_21&#39;)"><span class="hl_varref"><span class="mpre">name</span></span></a><span class="mpre">)
            case </span><a href="#loc_156_13_156_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_13_156_17&#39;)"><span class="hl_varref"><span class="mpre">evar</span></span></a><span class="mpre"> of
                </span><span class="hl_conref"><span class="mpre">Left</span></span><span class="mpre"> (_ :: </span><a href="GHC.IO.Exception.html#loc_238_6_238_17" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Exception.html#loc_238_6_238_17&#39;)"><span class="hl_tyconref"><span class="mpre">E.IOException</span></span></a><span class="mpre">) -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">N.connectTo</span></span><span class="mpre">
                </span><span class="hl_conref"><span class="mpre">Right</span></span><span class="mpre"> </span><a name="loc_159_23_159_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_23_159_26&#39;)"><span class="hl_vardecl"><span class="mpre">var</span></span></a><span class="mpre">                 -&gt;
                    case </span><a href="#loc_165_9_165_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_9_165_19&#39;)"><span class="hl_varref"><span class="mpre">parseSocks</span></span></a><span class="mpre"> </span><a href="#loc_159_23_159_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_23_159_26&#39;)"><span class="hl_varref"><span class="mpre">var</span></span></a><span class="mpre"> of
                        </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">             -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">N.connectTo</span></span><span class="mpre">
                        </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a name="loc_162_31_162_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_31_162_36&#39;)"><span class="hl_vardecl"><span class="mpre">sHost</span></span></a><span class="mpre">, </span><a name="loc_162_38_162_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_38_162_43&#39;)"><span class="hl_vardecl"><span class="mpre">sPort</span></span></a><span class="mpre">) -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.Socks5.html#loc_123_1_123_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Socks5.html#loc_123_1_123_15&#39;)"><span class="hl_varref"><span class="mpre">socksConnectTo</span></span></a><span class="mpre"> </span><a href="#loc_162_31_162_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_31_162_36&#39;)"><span class="hl_varref"><span class="mpre">sHost</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">N.PortNumber</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> (</span><a href="#loc_162_38_162_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_38_162_43&#39;)"><span class="hl_varref"><span class="mpre">sPort</span></span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">))

        </span><span class="hl_comment"><span class="mpre">-- Try to parse &quot;host:port&quot; or &quot;host&quot;</span></span><span class="mpre">
        </span><a name="loc_165_9_165_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_9_165_19&#39;)"><span class="hl_fundecl"><span class="mpre">parseSocks</span></span></a><span class="mpre"> </span><a name="loc_165_20_165_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_20_165_21&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> =
            case </span><span class="hl_varref"><span class="mpre">break</span></span><span class="mpre"> (</span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_char"><span class="mpre">&#39;:&#39;</span></span><span class="mpre">) </span><a href="#loc_165_20_165_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_20_165_21&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> of
                (</span><a name="loc_167_18_167_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_18_167_23&#39;)"><span class="hl_vardecl"><span class="mpre">sHost</span></span></a><span class="mpre">, </span><span class="hl_string"><span class="mpre">&quot;&quot;</span></span><span class="mpre">)        -&gt; </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a href="#loc_167_18_167_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_18_167_23&#39;)"><span class="hl_varref"><span class="mpre">sHost</span></span></a><span class="mpre">, </span><span class="hl_num"><span class="mpre">1080</span></span><span class="mpre">)
                (</span><a name="loc_168_18_168_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_18_168_23&#39;)"><span class="hl_vardecl"><span class="mpre">sHost</span></span></a><span class="mpre">, </span><span class="hl_char"><span class="mpre">&#39;:&#39;</span></span><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_168_29_168_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_29_168_34&#39;)"><span class="hl_vardecl"><span class="mpre">portS</span></span></a><span class="mpre">) -&gt;
                    case </span><span class="hl_varref"><span class="mpre">reads</span></span><span class="mpre"> </span><a href="#loc_168_29_168_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_29_168_34&#39;)"><span class="hl_varref"><span class="mpre">portS</span></span></a><span class="mpre"> of
                        [(</span><a name="loc_170_27_170_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_27_170_32&#39;)"><span class="hl_vardecl"><span class="mpre">sPort</span></span></a><span class="mpre">,</span><span class="hl_string"><span class="mpre">&quot;&quot;</span></span><span class="mpre">)] -&gt; </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a href="#loc_168_18_168_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_18_168_23&#39;)"><span class="hl_varref"><span class="mpre">sHost</span></span></a><span class="mpre">, </span><a href="#loc_170_27_170_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_27_170_32&#39;)"><span class="hl_varref"><span class="mpre">sPort</span></span></a><span class="mpre">)
                        _            -&gt; </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
                _                  -&gt; </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Put a block of data in the connection.</span></span><span class="mpre">
</span><a href="#loc_176_1_176_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_1_176_14&#39;)"><span class="mpre">connectionPut</span></a><span class="mpre"> :: </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_176_1_176_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_1_176_14&#39;)"><span class="hl_fundecl"><span class="mpre">connectionPut</span></span></a><span class="mpre"> </span><a name="loc_176_15_176_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_15_176_25&#39;)"><span class="hl_vardecl"><span class="mpre">connection</span></span></a><span class="mpre"> </span><a name="loc_176_26_176_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_26_176_33&#39;)"><span class="hl_vardecl"><span class="mpre">content</span></span></a><span class="mpre"> = </span><a href="#loc_119_1_119_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_12&#39;)"><span class="hl_varref"><span class="mpre">withBackend</span></span></a><span class="mpre"> </span><a href="#loc_177_11_177_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_177_11_177_18&#39;)"><span class="hl_varref"><span class="mpre">doWrite</span></span></a><span class="mpre"> </span><a href="#loc_176_15_176_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_15_176_25&#39;)"><span class="hl_varref"><span class="mpre">connection</span></span></a><span class="mpre">
    where </span><a name="loc_177_11_177_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_177_11_177_18&#39;)"><span class="hl_fundecl"><span class="mpre">doWrite</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_26_26_26_42" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_26_26_26_42&#39;)"><span class="hl_conref"><span class="mpre">ConnectionStream</span></span></a><span class="mpre"> </span><a name="loc_177_37_177_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_177_37_177_38&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">B.hPut</span></span><span class="mpre"> </span><a href="#loc_177_37_177_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_177_37_177_38&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> </span><a href="#loc_176_26_176_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_26_176_33&#39;)"><span class="hl_varref"><span class="mpre">content</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><a href="GHC.IO.Handle.html#loc_293_1_293_7" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.html#loc_293_1_293_7&#39;)"><span class="hl_varref"><span class="mpre">hFlush</span></span></a><span class="mpre"> </span><a href="#loc_177_37_177_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_177_37_177_38&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre">
          </span><a href="#loc_177_11_177_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_177_11_177_18&#39;)"><span class="hl_fundecl"><span class="mpre">doWrite</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_27_26_27_39" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_27_26_27_39&#39;)"><span class="hl_conref"><span class="mpre">ConnectionTLS</span></span></a><span class="mpre"> </span><a name="loc_178_34_178_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_34_178_37&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre">)  = </span><a href="Network.TLS.Core.html#loc_62_1_62_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Core.html#loc_62_1_62_9&#39;)"><span class="hl_varref"><span class="mpre">TLS.sendData</span></span></a><span class="mpre"> </span><a href="#loc_178_34_178_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_34_178_37&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">L.fromChunks</span></span><span class="mpre"> [</span><a href="#loc_176_26_176_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_26_176_33&#39;)"><span class="hl_varref"><span class="mpre">content</span></span></a><span class="mpre">]

</span><span class="hl_comment"><span class="mpre">-- | Get some bytes from a connection.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The size argument is just the maximum that could be returned to the user.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The call will return as soon as there&#39;s data, even if there&#39;s less</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- than requested.  Hence, it behaves like &#39;B.hGetSome&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- On end of input, &#39;connectionGet&#39; returns 0, but subsequent calls will throw</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- an &#39;E.isEOFError&#39; exception.</span></span><span class="mpre">
</span><a href="#loc_189_1_189_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_1_189_14&#39;)"><span class="mpre">connectionGet</span></a><span class="mpre"> :: </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">
</span><a name="loc_189_1_189_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_1_189_14&#39;)"><span class="hl_fundecl"><span class="mpre">connectionGet</span></span></a><span class="mpre"> </span><a name="loc_189_15_189_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_15_189_19&#39;)"><span class="hl_vardecl"><span class="mpre">conn</span></span></a><span class="mpre"> </span><a name="loc_189_20_189_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_20_189_24&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre">
  | </span><a href="#loc_189_20_189_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_20_189_24&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">  = </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;Network.Connection.connectionGet: size &lt; 0&quot;</span></span><span class="mpre">
  | </span><a href="#loc_189_20_189_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_20_189_24&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">B.empty</span></span><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = </span><a href="#loc_205_1_205_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_1_205_23&#39;)"><span class="hl_varref"><span class="mpre">connectionGetChunkBase</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;connectionGet&quot;</span></span><span class="mpre"> </span><a href="#loc_189_15_189_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_15_189_19&#39;)"><span class="hl_varref"><span class="mpre">conn</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">B.splitAt</span></span><span class="mpre"> </span><a href="#loc_189_20_189_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_20_189_24&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Get the next block of data from the connection.</span></span><span class="mpre">
</span><a href="#loc_196_1_196_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_1_196_19&#39;)"><span class="mpre">connectionGetChunk</span></a><span class="mpre"> :: </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">
</span><a name="loc_196_1_196_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_1_196_19&#39;)"><span class="hl_fundecl"><span class="mpre">connectionGetChunk</span></span></a><span class="mpre"> </span><a name="loc_196_20_196_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_20_196_24&#39;)"><span class="hl_vardecl"><span class="mpre">conn</span></span></a><span class="mpre"> =
    </span><a href="#loc_205_1_205_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_1_205_23&#39;)"><span class="hl_varref"><span class="mpre">connectionGetChunkBase</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;connectionGetChunk&quot;</span></span><span class="mpre"> </span><a href="#loc_196_20_196_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_20_196_24&#39;)"><span class="hl_varref"><span class="mpre">conn</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_197_57_197_58" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_197_57_197_58&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> -&gt; (</span><a href="#loc_197_57_197_58" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_197_57_197_58&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">, </span><span class="hl_varref"><span class="mpre">B.empty</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Like &#39;connectionGetChunk&#39;, but return the unused portion to the buffer,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- where it will be the next chunk read.</span></span><span class="mpre">
</span><a href="#loc_202_1_202_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_202_1_202_20&#39;)"><span class="mpre">connectionGetChunk&#39;</span></a><span class="mpre"> :: </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">, </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">)) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_202_1_202_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_202_1_202_20&#39;)"><span class="hl_vardecl"><span class="mpre">connectionGetChunk&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_205_1_205_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_1_205_23&#39;)"><span class="hl_varref"><span class="mpre">connectionGetChunkBase</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;connectionGetChunk&#39;&quot;</span></span><span class="mpre">

</span><a href="#loc_205_1_205_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_1_205_23&#39;)"><span class="mpre">connectionGetChunkBase</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">, </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">)) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_205_1_205_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_1_205_23&#39;)"><span class="hl_fundecl"><span class="mpre">connectionGetChunkBase</span></span></a><span class="mpre"> </span><a name="loc_205_24_205_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_24_205_27&#39;)"><span class="hl_vardecl"><span class="mpre">loc</span></span></a><span class="mpre"> </span><a name="loc_205_28_205_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_28_205_32&#39;)"><span class="hl_vardecl"><span class="mpre">conn</span></span></a><span class="mpre"> </span><a name="loc_205_33_205_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_33_205_34&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> =
    </span><a href="Control.Concurrent.MVar.html#loc_228_1_228_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.MVar.html#loc_228_1_228_11&#39;)"><span class="hl_varref"><span class="mpre">modifyMVar</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_86_7_86_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_86_7_86_23&#39;)"><span class="hl_varref"><span class="mpre">connectionBuffer</span></span></a><span class="mpre"> </span><a href="#loc_205_28_205_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_28_205_32&#39;)"><span class="hl_varref"><span class="mpre">conn</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_206_43_206_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_43_206_44&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre"> -&gt;
        case </span><a href="#loc_206_43_206_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_43_206_44&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> of
            </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; </span><a href="#loc_272_1_272_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_1_272_9&#39;)"><span class="hl_varref"><span class="mpre">throwEOF</span></span></a><span class="mpre"> </span><a href="#loc_205_28_205_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_28_205_32&#39;)"><span class="hl_varref"><span class="mpre">conn</span></span></a><span class="mpre"> </span><a href="#loc_205_24_205_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_24_205_27&#39;)"><span class="hl_varref"><span class="mpre">loc</span></span></a><span class="mpre">
            </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_209_18_209_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_209_18_209_21&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre">
              | </span><span class="hl_varref"><span class="mpre">B.null</span></span><span class="mpre"> </span><a href="#loc_209_18_209_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_209_18_209_21&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> -&gt; do
                  </span><a name="loc_211_19_211_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_19_211_24&#39;)"><span class="hl_vardecl"><span class="mpre">chunk</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_119_1_119_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_12&#39;)"><span class="hl_varref"><span class="mpre">withBackend</span></span></a><span class="mpre"> </span><a href="#loc_218_5_218_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_5_218_16&#39;)"><span class="hl_varref"><span class="mpre">getMoreData</span></span></a><span class="mpre"> </span><a href="#loc_205_28_205_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_28_205_32&#39;)"><span class="hl_varref"><span class="mpre">conn</span></span></a><span class="mpre">
                  if </span><span class="hl_varref"><span class="mpre">B.null</span></span><span class="mpre"> </span><a href="#loc_211_19_211_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_19_211_24&#39;)"><span class="hl_varref"><span class="mpre">chunk</span></span></a><span class="mpre">
                     then </span><a href="#loc_222_5_222_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_5_222_13&#39;)"><span class="hl_varref"><span class="mpre">closeBuf</span></span></a><span class="mpre"> </span><a href="#loc_211_19_211_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_19_211_24&#39;)"><span class="hl_varref"><span class="mpre">chunk</span></span></a><span class="mpre">
                     else </span><a href="#loc_221_5_221_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_5_221_14&#39;)"><span class="hl_varref"><span class="mpre">updateBuf</span></span></a><span class="mpre"> </span><a href="#loc_211_19_211_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_19_211_24&#39;)"><span class="hl_varref"><span class="mpre">chunk</span></span></a><span class="mpre">
              | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> -&gt;
                  </span><a href="#loc_221_5_221_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_5_221_14&#39;)"><span class="hl_varref"><span class="mpre">updateBuf</span></span></a><span class="mpre"> </span><a href="#loc_209_18_209_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_209_18_209_21&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">
  where
    </span><a name="loc_218_5_218_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_5_218_16&#39;)"><span class="hl_fundecl"><span class="mpre">getMoreData</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_27_26_27_39" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_27_26_27_39&#39;)"><span class="hl_conref"><span class="mpre">ConnectionTLS</span></span></a><span class="mpre"> </span><a name="loc_218_32_218_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_32_218_38&#39;)"><span class="hl_vardecl"><span class="mpre">tlsctx</span></span></a><span class="mpre">) = </span><a href="Network.TLS.Core.html#loc_73_1_73_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Core.html#loc_73_1_73_9&#39;)"><span class="hl_varref"><span class="mpre">TLS.recvData</span></span></a><span class="mpre"> </span><a href="#loc_218_32_218_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_32_218_38&#39;)"><span class="hl_varref"><span class="mpre">tlsctx</span></span></a><span class="mpre">
    </span><a href="#loc_218_5_218_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_5_218_16&#39;)"><span class="hl_fundecl"><span class="mpre">getMoreData</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_26_26_26_42" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_26_26_26_42&#39;)"><span class="hl_conref"><span class="mpre">ConnectionStream</span></span></a><span class="mpre"> </span><a name="loc_219_35_219_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_35_219_36&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre">)   = </span><span class="hl_varref"><span class="mpre">B.hGetSome</span></span><span class="mpre"> </span><a href="#loc_219_35_219_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_35_219_36&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> (</span><span class="hl_num"><span class="mpre">16</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1024</span></span><span class="mpre">)

    </span><a name="loc_221_5_221_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_5_221_14&#39;)"><span class="hl_fundecl"><span class="mpre">updateBuf</span></span></a><span class="mpre"> </span><a name="loc_221_15_221_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_15_221_18&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre"> = case </span><a href="#loc_205_33_205_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_33_205_34&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_221_15_221_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_15_221_18&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> of (</span><a name="loc_221_36_221_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_36_221_37&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre">, !</span><a name="loc_221_40_221_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_40_221_44&#39;)"><span class="hl_vardecl"><span class="mpre">buf&#39;</span></span></a><span class="mpre">) -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a href="#loc_221_40_221_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_40_221_44&#39;)"><span class="hl_varref"><span class="mpre">buf&#39;</span></span></a><span class="mpre">, </span><a href="#loc_221_36_221_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_36_221_37&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">)
    </span><a name="loc_222_5_222_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_5_222_13&#39;)"><span class="hl_fundecl"><span class="mpre">closeBuf</span></span></a><span class="mpre">  </span><a name="loc_222_15_222_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_15_222_18&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre"> = case </span><a href="#loc_205_33_205_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_33_205_34&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_222_15_222_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_15_222_18&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> of (</span><a name="loc_222_36_222_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_36_222_37&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre">, </span><span class="hl_vardecl"><span class="mpre">_buf&#39;</span></span><span class="mpre">) -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">, </span><a href="#loc_222_36_222_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_36_222_37&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Get the next line, using ASCII LF as the line terminator.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This throws an &#39;isEOFError&#39; exception on end of input, and LineTooLong when</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the number of bytes gathered is over the limit without a line terminator.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The actual line returned can be bigger than the limit specified, provided</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- that the last chunk returned by the underlaying backend contains a LF.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- In another world only when we need more input and limit is reached that the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- LineTooLong exception will be raised.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- An end of file will be considered as a line terminator too, if line is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- not empty.</span></span><span class="mpre">
</span><a href="#loc_239_1_239_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_1_239_18&#39;)"><span class="mpre">connectionGetLine</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">           </span><span class="hl_comment"><span class="mpre">-- ^ Maximum number of bytes before raising a LineTooLong exception</span></span><span class="mpre">
                  -&gt; </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre">    </span><span class="hl_comment"><span class="mpre">-- ^ Connection</span></span><span class="mpre">
                  -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ The received line with the LF trimmed</span></span><span class="mpre">
</span><a name="loc_239_1_239_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_1_239_18&#39;)"><span class="hl_fundecl"><span class="mpre">connectionGetLine</span></span></a><span class="mpre"> </span><a name="loc_239_19_239_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_19_239_24&#39;)"><span class="hl_vardecl"><span class="mpre">limit</span></span></a><span class="mpre"> </span><a name="loc_239_25_239_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_25_239_29&#39;)"><span class="hl_vardecl"><span class="mpre">conn</span></span></a><span class="mpre"> = </span><a href="#loc_246_5_246_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_5_246_9&#39;)"><span class="hl_varref"><span class="mpre">more</span></span></a><span class="mpre"> (</span><a href="#loc_272_1_272_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_1_272_9&#39;)"><span class="hl_varref"><span class="mpre">throwEOF</span></span></a><span class="mpre"> </span><a href="#loc_239_25_239_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_25_239_29&#39;)"><span class="hl_varref"><span class="mpre">conn</span></span></a><span class="mpre"> </span><a href="#loc_241_5_241_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_5_241_8&#39;)"><span class="hl_varref"><span class="mpre">loc</span></span></a><span class="mpre">) </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">id</span></span><span class="mpre">
  where
    </span><a name="loc_241_5_241_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_5_241_8&#39;)"><span class="hl_vardecl"><span class="mpre">loc</span></span></a><span class="mpre"> = </span><span class="hl_string"><span class="mpre">&quot;connectionGetLine&quot;</span></span><span class="mpre">
    </span><a name="loc_242_5_242_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_5_242_16&#39;)"><span class="hl_vardecl"><span class="mpre">lineTooLong</span></span></a><span class="mpre"> = </span><a href="GHC.IO.html#loc_304_1_304_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_304_1_304_8&#39;)"><span class="hl_varref"><span class="mpre">E.throwIO</span></span></a><span class="mpre"> </span><a href="#loc_80_20_80_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_20_80_31&#39;)"><span class="hl_conref"><span class="mpre">LineTooLong</span></span></a><span class="mpre">

    </span><span class="hl_comment"><span class="mpre">-- Accumulate chunks using a difference list, and concatenate them</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- when an end-of-line indicator is reached.</span></span><span class="mpre">
    </span><a name="loc_246_5_246_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_5_246_9&#39;)"><span class="hl_fundecl"><span class="mpre">more</span></span></a><span class="mpre"> </span><a name="loc_246_10_246_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_10_246_14&#39;)"><span class="hl_vardecl"><span class="mpre">eofK</span></span></a><span class="mpre"> !</span><a name="loc_246_16_246_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_16_246_25&#39;)"><span class="hl_vardecl"><span class="mpre">currentSz</span></span></a><span class="mpre"> !</span><a name="loc_246_27_246_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_27_246_29&#39;)"><span class="hl_vardecl"><span class="mpre">dl</span></span></a><span class="mpre"> =
        </span><a href="#loc_262_5_262_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_262_5_262_13&#39;)"><span class="hl_varref"><span class="mpre">getChunk</span></span></a><span class="mpre"> (\</span><a name="loc_247_20_247_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_20_247_21&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> -&gt; let </span><a name="loc_247_29_247_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_29_247_32&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">B.length</span></span><span class="mpre"> </span><a href="#loc_247_20_247_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_20_247_21&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">
                         in if </span><a href="#loc_246_16_246_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_16_246_25&#39;)"><span class="hl_varref"><span class="mpre">currentSz</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><a href="#loc_247_29_247_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_29_247_32&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><a href="#loc_239_19_239_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_19_239_24&#39;)"><span class="hl_varref"><span class="mpre">limit</span></span></a><span class="mpre">
                               then </span><a href="#loc_242_5_242_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_5_242_16&#39;)"><span class="hl_varref"><span class="mpre">lineTooLong</span></span></a><span class="mpre">
                               else </span><a href="#loc_246_5_246_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_5_246_9&#39;)"><span class="hl_varref"><span class="mpre">more</span></span></a><span class="mpre"> </span><a href="#loc_246_10_246_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_10_246_14&#39;)"><span class="hl_varref"><span class="mpre">eofK</span></span></a><span class="mpre"> (</span><a href="#loc_246_16_246_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_16_246_25&#39;)"><span class="hl_varref"><span class="mpre">currentSz</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><a href="#loc_247_29_247_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_29_247_32&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">) (</span><a href="#loc_246_27_246_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_27_246_29&#39;)"><span class="hl_varref"><span class="mpre">dl</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> (</span><a href="#loc_247_20_247_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_20_247_21&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre">)))
                 (\</span><a name="loc_251_20_251_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_251_20_251_21&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_255_5_255_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_255_5_255_9&#39;)"><span class="hl_varref"><span class="mpre">done</span></span></a><span class="mpre"> (</span><a href="#loc_246_27_246_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_27_246_29&#39;)"><span class="hl_varref"><span class="mpre">dl</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> (</span><a href="#loc_251_20_251_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_251_20_251_21&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre">)))
                 (</span><a href="#loc_255_5_255_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_255_5_255_9&#39;)"><span class="hl_varref"><span class="mpre">done</span></span></a><span class="mpre"> </span><a href="#loc_246_27_246_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_27_246_29&#39;)"><span class="hl_varref"><span class="mpre">dl</span></span></a><span class="mpre">)

    </span><a href="#loc_255_5_255_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_255_5_255_9&#39;)"><span class="mpre">done</span></a><span class="mpre"> :: ([</span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">] -&gt; [</span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">]) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">
    </span><a name="loc_255_5_255_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_255_5_255_9&#39;)"><span class="hl_fundecl"><span class="mpre">done</span></span></a><span class="mpre"> </span><a name="loc_255_10_255_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_255_10_255_12&#39;)"><span class="hl_vardecl"><span class="mpre">dl</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">B.concat</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_255_10_255_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_255_10_255_12&#39;)"><span class="hl_varref"><span class="mpre">dl</span></span></a><span class="mpre"> []

    </span><span class="hl_comment"><span class="mpre">-- Get another chunk, and call one of the continuations</span></span><span class="mpre">
    </span><a href="#loc_262_5_262_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_262_5_262_13&#39;)"><span class="mpre">getChunk</span></a><span class="mpre"> :: (</span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">) </span><span class="hl_comment"><span class="mpre">-- moreK: need more input</span></span><span class="mpre">
             -&gt; (</span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">) </span><span class="hl_comment"><span class="mpre">-- doneK: end of line (line terminator found)</span></span><span class="mpre">
             -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">                 </span><span class="hl_comment"><span class="mpre">-- eofK:  end of file</span></span><span class="mpre">
             -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">
    </span><a name="loc_262_5_262_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_262_5_262_13&#39;)"><span class="hl_fundecl"><span class="mpre">getChunk</span></span></a><span class="mpre"> </span><a name="loc_262_14_262_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_262_14_262_19&#39;)"><span class="hl_vardecl"><span class="mpre">moreK</span></span></a><span class="mpre"> </span><a name="loc_262_20_262_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_262_20_262_25&#39;)"><span class="hl_vardecl"><span class="mpre">doneK</span></span></a><span class="mpre"> </span><a name="loc_262_26_262_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_262_26_262_30&#39;)"><span class="hl_vardecl"><span class="mpre">eofK</span></span></a><span class="mpre"> =
      </span><a href="Control.Monad.html#loc_204_1_204_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_204_1_204_5&#39;)"><span class="hl_varref"><span class="mpre">join</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_205_1_205_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_1_205_23&#39;)"><span class="hl_varref"><span class="mpre">connectionGetChunkBase</span></span></a><span class="mpre"> </span><a href="#loc_241_5_241_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_5_241_8&#39;)"><span class="hl_varref"><span class="mpre">loc</span></span></a><span class="mpre"> </span><a href="#loc_239_25_239_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_25_239_29&#39;)"><span class="hl_varref"><span class="mpre">conn</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_263_49_263_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_263_49_263_50&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> -&gt;
        if </span><span class="hl_varref"><span class="mpre">B.null</span></span><span class="mpre"> </span><a href="#loc_263_49_263_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_263_49_263_50&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">
          then (</span><a href="#loc_262_26_262_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_262_26_262_30&#39;)"><span class="hl_varref"><span class="mpre">eofK</span></span></a><span class="mpre">, </span><span class="hl_varref"><span class="mpre">B.empty</span></span><span class="mpre">)
          else case </span><span class="hl_varref"><span class="mpre">B.breakByte</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">10</span></span><span class="mpre"> </span><a href="#loc_263_49_263_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_263_49_263_50&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> of
                 (</span><a name="loc_267_19_267_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_19_267_20&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre">, </span><a name="loc_267_22_267_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_22_267_23&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">)
                   | </span><span class="hl_varref"><span class="mpre">B.null</span></span><span class="mpre"> </span><a href="#loc_267_22_267_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_22_267_23&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">  -&gt; (</span><a href="#loc_262_14_262_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_262_14_262_19&#39;)"><span class="hl_varref"><span class="mpre">moreK</span></span></a><span class="mpre"> </span><a href="#loc_267_19_267_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_19_267_20&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">, </span><span class="hl_varref"><span class="mpre">B.empty</span></span><span class="mpre">)
                   | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> -&gt; (</span><a href="#loc_262_20_262_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_262_20_262_25&#39;)"><span class="hl_varref"><span class="mpre">doneK</span></span></a><span class="mpre"> </span><a href="#loc_267_19_267_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_19_267_20&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">, </span><span class="hl_varref"><span class="mpre">B.tail</span></span><span class="mpre"> </span><a href="#loc_267_22_267_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_22_267_23&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">)

</span><a href="#loc_272_1_272_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_1_272_9&#39;)"><span class="mpre">throwEOF</span></a><span class="mpre"> :: </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_272_1_272_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_1_272_9&#39;)"><span class="hl_fundecl"><span class="mpre">throwEOF</span></span></a><span class="mpre"> </span><a name="loc_272_10_272_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_10_272_14&#39;)"><span class="hl_vardecl"><span class="mpre">conn</span></span></a><span class="mpre"> </span><a name="loc_272_15_272_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_15_272_18&#39;)"><span class="hl_vardecl"><span class="mpre">loc</span></span></a><span class="mpre"> =
    </span><a href="GHC.IO.html#loc_304_1_304_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_304_1_304_8&#39;)"><span class="hl_varref"><span class="mpre">E.throwIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="System.IO.Error.html#loc_115_1_115_10" onmouseover="nemnem.highlightLocalToRemote(&#39;System.IO.Error.html#loc_115_1_115_10&#39;)"><span class="hl_varref"><span class="mpre">E.mkIOError</span></span></a><span class="mpre"> </span><a href="System.IO.Error.html#loc_198_1_198_13" onmouseover="nemnem.highlightLocalToRemote(&#39;System.IO.Error.html#loc_198_1_198_13&#39;)"><span class="hl_varref"><span class="mpre">E.eofErrorType</span></span></a><span class="mpre"> </span><a href="#loc_275_5_275_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_275_5_275_9&#39;)"><span class="hl_varref"><span class="mpre">loc&#39;</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a href="#loc_276_5_276_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_276_5_276_9&#39;)"><span class="hl_varref"><span class="mpre">path</span></span></a><span class="mpre">)
  where
    </span><a name="loc_275_5_275_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_275_5_275_9&#39;)"><span class="hl_vardecl"><span class="mpre">loc&#39;</span></span></a><span class="mpre"> = </span><span class="hl_string"><span class="mpre">&quot;Network.Connection.&quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><a href="#loc_272_15_272_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_15_272_18&#39;)"><span class="hl_varref"><span class="mpre">loc</span></span></a><span class="mpre">
    </span><a name="loc_276_5_276_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_276_5_276_9&#39;)"><span class="hl_vardecl"><span class="mpre">path</span></span></a><span class="mpre"> = let (</span><a name="loc_276_17_276_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_276_17_276_21&#39;)"><span class="hl_vardecl"><span class="mpre">host</span></span></a><span class="mpre">, </span><a name="loc_276_23_276_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_276_23_276_27&#39;)"><span class="hl_vardecl"><span class="mpre">port</span></span></a><span class="mpre">) = </span><a href="Network.Connection.Types.html#loc_87_7_87_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_87_7_87_19&#39;)"><span class="hl_varref"><span class="mpre">connectionID</span></span></a><span class="mpre"> </span><a href="#loc_272_10_272_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_10_272_14&#39;)"><span class="hl_varref"><span class="mpre">conn</span></span></a><span class="mpre">
            in </span><a href="#loc_276_17_276_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_276_17_276_21&#39;)"><span class="hl_varref"><span class="mpre">host</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;:&quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_276_23_276_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_276_23_276_27&#39;)"><span class="hl_varref"><span class="mpre">port</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Close a connection.</span></span><span class="mpre">
</span><a href="#loc_281_1_281_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_281_1_281_16&#39;)"><span class="mpre">connectionClose</span></a><span class="mpre"> :: </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_281_1_281_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_281_1_281_16&#39;)"><span class="hl_vardecl"><span class="mpre">connectionClose</span></span></a><span class="mpre"> = </span><a href="#loc_119_1_119_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_12&#39;)"><span class="hl_varref"><span class="mpre">withBackend</span></span></a><span class="mpre"> </span><a href="#loc_282_11_282_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_282_11_282_23&#39;)"><span class="hl_varref"><span class="mpre">backendClose</span></span></a><span class="mpre">
    where </span><a name="loc_282_11_282_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_282_11_282_23&#39;)"><span class="hl_fundecl"><span class="mpre">backendClose</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_27_26_27_39" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_27_26_27_39&#39;)"><span class="hl_conref"><span class="mpre">ConnectionTLS</span></span></a><span class="mpre"> </span><a name="loc_282_39_282_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_282_39_282_42&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre">)  = </span><a href="Network.TLS.Core.html#loc_52_1_52_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Core.html#loc_52_1_52_4&#39;)"><span class="hl_varref"><span class="mpre">TLS.bye</span></span></a><span class="mpre"> </span><a href="#loc_282_39_282_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_282_39_282_42&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_122_1_122_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_122_1_122_13&#39;)"><span class="hl_varref"><span class="mpre">TLS.contextClose</span></span></a><span class="mpre"> </span><a href="#loc_282_39_282_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_282_39_282_42&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
          </span><a href="#loc_282_11_282_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_282_11_282_23&#39;)"><span class="hl_fundecl"><span class="mpre">backendClose</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_26_26_26_42" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_26_26_26_42&#39;)"><span class="hl_conref"><span class="mpre">ConnectionStream</span></span></a><span class="mpre"> </span><a name="loc_283_42_283_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_42_283_43&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre">) = </span><a href="GHC.IO.Handle.html#loc_86_1_86_7" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.html#loc_86_1_86_7&#39;)"><span class="hl_varref"><span class="mpre">hClose</span></span></a><span class="mpre"> </span><a href="#loc_283_42_283_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_42_283_43&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Activate secure layer using the parameters specified.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This is typically used to negociate a TLS channel on an already</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- establish channel, e.g. supporting a STARTTLS command. it also</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- flush the received buffer to prevent application confusing</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- received data before and after the setSecure call.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- If the connection is already using TLS, nothing else happens.</span></span><span class="mpre">
</span><a href="#loc_297_1_297_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_1_297_20&#39;)"><span class="mpre">connectionSetSecure</span></a><span class="mpre"> :: </span><a href="Network.Connection.Types.html#loc_94_6_94_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_94_6_94_23&#39;)"><span class="hl_tyconref"><span class="mpre">ConnectionContext</span></span></a><span class="mpre">
                    -&gt; </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre">
                    -&gt; </span><a href="Network.Connection.Types.html#loc_65_6_65_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_65_6_65_17&#39;)"><span class="hl_tyconref"><span class="mpre">TLSSettings</span></span></a><span class="mpre">
                    -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_297_1_297_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_1_297_20&#39;)"><span class="hl_fundecl"><span class="mpre">connectionSetSecure</span></span></a><span class="mpre"> </span><a name="loc_297_21_297_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_21_297_23&#39;)"><span class="hl_vardecl"><span class="mpre">cg</span></span></a><span class="mpre"> </span><a name="loc_297_24_297_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_24_297_34&#39;)"><span class="hl_vardecl"><span class="mpre">connection</span></span></a><span class="mpre"> </span><a name="loc_297_35_297_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_35_297_41&#39;)"><span class="hl_vardecl"><span class="mpre">params</span></span></a><span class="mpre"> =
    </span><a href="Control.Concurrent.MVar.html#loc_216_1_216_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.MVar.html#loc_216_1_216_12&#39;)"><span class="hl_varref"><span class="mpre">modifyMVar_</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_86_7_86_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_86_7_86_23&#39;)"><span class="hl_varref"><span class="mpre">connectionBuffer</span></span></a><span class="mpre"> </span><a href="#loc_297_24_297_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_24_297_34&#39;)"><span class="hl_varref"><span class="mpre">connection</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_298_50_298_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_298_50_298_51&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> -&gt;
    </span><a href="Control.Concurrent.MVar.html#loc_228_1_228_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.MVar.html#loc_228_1_228_11&#39;)"><span class="hl_varref"><span class="mpre">modifyMVar</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_85_7_85_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_85_7_85_24&#39;)"><span class="hl_varref"><span class="mpre">connectionBackend</span></span></a><span class="mpre"> </span><a href="#loc_297_24_297_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_24_297_34&#39;)"><span class="hl_varref"><span class="mpre">connection</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_299_50_299_57" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_50_299_57&#39;)"><span class="hl_vardecl"><span class="mpre">backend</span></span></a><span class="mpre"> -&gt;
        case </span><a href="#loc_299_50_299_57" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_50_299_57&#39;)"><span class="hl_varref"><span class="mpre">backend</span></span></a><span class="mpre"> of
            (</span><a href="Network.Connection.Types.html#loc_26_26_26_42" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_26_26_26_42&#39;)"><span class="hl_conref"><span class="mpre">ConnectionStream</span></span></a><span class="mpre"> </span><a name="loc_301_31_301_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_31_301_32&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre">) -&gt; do </span><a name="loc_301_40_301_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_40_301_43&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_312_1_312_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_312_1_312_13&#39;)"><span class="hl_varref"><span class="mpre">tlsEstablish</span></span></a><span class="mpre"> </span><a href="#loc_301_31_301_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_31_301_32&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> (</span><a href="#loc_99_1_99_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_1_99_14&#39;)"><span class="hl_varref"><span class="mpre">makeTLSParams</span></span></a><span class="mpre"> </span><a href="#loc_297_21_297_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_21_297_23&#39;)"><span class="hl_varref"><span class="mpre">cg</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_87_7_87_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_87_7_87_19&#39;)"><span class="hl_varref"><span class="mpre">connectionID</span></span></a><span class="mpre"> </span><a href="#loc_297_24_297_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_24_297_34&#39;)"><span class="hl_varref"><span class="mpre">connection</span></span></a><span class="mpre">) </span><a href="#loc_297_35_297_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_35_297_41&#39;)"><span class="hl_varref"><span class="mpre">params</span></span></a><span class="mpre">)
                                       </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_27_26_27_39" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_27_26_27_39&#39;)"><span class="hl_conref"><span class="mpre">ConnectionTLS</span></span></a><span class="mpre"> </span><a href="#loc_301_40_301_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_40_301_43&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">, </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">B.empty</span></span><span class="mpre">)
            (</span><a href="Network.Connection.Types.html#loc_27_26_27_39" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_27_26_27_39&#39;)"><span class="hl_conref"><span class="mpre">ConnectionTLS</span></span></a><span class="mpre"> _)    -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_299_50_299_57" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_50_299_57&#39;)"><span class="hl_varref"><span class="mpre">backend</span></span></a><span class="mpre">, </span><a href="#loc_298_50_298_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_298_50_298_51&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Returns if the connection is establish securely or not.</span></span><span class="mpre">
</span><a href="#loc_307_1_307_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_1_307_19&#39;)"><span class="mpre">connectionIsSecure</span></a><span class="mpre"> :: </span><a href="Network.Connection.Types.html#loc_84_6_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_84_6_84_16&#39;)"><span class="hl_tyconref"><span class="mpre">Connection</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
</span><a name="loc_307_1_307_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_1_307_19&#39;)"><span class="hl_fundecl"><span class="mpre">connectionIsSecure</span></span></a><span class="mpre"> </span><a name="loc_307_20_307_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_20_307_24&#39;)"><span class="hl_vardecl"><span class="mpre">conn</span></span></a><span class="mpre"> = </span><a href="#loc_119_1_119_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_12&#39;)"><span class="hl_varref"><span class="mpre">withBackend</span></span></a><span class="mpre"> </span><a href="#loc_308_11_308_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_11_308_19&#39;)"><span class="hl_varref"><span class="mpre">isSecure</span></span></a><span class="mpre"> </span><a href="#loc_307_20_307_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_20_307_24&#39;)"><span class="hl_varref"><span class="mpre">conn</span></span></a><span class="mpre">
    where </span><a name="loc_308_11_308_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_11_308_19&#39;)"><span class="hl_fundecl"><span class="mpre">isSecure</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_26_26_26_42" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_26_26_26_42&#39;)"><span class="hl_conref"><span class="mpre">ConnectionStream</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">
          </span><a href="#loc_308_11_308_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_11_308_19&#39;)"><span class="hl_fundecl"><span class="mpre">isSecure</span></span></a><span class="mpre"> (</span><a href="Network.Connection.Types.html#loc_27_26_27_39" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Connection.Types.html#loc_27_26_27_39&#39;)"><span class="hl_conref"><span class="mpre">ConnectionTLS</span></span></a><span class="mpre"> _)    = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">

</span><a href="#loc_312_1_312_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_312_1_312_13&#39;)"><span class="mpre">tlsEstablish</span></a><span class="mpre"> :: </span><a href="GHC.IO.Handle.Types.html#loc_100_6_100_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Types.html#loc_100_6_100_12&#39;)"><span class="hl_tyconref"><span class="mpre">Handle</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Parameters.html#loc_43_6_43_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_43_6_43_18&#39;)"><span class="hl_tyconref"><span class="mpre">TLS.ClientParams</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">TLS.Context</span></span></a><span class="mpre">
</span><a name="loc_312_1_312_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_312_1_312_13&#39;)"><span class="hl_fundecl"><span class="mpre">tlsEstablish</span></span></a><span class="mpre"> </span><a name="loc_312_14_312_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_312_14_312_20&#39;)"><span class="hl_vardecl"><span class="mpre">handle</span></span></a><span class="mpre"> </span><a name="loc_312_21_312_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_312_21_312_30&#39;)"><span class="hl_vardecl"><span class="mpre">tlsParams</span></span></a><span class="mpre"> = do
    </span><a name="loc_313_5_313_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_313_5_313_8&#39;)"><span class="hl_vardecl"><span class="mpre">rng</span></span></a><span class="mpre"> &lt;- </span><a href="Crypto.Random.AESCtr.html#loc_72_1_72_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Crypto.Random.AESCtr.html#loc_72_1_72_11&#39;)"><span class="hl_varref"><span class="mpre">RNG.makeSystem</span></span></a><span class="mpre">
    </span><a name="loc_314_5_314_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_314_5_314_8&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.html#loc_141_1_141_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.html#loc_141_1_141_11&#39;)"><span class="hl_varref"><span class="mpre">TLS.contextNew</span></span></a><span class="mpre"> </span><a href="#loc_312_14_312_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_312_14_312_20&#39;)"><span class="hl_varref"><span class="mpre">handle</span></span></a><span class="mpre"> </span><a href="#loc_312_21_312_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_312_21_312_30&#39;)"><span class="hl_varref"><span class="mpre">tlsParams</span></span></a><span class="mpre"> </span><a href="#loc_313_5_313_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_313_5_313_8&#39;)"><span class="hl_varref"><span class="mpre">rng</span></span></a><span class="mpre">
    </span><a href="Network.TLS.Handshake.html#loc_31_1_31_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.html#loc_31_1_31_10&#39;)"><span class="hl_varref"><span class="mpre">TLS.handshake</span></span></a><span class="mpre"> </span><a href="#loc_314_5_314_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_314_5_314_8&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_314_5_314_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_314_5_314_8&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
</span></div></body></html>