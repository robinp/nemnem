<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE Trustworthy #-}
{-# LANGUAGE CPP, NoImplicitPrelude #-}

</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      :  Foreign.C.String</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   :  (c) The FFI task force 2001</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     :  BSD-style (see the file libraries/base/LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- </span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  :  ffi@haskell.org</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   :  provisional</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability :  portable</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Utilities for primitive marshalling of C strings.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The marshalling converts each Haskell character, representing a Unicode</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- code point, to one or more bytes in a manner that, by default, is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- determined by the current locale.  As a consequence, no guarantees</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- can be made about the relative length of a Haskell string and its</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- corresponding C string, and therefore all the marshalling routines</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- include memory allocation.  The translation between Unicode and the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- encoding of the current locale may be lossy.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">

module Foreign.C.String (   </span><span class="hl_comment"><span class="mpre">-- representation of strings in C</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- * C strings</span></span><span class="mpre">

  CString,
  CStringLen,

  </span><span class="hl_comment"><span class="mpre">-- ** Using a locale-dependent encoding</span></span><span class="mpre">

  </span><span class="hl_comment"><span class="mpre">-- | These functions are different from their @CAString@ counterparts</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- in that they will use an encoding determined by the current locale,</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- rather than always assuming ASCII.</span></span><span class="mpre">

  </span><span class="hl_comment"><span class="mpre">-- conversion of C strings into Haskell strings</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
  peekCString,
  peekCStringLen,

  </span><span class="hl_comment"><span class="mpre">-- conversion of Haskell strings into C strings</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
  newCString,
  newCStringLen,

  </span><span class="hl_comment"><span class="mpre">-- conversion of Haskell strings into C strings using temporary storage</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
  withCString,
  withCStringLen,

  charIsRepresentable,

  </span><span class="hl_comment"><span class="mpre">-- ** Using 8-bit characters</span></span><span class="mpre">

  </span><span class="hl_comment"><span class="mpre">-- | These variants of the above functions are for use with C libraries</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- that are ignorant of Unicode.  These functions should be used with</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- care, as a loss of information can occur.</span></span><span class="mpre">

  castCharToCChar,
  castCCharToChar,

  castCharToCUChar,
  castCUCharToChar,
  castCharToCSChar,
  castCSCharToChar,

  peekCAString,
  peekCAStringLen,
  newCAString,
  newCAStringLen,
  withCAString,
  withCAStringLen,

  </span><span class="hl_comment"><span class="mpre">-- * C wide strings</span></span><span class="mpre">

  </span><span class="hl_comment"><span class="mpre">-- | These variants of the above functions are for use with C libraries</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- that encode Unicode using the C @wchar_t@ type in a system-dependent</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- way.  The only encodings supported are</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- * UTF-32 (the C compiler defines @__STDC_ISO_10646__@), or</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- * UTF-16 (as used on Windows systems).</span></span><span class="mpre">

  CWString,
  CWStringLen,

  peekCWString,
  peekCWStringLen,
  newCWString,
  newCWStringLen,
  withCWString,
  withCWStringLen,

  ) where

import Foreign.Marshal.Array
import Foreign.C.Types
import Foreign.Ptr
import Foreign.Storable

import Data.Word

import Control.Monad

import GHC.Char
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 108, srcSpanStartColumn = 8, srcSpanEndLine = 108, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.List&quot;"><span class="mpre">GHC.List</span></span><span class="mpre">
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 109, srcSpanStartColumn = 8, srcSpanEndLine = 109, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Real&quot;"><span class="mpre">GHC.Real</span></span><span class="mpre">
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 110, srcSpanStartColumn = 8, srcSpanEndLine = 110, srcSpanEndColumn = 15}, srcInfoPoints = []}) &quot;GHC.Num&quot;"><span class="mpre">GHC.Num</span></span><span class="mpre">
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 111, srcSpanStartColumn = 8, srcSpanEndLine = 111, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Base&quot;"><span class="mpre">GHC.Base</span></span><span class="mpre">

import {-# SOURCE #-} GHC.IO.Encoding
import qualified GHC.Foreign as GHC

</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Strings</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- representation of strings in C</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A C string is a reference to an array of C characters terminated by NUL.</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 123, srcSpanStartColumn = 1, srcSpanEndLine = 123, srcSpanEndColumn = 28}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 123, srcSpanStartColumn = 1, srcSpanEndLine = 123, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 123,"><span class="mpre">type CString    = Ptr CChar</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A string with explicit length information in bytes instead of a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- terminating NUL (allowing NUL characters in the middle of the string).</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 127, srcSpanStartColumn = 1, srcSpanEndLine = 127, srcSpanEndColumn = 35}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 127, srcSpanStartColumn = 1, srcSpanEndLine = 127, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 127,"><span class="mpre">type CStringLen = (Ptr CChar, Int)</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- exported functions</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the following routines apply the default conversion when converting the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   C-land character encoding into the Haskell-land character encoding</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a NUL terminated C string into a Haskell string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_138_1_138_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_1_138_12&#39;)"><span class="mpre">peekCString</span></a><span class="mpre">    :: </span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">
</span><a name="loc_138_1_138_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_1_138_12&#39;)"><span class="hl_fundecl"><span class="mpre">peekCString</span></span></a><span class="mpre"> </span><a name="loc_138_13_138_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_13_138_14&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Encoding.html#loc_135_2_135_20" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.html#loc_135_2_135_20&#39;)"><span class="hl_varref"><span class="mpre">getForeignEncoding</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">flip</span></span><span class="mpre"> </span><a href="GHC.Foreign.html#loc_86_1_86_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Foreign.html#loc_86_1_86_12&#39;)"><span class="hl_varref"><span class="mpre">GHC.peekCString</span></span></a><span class="mpre"> </span><a href="#loc_138_13_138_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_13_138_14&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a C string with explicit length into a Haskell string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_143_1_143_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_143_1_143_15&#39;)"><span class="mpre">peekCStringLen</span></a><span class="mpre">           :: </span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">
</span><a name="loc_143_1_143_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_143_1_143_15&#39;)"><span class="hl_fundecl"><span class="mpre">peekCStringLen</span></span></a><span class="mpre"> </span><a name="loc_143_16_143_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_143_16_143_17&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Encoding.html#loc_135_2_135_20" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.html#loc_135_2_135_20&#39;)"><span class="hl_varref"><span class="mpre">getForeignEncoding</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">flip</span></span><span class="mpre"> </span><a href="GHC.Foreign.html#loc_93_1_93_15" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Foreign.html#loc_93_1_93_15&#39;)"><span class="hl_varref"><span class="mpre">GHC.peekCStringLen</span></span></a><span class="mpre"> </span><a href="#loc_143_16_143_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_143_16_143_17&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a NUL terminated C string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the Haskell string may /not/ contain any NUL characters</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * new storage is allocated for the C string and must be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   explicitly freed using &#39;Foreign.Marshal.Alloc.free&#39; or</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;Foreign.Marshal.Alloc.finalizerFree&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_154_1_154_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_1_154_11&#39;)"><span class="mpre">newCString</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre">
</span><a name="loc_154_1_154_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_1_154_11&#39;)"><span class="hl_fundecl"><span class="mpre">newCString</span></span></a><span class="mpre"> </span><a name="loc_154_12_154_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_12_154_13&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Encoding.html#loc_135_2_135_20" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.html#loc_135_2_135_20&#39;)"><span class="hl_varref"><span class="mpre">getForeignEncoding</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">flip</span></span><span class="mpre"> </span><a href="GHC.Foreign.html#loc_104_1_104_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Foreign.html#loc_104_1_104_11&#39;)"><span class="hl_varref"><span class="mpre">GHC.newCString</span></span></a><span class="mpre"> </span><a href="#loc_154_12_154_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_12_154_13&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a C string (ie, character array) with</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- explicit length information.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * new storage is allocated for the C string and must be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   explicitly freed using &#39;Foreign.Marshal.Alloc.free&#39; or</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;Foreign.Marshal.Alloc.finalizerFree&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_164_1_164_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_1_164_14&#39;)"><span class="mpre">newCStringLen</span></a><span class="mpre">     :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre">
</span><a name="loc_164_1_164_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_1_164_14&#39;)"><span class="hl_fundecl"><span class="mpre">newCStringLen</span></span></a><span class="mpre"> </span><a name="loc_164_15_164_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_15_164_16&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Encoding.html#loc_135_2_135_20" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.html#loc_135_2_135_20&#39;)"><span class="hl_varref"><span class="mpre">getForeignEncoding</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">flip</span></span><span class="mpre"> </span><a href="GHC.Foreign.html#loc_114_1_114_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Foreign.html#loc_114_1_114_14&#39;)"><span class="hl_varref"><span class="mpre">GHC.newCStringLen</span></span></a><span class="mpre"> </span><a href="#loc_164_15_164_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_15_164_16&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a NUL terminated C string using temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- storage.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the Haskell string may /not/ contain any NUL characters</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the memory is freed when the subcomputation terminates (either</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   normally or via an exception), so the pointer to the temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   storage must /not/ be used after this.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_176_1_176_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_1_176_12&#39;)"><span class="mpre">withCString</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_176_1_176_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_1_176_12&#39;)"><span class="hl_fundecl"><span class="mpre">withCString</span></span></a><span class="mpre"> </span><a name="loc_176_13_176_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_13_176_14&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_176_15_176_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_15_176_16&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Encoding.html#loc_135_2_135_20" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.html#loc_135_2_135_20&#39;)"><span class="hl_varref"><span class="mpre">getForeignEncoding</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> \</span><a name="loc_176_43_176_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_43_176_46&#39;)"><span class="hl_vardecl"><span class="mpre">enc</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.Foreign.html#loc_126_1_126_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Foreign.html#loc_126_1_126_12&#39;)"><span class="hl_varref"><span class="mpre">GHC.withCString</span></span></a><span class="mpre"> </span><a href="#loc_176_43_176_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_43_176_46&#39;)"><span class="hl_varref"><span class="mpre">enc</span></span></a><span class="mpre"> </span><a href="#loc_176_13_176_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_13_176_14&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> </span><a href="#loc_176_15_176_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_15_176_16&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a C string (ie, character array)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- in temporary storage, with explicit length information.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the memory is freed when the subcomputation terminates (either</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   normally or via an exception), so the pointer to the temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   storage must /not/ be used after this.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_186_1_186_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_1_186_15&#39;)"><span class="mpre">withCStringLen</span></a><span class="mpre">         :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_186_1_186_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_1_186_15&#39;)"><span class="hl_fundecl"><span class="mpre">withCStringLen</span></span></a><span class="mpre"> </span><a name="loc_186_16_186_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_16_186_17&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_186_18_186_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_18_186_19&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Encoding.html#loc_135_2_135_20" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.html#loc_135_2_135_20&#39;)"><span class="hl_varref"><span class="mpre">getForeignEncoding</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> \</span><a name="loc_186_46_186_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_46_186_49&#39;)"><span class="hl_vardecl"><span class="mpre">enc</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.Foreign.html#loc_136_1_136_15" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Foreign.html#loc_136_1_136_15&#39;)"><span class="hl_varref"><span class="mpre">GHC.withCStringLen</span></span></a><span class="mpre"> </span><a href="#loc_186_46_186_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_46_186_49&#39;)"><span class="hl_varref"><span class="mpre">enc</span></span></a><span class="mpre"> </span><a href="#loc_186_16_186_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_16_186_17&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> </span><a href="#loc_186_18_186_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_18_186_19&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- -- | Determines whether a character can be accurately encoded in a &#39;CString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- -- Unrepresentable characters are converted to &#39;?&#39; or their nearest visual equivalent.</span></span><span class="mpre">
</span><a href="#loc_191_1_191_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_1_191_20&#39;)"><span class="mpre">charIsRepresentable</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
</span><a name="loc_191_1_191_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_1_191_20&#39;)"><span class="hl_fundecl"><span class="mpre">charIsRepresentable</span></span></a><span class="mpre"> </span><a name="loc_191_21_191_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_21_191_22&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Encoding.html#loc_135_2_135_20" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.html#loc_135_2_135_20&#39;)"><span class="hl_varref"><span class="mpre">getForeignEncoding</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">flip</span></span><span class="mpre"> </span><a href="GHC.Foreign.html#loc_145_1_145_20" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Foreign.html#loc_145_1_145_20&#39;)"><span class="hl_varref"><span class="mpre">GHC.charIsRepresentable</span></span></a><span class="mpre"> </span><a href="#loc_191_21_191_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_21_191_22&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- single byte characters</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ----------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   ** NOTE: These routines don&#39;t handle conversions! **</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Convert a C byte, representing a Latin-1 character, to the corresponding</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Haskell character.</span></span><span class="mpre">
</span><a href="#loc_201_1_201_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_1_201_16&#39;)"><span class="mpre">castCCharToChar</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CChar</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">
</span><a name="loc_201_1_201_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_1_201_16&#39;)"><span class="hl_fundecl"><span class="mpre">castCCharToChar</span></span></a><span class="mpre"> </span><a name="loc_201_17_201_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_17_201_19&#39;)"><span class="hl_vardecl"><span class="mpre">ch</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">unsafeChr</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_201_17_201_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_17_201_19&#39;)"><span class="hl_varref"><span class="mpre">ch</span></span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">))

</span><span class="hl_comment"><span class="mpre">-- | Convert a Haskell character to a C character.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function is only safe on the first 256 characters.</span></span><span class="mpre">
</span><a href="#loc_206_1_206_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_1_206_16&#39;)"><span class="mpre">castCharToCChar</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">CChar</span></span><span class="mpre">
</span><a name="loc_206_1_206_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_1_206_16&#39;)"><span class="hl_fundecl"><span class="mpre">castCharToCChar</span></span></a><span class="mpre"> </span><a name="loc_206_17_206_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_17_206_19&#39;)"><span class="hl_vardecl"><span class="mpre">ch</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">ord</span></span><span class="mpre"> </span><a href="#loc_206_17_206_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_17_206_19&#39;)"><span class="hl_varref"><span class="mpre">ch</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Convert a C @unsigned char@, representing a Latin-1 character, to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the corresponding Haskell character.</span></span><span class="mpre">
</span><a href="#loc_211_1_211_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_1_211_17&#39;)"><span class="mpre">castCUCharToChar</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CUChar</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">
</span><a name="loc_211_1_211_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_1_211_17&#39;)"><span class="hl_fundecl"><span class="mpre">castCUCharToChar</span></span></a><span class="mpre"> </span><a name="loc_211_18_211_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_18_211_20&#39;)"><span class="hl_vardecl"><span class="mpre">ch</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">unsafeChr</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_211_18_211_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_18_211_20&#39;)"><span class="hl_varref"><span class="mpre">ch</span></span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">))

</span><span class="hl_comment"><span class="mpre">-- | Convert a Haskell character to a C @unsigned char@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function is only safe on the first 256 characters.</span></span><span class="mpre">
</span><a href="#loc_216_1_216_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_1_216_17&#39;)"><span class="mpre">castCharToCUChar</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">CUChar</span></span><span class="mpre">
</span><a name="loc_216_1_216_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_1_216_17&#39;)"><span class="hl_fundecl"><span class="mpre">castCharToCUChar</span></span></a><span class="mpre"> </span><a name="loc_216_18_216_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_18_216_20&#39;)"><span class="hl_vardecl"><span class="mpre">ch</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">ord</span></span><span class="mpre"> </span><a href="#loc_216_18_216_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_18_216_20&#39;)"><span class="hl_varref"><span class="mpre">ch</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Convert a C @signed char@, representing a Latin-1 character, to the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- corresponding Haskell character.</span></span><span class="mpre">
</span><a href="#loc_221_1_221_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_1_221_17&#39;)"><span class="mpre">castCSCharToChar</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CSChar</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">
</span><a name="loc_221_1_221_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_1_221_17&#39;)"><span class="hl_fundecl"><span class="mpre">castCSCharToChar</span></span></a><span class="mpre"> </span><a name="loc_221_18_221_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_18_221_20&#39;)"><span class="hl_vardecl"><span class="mpre">ch</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">unsafeChr</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_221_18_221_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_18_221_20&#39;)"><span class="hl_varref"><span class="mpre">ch</span></span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">))

</span><span class="hl_comment"><span class="mpre">-- | Convert a Haskell character to a C @signed char@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function is only safe on the first 256 characters.</span></span><span class="mpre">
</span><a href="#loc_226_1_226_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_1_226_17&#39;)"><span class="mpre">castCharToCSChar</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">CSChar</span></span><span class="mpre">
</span><a name="loc_226_1_226_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_1_226_17&#39;)"><span class="hl_fundecl"><span class="mpre">castCharToCSChar</span></span></a><span class="mpre"> </span><a name="loc_226_18_226_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_18_226_20&#39;)"><span class="hl_vardecl"><span class="mpre">ch</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">ord</span></span><span class="mpre"> </span><a href="#loc_226_18_226_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_18_226_20&#39;)"><span class="hl_varref"><span class="mpre">ch</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Marshal a NUL terminated C string into a Haskell string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_231_1_231_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_13&#39;)"><span class="mpre">peekCAString</span></a><span class="mpre">    :: </span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">
</span><a name="loc_231_1_231_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_13&#39;)"><span class="hl_fundecl"><span class="mpre">peekCAString</span></span></a><span class="mpre"> </span><a name="loc_231_14_231_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_14_231_16&#39;)"><span class="hl_vardecl"><span class="mpre">cp</span></span></a><span class="mpre"> = do
  </span><a name="loc_232_3_232_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_232_3_232_4&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre"> &lt;- </span><a href="Foreign.Marshal.Array.html#loc_247_1_247_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_247_1_247_13&#39;)"><span class="hl_varref"><span class="mpre">lengthArray0</span></span></a><span class="mpre"> </span><a href="#loc_334_1_334_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_334_1_334_4&#39;)"><span class="hl_varref"><span class="mpre">nUL</span></span></a><span class="mpre"> </span><a href="#loc_231_14_231_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_14_231_16&#39;)"><span class="hl_varref"><span class="mpre">cp</span></span></a><span class="mpre">
  if </span><a href="#loc_232_3_232_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_232_3_232_4&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;&quot;</span></span><span class="mpre"> else </span><a href="#loc_235_5_235_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_5_235_9&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;&quot;</span></span><span class="mpre"> (</span><a href="#loc_232_3_232_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_232_3_232_4&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
  where
    </span><a name="loc_235_5_235_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_5_235_9&#39;)"><span class="hl_fundecl"><span class="mpre">loop</span></span></a><span class="mpre"> </span><a name="loc_235_10_235_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_10_235_11&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_235_12_235_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_12_235_13&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre"> = do
        </span><a name="loc_236_9_236_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_9_236_13&#39;)"><span class="hl_vardecl"><span class="mpre">xval</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">peekElemOff</span></span><span class="mpre"> </span><a href="#loc_231_14_231_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_14_231_16&#39;)"><span class="hl_varref"><span class="mpre">cp</span></span></a><span class="mpre"> </span><a href="#loc_235_12_235_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_12_235_13&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre">
        let </span><a name="loc_237_13_237_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_13_237_16&#39;)"><span class="hl_vardecl"><span class="mpre">val</span></span></a><span class="mpre"> = </span><a href="#loc_201_1_201_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_1_201_16&#39;)"><span class="hl_varref"><span class="mpre">castCCharToChar</span></span></a><span class="mpre"> </span><a href="#loc_236_9_236_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_9_236_13&#39;)"><span class="hl_varref"><span class="mpre">xval</span></span></a><span class="mpre">
        </span><a href="#loc_237_13_237_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_13_237_16&#39;)"><span class="hl_varref"><span class="mpre">val</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`seq`</span></span><span class="mpre"> if </span><a href="#loc_235_12_235_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_12_235_13&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_237_13_237_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_13_237_16&#39;)"><span class="hl_varref"><span class="mpre">val</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a href="#loc_235_10_235_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_10_235_11&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">) else </span><a href="#loc_235_5_235_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_5_235_9&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> (</span><a href="#loc_237_13_237_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_13_237_16&#39;)"><span class="hl_varref"><span class="mpre">val</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a href="#loc_235_10_235_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_10_235_11&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">) (</span><a href="#loc_235_12_235_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_235_12_235_13&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Marshal a C string with explicit length into a Haskell string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_243_1_243_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_1_243_16&#39;)"><span class="mpre">peekCAStringLen</span></a><span class="mpre">           :: </span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">
</span><a name="loc_243_1_243_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_1_243_16&#39;)"><span class="hl_fundecl"><span class="mpre">peekCAStringLen</span></span></a><span class="mpre"> (</span><a name="loc_243_18_243_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_18_243_20&#39;)"><span class="hl_vardecl"><span class="mpre">cp</span></span></a><span class="mpre">, </span><a name="loc_243_22_243_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_22_243_25&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre">) 
  | </span><a href="#loc_243_22_243_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_22_243_25&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">  = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;&quot;</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- being (too?) nice.</span></span><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = </span><a href="#loc_247_5_247_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_5_247_9&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> [] (</span><a href="#loc_243_22_243_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_22_243_25&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
  where
    </span><a name="loc_247_5_247_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_5_247_9&#39;)"><span class="hl_fundecl"><span class="mpre">loop</span></span></a><span class="mpre"> </span><a name="loc_247_10_247_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_10_247_13&#39;)"><span class="hl_vardecl"><span class="mpre">acc</span></span></a><span class="mpre"> </span><a name="loc_247_14_247_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_14_247_15&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre"> = do
         </span><a name="loc_248_10_248_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_10_248_14&#39;)"><span class="hl_vardecl"><span class="mpre">xval</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">peekElemOff</span></span><span class="mpre"> </span><a href="#loc_243_18_243_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_18_243_20&#39;)"><span class="hl_varref"><span class="mpre">cp</span></span></a><span class="mpre"> </span><a href="#loc_247_14_247_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_14_247_15&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre">
         let </span><a name="loc_249_14_249_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_14_249_17&#39;)"><span class="hl_vardecl"><span class="mpre">val</span></span></a><span class="mpre"> = </span><a href="#loc_201_1_201_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_1_201_16&#39;)"><span class="hl_varref"><span class="mpre">castCCharToChar</span></span></a><span class="mpre"> </span><a href="#loc_248_10_248_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_10_248_14&#39;)"><span class="hl_varref"><span class="mpre">xval</span></span></a><span class="mpre">
           </span><span class="hl_comment"><span class="mpre">-- blow away the coercion ASAP.</span></span><span class="mpre">
         if (</span><a href="#loc_249_14_249_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_14_249_17&#39;)"><span class="hl_varref"><span class="mpre">val</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`seq`</span></span><span class="mpre"> (</span><a href="#loc_247_14_247_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_14_247_15&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">))
          then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_249_14_249_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_14_249_17&#39;)"><span class="hl_varref"><span class="mpre">val</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a href="#loc_247_10_247_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_10_247_13&#39;)"><span class="hl_varref"><span class="mpre">acc</span></span></a><span class="mpre">)
          else </span><a href="#loc_247_5_247_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_5_247_9&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> (</span><a href="#loc_249_14_249_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_14_249_17&#39;)"><span class="hl_varref"><span class="mpre">val</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a href="#loc_247_10_247_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_10_247_13&#39;)"><span class="hl_varref"><span class="mpre">acc</span></span></a><span class="mpre">) (</span><a href="#loc_247_14_247_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_14_247_15&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a NUL terminated C string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the Haskell string may /not/ contain any NUL characters</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * new storage is allocated for the C string and must be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   explicitly freed using &#39;Foreign.Marshal.Alloc.free&#39; or</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;Foreign.Marshal.Alloc.finalizerFree&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_264_1_264_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_264_1_264_12&#39;)"><span class="mpre">newCAString</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre">
</span><a name="loc_264_1_264_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_264_1_264_12&#39;)"><span class="hl_fundecl"><span class="mpre">newCAString</span></span></a><span class="mpre"> </span><a name="loc_264_13_264_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_264_13_264_16&#39;)"><span class="hl_vardecl"><span class="mpre">str</span></span></a><span class="mpre"> = do
  </span><a name="loc_265_3_265_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_3_265_6&#39;)"><span class="hl_vardecl"><span class="mpre">ptr</span></span></a><span class="mpre"> &lt;- </span><a href="Foreign.Marshal.Array.html#loc_92_1_92_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_92_1_92_13&#39;)"><span class="hl_varref"><span class="mpre">mallocArray0</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">length</span></span><span class="mpre"> </span><a href="#loc_264_13_264_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_264_13_264_16&#39;)"><span class="hl_varref"><span class="mpre">str</span></span></a><span class="mpre">)
  let
        </span><a name="loc_267_9_267_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_9_267_11&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> [] </span><a name="loc_267_15_267_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_15_267_16&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre">     = </span><span class="hl_varref"><span class="mpre">pokeElemOff</span></span><span class="mpre"> </span><a href="#loc_265_3_265_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_3_265_6&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre"> </span><a href="#loc_267_15_267_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_15_267_16&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><a href="#loc_334_1_334_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_334_1_334_4&#39;)"><span class="hl_varref"><span class="mpre">nUL</span></span></a><span class="mpre">
        </span><a href="#loc_267_9_267_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_9_267_11&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a name="loc_268_13_268_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_13_268_14&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_268_15_268_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_15_268_17&#39;)"><span class="hl_vardecl"><span class="mpre">cs</span></span></a><span class="mpre">) </span><a name="loc_268_19_268_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_19_268_20&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> = do </span><span class="hl_varref"><span class="mpre">pokeElemOff</span></span><span class="mpre"> </span><a href="#loc_265_3_265_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_3_265_6&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre"> </span><a href="#loc_268_19_268_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_19_268_20&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> (</span><a href="#loc_206_1_206_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_1_206_16&#39;)"><span class="hl_varref"><span class="mpre">castCharToCChar</span></span></a><span class="mpre"> </span><a href="#loc_268_13_268_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_13_268_14&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">); </span><a href="#loc_267_9_267_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_9_267_11&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_268_15_268_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_15_268_17&#39;)"><span class="hl_varref"><span class="mpre">cs</span></span></a><span class="mpre"> (</span><a href="#loc_268_19_268_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_19_268_20&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
  </span><a href="#loc_267_9_267_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_9_267_11&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_264_13_264_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_264_13_264_16&#39;)"><span class="hl_varref"><span class="mpre">str</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_265_3_265_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_3_265_6&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a C string (ie, character array) with</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- explicit length information.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * new storage is allocated for the C string and must be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   explicitly freed using &#39;Foreign.Marshal.Alloc.free&#39; or</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;Foreign.Marshal.Alloc.finalizerFree&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_280_1_280_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_280_1_280_15&#39;)"><span class="mpre">newCAStringLen</span></a><span class="mpre">     :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre">
</span><a name="loc_280_1_280_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_280_1_280_15&#39;)"><span class="hl_fundecl"><span class="mpre">newCAStringLen</span></span></a><span class="mpre"> </span><a name="loc_280_16_280_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_280_16_280_19&#39;)"><span class="hl_vardecl"><span class="mpre">str</span></span></a><span class="mpre"> = do
  </span><a name="loc_281_3_281_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_281_3_281_6&#39;)"><span class="hl_vardecl"><span class="mpre">ptr</span></span></a><span class="mpre"> &lt;- </span><a href="Foreign.Marshal.Array.html#loc_92_1_92_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_92_1_92_13&#39;)"><span class="hl_varref"><span class="mpre">mallocArray0</span></span></a><span class="mpre"> </span><a href="#loc_288_5_288_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_288_5_288_8&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">
  let
        </span><a name="loc_283_9_283_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_9_283_11&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> [] </span><a name="loc_283_15_283_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_15_283_16&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre">     = </span><a href="#loc_283_15_283_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_15_283_16&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`seq`</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- make it strict in n</span></span><span class="mpre">
        </span><a href="#loc_283_9_283_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_9_283_11&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a name="loc_284_13_284_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_13_284_14&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_284_15_284_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_15_284_17&#39;)"><span class="hl_vardecl"><span class="mpre">cs</span></span></a><span class="mpre">) </span><a name="loc_284_19_284_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_19_284_20&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> = do </span><span class="hl_varref"><span class="mpre">pokeElemOff</span></span><span class="mpre"> </span><a href="#loc_281_3_281_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_281_3_281_6&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre"> </span><a href="#loc_284_19_284_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_19_284_20&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> (</span><a href="#loc_206_1_206_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_1_206_16&#39;)"><span class="hl_varref"><span class="mpre">castCharToCChar</span></span></a><span class="mpre"> </span><a href="#loc_284_13_284_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_13_284_14&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">); </span><a href="#loc_283_9_283_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_9_283_11&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_284_15_284_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_15_284_17&#39;)"><span class="hl_varref"><span class="mpre">cs</span></span></a><span class="mpre"> (</span><a href="#loc_284_19_284_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_19_284_20&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
  </span><a href="#loc_283_9_283_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_9_283_11&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_280_16_280_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_280_16_280_19&#39;)"><span class="hl_varref"><span class="mpre">str</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_281_3_281_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_281_3_281_6&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre">, </span><a href="#loc_288_5_288_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_288_5_288_8&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">)
  where
    </span><a name="loc_288_5_288_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_288_5_288_8&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">length</span></span><span class="mpre"> </span><a href="#loc_280_16_280_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_280_16_280_19&#39;)"><span class="hl_varref"><span class="mpre">str</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a NUL terminated C string using temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- storage.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the Haskell string may /not/ contain any NUL characters</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the memory is freed when the subcomputation terminates (either</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   normally or via an exception), so the pointer to the temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   storage must /not/ be used after this.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_300_1_300_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_1_300_13&#39;)"><span class="mpre">withCAString</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_300_1_300_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_1_300_13&#39;)"><span class="hl_fundecl"><span class="mpre">withCAString</span></span></a><span class="mpre"> </span><a name="loc_300_14_300_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_14_300_17&#39;)"><span class="hl_vardecl"><span class="mpre">str</span></span></a><span class="mpre"> </span><a name="loc_300_18_300_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_18_300_19&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> =
  </span><a href="Foreign.Marshal.Array.html#loc_108_1_108_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_108_1_108_13&#39;)"><span class="hl_varref"><span class="mpre">allocaArray0</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">length</span></span><span class="mpre"> </span><a href="#loc_300_14_300_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_14_300_17&#39;)"><span class="hl_varref"><span class="mpre">str</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_301_32_301_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_32_301_35&#39;)"><span class="hl_vardecl"><span class="mpre">ptr</span></span></a><span class="mpre"> -&gt;
      let
        </span><a name="loc_303_9_303_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_303_9_303_11&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> [] </span><a name="loc_303_15_303_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_303_15_303_16&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre">     = </span><span class="hl_varref"><span class="mpre">pokeElemOff</span></span><span class="mpre"> </span><a href="#loc_301_32_301_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_32_301_35&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre"> </span><a href="#loc_303_15_303_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_303_15_303_16&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><a href="#loc_334_1_334_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_334_1_334_4&#39;)"><span class="hl_varref"><span class="mpre">nUL</span></span></a><span class="mpre">
        </span><a href="#loc_303_9_303_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_303_9_303_11&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a name="loc_304_13_304_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_304_13_304_14&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_304_15_304_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_304_15_304_17&#39;)"><span class="hl_vardecl"><span class="mpre">cs</span></span></a><span class="mpre">) </span><a name="loc_304_19_304_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_304_19_304_20&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> = do </span><span class="hl_varref"><span class="mpre">pokeElemOff</span></span><span class="mpre"> </span><a href="#loc_301_32_301_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_32_301_35&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre"> </span><a href="#loc_304_19_304_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_304_19_304_20&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> (</span><a href="#loc_206_1_206_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_1_206_16&#39;)"><span class="hl_varref"><span class="mpre">castCharToCChar</span></span></a><span class="mpre"> </span><a href="#loc_304_13_304_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_304_13_304_14&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">); </span><a href="#loc_303_9_303_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_303_9_303_11&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_304_15_304_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_304_15_304_17&#39;)"><span class="hl_varref"><span class="mpre">cs</span></span></a><span class="mpre"> (</span><a href="#loc_304_19_304_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_304_19_304_20&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
      in do
      </span><a href="#loc_303_9_303_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_303_9_303_11&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_300_14_300_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_14_300_17&#39;)"><span class="hl_varref"><span class="mpre">str</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
      </span><a href="#loc_300_18_300_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_18_300_19&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_301_32_301_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_32_301_35&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a C string (ie, character array)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- in temporary storage, with explicit length information.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the memory is freed when the subcomputation terminates (either</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   normally or via an exception), so the pointer to the temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   storage must /not/ be used after this.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_317_1_317_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_1_317_16&#39;)"><span class="mpre">withCAStringLen</span></a><span class="mpre">         :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_317_1_317_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_1_317_16&#39;)"><span class="hl_fundecl"><span class="mpre">withCAStringLen</span></span></a><span class="mpre"> </span><a name="loc_317_17_317_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_17_317_20&#39;)"><span class="hl_vardecl"><span class="mpre">str</span></span></a><span class="mpre"> </span><a name="loc_317_21_317_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_21_317_22&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre">    =
  </span><a href="Foreign.Marshal.Array.html#loc_98_1_98_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_98_1_98_12&#39;)"><span class="hl_varref"><span class="mpre">allocaArray</span></span></a><span class="mpre"> </span><a href="#loc_326_5_326_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_326_5_326_8&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_318_22_318_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_318_22_318_25&#39;)"><span class="hl_vardecl"><span class="mpre">ptr</span></span></a><span class="mpre"> -&gt;
      let
        </span><a name="loc_320_9_320_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_9_320_11&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> [] </span><a name="loc_320_15_320_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_15_320_16&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre">     = </span><a href="#loc_320_15_320_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_15_320_16&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`seq`</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- make it strict in n</span></span><span class="mpre">
        </span><a href="#loc_320_9_320_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_9_320_11&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a name="loc_321_13_321_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_321_13_321_14&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_321_15_321_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_321_15_321_17&#39;)"><span class="hl_vardecl"><span class="mpre">cs</span></span></a><span class="mpre">) </span><a name="loc_321_19_321_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_321_19_321_20&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> = do </span><span class="hl_varref"><span class="mpre">pokeElemOff</span></span><span class="mpre"> </span><a href="#loc_318_22_318_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_318_22_318_25&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre"> </span><a href="#loc_321_19_321_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_321_19_321_20&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> (</span><a href="#loc_206_1_206_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_1_206_16&#39;)"><span class="hl_varref"><span class="mpre">castCharToCChar</span></span></a><span class="mpre"> </span><a href="#loc_321_13_321_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_321_13_321_14&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">); </span><a href="#loc_320_9_320_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_9_320_11&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_321_15_321_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_321_15_321_17&#39;)"><span class="hl_varref"><span class="mpre">cs</span></span></a><span class="mpre"> (</span><a href="#loc_321_19_321_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_321_19_321_20&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
      in do
      </span><a href="#loc_320_9_320_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_9_320_11&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_317_17_317_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_17_317_20&#39;)"><span class="hl_varref"><span class="mpre">str</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
      </span><a href="#loc_317_21_317_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_21_317_22&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> (</span><a href="#loc_318_22_318_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_318_22_318_25&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre">,</span><a href="#loc_326_5_326_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_326_5_326_8&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">)
  where
    </span><a name="loc_326_5_326_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_326_5_326_8&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">length</span></span><span class="mpre"> </span><a href="#loc_317_17_317_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_17_317_20&#39;)"><span class="hl_varref"><span class="mpre">str</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- auxiliary definitions</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ----------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- C&#39;s end of string character</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_334_1_334_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_334_1_334_4&#39;)"><span class="mpre">nUL</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CChar</span></span><span class="mpre">
</span><a name="loc_334_1_334_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_334_1_334_4&#39;)"><span class="hl_vardecl"><span class="mpre">nUL</span></span></a><span class="mpre">  = </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- allocate an array to hold the list and pair it with the number of elements</span></span><span class="mpre">
</span><a href="#loc_338_1_338_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_1_338_12&#39;)"><span class="mpre">newArrayLen</span></a><span class="mpre">        :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 337, srcSpanStartColumn = 23, srcSpanEndLine = 337, srcSpanEndColumn = 36}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 337, srcSpanStartColumn = 34, srcSpanEndLine = 337, srcSpanEndColumn = 36}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/For"><span class="mpre">Storable a =&gt;</span></span><span class="mpre"> [</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">] -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">, </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">)
</span><a name="loc_338_1_338_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_1_338_12&#39;)"><span class="hl_fundecl"><span class="mpre">newArrayLen</span></span></a><span class="mpre"> </span><a name="loc_338_13_338_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_13_338_15&#39;)"><span class="hl_vardecl"><span class="mpre">xs</span></span></a><span class="mpre">      = do
  </span><a name="loc_339_3_339_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_3_339_4&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> &lt;- </span><a href="Foreign.Marshal.Array.html#loc_170_1_170_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_170_1_170_9&#39;)"><span class="hl_varref"><span class="mpre">newArray</span></span></a><span class="mpre"> </span><a href="#loc_338_13_338_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_13_338_15&#39;)"><span class="hl_varref"><span class="mpre">xs</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_339_3_339_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_3_339_4&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">, </span><span class="hl_varref"><span class="mpre">length</span></span><span class="mpre"> </span><a href="#loc_338_13_338_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_13_338_15&#39;)"><span class="hl_varref"><span class="mpre">xs</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Wide strings</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- representation of wide strings in C</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- -----------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A C wide string is a reference to an array of C wide characters</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- terminated by NUL.</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 350, srcSpanStartColumn = 1, srcSpanEndLine = 350, srcSpanEndColumn = 30}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 350, srcSpanStartColumn = 1, srcSpanEndLine = 350, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 350,"><span class="mpre">type CWString    = Ptr CWchar</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A wide character string with explicit length information in &#39;CWchar&#39;s</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- instead of a terminating NUL (allowing NUL characters in the middle</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- of the string).</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 355, srcSpanStartColumn = 1, srcSpanEndLine = 355, srcSpanEndColumn = 37}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 355, srcSpanStartColumn = 1, srcSpanEndLine = 355, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/Foreign/C/String.hs&quot;, srcSpanStartLine = 355,"><span class="mpre">type CWStringLen = (Ptr CWchar, Int)</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a NUL terminated C wide string into a Haskell string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_360_1_360_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_360_1_360_13&#39;)"><span class="mpre">peekCWString</span></a><span class="mpre">    :: </span><span class="hl_tyconref"><span class="mpre">CWString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">
</span><a name="loc_360_1_360_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_360_1_360_13&#39;)"><span class="hl_fundecl"><span class="mpre">peekCWString</span></span></a><span class="mpre"> </span><a name="loc_360_14_360_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_360_14_360_16&#39;)"><span class="hl_vardecl"><span class="mpre">cp</span></span></a><span class="mpre">  = do
  </span><a name="loc_361_3_361_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_361_3_361_5&#39;)"><span class="hl_vardecl"><span class="mpre">cs</span></span></a><span class="mpre"> &lt;- </span><a href="Foreign.Marshal.Array.html#loc_143_1_143_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_143_1_143_11&#39;)"><span class="hl_varref"><span class="mpre">peekArray0</span></span></a><span class="mpre"> </span><a href="#loc_420_1_420_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_420_1_420_5&#39;)"><span class="hl_varref"><span class="mpre">wNUL</span></span></a><span class="mpre"> </span><a href="#loc_360_14_360_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_360_14_360_16&#39;)"><span class="hl_varref"><span class="mpre">cp</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_430_1_430_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_430_1_430_15&#39;)"><span class="hl_varref"><span class="mpre">cWcharsToChars</span></span></a><span class="mpre"> </span><a href="#loc_361_3_361_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_361_3_361_5&#39;)"><span class="hl_varref"><span class="mpre">cs</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Marshal a C wide string with explicit length into a Haskell string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_367_1_367_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_1_367_16&#39;)"><span class="mpre">peekCWStringLen</span></a><span class="mpre">           :: </span><span class="hl_tyconref"><span class="mpre">CWStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">
</span><a name="loc_367_1_367_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_1_367_16&#39;)"><span class="hl_fundecl"><span class="mpre">peekCWStringLen</span></span></a><span class="mpre"> (</span><a name="loc_367_18_367_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_18_367_20&#39;)"><span class="hl_vardecl"><span class="mpre">cp</span></span></a><span class="mpre">, </span><a name="loc_367_22_367_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_22_367_25&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre">)  = do
  </span><a name="loc_368_3_368_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_3_368_5&#39;)"><span class="hl_vardecl"><span class="mpre">cs</span></span></a><span class="mpre"> &lt;- </span><a href="Foreign.Marshal.Array.html#loc_134_1_134_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_134_1_134_10&#39;)"><span class="hl_varref"><span class="mpre">peekArray</span></span></a><span class="mpre"> </span><a href="#loc_367_22_367_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_22_367_25&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> </span><a href="#loc_367_18_367_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_18_367_20&#39;)"><span class="hl_varref"><span class="mpre">cp</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_430_1_430_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_430_1_430_15&#39;)"><span class="hl_varref"><span class="mpre">cWcharsToChars</span></span></a><span class="mpre"> </span><a href="#loc_368_3_368_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_3_368_5&#39;)"><span class="hl_varref"><span class="mpre">cs</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a NUL terminated C wide string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the Haskell string may /not/ contain any NUL characters</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * new storage is allocated for the C wide string and must</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   be explicitly freed using &#39;Foreign.Marshal.Alloc.free&#39; or</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;Foreign.Marshal.Alloc.finalizerFree&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_380_1_380_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_380_1_380_12&#39;)"><span class="mpre">newCWString</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">CWString</span></span><span class="mpre">
</span><a name="loc_380_1_380_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_380_1_380_12&#39;)"><span class="hl_vardecl"><span class="mpre">newCWString</span></span></a><span class="mpre">  = </span><a href="Foreign.Marshal.Array.html#loc_179_1_179_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_179_1_179_10&#39;)"><span class="hl_varref"><span class="mpre">newArray0</span></span></a><span class="mpre"> </span><a href="#loc_420_1_420_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_420_1_420_5&#39;)"><span class="hl_varref"><span class="mpre">wNUL</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_438_1_438_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_438_1_438_15&#39;)"><span class="hl_varref"><span class="mpre">charsToCWchars</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a C wide string (ie, wide character array)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- with explicit length information.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * new storage is allocated for the C wide string and must</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   be explicitly freed using &#39;Foreign.Marshal.Alloc.free&#39; or</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;Foreign.Marshal.Alloc.finalizerFree&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_390_1_390_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_390_1_390_15&#39;)"><span class="mpre">newCWStringLen</span></a><span class="mpre">     :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">CWStringLen</span></span><span class="mpre">
</span><a name="loc_390_1_390_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_390_1_390_15&#39;)"><span class="hl_fundecl"><span class="mpre">newCWStringLen</span></span></a><span class="mpre"> </span><a name="loc_390_16_390_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_390_16_390_19&#39;)"><span class="hl_vardecl"><span class="mpre">str</span></span></a><span class="mpre">  = </span><a href="#loc_338_1_338_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_1_338_12&#39;)"><span class="hl_varref"><span class="mpre">newArrayLen</span></span></a><span class="mpre"> (</span><a href="#loc_438_1_438_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_438_1_438_15&#39;)"><span class="hl_varref"><span class="mpre">charsToCWchars</span></span></a><span class="mpre"> </span><a href="#loc_390_16_390_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_390_16_390_19&#39;)"><span class="hl_varref"><span class="mpre">str</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a NUL terminated C wide string using</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- temporary storage.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the Haskell string may /not/ contain any NUL characters</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the memory is freed when the subcomputation terminates (either</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   normally or via an exception), so the pointer to the temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   storage must /not/ be used after this.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_402_1_402_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_1_402_13&#39;)"><span class="mpre">withCWString</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">CWString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_402_1_402_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_1_402_13&#39;)"><span class="hl_vardecl"><span class="mpre">withCWString</span></span></a><span class="mpre">  = </span><a href="Foreign.Marshal.Array.html#loc_205_1_205_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_205_1_205_11&#39;)"><span class="hl_varref"><span class="mpre">withArray0</span></span></a><span class="mpre"> </span><a href="#loc_420_1_420_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_420_1_420_5&#39;)"><span class="hl_varref"><span class="mpre">wNUL</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_438_1_438_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_438_1_438_15&#39;)"><span class="hl_varref"><span class="mpre">charsToCWchars</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a C wide string (i.e. wide</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- character array) in temporary storage, with explicit length</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- information.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the memory is freed when the subcomputation terminates (either</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   normally or via an exception), so the pointer to the temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   storage must /not/ be used after this.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_413_1_413_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_413_1_413_16&#39;)"><span class="mpre">withCWStringLen</span></a><span class="mpre">         :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">CWStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_413_1_413_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_413_1_413_16&#39;)"><span class="hl_fundecl"><span class="mpre">withCWStringLen</span></span></a><span class="mpre"> </span><a name="loc_413_17_413_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_413_17_413_20&#39;)"><span class="hl_vardecl"><span class="mpre">str</span></span></a><span class="mpre"> </span><a name="loc_413_21_413_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_413_21_413_22&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre">    =
  </span><a href="Foreign.Marshal.Array.html#loc_194_1_194_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_194_1_194_13&#39;)"><span class="hl_varref"><span class="mpre">withArrayLen</span></span></a><span class="mpre"> (</span><a href="#loc_438_1_438_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_438_1_438_15&#39;)"><span class="hl_varref"><span class="mpre">charsToCWchars</span></span></a><span class="mpre"> </span><a href="#loc_413_17_413_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_413_17_413_20&#39;)"><span class="hl_varref"><span class="mpre">str</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \ </span><a name="loc_414_41_414_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_414_41_414_44&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre"> </span><a name="loc_414_45_414_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_414_45_414_48&#39;)"><span class="hl_vardecl"><span class="mpre">ptr</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_413_21_413_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_413_21_413_22&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> (</span><a href="#loc_414_45_414_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_414_45_414_48&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre">, </span><a href="#loc_414_41_414_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_414_41_414_44&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- auxiliary definitions</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ----------------------</span></span><span class="mpre">

</span><a href="#loc_420_1_420_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_420_1_420_5&#39;)"><span class="mpre">wNUL</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CWchar</span></span><span class="mpre">
</span><a name="loc_420_1_420_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_420_1_420_5&#39;)"><span class="hl_vardecl"><span class="mpre">wNUL</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">

</span><a href="#loc_430_1_430_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_430_1_430_15&#39;)"><span class="mpre">cWcharsToChars</span></a><span class="mpre"> :: [</span><span class="hl_tyconref"><span class="mpre">CWchar</span></span><span class="mpre">] -&gt; [</span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">]
</span><a href="#loc_438_1_438_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_438_1_438_15&#39;)"><span class="mpre">charsToCWchars</span></a><span class="mpre"> :: [</span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">] -&gt; [</span><span class="hl_tyconref"><span class="mpre">CWchar</span></span><span class="mpre">]

#ifdef mingw32_HOST_OS

</span><span class="hl_comment"><span class="mpre">-- On Windows, wchar_t is 16 bits wide and CWString uses the UTF-16 encoding.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- coding errors generate Chars in the surrogate range</span></span><span class="mpre">
</span><a name="loc_430_1_430_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_430_1_430_15&#39;)"><span class="hl_vardecl"><span class="mpre">cWcharsToChars</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><a href="GHC.Char.html#loc_11_1_11_4" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Char.html#loc_11_1_11_4&#39;)"><span class="hl_varref"><span class="mpre">chr</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_432_3_432_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_3_432_12&#39;)"><span class="hl_varref"><span class="mpre">fromUTF16</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre">
 where
  </span><a name="loc_432_3_432_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_3_432_12&#39;)"><span class="hl_fundecl"><span class="mpre">fromUTF16</span></span></a><span class="mpre"> (</span><a name="loc_432_14_432_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_14_432_16&#39;)"><span class="hl_vardecl"><span class="mpre">c1</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_432_17_432_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_17_432_19&#39;)"><span class="hl_vardecl"><span class="mpre">c2</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_432_20_432_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_20_432_23&#39;)"><span class="hl_vardecl"><span class="mpre">wcs</span></span></a><span class="mpre">)
    | </span><span class="hl_num"><span class="mpre">0xd800</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_432_14_432_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_14_432_16&#39;)"><span class="hl_varref"><span class="mpre">c1</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_432_14_432_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_14_432_16&#39;)"><span class="hl_varref"><span class="mpre">c1</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xdbff</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xdc00</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_432_17_432_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_17_432_19&#39;)"><span class="hl_varref"><span class="mpre">c2</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_432_17_432_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_17_432_19&#39;)"><span class="hl_varref"><span class="mpre">c2</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xdfff</span></span><span class="mpre"> =
      ((</span><a href="#loc_432_14_432_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_14_432_16&#39;)"><span class="hl_varref"><span class="mpre">c1</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xd800</span></span><span class="mpre">)</span><span class="hl_infix"><span class="mpre">*</span></span><span class="hl_num"><span class="mpre">0x400</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> (</span><a href="#loc_432_17_432_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_17_432_19&#39;)"><span class="hl_varref"><span class="mpre">c2</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xdc00</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0x10000</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a href="#loc_432_3_432_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_3_432_12&#39;)"><span class="hl_varref"><span class="mpre">fromUTF16</span></span></a><span class="mpre"> </span><a href="#loc_432_20_432_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_20_432_23&#39;)"><span class="hl_varref"><span class="mpre">wcs</span></span></a><span class="mpre">
  </span><a href="#loc_432_3_432_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_3_432_12&#39;)"><span class="hl_fundecl"><span class="mpre">fromUTF16</span></span></a><span class="mpre"> (</span><a name="loc_435_14_435_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_435_14_435_15&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_435_16_435_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_435_16_435_19&#39;)"><span class="hl_vardecl"><span class="mpre">wcs</span></span></a><span class="mpre">) = </span><a href="#loc_435_14_435_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_435_14_435_15&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a href="#loc_432_3_432_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_3_432_12&#39;)"><span class="hl_varref"><span class="mpre">fromUTF16</span></span></a><span class="mpre"> </span><a href="#loc_435_16_435_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_435_16_435_19&#39;)"><span class="hl_varref"><span class="mpre">wcs</span></span></a><span class="mpre">
  </span><a href="#loc_432_3_432_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_3_432_12&#39;)"><span class="hl_fundecl"><span class="mpre">fromUTF16</span></span></a><span class="mpre"> [] = []

</span><a name="loc_438_1_438_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_438_1_438_15&#39;)"><span class="hl_vardecl"><span class="mpre">charsToCWchars</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">foldr</span></span><span class="mpre"> </span><a href="#loc_440_3_440_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_440_3_440_12&#39;)"><span class="hl_varref"><span class="mpre">utf16Char</span></span></a><span class="mpre"> [] </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">ord</span></span><span class="mpre">
 where
  </span><a name="loc_440_3_440_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_440_3_440_12&#39;)"><span class="hl_fundecl"><span class="mpre">utf16Char</span></span></a><span class="mpre"> </span><a name="loc_440_13_440_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_440_13_440_14&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre"> </span><a name="loc_440_15_440_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_440_15_440_18&#39;)"><span class="hl_vardecl"><span class="mpre">wcs</span></span></a><span class="mpre">
    | </span><a href="#loc_440_13_440_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_440_13_440_14&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0x10000</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_440_13_440_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_440_13_440_14&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a href="#loc_440_15_440_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_440_15_440_18&#39;)"><span class="hl_varref"><span class="mpre">wcs</span></span></a><span class="mpre">
    | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">   = let </span><a name="loc_442_25_442_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_442_25_442_27&#39;)"><span class="hl_vardecl"><span class="mpre">c&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_440_13_440_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_440_13_440_14&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0x10000</span></span><span class="mpre"> in
                    </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> (</span><a href="#loc_442_25_442_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_442_25_442_27&#39;)"><span class="hl_varref"><span class="mpre">c&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`div`</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0x400</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xd800</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre">
                    </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> (</span><a href="#loc_442_25_442_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_442_25_442_27&#39;)"><span class="hl_varref"><span class="mpre">c&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`mod`</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0x400</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xdc00</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a href="#loc_440_15_440_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_440_15_440_18&#39;)"><span class="hl_varref"><span class="mpre">wcs</span></span></a><span class="mpre">

#else /* !mingw32_HOST_OS */

</span><span class="hl_fundecl"><span class="mpre">cWcharsToChars</span></span><span class="mpre"> </span><a name="loc_448_16_448_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_448_16_448_18&#39;)"><span class="hl_vardecl"><span class="mpre">xs</span></span></a><span class="mpre">  = </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><a href="#loc_455_1_455_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_455_1_455_17&#39;)"><span class="hl_varref"><span class="mpre">castCWcharToChar</span></span></a><span class="mpre"> </span><a href="#loc_448_16_448_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_448_16_448_18&#39;)"><span class="hl_varref"><span class="mpre">xs</span></span></a><span class="mpre">
</span><span class="hl_fundecl"><span class="mpre">charsToCWchars</span></span><span class="mpre"> </span><a name="loc_449_16_449_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_449_16_449_18&#39;)"><span class="hl_vardecl"><span class="mpre">xs</span></span></a><span class="mpre">  = </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><a href="#loc_458_1_458_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_458_1_458_17&#39;)"><span class="hl_varref"><span class="mpre">castCharToCWchar</span></span></a><span class="mpre"> </span><a href="#loc_449_16_449_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_449_16_449_18&#39;)"><span class="hl_varref"><span class="mpre">xs</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- These conversions only make sense if __STDC_ISO_10646__ is defined</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- (meaning that wchar_t is ISO 10646, aka Unicode)</span></span><span class="mpre">

</span><a href="#loc_455_1_455_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_455_1_455_17&#39;)"><span class="mpre">castCWcharToChar</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CWchar</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">
</span><a name="loc_455_1_455_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_455_1_455_17&#39;)"><span class="hl_fundecl"><span class="mpre">castCWcharToChar</span></span></a><span class="mpre"> </span><a name="loc_455_18_455_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_455_18_455_20&#39;)"><span class="hl_vardecl"><span class="mpre">ch</span></span></a><span class="mpre"> = </span><a href="GHC.Char.html#loc_11_1_11_4" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Char.html#loc_11_1_11_4&#39;)"><span class="hl_varref"><span class="mpre">chr</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_455_18_455_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_455_18_455_20&#39;)"><span class="hl_varref"><span class="mpre">ch</span></span></a><span class="mpre"> )

</span><a href="#loc_458_1_458_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_458_1_458_17&#39;)"><span class="mpre">castCharToCWchar</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">CWchar</span></span><span class="mpre">
</span><a name="loc_458_1_458_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_458_1_458_17&#39;)"><span class="hl_fundecl"><span class="mpre">castCharToCWchar</span></span></a><span class="mpre"> </span><a name="loc_458_18_458_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_458_18_458_20&#39;)"><span class="hl_vardecl"><span class="mpre">ch</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">ord</span></span><span class="mpre"> </span><a href="#loc_458_18_458_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_458_18_458_20&#39;)"><span class="hl_varref"><span class="mpre">ch</span></span></a><span class="mpre">)

#endif /* !mingw32_HOST_OS */

</span></div></body></html>