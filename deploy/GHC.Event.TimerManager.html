<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE Trustworthy #-}
{-# LANGUAGE BangPatterns
           , CPP
           , ExistentialQuantification
           , NoImplicitPrelude
           , TypeSynonymInstances
           , FlexibleInstances
  #-}

module GHC.Event.TimerManager
    ( </span><span class="hl_comment"><span class="mpre">-- * Types</span></span><span class="mpre">
      TimerManager

      </span><span class="hl_comment"><span class="mpre">-- * Creation</span></span><span class="mpre">
    , new
    , newWith
    , newDefaultBackend

      </span><span class="hl_comment"><span class="mpre">-- * Running</span></span><span class="mpre">
    , finished
    , loop
    , step
    , shutdown
    , cleanup
    , wakeManager

      </span><span class="hl_comment"><span class="mpre">-- * Registering interest in timeout events</span></span><span class="mpre">
    , TimeoutCallback
    , TimeoutKey
    , registerTimeout
    , updateTimeout
    , unregisterTimeout
    ) where

#include &quot;EventConfig.h&quot;

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Imports</span></span><span class="mpre">

import Control.Exception (</span><a href="Control.Exception.Base.html#loc_273_3_273_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_273_3_273_12&#39;)"><span class="mpre">finally</span></a><span class="mpre">)
import Control.Monad (</span><a href="Control.Monad.html#loc_92_3_92_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_92_3_92_6&#39;)"><span class="mpre">(=&lt;&lt;)</span></a><span class="mpre">, </span><a href="Control.Monad.html#loc_274_1_274_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_274_1_274_6&#39;)"><span class="mpre">liftM</span></a><span class="mpre">, </span><a href="Control.Monad.html#loc_106_1_106_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_106_1_106_10&#39;)"><span class="mpre">sequence_</span></a><span class="mpre">, </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="mpre">when</span></a><span class="mpre">)
import Data.IORef (</span><a href="GHC.IORef.html#loc_34_9_34_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_34_9_34_14&#39;)"><span class="mpre">IORef</span></a><span class="mpre">, </span><a href="Data.IORef.html#loc_108_1_108_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.IORef.html#loc_108_1_108_19&#39;)"><span class="mpre">atomicModifyIORef&#39;</span></a><span class="mpre">, </span><a href="Data.IORef.html#loc_52_1_52_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.IORef.html#loc_52_1_52_12&#39;)"><span class="mpre">mkWeakIORef</span></a><span class="mpre">, </span><a href="GHC.IORef.html#loc_42_1_42_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_42_1_42_9&#39;)"><span class="mpre">newIORef</span></a><span class="mpre">, </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="mpre">readIORef</span></a><span class="mpre">,
                   </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="mpre">writeIORef</span></a><span class="mpre">)
import Data.Maybe (</span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="mpre">Maybe</span></a><span class="mpre">(..))
import Data.Monoid (</span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="mpre">mempty</span></a><span class="mpre">)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 46, srcSpanStartColumn = 8, srcSpanEndLine = 46, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Base&quot;"><span class="mpre">GHC.Base</span></span><span class="mpre">
import GHC.Conc.Signal (</span><a href="GHC.Conc.Signal.html#loc_63_1_63_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Conc.Signal.html#loc_63_1_63_12&#39;)"><span class="mpre">runHandlers</span></a><span class="mpre">)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 48, srcSpanStartColumn = 8, srcSpanEndLine = 48, srcSpanEndColumn = 15}, srcInfoPoints = []}) &quot;GHC.Num&quot;"><span class="mpre">GHC.Num</span></span><span class="mpre"> (Num(..))
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 49, srcSpanStartColumn = 8, srcSpanEndLine = 49, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Real&quot;"><span class="mpre">GHC.Real</span></span><span class="mpre"> ((/), fromIntegral )
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 50, srcSpanStartColumn = 8, srcSpanEndLine = 50, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Show&quot;"><span class="mpre">GHC.Show</span></span><span class="mpre"> (Show(..))
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 51, srcSpanStartColumn = 8, srcSpanEndLine = 51, srcSpanEndColumn = 23}, srcInfoPoints = []}) &quot;GHC.Event.Clock&quot;"><span class="mpre">GHC.Event.Clock</span></span><span class="mpre"> (getMonotonicTime)
import GHC.Event.Control
import GHC.Event.Internal (</span><a href="GHC.Event.Internal.html#loc_89_6_89_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_89_6_89_13&#39;)"><span class="mpre">Backend</span></a><span class="mpre">, </span><a href="GHC.Event.Internal.html#loc_37_9_37_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_37_9_37_14&#39;)"><span class="mpre">Event</span></a><span class="mpre">, </span><a href="GHC.Event.Internal.html#loc_46_1_46_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_46_1_46_8&#39;)"><span class="mpre">evtRead</span></a><span class="mpre">, </span><a href="GHC.Event.Internal.html#loc_84_6_84_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_84_6_84_13&#39;)"><span class="mpre">Timeout</span></a><span class="mpre">(..))
import GHC.Event.Unique (</span><a href="GHC.Event.Unique.html#loc_26_9_26_15" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Unique.html#loc_26_9_26_15&#39;)"><span class="mpre">Unique</span></a><span class="mpre">, </span><a href="GHC.Event.Unique.html#loc_24_9_24_21" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Unique.html#loc_24_9_24_21&#39;)"><span class="mpre">UniqueSource</span></a><span class="mpre">, </span><a href="GHC.Event.Unique.html#loc_33_1_33_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Unique.html#loc_33_1_33_10&#39;)"><span class="mpre">newSource</span></a><span class="mpre">, </span><a href="GHC.Event.Unique.html#loc_36_1_36_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Unique.html#loc_36_1_36_10&#39;)"><span class="mpre">newUnique</span></a><span class="mpre">)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 55, srcSpanStartColumn = 8, srcSpanEndLine = 55, srcSpanEndColumn = 26}, srcInfoPoints = []}) &quot;System.Posix.Types&quot;"><span class="mpre">System.Posix.Types</span></span><span class="mpre"> (Fd)

import qualified GHC.Event.Internal as I
import qualified GHC.Event.PSQ as Q

#if defined(HAVE_POLL)
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 61, srcSpanStartColumn = 18, srcSpanEndLine = 61, srcSpanEndColumn = 32}, srcInfoPoints = []}) &quot;GHC.Event.Poll&quot;"><span class="mpre">GHC.Event.Poll</span></span><span class="mpre">   as Poll
#else
# error not implemented for this operating system
#endif

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Types</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A timeout registration cookie.</span></span><span class="mpre">
newtype </span><a name="loc_70_9_70_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_9_70_19&#39;)"><span class="hl_tycondecl"><span class="mpre">TimeoutKey</span></span></a><span class="mpre">   = </span><a name="loc_70_24_70_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_24_70_26&#39;)"><span class="hl_condecl"><span class="mpre">TK</span></span></a><span class="mpre"> </span><a href="GHC.Event.Unique.html#loc_26_9_26_15" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Unique.html#loc_26_9_26_15&#39;)"><span class="hl_tyconref"><span class="mpre">Unique</span></span></a><span class="mpre">
    </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 71, srcSpanStartColumn = 5, srcSpanEndLine = 71, srcSpanEndColumn = 18}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 71, srcSpanStartColumn = 5, srcSpanEndLine = 71, srcSpanEndColumn = 13},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanS"><span class="mpre">deriving (Eq)</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Callback invoked on timeout events.</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 74, srcSpanStartColumn = 1, srcSpanEndLine = 74, srcSpanEndColumn = 29}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 74, srcSpanStartColumn = 1, srcSpanEndLine = 74, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanSt"><span class="mpre">type TimeoutCallback = IO ()</span></span><span class="mpre">

data </span><a name="loc_76_6_76_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_6_76_11&#39;)"><span class="hl_tycondecl"><span class="mpre">State</span></span></a><span class="mpre"> = </span><a name="loc_76_14_76_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_14_76_21&#39;)"><span class="hl_condecl"><span class="mpre">Created</span></span></a><span class="mpre">
           | </span><a name="loc_77_14_77_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_14_77_21&#39;)"><span class="hl_condecl"><span class="mpre">Running</span></span></a><span class="mpre">
           | </span><a name="loc_78_14_78_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_14_78_19&#39;)"><span class="hl_condecl"><span class="mpre">Dying</span></span></a><span class="mpre">
           | </span><a name="loc_79_14_79_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_14_79_22&#39;)"><span class="hl_condecl"><span class="mpre">Finished</span></span></a><span class="mpre">
             </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 80, srcSpanStartColumn = 14, srcSpanEndLine = 80, srcSpanEndColumn = 33}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 80, srcSpanStartColumn = 14, srcSpanEndLine = 80, srcSpanEndColumn = 22},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpa"><span class="mpre">deriving (Eq, Show)</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A priority search queue, with timeouts as priorities.</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 83, srcSpanStartColumn = 1, srcSpanEndLine = 83, srcSpanEndColumn = 42}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 83, srcSpanStartColumn = 1, srcSpanEndLine = 83, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanSt"><span class="mpre">type TimeoutQueue = Q.PSQ TimeoutCallback</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">{-
Instead of directly modifying the &#39;TimeoutQueue&#39; in
e.g. &#39;registerTimeout&#39; we keep a list of edits to perform, in the form
of a chain of function closures, and have the I/O manager thread
perform the edits later.  This exist to address the following GC
problem:

Since e.g. &#39;registerTimeout&#39; doesn&#39;t force the evaluation of the
thunks inside the &#39;emTimeouts&#39; IORef a number of thunks build up
inside the IORef.  If the I/O manager thread doesn&#39;t evaluate these
thunks soon enough they&#39;ll get promoted to the old generation and
become roots for all subsequent minor GCs.

When the thunks eventually get evaluated they will each create a new
intermediate &#39;TimeoutQueue&#39; that immediately becomes garbage.  Since
the thunks serve as roots until the next major GC these intermediate
&#39;TimeoutQueue&#39;s will get copied unnecesarily in the next minor GC,
increasing GC time.  This problem is known as &quot;floating garbage&quot;.

Keeping a list of edits doesn&#39;t stop this from happening but makes the
amount of data that gets copied smaller.

TODO: Evaluate the content of the IORef to WHNF on each insert once
this bug is resolved: http://hackage.haskell.org/trac/ghc/ticket/3838
-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | An edit to apply to a &#39;TimeoutQueue&#39;.</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 112, srcSpanStartColumn = 1, srcSpanEndLine = 112, srcSpanEndColumn = 48}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 112, srcSpanStartColumn = 1, srcSpanEndLine = 112, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSp"><span class="mpre">type TimeoutEdit = TimeoutQueue -&gt; TimeoutQueue</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The event manager state.</span></span><span class="mpre">
data </span><a name="loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tycondecl"><span class="mpre">TimerManager</span></span></a><span class="mpre"> = </span><span class="hl_condecl"><span class="mpre">TimerManager</span></span><span class="mpre">
    { </span><a name="loc_116_7_116_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_116_7_116_16&#39;)"><span class="hl_fielddecl"><span class="mpre">emBackend</span></span></a><span class="mpre">      :: !</span><a href="GHC.Event.Internal.html#loc_89_6_89_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_89_6_89_13&#39;)"><span class="hl_tyconref"><span class="mpre">Backend</span></span></a><span class="mpre">
    , </span><a name="loc_117_7_117_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_7_117_17&#39;)"><span class="hl_fielddecl"><span class="mpre">emTimeouts</span></span></a><span class="mpre">     :: {-# UNPACK #-} !(</span><a href="GHC.IORef.html#loc_34_9_34_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_34_9_34_14&#39;)"><span class="hl_tyconref"><span class="mpre">IORef</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">TimeoutQueue</span></span><span class="mpre">)
    , </span><a name="loc_118_7_118_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_7_118_14&#39;)"><span class="hl_fielddecl"><span class="mpre">emState</span></span></a><span class="mpre">        :: {-# UNPACK #-} !(</span><a href="GHC.IORef.html#loc_34_9_34_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_34_9_34_14&#39;)"><span class="hl_tyconref"><span class="mpre">IORef</span></span></a><span class="mpre"> </span><a href="#loc_76_6_76_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_6_76_11&#39;)"><span class="hl_tyconref"><span class="mpre">State</span></span></a><span class="mpre">)
    , </span><a name="loc_119_7_119_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_7_119_21&#39;)"><span class="hl_fielddecl"><span class="mpre">emUniqueSource</span></span></a><span class="mpre"> :: {-# UNPACK #-} !</span><a href="GHC.Event.Unique.html#loc_24_9_24_21" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Unique.html#loc_24_9_24_21&#39;)"><span class="hl_tyconref"><span class="mpre">UniqueSource</span></span></a><span class="mpre">
    , </span><a name="loc_120_7_120_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_7_120_16&#39;)"><span class="hl_fielddecl"><span class="mpre">emControl</span></span></a><span class="mpre">      :: {-# UNPACK #-} !</span><a href="GHC.Event.Control.html#loc_62_6_62_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_62_6_62_13&#39;)"><span class="hl_tyconref"><span class="mpre">Control</span></span></a><span class="mpre">
    }

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Creation</span></span><span class="mpre">

</span><a href="#loc_127_1_127_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_19&#39;)"><span class="mpre">handleControlEvent</span></a><span class="mpre"> :: </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Fd</span></span><span class="mpre"> -&gt; </span><a href="GHC.Event.Internal.html#loc_37_9_37_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_37_9_37_14&#39;)"><span class="hl_tyconref"><span class="mpre">Event</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_127_1_127_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_19&#39;)"><span class="hl_fundecl"><span class="mpre">handleControlEvent</span></span></a><span class="mpre"> </span><a name="loc_127_20_127_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_20_127_23&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> </span><a name="loc_127_24_127_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_24_127_26&#39;)"><span class="hl_vardecl"><span class="mpre">fd</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_evt</span></span><span class="mpre"> = do
  </span><a name="loc_128_3_128_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_128_3_128_6&#39;)"><span class="hl_vardecl"><span class="mpre">msg</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.Event.Control.html#loc_135_1_135_19" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_135_1_135_19&#39;)"><span class="hl_varref"><span class="mpre">readControlMessage</span></span></a><span class="mpre"> (</span><a href="#loc_120_7_120_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_7_120_16&#39;)"><span class="hl_varref"><span class="mpre">emControl</span></span></a><span class="mpre"> </span><a href="#loc_127_20_127_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_20_127_23&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">) </span><a href="#loc_127_24_127_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_24_127_26&#39;)"><span class="hl_varref"><span class="mpre">fd</span></span></a><span class="mpre">
  case </span><a href="#loc_128_3_128_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_128_3_128_6&#39;)"><span class="hl_varref"><span class="mpre">msg</span></span></a><span class="mpre"> of
    </span><a href="GHC.Event.Control.html#loc_55_23_55_33" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_55_23_55_33&#39;)"><span class="hl_conref"><span class="mpre">CMsgWakeup</span></span></a><span class="mpre">      -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
    </span><a href="GHC.Event.Control.html#loc_56_23_56_30" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_56_23_56_30&#39;)"><span class="hl_conref"><span class="mpre">CMsgDie</span></span></a><span class="mpre">         -&gt; </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> (</span><a href="#loc_118_7_118_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_7_118_14&#39;)"><span class="hl_varref"><span class="mpre">emState</span></span></a><span class="mpre"> </span><a href="#loc_127_20_127_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_20_127_23&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">) </span><a href="#loc_79_14_79_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_14_79_22&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre">
    </span><a href="GHC.Event.Control.html#loc_57_23_57_33" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_57_23_57_33&#39;)"><span class="hl_conref"><span class="mpre">CMsgSignal</span></span></a><span class="mpre"> </span><a name="loc_132_16_132_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_132_16_132_18&#39;)"><span class="hl_vardecl"><span class="mpre">fp</span></span></a><span class="mpre"> </span><a name="loc_132_19_132_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_132_19_132_20&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.Conc.Signal.html#loc_63_1_63_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Conc.Signal.html#loc_63_1_63_12&#39;)"><span class="hl_varref"><span class="mpre">runHandlers</span></span></a><span class="mpre"> </span><a href="#loc_132_16_132_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_132_16_132_18&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre"> </span><a href="#loc_132_19_132_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_132_19_132_20&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">

</span><a href="#loc_136_1_136_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_1_136_18&#39;)"><span class="mpre">newDefaultBackend</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="GHC.Event.Internal.html#loc_89_6_89_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_89_6_89_13&#39;)"><span class="hl_tyconref"><span class="mpre">Backend</span></span></a><span class="mpre">
#if defined(HAVE_POLL)
</span><a name="loc_136_1_136_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_1_136_18&#39;)"><span class="hl_vardecl"><span class="mpre">newDefaultBackend</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">Poll.new</span></span><span class="mpre">
#else
</span><span class="hl_vardecl"><span class="mpre">newDefaultBackend</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;no back end for this platform&quot;</span></span><span class="mpre">
#endif

</span><span class="hl_comment"><span class="mpre">-- | Create a new event manager.</span></span><span class="mpre">
</span><a href="#loc_143_1_143_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_143_1_143_4&#39;)"><span class="mpre">new</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre">
</span><a name="loc_143_1_143_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_143_1_143_4&#39;)"><span class="hl_vardecl"><span class="mpre">new</span></span></a><span class="mpre"> = </span><a href="#loc_146_1_146_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_1_146_8&#39;)"><span class="hl_varref"><span class="mpre">newWith</span></span></a><span class="mpre"> </span><a href="Control.Monad.html#loc_92_3_92_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_92_3_92_6&#39;)"><span class="hl_infix"><span class="mpre">=&lt;&lt;</span></span></a><span class="mpre"> </span><a href="#loc_136_1_136_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_1_136_18&#39;)"><span class="hl_varref"><span class="mpre">newDefaultBackend</span></span></a><span class="mpre">

</span><a href="#loc_146_1_146_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_1_146_8&#39;)"><span class="mpre">newWith</span></a><span class="mpre"> :: </span><a href="GHC.Event.Internal.html#loc_89_6_89_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_89_6_89_13&#39;)"><span class="hl_tyconref"><span class="mpre">Backend</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre">
</span><a name="loc_146_1_146_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_1_146_8&#39;)"><span class="hl_fundecl"><span class="mpre">newWith</span></span></a><span class="mpre"> </span><a name="loc_146_9_146_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_9_146_11&#39;)"><span class="hl_vardecl"><span class="mpre">be</span></span></a><span class="mpre"> = do
  </span><span class="hl_vardecl"><span class="mpre">timeouts</span></span><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_42_1_42_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_42_1_42_9&#39;)"><span class="hl_varref"><span class="mpre">newIORef</span></span></a><span class="mpre"> </span><a href="GHC.Event.PSQ.html#loc_142_1_142_6" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.PSQ.html#loc_142_1_142_6&#39;)"><span class="hl_varref"><span class="mpre">Q.empty</span></span></a><span class="mpre">
  </span><a name="loc_148_3_148_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_3_148_7&#39;)"><span class="hl_vardecl"><span class="mpre">ctrl</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.Event.Control.html#loc_82_1_82_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_82_1_82_11&#39;)"><span class="hl_varref"><span class="mpre">newControl</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">
  </span><a name="loc_149_3_149_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_3_149_8&#39;)"><span class="hl_vardecl"><span class="mpre">state</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_42_1_42_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_42_1_42_9&#39;)"><span class="hl_varref"><span class="mpre">newIORef</span></span></a><span class="mpre"> </span><a href="#loc_76_14_76_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_14_76_21&#39;)"><span class="hl_conref"><span class="mpre">Created</span></span></a><span class="mpre">
  </span><span class="hl_vardecl"><span class="mpre">us</span></span><span class="mpre"> &lt;- </span><a href="GHC.Event.Unique.html#loc_33_1_33_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Unique.html#loc_33_1_33_10&#39;)"><span class="hl_varref"><span class="mpre">newSource</span></span></a><span class="mpre">
  _ &lt;- </span><a href="Data.IORef.html#loc_52_1_52_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.IORef.html#loc_52_1_52_12&#39;)"><span class="hl_varref"><span class="mpre">mkWeakIORef</span></span></a><span class="mpre"> </span><a href="#loc_149_3_149_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_3_149_8&#39;)"><span class="hl_varref"><span class="mpre">state</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
               </span><a name="loc_152_16_152_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_16_152_18&#39;)"><span class="hl_vardecl"><span class="mpre">st</span></span></a><span class="mpre"> &lt;- </span><a href="Data.IORef.html#loc_108_1_108_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.IORef.html#loc_108_1_108_19&#39;)"><span class="hl_varref"><span class="mpre">atomicModifyIORef&#39;</span></span></a><span class="mpre"> </span><a href="#loc_149_3_149_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_3_149_8&#39;)"><span class="hl_varref"><span class="mpre">state</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_152_50_152_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_50_152_51&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> -&gt; (</span><a href="#loc_79_14_79_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_14_79_22&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre">, </span><a href="#loc_152_50_152_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_50_152_51&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">)
               </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><a href="#loc_152_16_152_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_16_152_18&#39;)"><span class="hl_varref"><span class="mpre">st</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">/=</span></span><span class="mpre"> </span><a href="#loc_79_14_79_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_14_79_22&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
                 </span><a href="GHC.Event.Internal.html#loc_144_1_144_7" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_144_1_144_7&#39;)"><span class="hl_varref"><span class="mpre">I.delete</span></span></a><span class="mpre"> </span><a href="#loc_146_9_146_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_9_146_11&#39;)"><span class="hl_varref"><span class="mpre">be</span></span></a><span class="mpre">
                 </span><a href="GHC.Event.Control.html#loc_116_1_116_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_116_1_116_13&#39;)"><span class="hl_varref"><span class="mpre">closeControl</span></span></a><span class="mpre"> </span><a href="#loc_148_3_148_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_3_148_7&#39;)"><span class="hl_varref"><span class="mpre">ctrl</span></span></a><span class="mpre">
  let </span><a name="loc_156_7_156_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_7_156_10&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> = </span><span class="warning" data-warning="ExpRecConstr (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 156, srcSpanStartColumn = 13, srcSpanEndLine = 161, srcSpanEndColumn = 27}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, srcSpanStartLine = 156, srcSpanStartColumn = 26, srcSpanEndLine = 156, srcSpanEndColumn = 27},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Event/TimerManager.hs&quot;, s"><span class="mpre">TimerManager { emBackend = be
                         , emTimeouts = timeouts
                         , emState = state
                         , emUniqueSource = us
                         , emControl = ctrl
                         }</span></span><span class="mpre">
  _ &lt;- </span><a href="GHC.Event.Internal.html#loc_133_1_133_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_133_1_133_9&#39;)"><span class="hl_varref"><span class="mpre">I.modifyFd</span></span></a><span class="mpre"> </span><a href="#loc_146_9_146_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_9_146_11&#39;)"><span class="hl_varref"><span class="mpre">be</span></span></a><span class="mpre"> (</span><a href="GHC.Event.Control.html#loc_63_7_63_20" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_63_7_63_20&#39;)"><span class="hl_varref"><span class="mpre">controlReadFd</span></span></a><span class="mpre"> </span><a href="#loc_148_3_148_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_3_148_7&#39;)"><span class="hl_varref"><span class="mpre">ctrl</span></span></a><span class="mpre">) </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre"> </span><a href="GHC.Event.Internal.html#loc_46_1_46_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_46_1_46_8&#39;)"><span class="hl_varref"><span class="mpre">evtRead</span></span></a><span class="mpre">
  _ &lt;- </span><a href="GHC.Event.Internal.html#loc_133_1_133_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_133_1_133_9&#39;)"><span class="hl_varref"><span class="mpre">I.modifyFd</span></span></a><span class="mpre"> </span><a href="#loc_146_9_146_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_9_146_11&#39;)"><span class="hl_varref"><span class="mpre">be</span></span></a><span class="mpre"> (</span><a href="GHC.Event.Control.html#loc_68_7_68_19" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_68_7_68_19&#39;)"><span class="hl_varref"><span class="mpre">wakeupReadFd</span></span></a><span class="mpre"> </span><a href="#loc_148_3_148_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_3_148_7&#39;)"><span class="hl_varref"><span class="mpre">ctrl</span></span></a><span class="mpre">) </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre"> </span><a href="GHC.Event.Internal.html#loc_46_1_46_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_46_1_46_8&#39;)"><span class="hl_varref"><span class="mpre">evtRead</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_156_7_156_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_7_156_10&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Asynchronously shuts down the event manager, if running.</span></span><span class="mpre">
</span><a href="#loc_168_1_168_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_1_168_9&#39;)"><span class="mpre">shutdown</span></a><span class="mpre"> :: </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_168_1_168_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_1_168_9&#39;)"><span class="hl_fundecl"><span class="mpre">shutdown</span></span></a><span class="mpre"> </span><a name="loc_168_10_168_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_10_168_13&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> = do
  </span><a name="loc_169_3_169_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_3_169_8&#39;)"><span class="hl_vardecl"><span class="mpre">state</span></span></a><span class="mpre"> &lt;- </span><a href="Data.IORef.html#loc_108_1_108_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.IORef.html#loc_108_1_108_19&#39;)"><span class="hl_varref"><span class="mpre">atomicModifyIORef&#39;</span></span></a><span class="mpre"> (</span><a href="#loc_118_7_118_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_7_118_14&#39;)"><span class="hl_varref"><span class="mpre">emState</span></span></a><span class="mpre"> </span><a href="#loc_168_10_168_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_10_168_13&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_169_48_169_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_48_169_49&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> -&gt; (</span><a href="#loc_78_14_78_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_14_78_19&#39;)"><span class="hl_conref"><span class="mpre">Dying</span></span></a><span class="mpre">, </span><a href="#loc_169_48_169_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_48_169_49&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">)
  </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><a href="#loc_169_3_169_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_3_169_8&#39;)"><span class="hl_varref"><span class="mpre">state</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_77_14_77_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_14_77_21&#39;)"><span class="hl_conref"><span class="mpre">Running</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="GHC.Event.Control.html#loc_184_1_184_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_184_1_184_8&#39;)"><span class="hl_varref"><span class="mpre">sendDie</span></span></a><span class="mpre"> (</span><a href="#loc_120_7_120_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_7_120_16&#39;)"><span class="hl_varref"><span class="mpre">emControl</span></span></a><span class="mpre"> </span><a href="#loc_168_10_168_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_10_168_13&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">)

</span><a href="#loc_173_1_173_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_1_173_9&#39;)"><span class="mpre">finished</span></a><span class="mpre"> :: </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
</span><a name="loc_173_1_173_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_1_173_9&#39;)"><span class="hl_fundecl"><span class="mpre">finished</span></span></a><span class="mpre"> </span><a name="loc_173_10_173_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_10_173_13&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> = (</span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_79_14_79_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_14_79_22&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre">) </span><a href="Control.Monad.html#loc_274_1_274_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_274_1_274_6&#39;)"><span class="hl_infix"><span class="mpre">`liftM`</span></span></a><span class="mpre"> </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> (</span><a href="#loc_118_7_118_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_7_118_14&#39;)"><span class="hl_varref"><span class="mpre">emState</span></span></a><span class="mpre"> </span><a href="#loc_173_10_173_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_10_173_13&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">)

</span><a href="#loc_176_1_176_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_1_176_8&#39;)"><span class="mpre">cleanup</span></a><span class="mpre"> :: </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_176_1_176_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_1_176_8&#39;)"><span class="hl_fundecl"><span class="mpre">cleanup</span></span></a><span class="mpre"> </span><a name="loc_176_9_176_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_9_176_12&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> = do
  </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> (</span><a href="#loc_118_7_118_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_7_118_14&#39;)"><span class="hl_varref"><span class="mpre">emState</span></span></a><span class="mpre"> </span><a href="#loc_176_9_176_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_9_176_12&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">) </span><a href="#loc_79_14_79_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_14_79_22&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre">
  </span><a href="GHC.Event.Internal.html#loc_144_1_144_7" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_144_1_144_7&#39;)"><span class="hl_varref"><span class="mpre">I.delete</span></span></a><span class="mpre"> (</span><a href="#loc_116_7_116_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_116_7_116_16&#39;)"><span class="hl_varref"><span class="mpre">emBackend</span></span></a><span class="mpre"> </span><a href="#loc_176_9_176_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_9_176_12&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">)
  </span><a href="GHC.Event.Control.html#loc_116_1_116_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_116_1_116_13&#39;)"><span class="hl_varref"><span class="mpre">closeControl</span></span></a><span class="mpre"> (</span><a href="#loc_120_7_120_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_7_120_16&#39;)"><span class="hl_varref"><span class="mpre">emControl</span></span></a><span class="mpre"> </span><a href="#loc_176_9_176_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_9_176_12&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Event loop</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Start handling events.  This function loops until told to stop,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- using &#39;shutdown&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- /Note/: This loop can only be run once per &#39;TimerManager&#39;, as it</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- closes all of its control resources when it finishes.</span></span><span class="mpre">
</span><a href="#loc_190_1_190_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_190_1_190_5&#39;)"><span class="mpre">loop</span></a><span class="mpre"> :: </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_190_1_190_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_190_1_190_5&#39;)"><span class="hl_fundecl"><span class="mpre">loop</span></span></a><span class="mpre"> </span><a name="loc_190_6_190_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_190_6_190_9&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> = do
  </span><a name="loc_191_3_191_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_3_191_8&#39;)"><span class="hl_vardecl"><span class="mpre">state</span></span></a><span class="mpre"> &lt;- </span><a href="Data.IORef.html#loc_108_1_108_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.IORef.html#loc_108_1_108_19&#39;)"><span class="hl_varref"><span class="mpre">atomicModifyIORef&#39;</span></span></a><span class="mpre"> (</span><a href="#loc_118_7_118_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_7_118_14&#39;)"><span class="hl_varref"><span class="mpre">emState</span></span></a><span class="mpre"> </span><a href="#loc_190_6_190_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_190_6_190_9&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_191_48_191_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_48_191_49&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> -&gt; case </span><a href="#loc_191_48_191_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_48_191_49&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> of
    </span><a href="#loc_76_14_76_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_14_76_21&#39;)"><span class="hl_conref"><span class="mpre">Created</span></span></a><span class="mpre"> -&gt; (</span><a href="#loc_77_14_77_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_14_77_21&#39;)"><span class="hl_conref"><span class="mpre">Running</span></span></a><span class="mpre">, </span><a href="#loc_191_48_191_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_48_191_49&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">)
    _       -&gt; (</span><a href="#loc_191_48_191_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_48_191_49&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">, </span><a href="#loc_191_48_191_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_48_191_49&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">)
  case </span><a href="#loc_191_3_191_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_3_191_8&#39;)"><span class="hl_varref"><span class="mpre">state</span></span></a><span class="mpre"> of
    </span><a href="#loc_76_14_76_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_14_76_21&#39;)"><span class="hl_conref"><span class="mpre">Created</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_201_3_201_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_3_201_5&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="Control.Exception.Base.html#loc_273_3_273_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_273_3_273_12&#39;)"><span class="hl_infix"><span class="mpre">`finally`</span></span></a><span class="mpre"> </span><a href="#loc_176_1_176_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_1_176_8&#39;)"><span class="hl_varref"><span class="mpre">cleanup</span></span></a><span class="mpre"> </span><a href="#loc_190_6_190_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_190_6_190_9&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">
    </span><a href="#loc_78_14_78_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_14_78_19&#39;)"><span class="hl_conref"><span class="mpre">Dying</span></span></a><span class="mpre">   -&gt; </span><a href="#loc_176_1_176_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_1_176_8&#39;)"><span class="hl_varref"><span class="mpre">cleanup</span></span></a><span class="mpre"> </span><a href="#loc_190_6_190_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_190_6_190_9&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">
    _       -&gt; do </span><a href="#loc_176_1_176_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_1_176_8&#39;)"><span class="hl_varref"><span class="mpre">cleanup</span></span></a><span class="mpre"> </span><a href="#loc_190_6_190_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_190_6_190_9&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">
                  </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;GHC.Event.Manager.loop: state is already &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre">
                      </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_191_3_191_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_3_191_8&#39;)"><span class="hl_varref"><span class="mpre">state</span></span></a><span class="mpre">
 where
  </span><a name="loc_201_3_201_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_3_201_5&#39;)"><span class="hl_vardecl"><span class="mpre">go</span></span></a><span class="mpre"> = do </span><a name="loc_201_11_201_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_11_201_18&#39;)"><span class="hl_vardecl"><span class="mpre">running</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_205_1_205_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_1_205_5&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_190_6_190_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_190_6_190_9&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">
          </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> </span><a href="#loc_201_11_201_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_11_201_18&#39;)"><span class="hl_varref"><span class="mpre">running</span></span></a><span class="mpre"> </span><a href="#loc_201_3_201_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_3_201_5&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre">

</span><a href="#loc_205_1_205_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_1_205_5&#39;)"><span class="mpre">step</span></a><span class="mpre"> :: </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
</span><a name="loc_205_1_205_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_1_205_5&#39;)"><span class="hl_fundecl"><span class="mpre">step</span></span></a><span class="mpre"> </span><a name="loc_205_6_205_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_6_205_9&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> = do
  </span><a name="loc_206_3_206_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_3_206_10&#39;)"><span class="hl_vardecl"><span class="mpre">timeout</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_215_3_215_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_3_215_12&#39;)"><span class="hl_varref"><span class="mpre">mkTimeout</span></span></a><span class="mpre">
  _ &lt;- </span><a href="GHC.Event.Internal.html#loc_126_1_126_5" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_126_1_126_5&#39;)"><span class="hl_varref"><span class="mpre">I.poll</span></span></a><span class="mpre"> (</span><a href="#loc_116_7_116_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_116_7_116_16&#39;)"><span class="hl_varref"><span class="mpre">emBackend</span></span></a><span class="mpre"> </span><a href="#loc_205_6_205_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_6_205_9&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">) (</span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> </span><a href="#loc_206_3_206_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_3_206_10&#39;)"><span class="hl_varref"><span class="mpre">timeout</span></span></a><span class="mpre">) (</span><a href="#loc_127_1_127_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_19&#39;)"><span class="hl_varref"><span class="mpre">handleControlEvent</span></span></a><span class="mpre"> </span><a href="#loc_205_6_205_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_6_205_9&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">)
  </span><a name="loc_208_3_208_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_208_3_208_8&#39;)"><span class="hl_vardecl"><span class="mpre">state</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> (</span><a href="#loc_118_7_118_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_7_118_14&#39;)"><span class="hl_varref"><span class="mpre">emState</span></span></a><span class="mpre"> </span><a href="#loc_205_6_205_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_6_205_9&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">)
  </span><a href="#loc_208_3_208_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_208_3_208_8&#39;)"><span class="hl_varref"><span class="mpre">state</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`seq`</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_208_3_208_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_208_3_208_8&#39;)"><span class="hl_varref"><span class="mpre">state</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_77_14_77_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_14_77_21&#39;)"><span class="hl_conref"><span class="mpre">Running</span></span></a><span class="mpre">)
 where

  </span><span class="hl_comment"><span class="mpre">-- | Call all expired timer callbacks and return the time to the</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- next timeout.</span></span><span class="mpre">
  </span><a href="#loc_215_3_215_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_3_215_12&#39;)"><span class="mpre">mkTimeout</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="GHC.Event.Internal.html#loc_84_6_84_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_84_6_84_13&#39;)"><span class="hl_tyconref"><span class="mpre">Timeout</span></span></a><span class="mpre">
  </span><a name="loc_215_3_215_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_3_215_12&#39;)"><span class="hl_vardecl"><span class="mpre">mkTimeout</span></span></a><span class="mpre"> = do
      </span><a name="loc_216_7_216_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_7_216_10&#39;)"><span class="hl_vardecl"><span class="mpre">now</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">getMonotonicTime</span></span><span class="mpre">
      (</span><a name="loc_217_8_217_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_8_217_15&#39;)"><span class="hl_vardecl"><span class="mpre">expired</span></span></a><span class="mpre">, </span><a name="loc_217_17_217_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_17_217_24&#39;)"><span class="hl_vardecl"><span class="mpre">timeout</span></span></a><span class="mpre">) &lt;- </span><a href="Data.IORef.html#loc_108_1_108_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.IORef.html#loc_108_1_108_19&#39;)"><span class="hl_varref"><span class="mpre">atomicModifyIORef&#39;</span></span></a><span class="mpre"> (</span><a href="#loc_117_7_117_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_7_117_17&#39;)"><span class="hl_varref"><span class="mpre">emTimeouts</span></span></a><span class="mpre"> </span><a href="#loc_205_6_205_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_6_205_9&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_217_68_217_70" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_68_217_70&#39;)"><span class="hl_vardecl"><span class="mpre">tq</span></span></a><span class="mpre"> -&gt;
           let (</span><a name="loc_218_17_218_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_17_218_24&#39;)"><span class="hl_vardecl"><span class="mpre">expired</span></span></a><span class="mpre">, </span><a name="loc_218_26_218_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_26_218_29&#39;)"><span class="hl_vardecl"><span class="mpre">tq&#39;</span></span></a><span class="mpre">) = </span><a href="GHC.Event.PSQ.html#loc_267_1_267_7" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.PSQ.html#loc_267_1_267_7&#39;)"><span class="hl_varref"><span class="mpre">Q.atMost</span></span></a><span class="mpre"> </span><a href="#loc_216_7_216_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_7_216_10&#39;)"><span class="hl_varref"><span class="mpre">now</span></span></a><span class="mpre"> </span><a href="#loc_217_68_217_70" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_68_217_70&#39;)"><span class="hl_varref"><span class="mpre">tq</span></span></a><span class="mpre">
               </span><a name="loc_219_16_219_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_16_219_23&#39;)"><span class="hl_vardecl"><span class="mpre">timeout</span></span></a><span class="mpre"> = case </span><a href="GHC.Event.PSQ.html#loc_256_1_256_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.PSQ.html#loc_256_1_256_8&#39;)"><span class="hl_varref"><span class="mpre">Q.minView</span></span></a><span class="mpre"> </span><a href="#loc_218_26_218_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_26_218_29&#39;)"><span class="hl_varref"><span class="mpre">tq&#39;</span></span></a><span class="mpre"> of
                 </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre">             -&gt; </span><a href="GHC.Event.Internal.html#loc_85_16_85_23" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_85_16_85_23&#39;)"><span class="hl_conref"><span class="mpre">Forever</span></span></a><span class="mpre">
                 </span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Q.E</span></span><span class="mpre"> _ </span><a name="loc_221_30_221_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_30_221_31&#39;)"><span class="hl_vardecl"><span class="mpre">t</span></span></a><span class="mpre"> _, _) -&gt;
                     </span><span class="hl_comment"><span class="mpre">-- This value will always be positive since the call</span></span><span class="mpre">
                     </span><span class="hl_comment"><span class="mpre">-- to &#39;atMost&#39; above removed any timeouts &lt;= &#39;now&#39;</span></span><span class="mpre">
                     let </span><a name="loc_224_26_224_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_26_224_28&#39;)"><span class="hl_vardecl"><span class="mpre">t&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_221_30_221_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_30_221_31&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><a href="#loc_216_7_216_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_7_216_10&#39;)"><span class="hl_varref"><span class="mpre">now</span></span></a><span class="mpre"> in </span><a href="#loc_224_26_224_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_26_224_28&#39;)"><span class="hl_varref"><span class="mpre">t&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`seq`</span></span><span class="mpre"> </span><a href="GHC.Event.Internal.html#loc_84_16_84_23" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Internal.html#loc_84_16_84_23&#39;)"><span class="hl_conref"><span class="mpre">Timeout</span></span></a><span class="mpre"> </span><a href="#loc_224_26_224_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_26_224_28&#39;)"><span class="hl_varref"><span class="mpre">t&#39;</span></span></a><span class="mpre">
           in (</span><a href="#loc_218_26_218_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_26_218_29&#39;)"><span class="hl_varref"><span class="mpre">tq&#39;</span></span></a><span class="mpre">, (</span><a href="#loc_218_17_218_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_17_218_24&#39;)"><span class="hl_varref"><span class="mpre">expired</span></span></a><span class="mpre">, </span><a href="#loc_219_16_219_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_16_219_23&#39;)"><span class="hl_varref"><span class="mpre">timeout</span></span></a><span class="mpre">))
      </span><a href="Control.Monad.html#loc_106_1_106_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_106_1_106_10&#39;)"><span class="hl_varref"><span class="mpre">sequence_</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><a href="GHC.Event.PSQ.html#loc_101_7_101_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.PSQ.html#loc_101_7_101_12&#39;)"><span class="hl_varref"><span class="mpre">Q.value</span></span></a><span class="mpre"> </span><a href="#loc_217_8_217_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_8_217_15&#39;)"><span class="hl_varref"><span class="mpre">expired</span></span></a><span class="mpre">
      </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_217_17_217_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_17_217_24&#39;)"><span class="hl_varref"><span class="mpre">timeout</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Wake up the event manager.</span></span><span class="mpre">
</span><a href="#loc_231_1_231_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_12&#39;)"><span class="mpre">wakeManager</span></a><span class="mpre"> :: </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_231_1_231_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_12&#39;)"><span class="hl_fundecl"><span class="mpre">wakeManager</span></span></a><span class="mpre"> </span><a name="loc_231_13_231_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_13_231_16&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> = </span><a href="GHC.Event.Control.html#loc_169_1_169_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Control.html#loc_169_1_169_11&#39;)"><span class="hl_varref"><span class="mpre">sendWakeup</span></span></a><span class="mpre"> (</span><a href="#loc_120_7_120_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_7_120_16&#39;)"><span class="hl_varref"><span class="mpre">emControl</span></span></a><span class="mpre"> </span><a href="#loc_231_13_231_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_13_231_16&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Registering interest in timeout events</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Register a timeout in the given number of microseconds.  The</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- returned &#39;TimeoutKey&#39; can be used to later unregister or update the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- timeout.  The timeout is automatically unregistered after the given</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- time has passed.</span></span><span class="mpre">
</span><a href="#loc_241_1_241_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_1_241_16&#39;)"><span class="mpre">registerTimeout</span></a><span class="mpre"> :: </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">TimeoutCallback</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_70_9_70_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_9_70_19&#39;)"><span class="hl_tyconref"><span class="mpre">TimeoutKey</span></span></a><span class="mpre">
</span><a name="loc_241_1_241_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_1_241_16&#39;)"><span class="hl_fundecl"><span class="mpre">registerTimeout</span></span></a><span class="mpre"> </span><a name="loc_241_17_241_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_17_241_20&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> </span><a name="loc_241_21_241_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_21_241_23&#39;)"><span class="hl_vardecl"><span class="mpre">us</span></span></a><span class="mpre"> </span><a name="loc_241_24_241_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_24_241_26&#39;)"><span class="hl_vardecl"><span class="mpre">cb</span></span></a><span class="mpre"> = do
  !</span><a name="loc_242_4_242_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_4_242_7&#39;)"><span class="hl_vardecl"><span class="mpre">key</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.Event.Unique.html#loc_36_1_36_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Unique.html#loc_36_1_36_10&#39;)"><span class="hl_varref"><span class="mpre">newUnique</span></span></a><span class="mpre"> (</span><a href="#loc_119_7_119_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_7_119_21&#39;)"><span class="hl_varref"><span class="mpre">emUniqueSource</span></span></a><span class="mpre"> </span><a href="#loc_241_17_241_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_17_241_20&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">)
  if </span><a href="#loc_241_21_241_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_21_241_23&#39;)"><span class="hl_varref"><span class="mpre">us</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> then </span><a href="#loc_241_24_241_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_24_241_26&#39;)"><span class="hl_varref"><span class="mpre">cb</span></span></a><span class="mpre">
    else do
      </span><a name="loc_245_7_245_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_245_7_245_10&#39;)"><span class="hl_vardecl"><span class="mpre">now</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">getMonotonicTime</span></span><span class="mpre">
      let </span><a name="loc_246_11_246_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_11_246_18&#39;)"><span class="hl_vardecl"><span class="mpre">expTime</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_241_21_241_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_21_241_23&#39;)"><span class="hl_varref"><span class="mpre">us</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">/</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1000000.0</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><a href="#loc_245_7_245_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_245_7_245_10&#39;)"><span class="hl_varref"><span class="mpre">now</span></span></a><span class="mpre">

      </span><a href="#loc_269_1_269_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_1_269_13&#39;)"><span class="hl_varref"><span class="mpre">editTimeouts</span></span></a><span class="mpre"> </span><a href="#loc_241_17_241_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_17_241_20&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre"> (</span><a href="GHC.Event.PSQ.html#loc_155_1_155_7" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.PSQ.html#loc_155_1_155_7&#39;)"><span class="hl_varref"><span class="mpre">Q.insert</span></span></a><span class="mpre"> </span><a href="#loc_242_4_242_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_4_242_7&#39;)"><span class="hl_varref"><span class="mpre">key</span></span></a><span class="mpre"> </span><a href="#loc_246_11_246_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_246_11_246_18&#39;)"><span class="hl_varref"><span class="mpre">expTime</span></span></a><span class="mpre"> </span><a href="#loc_241_24_241_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_24_241_26&#39;)"><span class="hl_varref"><span class="mpre">cb</span></span></a><span class="mpre">)
      </span><a href="#loc_231_1_231_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_12&#39;)"><span class="hl_varref"><span class="mpre">wakeManager</span></span></a><span class="mpre"> </span><a href="#loc_241_17_241_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_17_241_20&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_70_24_70_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_24_70_26&#39;)"><span class="hl_conref"><span class="mpre">TK</span></span></a><span class="mpre"> </span><a href="#loc_242_4_242_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_4_242_7&#39;)"><span class="hl_varref"><span class="mpre">key</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Unregister an active timeout.</span></span><span class="mpre">
</span><a href="#loc_254_1_254_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_1_254_18&#39;)"><span class="mpre">unregisterTimeout</span></a><span class="mpre"> :: </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_70_9_70_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_9_70_19&#39;)"><span class="hl_tyconref"><span class="mpre">TimeoutKey</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_254_1_254_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_1_254_18&#39;)"><span class="hl_fundecl"><span class="mpre">unregisterTimeout</span></span></a><span class="mpre"> </span><a name="loc_254_19_254_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_19_254_22&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> (</span><a href="#loc_70_24_70_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_24_70_26&#39;)"><span class="hl_conref"><span class="mpre">TK</span></span></a><span class="mpre"> </span><a name="loc_254_27_254_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_27_254_30&#39;)"><span class="hl_vardecl"><span class="mpre">key</span></span></a><span class="mpre">) = do
  </span><a href="#loc_269_1_269_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_1_269_13&#39;)"><span class="hl_varref"><span class="mpre">editTimeouts</span></span></a><span class="mpre"> </span><a href="#loc_254_19_254_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_19_254_22&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre"> (</span><a href="GHC.Event.PSQ.html#loc_175_1_175_7" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.PSQ.html#loc_175_1_175_7&#39;)"><span class="hl_varref"><span class="mpre">Q.delete</span></span></a><span class="mpre"> </span><a href="#loc_254_27_254_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_27_254_30&#39;)"><span class="hl_varref"><span class="mpre">key</span></span></a><span class="mpre">)
  </span><a href="#loc_231_1_231_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_12&#39;)"><span class="hl_varref"><span class="mpre">wakeManager</span></span></a><span class="mpre"> </span><a href="#loc_254_19_254_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_19_254_22&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Update an active timeout to fire in the given number of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- microseconds.</span></span><span class="mpre">
</span><a href="#loc_261_1_261_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_261_1_261_14&#39;)"><span class="mpre">updateTimeout</span></a><span class="mpre"> :: </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_70_9_70_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_9_70_19&#39;)"><span class="hl_tyconref"><span class="mpre">TimeoutKey</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_261_1_261_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_261_1_261_14&#39;)"><span class="hl_fundecl"><span class="mpre">updateTimeout</span></span></a><span class="mpre"> </span><a name="loc_261_15_261_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_261_15_261_18&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> (</span><a href="#loc_70_24_70_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_24_70_26&#39;)"><span class="hl_conref"><span class="mpre">TK</span></span></a><span class="mpre"> </span><a name="loc_261_23_261_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_261_23_261_26&#39;)"><span class="hl_vardecl"><span class="mpre">key</span></span></a><span class="mpre">) </span><a name="loc_261_28_261_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_261_28_261_30&#39;)"><span class="hl_vardecl"><span class="mpre">us</span></span></a><span class="mpre"> = do
  </span><a name="loc_262_3_262_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_262_3_262_6&#39;)"><span class="hl_vardecl"><span class="mpre">now</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">getMonotonicTime</span></span><span class="mpre">
  let </span><a name="loc_263_7_263_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_263_7_263_14&#39;)"><span class="hl_vardecl"><span class="mpre">expTime</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_261_28_261_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_261_28_261_30&#39;)"><span class="hl_varref"><span class="mpre">us</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">/</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1000000.0</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><a href="#loc_262_3_262_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_262_3_262_6&#39;)"><span class="hl_varref"><span class="mpre">now</span></span></a><span class="mpre">

  </span><a href="#loc_269_1_269_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_1_269_13&#39;)"><span class="hl_varref"><span class="mpre">editTimeouts</span></span></a><span class="mpre"> </span><a href="#loc_261_15_261_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_261_15_261_18&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre"> (</span><a href="GHC.Event.PSQ.html#loc_191_1_191_7" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.PSQ.html#loc_191_1_191_7&#39;)"><span class="hl_varref"><span class="mpre">Q.adjust</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">const</span></span><span class="mpre"> </span><a href="#loc_263_7_263_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_263_7_263_14&#39;)"><span class="hl_varref"><span class="mpre">expTime</span></span></a><span class="mpre">) </span><a href="#loc_261_23_261_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_261_23_261_26&#39;)"><span class="hl_varref"><span class="mpre">key</span></span></a><span class="mpre">)
  </span><a href="#loc_231_1_231_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_12&#39;)"><span class="hl_varref"><span class="mpre">wakeManager</span></span></a><span class="mpre"> </span><a href="#loc_261_15_261_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_261_15_261_18&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">

</span><a href="#loc_269_1_269_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_1_269_13&#39;)"><span class="mpre">editTimeouts</span></a><span class="mpre"> :: </span><a href="#loc_115_6_115_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_6_115_18&#39;)"><span class="hl_tyconref"><span class="mpre">TimerManager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">TimeoutEdit</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_269_1_269_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_1_269_13&#39;)"><span class="hl_fundecl"><span class="mpre">editTimeouts</span></span></a><span class="mpre"> </span><a name="loc_269_14_269_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_14_269_17&#39;)"><span class="hl_vardecl"><span class="mpre">mgr</span></span></a><span class="mpre"> </span><a name="loc_269_18_269_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_18_269_19&#39;)"><span class="hl_vardecl"><span class="mpre">g</span></span></a><span class="mpre"> = </span><a href="Data.IORef.html#loc_108_1_108_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.IORef.html#loc_108_1_108_19&#39;)"><span class="hl_varref"><span class="mpre">atomicModifyIORef&#39;</span></span></a><span class="mpre"> (</span><a href="#loc_117_7_117_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_7_117_17&#39;)"><span class="hl_varref"><span class="mpre">emTimeouts</span></span></a><span class="mpre"> </span><a href="#loc_269_14_269_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_14_269_17&#39;)"><span class="hl_varref"><span class="mpre">mgr</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_269_61_269_63" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_61_269_63&#39;)"><span class="hl_vardecl"><span class="mpre">tq</span></span></a><span class="mpre"> -&gt; (</span><a href="#loc_269_18_269_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_18_269_19&#39;)"><span class="hl_varref"><span class="mpre">g</span></span></a><span class="mpre"> </span><a href="#loc_269_61_269_63" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_61_269_63&#39;)"><span class="hl_varref"><span class="mpre">tq</span></span></a><span class="mpre">, </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">)

</span></div></body></html>