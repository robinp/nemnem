<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE OverloadedStrings #-}
</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- | Module : Network.Wai.Middleware.MethodOverridePost</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Changes the request-method via first post-parameter _method.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------</span></span><span class="mpre">
module Network.Wai.Middleware.MethodOverridePost
  ( methodOverridePost
  ) where

import Network.Wai
import Network.HTTP.Types           (</span><a href="Network.HTTP.Types.URI.html#loc_134_1_134_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.HTTP.Types.URI.html#loc_134_1_134_11&#39;)"><span class="mpre">parseQuery</span></a><span class="mpre">)
import Data.Monoid                  (</span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="mpre">mconcat</span></a><span class="mpre">, </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="mpre">mempty</span></a><span class="mpre">)
import Data.IORef
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/MethodOverridePost.hs&quot;, srcSpanStartLine = 15, srcSpanStartColumn = 8, srcSpanEndLine = 15, srcSpanEndColumn = 28}, srcInfoPoints = []}) &quot;Data.ByteString.Lazy&quot;"><span class="mpre">Data.ByteString.Lazy</span></span><span class="mpre"> (toChunks)

</span><span class="hl_comment"><span class="mpre">-- | Allows overriding of the HTTP request method via the _method post string parameter.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * Looks for the Content-Type requestHeader.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * If the header is set to application/x-www-form-urlencoded</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- and the first POST parameter is _method</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- then it changes the request-method to the value of that</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- parameter.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * This middleware only applies when the initial request method is POST.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_29_1_29_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_1_29_19&#39;)"><span class="mpre">methodOverridePost</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Middleware</span></span><span class="mpre">
</span><a name="loc_29_1_29_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_1_29_19&#39;)"><span class="hl_fundecl"><span class="mpre">methodOverridePost</span></span></a><span class="mpre"> </span><a name="loc_29_20_29_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_20_29_23&#39;)"><span class="hl_vardecl"><span class="mpre">app</span></span></a><span class="mpre"> </span><a name="loc_29_24_29_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_24_29_27&#39;)"><span class="hl_vardecl"><span class="mpre">req</span></span></a><span class="mpre"> </span><a name="loc_29_28_29_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_28_29_32&#39;)"><span class="hl_vardecl"><span class="mpre">send</span></span></a><span class="mpre"> =
    case (</span><a href="Network.Wai.Internal.html#loc_22_6_22_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Internal.html#loc_22_6_22_19&#39;)"><span class="hl_varref"><span class="mpre">requestMethod</span></span></a><span class="mpre"> </span><a href="#loc_29_24_29_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_24_29_27&#39;)"><span class="hl_varref"><span class="mpre">req</span></span></a><span class="mpre">, </span><span class="hl_varref"><span class="mpre">lookup</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;Content-Type&quot;</span></span><span class="mpre"> (</span><a href="Network.Wai.Internal.html#loc_36_6_36_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Internal.html#loc_36_6_36_20&#39;)"><span class="hl_varref"><span class="mpre">requestHeaders</span></span></a><span class="mpre"> </span><a href="#loc_29_24_29_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_24_29_27&#39;)"><span class="hl_varref"><span class="mpre">req</span></span></a><span class="mpre">)) of
      (</span><span class="hl_string"><span class="mpre">&quot;POST&quot;</span></span><span class="mpre">, </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;application/x-www-form-urlencoded&quot;</span></span><span class="mpre">) -&gt; </span><a href="#loc_35_1_35_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_1_35_8&#39;)"><span class="hl_varref"><span class="mpre">setPost</span></span></a><span class="mpre"> </span><a href="#loc_29_24_29_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_24_29_27&#39;)"><span class="hl_varref"><span class="mpre">req</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">flip</span></span><span class="mpre"> </span><a href="#loc_29_20_29_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_20_29_23&#39;)"><span class="hl_varref"><span class="mpre">app</span></span></a><span class="mpre"> </span><a href="#loc_29_28_29_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_28_29_32&#39;)"><span class="hl_varref"><span class="mpre">send</span></span></a><span class="mpre">
      _                                                  -&gt; </span><a href="#loc_29_20_29_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_20_29_23&#39;)"><span class="hl_varref"><span class="mpre">app</span></span></a><span class="mpre"> </span><a href="#loc_29_24_29_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_24_29_27&#39;)"><span class="hl_varref"><span class="mpre">req</span></span></a><span class="mpre"> </span><a href="#loc_29_28_29_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_28_29_32&#39;)"><span class="hl_varref"><span class="mpre">send</span></span></a><span class="mpre">

</span><a href="#loc_35_1_35_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_1_35_8&#39;)"><span class="mpre">setPost</span></a><span class="mpre"> :: </span><a href="Network.Wai.Internal.html#loc_20_6_20_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Internal.html#loc_20_6_20_13&#39;)"><span class="hl_tyconref"><span class="mpre">Request</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Network.Wai.Internal.html#loc_20_6_20_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Internal.html#loc_20_6_20_13&#39;)"><span class="hl_tyconref"><span class="mpre">Request</span></span></a><span class="mpre">
</span><a name="loc_35_1_35_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_1_35_8&#39;)"><span class="hl_fundecl"><span class="mpre">setPost</span></span></a><span class="mpre"> </span><a name="loc_35_9_35_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_9_35_12&#39;)"><span class="hl_vardecl"><span class="mpre">req</span></span></a><span class="mpre"> = do
  </span><a name="loc_36_3_36_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_3_36_7&#39;)"><span class="hl_vardecl"><span class="mpre">body</span></span></a><span class="mpre"> &lt;- (</span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="hl_varref"><span class="mpre">mconcat</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">toChunks</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">`fmap`</span></span><span class="mpre"> </span><a href="Network.Wai.html#loc_286_1_286_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.html#loc_286_1_286_16&#39;)"><span class="hl_varref"><span class="mpre">lazyRequestBody</span></span></a><span class="mpre"> </span><a href="#loc_35_9_35_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_9_35_12&#39;)"><span class="hl_varref"><span class="mpre">req</span></span></a><span class="mpre">
  </span><a name="loc_37_3_37_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_3_37_6&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_42_1_42_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_42_1_42_9&#39;)"><span class="hl_varref"><span class="mpre">newIORef</span></span></a><span class="mpre"> </span><a href="#loc_36_3_36_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_3_36_7&#39;)"><span class="hl_varref"><span class="mpre">body</span></span></a><span class="mpre">
  let </span><span class="hl_vardecl"><span class="mpre">rb</span></span><span class="mpre"> = </span><a href="Data.IORef.html#loc_101_1_101_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.IORef.html#loc_101_1_101_18&#39;)"><span class="hl_varref"><span class="mpre">atomicModifyIORef</span></span></a><span class="mpre"> </span><a href="#loc_37_3_37_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_3_37_6&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_38_37_38_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_37_38_39&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> -&gt; (</span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre">, </span><a href="#loc_38_37_38_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_37_38_39&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">)
  case </span><a href="Network.HTTP.Types.URI.html#loc_134_1_134_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.HTTP.Types.URI.html#loc_134_1_134_11&#39;)"><span class="hl_varref"><span class="mpre">parseQuery</span></span></a><span class="mpre"> </span><a href="#loc_36_3_36_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_36_3_36_7&#39;)"><span class="hl_varref"><span class="mpre">body</span></span></a><span class="mpre"> of
    ((</span><span class="hl_string"><span class="mpre">&quot;_method&quot;</span></span><span class="mpre">, </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">newmethod</span></span><span class="mpre">)</span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre">_) -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/MethodOverridePost.hs&quot;, srcSpanStartLine = 40, srcSpanStartColumn = 49, srcSpanEndLine = 40, srcSpanEndColumn = 98}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/MethodOverridePost.hs&quot;, srcSpanStartLine = 40, srcSpanStartColumn = 53, srcSpanEndLine = 40, srcSpanEndColumn = 54},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pul"><span class="mpre">req {requestBody = rb, requestMethod = newmethod}</span></span><span class="mpre">
    _                               -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/MethodOverridePost.hs&quot;, srcSpanStartLine = 41, srcSpanStartColumn = 49, srcSpanEndLine = 41, srcSpanEndColumn = 71}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/wai-extra-3.0.0.1/Network/Wai/Middleware/MethodOverridePost.hs&quot;, srcSpanStartLine = 41, srcSpanStartColumn = 53, srcSpanEndLine = 41, srcSpanEndColumn = 54},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pul"><span class="mpre">req {requestBody = rb}</span></span><span class="mpre">
</span></div></body></html>