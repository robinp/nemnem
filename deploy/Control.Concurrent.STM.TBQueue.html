<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# OPTIONS_GHC -fno-warn-name-shadowing #-}
{-# LANGUAGE CPP, DeriveDataTypeable #-}

#if __GLASGOW_HASKELL__ &gt;= 701
{-# LANGUAGE Trustworthy #-}
#endif

</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      :  Control.Concurrent.STM.TBQueue</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   :  (c) The University of Glasgow 2012</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     :  BSD-style (see the file libraries/base/LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- </span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  :  libraries@haskell.org</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   :  experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability :  non-portable (requires STM)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;TBQueue&#39; is a bounded version of &#39;TQueue&#39;. The queue has a maximum</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- capacity set when it is created.  If the queue already contains the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- maximum number of elements, then &#39;writeTBQueue&#39; blocks until an</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- element is removed from the queue.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The implementation is based on the traditional purely-functional</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- queue representation that uses two lists to obtain amortised /O(1)/</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- enqueue and dequeue operations.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">

module Control.Concurrent.STM.TBQueue (
        </span><span class="hl_comment"><span class="mpre">-- * TBQueue</span></span><span class="mpre">
        TBQueue,
        newTBQueue,
        newTBQueueIO,
        readTBQueue,
        tryReadTBQueue,
        peekTBQueue,
        tryPeekTBQueue,
        writeTBQueue,
        unGetTBQueue,
        isEmptyTBQueue,
        isFullTBQueue,
  ) where

import Data.Typeable
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Concurrent/STM/TBQueue.hs&quot;, srcSpanStartLine = 45, srcSpanStartColumn = 8, srcSpanEndLine = 45, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Conc&quot;"><span class="mpre">GHC.Conc</span></span><span class="mpre">

#define _UPK_(x) {-# UNPACK #-} !(x)

</span><span class="hl_comment"><span class="mpre">-- | &#39;TBQueue&#39; is an abstract type representing a bounded FIFO channel.</span></span><span class="mpre">
data </span><a name="loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tycondecl"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
   = </span><a name="loc_51_6_51_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_6_51_13&#39;)"><span class="hl_condecl"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">_UPK_</span></span><span class="mpre">(</span><span class="hl_tyconref"><span class="mpre">TVar</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">)  </span><span class="hl_comment"><span class="mpre">-- CR: read capacity</span></span><span class="mpre">
             </span><span class="hl_tyvar"><span class="mpre">_UPK_</span></span><span class="mpre">(</span><span class="hl_tyconref"><span class="mpre">TVar</span></span><span class="mpre"> [</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">])  </span><span class="hl_comment"><span class="mpre">-- R:  elements waiting to be read</span></span><span class="mpre">
             </span><span class="hl_tyvar"><span class="mpre">_UPK_</span></span><span class="mpre">(</span><span class="hl_tyconref"><span class="mpre">TVar</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">)  </span><span class="hl_comment"><span class="mpre">-- CW: write capacity</span></span><span class="mpre">
             </span><span class="hl_tyvar"><span class="mpre">_UPK_</span></span><span class="mpre">(</span><span class="hl_tyconref"><span class="mpre">TVar</span></span><span class="mpre"> [</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">])  </span><span class="hl_comment"><span class="mpre">-- W:  elements written (head is most recent)</span></span><span class="mpre">
  </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Concurrent/STM/TBQueue.hs&quot;, srcSpanStartLine = 55, srcSpanStartColumn = 3, srcSpanEndLine = 55, srcSpanEndColumn = 20}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Concurrent/STM/TBQueue.hs&quot;, srcSpanStartLine = 55, srcSpanStartColumn = 3, srcSpanEndLine = 55, srcSpanEndColumn = 11}]}) [IHead (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/s"><span class="mpre">deriving Typeable</span></span><span class="mpre">

instance </span><span class="hl_classref"><span class="mpre">Eq</span></span><span class="mpre"> (</span><a href="#loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tyconref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) where
  </span><a href="#loc_51_6_51_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_6_51_13&#39;)"><span class="hl_conref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><a name="loc_58_11_58_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_11_58_12&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> _ _ _ </span><span class="hl_fundecl"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_51_6_51_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_6_51_13&#39;)"><span class="hl_conref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><a name="loc_58_30_58_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_30_58_31&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> _ _ _ = </span><a href="#loc_58_11_58_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_11_58_12&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_58_30_58_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_30_58_31&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Total channel capacity remaining is CR + CW. Reads only need to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- access CR, writes usually need to access only CW but sometimes need</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- CR.  So in the common case we avoid contention between CR and CW.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   - when removing an element from R:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--     CR := CR + 1</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   - when adding an element to W:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--     if CW is non-zero</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--         then CW := CW - 1</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--         then if CR is non-zero</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--                 then CW := CR - 1; CR := 0</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--                 else **FULL**</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- |Build and returns a new instance of &#39;TBQueue&#39;</span></span><span class="mpre">
</span><a href="#loc_77_1_77_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_1_77_11&#39;)"><span class="mpre">newTBQueue</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">   </span><span class="hl_comment"><span class="mpre">-- ^ maximum number of elements the queue can hold</span></span><span class="mpre">
           -&gt; </span><span class="hl_tyconref"><span class="mpre">STM</span></span><span class="mpre"> (</span><a href="#loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tyconref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_77_1_77_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_1_77_11&#39;)"><span class="hl_fundecl"><span class="mpre">newTBQueue</span></span></a><span class="mpre"> </span><a name="loc_77_12_77_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_12_77_16&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre"> = do
  </span><a name="loc_78_3_78_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_3_78_7&#39;)"><span class="hl_vardecl"><span class="mpre">read</span></span></a><span class="mpre">  &lt;- </span><span class="hl_varref"><span class="mpre">newTVar</span></span><span class="mpre"> []
  </span><a name="loc_79_3_79_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_3_79_8&#39;)"><span class="hl_vardecl"><span class="mpre">write</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newTVar</span></span><span class="mpre"> []
  </span><a name="loc_80_3_80_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_3_80_8&#39;)"><span class="hl_vardecl"><span class="mpre">rsize</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newTVar</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
  </span><a name="loc_81_3_81_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_3_81_8&#39;)"><span class="hl_vardecl"><span class="mpre">wsize</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newTVar</span></span><span class="mpre"> </span><a href="#loc_77_12_77_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_12_77_16&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_51_6_51_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_6_51_13&#39;)"><span class="hl_conref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><a href="#loc_80_3_80_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_3_80_8&#39;)"><span class="hl_varref"><span class="mpre">rsize</span></span></a><span class="mpre"> </span><a href="#loc_78_3_78_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_3_78_7&#39;)"><span class="hl_varref"><span class="mpre">read</span></span></a><span class="mpre"> </span><a href="#loc_81_3_81_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_3_81_8&#39;)"><span class="hl_varref"><span class="mpre">wsize</span></span></a><span class="mpre"> </span><a href="#loc_79_3_79_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_3_79_8&#39;)"><span class="hl_varref"><span class="mpre">write</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- |@IO@ version of &#39;newTBQueue&#39;.  This is useful for creating top-level</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;TBQueue&#39;s using &#39;System.IO.Unsafe.unsafePerformIO&#39;, because using</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;atomically&#39; inside &#39;System.IO.Unsafe.unsafePerformIO&#39; isn&#39;t</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- possible.</span></span><span class="mpre">
</span><a href="#loc_89_1_89_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_1_89_13&#39;)"><span class="mpre">newTBQueueIO</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="#loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tyconref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_89_1_89_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_1_89_13&#39;)"><span class="hl_fundecl"><span class="mpre">newTBQueueIO</span></span></a><span class="mpre"> </span><a name="loc_89_14_89_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_14_89_18&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre"> = do
  </span><a name="loc_90_3_90_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_3_90_7&#39;)"><span class="hl_vardecl"><span class="mpre">read</span></span></a><span class="mpre">  &lt;- </span><span class="hl_varref"><span class="mpre">newTVarIO</span></span><span class="mpre"> []
  </span><a name="loc_91_3_91_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_3_91_8&#39;)"><span class="hl_vardecl"><span class="mpre">write</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newTVarIO</span></span><span class="mpre"> []
  </span><a name="loc_92_3_92_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_3_92_8&#39;)"><span class="hl_vardecl"><span class="mpre">rsize</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newTVarIO</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
  </span><a name="loc_93_3_93_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_3_93_8&#39;)"><span class="hl_vardecl"><span class="mpre">wsize</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newTVarIO</span></span><span class="mpre"> </span><a href="#loc_89_14_89_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_14_89_18&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_51_6_51_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_6_51_13&#39;)"><span class="hl_conref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><a href="#loc_92_3_92_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_3_92_8&#39;)"><span class="hl_varref"><span class="mpre">rsize</span></span></a><span class="mpre"> </span><a href="#loc_90_3_90_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_3_90_7&#39;)"><span class="hl_varref"><span class="mpre">read</span></span></a><span class="mpre"> </span><a href="#loc_93_3_93_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_3_93_8&#39;)"><span class="hl_varref"><span class="mpre">wsize</span></span></a><span class="mpre"> </span><a href="#loc_91_3_91_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_3_91_8&#39;)"><span class="hl_varref"><span class="mpre">write</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- |Write a value to a &#39;TBQueue&#39;; blocks if the queue is full.</span></span><span class="mpre">
</span><a href="#loc_98_1_98_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_1_98_13&#39;)"><span class="mpre">writeTBQueue</span></a><span class="mpre"> :: </span><a href="#loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tyconref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">STM</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_98_1_98_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_1_98_13&#39;)"><span class="hl_fundecl"><span class="mpre">writeTBQueue</span></span></a><span class="mpre"> (</span><a href="#loc_51_6_51_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_6_51_13&#39;)"><span class="hl_conref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><a name="loc_98_23_98_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_23_98_28&#39;)"><span class="hl_vardecl"><span class="mpre">rsize</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_read</span></span><span class="mpre"> </span><a name="loc_98_35_98_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_35_98_40&#39;)"><span class="hl_vardecl"><span class="mpre">wsize</span></span></a><span class="mpre"> </span><a name="loc_98_41_98_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_41_98_46&#39;)"><span class="hl_vardecl"><span class="mpre">write</span></span></a><span class="mpre">) </span><a name="loc_98_48_98_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_48_98_49&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> = do
  </span><a name="loc_99_3_99_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_3_99_4&#39;)"><span class="hl_vardecl"><span class="mpre">w</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_98_35_98_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_35_98_40&#39;)"><span class="hl_varref"><span class="mpre">wsize</span></span></a><span class="mpre">
  if (</span><a href="#loc_99_3_99_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_3_99_4&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">/=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">)
     then do </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_98_35_98_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_35_98_40&#39;)"><span class="hl_varref"><span class="mpre">wsize</span></span></a><span class="mpre"> (</span><a href="#loc_99_3_99_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_3_99_4&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
     else do
          </span><a name="loc_103_11_103_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_11_103_12&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_98_23_98_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_23_98_28&#39;)"><span class="hl_varref"><span class="mpre">rsize</span></span></a><span class="mpre">
          if (</span><a href="#loc_103_11_103_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_11_103_12&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">/=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">)
             then do </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_98_23_98_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_23_98_28&#39;)"><span class="hl_varref"><span class="mpre">rsize</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
                     </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_98_35_98_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_35_98_40&#39;)"><span class="hl_varref"><span class="mpre">wsize</span></span></a><span class="mpre"> (</span><a href="#loc_103_11_103_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_11_103_12&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
             else </span><span class="hl_varref"><span class="mpre">retry</span></span><span class="mpre">
  </span><a name="loc_108_3_108_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_108_3_108_10&#39;)"><span class="hl_vardecl"><span class="mpre">listend</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_98_41_98_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_41_98_46&#39;)"><span class="hl_varref"><span class="mpre">write</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_98_41_98_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_41_98_46&#39;)"><span class="hl_varref"><span class="mpre">write</span></span></a><span class="mpre"> (</span><a href="#loc_98_48_98_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_48_98_49&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a href="#loc_108_3_108_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_108_3_108_10&#39;)"><span class="hl_varref"><span class="mpre">listend</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- |Read the next value from the &#39;TBQueue&#39;.</span></span><span class="mpre">
</span><a href="#loc_113_1_113_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_12&#39;)"><span class="mpre">readTBQueue</span></a><span class="mpre"> :: </span><a href="#loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tyconref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">STM</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_113_1_113_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_12&#39;)"><span class="hl_fundecl"><span class="mpre">readTBQueue</span></span></a><span class="mpre"> (</span><a href="#loc_51_6_51_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_6_51_13&#39;)"><span class="hl_conref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><a name="loc_113_22_113_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_22_113_27&#39;)"><span class="hl_vardecl"><span class="mpre">rsize</span></span></a><span class="mpre"> </span><a name="loc_113_28_113_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_28_113_32&#39;)"><span class="hl_vardecl"><span class="mpre">read</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_wsize</span></span><span class="mpre"> </span><a name="loc_113_40_113_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_40_113_45&#39;)"><span class="hl_vardecl"><span class="mpre">write</span></span></a><span class="mpre">) = do
  </span><a name="loc_114_3_114_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_3_114_5&#39;)"><span class="hl_vardecl"><span class="mpre">xs</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_113_28_113_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_28_113_32&#39;)"><span class="hl_varref"><span class="mpre">read</span></span></a><span class="mpre">
  </span><a name="loc_115_3_115_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_3_115_4&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_113_22_113_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_22_113_27&#39;)"><span class="hl_varref"><span class="mpre">rsize</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_113_22_113_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_22_113_27&#39;)"><span class="hl_varref"><span class="mpre">rsize</span></span></a><span class="mpre"> (</span><a href="#loc_115_3_115_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_3_115_4&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
  case </span><a href="#loc_114_3_114_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_3_114_5&#39;)"><span class="hl_varref"><span class="mpre">xs</span></span></a><span class="mpre"> of
    (</span><a name="loc_118_6_118_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_6_118_7&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_118_8_118_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_8_118_11&#39;)"><span class="hl_vardecl"><span class="mpre">xs&#39;</span></span></a><span class="mpre">) -&gt; do
      </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_113_28_113_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_28_113_32&#39;)"><span class="hl_varref"><span class="mpre">read</span></span></a><span class="mpre"> </span><a href="#loc_118_8_118_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_8_118_11&#39;)"><span class="hl_varref"><span class="mpre">xs&#39;</span></span></a><span class="mpre">
      </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_118_6_118_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_6_118_7&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
    [] -&gt; do
      </span><a name="loc_122_7_122_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_7_122_9&#39;)"><span class="hl_vardecl"><span class="mpre">ys</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_113_40_113_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_40_113_45&#39;)"><span class="hl_varref"><span class="mpre">write</span></span></a><span class="mpre">
      case </span><a href="#loc_122_7_122_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_7_122_9&#39;)"><span class="hl_varref"><span class="mpre">ys</span></span></a><span class="mpre"> of
        [] -&gt; </span><span class="hl_varref"><span class="mpre">retry</span></span><span class="mpre">
        _  -&gt; do
          let (</span><a name="loc_126_16_126_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_16_126_17&#39;)"><span class="hl_vardecl"><span class="mpre">z</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_126_18_126_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_18_126_20&#39;)"><span class="hl_vardecl"><span class="mpre">zs</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">reverse</span></span><span class="mpre"> </span><a href="#loc_122_7_122_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_7_122_9&#39;)"><span class="hl_varref"><span class="mpre">ys</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- NB. lazy: we want the transaction to be</span></span><span class="mpre">
                                  </span><span class="hl_comment"><span class="mpre">-- short, otherwise it will conflict</span></span><span class="mpre">
          </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_113_40_113_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_40_113_45&#39;)"><span class="hl_varref"><span class="mpre">write</span></span></a><span class="mpre"> []
          </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_113_28_113_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_28_113_32&#39;)"><span class="hl_varref"><span class="mpre">read</span></span></a><span class="mpre"> </span><a href="#loc_126_18_126_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_18_126_20&#39;)"><span class="hl_varref"><span class="mpre">zs</span></span></a><span class="mpre">
          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_126_16_126_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_16_126_17&#39;)"><span class="hl_varref"><span class="mpre">z</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A version of &#39;readTBQueue&#39; which does not retry. Instead it</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- returns @Nothing@ if no value is available.</span></span><span class="mpre">
</span><a href="#loc_135_1_135_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_1_135_15&#39;)"><span class="mpre">tryReadTBQueue</span></a><span class="mpre"> :: </span><a href="#loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tyconref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">STM</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_135_1_135_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_1_135_15&#39;)"><span class="hl_fundecl"><span class="mpre">tryReadTBQueue</span></span></a><span class="mpre"> </span><a name="loc_135_16_135_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_16_135_17&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a href="#loc_113_1_113_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_12&#39;)"><span class="hl_varref"><span class="mpre">readTBQueue</span></span></a><span class="mpre"> </span><a href="#loc_135_16_135_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_16_135_17&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">`orElse`</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Get the next value from the @TBQueue@ without removing it,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- retrying if the channel is empty.</span></span><span class="mpre">
</span><a href="#loc_140_1_140_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_140_1_140_12&#39;)"><span class="mpre">peekTBQueue</span></a><span class="mpre"> :: </span><a href="#loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tyconref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">STM</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_140_1_140_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_140_1_140_12&#39;)"><span class="hl_fundecl"><span class="mpre">peekTBQueue</span></span></a><span class="mpre"> </span><a name="loc_140_13_140_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_140_13_140_14&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre"> = do
  </span><a name="loc_141_3_141_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_141_3_141_4&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_113_1_113_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_12&#39;)"><span class="hl_varref"><span class="mpre">readTBQueue</span></span></a><span class="mpre"> </span><a href="#loc_140_13_140_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_140_13_140_14&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">
  </span><a href="#loc_159_1_159_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_1_159_13&#39;)"><span class="hl_varref"><span class="mpre">unGetTBQueue</span></span></a><span class="mpre"> </span><a href="#loc_140_13_140_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_140_13_140_14&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><a href="#loc_141_3_141_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_141_3_141_4&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_141_3_141_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_141_3_141_4&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A version of &#39;peekTBQueue&#39; which does not retry. Instead it</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- returns @Nothing@ if no value is available.</span></span><span class="mpre">
</span><a href="#loc_148_1_148_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_1_148_15&#39;)"><span class="mpre">tryPeekTBQueue</span></a><span class="mpre"> :: </span><a href="#loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tyconref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">STM</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_148_1_148_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_1_148_15&#39;)"><span class="hl_fundecl"><span class="mpre">tryPeekTBQueue</span></span></a><span class="mpre"> </span><a name="loc_148_16_148_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_16_148_17&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre"> = do
  </span><a name="loc_149_3_149_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_3_149_4&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_135_1_135_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_1_135_15&#39;)"><span class="hl_varref"><span class="mpre">tryReadTBQueue</span></span></a><span class="mpre"> </span><a href="#loc_148_16_148_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_16_148_17&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">
  case </span><a href="#loc_149_3_149_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_3_149_4&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> of
    </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
    </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_152_10_152_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_10_152_11&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre">  -&gt; do
      </span><a href="#loc_159_1_159_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_1_159_13&#39;)"><span class="hl_varref"><span class="mpre">unGetTBQueue</span></span></a><span class="mpre"> </span><a href="#loc_148_16_148_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_16_148_17&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><a href="#loc_152_10_152_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_10_152_11&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
      </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_149_3_149_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_3_149_4&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- |Put a data item back onto a channel, where it will be the next item read.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Blocks if the queue is full.</span></span><span class="mpre">
</span><a href="#loc_159_1_159_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_1_159_13&#39;)"><span class="mpre">unGetTBQueue</span></a><span class="mpre"> :: </span><a href="#loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tyconref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">STM</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_159_1_159_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_1_159_13&#39;)"><span class="hl_fundecl"><span class="mpre">unGetTBQueue</span></span></a><span class="mpre"> (</span><a href="#loc_51_6_51_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_6_51_13&#39;)"><span class="hl_conref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><a name="loc_159_23_159_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_23_159_28&#39;)"><span class="hl_vardecl"><span class="mpre">rsize</span></span></a><span class="mpre"> </span><a name="loc_159_29_159_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_29_159_33&#39;)"><span class="hl_vardecl"><span class="mpre">read</span></span></a><span class="mpre"> </span><a name="loc_159_34_159_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_34_159_39&#39;)"><span class="hl_vardecl"><span class="mpre">wsize</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_write</span></span><span class="mpre">) </span><a name="loc_159_48_159_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_48_159_49&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> = do
  </span><a name="loc_160_3_160_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_160_3_160_4&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_159_23_159_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_23_159_28&#39;)"><span class="hl_varref"><span class="mpre">rsize</span></span></a><span class="mpre">
  if (</span><a href="#loc_160_3_160_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_160_3_160_4&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">)
     then do </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_159_23_159_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_23_159_28&#39;)"><span class="hl_varref"><span class="mpre">rsize</span></span></a><span class="mpre"> (</span><a href="#loc_160_3_160_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_160_3_160_4&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
     else do
          </span><a name="loc_164_11_164_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_11_164_12&#39;)"><span class="hl_vardecl"><span class="mpre">w</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_159_34_159_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_34_159_39&#39;)"><span class="hl_varref"><span class="mpre">wsize</span></span></a><span class="mpre">
          if (</span><a href="#loc_164_11_164_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_11_164_12&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">)
             then </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_159_34_159_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_34_159_39&#39;)"><span class="hl_varref"><span class="mpre">wsize</span></span></a><span class="mpre"> (</span><a href="#loc_164_11_164_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_11_164_12&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
             else </span><span class="hl_varref"><span class="mpre">retry</span></span><span class="mpre">
  </span><a name="loc_168_3_168_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_3_168_5&#39;)"><span class="hl_vardecl"><span class="mpre">xs</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_159_29_159_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_29_159_33&#39;)"><span class="hl_varref"><span class="mpre">read</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">writeTVar</span></span><span class="mpre"> </span><a href="#loc_159_29_159_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_29_159_33&#39;)"><span class="hl_varref"><span class="mpre">read</span></span></a><span class="mpre"> (</span><a href="#loc_159_48_159_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_48_159_49&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a href="#loc_168_3_168_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_3_168_5&#39;)"><span class="hl_varref"><span class="mpre">xs</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- |Returns &#39;True&#39; if the supplied &#39;TBQueue&#39; is empty.</span></span><span class="mpre">
</span><a href="#loc_173_1_173_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_1_173_15&#39;)"><span class="mpre">isEmptyTBQueue</span></a><span class="mpre"> :: </span><a href="#loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tyconref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">STM</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
</span><a name="loc_173_1_173_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_1_173_15&#39;)"><span class="hl_fundecl"><span class="mpre">isEmptyTBQueue</span></span></a><span class="mpre"> (</span><a href="#loc_51_6_51_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_6_51_13&#39;)"><span class="hl_conref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_rsize</span></span><span class="mpre"> </span><a name="loc_173_32_173_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_32_173_36&#39;)"><span class="hl_vardecl"><span class="mpre">read</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_wsize</span></span><span class="mpre"> </span><a name="loc_173_44_173_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_44_173_49&#39;)"><span class="hl_vardecl"><span class="mpre">write</span></span></a><span class="mpre">) = do
  </span><a name="loc_174_3_174_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_174_3_174_5&#39;)"><span class="hl_vardecl"><span class="mpre">xs</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_173_32_173_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_32_173_36&#39;)"><span class="hl_varref"><span class="mpre">read</span></span></a><span class="mpre">
  case </span><a href="#loc_174_3_174_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_174_3_174_5&#39;)"><span class="hl_varref"><span class="mpre">xs</span></span></a><span class="mpre"> of
    (_</span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre">_) -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">
    [] -&gt; do </span><a name="loc_177_14_177_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_177_14_177_16&#39;)"><span class="hl_vardecl"><span class="mpre">ys</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_173_44_173_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_44_173_49&#39;)"><span class="hl_varref"><span class="mpre">write</span></span></a><span class="mpre">
             case </span><a href="#loc_177_14_177_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_177_14_177_16&#39;)"><span class="hl_varref"><span class="mpre">ys</span></span></a><span class="mpre"> of
               [] -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">
               _  -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- |Returns &#39;True&#39; if the supplied &#39;TBQueue&#39; is full.</span></span><span class="mpre">
</span><a href="#loc_184_1_184_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_1_184_14&#39;)"><span class="mpre">isFullTBQueue</span></a><span class="mpre"> :: </span><a href="#loc_50_6_50_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_6_50_13&#39;)"><span class="hl_tyconref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">STM</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
</span><a name="loc_184_1_184_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_1_184_14&#39;)"><span class="hl_fundecl"><span class="mpre">isFullTBQueue</span></span></a><span class="mpre"> (</span><a href="#loc_51_6_51_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_6_51_13&#39;)"><span class="hl_conref"><span class="mpre">TBQueue</span></span></a><span class="mpre"> </span><a name="loc_184_24_184_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_24_184_29&#39;)"><span class="hl_vardecl"><span class="mpre">rsize</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_read</span></span><span class="mpre"> </span><a name="loc_184_36_184_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_36_184_41&#39;)"><span class="hl_vardecl"><span class="mpre">wsize</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_write</span></span><span class="mpre">) = do
  </span><a name="loc_185_3_185_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_185_3_185_4&#39;)"><span class="hl_vardecl"><span class="mpre">w</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_184_36_184_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_36_184_41&#39;)"><span class="hl_varref"><span class="mpre">wsize</span></span></a><span class="mpre">
  if (</span><a href="#loc_185_3_185_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_185_3_185_4&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">)
     then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">
     else do
         </span><a name="loc_189_10_189_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_10_189_11&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">readTVar</span></span><span class="mpre"> </span><a href="#loc_184_24_184_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_24_184_29&#39;)"><span class="hl_varref"><span class="mpre">rsize</span></span></a><span class="mpre">
         if (</span><a href="#loc_189_10_189_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_10_189_11&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">)
            then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">
            else </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">
</span></div></body></html>