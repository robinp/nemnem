<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE FlexibleContexts #-}
{-# LANGUAGE BangPatterns #-}
{-# LANGUAGE RankNTypes #-}
</span><span class="hl_comment"><span class="mpre">-- | Convert a stream of blaze-builder @Builder@s into a stream of @ByteString@s.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Adapted from blaze-builder-enumerator, written by myself and Simon Meier.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that the functions here can work in any monad built on top of @IO@ or</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @ST@.</span></span><span class="mpre">
module Data.Streaming.Blaze
    ( BlazeRecv
    , BlazePopper
    , BlazeFinish
    , newBlazeRecv

  </span><span class="hl_comment"><span class="mpre">-- * Buffers</span></span><span class="mpre">
  , Buffer

  </span><span class="hl_comment"><span class="mpre">-- ** Status information</span></span><span class="mpre">
  , freeSize
  , sliceSize
  , bufferSize

  </span><span class="hl_comment"><span class="mpre">-- ** Creation and modification</span></span><span class="mpre">
  , allocBuffer
  , reuseBuffer
  , nextSlice

  </span><span class="hl_comment"><span class="mpre">-- ** Conversion to bytestings</span></span><span class="mpre">
  , unsafeFreezeBuffer
  , unsafeFreezeNonEmptyBuffer

  </span><span class="hl_comment"><span class="mpre">-- * Buffer allocation strategies</span></span><span class="mpre">
  , BufferAllocStrategy
  , allNewBuffersStrategy
  , reuseBufferStrategy
  , defaultStrategy
    ) where

import Data.IORef
import Control.Monad (</span><a href="Control.Monad.html#loc_270_1_270_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_270_1_270_7&#39;)"><span class="mpre">unless</span></a><span class="mpre">, </span><a href="Control.Monad.html#loc_274_1_274_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_274_1_274_6&#39;)"><span class="mpre">liftM</span></a><span class="mpre">)
import Control.Monad.Trans.Class (</span><a href="Control.Monad.Trans.Class.html#loc_51_5_51_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.Class.html#loc_51_5_51_9&#39;)"><span class="mpre">lift</span></a><span class="mpre">, </span><a href="Control.Monad.Trans.Class.html#loc_49_7_49_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.Class.html#loc_49_7_49_17&#39;)"><span class="mpre">MonadTrans</span></a><span class="mpre">)

import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/streaming-commons-0.1.3/Data/Streaming/Blaze.hs&quot;, srcSpanStartLine = 44, srcSpanStartColumn = 18, srcSpanEndLine = 44, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre">                   as S

import Blaze.ByteString.Builder.Internal
import Blaze.ByteString.Builder.Internal.Types
import Blaze.ByteString.Builder.Internal.Buffer

</span><span class="hl_comment"><span class="mpre">-- | Provides a series of @ByteString@s until empty, at which point it provides</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- an empty @ByteString@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.1.2</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/streaming-commons-0.1.3/Data/Streaming/Blaze.hs&quot;, srcSpanStartLine = 54, srcSpanStartColumn = 1, srcSpanEndLine = 54, srcSpanEndColumn = 35}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/streaming-commons-0.1.3/Data/Streaming/Blaze.hs&quot;, srcSpanStartLine = 54, srcSpanStartColumn = 1, srcSpanEndLine = 54, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/streaming-commons-0.1.3/Data/Str"><span class="mpre">type BlazePopper = IO S.ByteString</span></span><span class="mpre">

</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/streaming-commons-0.1.3/Data/Streaming/Blaze.hs&quot;, srcSpanStartLine = 56, srcSpanStartColumn = 1, srcSpanEndLine = 56, srcSpanEndColumn = 43}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/streaming-commons-0.1.3/Data/Streaming/Blaze.hs&quot;, srcSpanStartLine = 56, srcSpanStartColumn = 1, srcSpanEndLine = 56, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/streaming-commons-0.1.3/Data/Str"><span class="mpre">type BlazeRecv = Builder -&gt; IO BlazePopper</span></span><span class="mpre">

</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/streaming-commons-0.1.3/Data/Streaming/Blaze.hs&quot;, srcSpanStartLine = 58, srcSpanStartColumn = 1, srcSpanEndLine = 58, srcSpanEndColumn = 43}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/streaming-commons-0.1.3/Data/Streaming/Blaze.hs&quot;, srcSpanStartLine = 58, srcSpanStartColumn = 1, srcSpanEndLine = 58, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/streaming-commons-0.1.3/Data/Str"><span class="mpre">type BlazeFinish = IO (Maybe S.ByteString)</span></span><span class="mpre">

</span><a href="#loc_61_1_61_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_61_1_61_16&#39;)"><span class="mpre">defaultStrategy</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">BufferAllocStrategy</span></span><span class="mpre">
</span><a name="loc_61_1_61_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_61_1_61_16&#39;)"><span class="hl_vardecl"><span class="mpre">defaultStrategy</span></span></a><span class="mpre"> = </span><a href="Blaze.ByteString.Builder.Internal.Buffer.html#loc_167_1_167_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Buffer.html#loc_167_1_167_22&#39;)"><span class="hl_varref"><span class="mpre">allNewBuffersStrategy</span></span></a><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.html#loc_84_1_84_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.html#loc_84_1_84_18&#39;)"><span class="hl_varref"><span class="mpre">defaultBufferSize</span></span></a><span class="mpre">

</span><a href="#loc_64_1_64_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_1_64_13&#39;)"><span class="mpre">newBlazeRecv</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">BufferAllocStrategy</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">BlazeRecv</span></span><span class="mpre">, </span><span class="hl_tyconref"><span class="mpre">BlazeFinish</span></span><span class="mpre">)
</span><a name="loc_64_1_64_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_1_64_13&#39;)"><span class="hl_fundecl"><span class="mpre">newBlazeRecv</span></span></a><span class="mpre"> (</span><a name="loc_64_15_64_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_15_64_24&#39;)"><span class="hl_vardecl"><span class="mpre">ioBufInit</span></span></a><span class="mpre">, </span><a name="loc_64_26_64_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_26_64_33&#39;)"><span class="hl_vardecl"><span class="mpre">nextBuf</span></span></a><span class="mpre">) = do
    </span><a name="loc_65_5_65_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_5_65_11&#39;)"><span class="hl_vardecl"><span class="mpre">refBuf</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_42_1_42_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_42_1_42_9&#39;)"><span class="hl_varref"><span class="mpre">newIORef</span></span></a><span class="mpre"> </span><a href="#loc_64_15_64_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_15_64_24&#39;)"><span class="hl_varref"><span class="mpre">ioBufInit</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_73_5_73_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_5_73_9&#39;)"><span class="hl_varref"><span class="mpre">push</span></span></a><span class="mpre"> </span><a href="#loc_65_5_65_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_5_65_11&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre">, </span><a href="#loc_68_5_68_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_5_68_11&#39;)"><span class="hl_varref"><span class="mpre">finish</span></span></a><span class="mpre"> </span><a href="#loc_65_5_65_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_5_65_11&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre">)
  where
    </span><a name="loc_68_5_68_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_5_68_11&#39;)"><span class="hl_fundecl"><span class="mpre">finish</span></span></a><span class="mpre"> </span><a name="loc_68_12_68_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_12_68_18&#39;)"><span class="hl_vardecl"><span class="mpre">refBuf</span></span></a><span class="mpre"> = do
        </span><a name="loc_69_9_69_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_9_69_14&#39;)"><span class="hl_vardecl"><span class="mpre">ioBuf</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_68_12_68_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_12_68_18&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre">
        </span><a name="loc_70_9_70_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_9_70_12&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_69_9_69_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_9_69_14&#39;)"><span class="hl_varref"><span class="mpre">ioBuf</span></span></a><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Buffer.html#loc_118_1_118_27" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Buffer.html#loc_118_1_118_27&#39;)"><span class="hl_varref"><span class="mpre">unsafeFreezeNonEmptyBuffer</span></span></a><span class="mpre"> </span><a href="#loc_70_9_70_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_9_70_12&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">

    </span><a name="loc_73_5_73_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_5_73_9&#39;)"><span class="hl_fundecl"><span class="mpre">push</span></span></a><span class="mpre"> </span><a name="loc_73_10_73_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_10_73_16&#39;)"><span class="hl_vardecl"><span class="mpre">refBuf</span></span></a><span class="mpre"> </span><a name="loc_73_17_73_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_17_73_24&#39;)"><span class="hl_vardecl"><span class="mpre">builder</span></span></a><span class="mpre"> = do
        </span><a name="loc_74_9_74_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_9_74_16&#39;)"><span class="hl_vardecl"><span class="mpre">refStep</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_42_1_42_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_42_1_42_9&#39;)"><span class="hl_varref"><span class="mpre">newIORef</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Left</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_70_5_70_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_70_5_70_14&#39;)"><span class="hl_varref"><span class="mpre">unBuilder</span></span></a><span class="mpre"> </span><a href="#loc_73_17_73_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_17_73_24&#39;)"><span class="hl_varref"><span class="mpre">builder</span></span></a><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_63_1_63_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_63_1_63_10&#39;)"><span class="hl_varref"><span class="mpre">buildStep</span></span></a><span class="mpre"> </span><a href="#loc_77_9_77_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_9_77_18&#39;)"><span class="hl_varref"><span class="mpre">finalStep</span></span></a><span class="mpre">)
        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_79_5_79_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_5_79_11&#39;)"><span class="hl_varref"><span class="mpre">popper</span></span></a><span class="mpre"> </span><a href="#loc_73_10_73_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_10_73_16&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre"> </span><a href="#loc_74_9_74_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_9_74_16&#39;)"><span class="hl_varref"><span class="mpre">refStep</span></span></a><span class="mpre">
      where
        </span><a name="loc_77_9_77_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_9_77_18&#39;)"><span class="hl_fundecl"><span class="mpre">finalStep</span></span></a><span class="mpre"> !(</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> </span><a name="loc_77_30_77_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_30_77_32&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a href="#loc_77_30_77_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_30_77_32&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">

    </span><a name="loc_79_5_79_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_5_79_11&#39;)"><span class="hl_fundecl"><span class="mpre">popper</span></span></a><span class="mpre"> </span><a name="loc_79_12_79_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_12_79_18&#39;)"><span class="hl_vardecl"><span class="mpre">refBuf</span></span></a><span class="mpre"> </span><a name="loc_79_19_79_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_19_79_26&#39;)"><span class="hl_vardecl"><span class="mpre">refStep</span></span></a><span class="mpre"> = do
        </span><a name="loc_80_9_80_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_9_80_14&#39;)"><span class="hl_vardecl"><span class="mpre">ioBuf</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_79_12_79_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_12_79_18&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre">
        </span><a name="loc_81_9_81_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_9_81_15&#39;)"><span class="hl_vardecl"><span class="mpre">ebStep</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_79_19_79_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_19_79_26&#39;)"><span class="hl_varref"><span class="mpre">refStep</span></span></a><span class="mpre">
        case </span><a href="#loc_81_9_81_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_9_81_15&#39;)"><span class="hl_varref"><span class="mpre">ebStep</span></span></a><span class="mpre"> of
            </span><span class="hl_conref"><span class="mpre">Left</span></span><span class="mpre"> </span><a name="loc_83_18_83_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_18_83_23&#39;)"><span class="hl_vardecl"><span class="mpre">bStep</span></span></a><span class="mpre"> -&gt; do
                !</span><a name="loc_84_18_84_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_18_84_21&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre">   &lt;- </span><a href="#loc_80_9_80_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_9_80_14&#39;)"><span class="hl_varref"><span class="mpre">ioBuf</span></span></a><span class="mpre">
                </span><a name="loc_85_17_85_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_17_85_23&#39;)"><span class="hl_vardecl"><span class="mpre">signal</span></span></a><span class="mpre"> &lt;- </span><a href="Blaze.ByteString.Builder.Internal.Buffer.html#loc_134_1_134_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Buffer.html#loc_134_1_134_14&#39;)"><span class="hl_varref"><span class="mpre">execBuildStep</span></span></a><span class="mpre"> </span><a href="#loc_83_18_83_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_18_83_23&#39;)"><span class="hl_varref"><span class="mpre">bStep</span></span></a><span class="mpre"> </span><a href="#loc_84_18_84_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_18_84_21&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">
                case </span><a href="#loc_85_17_85_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_17_85_23&#39;)"><span class="hl_varref"><span class="mpre">signal</span></span></a><span class="mpre"> of
                    </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a name="loc_87_26_87_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_26_87_29&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> _ -&gt; do
                        </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_79_12_79_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_12_79_18&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Buffer.html#loc_127_1_127_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Buffer.html#loc_127_1_127_17&#39;)"><span class="hl_varref"><span class="mpre">updateEndOfSlice</span></span></a><span class="mpre"> </span><a href="#loc_84_18_84_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_18_84_21&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> </span><a href="#loc_87_26_87_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_26_87_29&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre">
                        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">S.empty</span></span><span class="mpre">
                    </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_39_5_39_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_39_5_39_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre"> </span><a name="loc_90_32_90_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_32_90_39&#39;)"><span class="hl_vardecl"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a name="loc_90_40_90_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_40_90_43&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_90_44_90_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_44_90_50&#39;)"><span class="hl_vardecl"><span class="mpre">bStep&#39;</span></span></a><span class="mpre"> -&gt; do
                        let </span><a name="loc_91_29_91_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_29_91_33&#39;)"><span class="hl_vardecl"><span class="mpre">buf&#39;</span></span></a><span class="mpre"> = </span><a href="Blaze.ByteString.Builder.Internal.Buffer.html#loc_127_1_127_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Buffer.html#loc_127_1_127_17&#39;)"><span class="hl_varref"><span class="mpre">updateEndOfSlice</span></span></a><span class="mpre"> </span><a href="#loc_84_18_84_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_18_84_21&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> </span><a href="#loc_90_40_90_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_40_90_43&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre">
                            </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_93_29_93_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_29_93_33&#39;)"><span class="mpre">cont</span></a><span class="mpre"> #-}</span></span><span class="mpre">
                            </span><a name="loc_93_29_93_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_29_93_33&#39;)"><span class="hl_fundecl"><span class="mpre">cont</span></span></a><span class="mpre"> </span><a name="loc_93_34_93_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_34_93_37&#39;)"><span class="hl_vardecl"><span class="mpre">mbs</span></span></a><span class="mpre"> = do
                                </span><span class="hl_comment"><span class="mpre">-- sequencing the computation of the next buffer</span></span><span class="mpre">
                                </span><span class="hl_comment"><span class="mpre">-- construction here ensures that the reference to the</span></span><span class="mpre">
                                </span><span class="hl_comment"><span class="mpre">-- foreign pointer `fp` is lost as soon as possible.</span></span><span class="mpre">
                                </span><a name="loc_97_33_97_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_33_97_39&#39;)"><span class="hl_vardecl"><span class="mpre">ioBuf&#39;</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_64_26_64_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_26_64_33&#39;)"><span class="hl_varref"><span class="mpre">nextBuf</span></span></a><span class="mpre"> </span><a href="#loc_90_32_90_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_32_90_39&#39;)"><span class="hl_varref"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a href="#loc_91_29_91_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_29_91_33&#39;)"><span class="hl_varref"><span class="mpre">buf&#39;</span></span></a><span class="mpre">
                                </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_79_12_79_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_12_79_18&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre"> </span><a href="#loc_97_33_97_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_33_97_39&#39;)"><span class="hl_varref"><span class="mpre">ioBuf&#39;</span></span></a><span class="mpre">
                                </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_79_19_79_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_19_79_26&#39;)"><span class="hl_varref"><span class="mpre">refStep</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Left</span></span><span class="mpre"> </span><a href="#loc_90_44_90_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_44_90_50&#39;)"><span class="hl_varref"><span class="mpre">bStep&#39;</span></span></a><span class="mpre">
                                case </span><a href="#loc_93_34_93_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_34_93_37&#39;)"><span class="hl_varref"><span class="mpre">mbs</span></span></a><span class="mpre"> of
                                    </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_101_42_101_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_42_101_44&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> | </span><span class="hl_varref"><span class="mpre">not</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">S.null</span></span><span class="mpre"> </span><a href="#loc_101_42_101_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_42_101_44&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_101_42_101_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_42_101_44&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
                                    _ -&gt; </span><a href="#loc_79_5_79_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_5_79_11&#39;)"><span class="hl_varref"><span class="mpre">popper</span></span></a><span class="mpre"> </span><a href="#loc_79_12_79_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_12_79_18&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre"> </span><a href="#loc_79_19_79_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_19_79_26&#39;)"><span class="hl_varref"><span class="mpre">refStep</span></span></a><span class="mpre">
                        </span><a href="#loc_93_29_93_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_29_93_33&#39;)"><span class="hl_varref"><span class="mpre">cont</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Buffer.html#loc_118_1_118_27" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Buffer.html#loc_118_1_118_27&#39;)"><span class="hl_varref"><span class="mpre">unsafeFreezeNonEmptyBuffer</span></span></a><span class="mpre"> </span><a href="#loc_91_29_91_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_29_91_33&#39;)"><span class="hl_varref"><span class="mpre">buf&#39;</span></span></a><span class="mpre">
                    </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_43_5_43_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_43_5_43_21&#39;)"><span class="hl_conref"><span class="mpre">InsertByteString</span></span></a><span class="mpre"> </span><a name="loc_104_38_104_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_38_104_41&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_104_42_104_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_42_104_44&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_104_45_104_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_45_104_51&#39;)"><span class="hl_vardecl"><span class="mpre">bStep&#39;</span></span></a><span class="mpre"> -&gt; do
                        let </span><a name="loc_105_29_105_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_29_105_33&#39;)"><span class="hl_vardecl"><span class="mpre">buf&#39;</span></span></a><span class="mpre"> = </span><a href="Blaze.ByteString.Builder.Internal.Buffer.html#loc_127_1_127_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Buffer.html#loc_127_1_127_17&#39;)"><span class="hl_varref"><span class="mpre">updateEndOfSlice</span></span></a><span class="mpre"> </span><a href="#loc_84_18_84_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_18_84_21&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> </span><a href="#loc_104_38_104_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_38_104_41&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre">
                        let </span><a name="loc_106_29_106_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_29_106_36&#39;)"><span class="hl_vardecl"><span class="mpre">yieldBS</span></span></a><span class="mpre"> = do
                                </span><a href="#loc_64_26_64_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_26_64_33&#39;)"><span class="hl_varref"><span class="mpre">nextBuf</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> </span><a href="#loc_105_29_105_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_29_105_33&#39;)"><span class="hl_varref"><span class="mpre">buf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_79_12_79_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_12_79_18&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre">
                                </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_79_19_79_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_19_79_26&#39;)"><span class="hl_varref"><span class="mpre">refStep</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Left</span></span><span class="mpre"> </span><a href="#loc_104_45_104_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_45_104_51&#39;)"><span class="hl_varref"><span class="mpre">bStep&#39;</span></span></a><span class="mpre">
                                if </span><span class="hl_varref"><span class="mpre">S.null</span></span><span class="mpre"> </span><a href="#loc_104_42_104_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_42_104_44&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
                                    then </span><a href="#loc_79_5_79_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_5_79_11&#39;)"><span class="hl_varref"><span class="mpre">popper</span></span></a><span class="mpre"> </span><a href="#loc_79_12_79_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_12_79_18&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre"> </span><a href="#loc_79_19_79_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_19_79_26&#39;)"><span class="hl_varref"><span class="mpre">refStep</span></span></a><span class="mpre">
                                    else </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_104_42_104_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_42_104_44&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
                        case </span><a href="Blaze.ByteString.Builder.Internal.Buffer.html#loc_118_1_118_27" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Buffer.html#loc_118_1_118_27&#39;)"><span class="hl_varref"><span class="mpre">unsafeFreezeNonEmptyBuffer</span></span></a><span class="mpre"> </span><a href="#loc_105_29_105_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_29_105_33&#39;)"><span class="hl_varref"><span class="mpre">buf&#39;</span></span></a><span class="mpre"> of
                            </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; </span><a href="#loc_106_29_106_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_29_106_36&#39;)"><span class="hl_varref"><span class="mpre">yieldBS</span></span></a><span class="mpre">
                            </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_114_34_114_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_34_114_37&#39;)"><span class="hl_vardecl"><span class="mpre">bs&#39;</span></span></a><span class="mpre"> -&gt; do
                                </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_79_19_79_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_19_79_26&#39;)"><span class="hl_varref"><span class="mpre">refStep</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Right</span></span><span class="mpre"> </span><a href="#loc_106_29_106_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_29_106_36&#39;)"><span class="hl_varref"><span class="mpre">yieldBS</span></span></a><span class="mpre">
                                </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_114_34_114_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_34_114_37&#39;)"><span class="hl_varref"><span class="mpre">bs&#39;</span></span></a><span class="mpre">
            </span><span class="hl_conref"><span class="mpre">Right</span></span><span class="mpre"> </span><a name="loc_117_19_117_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_19_117_25&#39;)"><span class="hl_vardecl"><span class="mpre">action</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_117_19_117_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_19_117_25&#39;)"><span class="hl_varref"><span class="mpre">action</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">{-
helper :: (MonadBase base m, PrimMonad base, Monad (t m), MonadTrans t)
       =&gt; t m (Maybe (Flush Builder))
       -&gt; (Flush S.ByteString -&gt; t m ())
       -&gt; BufferAllocStrategy
       -&gt; t m ()
helper await&#39; yield&#39; (ioBufInit, nextBuf) =
    loop ioBufInit
  where
    loop ioBuf = do
        await&#39; &gt;&gt;= maybe (close ioBuf) (cont&#39; ioBuf)

    cont&#39; ioBuf Flush = push ioBuf flush $ \ioBuf&#39; -&gt; yield&#39; Flush &gt;&gt; loop ioBuf&#39;
    cont&#39; ioBuf (Chunk builder) = push ioBuf builder loop

    close ioBuf = do
        buf &lt;- lift $ unsafeLiftIO $ ioBuf
        maybe (return ()) (yield&#39; . Chunk) (unsafeFreezeNonEmptyBuffer buf)
-}</span></span><span class="mpre">
</span></div></body></html>