<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE Trustworthy #-}
{-# LANGUAGE DeriveDataTypeable, BangPatterns #-}
{-# OPTIONS_GHC -funbox-strict-fields #-}

</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      :  Control.Concurrent.QSem</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   :  (c) The University of Glasgow 2001</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     :  BSD-style (see the file libraries/base/LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- </span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  :  libraries@haskell.org</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   :  experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability :  non-portable (concurrency)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Simple quantity semaphores.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">

module Control.Concurrent.QSem
        ( </span><span class="hl_comment"><span class="mpre">-- * Simple Quantity Semaphores</span></span><span class="mpre">
          QSem,         </span><span class="hl_comment"><span class="mpre">-- abstract</span></span><span class="mpre">
          newQSem,      </span><span class="hl_comment"><span class="mpre">-- :: Int  -&gt; IO QSem</span></span><span class="mpre">
          waitQSem,     </span><span class="hl_comment"><span class="mpre">-- :: QSem -&gt; IO ()</span></span><span class="mpre">
          signalQSem    </span><span class="hl_comment"><span class="mpre">-- :: QSem -&gt; IO ()</span></span><span class="mpre">
        ) where

import Control.Concurrent.MVar ( </span><a href="GHC.MVar.html#loc_39_6_39_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_39_6_39_10&#39;)"><span class="mpre">MVar</span></a><span class="mpre">, </span><a href="GHC.MVar.html#loc_64_1_64_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_64_1_64_13&#39;)"><span class="mpre">newEmptyMVar</span></a><span class="mpre">, </span><a href="GHC.MVar.html#loc_91_1_91_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_91_1_91_9&#39;)"><span class="mpre">takeMVar</span></a><span class="mpre">, </span><a href="GHC.MVar.html#loc_142_1_142_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_142_1_142_12&#39;)"><span class="mpre">tryTakeMVar</span></a><span class="mpre">
                          , </span><a href="GHC.MVar.html#loc_133_1_133_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_133_1_133_8&#39;)"><span class="mpre">putMVar</span></a><span class="mpre">, </span><a href="GHC.MVar.html#loc_70_1_70_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_70_1_70_8&#39;)"><span class="mpre">newMVar</span></a><span class="mpre">, </span><a href="GHC.MVar.html#loc_151_1_151_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_151_1_151_11&#39;)"><span class="mpre">tryPutMVar</span></a><span class="mpre">)
import Control.Exception
import Data.Maybe

</span><span class="hl_comment"><span class="mpre">-- | &#39;QSem&#39; is a quantity semaphore in which the resource is aqcuired</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- and released in units of one. It provides guaranteed FIFO ordering</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- for satisfying blocked `waitQSem` calls.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The pattern</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt;   bracket_ waitQSem signalQSem (...)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- is safe; it never loses a unit of the resource.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
data </span><a name="loc_42_6_42_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_6_42_10&#39;)"><span class="hl_tycondecl"><span class="mpre">QSem</span></span></a><span class="mpre"> = </span><a name="loc_42_13_42_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_13_42_17&#39;)"><span class="hl_condecl"><span class="mpre">QSem</span></span></a><span class="mpre"> !(</span><a href="GHC.MVar.html#loc_39_6_39_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_39_6_39_10&#39;)"><span class="hl_tyconref"><span class="mpre">MVar</span></span></a><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">, [</span><a href="GHC.MVar.html#loc_39_6_39_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_39_6_39_10&#39;)"><span class="hl_tyconref"><span class="mpre">MVar</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">], [</span><a href="GHC.MVar.html#loc_39_6_39_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_39_6_39_10&#39;)"><span class="hl_tyconref"><span class="mpre">MVar</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">]))

</span><span class="hl_comment"><span class="mpre">-- The semaphore state (i, xs, ys):</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   i is the current resource value</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   (xs,ys) is the queue of blocked threads, where the queue is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--           given by xs ++ reverse ys.  We can enqueue new blocked threads</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--           by consing onto ys, and dequeue by removing from the head of xs.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- A blocked thread is represented by an empty (MVar ()).  To unblock</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the thread, we put () into the MVar.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- A thread can dequeue itself by also putting () into the MVar, which</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- it must do if it receives an exception while blocked in waitQSem.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This means that when unblocking a thread in signalQSem we must</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- first check whether the MVar is already full; the MVar lock on the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- semaphore itself resolves race conditions between signalQSem and a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- thread attempting to dequeue itself.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- |Build a new &#39;QSem&#39; with a supplied initial quantity.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--  The initial quantity must be at least 0.</span></span><span class="mpre">
</span><a href="#loc_65_1_65_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_1_65_8&#39;)"><span class="mpre">newQSem</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_42_6_42_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_6_42_10&#39;)"><span class="hl_tyconref"><span class="mpre">QSem</span></span></a><span class="mpre">
</span><a name="loc_65_1_65_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_1_65_8&#39;)"><span class="hl_fundecl"><span class="mpre">newQSem</span></span></a><span class="mpre"> </span><a name="loc_65_9_65_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_9_65_16&#39;)"><span class="hl_vardecl"><span class="mpre">initial</span></span></a><span class="mpre">
  | </span><a href="#loc_65_9_65_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_9_65_16&#39;)"><span class="hl_varref"><span class="mpre">initial</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;newQSem: Initial quantity must be non-negative&quot;</span></span><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">   = do
      </span><a name="loc_68_7_68_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_7_68_10&#39;)"><span class="hl_vardecl"><span class="mpre">sem</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.MVar.html#loc_70_1_70_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_70_1_70_8&#39;)"><span class="hl_varref"><span class="mpre">newMVar</span></span></a><span class="mpre"> (</span><a href="#loc_65_9_65_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_9_65_16&#39;)"><span class="hl_varref"><span class="mpre">initial</span></span></a><span class="mpre">, [], [])
      </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_42_13_42_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_13_42_17&#39;)"><span class="hl_conref"><span class="mpre">QSem</span></span></a><span class="mpre"> </span><a href="#loc_68_7_68_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_7_68_10&#39;)"><span class="hl_varref"><span class="mpre">sem</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- |Wait for a unit to become available</span></span><span class="mpre">
</span><a href="#loc_73_1_73_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_1_73_9&#39;)"><span class="mpre">waitQSem</span></a><span class="mpre"> :: </span><a href="#loc_42_6_42_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_6_42_10&#39;)"><span class="hl_tyconref"><span class="mpre">QSem</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_73_1_73_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_1_73_9&#39;)"><span class="hl_fundecl"><span class="mpre">waitQSem</span></span></a><span class="mpre"> (</span><a href="#loc_42_13_42_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_13_42_17&#39;)"><span class="hl_conref"><span class="mpre">QSem</span></span></a><span class="mpre"> </span><a name="loc_73_16_73_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_16_73_17&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre">) =
  </span><a href="GHC.IO.html#loc_426_1_426_6" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_426_1_426_6&#39;)"><span class="hl_varref"><span class="mpre">mask_</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
    (</span><a name="loc_75_6_75_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_6_75_7&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre">,</span><a name="loc_75_8_75_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_8_75_10&#39;)"><span class="hl_vardecl"><span class="mpre">b1</span></span></a><span class="mpre">,</span><a name="loc_75_11_75_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_11_75_13&#39;)"><span class="hl_vardecl"><span class="mpre">b2</span></span></a><span class="mpre">) &lt;- </span><a href="GHC.MVar.html#loc_91_1_91_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_91_1_91_9&#39;)"><span class="hl_varref"><span class="mpre">takeMVar</span></span></a><span class="mpre"> </span><a href="#loc_73_16_73_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_16_73_17&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre">
    if </span><a href="#loc_75_6_75_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_6_75_7&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
       then do
         </span><a name="loc_78_10_78_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_10_78_11&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.MVar.html#loc_64_1_64_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_64_1_64_13&#39;)"><span class="hl_varref"><span class="mpre">newEmptyMVar</span></span></a><span class="mpre">
         </span><a href="GHC.MVar.html#loc_133_1_133_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_133_1_133_8&#39;)"><span class="hl_varref"><span class="mpre">putMVar</span></span></a><span class="mpre"> </span><a href="#loc_73_16_73_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_16_73_17&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> (</span><a href="#loc_75_6_75_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_6_75_7&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre">, </span><a href="#loc_75_8_75_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_8_75_10&#39;)"><span class="hl_varref"><span class="mpre">b1</span></span></a><span class="mpre">, </span><a href="#loc_78_10_78_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_10_78_11&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a href="#loc_75_11_75_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_11_75_13&#39;)"><span class="hl_varref"><span class="mpre">b2</span></span></a><span class="mpre">)
         </span><a href="#loc_86_5_86_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_5_86_9&#39;)"><span class="hl_varref"><span class="mpre">wait</span></span></a><span class="mpre"> </span><a href="#loc_78_10_78_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_10_78_11&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">
       else do
         let !</span><a name="loc_82_15_82_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_15_82_16&#39;)"><span class="hl_vardecl"><span class="mpre">z</span></span></a><span class="mpre"> = </span><a href="#loc_75_6_75_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_6_75_7&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">
         </span><a href="GHC.MVar.html#loc_133_1_133_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_133_1_133_8&#39;)"><span class="hl_varref"><span class="mpre">putMVar</span></span></a><span class="mpre"> </span><a href="#loc_73_16_73_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_16_73_17&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> (</span><a href="#loc_82_15_82_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_15_82_16&#39;)"><span class="hl_varref"><span class="mpre">z</span></span></a><span class="mpre">, </span><a href="#loc_75_8_75_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_8_75_10&#39;)"><span class="hl_varref"><span class="mpre">b1</span></span></a><span class="mpre">, </span><a href="#loc_75_11_75_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_11_75_13&#39;)"><span class="hl_varref"><span class="mpre">b2</span></span></a><span class="mpre">)
         </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
  where
    </span><a name="loc_86_5_86_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_5_86_9&#39;)"><span class="hl_fundecl"><span class="mpre">wait</span></span></a><span class="mpre"> </span><a name="loc_86_10_86_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_10_86_11&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> = </span><a href="GHC.MVar.html#loc_91_1_91_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_91_1_91_9&#39;)"><span class="hl_varref"><span class="mpre">takeMVar</span></span></a><span class="mpre"> </span><a href="#loc_86_10_86_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_10_86_11&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><a href="Control.Exception.Base.html#loc_229_1_229_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_229_1_229_12&#39;)"><span class="hl_infix"><span class="mpre">`onException`</span></span></a><span class="mpre"> do
                (</span><a href="GHC.IO.html#loc_434_1_434_21" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_434_1_434_21&#39;)"><span class="hl_varref"><span class="mpre">uninterruptibleMask_</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do </span><span class="hl_comment"><span class="mpre">-- Note [signal uninterruptible]</span></span><span class="mpre">
                   (</span><a name="loc_88_21_88_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_88_21_88_22&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre">,</span><a name="loc_88_23_88_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_88_23_88_25&#39;)"><span class="hl_vardecl"><span class="mpre">b1</span></span></a><span class="mpre">,</span><a name="loc_88_26_88_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_88_26_88_28&#39;)"><span class="hl_vardecl"><span class="mpre">b2</span></span></a><span class="mpre">) &lt;- </span><a href="GHC.MVar.html#loc_91_1_91_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_91_1_91_9&#39;)"><span class="hl_varref"><span class="mpre">takeMVar</span></span></a><span class="mpre"> </span><a href="#loc_73_16_73_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_16_73_17&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre">
                   </span><a name="loc_89_20_89_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_20_89_21&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.MVar.html#loc_142_1_142_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_142_1_142_12&#39;)"><span class="hl_varref"><span class="mpre">tryTakeMVar</span></span></a><span class="mpre"> </span><a href="#loc_86_10_86_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_10_86_11&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">
                   </span><a name="loc_90_20_90_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_20_90_22&#39;)"><span class="hl_vardecl"><span class="mpre">r&#39;</span></span></a><span class="mpre"> &lt;- if </span><a href="Data.Maybe.html#loc_80_1_80_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_80_1_80_7&#39;)"><span class="hl_varref"><span class="mpre">isJust</span></span></a><span class="mpre"> </span><a href="#loc_89_20_89_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_20_89_21&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">
                            then </span><a href="#loc_120_1_120_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_1_120_7&#39;)"><span class="hl_varref"><span class="mpre">signal</span></span></a><span class="mpre"> (</span><a href="#loc_88_21_88_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_88_21_88_22&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre">,</span><a href="#loc_88_23_88_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_88_23_88_25&#39;)"><span class="hl_varref"><span class="mpre">b1</span></span></a><span class="mpre">,</span><a href="#loc_88_26_88_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_88_26_88_28&#39;)"><span class="hl_varref"><span class="mpre">b2</span></span></a><span class="mpre">)
                            else do </span><a href="GHC.MVar.html#loc_133_1_133_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_133_1_133_8&#39;)"><span class="hl_varref"><span class="mpre">putMVar</span></span></a><span class="mpre"> </span><a href="#loc_86_10_86_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_10_86_11&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_88_21_88_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_88_21_88_22&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre">,</span><a href="#loc_88_23_88_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_88_23_88_25&#39;)"><span class="hl_varref"><span class="mpre">b1</span></span></a><span class="mpre">,</span><a href="#loc_88_26_88_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_88_26_88_28&#39;)"><span class="hl_varref"><span class="mpre">b2</span></span></a><span class="mpre">)
                   </span><a href="GHC.MVar.html#loc_133_1_133_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_133_1_133_8&#39;)"><span class="hl_varref"><span class="mpre">putMVar</span></span></a><span class="mpre"> </span><a href="#loc_73_16_73_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_16_73_17&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><a href="#loc_90_20_90_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_20_90_22&#39;)"><span class="hl_varref"><span class="mpre">r&#39;</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- |Signal that a unit of the &#39;QSem&#39; is available</span></span><span class="mpre">
</span><a href="#loc_97_1_97_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_1_97_11&#39;)"><span class="mpre">signalQSem</span></a><span class="mpre"> :: </span><a href="#loc_42_6_42_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_6_42_10&#39;)"><span class="hl_tyconref"><span class="mpre">QSem</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_97_1_97_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_1_97_11&#39;)"><span class="hl_fundecl"><span class="mpre">signalQSem</span></span></a><span class="mpre"> (</span><a href="#loc_42_13_42_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_13_42_17&#39;)"><span class="hl_conref"><span class="mpre">QSem</span></span></a><span class="mpre"> </span><a name="loc_97_18_97_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_18_97_19&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre">) =
  </span><a href="GHC.IO.html#loc_434_1_434_21" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_434_1_434_21&#39;)"><span class="hl_varref"><span class="mpre">uninterruptibleMask_</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do </span><span class="hl_comment"><span class="mpre">-- Note [signal uninterruptible]</span></span><span class="mpre">
    </span><a name="loc_99_5_99_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_5_99_6&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.MVar.html#loc_91_1_91_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_91_1_91_9&#39;)"><span class="hl_varref"><span class="mpre">takeMVar</span></span></a><span class="mpre"> </span><a href="#loc_97_18_97_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_18_97_19&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre">
    </span><a name="loc_100_5_100_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_100_5_100_7&#39;)"><span class="hl_vardecl"><span class="mpre">r&#39;</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_120_1_120_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_1_120_7&#39;)"><span class="hl_varref"><span class="mpre">signal</span></span></a><span class="mpre"> </span><a href="#loc_99_5_99_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_5_99_6&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">
    </span><a href="GHC.MVar.html#loc_133_1_133_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_133_1_133_8&#39;)"><span class="hl_varref"><span class="mpre">putMVar</span></span></a><span class="mpre"> </span><a href="#loc_97_18_97_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_18_97_19&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><a href="#loc_100_5_100_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_100_5_100_7&#39;)"><span class="hl_varref"><span class="mpre">r&#39;</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Note [signal uninterruptible]</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   If we have</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      bracket waitQSem signalQSem (...)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   and an exception arrives at the signalQSem, then we must not lose</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   the resource.  The signalQSem is masked by bracket, but taking</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   the MVar might block, and so it would be interruptible.  Hence we</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   need an uninterruptibleMask here.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   This isn&#39;t ideal: during high contention, some threads won&#39;t be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   interruptible.  The QSemSTM implementation has better behaviour</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   here, but it performs much worse than this one in some</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   benchmarks.</span></span><span class="mpre">

</span><a href="#loc_120_1_120_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_1_120_7&#39;)"><span class="mpre">signal</span></a><span class="mpre"> :: (</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">,[</span><a href="GHC.MVar.html#loc_39_6_39_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_39_6_39_10&#39;)"><span class="hl_tyconref"><span class="mpre">MVar</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">],[</span><a href="GHC.MVar.html#loc_39_6_39_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_39_6_39_10&#39;)"><span class="hl_tyconref"><span class="mpre">MVar</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">]) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">,[</span><a href="GHC.MVar.html#loc_39_6_39_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_39_6_39_10&#39;)"><span class="hl_tyconref"><span class="mpre">MVar</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">],[</span><a href="GHC.MVar.html#loc_39_6_39_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_39_6_39_10&#39;)"><span class="hl_tyconref"><span class="mpre">MVar</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">])
</span><a name="loc_120_1_120_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_1_120_7&#39;)"><span class="hl_fundecl"><span class="mpre">signal</span></span></a><span class="mpre"> (</span><a name="loc_120_9_120_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_9_120_10&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre">,</span><a name="loc_120_11_120_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_11_120_13&#39;)"><span class="hl_vardecl"><span class="mpre">a1</span></span></a><span class="mpre">,</span><a name="loc_120_14_120_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_14_120_16&#39;)"><span class="hl_vardecl"><span class="mpre">a2</span></span></a><span class="mpre">) =
 if </span><a href="#loc_120_9_120_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_9_120_10&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
   then </span><a href="#loc_125_4_125_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_4_125_8&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> </span><a href="#loc_120_11_120_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_11_120_13&#39;)"><span class="hl_varref"><span class="mpre">a1</span></span></a><span class="mpre"> </span><a href="#loc_120_14_120_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_14_120_16&#39;)"><span class="hl_varref"><span class="mpre">a2</span></span></a><span class="mpre">
   else let !</span><a name="loc_123_14_123_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_123_14_123_15&#39;)"><span class="hl_vardecl"><span class="mpre">z</span></span></a><span class="mpre"> = </span><a href="#loc_120_9_120_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_9_120_10&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> in </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_123_14_123_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_123_14_123_15&#39;)"><span class="hl_varref"><span class="mpre">z</span></span></a><span class="mpre">, </span><a href="#loc_120_11_120_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_11_120_13&#39;)"><span class="hl_varref"><span class="mpre">a1</span></span></a><span class="mpre">, </span><a href="#loc_120_14_120_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_14_120_16&#39;)"><span class="hl_varref"><span class="mpre">a2</span></span></a><span class="mpre">)
 where
   </span><a name="loc_125_4_125_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_4_125_8&#39;)"><span class="hl_fundecl"><span class="mpre">loop</span></span></a><span class="mpre"> [] [] = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">, [], [])
   </span><a href="#loc_125_4_125_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_4_125_8&#39;)"><span class="hl_fundecl"><span class="mpre">loop</span></span></a><span class="mpre"> [] </span><a name="loc_126_12_126_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_12_126_14&#39;)"><span class="hl_vardecl"><span class="mpre">b2</span></span></a><span class="mpre"> = </span><a href="#loc_125_4_125_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_4_125_8&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">reverse</span></span><span class="mpre"> </span><a href="#loc_126_12_126_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_12_126_14&#39;)"><span class="hl_varref"><span class="mpre">b2</span></span></a><span class="mpre">) []
   </span><a href="#loc_125_4_125_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_4_125_8&#39;)"><span class="hl_fundecl"><span class="mpre">loop</span></span></a><span class="mpre"> (</span><a name="loc_127_10_127_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_10_127_11&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_127_12_127_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_12_127_14&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre">) </span><a name="loc_127_16_127_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_16_127_18&#39;)"><span class="hl_vardecl"><span class="mpre">b2</span></span></a><span class="mpre"> = do
     </span><a name="loc_128_6_128_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_128_6_128_7&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.MVar.html#loc_151_1_151_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_151_1_151_11&#39;)"><span class="hl_varref"><span class="mpre">tryPutMVar</span></span></a><span class="mpre"> </span><a href="#loc_127_10_127_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_10_127_11&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
     if </span><a href="#loc_128_6_128_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_128_6_128_7&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">, </span><a href="#loc_127_12_127_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_12_127_14&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">, </span><a href="#loc_127_16_127_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_16_127_18&#39;)"><span class="hl_varref"><span class="mpre">b2</span></span></a><span class="mpre">)
          else </span><a href="#loc_125_4_125_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_4_125_8&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> </span><a href="#loc_127_12_127_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_12_127_14&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="#loc_127_16_127_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_16_127_18&#39;)"><span class="hl_varref"><span class="mpre">b2</span></span></a><span class="mpre">
</span></div></body></html>