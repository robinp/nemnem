<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="hl_comment"><span class="mpre">-- Transactional memory for sequential implementations.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Transactions do not run concurrently, but are atomic in the face</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- of exceptions.</span></span><span class="mpre">

{-# LANGUAGE CPP #-}

#if __GLASGOW_HASKELL__ &gt;= 701
{-# LANGUAGE Trustworthy #-}
#endif

</span><span class="hl_comment"><span class="mpre">-- #hide</span></span><span class="mpre">
module Control.Sequential.STM (
        STM, atomically, throwSTM, catchSTM,
        TVar, newTVar, newTVarIO, readTVar, readTVarIO, writeTVar
    ) where

#if __GLASGOW_HASKELL__ &lt; 705
import Prelude hiding (catch)
#endif
import Control.Applicative (</span><a href="Control.Applicative.html#loc_113_20_113_31" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_113_20_113_31&#39;)"><span class="mpre">Applicative</span></a><span class="mpre">(</span><a href="Control.Applicative.html#loc_115_5_115_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_115_5_115_9&#39;)"><span class="mpre">pure</span></a><span class="mpre">, </span><a href="Control.Applicative.html#loc_118_5_118_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_118_5_118_10&#39;)"><span class="mpre">(&lt;*&gt;)</span></a><span class="mpre">))
import Control.Exception
import Data.IORef

</span><span class="hl_comment"><span class="mpre">-- The reference contains a rollback action to be executed on exceptions</span></span><span class="mpre">
newtype </span><a name="loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tycondecl"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> = </span><a name="loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_condecl"><span class="mpre">STM</span></span></a><span class="mpre"> (</span><a href="GHC.IORef.html#loc_34_9_34_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_34_9_34_14&#39;)"><span class="hl_tyconref"><span class="mpre">IORef</span></span></a><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)

</span><a href="#loc_28_1_28_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_28_1_28_6&#39;)"><span class="mpre">unSTM</span></a><span class="mpre"> :: </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><a href="GHC.IORef.html#loc_34_9_34_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_34_9_34_14&#39;)"><span class="hl_tyconref"><span class="mpre">IORef</span></span></a><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_28_1_28_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_28_1_28_6&#39;)"><span class="hl_fundecl"><span class="mpre">unSTM</span></span></a><span class="mpre"> (</span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><a name="loc_28_12_28_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_28_12_28_13&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre">) = </span><a href="#loc_28_12_28_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_28_12_28_13&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre">

instance </span><span class="hl_classref"><span class="mpre">Functor</span></span><span class="mpre"> </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> where
    </span><span class="hl_fundecl"><span class="mpre">fmap</span></span><span class="mpre"> </span><a name="loc_31_10_31_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_31_10_31_11&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> (</span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><a name="loc_31_17_31_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_31_17_31_18&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre">) = </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> </span><a href="#loc_31_10_31_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_31_10_31_11&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_31_17_31_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_31_17_31_18&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre">)

instance </span><a href="Control.Applicative.html#loc_113_20_113_31" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_113_20_113_31&#39;)"><span class="hl_classref"><span class="mpre">Applicative</span></span></a><span class="mpre"> </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> where
    </span><a href="Control.Applicative.html#loc_115_5_115_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_115_5_115_9&#39;)"><span class="hl_vardecl"><span class="mpre">pure</span></span></a><span class="mpre"> = </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">const</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Control.Applicative.html#loc_115_5_115_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_115_5_115_9&#39;)"><span class="hl_varref"><span class="mpre">pure</span></span></a><span class="mpre">
    </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><a name="loc_35_9_35_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_9_35_11&#39;)"><span class="hl_vardecl"><span class="mpre">mf</span></span></a><span class="mpre"> </span><a href="Control.Applicative.html#loc_118_5_118_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_118_5_118_10&#39;)"><span class="hl_fundecl"><span class="mpre">&lt;*&gt;</span></span></a><span class="mpre"> </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><a name="loc_35_20_35_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_20_35_22&#39;)"><span class="hl_vardecl"><span class="mpre">mx</span></span></a><span class="mpre"> = </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \ </span><a name="loc_35_33_35_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_33_35_34&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_35_9_35_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_9_35_11&#39;)"><span class="hl_varref"><span class="mpre">mf</span></span></a><span class="mpre"> </span><a href="#loc_35_33_35_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_33_35_34&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> </span><a href="Control.Applicative.html#loc_118_5_118_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_118_5_118_10&#39;)"><span class="hl_infix"><span class="mpre">&lt;*&gt;</span></span></a><span class="mpre"> </span><a href="#loc_35_20_35_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_20_35_22&#39;)"><span class="hl_varref"><span class="mpre">mx</span></span></a><span class="mpre"> </span><a href="#loc_35_33_35_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_33_35_34&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">

instance </span><span class="hl_classref"><span class="mpre">Monad</span></span><span class="mpre"> </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> where
    </span><span class="hl_vardecl"><span class="mpre">return</span></span><span class="mpre"> = </span><a href="Control.Applicative.html#loc_115_5_115_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_115_5_115_9&#39;)"><span class="hl_varref"><span class="mpre">pure</span></span></a><span class="mpre">
    </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><a name="loc_39_9_39_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_9_39_10&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre"> </span><span class="hl_fundecl"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a name="loc_39_15_39_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_15_39_16&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> = </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \ </span><a name="loc_39_27_39_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_27_39_28&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> -&gt; do
        </span><a name="loc_40_9_40_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_40_9_40_10&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_39_9_39_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_9_39_10&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><a href="#loc_39_27_39_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_27_39_28&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">
        </span><a href="#loc_28_1_28_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_28_1_28_6&#39;)"><span class="hl_varref"><span class="mpre">unSTM</span></span></a><span class="mpre"> (</span><a href="#loc_39_15_39_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_15_39_16&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_40_9_40_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_40_9_40_10&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">) </span><a href="#loc_39_27_39_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_27_39_28&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">

</span><a href="#loc_44_1_44_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_44_1_44_11&#39;)"><span class="mpre">atomically</span></a><span class="mpre"> :: </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_44_1_44_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_44_1_44_11&#39;)"><span class="hl_fundecl"><span class="mpre">atomically</span></span></a><span class="mpre"> (</span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><a name="loc_44_17_44_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_44_17_44_18&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre">) = do
    </span><a name="loc_45_5_45_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_5_45_6&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_42_1_42_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_42_1_42_9&#39;)"><span class="hl_varref"><span class="mpre">newIORef</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">)
    </span><a href="#loc_44_17_44_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_44_17_44_18&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><a href="#loc_45_5_45_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_5_45_6&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> </span><a href="Control.Exception.Base.html#loc_229_1_229_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_229_1_229_12&#39;)"><span class="hl_infix"><span class="mpre">`onException`</span></span></a><span class="mpre"> do
        </span><a name="loc_47_9_47_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_9_47_17&#39;)"><span class="hl_vardecl"><span class="mpre">rollback</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_45_5_45_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_5_45_6&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">
        </span><a href="#loc_47_9_47_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_9_47_17&#39;)"><span class="hl_varref"><span class="mpre">rollback</span></span></a><span class="mpre">

</span><a href="#loc_51_1_51_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_1_51_9&#39;)"><span class="mpre">throwSTM</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Sequential/STM.hs&quot;, srcSpanStartLine = 50, srcSpanStartColumn = 13, srcSpanEndLine = 50, srcSpanEndColumn = 27}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Sequential/STM.hs&quot;, srcSpanStartLine = 50, srcSpanStartColumn = 25, srcSpanEndLine = 50, srcSpanEndColumn = 27}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Cont"><span class="mpre">Exception e =&gt;</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">e</span></span><span class="mpre"> -&gt; </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_51_1_51_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_1_51_9&#39;)"><span class="hl_vardecl"><span class="mpre">throwSTM</span></span></a><span class="mpre"> = </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">const</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="GHC.IO.html#loc_304_1_304_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_304_1_304_8&#39;)"><span class="hl_varref"><span class="mpre">throwIO</span></span></a><span class="mpre">

</span><a href="#loc_54_1_54_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_1_54_9&#39;)"><span class="mpre">catchSTM</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Sequential/STM.hs&quot;, srcSpanStartLine = 53, srcSpanStartColumn = 13, srcSpanEndLine = 53, srcSpanEndColumn = 27}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Sequential/STM.hs&quot;, srcSpanStartLine = 53, srcSpanStartColumn = 25, srcSpanEndLine = 53, srcSpanEndColumn = 27}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Cont"><span class="mpre">Exception e =&gt;</span></span><span class="mpre"> </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyvar"><span class="mpre">e</span></span><span class="mpre"> -&gt; </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_54_1_54_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_1_54_9&#39;)"><span class="hl_fundecl"><span class="mpre">catchSTM</span></span></a><span class="mpre"> (</span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><a name="loc_54_15_54_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_15_54_16&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre">) </span><a name="loc_54_18_54_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_18_54_19&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre"> = </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \ </span><a name="loc_54_30_54_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_30_54_31&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> -&gt; do
    </span><a name="loc_55_5_55_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_5_55_17&#39;)"><span class="hl_vardecl"><span class="mpre">old_rollback</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_54_30_54_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_30_54_31&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">
    </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_54_30_54_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_30_54_31&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">)
    </span><a name="loc_57_5_57_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_57_5_57_8&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> &lt;- </span><a href="Control.Exception.Base.html#loc_212_1_212_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_212_1_212_4&#39;)"><span class="hl_varref"><span class="mpre">try</span></span></a><span class="mpre"> (</span><a href="#loc_54_15_54_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_15_54_16&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><a href="#loc_54_30_54_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_30_54_31&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">)
    </span><a name="loc_58_5_58_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_5_58_15&#39;)"><span class="hl_vardecl"><span class="mpre">rollback_m</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_54_30_54_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_30_54_31&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">
    case </span><a href="#loc_57_5_57_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_57_5_57_8&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre"> of
        </span><span class="hl_conref"><span class="mpre">Left</span></span><span class="mpre"> </span><a name="loc_60_14_60_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_60_14_60_16&#39;)"><span class="hl_vardecl"><span class="mpre">ex</span></span></a><span class="mpre"> -&gt; do
            </span><a href="#loc_58_5_58_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_5_58_15&#39;)"><span class="hl_varref"><span class="mpre">rollback_m</span></span></a><span class="mpre">
            </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_54_30_54_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_30_54_31&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> </span><a href="#loc_55_5_55_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_5_55_17&#39;)"><span class="hl_varref"><span class="mpre">old_rollback</span></span></a><span class="mpre">
            </span><a href="#loc_28_1_28_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_28_1_28_6&#39;)"><span class="hl_varref"><span class="mpre">unSTM</span></span></a><span class="mpre"> (</span><a href="#loc_54_18_54_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_18_54_19&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> </span><a href="#loc_60_14_60_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_60_14_60_16&#39;)"><span class="hl_varref"><span class="mpre">ex</span></span></a><span class="mpre">) </span><a href="#loc_54_30_54_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_30_54_31&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">
        </span><span class="hl_conref"><span class="mpre">Right</span></span><span class="mpre"> </span><a name="loc_64_15_64_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_15_64_16&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> -&gt; do
            </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_54_30_54_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_30_54_31&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> (</span><a href="#loc_58_5_58_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_5_58_15&#39;)"><span class="hl_varref"><span class="mpre">rollback_m</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><a href="#loc_55_5_55_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_5_55_17&#39;)"><span class="hl_varref"><span class="mpre">old_rollback</span></span></a><span class="mpre">)
            </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_64_15_64_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_15_64_16&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">

newtype </span><a name="loc_68_9_68_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_9_68_13&#39;)"><span class="hl_tycondecl"><span class="mpre">TVar</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> = </span><a name="loc_68_18_68_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_18_68_22&#39;)"><span class="hl_condecl"><span class="mpre">TVar</span></span></a><span class="mpre"> (</span><a href="GHC.IORef.html#loc_34_9_34_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_34_9_34_14&#39;)"><span class="hl_tyconref"><span class="mpre">IORef</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
    </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Sequential/STM.hs&quot;, srcSpanStartLine = 69, srcSpanStartColumn = 5, srcSpanEndLine = 69, srcSpanEndColumn = 18}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Sequential/STM.hs&quot;, srcSpanStartLine = 69, srcSpanStartColumn = 5, srcSpanEndLine = 69, srcSpanEndColumn = 13},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Sequential/STM.hs&quot;, srcSpanStartLine "><span class="mpre">deriving (Eq)</span></span><span class="mpre">

</span><a href="#loc_72_1_72_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_1_72_8&#39;)"><span class="mpre">newTVar</span></a><span class="mpre"> :: </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> (</span><a href="#loc_68_9_68_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_9_68_13&#39;)"><span class="hl_tyconref"><span class="mpre">TVar</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_72_1_72_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_1_72_8&#39;)"><span class="hl_fundecl"><span class="mpre">newTVar</span></span></a><span class="mpre"> </span><a name="loc_72_9_72_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_9_72_10&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> = </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">const</span></span><span class="mpre"> (</span><a href="#loc_75_1_75_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_1_75_10&#39;)"><span class="hl_varref"><span class="mpre">newTVarIO</span></span></a><span class="mpre"> </span><a href="#loc_72_9_72_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_9_72_10&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">))

</span><a href="#loc_75_1_75_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_1_75_10&#39;)"><span class="mpre">newTVarIO</span></a><span class="mpre"> :: </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="#loc_68_9_68_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_9_68_13&#39;)"><span class="hl_tyconref"><span class="mpre">TVar</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_75_1_75_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_1_75_10&#39;)"><span class="hl_fundecl"><span class="mpre">newTVarIO</span></span></a><span class="mpre"> </span><a name="loc_75_11_75_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_11_75_12&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> = do
    </span><a name="loc_76_5_76_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_5_76_8&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_42_1_42_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_42_1_42_9&#39;)"><span class="hl_varref"><span class="mpre">newIORef</span></span></a><span class="mpre"> </span><a href="#loc_75_11_75_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_11_75_12&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_68_18_68_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_18_68_22&#39;)"><span class="hl_conref"><span class="mpre">TVar</span></span></a><span class="mpre"> </span><a href="#loc_76_5_76_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_5_76_8&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre">)

</span><a href="#loc_80_1_80_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_1_80_9&#39;)"><span class="mpre">readTVar</span></a><span class="mpre"> :: </span><a href="#loc_68_9_68_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_9_68_13&#39;)"><span class="hl_tyconref"><span class="mpre">TVar</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_80_1_80_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_1_80_9&#39;)"><span class="hl_fundecl"><span class="mpre">readTVar</span></span></a><span class="mpre"> (</span><a href="#loc_68_18_68_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_18_68_22&#39;)"><span class="hl_conref"><span class="mpre">TVar</span></span></a><span class="mpre"> </span><a name="loc_80_16_80_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_16_80_19&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre">) = </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">const</span></span><span class="mpre"> (</span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_80_16_80_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_16_80_19&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre">))

</span><a href="#loc_83_1_83_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_1_83_11&#39;)"><span class="mpre">readTVarIO</span></a><span class="mpre"> :: </span><a href="#loc_68_9_68_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_9_68_13&#39;)"><span class="hl_tyconref"><span class="mpre">TVar</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_83_1_83_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_1_83_11&#39;)"><span class="hl_fundecl"><span class="mpre">readTVarIO</span></span></a><span class="mpre"> (</span><a href="#loc_68_18_68_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_18_68_22&#39;)"><span class="hl_conref"><span class="mpre">TVar</span></span></a><span class="mpre"> </span><a name="loc_83_18_83_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_18_83_21&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre">) = </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_83_18_83_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_18_83_21&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre">

</span><a href="#loc_86_1_86_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_1_86_10&#39;)"><span class="mpre">writeTVar</span></a><span class="mpre"> :: </span><a href="#loc_68_9_68_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_9_68_13&#39;)"><span class="hl_tyconref"><span class="mpre">TVar</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><a href="#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_86_1_86_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_1_86_10&#39;)"><span class="hl_fundecl"><span class="mpre">writeTVar</span></span></a><span class="mpre"> (</span><a href="#loc_68_18_68_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_18_68_22&#39;)"><span class="hl_conref"><span class="mpre">TVar</span></span></a><span class="mpre"> </span><a name="loc_86_17_86_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_17_86_20&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre">) </span><a name="loc_86_22_86_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_22_86_23&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> = </span><a href="#loc_25_17_25_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_25_17_25_20&#39;)"><span class="hl_conref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \ </span><a name="loc_86_34_86_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_34_86_35&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> -&gt; do
    </span><a name="loc_87_5_87_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_5_87_11&#39;)"><span class="hl_vardecl"><span class="mpre">oldval</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_86_17_86_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_17_86_20&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre">
    </span><a href="Data.IORef.html#loc_70_1_70_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.IORef.html#loc_70_1_70_12&#39;)"><span class="hl_varref"><span class="mpre">modifyIORef</span></span></a><span class="mpre"> </span><a href="#loc_86_34_86_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_34_86_35&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> (</span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_86_17_86_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_17_86_20&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre"> </span><a href="#loc_87_5_87_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_5_87_11&#39;)"><span class="hl_varref"><span class="mpre">oldval</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre">)
    </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_86_17_86_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_17_86_20&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre"> </span><a href="#loc_86_22_86_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_22_86_23&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">
</span></div></body></html>