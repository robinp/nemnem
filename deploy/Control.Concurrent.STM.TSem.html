<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      :  Control.Concurrent.STM.TSem</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   :  (c) The University of Glasgow 2012</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     :  BSD-style (see the file libraries/base/LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- </span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  :  libraries@haskell.org</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   :  experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability :  non-portable (requires STM)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;TSem&#39;: transactional semaphores.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">

{-# LANGUAGE DeriveDataTypeable #-}
module Control.Concurrent.STM.TSem (
      TSem, newTSem, waitTSem, signalTSem
  ) where

import Control.Concurrent.STM
import Control.Monad
import Data.Typeable

</span><span class="hl_comment"><span class="mpre">-- | &#39;TSem&#39; is a transactional semaphore.  It holds a certain number</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- of units, and units may be acquired or released by &#39;waitTSem&#39; and</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;signalTSem&#39; respectively.  When the &#39;TSem&#39; is empty, &#39;waitTSem&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- blocks.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that &#39;TSem&#39; has no concept of fairness, and there is no</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- guarantee that threads blocked in `waitTSem` will be unblocked in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the same order; in fact they will all be unblocked at the same time</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- and will fight over the &#39;TSem&#39;.  Hence &#39;TSem&#39; is not suitable if</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- you expect there to be a high number of threads contending for the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- resource.  However, like other STM abstractions, &#39;TSem&#39; is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- composable.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
newtype </span><a name="loc_37_9_37_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_9_37_13&#39;)"><span class="hl_tycondecl"><span class="mpre">TSem</span></span></a><span class="mpre"> = </span><a name="loc_37_16_37_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_16_37_20&#39;)"><span class="hl_condecl"><span class="mpre">TSem</span></span></a><span class="mpre"> (</span><a href="Control.Sequential.STM.html#loc_68_9_68_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Sequential.STM.html#loc_68_9_68_13&#39;)"><span class="hl_tyconref"><span class="mpre">TVar</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">)
  </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Concurrent/STM/TSem.hs&quot;, srcSpanStartLine = 38, srcSpanStartColumn = 3, srcSpanEndLine = 38, srcSpanEndColumn = 26}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Concurrent/STM/TSem.hs&quot;, srcSpanStartLine = 38, srcSpanStartColumn = 3, srcSpanEndLine = 38, srcSpanEndColumn = 11},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/stm-2.4.3/Control/Concurrent/STM/TSem.hs&quot;, sr"><span class="mpre">deriving (Eq, Typeable)</span></span><span class="mpre">

</span><a href="#loc_41_1_41_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_41_1_41_8&#39;)"><span class="mpre">newTSem</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="Control.Sequential.STM.html#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Sequential.STM.html#loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><a href="#loc_37_9_37_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_9_37_13&#39;)"><span class="hl_tyconref"><span class="mpre">TSem</span></span></a><span class="mpre">
</span><a name="loc_41_1_41_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_41_1_41_8&#39;)"><span class="hl_fundecl"><span class="mpre">newTSem</span></span></a><span class="mpre"> </span><a name="loc_41_9_41_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_41_9_41_10&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> </span><a href="#loc_37_16_37_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_16_37_20&#39;)"><span class="hl_conref"><span class="mpre">TSem</span></span></a><span class="mpre"> (</span><a href="Control.Sequential.STM.html#loc_72_1_72_8" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Sequential.STM.html#loc_72_1_72_8&#39;)"><span class="hl_varref"><span class="mpre">newTVar</span></span></a><span class="mpre"> </span><a href="#loc_41_9_41_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_41_9_41_10&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre">)

</span><a href="#loc_44_1_44_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_44_1_44_9&#39;)"><span class="mpre">waitTSem</span></a><span class="mpre"> :: </span><a href="#loc_37_9_37_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_9_37_13&#39;)"><span class="hl_tyconref"><span class="mpre">TSem</span></span></a><span class="mpre"> -&gt; </span><a href="Control.Sequential.STM.html#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Sequential.STM.html#loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_44_1_44_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_44_1_44_9&#39;)"><span class="hl_fundecl"><span class="mpre">waitTSem</span></span></a><span class="mpre"> (</span><a href="#loc_37_16_37_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_16_37_20&#39;)"><span class="hl_conref"><span class="mpre">TSem</span></span></a><span class="mpre"> </span><a name="loc_44_16_44_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_44_16_44_17&#39;)"><span class="hl_vardecl"><span class="mpre">t</span></span></a><span class="mpre">) = do
  </span><a name="loc_45_3_45_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_3_45_4&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre"> &lt;- </span><a href="Control.Sequential.STM.html#loc_80_1_80_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Sequential.STM.html#loc_80_1_80_9&#39;)"><span class="hl_varref"><span class="mpre">readTVar</span></span></a><span class="mpre"> </span><a href="#loc_44_16_44_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_44_16_44_17&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre">
  </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><a href="#loc_45_3_45_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_3_45_4&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">) </span><span class="hl_varref"><span class="mpre">retry</span></span><span class="mpre">
  </span><a href="Control.Sequential.STM.html#loc_86_1_86_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Sequential.STM.html#loc_86_1_86_10&#39;)"><span class="hl_varref"><span class="mpre">writeTVar</span></span></a><span class="mpre"> </span><a href="#loc_44_16_44_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_44_16_44_17&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> (</span><a href="#loc_45_3_45_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_3_45_4&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)

</span><a href="#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_1_50_11&#39;)"><span class="mpre">signalTSem</span></a><span class="mpre"> :: </span><a href="#loc_37_9_37_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_9_37_13&#39;)"><span class="hl_tyconref"><span class="mpre">TSem</span></span></a><span class="mpre"> -&gt; </span><a href="Control.Sequential.STM.html#loc_25_9_25_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Sequential.STM.html#loc_25_9_25_12&#39;)"><span class="hl_tyconref"><span class="mpre">STM</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_50_1_50_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_1_50_11&#39;)"><span class="hl_fundecl"><span class="mpre">signalTSem</span></span></a><span class="mpre"> (</span><a href="#loc_37_16_37_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_37_16_37_20&#39;)"><span class="hl_conref"><span class="mpre">TSem</span></span></a><span class="mpre"> </span><a name="loc_50_18_50_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_18_50_19&#39;)"><span class="hl_vardecl"><span class="mpre">t</span></span></a><span class="mpre">) = do
  </span><a name="loc_51_3_51_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_3_51_4&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre"> &lt;- </span><a href="Control.Sequential.STM.html#loc_80_1_80_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Sequential.STM.html#loc_80_1_80_9&#39;)"><span class="hl_varref"><span class="mpre">readTVar</span></span></a><span class="mpre"> </span><a href="#loc_50_18_50_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_18_50_19&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre">
  </span><a href="Control.Sequential.STM.html#loc_86_1_86_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Sequential.STM.html#loc_86_1_86_10&#39;)"><span class="hl_varref"><span class="mpre">writeTVar</span></span></a><span class="mpre"> </span><a href="#loc_50_18_50_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_18_50_19&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><a href="#loc_51_3_51_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_3_51_4&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">

</span></div></body></html>