<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE Trustworthy #-}
{-# LANGUAGE NoImplicitPrelude #-}

</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      :  GHC.Foreign</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   :  (c) The University of Glasgow, 2008-2011</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     :  see libraries/base/LICENSE</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- </span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  :  libraries@haskell.org</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   :  internal</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability :  non-portable</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Foreign marshalling support for CStrings with configurable encodings</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">

module GHC.Foreign (
    </span><span class="hl_comment"><span class="mpre">-- * C strings with a configurable encoding</span></span><span class="mpre">
    
    </span><span class="hl_comment"><span class="mpre">-- conversion of C strings into Haskell strings</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
    peekCString,
    peekCStringLen,
    
    </span><span class="hl_comment"><span class="mpre">-- conversion of Haskell strings into C strings</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
    newCString,
    newCStringLen,
    
    </span><span class="hl_comment"><span class="mpre">-- conversion of Haskell strings into C strings using temporary storage</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
    withCString,
    withCStringLen,
    
    charIsRepresentable,
  ) where

import Foreign.Marshal.Array
import Foreign.C.Types
import Foreign.Ptr
import Foreign.Storable

import Data.Word

</span><span class="hl_comment"><span class="mpre">-- Imports for the locale-encoding version of marshallers</span></span><span class="mpre">
import Control.Monad

import Data.Tuple (</span><a href="Data.Tuple.html#loc_48_1_48_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Tuple.html#loc_48_1_48_4&#39;)"><span class="mpre">fst</span></a><span class="mpre">)
import Data.Maybe

import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 52, srcSpanStartColumn = 8, srcSpanEndLine = 52, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Show&quot;"><span class="mpre">GHC.Show</span></span><span class="mpre"> ( show )

import Foreign.Marshal.Alloc
import Foreign.ForeignPtr

import GHC.Debug
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 58, srcSpanStartColumn = 8, srcSpanEndLine = 58, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.List&quot;"><span class="mpre">GHC.List</span></span><span class="mpre">
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 59, srcSpanStartColumn = 8, srcSpanEndLine = 59, srcSpanEndColumn = 15}, srcInfoPoints = []}) &quot;GHC.Num&quot;"><span class="mpre">GHC.Num</span></span><span class="mpre">
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 60, srcSpanStartColumn = 8, srcSpanEndLine = 60, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Base&quot;"><span class="mpre">GHC.Base</span></span><span class="mpre">

import GHC.IO
import GHC.IO.Exception
import GHC.IO.Buffer
import GHC.IO.Encoding.Types


</span><a href="#loc_69_1_69_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_1_69_13&#39;)"><span class="mpre">c_DEBUG_DUMP</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
</span><a name="loc_69_1_69_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_1_69_13&#39;)"><span class="hl_vardecl"><span class="mpre">c_DEBUG_DUMP</span></span></a><span class="mpre"> = </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">

</span><a href="#loc_72_1_72_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_1_72_12&#39;)"><span class="mpre">putDebugMsg</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_72_1_72_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_1_72_12&#39;)"><span class="hl_vardecl"><span class="mpre">putDebugMsg</span></span></a><span class="mpre"> | </span><a href="#loc_69_1_69_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_1_69_13&#39;)"><span class="hl_varref"><span class="mpre">c_DEBUG_DUMP</span></span></a><span class="mpre"> = </span><a href="GHC.Debug.html#loc_10_1_10_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Debug.html#loc_10_1_10_8&#39;)"><span class="hl_varref"><span class="mpre">debugLn</span></span></a><span class="mpre">
            | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">    = </span><span class="hl_varref"><span class="mpre">const</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">)


</span><span class="hl_comment"><span class="mpre">-- These definitions are identical to those in Foreign.C.String, but copied in here to avoid a cycle:</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 77, srcSpanStartColumn = 1, srcSpanEndLine = 77, srcSpanEndColumn = 28}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 77, srcSpanStartColumn = 1, srcSpanEndLine = 77, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 77, srcSpanStartColumn "><span class="mpre">type CString    = Ptr CChar</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 78, srcSpanStartColumn = 1, srcSpanEndLine = 78, srcSpanEndColumn = 35}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 78, srcSpanStartColumn = 1, srcSpanEndLine = 78, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 78, srcSpanStartColumn "><span class="mpre">type CStringLen = (Ptr CChar, Int)</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- exported functions</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a NUL terminated C string into a Haskell string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_86_1_86_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_1_86_12&#39;)"><span class="mpre">peekCString</span></a><span class="mpre">    :: </span><a href="GHC.IO.Encoding.Types.html#loc_107_6_107_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_107_6_107_18&#39;)"><span class="hl_tyconref"><span class="mpre">TextEncoding</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">
</span><a name="loc_86_1_86_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_1_86_12&#39;)"><span class="hl_fundecl"><span class="mpre">peekCString</span></span></a><span class="mpre"> </span><a name="loc_86_13_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_13_86_16&#39;)"><span class="hl_vardecl"><span class="mpre">enc</span></span></a><span class="mpre"> </span><a name="loc_86_17_86_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_17_86_19&#39;)"><span class="hl_vardecl"><span class="mpre">cp</span></span></a><span class="mpre"> = do
    </span><a name="loc_87_5_87_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_5_87_7&#39;)"><span class="hl_vardecl"><span class="mpre">sz</span></span></a><span class="mpre"> &lt;- </span><a href="Foreign.Marshal.Array.html#loc_247_1_247_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_247_1_247_13&#39;)"><span class="hl_varref"><span class="mpre">lengthArray0</span></span></a><span class="mpre"> </span><a href="#loc_152_1_152_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_1_152_4&#39;)"><span class="hl_varref"><span class="mpre">nUL</span></span></a><span class="mpre"> </span><a href="#loc_86_17_86_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_17_86_19&#39;)"><span class="hl_varref"><span class="mpre">cp</span></span></a><span class="mpre">
    </span><a href="#loc_163_1_163_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_163_1_163_19&#39;)"><span class="hl_varref"><span class="mpre">peekEncodedCString</span></span></a><span class="mpre"> </span><a href="#loc_86_13_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_13_86_16&#39;)"><span class="hl_varref"><span class="mpre">enc</span></span></a><span class="mpre"> (</span><a href="#loc_86_17_86_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_17_86_19&#39;)"><span class="hl_varref"><span class="mpre">cp</span></span></a><span class="mpre">, </span><a href="#loc_87_5_87_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_5_87_7&#39;)"><span class="hl_varref"><span class="mpre">sz</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><a href="#loc_156_1_156_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_1_156_10&#39;)"><span class="hl_varref"><span class="mpre">cCharSize</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Marshal a C string with explicit length into a Haskell string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_93_1_93_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_1_93_15&#39;)"><span class="mpre">peekCStringLen</span></a><span class="mpre">           :: </span><a href="GHC.IO.Encoding.Types.html#loc_107_6_107_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_107_6_107_18&#39;)"><span class="hl_tyconref"><span class="mpre">TextEncoding</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">
</span><a name="loc_93_1_93_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_1_93_15&#39;)"><span class="hl_vardecl"><span class="mpre">peekCStringLen</span></span></a><span class="mpre"> = </span><a href="#loc_163_1_163_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_163_1_163_19&#39;)"><span class="hl_varref"><span class="mpre">peekEncodedCString</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a NUL terminated C string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the Haskell string may /not/ contain any NUL characters</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * new storage is allocated for the C string and must be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   explicitly freed using &#39;Foreign.Marshal.Alloc.free&#39; or</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;Foreign.Marshal.Alloc.finalizerFree&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_104_1_104_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_1_104_11&#39;)"><span class="mpre">newCString</span></a><span class="mpre"> :: </span><a href="GHC.IO.Encoding.Types.html#loc_107_6_107_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_107_6_107_18&#39;)"><span class="hl_tyconref"><span class="mpre">TextEncoding</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre">
</span><a name="loc_104_1_104_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_1_104_11&#39;)"><span class="hl_fundecl"><span class="mpre">newCString</span></span></a><span class="mpre"> </span><a name="loc_104_12_104_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_12_104_15&#39;)"><span class="hl_vardecl"><span class="mpre">enc</span></span></a><span class="mpre"> = </span><a href="Control.Monad.html#loc_274_1_274_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_274_1_274_6&#39;)"><span class="hl_varref"><span class="mpre">liftM</span></span></a><span class="mpre"> </span><a href="Data.Tuple.html#loc_48_1_48_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Tuple.html#loc_48_1_48_4&#39;)"><span class="hl_varref"><span class="mpre">fst</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_214_1_214_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_18&#39;)"><span class="hl_varref"><span class="mpre">newEncodedCString</span></span></a><span class="mpre"> </span><a href="#loc_104_12_104_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_12_104_15&#39;)"><span class="hl_varref"><span class="mpre">enc</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a C string (ie, character array) with</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- explicit length information.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * new storage is allocated for the C string and must be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   explicitly freed using &#39;Foreign.Marshal.Alloc.free&#39; or</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;Foreign.Marshal.Alloc.finalizerFree&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_114_1_114_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_1_114_14&#39;)"><span class="mpre">newCStringLen</span></a><span class="mpre">     :: </span><a href="GHC.IO.Encoding.Types.html#loc_107_6_107_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_107_6_107_18&#39;)"><span class="hl_tyconref"><span class="mpre">TextEncoding</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre">
</span><a name="loc_114_1_114_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_1_114_14&#39;)"><span class="hl_fundecl"><span class="mpre">newCStringLen</span></span></a><span class="mpre"> </span><a name="loc_114_15_114_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_15_114_18&#39;)"><span class="hl_vardecl"><span class="mpre">enc</span></span></a><span class="mpre"> = </span><a href="#loc_214_1_214_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_18&#39;)"><span class="hl_varref"><span class="mpre">newEncodedCString</span></span></a><span class="mpre"> </span><a href="#loc_114_15_114_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_15_114_18&#39;)"><span class="hl_varref"><span class="mpre">enc</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a NUL terminated C string using temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- storage.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the Haskell string may /not/ contain any NUL characters</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the memory is freed when the subcomputation terminates (either</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   normally or via an exception), so the pointer to the temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   storage must /not/ be used after this.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_126_1_126_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_1_126_12&#39;)"><span class="mpre">withCString</span></a><span class="mpre"> :: </span><a href="GHC.IO.Encoding.Types.html#loc_107_6_107_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_107_6_107_18&#39;)"><span class="hl_tyconref"><span class="mpre">TextEncoding</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_126_1_126_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_1_126_12&#39;)"><span class="hl_fundecl"><span class="mpre">withCString</span></span></a><span class="mpre"> </span><a name="loc_126_13_126_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_13_126_16&#39;)"><span class="hl_vardecl"><span class="mpre">enc</span></span></a><span class="mpre"> </span><a name="loc_126_17_126_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_17_126_18&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_126_19_126_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_19_126_22&#39;)"><span class="hl_vardecl"><span class="mpre">act</span></span></a><span class="mpre"> = </span><a href="#loc_194_1_194_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_1_194_19&#39;)"><span class="hl_varref"><span class="mpre">withEncodedCString</span></span></a><span class="mpre"> </span><a href="#loc_126_13_126_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_13_126_16&#39;)"><span class="hl_varref"><span class="mpre">enc</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre"> </span><a href="#loc_126_17_126_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_17_126_18&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \(</span><a name="loc_126_59_126_61" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_59_126_61&#39;)"><span class="hl_vardecl"><span class="mpre">cp</span></span></a><span class="mpre">, </span><span class="hl_vardecl"><span class="mpre">_sz</span></span><span class="mpre">) -&gt; </span><a href="#loc_126_19_126_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_19_126_22&#39;)"><span class="hl_varref"><span class="mpre">act</span></span></a><span class="mpre"> </span><a href="#loc_126_59_126_61" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_59_126_61&#39;)"><span class="hl_varref"><span class="mpre">cp</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a Haskell string into a C string (ie, character array)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- in temporary storage, with explicit length information.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the memory is freed when the subcomputation terminates (either</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   normally or via an exception), so the pointer to the temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   storage must /not/ be used after this.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_136_1_136_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_1_136_15&#39;)"><span class="mpre">withCStringLen</span></a><span class="mpre">         :: </span><a href="GHC.IO.Encoding.Types.html#loc_107_6_107_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_107_6_107_18&#39;)"><span class="hl_tyconref"><span class="mpre">TextEncoding</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_136_1_136_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_1_136_15&#39;)"><span class="hl_fundecl"><span class="mpre">withCStringLen</span></span></a><span class="mpre"> </span><a name="loc_136_16_136_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_16_136_19&#39;)"><span class="hl_vardecl"><span class="mpre">enc</span></span></a><span class="mpre"> = </span><a href="#loc_194_1_194_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_1_194_19&#39;)"><span class="hl_varref"><span class="mpre">withEncodedCString</span></span></a><span class="mpre"> </span><a href="#loc_136_16_136_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_16_136_19&#39;)"><span class="hl_varref"><span class="mpre">enc</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | Determines whether a character can be accurately encoded in a &#39;CString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Pretty much anyone who uses this function is in a state of sin because</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- whether or not a character is encodable will, in general, depend on the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- context in which it occurs.</span></span><span class="mpre">
</span><a href="#loc_145_1_145_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_1_145_20&#39;)"><span class="mpre">charIsRepresentable</span></a><span class="mpre"> :: </span><a href="GHC.IO.Encoding.Types.html#loc_107_6_107_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_107_6_107_18&#39;)"><span class="hl_tyconref"><span class="mpre">TextEncoding</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
</span><a name="loc_145_1_145_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_1_145_20&#39;)"><span class="hl_fundecl"><span class="mpre">charIsRepresentable</span></span></a><span class="mpre"> </span><a name="loc_145_21_145_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_21_145_24&#39;)"><span class="hl_vardecl"><span class="mpre">enc</span></span></a><span class="mpre"> </span><a name="loc_145_25_145_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_25_145_26&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre"> = </span><a href="#loc_126_1_126_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_1_126_12&#39;)"><span class="hl_varref"><span class="mpre">withCString</span></span></a><span class="mpre"> </span><a href="#loc_145_21_145_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_21_145_24&#39;)"><span class="hl_varref"><span class="mpre">enc</span></span></a><span class="mpre"> [</span><a href="#loc_145_25_145_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_25_145_26&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">] (</span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> (</span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> [</span><a href="#loc_145_25_145_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_25_145_26&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">]) </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_86_1_86_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_1_86_12&#39;)"><span class="hl_varref"><span class="mpre">peekCString</span></span></a><span class="mpre"> </span><a href="#loc_145_21_145_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_21_145_24&#39;)"><span class="hl_varref"><span class="mpre">enc</span></span></a><span class="mpre">) </span><a href="GHC.IO.html#loc_279_1_279_15" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_279_1_279_15&#39;)"><span class="hl_infix"><span class="mpre">`catchException`</span></span></a><span class="mpre"> (\</span><a name="loc_145_102_145_103" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_102_145_103&#39;)"><span class="hl_vardecl"><span class="mpre">e</span></span></a><span class="mpre"> -&gt; let _ = </span><a href="#loc_145_102_145_103" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_102_145_103&#39;)"><span class="hl_varref"><span class="mpre">e</span></span></a><span class="mpre"> :: </span><a href="GHC.IO.Exception.html#loc_238_6_238_17" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Exception.html#loc_238_6_238_17&#39;)"><span class="hl_tyconref"><span class="mpre">IOException</span></span></a><span class="mpre"> in </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- auxiliary definitions</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ----------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- C&#39;s end of string character</span></span><span class="mpre">
</span><a href="#loc_152_1_152_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_1_152_4&#39;)"><span class="mpre">nUL</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CChar</span></span><span class="mpre">
</span><a name="loc_152_1_152_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_1_152_4&#39;)"><span class="hl_vardecl"><span class="mpre">nUL</span></span></a><span class="mpre">  = </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Size of a CChar in bytes</span></span><span class="mpre">
</span><a href="#loc_156_1_156_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_1_156_10&#39;)"><span class="mpre">cCharSize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_156_1_156_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_1_156_10&#39;)"><span class="hl_vardecl"><span class="mpre">cCharSize</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">sizeOf</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">undefined</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CChar</span></span><span class="mpre">)


</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_163_1_163_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_163_1_163_19&#39;)"><span class="mpre">peekEncodedCString</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_163_1_163_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_163_1_163_19&#39;)"><span class="mpre">peekEncodedCString</span></a><span class="mpre"> :: </span><a href="GHC.IO.Encoding.Types.html#loc_107_6_107_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_107_6_107_18&#39;)"><span class="hl_tyconref"><span class="mpre">TextEncoding</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ Encoding of CString</span></span><span class="mpre">
                   -&gt; </span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre">
                   -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">    </span><span class="hl_comment"><span class="mpre">-- ^ String in Haskell terms</span></span><span class="mpre">
</span><a name="loc_163_1_163_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_163_1_163_19&#39;)"><span class="hl_fundecl"><span class="mpre">peekEncodedCString</span></span></a><span class="mpre"> (</span><span class="warning" data-warning="PatPRec (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 163, srcSpanStartColumn = 21, srcSpanEndLine = 163, srcSpanEndColumn = 64}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 163, srcSpanStartColumn = 34, srcSpanEndLine = 163, srcSpanEndColumn = 35},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 163, srcSpanStartCol"><span class="mpre">TextEncoding { mkTextDecoder = mk_decoder }</span></span><span class="mpre">) (</span><a name="loc_163_67_163_68" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_163_67_163_68&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre">, </span><a name="loc_163_70_163_78" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_163_70_163_78&#39;)"><span class="hl_vardecl"><span class="mpre">sz_bytes</span></span></a><span class="mpre">)
  = </span><a href="GHC.IO.html#loc_448_1_448_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_448_1_448_8&#39;)"><span class="hl_varref"><span class="mpre">bracket</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">mk_decoder</span></span><span class="mpre"> </span><a href="GHC.IO.Encoding.Types.html#loc_72_3_72_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_72_3_72_8&#39;)"><span class="hl_varref"><span class="mpre">close</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_164_33_164_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_33_164_40&#39;)"><span class="hl_vardecl"><span class="mpre">decoder</span></span></a><span class="mpre"> -&gt; do
      let </span><a name="loc_165_11_165_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_11_165_21&#39;)"><span class="hl_vardecl"><span class="mpre">chunk_size</span></span></a><span class="mpre"> = </span><a href="#loc_163_70_163_78" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_163_70_163_78&#39;)"><span class="hl_varref"><span class="mpre">sz_bytes</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`max`</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- Decode buffer chunk size in characters: one iteration only for ASCII</span></span><span class="mpre">
      </span><a name="loc_166_7_166_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_7_166_12&#39;)"><span class="hl_vardecl"><span class="mpre">from0</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> (\</span><a name="loc_166_23_166_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_23_166_25&#39;)"><span class="hl_vardecl"><span class="mpre">fp</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.IO.Buffer.html#loc_237_1_237_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_237_1_237_10&#39;)"><span class="hl_varref"><span class="mpre">bufferAdd</span></span></a><span class="mpre"> </span><a href="#loc_163_70_163_78" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_163_70_163_78&#39;)"><span class="hl_varref"><span class="mpre">sz_bytes</span></span></a><span class="mpre"> (</span><a href="GHC.IO.Buffer.html#loc_240_1_240_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_240_1_240_12&#39;)"><span class="hl_varref"><span class="mpre">emptyBuffer</span></span></a><span class="mpre"> </span><a href="#loc_166_23_166_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_23_166_25&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre"> </span><a href="#loc_163_70_163_78" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_163_70_163_78&#39;)"><span class="hl_varref"><span class="mpre">sz_bytes</span></span></a><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_195_20_195_30" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_195_20_195_30&#39;)"><span class="hl_conref"><span class="mpre">ReadBuffer</span></span></a><span class="mpre">)) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">newForeignPtr_</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_163_67_163_68" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_163_67_163_68&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">)
      </span><a name="loc_167_7_167_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_7_167_9&#39;)"><span class="hl_vardecl"><span class="mpre">to</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IO.Buffer.html#loc_247_1_247_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_247_1_247_14&#39;)"><span class="hl_varref"><span class="mpre">newCharBuffer</span></span></a><span class="mpre"> </span><a href="#loc_165_11_165_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_11_165_21&#39;)"><span class="hl_varref"><span class="mpre">chunk_size</span></span></a><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_195_33_195_44" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_195_33_195_44&#39;)"><span class="hl_conref"><span class="mpre">WriteBuffer</span></span></a><span class="mpre">

      let </span><a name="loc_169_11_169_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_11_169_13&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> </span><a name="loc_169_14_169_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_14_169_23&#39;)"><span class="hl_vardecl"><span class="mpre">iteration</span></span></a><span class="mpre"> </span><a name="loc_169_24_169_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_24_169_28&#39;)"><span class="hl_vardecl"><span class="mpre">from</span></span></a><span class="mpre"> = do
            (</span><a name="loc_170_14_170_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_14_170_17&#39;)"><span class="hl_vardecl"><span class="mpre">why</span></span></a><span class="mpre">, </span><a name="loc_170_19_170_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_19_170_24&#39;)"><span class="hl_vardecl"><span class="mpre">from&#39;</span></span></a><span class="mpre">, </span><a name="loc_170_26_170_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_26_170_29&#39;)"><span class="hl_vardecl"><span class="mpre">to&#39;</span></span></a><span class="mpre">) &lt;- </span><a href="GHC.IO.Encoding.Types.html#loc_37_3_37_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_37_3_37_9&#39;)"><span class="hl_varref"><span class="mpre">encode</span></span></a><span class="mpre"> </span><a href="#loc_164_33_164_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_33_164_40&#39;)"><span class="hl_varref"><span class="mpre">decoder</span></span></a><span class="mpre"> </span><a href="#loc_169_24_169_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_24_169_28&#39;)"><span class="hl_varref"><span class="mpre">from</span></span></a><span class="mpre"> </span><a href="#loc_167_7_167_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_7_167_9&#39;)"><span class="hl_varref"><span class="mpre">to</span></span></a><span class="mpre">
            if </span><a href="GHC.IO.Buffer.html#loc_204_1_204_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_204_1_204_14&#39;)"><span class="hl_varref"><span class="mpre">isEmptyBuffer</span></span></a><span class="mpre"> </span><a href="#loc_170_19_170_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_19_170_24&#39;)"><span class="hl_varref"><span class="mpre">from&#39;</span></span></a><span class="mpre">
             then
              </span><span class="hl_comment"><span class="mpre">-- No input remaining: @why@ will be InputUnderflow, but we don&#39;t care</span></span><span class="mpre">
              </span><a href="GHC.IO.Buffer.html#loc_198_1_198_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_198_1_198_11&#39;)"><span class="hl_varref"><span class="mpre">withBuffer</span></span></a><span class="mpre"> </span><a href="#loc_170_26_170_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_26_170_29&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Foreign.Marshal.Array.html#loc_134_1_134_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_134_1_134_10&#39;)"><span class="hl_varref"><span class="mpre">peekArray</span></span></a><span class="mpre"> (</span><a href="GHC.IO.Buffer.html#loc_223_1_223_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_223_1_223_12&#39;)"><span class="hl_varref"><span class="mpre">bufferElems</span></span></a><span class="mpre"> </span><a href="#loc_170_26_170_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_26_170_29&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre">)
             else do
              </span><span class="hl_comment"><span class="mpre">-- Input remaining: what went wrong?</span></span><span class="mpre">
              </span><a href="#loc_72_1_72_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_1_72_12&#39;)"><span class="hl_varref"><span class="mpre">putDebugMsg</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;peekEncodedCString: &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_169_14_169_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_14_169_23&#39;)"><span class="hl_varref"><span class="mpre">iteration</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot; &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_170_14_170_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_14_170_17&#39;)"><span class="hl_varref"><span class="mpre">why</span></span></a><span class="mpre">)
              (</span><a name="loc_178_16_178_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_16_178_22&#39;)"><span class="hl_vardecl"><span class="mpre">from&#39;&#39;</span></span></a><span class="mpre">, </span><a name="loc_178_24_178_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_24_178_28&#39;)"><span class="hl_vardecl"><span class="mpre">to&#39;&#39;</span></span></a><span class="mpre">) &lt;- case </span><a href="#loc_170_14_170_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_14_170_17&#39;)"><span class="hl_varref"><span class="mpre">why</span></span></a><span class="mpre"> of </span><a href="GHC.IO.Encoding.Types.html#loc_128_23_128_38" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_128_23_128_38&#39;)"><span class="hl_conref"><span class="mpre">InvalidSequence</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.IO.Encoding.Types.html#loc_53_3_53_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_53_3_53_10&#39;)"><span class="hl_varref"><span class="mpre">recover</span></span></a><span class="mpre"> </span><a href="#loc_164_33_164_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_33_164_40&#39;)"><span class="hl_varref"><span class="mpre">decoder</span></span></a><span class="mpre"> </span><a href="#loc_170_19_170_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_19_170_24&#39;)"><span class="hl_varref"><span class="mpre">from&#39;</span></span></a><span class="mpre"> </span><a href="#loc_170_26_170_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_26_170_29&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- These conditions are equally bad because</span></span><span class="mpre">
                                            </span><a href="GHC.IO.Encoding.Types.html#loc_125_23_125_37" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_125_23_125_37&#39;)"><span class="hl_conref"><span class="mpre">InputUnderflow</span></span></a><span class="mpre">  -&gt; </span><a href="GHC.IO.Encoding.Types.html#loc_53_3_53_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_53_3_53_10&#39;)"><span class="hl_varref"><span class="mpre">recover</span></span></a><span class="mpre"> </span><a href="#loc_164_33_164_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_33_164_40&#39;)"><span class="hl_varref"><span class="mpre">decoder</span></span></a><span class="mpre"> </span><a href="#loc_170_19_170_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_19_170_24&#39;)"><span class="hl_varref"><span class="mpre">from&#39;</span></span></a><span class="mpre"> </span><a href="#loc_170_26_170_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_26_170_29&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- they indicate malformed/truncated input</span></span><span class="mpre">
                                            </span><a href="GHC.IO.Encoding.Types.html#loc_127_23_127_38" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_127_23_127_38&#39;)"><span class="hl_conref"><span class="mpre">OutputUnderflow</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_170_19_170_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_19_170_24&#39;)"><span class="hl_varref"><span class="mpre">from&#39;</span></span></a><span class="mpre">, </span><a href="#loc_170_26_170_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_26_170_29&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre">)       </span><span class="hl_comment"><span class="mpre">-- We will have more space next time round</span></span><span class="mpre">
              </span><a href="#loc_72_1_72_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_1_72_12&#39;)"><span class="hl_varref"><span class="mpre">putDebugMsg</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;peekEncodedCString: from &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_267_1_267_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_267_1_267_14&#39;)"><span class="hl_varref"><span class="mpre">summaryBuffer</span></span></a><span class="mpre"> </span><a href="#loc_169_24_169_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_24_169_28&#39;)"><span class="hl_varref"><span class="mpre">from</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot; &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_267_1_267_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_267_1_267_14&#39;)"><span class="hl_varref"><span class="mpre">summaryBuffer</span></span></a><span class="mpre"> </span><a href="#loc_170_19_170_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_19_170_24&#39;)"><span class="hl_varref"><span class="mpre">from&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot; &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_267_1_267_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_267_1_267_14&#39;)"><span class="hl_varref"><span class="mpre">summaryBuffer</span></span></a><span class="mpre"> </span><a href="#loc_178_16_178_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_16_178_22&#39;)"><span class="hl_varref"><span class="mpre">from&#39;&#39;</span></span></a><span class="mpre">)
              </span><a href="#loc_72_1_72_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_1_72_12&#39;)"><span class="hl_varref"><span class="mpre">putDebugMsg</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;peekEncodedCString: to &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_267_1_267_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_267_1_267_14&#39;)"><span class="hl_varref"><span class="mpre">summaryBuffer</span></span></a><span class="mpre"> </span><a href="#loc_167_7_167_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_7_167_9&#39;)"><span class="hl_varref"><span class="mpre">to</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot; &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_267_1_267_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_267_1_267_14&#39;)"><span class="hl_varref"><span class="mpre">summaryBuffer</span></span></a><span class="mpre"> </span><a href="#loc_170_26_170_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_26_170_29&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot; &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_267_1_267_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_267_1_267_14&#39;)"><span class="hl_varref"><span class="mpre">summaryBuffer</span></span></a><span class="mpre"> </span><a href="#loc_178_24_178_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_24_178_28&#39;)"><span class="hl_varref"><span class="mpre">to&#39;&#39;</span></span></a><span class="mpre">)
              </span><a name="loc_183_15_183_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_15_183_23&#39;)"><span class="hl_vardecl"><span class="mpre">to_chars</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IO.Buffer.html#loc_198_1_198_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_198_1_198_11&#39;)"><span class="hl_varref"><span class="mpre">withBuffer</span></span></a><span class="mpre"> </span><a href="#loc_178_24_178_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_24_178_28&#39;)"><span class="hl_varref"><span class="mpre">to&#39;&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Foreign.Marshal.Array.html#loc_134_1_134_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_134_1_134_10&#39;)"><span class="hl_varref"><span class="mpre">peekArray</span></span></a><span class="mpre"> (</span><a href="GHC.IO.Buffer.html#loc_223_1_223_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_223_1_223_12&#39;)"><span class="hl_varref"><span class="mpre">bufferElems</span></span></a><span class="mpre"> </span><a href="#loc_178_24_178_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_24_178_28&#39;)"><span class="hl_varref"><span class="mpre">to&#39;&#39;</span></span></a><span class="mpre">)
              </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> (</span><a href="#loc_183_15_183_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_15_183_23&#39;)"><span class="hl_varref"><span class="mpre">to_chars</span></span></a><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_169_11_169_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_11_169_13&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_169_14_169_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_14_169_23&#39;)"><span class="hl_varref"><span class="mpre">iteration</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">) </span><a href="#loc_178_16_178_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_16_178_22&#39;)"><span class="hl_varref"><span class="mpre">from&#39;&#39;</span></span></a><span class="mpre">

      </span><a href="#loc_169_11_169_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_11_169_13&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> (</span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">) </span><a href="#loc_166_7_166_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_7_166_12&#39;)"><span class="hl_varref"><span class="mpre">from0</span></span></a><span class="mpre">

</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_194_1_194_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_1_194_19&#39;)"><span class="mpre">withEncodedCString</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_194_1_194_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_1_194_19&#39;)"><span class="mpre">withEncodedCString</span></a><span class="mpre"> :: </span><a href="GHC.IO.Encoding.Types.html#loc_107_6_107_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_107_6_107_18&#39;)"><span class="hl_tyconref"><span class="mpre">TextEncoding</span></span></a><span class="mpre">         </span><span class="hl_comment"><span class="mpre">-- ^ Encoding of CString to create</span></span><span class="mpre">
                   -&gt; </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">                 </span><span class="hl_comment"><span class="mpre">-- ^ Null-terminate?</span></span><span class="mpre">
                   -&gt; </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">               </span><span class="hl_comment"><span class="mpre">-- ^ String to encode</span></span><span class="mpre">
                   -&gt; (</span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) </span><span class="hl_comment"><span class="mpre">-- ^ Worker that can safely use the allocated memory</span></span><span class="mpre">
                   -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_194_1_194_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_1_194_19&#39;)"><span class="hl_fundecl"><span class="mpre">withEncodedCString</span></span></a><span class="mpre"> (</span><span class="warning" data-warning="PatPRec (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 194, srcSpanStartColumn = 21, srcSpanEndLine = 194, srcSpanEndColumn = 64}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 194, srcSpanStartColumn = 34, srcSpanEndLine = 194, srcSpanEndColumn = 35},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 194, srcSpanStartCol"><span class="mpre">TextEncoding { mkTextEncoder = mk_encoder }</span></span><span class="mpre">) </span><a name="loc_194_66_194_80" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_66_194_80&#39;)"><span class="hl_vardecl"><span class="mpre">null_terminate</span></span></a><span class="mpre"> </span><a name="loc_194_81_194_82" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_81_194_82&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_194_83_194_86" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_83_194_86&#39;)"><span class="hl_vardecl"><span class="mpre">act</span></span></a><span class="mpre">
  = </span><a href="GHC.IO.html#loc_448_1_448_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_448_1_448_8&#39;)"><span class="hl_varref"><span class="mpre">bracket</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">mk_encoder</span></span><span class="mpre"> </span><a href="GHC.IO.Encoding.Types.html#loc_72_3_72_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_72_3_72_8&#39;)"><span class="hl_varref"><span class="mpre">close</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_195_33_195_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_33_195_40&#39;)"><span class="hl_vardecl"><span class="mpre">encoder</span></span></a><span class="mpre"> -&gt; </span><a href="Foreign.Marshal.Array.html#loc_194_1_194_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_194_1_194_13&#39;)"><span class="hl_varref"><span class="mpre">withArrayLen</span></span></a><span class="mpre"> </span><a href="#loc_194_81_194_82" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_81_194_82&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_195_62_195_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_62_195_64&#39;)"><span class="hl_vardecl"><span class="mpre">sz</span></span></a><span class="mpre"> </span><a name="loc_195_65_195_66" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_65_195_66&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> -&gt; do
      </span><a name="loc_196_7_196_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_7_196_11&#39;)"><span class="hl_vardecl"><span class="mpre">from</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> (\</span><a name="loc_196_22_196_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_22_196_24&#39;)"><span class="hl_vardecl"><span class="mpre">fp</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.IO.Buffer.html#loc_237_1_237_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_237_1_237_10&#39;)"><span class="hl_varref"><span class="mpre">bufferAdd</span></span></a><span class="mpre"> </span><a href="#loc_195_62_195_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_62_195_64&#39;)"><span class="hl_varref"><span class="mpre">sz</span></span></a><span class="mpre"> (</span><a href="GHC.IO.Buffer.html#loc_240_1_240_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_240_1_240_12&#39;)"><span class="hl_varref"><span class="mpre">emptyBuffer</span></span></a><span class="mpre"> </span><a href="#loc_196_22_196_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_22_196_24&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre"> </span><a href="#loc_195_62_195_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_62_195_64&#39;)"><span class="hl_varref"><span class="mpre">sz</span></span></a><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_195_20_195_30" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_195_20_195_30&#39;)"><span class="hl_conref"><span class="mpre">ReadBuffer</span></span></a><span class="mpre">)) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">newForeignPtr_</span></span><span class="mpre"> </span><a href="#loc_195_65_195_66" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_65_195_66&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">

      let </span><a name="loc_198_11_198_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_11_198_13&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> </span><a name="loc_198_14_198_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_14_198_23&#39;)"><span class="hl_vardecl"><span class="mpre">iteration</span></span></a><span class="mpre"> </span><a name="loc_198_24_198_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_24_198_35&#39;)"><span class="hl_vardecl"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre"> = do
           </span><a href="#loc_72_1_72_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_1_72_12&#39;)"><span class="hl_varref"><span class="mpre">putDebugMsg</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;withEncodedCString: &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_198_14_198_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_14_198_23&#39;)"><span class="hl_varref"><span class="mpre">iteration</span></span></a><span class="mpre">)
           </span><span class="hl_varref"><span class="mpre">allocaBytes</span></span><span class="mpre"> </span><a href="#loc_198_24_198_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_24_198_35&#39;)"><span class="hl_varref"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_200_39_200_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_39_200_43&#39;)"><span class="hl_vardecl"><span class="mpre">to_p</span></span></a><span class="mpre"> -&gt; do
            </span><a name="loc_201_13_201_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_13_201_19&#39;)"><span class="hl_vardecl"><span class="mpre">mb_res</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_236_1_236_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_1_236_21&#39;)"><span class="hl_varref"><span class="mpre">tryFillBufferAndCall</span></span></a><span class="mpre"> </span><a href="#loc_195_33_195_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_33_195_40&#39;)"><span class="hl_varref"><span class="mpre">encoder</span></span></a><span class="mpre"> </span><a href="#loc_194_66_194_80" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_66_194_80&#39;)"><span class="hl_varref"><span class="mpre">null_terminate</span></span></a><span class="mpre"> </span><a href="#loc_196_7_196_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_7_196_11&#39;)"><span class="hl_varref"><span class="mpre">from</span></span></a><span class="mpre"> </span><a href="#loc_200_39_200_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_39_200_43&#39;)"><span class="hl_varref"><span class="mpre">to_p</span></span></a><span class="mpre"> </span><a href="#loc_198_24_198_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_24_198_35&#39;)"><span class="hl_varref"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre"> </span><a href="#loc_194_83_194_86" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_194_83_194_86&#39;)"><span class="hl_varref"><span class="mpre">act</span></span></a><span class="mpre">
            case </span><a href="#loc_201_13_201_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_13_201_19&#39;)"><span class="hl_varref"><span class="mpre">mb_res</span></span></a><span class="mpre"> of
              </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre">  -&gt; </span><a href="#loc_198_11_198_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_11_198_13&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_198_14_198_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_14_198_23&#39;)"><span class="hl_varref"><span class="mpre">iteration</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">) (</span><a href="#loc_198_24_198_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_24_198_35&#39;)"><span class="hl_varref"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre">)
              </span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> </span><a name="loc_204_20_204_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_20_204_23&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_204_20_204_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_20_204_23&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">

      </span><span class="hl_comment"><span class="mpre">-- If the input string is ASCII, this value will ensure we only allocate once</span></span><span class="mpre">
      </span><a href="#loc_198_11_198_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_11_198_13&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> (</span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">) (</span><a href="#loc_156_1_156_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_1_156_10&#39;)"><span class="hl_varref"><span class="mpre">cCharSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> (</span><a href="#loc_195_62_195_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_195_62_195_64&#39;)"><span class="hl_varref"><span class="mpre">sz</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">))

</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_214_1_214_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_18&#39;)"><span class="mpre">newEncodedCString</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_214_1_214_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_18&#39;)"><span class="mpre">newEncodedCString</span></a><span class="mpre"> :: </span><a href="GHC.IO.Encoding.Types.html#loc_107_6_107_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_107_6_107_18&#39;)"><span class="hl_tyconref"><span class="mpre">TextEncoding</span></span></a><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- ^ Encoding of CString to create</span></span><span class="mpre">
                  -&gt; </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">          </span><span class="hl_comment"><span class="mpre">-- ^ Null-terminate?</span></span><span class="mpre">
                  -&gt; </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">        </span><span class="hl_comment"><span class="mpre">-- ^ String to encode</span></span><span class="mpre">
                  -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre">
</span><a name="loc_214_1_214_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_18&#39;)"><span class="hl_fundecl"><span class="mpre">newEncodedCString</span></span></a><span class="mpre"> (</span><span class="warning" data-warning="PatPRec (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 214, srcSpanStartColumn = 20, srcSpanEndLine = 214, srcSpanEndColumn = 63}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 214, srcSpanStartColumn = 33, srcSpanEndLine = 214, srcSpanEndColumn = 34},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Foreign.hs&quot;, srcSpanStartLine = 214, srcSpanStartCol"><span class="mpre">TextEncoding { mkTextEncoder = mk_encoder }</span></span><span class="mpre">) </span><a name="loc_214_65_214_79" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_65_214_79&#39;)"><span class="hl_vardecl"><span class="mpre">null_terminate</span></span></a><span class="mpre"> </span><a name="loc_214_80_214_81" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_80_214_81&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre">
  = </span><a href="GHC.IO.html#loc_448_1_448_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_448_1_448_8&#39;)"><span class="hl_varref"><span class="mpre">bracket</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">mk_encoder</span></span><span class="mpre"> </span><a href="GHC.IO.Encoding.Types.html#loc_72_3_72_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_72_3_72_8&#39;)"><span class="hl_varref"><span class="mpre">close</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_215_33_215_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_33_215_40&#39;)"><span class="hl_vardecl"><span class="mpre">encoder</span></span></a><span class="mpre"> -&gt; </span><a href="Foreign.Marshal.Array.html#loc_194_1_194_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Array.html#loc_194_1_194_13&#39;)"><span class="hl_varref"><span class="mpre">withArrayLen</span></span></a><span class="mpre"> </span><a href="#loc_214_80_214_81" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_80_214_81&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_215_62_215_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_62_215_64&#39;)"><span class="hl_vardecl"><span class="mpre">sz</span></span></a><span class="mpre"> </span><a name="loc_215_65_215_66" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_65_215_66&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> -&gt; do
      </span><a name="loc_216_7_216_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_7_216_11&#39;)"><span class="hl_vardecl"><span class="mpre">from</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> (\</span><a name="loc_216_22_216_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_22_216_24&#39;)"><span class="hl_vardecl"><span class="mpre">fp</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.IO.Buffer.html#loc_237_1_237_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_237_1_237_10&#39;)"><span class="hl_varref"><span class="mpre">bufferAdd</span></span></a><span class="mpre"> </span><a href="#loc_215_62_215_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_62_215_64&#39;)"><span class="hl_varref"><span class="mpre">sz</span></span></a><span class="mpre"> (</span><a href="GHC.IO.Buffer.html#loc_240_1_240_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_240_1_240_12&#39;)"><span class="hl_varref"><span class="mpre">emptyBuffer</span></span></a><span class="mpre"> </span><a href="#loc_216_22_216_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_22_216_24&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre"> </span><a href="#loc_215_62_215_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_62_215_64&#39;)"><span class="hl_varref"><span class="mpre">sz</span></span></a><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_195_20_195_30" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_195_20_195_30&#39;)"><span class="hl_conref"><span class="mpre">ReadBuffer</span></span></a><span class="mpre">)) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">newForeignPtr_</span></span><span class="mpre"> </span><a href="#loc_215_65_215_66" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_65_215_66&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">

      let </span><a name="loc_218_11_218_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_11_218_13&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> </span><a name="loc_218_14_218_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_14_218_23&#39;)"><span class="hl_vardecl"><span class="mpre">iteration</span></span></a><span class="mpre"> </span><a name="loc_218_24_218_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_24_218_28&#39;)"><span class="hl_vardecl"><span class="mpre">to_p</span></span></a><span class="mpre"> </span><a name="loc_218_29_218_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_29_218_40&#39;)"><span class="hl_vardecl"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre"> = do
           </span><a href="#loc_72_1_72_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_1_72_12&#39;)"><span class="hl_varref"><span class="mpre">putDebugMsg</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;newEncodedCString: &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_218_14_218_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_14_218_23&#39;)"><span class="hl_varref"><span class="mpre">iteration</span></span></a><span class="mpre">)
           </span><a name="loc_220_12_220_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_220_12_220_18&#39;)"><span class="hl_vardecl"><span class="mpre">mb_res</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_236_1_236_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_1_236_21&#39;)"><span class="hl_varref"><span class="mpre">tryFillBufferAndCall</span></span></a><span class="mpre"> </span><a href="#loc_215_33_215_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_33_215_40&#39;)"><span class="hl_varref"><span class="mpre">encoder</span></span></a><span class="mpre"> </span><a href="#loc_214_65_214_79" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_65_214_79&#39;)"><span class="hl_varref"><span class="mpre">null_terminate</span></span></a><span class="mpre"> </span><a href="#loc_216_7_216_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_7_216_11&#39;)"><span class="hl_varref"><span class="mpre">from</span></span></a><span class="mpre"> </span><a href="#loc_218_24_218_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_24_218_28&#39;)"><span class="hl_varref"><span class="mpre">to_p</span></span></a><span class="mpre"> </span><a href="#loc_218_29_218_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_29_218_40&#39;)"><span class="hl_varref"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre">
           case </span><a href="#loc_220_12_220_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_220_12_220_18&#39;)"><span class="hl_varref"><span class="mpre">mb_res</span></span></a><span class="mpre"> of
             </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre">  -&gt; do
                 let </span><a name="loc_223_22_223_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_22_223_34&#39;)"><span class="hl_vardecl"><span class="mpre">to_sz_bytes&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_218_29_218_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_29_218_40&#39;)"><span class="hl_varref"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre">
                 </span><a name="loc_224_18_224_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_18_224_23&#39;)"><span class="hl_vardecl"><span class="mpre">to_p&#39;</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">reallocBytes</span></span><span class="mpre"> </span><a href="#loc_218_24_218_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_24_218_28&#39;)"><span class="hl_varref"><span class="mpre">to_p</span></span></a><span class="mpre"> </span><a href="#loc_223_22_223_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_22_223_34&#39;)"><span class="hl_varref"><span class="mpre">to_sz_bytes&#39;</span></span></a><span class="mpre">
                 </span><a href="#loc_218_11_218_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_11_218_13&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_218_14_218_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_14_218_23&#39;)"><span class="hl_varref"><span class="mpre">iteration</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">) </span><a href="#loc_224_18_224_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_18_224_23&#39;)"><span class="hl_varref"><span class="mpre">to_p&#39;</span></span></a><span class="mpre"> </span><a href="#loc_223_22_223_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_22_223_34&#39;)"><span class="hl_varref"><span class="mpre">to_sz_bytes&#39;</span></span></a><span class="mpre">
             </span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> </span><a name="loc_226_19_226_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_19_226_22&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_226_19_226_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_226_19_226_22&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">

      </span><span class="hl_comment"><span class="mpre">-- If the input string is ASCII, this value will ensure we only allocate once</span></span><span class="mpre">
      let </span><a name="loc_229_11_229_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_229_11_229_22&#39;)"><span class="hl_vardecl"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre"> = </span><a href="#loc_156_1_156_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_1_156_10&#39;)"><span class="hl_varref"><span class="mpre">cCharSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> (</span><a href="#loc_215_62_215_64" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_62_215_64&#39;)"><span class="hl_varref"><span class="mpre">sz</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
      </span><a name="loc_230_7_230_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_230_7_230_11&#39;)"><span class="hl_vardecl"><span class="mpre">to_p</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">mallocBytes</span></span><span class="mpre"> </span><a href="#loc_229_11_229_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_229_11_229_22&#39;)"><span class="hl_varref"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre">
      </span><a href="#loc_218_11_218_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_11_218_13&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> (</span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">) </span><a href="#loc_230_7_230_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_230_7_230_11&#39;)"><span class="hl_varref"><span class="mpre">to_p</span></span></a><span class="mpre"> </span><a href="#loc_229_11_229_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_229_11_229_22&#39;)"><span class="hl_varref"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre">


</span><a href="#loc_236_1_236_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_1_236_21&#39;)"><span class="mpre">tryFillBufferAndCall</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">TextEncoder</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">dstate</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre"> -&gt; </span><a href="GHC.IO.Buffer.html#loc_180_6_180_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_180_6_180_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
                     -&gt; (</span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="hl_tyconref"><span class="mpre">Maybe</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_236_1_236_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_1_236_21&#39;)"><span class="hl_fundecl"><span class="mpre">tryFillBufferAndCall</span></span></a><span class="mpre"> </span><a name="loc_236_22_236_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_22_236_29&#39;)"><span class="hl_vardecl"><span class="mpre">encoder</span></span></a><span class="mpre"> </span><a name="loc_236_30_236_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_30_236_44&#39;)"><span class="hl_vardecl"><span class="mpre">null_terminate</span></span></a><span class="mpre"> </span><a name="loc_236_45_236_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_45_236_50&#39;)"><span class="hl_vardecl"><span class="mpre">from0</span></span></a><span class="mpre"> </span><a name="loc_236_51_236_55" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_51_236_55&#39;)"><span class="hl_vardecl"><span class="mpre">to_p</span></span></a><span class="mpre"> </span><a name="loc_236_56_236_67" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_56_236_67&#39;)"><span class="hl_vardecl"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre"> </span><a name="loc_236_68_236_71" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_68_236_71&#39;)"><span class="hl_vardecl"><span class="mpre">act</span></span></a><span class="mpre"> = do
    </span><a name="loc_237_5_237_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_5_237_10&#39;)"><span class="hl_vardecl"><span class="mpre">to_fp</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newForeignPtr_</span></span><span class="mpre"> </span><a href="#loc_236_51_236_55" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_51_236_55&#39;)"><span class="hl_varref"><span class="mpre">to_p</span></span></a><span class="mpre">
    </span><a href="#loc_240_5_240_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_5_240_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> (</span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">) (</span><a href="#loc_236_45_236_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_45_236_50&#39;)"><span class="hl_varref"><span class="mpre">from0</span></span></a><span class="mpre">, </span><a href="GHC.IO.Buffer.html#loc_240_1_240_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_240_1_240_12&#39;)"><span class="hl_varref"><span class="mpre">emptyBuffer</span></span></a><span class="mpre"> </span><a href="#loc_237_5_237_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_5_237_10&#39;)"><span class="hl_varref"><span class="mpre">to_fp</span></span></a><span class="mpre"> </span><a href="#loc_236_56_236_67" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_56_236_67&#39;)"><span class="hl_varref"><span class="mpre">to_sz_bytes</span></span></a><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_195_33_195_44" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_195_33_195_44&#39;)"><span class="hl_conref"><span class="mpre">WriteBuffer</span></span></a><span class="mpre">)
  where
    </span><a name="loc_240_5_240_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_5_240_7&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> </span><a name="loc_240_8_240_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_8_240_17&#39;)"><span class="hl_vardecl"><span class="mpre">iteration</span></span></a><span class="mpre"> (</span><a name="loc_240_19_240_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_19_240_23&#39;)"><span class="hl_vardecl"><span class="mpre">from</span></span></a><span class="mpre">, </span><a name="loc_240_25_240_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_25_240_27&#39;)"><span class="hl_vardecl"><span class="mpre">to</span></span></a><span class="mpre">) = do
      (</span><a name="loc_241_8_241_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_8_241_11&#39;)"><span class="hl_vardecl"><span class="mpre">why</span></span></a><span class="mpre">, </span><a name="loc_241_13_241_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_13_241_18&#39;)"><span class="hl_vardecl"><span class="mpre">from&#39;</span></span></a><span class="mpre">, </span><a name="loc_241_20_241_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_20_241_23&#39;)"><span class="hl_vardecl"><span class="mpre">to&#39;</span></span></a><span class="mpre">) &lt;- </span><a href="GHC.IO.Encoding.Types.html#loc_37_3_37_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_37_3_37_9&#39;)"><span class="hl_varref"><span class="mpre">encode</span></span></a><span class="mpre"> </span><a href="#loc_236_22_236_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_22_236_29&#39;)"><span class="hl_varref"><span class="mpre">encoder</span></span></a><span class="mpre"> </span><a href="#loc_240_19_240_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_19_240_23&#39;)"><span class="hl_varref"><span class="mpre">from</span></span></a><span class="mpre"> </span><a href="#loc_240_25_240_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_25_240_27&#39;)"><span class="hl_varref"><span class="mpre">to</span></span></a><span class="mpre">
      </span><a href="#loc_72_1_72_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_1_72_12&#39;)"><span class="hl_varref"><span class="mpre">putDebugMsg</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;tryFillBufferAndCall: &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_240_8_240_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_8_240_17&#39;)"><span class="hl_varref"><span class="mpre">iteration</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot; &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_241_8_241_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_8_241_11&#39;)"><span class="hl_varref"><span class="mpre">why</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot; &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_267_1_267_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_267_1_267_14&#39;)"><span class="hl_varref"><span class="mpre">summaryBuffer</span></span></a><span class="mpre"> </span><a href="#loc_240_19_240_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_19_240_23&#39;)"><span class="hl_varref"><span class="mpre">from</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot; &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_267_1_267_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_267_1_267_14&#39;)"><span class="hl_varref"><span class="mpre">summaryBuffer</span></span></a><span class="mpre"> </span><a href="#loc_241_13_241_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_13_241_18&#39;)"><span class="hl_varref"><span class="mpre">from&#39;</span></span></a><span class="mpre">)
      if </span><a href="GHC.IO.Buffer.html#loc_204_1_204_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_204_1_204_14&#39;)"><span class="hl_varref"><span class="mpre">isEmptyBuffer</span></span></a><span class="mpre"> </span><a href="#loc_241_13_241_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_13_241_18&#39;)"><span class="hl_varref"><span class="mpre">from&#39;</span></span></a><span class="mpre">
       then if </span><a href="#loc_236_30_236_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_30_236_44&#39;)"><span class="hl_varref"><span class="mpre">null_terminate</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_226_1_226_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_226_1_226_16&#39;)"><span class="hl_varref"><span class="mpre">bufferAvailable</span></span></a><span class="mpre"> </span><a href="#loc_241_20_241_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_20_241_23&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
             then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- We had enough for the string but not the terminator: ask the caller for more buffer</span></span><span class="mpre">
             else do
               </span><span class="hl_comment"><span class="mpre">-- Awesome, we had enough buffer</span></span><span class="mpre">
               let </span><a name="loc_248_20_248_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_20_248_25&#39;)"><span class="hl_vardecl"><span class="mpre">bytes</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Buffer.html#loc_223_1_223_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_223_1_223_12&#39;)"><span class="hl_varref"><span class="mpre">bufferElems</span></span></a><span class="mpre"> </span><a href="#loc_241_20_241_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_20_241_23&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre">
               </span><a href="GHC.IO.Buffer.html#loc_198_1_198_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_198_1_198_11&#39;)"><span class="hl_varref"><span class="mpre">withBuffer</span></span></a><span class="mpre"> </span><a href="#loc_241_20_241_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_20_241_23&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_249_34_249_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_34_249_40&#39;)"><span class="hl_vardecl"><span class="mpre">to_ptr</span></span></a><span class="mpre"> -&gt; do
                   </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> </span><a href="#loc_236_30_236_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_30_236_44&#39;)"><span class="hl_varref"><span class="mpre">null_terminate</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">pokeElemOff</span></span><span class="mpre"> </span><a href="#loc_249_34_249_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_34_249_40&#39;)"><span class="hl_varref"><span class="mpre">to_ptr</span></span></a><span class="mpre"> (</span><a href="GHC.IO.Buffer.html#loc_186_9_186_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_186_9_186_13&#39;)"><span class="hl_varref"><span class="mpre">bufR</span></span></a><span class="mpre"> </span><a href="#loc_241_20_241_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_20_241_23&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre">) </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
                   </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_236_68_236_71" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_68_236_71&#39;)"><span class="hl_varref"><span class="mpre">act</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_249_34_249_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_34_249_40&#39;)"><span class="hl_varref"><span class="mpre">to_ptr</span></span></a><span class="mpre">, </span><a href="#loc_248_20_248_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_20_248_25&#39;)"><span class="hl_varref"><span class="mpre">bytes</span></span></a><span class="mpre">) </span><span class="hl_comment"><span class="mpre">-- NB: the length information is specified as being in *bytes*</span></span><span class="mpre">
       else case </span><a href="#loc_241_8_241_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_8_241_11&#39;)"><span class="hl_varref"><span class="mpre">why</span></span></a><span class="mpre"> of </span><span class="hl_comment"><span class="mpre">-- We didn&#39;t consume all of the input</span></span><span class="mpre">
              </span><a href="GHC.IO.Encoding.Types.html#loc_125_23_125_37" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_125_23_125_37&#39;)"><span class="hl_conref"><span class="mpre">InputUnderflow</span></span></a><span class="mpre">  -&gt; </span><a href="GHC.IO.Encoding.Types.html#loc_53_3_53_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_53_3_53_10&#39;)"><span class="hl_varref"><span class="mpre">recover</span></span></a><span class="mpre"> </span><a href="#loc_236_22_236_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_22_236_29&#39;)"><span class="hl_varref"><span class="mpre">encoder</span></span></a><span class="mpre"> </span><a href="#loc_241_13_241_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_13_241_18&#39;)"><span class="hl_varref"><span class="mpre">from&#39;</span></span></a><span class="mpre"> </span><a href="#loc_241_20_241_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_20_241_23&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_240_5_240_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_5_240_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_240_8_240_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_8_240_17&#39;)"><span class="hl_varref"><span class="mpre">iteration</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">) </span><span class="hl_comment"><span class="mpre">-- These conditions are equally bad</span></span><span class="mpre">
              </span><a href="GHC.IO.Encoding.Types.html#loc_128_23_128_38" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_128_23_128_38&#39;)"><span class="hl_conref"><span class="mpre">InvalidSequence</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.IO.Encoding.Types.html#loc_53_3_53_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_53_3_53_10&#39;)"><span class="hl_varref"><span class="mpre">recover</span></span></a><span class="mpre"> </span><a href="#loc_236_22_236_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_22_236_29&#39;)"><span class="hl_varref"><span class="mpre">encoder</span></span></a><span class="mpre"> </span><a href="#loc_241_13_241_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_13_241_18&#39;)"><span class="hl_varref"><span class="mpre">from&#39;</span></span></a><span class="mpre"> </span><a href="#loc_241_20_241_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_20_241_23&#39;)"><span class="hl_varref"><span class="mpre">to&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_240_5_240_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_5_240_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_240_8_240_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_8_240_17&#39;)"><span class="hl_varref"><span class="mpre">iteration</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">) </span><span class="hl_comment"><span class="mpre">-- since the input was truncated/invalid</span></span><span class="mpre">
              </span><a href="GHC.IO.Encoding.Types.html#loc_127_23_127_38" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Encoding.Types.html#loc_127_23_127_38&#39;)"><span class="hl_conref"><span class="mpre">OutputUnderflow</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- Oops, out of buffer during decoding: ask the caller for more</span></span><span class="mpre">

</span></div></body></html>