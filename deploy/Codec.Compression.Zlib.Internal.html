<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE CPP #-}
</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   :  (c) 2006-2008 Duncan Coutts</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     :  BSD-style</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  :  duncan@haskell.org</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   :  provisional</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability :  portable (H98 + FFI)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Pure stream based interface to lower level zlib wrapper</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">
module Codec.Compression.Zlib.Internal (

  </span><span class="hl_comment"><span class="mpre">-- * Compression</span></span><span class="mpre">
  compress,
  CompressParams(..),
  defaultCompressParams,

  </span><span class="hl_comment"><span class="mpre">-- * Decompression</span></span><span class="mpre">
  decompress,
  DecompressParams(..),
  defaultDecompressParams,

  </span><span class="hl_comment"><span class="mpre">-- * The compression parameter types</span></span><span class="mpre">
  Stream.Format(..),
    Stream.gzipFormat,
    Stream.zlibFormat,
    Stream.rawFormat,
    Stream.gzipOrZlibFormat,
  Stream.CompressionLevel(..),
    Stream.defaultCompression,
    Stream.noCompression,
    Stream.bestSpeed,
    Stream.bestCompression,
    Stream.compressionLevel,
  Stream.Method(..),
    Stream.deflateMethod,
  Stream.WindowBits(..),
    Stream.defaultWindowBits,
    Stream.windowBits,
  Stream.MemoryLevel(..),
    Stream.defaultMemoryLevel,
    Stream.minMemoryLevel,
    Stream.maxMemoryLevel,
    Stream.memoryLevel,
  Stream.CompressionStrategy(..),
    Stream.defaultStrategy,
    Stream.filteredStrategy,
    Stream.huffmanOnlyStrategy,

  </span><span class="hl_comment"><span class="mpre">-- * Low-level API to get explicit error reports</span></span><span class="mpre">
  decompressWithErrors,
  DecompressStream(..),
  DecompressError(..),
  foldDecompressStream,
  fromDecompressStream,
  ) where

import Prelude hiding (length)
import Control.Monad (</span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="mpre">when</span></a><span class="mpre">)
import Control.Exception (assert)
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/zlib-0.5.4.1/Codec/Compression/Zlib/Internal.hs&quot;, srcSpanStartLine = 64, srcSpanStartColumn = 18, srcSpanEndLine = 64, srcSpanEndColumn = 38}, srcInfoPoints = []}) &quot;Data.ByteString.Lazy&quot;"><span class="mpre">Data.ByteString.Lazy</span></span><span class="mpre"> as L
import qualified Data.ByteString.Lazy.Internal as L
import qualified Data.ByteString.Internal as S

import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/zlib-0.5.4.1/Codec/Compression/Zlib/Internal.hs&quot;, srcSpanStartLine = 68, srcSpanStartColumn = 18, srcSpanEndLine = 68, srcSpanEndColumn = 47}, srcInfoPoints = []}) &quot;Codec.Compression.Zlib.Stream&quot;"><span class="mpre">Codec.Compression.Zlib.Stream</span></span><span class="mpre"> as Stream
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/zlib-0.5.4.1/Codec/Compression/Zlib/Internal.hs&quot;, srcSpanStartLine = 69, srcSpanStartColumn = 8, srcSpanEndLine = 69, srcSpanEndColumn = 37}, srcInfoPoints = []}) &quot;Codec.Compression.Zlib.Stream&quot;"><span class="mpre">Codec.Compression.Zlib.Stream</span></span><span class="mpre"> (Stream)

</span><span class="hl_comment"><span class="mpre">-- | The full set of parameters for compression. The defaults are</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;defaultCompressParams&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The &#39;compressBufferSize&#39; is the size of the first output buffer containing</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the compressed data. If you know an approximate upper bound on the size of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the compressed data then setting this parameter can save memory. The default</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- compression output buffer size is @16k@. If your extimate is wrong it does</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- not matter too much, the default buffer size will be used for the remaining</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- chunks.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
data </span><a name="loc_81_6_81_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_6_81_20&#39;)"><span class="hl_tycondecl"><span class="mpre">CompressParams</span></span></a><span class="mpre"> = </span><a name="loc_81_23_81_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_23_81_37&#39;)"><span class="hl_condecl"><span class="mpre">CompressParams</span></span></a><span class="mpre"> {
  </span><a name="loc_82_3_82_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_3_82_16&#39;)"><span class="hl_fielddecl"><span class="mpre">compressLevel</span></span></a><span class="mpre">       :: !</span><span class="hl_tyconref"><span class="mpre">Stream.CompressionLevel</span></span><span class="mpre">,
  </span><a name="loc_83_3_83_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_3_83_17&#39;)"><span class="hl_fielddecl"><span class="mpre">compressMethod</span></span></a><span class="mpre">      :: !</span><span class="hl_tyconref"><span class="mpre">Stream.Method</span></span><span class="mpre">,
  </span><a name="loc_84_3_84_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_3_84_21&#39;)"><span class="hl_fielddecl"><span class="mpre">compressWindowBits</span></span></a><span class="mpre">  :: !</span><span class="hl_tyconref"><span class="mpre">Stream.WindowBits</span></span><span class="mpre">,
  </span><a name="loc_85_3_85_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_3_85_22&#39;)"><span class="hl_fielddecl"><span class="mpre">compressMemoryLevel</span></span></a><span class="mpre"> :: !</span><span class="hl_tyconref"><span class="mpre">Stream.MemoryLevel</span></span><span class="mpre">,
  </span><a name="loc_86_3_86_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_3_86_19&#39;)"><span class="hl_fielddecl"><span class="mpre">compressStrategy</span></span></a><span class="mpre">    :: !</span><span class="hl_tyconref"><span class="mpre">Stream.CompressionStrategy</span></span><span class="mpre">,
  </span><a name="loc_87_3_87_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_3_87_21&#39;)"><span class="hl_fielddecl"><span class="mpre">compressBufferSize</span></span></a><span class="mpre">  :: !</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">,
  </span><a name="loc_88_3_88_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_88_3_88_21&#39;)"><span class="hl_fielddecl"><span class="mpre">compressDictionary</span></span></a><span class="mpre">  :: </span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="hl_tyconref"><span class="mpre">Maybe</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
}

</span><span class="hl_comment"><span class="mpre">-- | The full set of parameters for decompression. The defaults are</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;defaultDecompressParams&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The &#39;decompressBufferSize&#39; is the size of the first output buffer,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- containing the uncompressed data. If you know an exact or approximate upper</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- bound on the size of the decompressed data then setting this parameter can</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- save memory. The default decompression output buffer size is @32k@. If your</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- extimate is wrong it does not matter too much, the default buffer size will</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- be used for the remaining chunks.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- One particular use case for setting the &#39;decompressBufferSize&#39; is if you</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- know the exact size of the decompressed data and want to produce a strict</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;Data.ByteString.ByteString&#39;. The compression and deccompression functions</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- use lazy &#39;Data.ByteString.Lazy.ByteString&#39;s but if you set the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;decompressBufferSize&#39; correctly then you can generate a lazy</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;Data.ByteString.Lazy.ByteString&#39; with exactly one chunk, which can be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- converted to a strict &#39;Data.ByteString.ByteString&#39; in @O(1)@ time using</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @&#39;Data.ByteString.concat&#39; . &#39;Data.ByteString.Lazy.toChunks&#39;@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
data </span><a name="loc_110_6_110_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_6_110_22&#39;)"><span class="hl_tycondecl"><span class="mpre">DecompressParams</span></span></a><span class="mpre"> = </span><a name="loc_110_25_110_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_25_110_41&#39;)"><span class="hl_condecl"><span class="mpre">DecompressParams</span></span></a><span class="mpre"> {
  </span><a name="loc_111_3_111_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_3_111_23&#39;)"><span class="hl_fielddecl"><span class="mpre">decompressWindowBits</span></span></a><span class="mpre"> :: !</span><span class="hl_tyconref"><span class="mpre">Stream.WindowBits</span></span><span class="mpre">,
  </span><a name="loc_112_3_112_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_3_112_23&#39;)"><span class="hl_fielddecl"><span class="mpre">decompressBufferSize</span></span></a><span class="mpre"> :: !</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">,
  </span><a name="loc_113_3_113_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_3_113_23&#39;)"><span class="hl_fielddecl"><span class="mpre">decompressDictionary</span></span></a><span class="mpre"> :: </span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="hl_tyconref"><span class="mpre">Maybe</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
}

</span><span class="hl_comment"><span class="mpre">-- | The default set of parameters for compression. This is typically used with</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the @compressWith@ function with specific parameters overridden.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_120_1_120_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_1_120_22&#39;)"><span class="mpre">defaultCompressParams</span></a><span class="mpre"> :: </span><a href="#loc_81_6_81_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_6_81_20&#39;)"><span class="hl_tyconref"><span class="mpre">CompressParams</span></span></a><span class="mpre">
</span><a name="loc_120_1_120_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_1_120_22&#39;)"><span class="hl_vardecl"><span class="mpre">defaultCompressParams</span></span></a><span class="mpre"> = </span><span class="warning" data-warning="ExpRecConstr (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/zlib-0.5.4.1/Codec/Compression/Zlib/Internal.hs&quot;, srcSpanStartLine = 120, srcSpanStartColumn = 25, srcSpanEndLine = 128, srcSpanEndColumn = 2}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/zlib-0.5.4.1/Codec/Compression/Zlib/Internal.hs&quot;, srcSpanStartLine = 120, srcSpanStartColumn = 40, srcSpanEndLine = 120, srcSpanEndColumn = 41},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/zlib-0.5.4.1/Codec/Compre"><span class="mpre">CompressParams {
  compressLevel       = Stream.defaultCompression,
  compressMethod      = Stream.deflateMethod,
  compressWindowBits  = Stream.defaultWindowBits,
  compressMemoryLevel = Stream.defaultMemoryLevel,
  compressStrategy    = Stream.defaultStrategy,
  compressBufferSize  = defaultCompressBufferSize,
  compressDictionary  = Nothing
}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The default set of parameters for decompression. This is typically used with</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the @compressWith@ function with specific parameters overridden.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_134_1_134_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_1_134_24&#39;)"><span class="mpre">defaultDecompressParams</span></a><span class="mpre"> :: </span><a href="#loc_110_6_110_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_6_110_22&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressParams</span></span></a><span class="mpre">
</span><a name="loc_134_1_134_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_1_134_24&#39;)"><span class="hl_vardecl"><span class="mpre">defaultDecompressParams</span></span></a><span class="mpre"> = </span><span class="warning" data-warning="ExpRecConstr (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/zlib-0.5.4.1/Codec/Compression/Zlib/Internal.hs&quot;, srcSpanStartLine = 134, srcSpanStartColumn = 27, srcSpanEndLine = 138, srcSpanEndColumn = 2}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/zlib-0.5.4.1/Codec/Compression/Zlib/Internal.hs&quot;, srcSpanStartLine = 134, srcSpanStartColumn = 44, srcSpanEndLine = 134, srcSpanEndColumn = 45},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/zlib-0.5.4.1/Codec/Compre"><span class="mpre">DecompressParams {
  decompressWindowBits = Stream.defaultWindowBits,
  decompressBufferSize = defaultDecompressBufferSize,
  decompressDictionary = Nothing
}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The default chunk sizes for the output of compression and decompression</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- are 16k and 32k respectively (less a small accounting overhead).</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_144_1_144_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_1_144_26&#39;)"><span class="mpre">defaultCompressBufferSize</span></a><span class="mpre">, </span><a href="#loc_145_1_145_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_1_145_28&#39;)"><span class="mpre">defaultDecompressBufferSize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_144_1_144_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_1_144_26&#39;)"><span class="hl_vardecl"><span class="mpre">defaultCompressBufferSize</span></span></a><span class="mpre">   = </span><span class="hl_num"><span class="mpre">16</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1024</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_218_1_218_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_218_1_218_14&#39;)"><span class="hl_varref"><span class="mpre">L.chunkOverhead</span></span></a><span class="mpre">
</span><a name="loc_145_1_145_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_1_145_28&#39;)"><span class="hl_vardecl"><span class="mpre">defaultDecompressBufferSize</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">32</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1024</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_218_1_218_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_218_1_218_14&#39;)"><span class="hl_varref"><span class="mpre">L.chunkOverhead</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A sequence of chunks of data produced from decompression.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The difference from a simple list is that it contains a representation of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- errors as data rather than as exceptions. This allows you to handle error</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- conditions explicitly.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
data </span><a name="loc_153_6_153_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_6_153_22&#39;)"><span class="hl_tycondecl"><span class="mpre">DecompressStream</span></span></a><span class="mpre"> = </span><a name="loc_153_25_153_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_25_153_34&#39;)"><span class="hl_condecl"><span class="mpre">StreamEnd</span></span></a><span class="mpre">
                      | </span><a name="loc_154_25_154_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_25_154_36&#39;)"><span class="hl_condecl"><span class="mpre">StreamChunk</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> </span><a href="#loc_153_6_153_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_6_153_22&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressStream</span></span></a><span class="mpre">

                        </span><span class="hl_comment"><span class="mpre">-- | An error code and a human readable error message.</span></span><span class="mpre">
                      | </span><a name="loc_157_25_157_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_25_157_36&#39;)"><span class="hl_condecl"><span class="mpre">StreamError</span></span></a><span class="mpre"> </span><a href="#loc_161_6_161_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_6_161_21&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressError</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The possible error cases when decompressing a stream.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
data </span><a name="loc_161_6_161_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_6_161_21&#39;)"><span class="hl_tycondecl"><span class="mpre">DecompressError</span></span></a><span class="mpre"> =
     </span><span class="hl_comment"><span class="mpre">-- | The compressed data stream ended prematurely. This may happen if the</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- input data stream was truncated.</span></span><span class="mpre">
     </span><a name="loc_164_6_164_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_6_164_20&#39;)"><span class="hl_condecl"><span class="mpre">TruncatedInput</span></span></a><span class="mpre">

     </span><span class="hl_comment"><span class="mpre">-- | It is possible to do zlib compression with a custom dictionary. This</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- allows slightly higher compression ratios for short files. However such</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- compressed streams require the same dictionary when decompressing. This</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- error is for when we encounter a compressed stream that needs a</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- dictionary, and it&#39;s not provided.</span></span><span class="mpre">
   | </span><a name="loc_171_6_171_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_171_6_171_24&#39;)"><span class="hl_condecl"><span class="mpre">DictionaryRequired</span></span></a><span class="mpre">

     </span><span class="hl_comment"><span class="mpre">-- | If the compressed data stream is corrupted in any way then you will</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- get this error, for example if the input data just isn&#39;t a compressed</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- zlib data stream. In particular if the data checksum turns out to be</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- wrong then you will get all the decompressed data but this error at the</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- end, instead of the normal sucessful &#39;StreamEnd&#39;.</span></span><span class="mpre">
   | </span><a name="loc_178_6_178_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_6_178_15&#39;)"><span class="hl_condecl"><span class="mpre">DataError</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Fold an &#39;DecompressionStream&#39;. Just like &#39;foldr&#39; but with an extra error</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- case. For example to convert to a list and translate the errors into</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- exceptions:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; foldDecompressStream (:) [] (\code msg -&gt; error msg)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_189_1_189_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_1_189_21&#39;)"><span class="mpre">foldDecompressStream</span></a><span class="mpre"> :: (</span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
                 -&gt; (</span><a href="#loc_161_6_161_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_6_161_21&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressError</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
                 -&gt; </span><a href="#loc_153_6_153_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_6_153_22&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressStream</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_189_1_189_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_1_189_21&#39;)"><span class="hl_fundecl"><span class="mpre">foldDecompressStream</span></span></a><span class="mpre"> </span><a name="loc_189_22_189_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_22_189_27&#39;)"><span class="hl_vardecl"><span class="mpre">chunk</span></span></a><span class="mpre"> </span><a name="loc_189_28_189_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_28_189_31&#39;)"><span class="hl_vardecl"><span class="mpre">end</span></span></a><span class="mpre"> </span><a name="loc_189_32_189_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_32_189_35&#39;)"><span class="hl_vardecl"><span class="mpre">err</span></span></a><span class="mpre"> = </span><a href="#loc_191_5_191_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_5_191_9&#39;)"><span class="hl_varref"><span class="mpre">fold</span></span></a><span class="mpre">
  where
    </span><a name="loc_191_5_191_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_5_191_9&#39;)"><span class="hl_fundecl"><span class="mpre">fold</span></span></a><span class="mpre"> </span><a href="#loc_153_25_153_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_25_153_34&#39;)"><span class="hl_conref"><span class="mpre">StreamEnd</span></span></a><span class="mpre">               = </span><a href="#loc_189_28_189_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_28_189_31&#39;)"><span class="hl_varref"><span class="mpre">end</span></span></a><span class="mpre">
    </span><a href="#loc_191_5_191_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_5_191_9&#39;)"><span class="hl_fundecl"><span class="mpre">fold</span></span></a><span class="mpre"> (</span><a href="#loc_154_25_154_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_25_154_36&#39;)"><span class="hl_conref"><span class="mpre">StreamChunk</span></span></a><span class="mpre"> </span><a name="loc_192_23_192_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_23_192_25&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_192_26_192_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_26_192_32&#39;)"><span class="hl_vardecl"><span class="mpre">stream</span></span></a><span class="mpre">) = </span><a href="#loc_189_22_189_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_22_189_27&#39;)"><span class="hl_varref"><span class="mpre">chunk</span></span></a><span class="mpre"> </span><a href="#loc_192_23_192_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_23_192_25&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> (</span><a href="#loc_191_5_191_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_5_191_9&#39;)"><span class="hl_varref"><span class="mpre">fold</span></span></a><span class="mpre"> </span><a href="#loc_192_26_192_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_26_192_32&#39;)"><span class="hl_varref"><span class="mpre">stream</span></span></a><span class="mpre">)
    </span><a href="#loc_191_5_191_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_5_191_9&#39;)"><span class="hl_fundecl"><span class="mpre">fold</span></span></a><span class="mpre"> (</span><a href="#loc_157_25_157_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_25_157_36&#39;)"><span class="hl_conref"><span class="mpre">StreamError</span></span></a><span class="mpre"> </span><a name="loc_193_23_193_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_23_193_27&#39;)"><span class="hl_vardecl"><span class="mpre">code</span></span></a><span class="mpre"> </span><a name="loc_193_28_193_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_28_193_31&#39;)"><span class="hl_vardecl"><span class="mpre">msg</span></span></a><span class="mpre">)  = </span><a href="#loc_189_32_189_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_32_189_35&#39;)"><span class="hl_varref"><span class="mpre">err</span></span></a><span class="mpre"> </span><a href="#loc_193_23_193_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_23_193_27&#39;)"><span class="hl_varref"><span class="mpre">code</span></span></a><span class="mpre"> </span><a href="#loc_193_28_193_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_193_28_193_31&#39;)"><span class="hl_varref"><span class="mpre">msg</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Convert a &#39;DecompressStream&#39; to a lazy &#39;ByteString&#39;. If any decompression</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- errors are encountered then they are thrown as exceptions.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This is a special case of &#39;foldDecompressStream&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_201_1_201_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_1_201_21&#39;)"><span class="mpre">fromDecompressStream</span></a><span class="mpre"> :: </span><a href="#loc_153_6_153_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_6_153_22&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressStream</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
</span><a name="loc_201_1_201_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_1_201_21&#39;)"><span class="hl_vardecl"><span class="mpre">fromDecompressStream</span></span></a><span class="mpre"> =
  </span><a href="#loc_189_1_189_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_1_189_21&#39;)"><span class="hl_varref"><span class="mpre">foldDecompressStream</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_19_82_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_19_82_24&#39;)"><span class="hl_conref"><span class="mpre">L.Empty</span></span></a><span class="mpre">
    (\</span><span class="hl_vardecl"><span class="mpre">_code</span></span><span class="mpre"> </span><a name="loc_203_13_203_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_13_203_16&#39;)"><span class="hl_vardecl"><span class="mpre">msg</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;Codec.Compression.Zlib: &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><a href="#loc_203_13_203_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_13_203_16&#39;)"><span class="hl_varref"><span class="mpre">msg</span></span></a><span class="mpre">))

</span><span class="hl_comment"><span class="mpre">--TODO: throw DecompressError as an Exception class type and document that it</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- does this.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Compress a data stream.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- There are no expected error conditions. All input data streams are valid. It</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- is possible for unexpected errors to occur, such as running out of memory,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- or finding the wrong version of the zlib C library, these are thrown as</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- exceptions.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_220_1_220_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_220_1_220_9&#39;)"><span class="mpre">compress</span></a><span class="mpre">
  :: </span><span class="hl_tyconref"><span class="mpre">Stream.Format</span></span><span class="mpre">
  -&gt; </span><a href="#loc_81_6_81_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_6_81_20&#39;)"><span class="hl_tyconref"><span class="mpre">CompressParams</span></span></a><span class="mpre">
  -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
  -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
</span><a name="loc_220_1_220_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_220_1_220_9&#39;)"><span class="hl_fundecl"><span class="mpre">compress</span></span></a><span class="mpre"> </span><a name="loc_220_10_220_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_220_10_220_16&#39;)"><span class="hl_vardecl"><span class="mpre">format</span></span></a><span class="mpre">
  (</span><a href="#loc_81_23_81_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_23_81_37&#39;)"><span class="hl_conref"><span class="mpre">CompressParams</span></span></a><span class="mpre"> </span><a name="loc_221_19_221_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_19_221_28&#39;)"><span class="hl_vardecl"><span class="mpre">compLevel</span></span></a><span class="mpre"> </span><a name="loc_221_29_221_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_29_221_35&#39;)"><span class="hl_vardecl"><span class="mpre">method</span></span></a><span class="mpre"> </span><a name="loc_221_36_221_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_36_221_40&#39;)"><span class="hl_vardecl"><span class="mpre">bits</span></span></a><span class="mpre"> </span><a name="loc_221_41_221_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_41_221_49&#39;)"><span class="hl_vardecl"><span class="mpre">memLevel</span></span></a><span class="mpre"> </span><a name="loc_221_50_221_58" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_50_221_58&#39;)"><span class="hl_vardecl"><span class="mpre">strategy</span></span></a><span class="mpre"> </span><a name="loc_221_59_221_72" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_59_221_72&#39;)"><span class="hl_vardecl"><span class="mpre">initChunkSize</span></span></a><span class="mpre"> </span><a name="loc_221_73_221_78" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_73_221_78&#39;)"><span class="hl_vardecl"><span class="mpre">mdict</span></span></a><span class="mpre">)
  </span><a name="loc_222_3_222_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_3_222_8&#39;)"><span class="hl_vardecl"><span class="mpre">input</span></span></a><span class="mpre"> =
  </span><span class="hl_varref"><span class="mpre">L.fromChunks</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">Stream.run</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
    </span><span class="hl_varref"><span class="mpre">Stream.deflateInit</span></span><span class="mpre"> </span><a href="#loc_220_10_220_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_220_10_220_16&#39;)"><span class="hl_varref"><span class="mpre">format</span></span></a><span class="mpre"> </span><a href="#loc_221_19_221_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_19_221_28&#39;)"><span class="hl_varref"><span class="mpre">compLevel</span></span></a><span class="mpre"> </span><a href="#loc_221_29_221_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_29_221_35&#39;)"><span class="hl_varref"><span class="mpre">method</span></span></a><span class="mpre"> </span><a href="#loc_221_36_221_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_36_221_40&#39;)"><span class="hl_varref"><span class="mpre">bits</span></span></a><span class="mpre"> </span><a href="#loc_221_41_221_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_41_221_49&#39;)"><span class="hl_varref"><span class="mpre">memLevel</span></span></a><span class="mpre"> </span><a href="#loc_221_50_221_58" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_50_221_58&#39;)"><span class="hl_varref"><span class="mpre">strategy</span></span></a><span class="mpre">
    </span><a href="#loc_315_3_315_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_315_3_315_16&#39;)"><span class="hl_varref"><span class="mpre">setDictionary</span></span></a><span class="mpre"> </span><a href="#loc_221_73_221_78" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_73_221_78&#39;)"><span class="hl_varref"><span class="mpre">mdict</span></span></a><span class="mpre">
    case </span><span class="hl_varref"><span class="mpre">L.toChunks</span></span><span class="mpre"> </span><a href="#loc_222_3_222_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_3_222_8&#39;)"><span class="hl_varref"><span class="mpre">input</span></span></a><span class="mpre"> of
      [] -&gt; </span><a href="#loc_243_3_243_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_3_243_14&#39;)"><span class="hl_varref"><span class="mpre">fillBuffers</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">20</span></span><span class="mpre"> [] </span><span class="hl_comment"><span class="mpre">--gzip header is 20 bytes, others even smaller</span></span><span class="mpre">
      </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a name="loc_228_12_228_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_12_228_18&#39;)"><span class="hl_vardecl"><span class="mpre">inFPtr</span></span></a><span class="mpre"> </span><a name="loc_228_19_228_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_19_228_25&#39;)"><span class="hl_vardecl"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a name="loc_228_26_228_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_26_228_32&#39;)"><span class="hl_vardecl"><span class="mpre">length</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a name="loc_228_35_228_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_35_228_41&#39;)"><span class="hl_vardecl"><span class="mpre">chunks</span></span></a><span class="mpre"> -&gt; do
        </span><span class="hl_varref"><span class="mpre">Stream.pushInputBuffer</span></span><span class="mpre"> </span><a href="#loc_228_12_228_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_12_228_18&#39;)"><span class="hl_varref"><span class="mpre">inFPtr</span></span></a><span class="mpre"> </span><a href="#loc_228_19_228_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_19_228_25&#39;)"><span class="hl_varref"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a href="#loc_228_26_228_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_26_228_32&#39;)"><span class="hl_varref"><span class="mpre">length</span></span></a><span class="mpre">
        </span><a name="loc_230_9_230_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_230_9_230_10&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_243_3_243_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_3_243_14&#39;)"><span class="hl_varref"><span class="mpre">fillBuffers</span></span></a><span class="mpre"> </span><a href="#loc_221_59_221_72" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_59_221_72&#39;)"><span class="hl_varref"><span class="mpre">initChunkSize</span></span></a><span class="mpre"> </span><a href="#loc_228_35_228_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_35_228_41&#39;)"><span class="hl_varref"><span class="mpre">chunks</span></span></a><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_230_9_230_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_230_9_230_10&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">

  where
    </span><span class="hl_comment"><span class="mpre">-- we flick between two states:</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--   * where one or other buffer is empty</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--       - in which case we refill one or both</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--   * where both buffers are non-empty</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--       - in which case we compress until a buffer is empty</span></span><span class="mpre">

  </span><a href="#loc_243_3_243_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_3_243_14&#39;)"><span class="mpre">fillBuffers</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
              -&gt; [</span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">]
              -&gt; </span><span class="hl_tyconref"><span class="mpre">Stream</span></span><span class="mpre"> [</span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">]
  </span><a name="loc_243_3_243_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_3_243_14&#39;)"><span class="hl_fundecl"><span class="mpre">fillBuffers</span></span></a><span class="mpre"> </span><a name="loc_243_15_243_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_15_243_27&#39;)"><span class="hl_vardecl"><span class="mpre">outChunkSize</span></span></a><span class="mpre"> </span><a name="loc_243_28_243_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_28_243_36&#39;)"><span class="hl_vardecl"><span class="mpre">inChunks</span></span></a><span class="mpre"> = do
#ifdef DEBUG
    </span><span class="hl_varref"><span class="mpre">Stream.consistencyCheck</span></span><span class="mpre">
#endif

    </span><span class="hl_comment"><span class="mpre">-- in this state there are two possabilities:</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--   * no outbut buffer space is available</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--       - in which case we must make more available</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--   * no input buffer is available</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--       - in which case we must supply more</span></span><span class="mpre">
    </span><a name="loc_253_5_253_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_253_5_253_21&#39;)"><span class="hl_vardecl"><span class="mpre">inputBufferEmpty</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.inputBufferEmpty</span></span><span class="mpre">
    </span><a name="loc_254_5_254_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_5_254_21&#39;)"><span class="hl_vardecl"><span class="mpre">outputBufferFull</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.outputBufferFull</span></span><span class="mpre">

    </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre"> (</span><a href="#loc_253_5_253_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_253_5_253_21&#39;)"><span class="hl_varref"><span class="mpre">inputBufferEmpty</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">||</span></span><span class="mpre"> </span><a href="#loc_254_5_254_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_5_254_21&#39;)"><span class="hl_varref"><span class="mpre">outputBufferFull</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">

    </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> </span><a href="#loc_254_5_254_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_5_254_21&#39;)"><span class="hl_varref"><span class="mpre">outputBufferFull</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
      </span><a name="loc_259_7_259_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_259_7_259_14&#39;)"><span class="hl_vardecl"><span class="mpre">outFPtr</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.unsafeLiftIO</span></span><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_489_1_489_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_489_1_489_17&#39;)"><span class="hl_varref"><span class="mpre">S.mallocByteString</span></span></a><span class="mpre"> </span><a href="#loc_243_15_243_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_15_243_27&#39;)"><span class="hl_varref"><span class="mpre">outChunkSize</span></span></a><span class="mpre">)
      </span><span class="hl_varref"><span class="mpre">Stream.pushOutputBuffer</span></span><span class="mpre"> </span><a href="#loc_259_7_259_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_259_7_259_14&#39;)"><span class="hl_varref"><span class="mpre">outFPtr</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><a href="#loc_243_15_243_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_15_243_27&#39;)"><span class="hl_varref"><span class="mpre">outChunkSize</span></span></a><span class="mpre">

    if </span><a href="#loc_253_5_253_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_253_5_253_21&#39;)"><span class="hl_varref"><span class="mpre">inputBufferEmpty</span></span></a><span class="mpre">
      then case </span><a href="#loc_243_28_243_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_28_243_36&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre"> of
             [] -&gt; </span><a href="#loc_274_3_274_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_3_274_15&#39;)"><span class="hl_varref"><span class="mpre">drainBuffers</span></span></a><span class="mpre"> []
             </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a name="loc_265_19_265_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_19_265_25&#39;)"><span class="hl_vardecl"><span class="mpre">inFPtr</span></span></a><span class="mpre"> </span><a name="loc_265_26_265_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_26_265_32&#39;)"><span class="hl_vardecl"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a name="loc_265_33_265_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_33_265_39&#39;)"><span class="hl_vardecl"><span class="mpre">length</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a name="loc_265_42_265_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_42_265_51&#39;)"><span class="hl_vardecl"><span class="mpre">inChunks&#39;</span></span></a><span class="mpre"> -&gt; do
                </span><span class="hl_varref"><span class="mpre">Stream.pushInputBuffer</span></span><span class="mpre"> </span><a href="#loc_265_19_265_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_19_265_25&#39;)"><span class="hl_varref"><span class="mpre">inFPtr</span></span></a><span class="mpre"> </span><a href="#loc_265_26_265_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_26_265_32&#39;)"><span class="hl_varref"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a href="#loc_265_33_265_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_33_265_39&#39;)"><span class="hl_varref"><span class="mpre">length</span></span></a><span class="mpre">
                </span><a href="#loc_274_3_274_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_3_274_15&#39;)"><span class="hl_varref"><span class="mpre">drainBuffers</span></span></a><span class="mpre"> </span><a href="#loc_265_42_265_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_42_265_51&#39;)"><span class="hl_varref"><span class="mpre">inChunks&#39;</span></span></a><span class="mpre">
      else </span><a href="#loc_274_3_274_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_3_274_15&#39;)"><span class="hl_varref"><span class="mpre">drainBuffers</span></span></a><span class="mpre"> </span><a href="#loc_243_28_243_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_28_243_36&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre">


  </span><a href="#loc_274_3_274_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_3_274_15&#39;)"><span class="mpre">drainBuffers</span></a><span class="mpre"> ::
      [</span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">]
   -&gt; </span><span class="hl_tyconref"><span class="mpre">Stream</span></span><span class="mpre"> [</span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">]
  </span><a name="loc_274_3_274_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_3_274_15&#39;)"><span class="hl_fundecl"><span class="mpre">drainBuffers</span></span></a><span class="mpre"> </span><a name="loc_274_16_274_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_16_274_24&#39;)"><span class="hl_vardecl"><span class="mpre">inChunks</span></span></a><span class="mpre"> = do

    </span><a name="loc_276_5_276_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_276_5_276_22&#39;)"><span class="hl_vardecl"><span class="mpre">inputBufferEmpty&#39;</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.inputBufferEmpty</span></span><span class="mpre">
    </span><a name="loc_277_5_277_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_277_5_277_22&#39;)"><span class="hl_vardecl"><span class="mpre">outputBufferFull&#39;</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.outputBufferFull</span></span><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre">(</span><span class="hl_varref"><span class="mpre">not</span></span><span class="mpre"> </span><a href="#loc_277_5_277_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_277_5_277_22&#39;)"><span class="hl_varref"><span class="mpre">outputBufferFull&#39;</span></span></a><span class="mpre">
       </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">null</span></span><span class="mpre"> </span><a href="#loc_274_16_274_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_16_274_24&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">||</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">not</span></span><span class="mpre"> </span><a href="#loc_276_5_276_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_276_5_276_22&#39;)"><span class="hl_varref"><span class="mpre">inputBufferEmpty&#39;</span></span></a><span class="mpre">)) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- this invariant guarantees we can always make forward progress</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- and that therefore a BufferError is impossible</span></span><span class="mpre">

    let </span><a name="loc_283_9_283_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_9_283_14&#39;)"><span class="hl_vardecl"><span class="mpre">flush</span></span></a><span class="mpre"> = if </span><span class="hl_varref"><span class="mpre">null</span></span><span class="mpre"> </span><a href="#loc_274_16_274_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_16_274_24&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre"> then </span><span class="hl_conref"><span class="mpre">Stream.Finish</span></span><span class="mpre"> else </span><span class="hl_conref"><span class="mpre">Stream.NoFlush</span></span><span class="mpre">
    </span><a name="loc_284_5_284_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_5_284_11&#39;)"><span class="hl_vardecl"><span class="mpre">status</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.deflate</span></span><span class="mpre"> </span><a href="#loc_283_9_283_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_9_283_14&#39;)"><span class="hl_varref"><span class="mpre">flush</span></span></a><span class="mpre">

    case </span><a href="#loc_284_5_284_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_5_284_11&#39;)"><span class="hl_varref"><span class="mpre">status</span></span></a><span class="mpre"> of
      </span><span class="hl_conref"><span class="mpre">Stream.Ok</span></span><span class="mpre"> -&gt; do
        </span><a name="loc_288_9_288_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_288_9_288_25&#39;)"><span class="hl_vardecl"><span class="mpre">outputBufferFull</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.outputBufferFull</span></span><span class="mpre">
        if </span><a href="#loc_288_9_288_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_288_9_288_25&#39;)"><span class="hl_varref"><span class="mpre">outputBufferFull</span></span></a><span class="mpre">
          then do (</span><a name="loc_290_20_290_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_20_290_27&#39;)"><span class="hl_vardecl"><span class="mpre">outFPtr</span></span></a><span class="mpre">, </span><a name="loc_290_29_290_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_29_290_35&#39;)"><span class="hl_vardecl"><span class="mpre">offset</span></span></a><span class="mpre">, </span><a name="loc_290_37_290_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_37_290_43&#39;)"><span class="hl_vardecl"><span class="mpre">length</span></span></a><span class="mpre">) &lt;- </span><span class="hl_varref"><span class="mpre">Stream.popOutputBuffer</span></span><span class="mpre">
                  </span><a name="loc_291_19_291_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_291_19_291_28&#39;)"><span class="hl_vardecl"><span class="mpre">outChunks</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.unsafeInterleave</span></span><span class="mpre">
                    (</span><a href="#loc_243_3_243_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_3_243_14&#39;)"><span class="hl_varref"><span class="mpre">fillBuffers</span></span></a><span class="mpre"> </span><a href="#loc_144_1_144_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_1_144_26&#39;)"><span class="hl_varref"><span class="mpre">defaultCompressBufferSize</span></span></a><span class="mpre"> </span><a href="#loc_274_16_274_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_16_274_24&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre">)
                  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_290_20_290_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_20_290_27&#39;)"><span class="hl_varref"><span class="mpre">outFPtr</span></span></a><span class="mpre"> </span><a href="#loc_290_29_290_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_29_290_35&#39;)"><span class="hl_varref"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a href="#loc_290_37_290_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_37_290_43&#39;)"><span class="hl_varref"><span class="mpre">length</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a href="#loc_291_19_291_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_291_19_291_28&#39;)"><span class="hl_varref"><span class="mpre">outChunks</span></span></a><span class="mpre">)
          else do </span><a href="#loc_243_3_243_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_243_3_243_14&#39;)"><span class="hl_varref"><span class="mpre">fillBuffers</span></span></a><span class="mpre"> </span><a href="#loc_144_1_144_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_144_1_144_26&#39;)"><span class="hl_varref"><span class="mpre">defaultCompressBufferSize</span></span></a><span class="mpre"> </span><a href="#loc_274_16_274_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_16_274_24&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre">

      </span><span class="hl_conref"><span class="mpre">Stream.StreamEnd</span></span><span class="mpre"> -&gt; do
        </span><a name="loc_297_9_297_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_9_297_25&#39;)"><span class="hl_vardecl"><span class="mpre">inputBufferEmpty</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.inputBufferEmpty</span></span><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre"> </span><a href="#loc_297_9_297_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_297_9_297_25&#39;)"><span class="hl_varref"><span class="mpre">inputBufferEmpty</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
        </span><a name="loc_299_9_299_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_9_299_35&#39;)"><span class="hl_vardecl"><span class="mpre">outputBufferBytesAvailable</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.outputBufferBytesAvailable</span></span><span class="mpre">
        if </span><a href="#loc_299_9_299_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_9_299_35&#39;)"><span class="hl_varref"><span class="mpre">outputBufferBytesAvailable</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
          then do (</span><a name="loc_301_20_301_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_20_301_27&#39;)"><span class="hl_vardecl"><span class="mpre">outFPtr</span></span></a><span class="mpre">, </span><a name="loc_301_29_301_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_29_301_35&#39;)"><span class="hl_vardecl"><span class="mpre">offset</span></span></a><span class="mpre">, </span><a name="loc_301_37_301_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_37_301_43&#39;)"><span class="hl_vardecl"><span class="mpre">length</span></span></a><span class="mpre">) &lt;- </span><span class="hl_varref"><span class="mpre">Stream.popOutputBuffer</span></span><span class="mpre">
                  </span><span class="hl_varref"><span class="mpre">Stream.finalise</span></span><span class="mpre">
                  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> [</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_301_20_301_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_20_301_27&#39;)"><span class="hl_varref"><span class="mpre">outFPtr</span></span></a><span class="mpre"> </span><a href="#loc_301_29_301_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_29_301_35&#39;)"><span class="hl_varref"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a href="#loc_301_37_301_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_37_301_43&#39;)"><span class="hl_varref"><span class="mpre">length</span></span></a><span class="mpre">]
          else do </span><span class="hl_varref"><span class="mpre">Stream.finalise</span></span><span class="mpre">
                  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> []

      </span><span class="hl_conref"><span class="mpre">Stream.Error</span></span><span class="mpre"> </span><a name="loc_307_20_307_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_20_307_24&#39;)"><span class="hl_vardecl"><span class="mpre">code</span></span></a><span class="mpre"> </span><a name="loc_307_25_307_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_25_307_28&#39;)"><span class="hl_vardecl"><span class="mpre">msg</span></span></a><span class="mpre"> -&gt; case </span><a href="#loc_307_20_307_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_20_307_24&#39;)"><span class="hl_varref"><span class="mpre">code</span></span></a><span class="mpre"> of
        </span><span class="hl_conref"><span class="mpre">Stream.BufferError</span></span><span class="mpre">  -&gt; </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;BufferError should be impossible!&quot;</span></span><span class="mpre">
        </span><span class="hl_conref"><span class="mpre">Stream.NeedDict</span></span><span class="mpre"> _   -&gt; </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;NeedDict is impossible!&quot;</span></span><span class="mpre">
        _                   -&gt; </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><a href="#loc_307_25_307_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_25_307_28&#39;)"><span class="hl_varref"><span class="mpre">msg</span></span></a><span class="mpre">

  </span><span class="hl_comment"><span class="mpre">-- Set the custom dictionary, if we were provided with one</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- and if the format supports it (zlib and raw, not gzip).</span></span><span class="mpre">
  </span><a href="#loc_315_3_315_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_315_3_315_16&#39;)"><span class="mpre">setDictionary</span></a><span class="mpre"> :: </span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="hl_tyconref"><span class="mpre">Maybe</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Stream</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
  </span><a name="loc_315_3_315_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_315_3_315_16&#39;)"><span class="hl_fundecl"><span class="mpre">setDictionary</span></span></a><span class="mpre"> (</span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> </span><a name="loc_315_23_315_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_315_23_315_27&#39;)"><span class="hl_vardecl"><span class="mpre">dict</span></span></a><span class="mpre">)
    | </span><span class="hl_varref"><span class="mpre">Stream.formatSupportsDictionary</span></span><span class="mpre"> </span><a href="#loc_220_10_220_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_220_10_220_16&#39;)"><span class="hl_varref"><span class="mpre">format</span></span></a><span class="mpre"> = do
        </span><a name="loc_317_9_317_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_9_317_15&#39;)"><span class="hl_vardecl"><span class="mpre">status</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.deflateSetDictionary</span></span><span class="mpre"> </span><a href="#loc_315_23_315_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_315_23_315_27&#39;)"><span class="hl_varref"><span class="mpre">dict</span></span></a><span class="mpre">
        case </span><a href="#loc_317_9_317_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_9_317_15&#39;)"><span class="hl_varref"><span class="mpre">status</span></span></a><span class="mpre"> of
          </span><span class="hl_conref"><span class="mpre">Stream.Ok</span></span><span class="mpre">          -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
          </span><span class="hl_conref"><span class="mpre">Stream.Error</span></span><span class="mpre"> _ </span><a name="loc_320_26_320_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_26_320_29&#39;)"><span class="hl_vardecl"><span class="mpre">msg</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><a href="#loc_320_26_320_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_26_320_29&#39;)"><span class="hl_varref"><span class="mpre">msg</span></span></a><span class="mpre">
          _                  -&gt; </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;error when setting deflate dictionary&quot;</span></span><span class="mpre">
  </span><a href="#loc_315_3_315_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_315_3_315_16&#39;)"><span class="hl_fundecl"><span class="mpre">setDictionary</span></span></a><span class="mpre"> _ = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | Decompress a data stream.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- It will throw an exception if any error is encountered in the input data. If</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- you need more control over error handling then use &#39;decompressWithErrors&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_335_1_335_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_335_1_335_11&#39;)"><span class="mpre">decompress</span></a><span class="mpre">
  :: </span><span class="hl_tyconref"><span class="mpre">Stream.Format</span></span><span class="mpre">
  -&gt; </span><a href="#loc_110_6_110_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_6_110_22&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressParams</span></span></a><span class="mpre">
  -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
  -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
</span><a name="loc_335_1_335_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_335_1_335_11&#39;)"><span class="hl_fundecl"><span class="mpre">decompress</span></span></a><span class="mpre"> </span><a name="loc_335_12_335_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_335_12_335_18&#39;)"><span class="hl_vardecl"><span class="mpre">format</span></span></a><span class="mpre"> </span><a name="loc_335_19_335_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_335_19_335_25&#39;)"><span class="hl_vardecl"><span class="mpre">params</span></span></a><span class="mpre"> = </span><a href="#loc_201_1_201_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_1_201_21&#39;)"><span class="hl_varref"><span class="mpre">fromDecompressStream</span></span></a><span class="mpre">
                         </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_352_1_352_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_1_352_21&#39;)"><span class="hl_varref"><span class="mpre">decompressWithErrors</span></span></a><span class="mpre"> </span><a href="#loc_335_12_335_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_335_12_335_18&#39;)"><span class="hl_varref"><span class="mpre">format</span></span></a><span class="mpre"> </span><a href="#loc_335_19_335_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_335_19_335_25&#39;)"><span class="hl_varref"><span class="mpre">params</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Like &#39;decompress&#39; but returns a &#39;DecompressStream&#39; data structure that</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- contains an explicit representation of the error conditions that one may</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- encounter when decompressing.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that in addition to errors in the input data, it is possible for other</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- unexpected errors to occur, such as out of memory, or finding the wrong</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- version of the zlib C library, these are still thrown as exceptions (because</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- representing them as data would make this function impure).</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_352_1_352_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_1_352_21&#39;)"><span class="mpre">decompressWithErrors</span></a><span class="mpre">
  :: </span><span class="hl_tyconref"><span class="mpre">Stream.Format</span></span><span class="mpre">
  -&gt; </span><a href="#loc_110_6_110_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_6_110_22&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressParams</span></span></a><span class="mpre">
  -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
  -&gt; </span><a href="#loc_153_6_153_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_6_153_22&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressStream</span></span></a><span class="mpre">
</span><a name="loc_352_1_352_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_1_352_21&#39;)"><span class="hl_fundecl"><span class="mpre">decompressWithErrors</span></span></a><span class="mpre"> </span><a name="loc_352_22_352_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_22_352_28&#39;)"><span class="hl_vardecl"><span class="mpre">format</span></span></a><span class="mpre"> (</span><a href="#loc_110_25_110_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_25_110_41&#39;)"><span class="hl_conref"><span class="mpre">DecompressParams</span></span></a><span class="mpre"> </span><a name="loc_352_47_352_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_47_352_51&#39;)"><span class="hl_vardecl"><span class="mpre">bits</span></span></a><span class="mpre"> </span><a name="loc_352_52_352_65" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_52_352_65&#39;)"><span class="hl_vardecl"><span class="mpre">initChunkSize</span></span></a><span class="mpre"> </span><a name="loc_352_66_352_71" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_66_352_71&#39;)"><span class="hl_vardecl"><span class="mpre">mdict</span></span></a><span class="mpre">) </span><a name="loc_352_73_352_78" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_73_352_78&#39;)"><span class="hl_vardecl"><span class="mpre">input</span></span></a><span class="mpre"> =
  </span><span class="hl_varref"><span class="mpre">Stream.run</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
    </span><span class="hl_varref"><span class="mpre">Stream.inflateInit</span></span><span class="mpre"> </span><a href="#loc_352_22_352_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_22_352_28&#39;)"><span class="hl_varref"><span class="mpre">format</span></span></a><span class="mpre"> </span><a href="#loc_352_47_352_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_47_352_51&#39;)"><span class="hl_varref"><span class="mpre">bits</span></span></a><span class="mpre">
    case </span><span class="hl_varref"><span class="mpre">L.toChunks</span></span><span class="mpre"> </span><a href="#loc_352_73_352_78" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_73_352_78&#39;)"><span class="hl_varref"><span class="mpre">input</span></span></a><span class="mpre"> of
      [] -&gt; </span><a href="#loc_371_3_371_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_3_371_14&#39;)"><span class="hl_varref"><span class="mpre">fillBuffers</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">4</span></span><span class="mpre"> [] </span><span class="hl_comment"><span class="mpre">--always an error anyway</span></span><span class="mpre">
      </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a name="loc_357_12_357_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_357_12_357_18&#39;)"><span class="hl_vardecl"><span class="mpre">inFPtr</span></span></a><span class="mpre"> </span><a name="loc_357_19_357_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_357_19_357_25&#39;)"><span class="hl_vardecl"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a name="loc_357_26_357_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_357_26_357_32&#39;)"><span class="hl_vardecl"><span class="mpre">length</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a name="loc_357_35_357_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_357_35_357_41&#39;)"><span class="hl_vardecl"><span class="mpre">chunks</span></span></a><span class="mpre"> -&gt; do
        </span><span class="hl_varref"><span class="mpre">Stream.pushInputBuffer</span></span><span class="mpre"> </span><a href="#loc_357_12_357_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_357_12_357_18&#39;)"><span class="hl_varref"><span class="mpre">inFPtr</span></span></a><span class="mpre"> </span><a href="#loc_357_19_357_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_357_19_357_25&#39;)"><span class="hl_varref"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a href="#loc_357_26_357_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_357_26_357_32&#39;)"><span class="hl_varref"><span class="mpre">length</span></span></a><span class="mpre">
        </span><a href="#loc_371_3_371_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_3_371_14&#39;)"><span class="hl_varref"><span class="mpre">fillBuffers</span></span></a><span class="mpre"> </span><a href="#loc_352_52_352_65" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_52_352_65&#39;)"><span class="hl_varref"><span class="mpre">initChunkSize</span></span></a><span class="mpre"> </span><a href="#loc_357_35_357_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_357_35_357_41&#39;)"><span class="hl_varref"><span class="mpre">chunks</span></span></a><span class="mpre">

  where
    </span><span class="hl_comment"><span class="mpre">-- we flick between two states:</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--   * where one or other buffer is empty</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--       - in which case we refill one or both</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--   * where both buffers are non-empty</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--       - in which case we compress until a buffer is empty</span></span><span class="mpre">

  </span><a href="#loc_371_3_371_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_3_371_14&#39;)"><span class="mpre">fillBuffers</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
              -&gt; [</span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">]
              -&gt; </span><span class="hl_tyconref"><span class="mpre">Stream</span></span><span class="mpre"> </span><a href="#loc_153_6_153_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_6_153_22&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressStream</span></span></a><span class="mpre">
  </span><a name="loc_371_3_371_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_3_371_14&#39;)"><span class="hl_fundecl"><span class="mpre">fillBuffers</span></span></a><span class="mpre"> </span><a name="loc_371_15_371_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_15_371_27&#39;)"><span class="hl_vardecl"><span class="mpre">outChunkSize</span></span></a><span class="mpre"> </span><a name="loc_371_28_371_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_28_371_36&#39;)"><span class="hl_vardecl"><span class="mpre">inChunks</span></span></a><span class="mpre"> = do
#ifdef DEBUG
    </span><span class="hl_varref"><span class="mpre">Stream.consistencyCheck</span></span><span class="mpre">
#endif

    </span><span class="hl_comment"><span class="mpre">-- in this state there are two possabilities:</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--   * no outbut buffer space is available</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--       - in which case we must make more available</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--   * no input buffer is available</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">--       - in which case we must supply more</span></span><span class="mpre">
    </span><a name="loc_381_5_381_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_381_5_381_21&#39;)"><span class="hl_vardecl"><span class="mpre">inputBufferEmpty</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.inputBufferEmpty</span></span><span class="mpre">
    </span><a name="loc_382_5_382_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_382_5_382_21&#39;)"><span class="hl_vardecl"><span class="mpre">outputBufferFull</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.outputBufferFull</span></span><span class="mpre">

    </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre"> (</span><a href="#loc_381_5_381_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_381_5_381_21&#39;)"><span class="hl_varref"><span class="mpre">inputBufferEmpty</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">||</span></span><span class="mpre"> </span><a href="#loc_382_5_382_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_382_5_382_21&#39;)"><span class="hl_varref"><span class="mpre">outputBufferFull</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">

    </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> </span><a href="#loc_382_5_382_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_382_5_382_21&#39;)"><span class="hl_varref"><span class="mpre">outputBufferFull</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
      </span><a name="loc_387_7_387_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_387_7_387_14&#39;)"><span class="hl_vardecl"><span class="mpre">outFPtr</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.unsafeLiftIO</span></span><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_489_1_489_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_489_1_489_17&#39;)"><span class="hl_varref"><span class="mpre">S.mallocByteString</span></span></a><span class="mpre"> </span><a href="#loc_371_15_371_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_15_371_27&#39;)"><span class="hl_varref"><span class="mpre">outChunkSize</span></span></a><span class="mpre">)
      </span><span class="hl_varref"><span class="mpre">Stream.pushOutputBuffer</span></span><span class="mpre"> </span><a href="#loc_387_7_387_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_387_7_387_14&#39;)"><span class="hl_varref"><span class="mpre">outFPtr</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><a href="#loc_371_15_371_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_15_371_27&#39;)"><span class="hl_varref"><span class="mpre">outChunkSize</span></span></a><span class="mpre">

    if </span><a href="#loc_381_5_381_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_381_5_381_21&#39;)"><span class="hl_varref"><span class="mpre">inputBufferEmpty</span></span></a><span class="mpre">
      then case </span><a href="#loc_371_28_371_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_28_371_36&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre"> of
             [] -&gt; </span><a href="#loc_402_3_402_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_3_402_15&#39;)"><span class="hl_varref"><span class="mpre">drainBuffers</span></span></a><span class="mpre"> []
             </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a name="loc_393_19_393_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_393_19_393_25&#39;)"><span class="hl_vardecl"><span class="mpre">inFPtr</span></span></a><span class="mpre"> </span><a name="loc_393_26_393_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_393_26_393_32&#39;)"><span class="hl_vardecl"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a name="loc_393_33_393_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_393_33_393_39&#39;)"><span class="hl_vardecl"><span class="mpre">length</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a name="loc_393_42_393_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_393_42_393_51&#39;)"><span class="hl_vardecl"><span class="mpre">inChunks&#39;</span></span></a><span class="mpre"> -&gt; do
                </span><span class="hl_varref"><span class="mpre">Stream.pushInputBuffer</span></span><span class="mpre"> </span><a href="#loc_393_19_393_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_393_19_393_25&#39;)"><span class="hl_varref"><span class="mpre">inFPtr</span></span></a><span class="mpre"> </span><a href="#loc_393_26_393_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_393_26_393_32&#39;)"><span class="hl_varref"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a href="#loc_393_33_393_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_393_33_393_39&#39;)"><span class="hl_varref"><span class="mpre">length</span></span></a><span class="mpre">
                </span><a href="#loc_402_3_402_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_3_402_15&#39;)"><span class="hl_varref"><span class="mpre">drainBuffers</span></span></a><span class="mpre"> </span><a href="#loc_393_42_393_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_393_42_393_51&#39;)"><span class="hl_varref"><span class="mpre">inChunks&#39;</span></span></a><span class="mpre">
      else </span><a href="#loc_402_3_402_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_3_402_15&#39;)"><span class="hl_varref"><span class="mpre">drainBuffers</span></span></a><span class="mpre"> </span><a href="#loc_371_28_371_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_28_371_36&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre">


  </span><a href="#loc_402_3_402_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_3_402_15&#39;)"><span class="mpre">drainBuffers</span></a><span class="mpre"> ::
      [</span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">]
   -&gt; </span><span class="hl_tyconref"><span class="mpre">Stream</span></span><span class="mpre"> </span><a href="#loc_153_6_153_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_6_153_22&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressStream</span></span></a><span class="mpre">
  </span><a name="loc_402_3_402_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_3_402_15&#39;)"><span class="hl_fundecl"><span class="mpre">drainBuffers</span></span></a><span class="mpre"> </span><a name="loc_402_16_402_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_16_402_24&#39;)"><span class="hl_vardecl"><span class="mpre">inChunks</span></span></a><span class="mpre"> = do

    </span><a name="loc_404_5_404_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_404_5_404_22&#39;)"><span class="hl_vardecl"><span class="mpre">inputBufferEmpty&#39;</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.inputBufferEmpty</span></span><span class="mpre">
    </span><a name="loc_405_5_405_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_405_5_405_22&#39;)"><span class="hl_vardecl"><span class="mpre">outputBufferFull&#39;</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.outputBufferFull</span></span><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre">(</span><span class="hl_varref"><span class="mpre">not</span></span><span class="mpre"> </span><a href="#loc_405_5_405_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_405_5_405_22&#39;)"><span class="hl_varref"><span class="mpre">outputBufferFull&#39;</span></span></a><span class="mpre">
       </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">null</span></span><span class="mpre"> </span><a href="#loc_402_16_402_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_16_402_24&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">||</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">not</span></span><span class="mpre"> </span><a href="#loc_404_5_404_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_404_5_404_22&#39;)"><span class="hl_varref"><span class="mpre">inputBufferEmpty&#39;</span></span></a><span class="mpre">)) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- this invariant guarantees we can always make forward progress or at</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- least if a BufferError does occur that it must be due to a premature EOF</span></span><span class="mpre">

    </span><a name="loc_411_5_411_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_411_5_411_11&#39;)"><span class="hl_vardecl"><span class="mpre">status</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.inflate</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Stream.NoFlush</span></span><span class="mpre">

    case </span><a href="#loc_411_5_411_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_411_5_411_11&#39;)"><span class="hl_varref"><span class="mpre">status</span></span></a><span class="mpre"> of
      </span><span class="hl_conref"><span class="mpre">Stream.Ok</span></span><span class="mpre"> -&gt; do
        </span><a name="loc_415_9_415_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_415_9_415_25&#39;)"><span class="hl_vardecl"><span class="mpre">outputBufferFull</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.outputBufferFull</span></span><span class="mpre">
        if </span><a href="#loc_415_9_415_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_415_9_415_25&#39;)"><span class="hl_varref"><span class="mpre">outputBufferFull</span></span></a><span class="mpre">
          then do (</span><a name="loc_417_20_417_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_417_20_417_27&#39;)"><span class="hl_vardecl"><span class="mpre">outFPtr</span></span></a><span class="mpre">, </span><a name="loc_417_29_417_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_417_29_417_35&#39;)"><span class="hl_vardecl"><span class="mpre">offset</span></span></a><span class="mpre">, </span><a name="loc_417_37_417_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_417_37_417_43&#39;)"><span class="hl_vardecl"><span class="mpre">length</span></span></a><span class="mpre">) &lt;- </span><span class="hl_varref"><span class="mpre">Stream.popOutputBuffer</span></span><span class="mpre">
                  </span><a name="loc_418_19_418_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_418_19_418_28&#39;)"><span class="hl_vardecl"><span class="mpre">outChunks</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.unsafeInterleave</span></span><span class="mpre">
                    (</span><a href="#loc_371_3_371_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_3_371_14&#39;)"><span class="hl_varref"><span class="mpre">fillBuffers</span></span></a><span class="mpre"> </span><a href="#loc_145_1_145_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_1_145_28&#39;)"><span class="hl_varref"><span class="mpre">defaultDecompressBufferSize</span></span></a><span class="mpre"> </span><a href="#loc_402_16_402_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_16_402_24&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre">)
                  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_154_25_154_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_25_154_36&#39;)"><span class="hl_conref"><span class="mpre">StreamChunk</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_417_20_417_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_417_20_417_27&#39;)"><span class="hl_varref"><span class="mpre">outFPtr</span></span></a><span class="mpre"> </span><a href="#loc_417_29_417_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_417_29_417_35&#39;)"><span class="hl_varref"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a href="#loc_417_37_417_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_417_37_417_43&#39;)"><span class="hl_varref"><span class="mpre">length</span></span></a><span class="mpre">) </span><a href="#loc_418_19_418_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_418_19_418_28&#39;)"><span class="hl_varref"><span class="mpre">outChunks</span></span></a><span class="mpre">
          else do </span><a href="#loc_371_3_371_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_371_3_371_14&#39;)"><span class="hl_varref"><span class="mpre">fillBuffers</span></span></a><span class="mpre"> </span><a href="#loc_145_1_145_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_1_145_28&#39;)"><span class="hl_varref"><span class="mpre">defaultDecompressBufferSize</span></span></a><span class="mpre"> </span><a href="#loc_402_16_402_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_16_402_24&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre">

      </span><span class="hl_conref"><span class="mpre">Stream.StreamEnd</span></span><span class="mpre">      -&gt; </span><a href="#loc_402_16_402_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_16_402_24&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre"> </span><a href="Prelude.html#loc_167_1_167_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Prelude.html#loc_167_1_167_4&#39;)"><span class="hl_infix"><span class="mpre">`seq`</span></span></a><span class="mpre"> </span><a href="#loc_445_3_445_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_445_3_445_9&#39;)"><span class="hl_varref"><span class="mpre">finish</span></span></a><span class="mpre"> </span><a href="#loc_153_25_153_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_25_153_34&#39;)"><span class="hl_conref"><span class="mpre">StreamEnd</span></span></a><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- The decompressor tells us we&#39;re done, but that doesn&#39;t mean we have</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- consumed all the input (there could be trailing data). But more</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- subtle than that, the decompressor will actually never demand the</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- tail of the input (in the usual case where it&#39;s empty) because</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- the zlib and gzip formats know their own length. So we force the</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- tail of the input here because this can be important for closing</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- file handles etc.</span></span><span class="mpre">

      </span><span class="hl_conref"><span class="mpre">Stream.Error</span></span><span class="mpre"> </span><a name="loc_432_20_432_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_20_432_24&#39;)"><span class="hl_vardecl"><span class="mpre">code</span></span></a><span class="mpre"> </span><a name="loc_432_25_432_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_25_432_28&#39;)"><span class="hl_vardecl"><span class="mpre">msg</span></span></a><span class="mpre"> -&gt; case </span><a href="#loc_432_20_432_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_20_432_24&#39;)"><span class="hl_varref"><span class="mpre">code</span></span></a><span class="mpre"> of
        </span><span class="hl_conref"><span class="mpre">Stream.BufferError</span></span><span class="mpre">  -&gt; </span><a href="#loc_445_3_445_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_445_3_445_9&#39;)"><span class="hl_varref"><span class="mpre">finish</span></span></a><span class="mpre"> (</span><a href="#loc_157_25_157_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_25_157_36&#39;)"><span class="hl_conref"><span class="mpre">StreamError</span></span></a><span class="mpre"> </span><a href="#loc_164_6_164_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_6_164_20&#39;)"><span class="hl_conref"><span class="mpre">TruncatedInput</span></span></a><span class="mpre"> </span><a href="#loc_434_17_434_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_434_17_434_21&#39;)"><span class="hl_varref"><span class="mpre">msg&#39;</span></span></a><span class="mpre">)
          where </span><a name="loc_434_17_434_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_434_17_434_21&#39;)"><span class="hl_vardecl"><span class="mpre">msg&#39;</span></span></a><span class="mpre"> = </span><span class="hl_string"><span class="mpre">&quot;premature end of compressed stream&quot;</span></span><span class="mpre">
        </span><span class="hl_conref"><span class="mpre">Stream.NeedDict</span></span><span class="mpre"> </span><a name="loc_435_25_435_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_435_25_435_30&#39;)"><span class="hl_vardecl"><span class="mpre">adler</span></span></a><span class="mpre"> -&gt; do
          </span><a name="loc_436_11_436_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_436_11_436_14&#39;)"><span class="hl_vardecl"><span class="mpre">err</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_459_3_459_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_459_3_459_16&#39;)"><span class="hl_varref"><span class="mpre">setDictionary</span></span></a><span class="mpre"> </span><a href="#loc_435_25_435_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_435_25_435_30&#39;)"><span class="hl_varref"><span class="mpre">adler</span></span></a><span class="mpre"> </span><a href="#loc_352_66_352_71" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_66_352_71&#39;)"><span class="hl_varref"><span class="mpre">mdict</span></span></a><span class="mpre">
          case </span><a href="#loc_436_11_436_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_436_11_436_14&#39;)"><span class="hl_varref"><span class="mpre">err</span></span></a><span class="mpre"> of
            </span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> </span><a name="loc_438_18_438_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_438_18_438_27&#39;)"><span class="hl_vardecl"><span class="mpre">streamErr</span></span></a><span class="mpre">  -&gt; </span><a href="#loc_445_3_445_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_445_3_445_9&#39;)"><span class="hl_varref"><span class="mpre">finish</span></span></a><span class="mpre"> </span><a href="#loc_438_18_438_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_438_18_438_27&#39;)"><span class="hl_varref"><span class="mpre">streamErr</span></span></a><span class="mpre">
            </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre">         -&gt; </span><a href="#loc_402_3_402_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_3_402_15&#39;)"><span class="hl_varref"><span class="mpre">drainBuffers</span></span></a><span class="mpre"> </span><a href="#loc_402_16_402_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_402_16_402_24&#39;)"><span class="hl_varref"><span class="mpre">inChunks</span></span></a><span class="mpre">
        </span><span class="hl_conref"><span class="mpre">Stream.DataError</span></span><span class="mpre">    -&gt; </span><a href="#loc_445_3_445_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_445_3_445_9&#39;)"><span class="hl_varref"><span class="mpre">finish</span></span></a><span class="mpre"> (</span><a href="#loc_157_25_157_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_25_157_36&#39;)"><span class="hl_conref"><span class="mpre">StreamError</span></span></a><span class="mpre"> </span><a href="#loc_178_6_178_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_6_178_15&#39;)"><span class="hl_conref"><span class="mpre">DataError</span></span></a><span class="mpre"> </span><a href="#loc_432_25_432_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_25_432_28&#39;)"><span class="hl_varref"><span class="mpre">msg</span></span></a><span class="mpre">)
        _                   -&gt; </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><a href="#loc_432_25_432_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_432_25_432_28&#39;)"><span class="hl_varref"><span class="mpre">msg</span></span></a><span class="mpre">

  </span><span class="hl_comment"><span class="mpre">-- Note even if we end with an error we still try to flush the last chunk if</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- there is one. The user just has to decide what they want to trust.</span></span><span class="mpre">
  </span><a name="loc_445_3_445_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_445_3_445_9&#39;)"><span class="hl_fundecl"><span class="mpre">finish</span></span></a><span class="mpre"> </span><a name="loc_445_10_445_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_445_10_445_13&#39;)"><span class="hl_vardecl"><span class="mpre">end</span></span></a><span class="mpre"> = do
    </span><span class="hl_comment"><span class="mpre">-- Note that there may be input bytes still available if the stream</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- is embeded in some other data stream. Here we just silently discard</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- any trailing data.</span></span><span class="mpre">
    </span><a name="loc_449_5_449_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_449_5_449_31&#39;)"><span class="hl_vardecl"><span class="mpre">outputBufferBytesAvailable</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.outputBufferBytesAvailable</span></span><span class="mpre">
    if </span><a href="#loc_449_5_449_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_449_5_449_31&#39;)"><span class="hl_varref"><span class="mpre">outputBufferBytesAvailable</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
      then do (</span><a name="loc_451_16_451_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_451_16_451_23&#39;)"><span class="hl_vardecl"><span class="mpre">outFPtr</span></span></a><span class="mpre">, </span><a name="loc_451_25_451_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_451_25_451_31&#39;)"><span class="hl_vardecl"><span class="mpre">offset</span></span></a><span class="mpre">, </span><a name="loc_451_33_451_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_451_33_451_39&#39;)"><span class="hl_vardecl"><span class="mpre">length</span></span></a><span class="mpre">) &lt;- </span><span class="hl_varref"><span class="mpre">Stream.popOutputBuffer</span></span><span class="mpre">
              </span><span class="hl_varref"><span class="mpre">Stream.finalise</span></span><span class="mpre">
              </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_154_25_154_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_25_154_36&#39;)"><span class="hl_conref"><span class="mpre">StreamChunk</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_451_16_451_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_451_16_451_23&#39;)"><span class="hl_varref"><span class="mpre">outFPtr</span></span></a><span class="mpre"> </span><a href="#loc_451_25_451_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_451_25_451_31&#39;)"><span class="hl_varref"><span class="mpre">offset</span></span></a><span class="mpre"> </span><a href="#loc_451_33_451_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_451_33_451_39&#39;)"><span class="hl_varref"><span class="mpre">length</span></span></a><span class="mpre">) </span><a href="#loc_445_10_445_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_445_10_445_13&#39;)"><span class="hl_varref"><span class="mpre">end</span></span></a><span class="mpre">)
      else do </span><span class="hl_varref"><span class="mpre">Stream.finalise</span></span><span class="mpre">
              </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_445_10_445_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_445_10_445_13&#39;)"><span class="hl_varref"><span class="mpre">end</span></span></a><span class="mpre">

  </span><a href="#loc_459_3_459_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_459_3_459_16&#39;)"><span class="mpre">setDictionary</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Stream.DictionaryHash</span></span><span class="mpre"> -&gt; </span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="hl_tyconref"><span class="mpre">Maybe</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
                -&gt; </span><span class="hl_tyconref"><span class="mpre">Stream</span></span><span class="mpre"> (</span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="hl_tyconref"><span class="mpre">Maybe</span></span></a><span class="mpre"> </span><a href="#loc_153_6_153_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_6_153_22&#39;)"><span class="hl_tyconref"><span class="mpre">DecompressStream</span></span></a><span class="mpre">)
  </span><a name="loc_459_3_459_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_459_3_459_16&#39;)"><span class="hl_fundecl"><span class="mpre">setDictionary</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_adler</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre"> =
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> (</span><a href="#loc_157_25_157_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_25_157_36&#39;)"><span class="hl_conref"><span class="mpre">StreamError</span></span></a><span class="mpre"> </span><a href="#loc_171_6_171_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_171_6_171_24&#39;)"><span class="hl_conref"><span class="mpre">DictionaryRequired</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;custom dictionary needed&quot;</span></span><span class="mpre">)
  </span><a href="#loc_459_3_459_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_459_3_459_16&#39;)"><span class="hl_fundecl"><span class="mpre">setDictionary</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_adler</span></span><span class="mpre"> (</span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> </span><a name="loc_461_30_461_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_461_30_461_34&#39;)"><span class="hl_vardecl"><span class="mpre">dict</span></span></a><span class="mpre">) = do
    </span><a name="loc_462_5_462_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_462_5_462_11&#39;)"><span class="hl_vardecl"><span class="mpre">status</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">Stream.inflateSetDictionary</span></span><span class="mpre"> </span><a href="#loc_461_30_461_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_461_30_461_34&#39;)"><span class="hl_varref"><span class="mpre">dict</span></span></a><span class="mpre">
    case </span><a href="#loc_462_5_462_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_462_5_462_11&#39;)"><span class="hl_varref"><span class="mpre">status</span></span></a><span class="mpre"> of
      </span><span class="hl_conref"><span class="mpre">Stream.Ok</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre">
      </span><span class="hl_conref"><span class="mpre">Stream.Error</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Stream.StreamError</span></span><span class="mpre"> _ -&gt;
        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> (</span><a href="#loc_157_25_157_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_25_157_36&#39;)"><span class="hl_conref"><span class="mpre">StreamError</span></span></a><span class="mpre"> </span><a href="#loc_171_6_171_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_171_6_171_24&#39;)"><span class="hl_conref"><span class="mpre">DictionaryRequired</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;provided dictionary not valid&quot;</span></span><span class="mpre">)
      </span><span class="hl_conref"><span class="mpre">Stream.Error</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Stream.DataError</span></span><span class="mpre"> _   -&gt;
        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> (</span><a href="#loc_157_25_157_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_25_157_36&#39;)"><span class="hl_conref"><span class="mpre">StreamError</span></span></a><span class="mpre"> </span><a href="#loc_171_6_171_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_171_6_171_24&#39;)"><span class="hl_conref"><span class="mpre">DictionaryRequired</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;given dictionary does not match the expected one&quot;</span></span><span class="mpre">)
      _ -&gt; </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;error when setting inflate dictionary&quot;</span></span><span class="mpre">
</span></div></body></html>