<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE Trustworthy #-}
{-# LANGUAGE CPP #-}
{-# LANGUAGE DeriveDataTypeable, StandaloneDeriving #-}

</span><span class="hl_comment"><span class="mpre">-------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      :  System.Timeout</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   :  (c) The University of Glasgow 2007</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     :  BSD-style (see the file libraries/base/LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  :  libraries@haskell.org</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   :  experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability :  non-portable</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Attach a timeout event to arbitrary &#39;IO&#39; computations.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-------------------------------------------------------------------------------</span></span><span class="mpre">

module System.Timeout ( timeout ) where

#ifndef mingw32_HOST_OS
import Control.Monad
import GHC.Event           (</span><a href="GHC.Event.Thread.html#loc_206_1_206_22" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Thread.html#loc_206_1_206_22&#39;)"><span class="mpre">getSystemTimerManager</span></a><span class="mpre">,
                            </span><a href="GHC.Event.TimerManager.html#loc_241_1_241_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.TimerManager.html#loc_241_1_241_16&#39;)"><span class="mpre">registerTimeout</span></a><span class="mpre">, </span><a href="GHC.Event.TimerManager.html#loc_254_1_254_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.TimerManager.html#loc_254_1_254_18&#39;)"><span class="mpre">unregisterTimeout</span></a><span class="mpre">)
#endif

import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/System/Timeout.hs&quot;, srcSpanStartLine = 27, srcSpanStartColumn = 8, srcSpanEndLine = 27, srcSpanEndColumn = 26}, srcInfoPoints = []}) &quot;Control.Concurrent&quot;"><span class="mpre">Control.Concurrent</span></span><span class="mpre">
import Control.Exception   (Exception(..), </span><a href="Control.Exception.Base.html#loc_186_1_186_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_186_1_186_11&#39;)"><span class="mpre">handleJust</span></a><span class="mpre">, </span><a href="Control.Exception.Base.html#loc_259_1_259_8" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_259_1_259_8&#39;)"><span class="mpre">bracket</span></a><span class="mpre">,
                            </span><a href="GHC.IO.html#loc_434_1_434_21" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_434_1_434_21&#39;)"><span class="mpre">uninterruptibleMask_</span></a><span class="mpre">,
                            </span><a href="GHC.IO.Exception.html#loc_126_1_126_26" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Exception.html#loc_126_1_126_26&#39;)"><span class="mpre">asyncExceptionToException</span></a><span class="mpre">,
                            </span><a href="GHC.IO.Exception.html#loc_130_1_130_28" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Exception.html#loc_130_1_130_28&#39;)"><span class="mpre">asyncExceptionFromException</span></a><span class="mpre">)
import Data.Typeable
import Data.Unique         (</span><a href="Data.Unique.html#loc_36_9_36_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Unique.html#loc_36_9_36_15&#39;)"><span class="mpre">Unique</span></a><span class="mpre">, </span><a href="Data.Unique.html#loc_47_1_47_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Unique.html#loc_47_1_47_10&#39;)"><span class="mpre">newUnique</span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- An internal type that is thrown as a dynamic exception to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- interrupt the running IO computation when the timeout has</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- expired.</span></span><span class="mpre">

newtype </span><a name="loc_39_9_39_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_9_39_16&#39;)"><span class="hl_tycondecl"><span class="mpre">Timeout</span></span></a><span class="mpre"> = </span><a name="loc_39_19_39_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_19_39_26&#39;)"><span class="hl_condecl"><span class="mpre">Timeout</span></span></a><span class="mpre"> </span><a href="Data.Unique.html#loc_36_9_36_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Unique.html#loc_36_9_36_15&#39;)"><span class="hl_tyconref"><span class="mpre">Unique</span></span></a><span class="mpre"> </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/System/Timeout.hs&quot;, srcSpanStartLine = 39, srcSpanStartColumn = 34, srcSpanEndLine = 39, srcSpanEndColumn = 57}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/System/Timeout.hs&quot;, srcSpanStartLine = 39, srcSpanStartColumn = 34, srcSpanEndLine = 39, srcSpanEndColumn = 42},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/System/Timeout.hs&quot;, srcSpanStartLine = 39, srcSpan"><span class="mpre">deriving (Eq, Typeable)</span></span><span class="mpre">

instance </span><span class="hl_classref"><span class="mpre">Show</span></span><span class="mpre"> </span><a href="#loc_39_9_39_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_9_39_16&#39;)"><span class="hl_tyconref"><span class="mpre">Timeout</span></span></a><span class="mpre"> where
    </span><span class="hl_fundecl"><span class="mpre">show</span></span><span class="mpre"> _ = </span><span class="hl_string"><span class="mpre">&quot;&lt;&lt;timeout&gt;&gt;&quot;</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Timeout is a child of SomeAsyncException</span></span><span class="mpre">
instance </span><span class="hl_classref"><span class="mpre">Exception</span></span><span class="mpre"> </span><a href="#loc_39_9_39_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_9_39_16&#39;)"><span class="hl_tyconref"><span class="mpre">Timeout</span></span></a><span class="mpre"> where
  </span><span class="hl_vardecl"><span class="mpre">toException</span></span><span class="mpre"> = </span><a href="GHC.IO.Exception.html#loc_126_1_126_26" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Exception.html#loc_126_1_126_26&#39;)"><span class="hl_varref"><span class="mpre">asyncExceptionToException</span></span></a><span class="mpre">
  </span><span class="hl_vardecl"><span class="mpre">fromException</span></span><span class="mpre"> = </span><a href="GHC.IO.Exception.html#loc_130_1_130_28" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Exception.html#loc_130_1_130_28&#39;)"><span class="hl_varref"><span class="mpre">asyncExceptionFromException</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- |Wrap an &#39;IO&#39; computation to time out and return @Nothing@ in case no result</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- is available within @n@ microseconds (@1\/10^6@ seconds). In case a result</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- is available before the timeout expires, @Just a@ is returned. A negative</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- timeout interval means \&quot;wait indefinitely\&quot;. When specifying long timeouts,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- be careful not to exceed @maxBound :: Int@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The design of this combinator was guided by the objective that @timeout n f@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- should behave exactly the same as @f@ as long as @f@ doesn&#39;t time out. This</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- means that @f@ has the same &#39;myThreadId&#39; it would have without the timeout</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- wrapper. Any exceptions @f@ might throw cancel the timeout and propagate</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- further up. It also possible for @f@ to receive exceptions thrown to it by</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- another thread.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- A tricky implementation detail is the question of how to abort an @IO@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- computation. This combinator relies on asynchronous exceptions internally.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The technique works very well for computations executing inside of the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Haskell runtime system, but it doesn&#39;t work at all for non-Haskell code.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Foreign function calls, for example, cannot be timed out with this</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- combinator simply because an arbitrary C function cannot receive</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- asynchronous exceptions. When @timeout@ is used to wrap an FFI call that</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- blocks, no timeout event can be delivered until the FFI call returns, which</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- pretty much negates the purpose of the combinator. In practice, however,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- this limitation is less severe than it may sound. Standard I\/O functions</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- like &#39;System.IO.hGetBuf&#39;, &#39;System.IO.hPutBuf&#39;, Network.Socket.accept, or</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;System.IO.hWaitForInput&#39; appear to be blocking, but they really don&#39;t</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- because the runtime system uses scheduling mechanisms like @select(2)@ to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- perform asynchronous I\/O, so it is possible to interrupt standard socket</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- I\/O or file I\/O using this combinator.</span></span><span class="mpre">

</span><a href="#loc_79_1_79_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_1_79_8&#39;)"><span class="mpre">timeout</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_79_1_79_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_1_79_8&#39;)"><span class="hl_fundecl"><span class="mpre">timeout</span></span></a><span class="mpre"> </span><a name="loc_79_9_79_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_9_79_10&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> </span><a name="loc_79_11_79_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_11_79_12&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre">
    | </span><a href="#loc_79_9_79_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_9_79_10&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre">  </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">    = </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a href="#loc_79_11_79_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_11_79_12&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre">
    | </span><a href="#loc_79_9_79_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_9_79_10&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">    = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
#ifndef mingw32_HOST_OS
    | </span><span class="hl_varref"><span class="mpre">rtsSupportsBoundThreads</span></span><span class="mpre"> = do
        </span><span class="hl_comment"><span class="mpre">-- In the threaded RTS, we use the Timer Manager to delay the</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- (fairly expensive) &#39;forkIO&#39; call until the timeout has expired.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- An additional thread is required for the actual delivery of</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- the Timeout exception because killThread (or another throwTo)</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- is the only way to reliably interrupt a throwTo in flight.</span></span><span class="mpre">
        </span><a name="loc_90_9_90_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_9_90_12&#39;)"><span class="hl_vardecl"><span class="mpre">pid</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">myThreadId</span></span><span class="mpre">
        </span><a name="loc_91_9_91_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_9_91_11&#39;)"><span class="hl_vardecl"><span class="mpre">ex</span></span></a><span class="mpre">  &lt;- </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> </span><a href="#loc_39_19_39_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_19_39_26&#39;)"><span class="hl_conref"><span class="mpre">Timeout</span></span></a><span class="mpre"> </span><a href="Data.Unique.html#loc_47_1_47_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Unique.html#loc_47_1_47_10&#39;)"><span class="hl_varref"><span class="mpre">newUnique</span></span></a><span class="mpre">
        </span><a name="loc_92_9_92_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_9_92_11&#39;)"><span class="hl_vardecl"><span class="mpre">tm</span></span></a><span class="mpre">  &lt;- </span><a href="GHC.Event.Thread.html#loc_206_1_206_22" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.Thread.html#loc_206_1_206_22&#39;)"><span class="hl_varref"><span class="mpre">getSystemTimerManager</span></span></a><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- &#39;lock&#39; synchronizes the timeout handler and the main thread:</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--  * the main thread can disable the handler by writing to &#39;lock&#39;;</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--  * the handler communicates the spawned thread&#39;s id through &#39;lock&#39;.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- These two cases are mutually exclusive.</span></span><span class="mpre">
        </span><a name="loc_97_9_97_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_9_97_13&#39;)"><span class="hl_vardecl"><span class="mpre">lock</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newEmptyMVar</span></span><span class="mpre">
        let </span><a name="loc_98_13_98_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_13_98_26&#39;)"><span class="hl_vardecl"><span class="mpre">handleTimeout</span></span></a><span class="mpre"> = do
                </span><a name="loc_99_17_99_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_17_99_18&#39;)"><span class="hl_vardecl"><span class="mpre">v</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">isEmptyMVar</span></span><span class="mpre"> </span><a href="#loc_97_9_97_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_9_97_13&#39;)"><span class="hl_varref"><span class="mpre">lock</span></span></a><span class="mpre">
                </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> </span><a href="#loc_99_17_99_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_17_99_18&#39;)"><span class="hl_varref"><span class="mpre">v</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Control.Monad.html#loc_195_1_195_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_195_1_195_5&#39;)"><span class="hl_varref"><span class="mpre">void</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">forkIOWithUnmask</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_100_53_100_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_100_53_100_59&#39;)"><span class="hl_vardecl"><span class="mpre">unmask</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_100_53_100_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_100_53_100_59&#39;)"><span class="hl_varref"><span class="mpre">unmask</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
                    </span><a name="loc_101_21_101_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_21_101_23&#39;)"><span class="hl_vardecl"><span class="mpre">v2</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">tryPutMVar</span></span><span class="mpre"> </span><a href="#loc_97_9_97_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_9_97_13&#39;)"><span class="hl_varref"><span class="mpre">lock</span></span></a><span class="mpre"> </span><a href="Control.Monad.html#loc_92_3_92_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_92_3_92_6&#39;)"><span class="hl_infix"><span class="mpre">=&lt;&lt;</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">myThreadId</span></span><span class="mpre">
                    </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> </span><a href="#loc_101_21_101_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_21_101_23&#39;)"><span class="hl_varref"><span class="mpre">v2</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">throwTo</span></span><span class="mpre"> </span><a href="#loc_90_9_90_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_9_90_12&#39;)"><span class="hl_varref"><span class="mpre">pid</span></span></a><span class="mpre"> </span><a href="#loc_91_9_91_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_9_91_11&#39;)"><span class="hl_varref"><span class="mpre">ex</span></span></a><span class="mpre">
            </span><a name="loc_103_13_103_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_13_103_27&#39;)"><span class="hl_fundecl"><span class="mpre">cleanupTimeout</span></span></a><span class="mpre"> </span><a name="loc_103_28_103_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_28_103_31&#39;)"><span class="hl_vardecl"><span class="mpre">key</span></span></a><span class="mpre"> = </span><a href="GHC.IO.html#loc_434_1_434_21" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_434_1_434_21&#39;)"><span class="hl_varref"><span class="mpre">uninterruptibleMask_</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
                </span><a name="loc_104_17_104_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_17_104_18&#39;)"><span class="hl_vardecl"><span class="mpre">v</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">tryPutMVar</span></span><span class="mpre"> </span><a href="#loc_97_9_97_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_9_97_13&#39;)"><span class="hl_varref"><span class="mpre">lock</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">undefined</span></span><span class="mpre">
                if </span><a href="#loc_104_17_104_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_17_104_18&#39;)"><span class="hl_varref"><span class="mpre">v</span></span></a><span class="mpre"> then </span><a href="GHC.Event.TimerManager.html#loc_254_1_254_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.TimerManager.html#loc_254_1_254_18&#39;)"><span class="hl_varref"><span class="mpre">unregisterTimeout</span></span></a><span class="mpre"> </span><a href="#loc_92_9_92_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_9_92_11&#39;)"><span class="hl_varref"><span class="mpre">tm</span></span></a><span class="mpre"> </span><a href="#loc_103_28_103_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_28_103_31&#39;)"><span class="hl_varref"><span class="mpre">key</span></span></a><span class="mpre">
                     else </span><span class="hl_varref"><span class="mpre">takeMVar</span></span><span class="mpre"> </span><a href="#loc_97_9_97_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_9_97_13&#39;)"><span class="hl_varref"><span class="mpre">lock</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">killThread</span></span><span class="mpre">
        </span><a href="Control.Exception.Base.html#loc_186_1_186_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_186_1_186_11&#39;)"><span class="hl_varref"><span class="mpre">handleJust</span></span></a><span class="mpre"> (\</span><a name="loc_107_22_107_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_107_22_107_23&#39;)"><span class="hl_vardecl"><span class="mpre">e</span></span></a><span class="mpre"> -&gt; if </span><a href="#loc_107_22_107_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_107_22_107_23&#39;)"><span class="hl_varref"><span class="mpre">e</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_91_9_91_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_9_91_11&#39;)"><span class="hl_varref"><span class="mpre">ex</span></span></a><span class="mpre"> then </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre"> else </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">)
                   (\_ -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">)
                   (</span><a href="Control.Exception.Base.html#loc_259_1_259_8" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_259_1_259_8&#39;)"><span class="hl_varref"><span class="mpre">bracket</span></span></a><span class="mpre"> (</span><a href="GHC.Event.TimerManager.html#loc_241_1_241_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Event.TimerManager.html#loc_241_1_241_16&#39;)"><span class="hl_varref"><span class="mpre">registerTimeout</span></span></a><span class="mpre"> </span><a href="#loc_92_9_92_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_9_92_11&#39;)"><span class="hl_varref"><span class="mpre">tm</span></span></a><span class="mpre"> </span><a href="#loc_79_9_79_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_9_79_10&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><a href="#loc_98_13_98_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_13_98_26&#39;)"><span class="hl_varref"><span class="mpre">handleTimeout</span></span></a><span class="mpre">)
                            </span><a href="#loc_103_13_103_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_13_103_27&#39;)"><span class="hl_varref"><span class="mpre">cleanupTimeout</span></span></a><span class="mpre">
                            (\_ -&gt; </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a href="#loc_79_11_79_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_11_79_12&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre">))
#endif
    | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = do
        </span><a name="loc_114_9_114_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_9_114_12&#39;)"><span class="hl_vardecl"><span class="mpre">pid</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">myThreadId</span></span><span class="mpre">
        </span><a name="loc_115_9_115_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_9_115_11&#39;)"><span class="hl_vardecl"><span class="mpre">ex</span></span></a><span class="mpre">  &lt;- </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> </span><a href="#loc_39_19_39_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_19_39_26&#39;)"><span class="hl_conref"><span class="mpre">Timeout</span></span></a><span class="mpre"> </span><a href="Data.Unique.html#loc_47_1_47_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Unique.html#loc_47_1_47_10&#39;)"><span class="hl_varref"><span class="mpre">newUnique</span></span></a><span class="mpre">
        </span><a href="Control.Exception.Base.html#loc_186_1_186_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_186_1_186_11&#39;)"><span class="hl_varref"><span class="mpre">handleJust</span></span></a><span class="mpre"> (\</span><a name="loc_116_22_116_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_116_22_116_23&#39;)"><span class="hl_vardecl"><span class="mpre">e</span></span></a><span class="mpre"> -&gt; if </span><a href="#loc_116_22_116_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_116_22_116_23&#39;)"><span class="hl_varref"><span class="mpre">e</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_115_9_115_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_9_115_11&#39;)"><span class="hl_varref"><span class="mpre">ex</span></span></a><span class="mpre"> then </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre"> else </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">)
                   (\_ -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">)
                   (</span><a href="Control.Exception.Base.html#loc_259_1_259_8" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_259_1_259_8&#39;)"><span class="hl_varref"><span class="mpre">bracket</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">forkIOWithUnmask</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_118_50_118_56" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_50_118_56&#39;)"><span class="hl_vardecl"><span class="mpre">unmask</span></span></a><span class="mpre"> -&gt;
                                 </span><a href="#loc_118_50_118_56" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_50_118_56&#39;)"><span class="hl_varref"><span class="mpre">unmask</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">threadDelay</span></span><span class="mpre"> </span><a href="#loc_79_9_79_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_9_79_10&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">throwTo</span></span><span class="mpre"> </span><a href="#loc_114_9_114_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_9_114_12&#39;)"><span class="hl_varref"><span class="mpre">pid</span></span></a><span class="mpre"> </span><a href="#loc_115_9_115_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_9_115_11&#39;)"><span class="hl_varref"><span class="mpre">ex</span></span></a><span class="mpre">)
                            (</span><a href="GHC.IO.html#loc_434_1_434_21" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_434_1_434_21&#39;)"><span class="hl_varref"><span class="mpre">uninterruptibleMask_</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">killThread</span></span><span class="mpre">)
                            (\_ -&gt; </span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a href="#loc_79_11_79_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_11_79_12&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre">))
        </span><span class="hl_comment"><span class="mpre">-- #7719 explains why we need uninterruptibleMask_ above.</span></span><span class="mpre">
</span></div></body></html>