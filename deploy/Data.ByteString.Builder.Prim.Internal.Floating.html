<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE ScopedTypeVariables #-}
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   : (c) 2010 Simon Meier</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD3-style (see LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Simon Meier &lt;iridcode@gmail.com&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : GHC</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Conversion of &#39;Float&#39;s and &#39;Double&#39;s to &#39;Word32&#39;s and &#39;Word64&#39;s.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Data.ByteString.Builder.Prim.Internal.Floating
    (
      </span><span class="hl_comment"><span class="mpre">-- coerceFloatToWord32</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- , coerceDoubleToWord64</span></span><span class="mpre">
    encodeFloatViaWord32F
  , encodeDoubleViaWord64F
  ) where

import Foreign
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Prim/Internal/Floating.hs&quot;, srcSpanStartLine = 22, srcSpanStartColumn = 8, srcSpanEndLine = 22, srcSpanEndColumn = 45}, srcInfoPoints = []}) &quot;Data.ByteString.Builder.Prim.Internal&quot;"><span class="mpre">Data.ByteString.Builder.Prim.Internal</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">{-
We work around ticket http://hackage.haskell.org/trac/ghc/ticket/4092 using the
FFI to store the Float/Double in the buffer and peek it out again from there.
-}</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | Encode a &#39;Float&#39; using a &#39;Word32&#39; encoding.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- PRE: The &#39;Word32&#39; encoding must have a size of at least 4 bytes.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_35_1_35_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_1_35_22&#39;)"><span class="mpre">encodeFloatViaWord32F</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_35_1_35_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_1_35_22&#39;)"><span class="mpre">encodeFloatViaWord32F</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">FixedPrim</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word32</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">FixedPrim</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Float</span></span><span class="mpre">
</span><a name="loc_35_1_35_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_1_35_22&#39;)"><span class="hl_fundecl"><span class="mpre">encodeFloatViaWord32F</span></span></a><span class="mpre"> </span><a name="loc_35_23_35_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_23_35_28&#39;)"><span class="hl_vardecl"><span class="mpre">w32fe</span></span></a><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">size</span></span><span class="mpre"> </span><a href="#loc_35_23_35_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_23_35_28&#39;)"><span class="hl_varref"><span class="mpre">w32fe</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">sizeOf</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">undefined</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Float</span></span><span class="mpre">) =
      </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;encodeFloatViaWord32F: encoding not wide enough&quot;</span></span><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fixedPrim</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">size</span></span><span class="mpre"> </span><a href="#loc_35_23_35_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_23_35_28&#39;)"><span class="hl_varref"><span class="mpre">w32fe</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_38_43_38_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_43_38_44&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> </span><a name="loc_38_45_38_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_45_38_47&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> -&gt; do
      </span><span class="hl_varref"><span class="mpre">poke</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_38_45_38_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_45_38_47&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre">) </span><a href="#loc_38_43_38_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_43_38_44&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
      </span><a name="loc_40_7_40_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_40_7_40_9&#39;)"><span class="hl_vardecl"><span class="mpre">x&#39;</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">peek</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_38_45_38_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_45_38_47&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre">)
      </span><span class="hl_varref"><span class="mpre">runF</span></span><span class="mpre"> </span><a href="#loc_35_23_35_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_23_35_28&#39;)"><span class="hl_varref"><span class="mpre">w32fe</span></span></a><span class="mpre"> </span><a href="#loc_40_7_40_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_40_7_40_9&#39;)"><span class="hl_varref"><span class="mpre">x&#39;</span></span></a><span class="mpre"> </span><a href="#loc_38_45_38_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_45_38_47&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Encode a &#39;Double&#39; using a &#39;Word64&#39; encoding.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- PRE: The &#39;Word64&#39; encoding must have a size of at least 8 bytes.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_48_1_48_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_1_48_23&#39;)"><span class="mpre">encodeDoubleViaWord64F</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_48_1_48_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_1_48_23&#39;)"><span class="mpre">encodeDoubleViaWord64F</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">FixedPrim</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word64</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">FixedPrim</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Double</span></span><span class="mpre">
</span><a name="loc_48_1_48_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_1_48_23&#39;)"><span class="hl_fundecl"><span class="mpre">encodeDoubleViaWord64F</span></span></a><span class="mpre"> </span><a name="loc_48_24_48_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_24_48_29&#39;)"><span class="hl_vardecl"><span class="mpre">w64fe</span></span></a><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">size</span></span><span class="mpre"> </span><a href="#loc_48_24_48_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_24_48_29&#39;)"><span class="hl_varref"><span class="mpre">w64fe</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">sizeOf</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">undefined</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Float</span></span><span class="mpre">) =
      </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;encodeDoubleViaWord64F: encoding not wide enough&quot;</span></span><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fixedPrim</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">size</span></span><span class="mpre"> </span><a href="#loc_48_24_48_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_24_48_29&#39;)"><span class="hl_varref"><span class="mpre">w64fe</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_51_43_51_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_43_51_44&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> </span><a name="loc_51_45_51_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_45_51_47&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> -&gt; do
      </span><span class="hl_varref"><span class="mpre">poke</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_51_45_51_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_45_51_47&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre">) </span><a href="#loc_51_43_51_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_43_51_44&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
      </span><a name="loc_53_7_53_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_7_53_9&#39;)"><span class="hl_vardecl"><span class="mpre">x&#39;</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">peek</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_51_45_51_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_45_51_47&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre">)
      </span><span class="hl_varref"><span class="mpre">runF</span></span><span class="mpre"> </span><a href="#loc_48_24_48_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_24_48_29&#39;)"><span class="hl_varref"><span class="mpre">w64fe</span></span></a><span class="mpre"> </span><a href="#loc_53_7_53_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_7_53_9&#39;)"><span class="hl_varref"><span class="mpre">x&#39;</span></span></a><span class="mpre"> </span><a href="#loc_51_45_51_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_45_51_47&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre">

</span></div></body></html>