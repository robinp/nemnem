<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE BangPatterns, CPP, Rank2Types #-}
{-# OPTIONS_HADDOCK not-home #-}

</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : Data.Text.Internal.Builder</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   : (c) 2013 Bryan O&#39;Sullivan</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--               (c) 2010 Johan Tibell</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD3-style (see LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Johan Tibell &lt;johan.tibell@gmail.com&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : portable to Hugs and GHC</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- /Warning/: this is an internal module, and does not have a stable</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- API or name. Functions in this module may not check or enforce</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- preconditions expected by public modules. Use at your own risk!</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Efficient construction of lazy @Text@ values.  The principal</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- operations on a @Builder@ are @singleton@, @fromText@, and</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @fromLazyText@, which construct new builders, and &#39;mappend&#39;, which</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- concatenates two builders.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- To get maximum performance when building lazy @Text@ values using a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- builder, associate @mappend@ calls to the right.  For example,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- prefer</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; singleton &#39;a&#39; `mappend` (singleton &#39;b&#39; `mappend` singleton &#39;c&#39;)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; singleton &#39;a&#39; `mappend` singleton &#39;b&#39; `mappend` singleton &#39;c&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- as the latter associates @mappend@ to the left.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">

module Data.Text.Internal.Builder
   ( </span><span class="hl_comment"><span class="mpre">-- * Public API</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- ** The Builder type</span></span><span class="mpre">
     Builder
   , toLazyText
   , toLazyTextWith

     </span><span class="hl_comment"><span class="mpre">-- ** Constructing Builders</span></span><span class="mpre">
   , singleton
   , fromText
   , fromLazyText
   , fromString

     </span><span class="hl_comment"><span class="mpre">-- ** Flushing the buffer state</span></span><span class="mpre">
   , flush

     </span><span class="hl_comment"><span class="mpre">-- * Internal functions</span></span><span class="mpre">
   , append&#39;
   , ensureFree
   , writeN
   ) where

import Control.Monad.ST (ST, runST)
import Data.Bits ((.&amp;.))
import Data.Monoid (</span><a href="Data.Monoid.html#loc_79_7_79_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_79_7_79_13&#39;)"><span class="mpre">Monoid</span></a><span class="mpre">(..))
import Data.Text.Internal (</span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="mpre">Text</span></a><span class="mpre">(..))
import Data.Text.Internal.Lazy (</span><a href="Data.Text.Internal.Lazy.html#loc_113_1_113_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Lazy.html#loc_113_1_113_15&#39;)"><span class="mpre">smallChunkSize</span></a><span class="mpre">)
import Data.Text.Unsafe (</span><a href="Data.Text.Internal.Unsafe.html#loc_54_1_54_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Unsafe.html#loc_54_1_54_19&#39;)"><span class="mpre">inlineInterleaveST</span></a><span class="mpre">)
import Data.Text.Internal.Unsafe.Char (</span><a href="Data.Text.Internal.Unsafe.Char.html#loc_40_1_40_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Unsafe.Char.html#loc_40_1_40_4&#39;)"><span class="mpre">ord</span></a><span class="mpre">, </span><a href="Data.Text.Internal.Unsafe.Char.html#loc_58_1_58_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Unsafe.Char.html#loc_58_1_58_12&#39;)"><span class="mpre">unsafeWrite</span></a><span class="mpre">)
import Data.Text.Internal.Unsafe.Shift (</span><a href="Data.Text.Internal.Unsafe.Shift.html#loc_35_5_35_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Unsafe.Shift.html#loc_35_5_35_11&#39;)"><span class="mpre">shiftR</span></a><span class="mpre">)
import Prelude hiding (map, </span><a href="System.IO.html#loc_256_1_256_8" onmouseover="nemnem.highlightLocalToRemote(&#39;System.IO.html#loc_256_1_256_8&#39;)"><span class="mpre">putChar</span></a><span class="mpre">)

import qualified Data.String as String
import qualified Data.Text as S
import qualified Data.Text.Array as A
import qualified Data.Text.Lazy as L

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A @Builder@ is an efficient way to build lazy @Text@ values.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- There are several functions for constructing builders, but only one</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to inspect them: to extract any data, you have to turn them into</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- lazy @Text@ values using @toLazyText@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Internally, a builder constructs a lazy @Text@ by filling arrays</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- piece by piece.  As each buffer is filled, it is \&#39;popped\&#39; off, to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- become a new chunk of the resulting lazy @Text@.  All this is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- hidden from the user of the @Builder@.</span></span><span class="mpre">
newtype </span><a name="loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tycondecl"><span class="mpre">Builder</span></span></a><span class="mpre"> = </span><a name="loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_condecl"><span class="mpre">Builder</span></span></a><span class="mpre"> {
     </span><span class="hl_comment"><span class="mpre">-- Invariant (from Data.Text.Lazy):</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">--      The lists include no null Texts.</span></span><span class="mpre">
     </span><a name="loc_89_6_89_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_6_89_16&#39;)"><span class="hl_fielddecl"><span class="mpre">runBuilder</span></span></a><span class="mpre"> :: forall </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre">. (</span><a href="#loc_210_6_210_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_6_210_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ST</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> [</span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">S.Text</span></span></a><span class="mpre">])
                -&gt; </span><a href="#loc_210_6_210_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_6_210_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre">
                -&gt; </span><span class="hl_tyconref"><span class="mpre">ST</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> [</span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">S.Text</span></span></a><span class="mpre">]
   }

instance </span><a href="Data.Monoid.html#loc_79_7_79_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_79_7_79_13&#39;)"><span class="hl_classref"><span class="mpre">Monoid</span></span></a><span class="mpre"> </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> where
   </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_vardecl"><span class="mpre">mempty</span></span></a><span class="mpre">  = </span><a href="#loc_122_1_122_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_6&#39;)"><span class="hl_varref"><span class="mpre">empty</span></span></a><span class="mpre">
   </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="mpre">mempty</span></a><span class="mpre"> #-}</span></span><span class="mpre">
   </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_vardecl"><span class="mpre">mappend</span></span></a><span class="mpre"> = </span><a href="#loc_151_1_151_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_1_151_7&#39;)"><span class="hl_varref"><span class="mpre">append</span></span></a><span class="mpre">
   </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="mpre">mappend</span></a><span class="mpre"> #-}</span></span><span class="mpre">
   </span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="hl_vardecl"><span class="mpre">mconcat</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">foldr</span></span><span class="mpre"> </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_varref"><span class="mpre">mappend</span></span></a><span class="mpre"> </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre">
   </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="mpre">mconcat</span></a><span class="mpre"> #-}</span></span><span class="mpre">

instance </span><a href="Data.String.html#loc_34_7_34_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.String.html#loc_34_7_34_15&#39;)"><span class="hl_classref"><span class="mpre">String.IsString</span></span></a><span class="mpre"> </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> where
    </span><a href="#loc_182_1_182_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_1_182_11&#39;)"><span class="hl_vardecl"><span class="mpre">fromString</span></span></a><span class="mpre"> = </span><a href="#loc_182_1_182_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_1_182_11&#39;)"><span class="hl_varref"><span class="mpre">fromString</span></span></a><span class="mpre">
    </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_182_1_182_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_1_182_11&#39;)"><span class="mpre">fromString</span></a><span class="mpre"> #-}</span></span><span class="mpre">

instance </span><span class="hl_classref"><span class="mpre">Show</span></span><span class="mpre"> </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> where
    </span><span class="hl_vardecl"><span class="mpre">show</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_221_1_221_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_1_221_11&#39;)"><span class="hl_varref"><span class="mpre">toLazyText</span></span></a><span class="mpre">

instance </span><span class="hl_classref"><span class="mpre">Eq</span></span><span class="mpre"> </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> where
    </span><a name="loc_110_5_110_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_5_110_6&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> </span><span class="hl_fundecl"><span class="mpre">==</span></span><span class="mpre"> </span><a name="loc_110_10_110_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_10_110_11&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> = </span><a href="#loc_221_1_221_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_1_221_11&#39;)"><span class="hl_varref"><span class="mpre">toLazyText</span></span></a><span class="mpre"> </span><a href="#loc_110_5_110_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_5_110_6&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_221_1_221_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_1_221_11&#39;)"><span class="hl_varref"><span class="mpre">toLazyText</span></span></a><span class="mpre"> </span><a href="#loc_110_10_110_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_10_110_11&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">

instance </span><span class="hl_classref"><span class="mpre">Ord</span></span><span class="mpre"> </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> where
    </span><a name="loc_113_5_113_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_5_113_6&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> </span><span class="hl_fundecl"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a name="loc_113_10_113_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_10_113_11&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> = </span><a href="#loc_221_1_221_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_1_221_11&#39;)"><span class="hl_varref"><span class="mpre">toLazyText</span></span></a><span class="mpre"> </span><a href="#loc_113_5_113_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_5_113_6&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_221_1_221_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_1_221_11&#39;)"><span class="hl_varref"><span class="mpre">toLazyText</span></span></a><span class="mpre"> </span><a href="#loc_113_10_113_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_10_113_11&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(1)./ The empty @Builder@, satisfying</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--  * @&#39;toLazyText&#39; &#39;empty&#39; = &#39;L.empty&#39;@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_122_1_122_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_6&#39;)"><span class="mpre">empty</span></a><span class="mpre"> :: </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_122_1_122_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_6&#39;)"><span class="hl_vardecl"><span class="mpre">empty</span></span></a><span class="mpre"> = </span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> (\ </span><a name="loc_122_20_122_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_20_122_21&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> </span><a name="loc_122_22_122_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_22_122_25&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_122_20_122_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_20_122_21&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_122_22_122_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_22_122_25&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_122_1_122_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_6&#39;)"><span class="mpre">empty</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(1)./ A @Builder@ taking a single character, satisfying</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--  * @&#39;toLazyText&#39; (&#39;singleton&#39; c) = &#39;L.singleton&#39; c@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_130_1_130_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_1_130_10&#39;)"><span class="mpre">singleton</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre"> -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_130_1_130_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_1_130_10&#39;)"><span class="hl_fundecl"><span class="mpre">singleton</span></span></a><span class="mpre"> </span><a name="loc_130_11_130_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_11_130_12&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre"> = </span><a href="#loc_273_1_273_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_273_1_273_12&#39;)"><span class="hl_varref"><span class="mpre">writeAtMost</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \ </span><a name="loc_130_33_130_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_33_130_37&#39;)"><span class="hl_vardecl"><span class="mpre">marr</span></span></a><span class="mpre"> </span><a name="loc_130_38_130_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_38_130_39&#39;)"><span class="hl_vardecl"><span class="mpre">o</span></span></a><span class="mpre"> -&gt;
    if </span><a href="#loc_137_9_137_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_9_137_10&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0x10000</span></span><span class="mpre">
    then </span><a href="Data.Text.Array.html#loc_158_1_158_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_158_1_158_12&#39;)"><span class="hl_varref"><span class="mpre">A.unsafeWrite</span></span></a><span class="mpre"> </span><a href="#loc_130_33_130_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_33_130_37&#39;)"><span class="hl_varref"><span class="mpre">marr</span></span></a><span class="mpre"> </span><a href="#loc_130_38_130_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_38_130_39&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_137_9_137_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_9_137_10&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">
    else do
        </span><a href="Data.Text.Array.html#loc_158_1_158_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_158_1_158_12&#39;)"><span class="hl_varref"><span class="mpre">A.unsafeWrite</span></span></a><span class="mpre"> </span><a href="#loc_130_33_130_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_33_130_37&#39;)"><span class="hl_varref"><span class="mpre">marr</span></span></a><span class="mpre"> </span><a href="#loc_130_38_130_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_38_130_39&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre"> </span><a href="#loc_139_9_139_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_9_139_11&#39;)"><span class="hl_varref"><span class="mpre">lo</span></span></a><span class="mpre">
        </span><a href="Data.Text.Array.html#loc_158_1_158_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_158_1_158_12&#39;)"><span class="hl_varref"><span class="mpre">A.unsafeWrite</span></span></a><span class="mpre"> </span><a href="#loc_130_33_130_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_33_130_37&#39;)"><span class="hl_varref"><span class="mpre">marr</span></span></a><span class="mpre"> (</span><a href="#loc_130_38_130_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_38_130_39&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">) </span><a href="#loc_140_9_140_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_140_9_140_11&#39;)"><span class="hl_varref"><span class="mpre">hi</span></span></a><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre">
  where </span><a name="loc_137_9_137_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_9_137_10&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> = </span><a href="Data.Text.Internal.Unsafe.Char.html#loc_40_1_40_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Unsafe.Char.html#loc_40_1_40_4&#39;)"><span class="hl_varref"><span class="mpre">ord</span></span></a><span class="mpre"> </span><a href="#loc_130_11_130_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_11_130_12&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">
        </span><a name="loc_138_9_138_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_9_138_10&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre"> = </span><a href="#loc_137_9_137_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_9_137_10&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0x10000</span></span><span class="mpre">
        </span><a name="loc_139_9_139_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_9_139_11&#39;)"><span class="hl_vardecl"><span class="mpre">lo</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> (</span><a href="#loc_138_9_138_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_9_138_10&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><a href="Data.Text.Internal.Unsafe.Shift.html#loc_35_5_35_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Unsafe.Shift.html#loc_35_5_35_11&#39;)"><span class="hl_infix"><span class="mpre">`shiftR`</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">10</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xD800</span></span><span class="mpre">
        </span><a name="loc_140_9_140_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_140_9_140_11&#39;)"><span class="hl_vardecl"><span class="mpre">hi</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> (</span><a href="#loc_138_9_138_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_9_138_10&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.&amp;.</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0x3FF</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xDC00</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_130_1_130_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_130_1_130_10&#39;)"><span class="mpre">singleton</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(1)./ The concatenation of two builders, an associative</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- operation with identity &#39;empty&#39;, satisfying</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--  * @&#39;toLazyText&#39; (&#39;append&#39; x y) = &#39;L.append&#39; (&#39;toLazyText&#39; x) (&#39;toLazyText&#39; y)@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_151_1_151_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_1_151_7&#39;)"><span class="mpre">append</span></a><span class="mpre"> :: </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_151_1_151_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_1_151_7&#39;)"><span class="hl_fundecl"><span class="mpre">append</span></span></a><span class="mpre"> (</span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><a name="loc_151_17_151_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_17_151_18&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre">) (</span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><a name="loc_151_29_151_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_29_151_30&#39;)"><span class="hl_vardecl"><span class="mpre">g</span></span></a><span class="mpre">) = </span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> (</span><a href="#loc_151_17_151_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_17_151_18&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_151_29_151_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_29_151_30&#39;)"><span class="hl_varref"><span class="mpre">g</span></span></a><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE [0] </span><a href="#loc_151_1_151_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_1_151_7&#39;)"><span class="mpre">append</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- TODO: Experiment to find the right threshold.</span></span><span class="mpre">
</span><a href="#loc_156_1_156_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_1_156_10&#39;)"><span class="mpre">copyLimit</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_156_1_156_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_1_156_10&#39;)"><span class="hl_vardecl"><span class="mpre">copyLimit</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">128</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- This function attempts to merge small @Text@ values instead of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- treating each value as its own chunk.  We may not always want this.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(1)./ A @Builder@ taking a &#39;S.Text&#39;, satisfying</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--  * @&#39;toLazyText&#39; (&#39;fromText&#39; t) = &#39;L.fromChunks&#39; [t]@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_166_1_166_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_1_166_9&#39;)"><span class="mpre">fromText</span></a><span class="mpre"> :: </span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">S.Text</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_166_1_166_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_1_166_9&#39;)"><span class="hl_fundecl"><span class="mpre">fromText</span></span></a><span class="mpre"> </span><a name="loc_166_10_166_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_10_166_11&#39;)"><span class="hl_specname"><span class="mpre">t</span></span></a><span class="mpre">@(</span><a href="Data.Text.Internal.html#loc_50_13_50_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_13_50_17&#39;)"><span class="hl_conref"><span class="mpre">Text</span></span></a><span class="mpre"> </span><a name="loc_166_18_166_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_18_166_21&#39;)"><span class="hl_vardecl"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a name="loc_166_22_166_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_22_166_25&#39;)"><span class="hl_vardecl"><span class="mpre">off</span></span></a><span class="mpre"> </span><a name="loc_166_26_166_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_26_166_27&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">)
    | </span><a href="Data.Text.html#loc_531_1_531_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.html#loc_531_1_531_5&#39;)"><span class="hl_varref"><span class="mpre">S.null</span></span></a><span class="mpre"> </span><a href="#loc_166_10_166_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_10_166_11&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre">       = </span><a href="#loc_122_1_122_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_6&#39;)"><span class="hl_varref"><span class="mpre">empty</span></span></a><span class="mpre">
    | </span><a href="#loc_166_26_166_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_26_166_27&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_156_1_156_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_1_156_10&#39;)"><span class="hl_varref"><span class="mpre">copyLimit</span></span></a><span class="mpre"> = </span><a href="#loc_279_1_279_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_1_279_7&#39;)"><span class="hl_varref"><span class="mpre">writeN</span></span></a><span class="mpre"> </span><a href="#loc_166_26_166_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_26_166_27&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_168_36_168_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_36_168_40&#39;)"><span class="hl_vardecl"><span class="mpre">marr</span></span></a><span class="mpre"> </span><a name="loc_168_41_168_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_41_168_42&#39;)"><span class="hl_vardecl"><span class="mpre">o</span></span></a><span class="mpre"> -&gt; </span><a href="Data.Text.Array.html#loc_215_1_215_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_215_1_215_6&#39;)"><span class="hl_varref"><span class="mpre">A.copyI</span></span></a><span class="mpre"> </span><a href="#loc_168_36_168_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_36_168_40&#39;)"><span class="hl_varref"><span class="mpre">marr</span></span></a><span class="mpre"> </span><a href="#loc_168_41_168_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_41_168_42&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre"> </span><a href="#loc_166_18_166_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_18_166_21&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a href="#loc_166_22_166_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_22_166_25&#39;)"><span class="hl_varref"><span class="mpre">off</span></span></a><span class="mpre"> (</span><a href="#loc_166_26_166_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_26_166_27&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_168_41_168_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_168_41_168_42&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre">)
    | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">      = </span><a href="#loc_236_1_236_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_1_236_6&#39;)"><span class="hl_varref"><span class="mpre">flush</span></span></a><span class="mpre"> </span><a href="#loc_151_1_151_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_1_151_7&#39;)"><span class="hl_infix"><span class="mpre">`append`</span></span></a><span class="mpre"> </span><a href="#loc_260_1_260_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_260_1_260_11&#39;)"><span class="hl_varref"><span class="mpre">mapBuilder</span></span></a><span class="mpre"> (</span><a href="#loc_166_10_166_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_10_166_11&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE [1] </span><a href="#loc_166_1_166_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_1_166_9&#39;)"><span class="mpre">fromText</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_pragma"><span class="mpre">{-# RULES
&quot;fromText/pack&quot; forall s .
        fromText (S.pack s) = fromString s
 #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(1)./ A Builder taking a @String@, satisfying</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--  * @&#39;toLazyText&#39; (&#39;fromString&#39; s) = &#39;L.fromChunks&#39; [S.pack s]@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_182_1_182_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_1_182_11&#39;)"><span class="mpre">fromString</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_182_1_182_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_1_182_11&#39;)"><span class="hl_fundecl"><span class="mpre">fromString</span></span></a><span class="mpre"> </span><a name="loc_182_12_182_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_12_182_15&#39;)"><span class="hl_vardecl"><span class="mpre">str</span></span></a><span class="mpre"> = </span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_182_29_182_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_29_182_30&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> (</span><a href="#loc_210_17_210_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_17_210_23&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_182_39_182_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_39_182_41&#39;)"><span class="hl_vardecl"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a name="loc_182_42_182_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_42_182_44&#39;)"><span class="hl_vardecl"><span class="mpre">o0</span></span></a><span class="mpre"> </span><a name="loc_182_45_182_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_45_182_47&#39;)"><span class="hl_vardecl"><span class="mpre">u0</span></span></a><span class="mpre"> </span><a name="loc_182_48_182_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_48_182_50&#39;)"><span class="hl_vardecl"><span class="mpre">l0</span></span></a><span class="mpre">) -&gt;
    let </span><a name="loc_183_9_183_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_9_183_13&#39;)"><span class="hl_fundecl"><span class="mpre">loop</span></span></a><span class="mpre"> !</span><a name="loc_183_15_183_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_15_183_19&#39;)"><span class="hl_vardecl"><span class="mpre">marr</span></span></a><span class="mpre"> !</span><a name="loc_183_21_183_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_21_183_22&#39;)"><span class="hl_vardecl"><span class="mpre">o</span></span></a><span class="mpre"> !</span><a name="loc_183_24_183_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_24_183_25&#39;)"><span class="hl_vardecl"><span class="mpre">u</span></span></a><span class="mpre"> !</span><a name="loc_183_27_183_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_27_183_28&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre"> [] = </span><a href="#loc_182_29_182_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_29_182_30&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> (</span><a href="#loc_210_17_210_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_17_210_23&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_183_15_183_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_15_183_19&#39;)"><span class="hl_varref"><span class="mpre">marr</span></span></a><span class="mpre"> </span><a href="#loc_183_21_183_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_21_183_22&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre"> </span><a href="#loc_183_24_183_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_24_183_25&#39;)"><span class="hl_varref"><span class="mpre">u</span></span></a><span class="mpre"> </span><a href="#loc_183_27_183_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_27_183_28&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">)
        </span><a href="#loc_183_9_183_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_9_183_13&#39;)"><span class="hl_fundecl"><span class="mpre">loop</span></span></a><span class="mpre"> </span><a name="loc_184_14_184_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_14_184_18&#39;)"><span class="hl_vardecl"><span class="mpre">marr</span></span></a><span class="mpre"> </span><a name="loc_184_19_184_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_19_184_20&#39;)"><span class="hl_vardecl"><span class="mpre">o</span></span></a><span class="mpre"> </span><a name="loc_184_21_184_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_21_184_22&#39;)"><span class="hl_vardecl"><span class="mpre">u</span></span></a><span class="mpre"> </span><a name="loc_184_23_184_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_23_184_24&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre"> </span><a name="loc_184_25_184_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_25_184_26&#39;)"><span class="hl_specname"><span class="mpre">s</span></span></a><span class="mpre">@(</span><a name="loc_184_28_184_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_28_184_29&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_184_30_184_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_30_184_32&#39;)"><span class="hl_vardecl"><span class="mpre">cs</span></span></a><span class="mpre">)
            | </span><a href="#loc_184_23_184_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_23_184_24&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> = do
                </span><a name="loc_186_17_186_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_17_186_20&#39;)"><span class="hl_vardecl"><span class="mpre">arr</span></span></a><span class="mpre"> &lt;- </span><a href="Data.Text.Array.html#loc_133_1_133_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_133_1_133_13&#39;)"><span class="hl_varref"><span class="mpre">A.unsafeFreeze</span></span></a><span class="mpre"> </span><a href="#loc_184_14_184_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_14_184_18&#39;)"><span class="hl_varref"><span class="mpre">marr</span></span></a><span class="mpre">
                let !</span><a name="loc_187_22_187_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_187_22_187_23&#39;)"><span class="hl_vardecl"><span class="mpre">t</span></span></a><span class="mpre"> = </span><a href="Data.Text.Internal.html#loc_50_13_50_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_13_50_17&#39;)"><span class="hl_conref"><span class="mpre">Text</span></span></a><span class="mpre"> </span><a href="#loc_186_17_186_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_17_186_20&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a href="#loc_184_19_184_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_19_184_20&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre"> </span><a href="#loc_184_21_184_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_21_184_22&#39;)"><span class="hl_varref"><span class="mpre">u</span></span></a><span class="mpre">
                </span><a name="loc_188_17_188_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_17_188_22&#39;)"><span class="hl_vardecl"><span class="mpre">marr&#39;</span></span></a><span class="mpre"> &lt;- </span><a href="Data.Text.Array.html#loc_115_1_115_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_115_1_115_4&#39;)"><span class="hl_varref"><span class="mpre">A.new</span></span></a><span class="mpre"> </span><a href="#loc_196_5_196_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_5_196_14&#39;)"><span class="hl_varref"><span class="mpre">chunkSize</span></span></a><span class="mpre">
                </span><a name="loc_189_17_189_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_17_189_19&#39;)"><span class="hl_vardecl"><span class="mpre">ts</span></span></a><span class="mpre"> &lt;- </span><a href="Data.Text.Internal.Unsafe.html#loc_54_1_54_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Unsafe.html#loc_54_1_54_19&#39;)"><span class="hl_varref"><span class="mpre">inlineInterleaveST</span></span></a><span class="mpre"> (</span><a href="#loc_183_9_183_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_9_183_13&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> </span><a href="#loc_188_17_188_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_17_188_22&#39;)"><span class="hl_varref"><span class="mpre">marr&#39;</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><a href="#loc_196_5_196_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_5_196_14&#39;)"><span class="hl_varref"><span class="mpre">chunkSize</span></span></a><span class="mpre"> </span><a href="#loc_184_25_184_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_25_184_26&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">)
                </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_187_22_187_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_187_22_187_23&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a href="#loc_189_17_189_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_17_189_19&#39;)"><span class="hl_varref"><span class="mpre">ts</span></span></a><span class="mpre">
            | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = do
                </span><a name="loc_192_17_192_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_17_192_18&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> &lt;- </span><a href="Data.Text.Internal.Unsafe.Char.html#loc_58_1_58_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Unsafe.Char.html#loc_58_1_58_12&#39;)"><span class="hl_varref"><span class="mpre">unsafeWrite</span></span></a><span class="mpre"> </span><a href="#loc_184_14_184_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_14_184_18&#39;)"><span class="hl_varref"><span class="mpre">marr</span></span></a><span class="mpre"> (</span><a href="#loc_184_19_184_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_19_184_20&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_184_21_184_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_21_184_22&#39;)"><span class="hl_varref"><span class="mpre">u</span></span></a><span class="mpre">) </span><a href="#loc_184_28_184_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_28_184_29&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">
                </span><a href="#loc_183_9_183_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_9_183_13&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> </span><a href="#loc_184_14_184_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_14_184_18&#39;)"><span class="hl_varref"><span class="mpre">marr</span></span></a><span class="mpre"> </span><a href="#loc_184_19_184_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_19_184_20&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre"> (</span><a href="#loc_184_21_184_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_21_184_22&#39;)"><span class="hl_varref"><span class="mpre">u</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_192_17_192_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_17_192_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">) (</span><a href="#loc_184_23_184_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_23_184_24&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><a href="#loc_192_17_192_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_17_192_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">) </span><a href="#loc_184_30_184_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_184_30_184_32&#39;)"><span class="hl_varref"><span class="mpre">cs</span></span></a><span class="mpre">
    in </span><a href="#loc_183_9_183_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_183_9_183_13&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> </span><a href="#loc_182_39_182_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_39_182_41&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a href="#loc_182_42_182_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_42_182_44&#39;)"><span class="hl_varref"><span class="mpre">o0</span></span></a><span class="mpre"> </span><a href="#loc_182_45_182_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_45_182_47&#39;)"><span class="hl_varref"><span class="mpre">u0</span></span></a><span class="mpre"> </span><a href="#loc_182_48_182_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_48_182_50&#39;)"><span class="hl_varref"><span class="mpre">l0</span></span></a><span class="mpre"> </span><a href="#loc_182_12_182_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_12_182_15&#39;)"><span class="hl_varref"><span class="mpre">str</span></span></a><span class="mpre">
  where
    </span><a name="loc_196_5_196_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_5_196_14&#39;)"><span class="hl_vardecl"><span class="mpre">chunkSize</span></span></a><span class="mpre"> = </span><a href="Data.Text.Internal.Lazy.html#loc_113_1_113_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Lazy.html#loc_113_1_113_15&#39;)"><span class="hl_varref"><span class="mpre">smallChunkSize</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_182_1_182_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_1_182_11&#39;)"><span class="mpre">fromString</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(1)./ A @Builder@ taking a lazy @Text@, satisfying</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--  * @&#39;toLazyText&#39; (&#39;fromLazyText&#39; t) = t@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_204_1_204_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_1_204_13&#39;)"><span class="mpre">fromLazyText</span></a><span class="mpre"> :: </span><a href="Data.Text.Internal.Lazy.html#loc_47_6_47_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Lazy.html#loc_47_6_47_10&#39;)"><span class="hl_tyconref"><span class="mpre">L.Text</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_204_1_204_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_1_204_13&#39;)"><span class="hl_fundecl"><span class="mpre">fromLazyText</span></span></a><span class="mpre"> </span><a name="loc_204_14_204_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_14_204_16&#39;)"><span class="hl_vardecl"><span class="mpre">ts</span></span></a><span class="mpre"> = </span><a href="#loc_236_1_236_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_1_236_6&#39;)"><span class="hl_varref"><span class="mpre">flush</span></span></a><span class="mpre"> </span><a href="#loc_151_1_151_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_1_151_7&#39;)"><span class="hl_infix"><span class="mpre">`append`</span></span></a><span class="mpre"> </span><a href="#loc_260_1_260_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_260_1_260_11&#39;)"><span class="hl_varref"><span class="mpre">mapBuilder</span></span></a><span class="mpre"> (</span><a href="Data.Text.Lazy.html#loc_389_1_389_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Lazy.html#loc_389_1_389_9&#39;)"><span class="hl_varref"><span class="mpre">L.toChunks</span></span></a><span class="mpre"> </span><a href="#loc_204_14_204_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_14_204_16&#39;)"><span class="hl_varref"><span class="mpre">ts</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_204_1_204_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_1_204_13&#39;)"><span class="mpre">fromLazyText</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Our internal buffer type</span></span><span class="mpre">
data </span><a name="loc_210_6_210_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_6_210_12&#39;)"><span class="hl_tycondecl"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> = </span><a name="loc_210_17_210_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_17_210_23&#39;)"><span class="hl_condecl"><span class="mpre">Buffer</span></span></a><span class="mpre"> {-# UNPACK #-} !(</span><a href="Data.Text.Array.html#loc_91_6_91_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_91_6_91_12&#39;)"><span class="hl_tyconref"><span class="mpre">A.MArray</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre">)
                       {-# UNPACK #-} !</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- offset</span></span><span class="mpre">
                       {-# UNPACK #-} !</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- used units</span></span><span class="mpre">
                       {-# UNPACK #-} !</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- length left</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(n)./ Extract a lazy @Text@ from a @Builder@ with a default</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- buffer size.  The construction work takes place if and when the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- relevant part of the lazy @Text@ is demanded.</span></span><span class="mpre">
</span><a href="#loc_221_1_221_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_1_221_11&#39;)"><span class="mpre">toLazyText</span></a><span class="mpre"> :: </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><a href="Data.Text.Internal.Lazy.html#loc_47_6_47_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Lazy.html#loc_47_6_47_10&#39;)"><span class="hl_tyconref"><span class="mpre">L.Text</span></span></a><span class="mpre">
</span><a name="loc_221_1_221_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_1_221_11&#39;)"><span class="hl_vardecl"><span class="mpre">toLazyText</span></span></a><span class="mpre"> = </span><a href="#loc_230_1_230_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_230_1_230_15&#39;)"><span class="hl_varref"><span class="mpre">toLazyTextWith</span></span></a><span class="mpre"> </span><a href="Data.Text.Internal.Lazy.html#loc_113_1_113_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Lazy.html#loc_113_1_113_15&#39;)"><span class="hl_varref"><span class="mpre">smallChunkSize</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(n)./ Extract a lazy @Text@ from a @Builder@, using the given</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- size for the initial buffer.  The construction work takes place if</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- and when the relevant part of the lazy @Text@ is demanded.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- If the initial buffer is too small to hold all data, subsequent</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- buffers will be the default buffer size.</span></span><span class="mpre">
</span><a href="#loc_230_1_230_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_230_1_230_15&#39;)"><span class="mpre">toLazyTextWith</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><a href="Data.Text.Internal.Lazy.html#loc_47_6_47_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Lazy.html#loc_47_6_47_10&#39;)"><span class="hl_tyconref"><span class="mpre">L.Text</span></span></a><span class="mpre">
</span><a name="loc_230_1_230_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_230_1_230_15&#39;)"><span class="hl_fundecl"><span class="mpre">toLazyTextWith</span></span></a><span class="mpre"> </span><a name="loc_230_16_230_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_230_16_230_25&#39;)"><span class="hl_vardecl"><span class="mpre">chunkSize</span></span></a><span class="mpre"> </span><a name="loc_230_26_230_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_230_26_230_27&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre"> = </span><a href="Data.Text.Lazy.html#loc_385_1_385_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Lazy.html#loc_385_1_385_11&#39;)"><span class="hl_varref"><span class="mpre">L.fromChunks</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">runST</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
  </span><a href="#loc_289_1_289_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_1_289_10&#39;)"><span class="hl_varref"><span class="mpre">newBuffer</span></span></a><span class="mpre"> </span><a href="#loc_230_16_230_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_230_16_230_25&#39;)"><span class="hl_varref"><span class="mpre">chunkSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_89_6_89_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_6_89_16&#39;)"><span class="hl_varref"><span class="mpre">runBuilder</span></span></a><span class="mpre"> (</span><a href="#loc_230_26_230_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_230_26_230_27&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><a href="#loc_151_1_151_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_1_151_7&#39;)"><span class="hl_infix"><span class="mpre">`append`</span></span></a><span class="mpre"> </span><a href="#loc_236_1_236_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_1_236_6&#39;)"><span class="hl_varref"><span class="mpre">flush</span></span></a><span class="mpre">) (</span><span class="hl_varref"><span class="mpre">const</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> [])))

</span><span class="hl_comment"><span class="mpre">-- | /O(1)./ Pop the strict @Text@ we have constructed so far, if any,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- yielding a new chunk in the result lazy @Text@.</span></span><span class="mpre">
</span><a href="#loc_236_1_236_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_1_236_6&#39;)"><span class="mpre">flush</span></a><span class="mpre"> :: </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_236_1_236_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_1_236_6&#39;)"><span class="hl_vardecl"><span class="mpre">flush</span></span></a><span class="mpre"> = </span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \ </span><a name="loc_236_21_236_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_21_236_22&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> </span><a name="loc_236_23_236_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_23_236_26&#39;)"><span class="hl_specname"><span class="mpre">buf</span></span></a><span class="mpre">@(</span><a href="#loc_210_17_210_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_17_210_23&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_236_35_236_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_35_236_36&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> </span><a name="loc_236_37_236_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_37_236_38&#39;)"><span class="hl_vardecl"><span class="mpre">o</span></span></a><span class="mpre"> </span><a name="loc_236_39_236_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_39_236_40&#39;)"><span class="hl_vardecl"><span class="mpre">u</span></span></a><span class="mpre"> </span><a name="loc_236_41_236_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_41_236_42&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) -&gt;
    if </span><a href="#loc_236_39_236_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_39_236_40&#39;)"><span class="hl_varref"><span class="mpre">u</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
    then </span><a href="#loc_236_21_236_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_21_236_22&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_236_23_236_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_23_236_26&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">
    else do </span><a name="loc_239_13_239_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_13_239_16&#39;)"><span class="hl_vardecl"><span class="mpre">arr</span></span></a><span class="mpre"> &lt;- </span><a href="Data.Text.Array.html#loc_133_1_133_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_133_1_133_13&#39;)"><span class="hl_varref"><span class="mpre">A.unsafeFreeze</span></span></a><span class="mpre"> </span><a href="#loc_236_35_236_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_35_236_36&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">
            let !</span><a name="loc_240_18_240_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_18_240_19&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> = </span><a href="#loc_210_17_210_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_17_210_23&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_236_35_236_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_35_236_36&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> (</span><a href="#loc_236_37_236_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_37_236_38&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_236_39_236_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_39_236_40&#39;)"><span class="hl_varref"><span class="mpre">u</span></span></a><span class="mpre">) </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><a href="#loc_236_41_236_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_41_236_42&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">
                !</span><a name="loc_241_18_241_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_18_241_19&#39;)"><span class="hl_vardecl"><span class="mpre">t</span></span></a><span class="mpre"> = </span><a href="Data.Text.Internal.html#loc_50_13_50_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_13_50_17&#39;)"><span class="hl_conref"><span class="mpre">Text</span></span></a><span class="mpre"> </span><a href="#loc_239_13_239_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_13_239_16&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a href="#loc_236_37_236_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_37_236_38&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre"> </span><a href="#loc_236_39_236_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_39_236_40&#39;)"><span class="hl_varref"><span class="mpre">u</span></span></a><span class="mpre">
            </span><a name="loc_242_13_242_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_13_242_15&#39;)"><span class="hl_vardecl"><span class="mpre">ts</span></span></a><span class="mpre"> &lt;- </span><a href="Data.Text.Internal.Unsafe.html#loc_54_1_54_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Unsafe.html#loc_54_1_54_19&#39;)"><span class="hl_varref"><span class="mpre">inlineInterleaveST</span></span></a><span class="mpre"> (</span><a href="#loc_236_21_236_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_21_236_22&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_240_18_240_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_240_18_240_19&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">)
            </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="Prelude.html#loc_160_3_160_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Prelude.html#loc_160_3_160_5&#39;)"><span class="hl_infix"><span class="mpre">$!</span></span></a><span class="mpre"> </span><a href="#loc_241_18_241_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_18_241_19&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a href="#loc_242_13_242_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_13_242_15&#39;)"><span class="hl_varref"><span class="mpre">ts</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Sequence an ST operation on the buffer</span></span><span class="mpre">
</span><a href="#loc_249_1_249_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_1_249_11&#39;)"><span class="mpre">withBuffer</span></a><span class="mpre"> :: (forall </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre">. </span><a href="#loc_210_6_210_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_6_210_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ST</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> (</span><a href="#loc_210_6_210_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_6_210_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre">)) -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_249_1_249_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_1_249_11&#39;)"><span class="hl_fundecl"><span class="mpre">withBuffer</span></span></a><span class="mpre"> </span><a name="loc_249_12_249_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_12_249_13&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = </span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_249_27_249_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_27_249_28&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> </span><a name="loc_249_29_249_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_29_249_32&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_249_12_249_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_12_249_13&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_249_29_249_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_29_249_32&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_249_27_249_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_27_249_28&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_249_1_249_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_1_249_11&#39;)"><span class="mpre">withBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Get the size of the buffer</span></span><span class="mpre">
</span><a href="#loc_254_1_254_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_1_254_9&#39;)"><span class="mpre">withSize</span></a><span class="mpre"> :: (</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">) -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_254_1_254_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_1_254_9&#39;)"><span class="hl_fundecl"><span class="mpre">withSize</span></span></a><span class="mpre"> </span><a name="loc_254_10_254_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_10_254_11&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = </span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \ </span><a name="loc_254_26_254_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_26_254_27&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> </span><a name="loc_254_28_254_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_28_254_31&#39;)"><span class="hl_specname"><span class="mpre">buf</span></span></a><span class="mpre">@(</span><a href="#loc_210_17_210_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_17_210_23&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> _ _ _ </span><a name="loc_254_46_254_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_46_254_47&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) -&gt;
    </span><a href="#loc_89_6_89_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_6_89_16&#39;)"><span class="hl_varref"><span class="mpre">runBuilder</span></span></a><span class="mpre"> (</span><a href="#loc_254_10_254_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_10_254_11&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_254_46_254_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_46_254_47&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">) </span><a href="#loc_254_26_254_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_26_254_27&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_254_28_254_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_28_254_31&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_254_1_254_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_1_254_9&#39;)"><span class="mpre">withSize</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Map the resulting list of texts.</span></span><span class="mpre">
</span><a href="#loc_260_1_260_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_260_1_260_11&#39;)"><span class="mpre">mapBuilder</span></a><span class="mpre"> :: ([</span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">S.Text</span></span></a><span class="mpre">] -&gt; [</span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">S.Text</span></span></a><span class="mpre">]) -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_260_1_260_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_260_1_260_11&#39;)"><span class="hl_fundecl"><span class="mpre">mapBuilder</span></span></a><span class="mpre"> </span><a name="loc_260_12_260_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_260_12_260_13&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = </span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> </span><a href="#loc_260_12_260_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_260_12_260_13&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Ensure that there are at least @n@ many elements available.</span></span><span class="mpre">
</span><a href="#loc_266_1_266_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_266_1_266_11&#39;)"><span class="mpre">ensureFree</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_266_1_266_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_266_1_266_11&#39;)"><span class="hl_fundecl"><span class="mpre">ensureFree</span></span></a><span class="mpre"> !</span><a name="loc_266_13_266_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_266_13_266_14&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> = </span><a href="#loc_254_1_254_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_1_254_9&#39;)"><span class="hl_varref"><span class="mpre">withSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \ </span><a name="loc_266_30_266_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_266_30_266_31&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre"> -&gt;
    if </span><a href="#loc_266_13_266_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_266_13_266_14&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_266_30_266_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_266_30_266_31&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">
    then </span><a href="#loc_122_1_122_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_6&#39;)"><span class="hl_varref"><span class="mpre">empty</span></span></a><span class="mpre">
    else </span><a href="#loc_236_1_236_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_236_1_236_6&#39;)"><span class="hl_varref"><span class="mpre">flush</span></span></a><span class="mpre"> </span><a href="#loc_301_1_301_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_1_301_8&#39;)"><span class="hl_infix"><span class="mpre">`append&#39;`</span></span></a><span class="mpre"> </span><a href="#loc_249_1_249_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_1_249_11&#39;)"><span class="hl_varref"><span class="mpre">withBuffer</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">const</span></span><span class="mpre"> (</span><a href="#loc_289_1_289_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_1_289_10&#39;)"><span class="hl_varref"><span class="mpre">newBuffer</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">max</span></span><span class="mpre"> </span><a href="#loc_266_13_266_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_266_13_266_14&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><a href="Data.Text.Internal.Lazy.html#loc_113_1_113_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.Lazy.html#loc_113_1_113_15&#39;)"><span class="hl_varref"><span class="mpre">smallChunkSize</span></span></a><span class="mpre">)))
</span><span class="hl_pragma"><span class="mpre">{-# INLINE [0] </span><a href="#loc_266_1_266_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_266_1_266_11&#39;)"><span class="mpre">ensureFree</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><a href="#loc_273_1_273_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_273_1_273_12&#39;)"><span class="mpre">writeAtMost</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; (forall </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre">. </span><a href="Data.Text.Array.html#loc_91_6_91_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_91_6_91_12&#39;)"><span class="hl_tyconref"><span class="mpre">A.MArray</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ST</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">) -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_273_1_273_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_273_1_273_12&#39;)"><span class="hl_fundecl"><span class="mpre">writeAtMost</span></span></a><span class="mpre"> </span><a name="loc_273_13_273_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_273_13_273_14&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> </span><a name="loc_273_15_273_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_273_15_273_16&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = </span><a href="#loc_266_1_266_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_266_1_266_11&#39;)"><span class="hl_varref"><span class="mpre">ensureFree</span></span></a><span class="mpre"> </span><a href="#loc_273_13_273_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_273_13_273_14&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><a href="#loc_301_1_301_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_1_301_8&#39;)"><span class="hl_infix"><span class="mpre">`append&#39;`</span></span></a><span class="mpre"> </span><a href="#loc_249_1_249_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_1_249_11&#39;)"><span class="hl_varref"><span class="mpre">withBuffer</span></span></a><span class="mpre"> (</span><a href="#loc_283_1_283_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_1_283_12&#39;)"><span class="hl_varref"><span class="mpre">writeBuffer</span></span></a><span class="mpre"> </span><a href="#loc_273_15_273_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_273_15_273_16&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE [0] </span><a href="#loc_273_1_273_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_273_1_273_12&#39;)"><span class="mpre">writeAtMost</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Ensure that @n@ many elements are available, and then use @f@ to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- write some elements into the memory.</span></span><span class="mpre">
</span><a href="#loc_279_1_279_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_1_279_7&#39;)"><span class="mpre">writeN</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; (forall </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre">. </span><a href="Data.Text.Array.html#loc_91_6_91_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_91_6_91_12&#39;)"><span class="hl_tyconref"><span class="mpre">A.MArray</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ST</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">) -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_279_1_279_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_1_279_7&#39;)"><span class="hl_fundecl"><span class="mpre">writeN</span></span></a><span class="mpre"> </span><a name="loc_279_8_279_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_8_279_9&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> </span><a name="loc_279_10_279_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_10_279_11&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = </span><a href="#loc_273_1_273_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_273_1_273_12&#39;)"><span class="hl_varref"><span class="mpre">writeAtMost</span></span></a><span class="mpre"> </span><a href="#loc_279_8_279_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_8_279_9&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> (\ </span><a name="loc_279_31_279_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_31_279_32&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> </span><a name="loc_279_33_279_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_33_279_34&#39;)"><span class="hl_vardecl"><span class="mpre">o</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_279_10_279_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_10_279_11&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_279_31_279_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_31_279_32&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> </span><a href="#loc_279_33_279_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_33_279_34&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_279_8_279_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_8_279_9&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_279_1_279_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_279_1_279_7&#39;)"><span class="mpre">writeN</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><a href="#loc_283_1_283_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_1_283_12&#39;)"><span class="mpre">writeBuffer</span></a><span class="mpre"> :: (</span><a href="Data.Text.Array.html#loc_91_6_91_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_91_6_91_12&#39;)"><span class="hl_tyconref"><span class="mpre">A.MArray</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ST</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">) -&gt; </span><a href="#loc_210_6_210_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_6_210_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ST</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> (</span><a href="#loc_210_6_210_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_6_210_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre">)
</span><a name="loc_283_1_283_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_1_283_12&#39;)"><span class="hl_fundecl"><span class="mpre">writeBuffer</span></span></a><span class="mpre"> </span><a name="loc_283_13_283_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_13_283_14&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> (</span><a href="#loc_210_17_210_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_17_210_23&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_283_23_283_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_23_283_24&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> </span><a name="loc_283_25_283_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_25_283_26&#39;)"><span class="hl_vardecl"><span class="mpre">o</span></span></a><span class="mpre"> </span><a name="loc_283_27_283_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_27_283_28&#39;)"><span class="hl_vardecl"><span class="mpre">u</span></span></a><span class="mpre"> </span><a name="loc_283_29_283_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_29_283_30&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) = do
    </span><a name="loc_284_5_284_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_5_284_6&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_283_13_283_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_13_283_14&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_283_23_283_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_23_283_24&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> (</span><a href="#loc_283_25_283_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_25_283_26&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_283_27_283_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_27_283_28&#39;)"><span class="hl_varref"><span class="mpre">u</span></span></a><span class="mpre">)
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="Prelude.html#loc_160_3_160_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Prelude.html#loc_160_3_160_5&#39;)"><span class="hl_infix"><span class="mpre">$!</span></span></a><span class="mpre"> </span><a href="#loc_210_17_210_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_17_210_23&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_283_23_283_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_23_283_24&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> </span><a href="#loc_283_25_283_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_25_283_26&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre"> (</span><a href="#loc_283_27_283_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_27_283_28&#39;)"><span class="hl_varref"><span class="mpre">u</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_284_5_284_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_5_284_6&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">) (</span><a href="#loc_283_29_283_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_29_283_30&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><a href="#loc_284_5_284_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_5_284_6&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_283_1_283_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_283_1_283_12&#39;)"><span class="mpre">writeBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><a href="#loc_289_1_289_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_1_289_10&#39;)"><span class="mpre">newBuffer</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ST</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre"> (</span><a href="#loc_210_6_210_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_6_210_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">s</span></span><span class="mpre">)
</span><a name="loc_289_1_289_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_1_289_10&#39;)"><span class="hl_fundecl"><span class="mpre">newBuffer</span></span></a><span class="mpre"> </span><a name="loc_289_11_289_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_11_289_15&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre"> = do
    </span><a name="loc_290_5_290_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_5_290_8&#39;)"><span class="hl_vardecl"><span class="mpre">arr</span></span></a><span class="mpre"> &lt;- </span><a href="Data.Text.Array.html#loc_115_1_115_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_115_1_115_4&#39;)"><span class="hl_varref"><span class="mpre">A.new</span></span></a><span class="mpre"> </span><a href="#loc_289_11_289_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_11_289_15&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="Prelude.html#loc_160_3_160_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Prelude.html#loc_160_3_160_5&#39;)"><span class="hl_infix"><span class="mpre">$!</span></span></a><span class="mpre"> </span><a href="#loc_210_17_210_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_17_210_23&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_290_5_290_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_5_290_8&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><a href="#loc_289_11_289_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_11_289_15&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_289_1_289_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_1_289_10&#39;)"><span class="mpre">newBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Some nice rules for Builder</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- This function makes GHC understand that &#39;writeN&#39; and &#39;ensureFree&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- are *not* recursive in the precense of the rewrite rules below.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This is not needed with GHC 7+.</span></span><span class="mpre">
</span><a href="#loc_301_1_301_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_1_301_8&#39;)"><span class="mpre">append&#39;</span></a><span class="mpre"> :: </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_86_9_86_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_301_1_301_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_1_301_8&#39;)"><span class="hl_fundecl"><span class="mpre">append&#39;</span></span></a><span class="mpre"> (</span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><a name="loc_301_18_301_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_18_301_19&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre">) (</span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><a name="loc_301_30_301_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_30_301_31&#39;)"><span class="hl_vardecl"><span class="mpre">g</span></span></a><span class="mpre">) = </span><a href="#loc_86_19_86_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_19_86_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> (</span><a href="#loc_301_18_301_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_18_301_19&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_301_30_301_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_30_301_31&#39;)"><span class="hl_varref"><span class="mpre">g</span></span></a><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_301_1_301_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_1_301_8&#39;)"><span class="mpre">append&#39;</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_pragma"><span class="mpre">{-# RULES

&quot;append/writeAtMost&quot; forall a b (f::forall s. A.MArray s -&gt; Int -&gt; ST s Int)
                           (g::forall s. A.MArray s -&gt; Int -&gt; ST s Int) ws.
    append (writeAtMost a f) (append (writeAtMost b g) ws) =
        append (writeAtMost (a+b) (\marr o -&gt; f marr o &gt;&gt;= \ n -&gt;
                                    g marr (o+n) &gt;&gt;= \ m -&gt;
                                    let s = n+m in s `seq` return s)) ws

&quot;writeAtMost/writeAtMost&quot; forall a b (f::forall s. A.MArray s -&gt; Int -&gt; ST s Int)
                           (g::forall s. A.MArray s -&gt; Int -&gt; ST s Int).
    append (writeAtMost a f) (writeAtMost b g) =
        writeAtMost (a+b) (\marr o -&gt; f marr o &gt;&gt;= \ n -&gt;
                            g marr (o+n) &gt;&gt;= \ m -&gt;
                            let s = n+m in s `seq` return s)

&quot;ensureFree/ensureFree&quot; forall a b .
    append (ensureFree a) (ensureFree b) = ensureFree (max a b)

&quot;flush/flush&quot;
    append flush flush = flush

 #-}</span></span><span class="mpre">
</span></div></body></html>