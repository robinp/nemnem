<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE Trustworthy #-}
{-# LANGUAGE NoImplicitPrelude #-}

</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      :  GHC.IO.Encoding.Failure</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   :  (c) The University of Glasgow, 2008-2011</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     :  see libraries/base/LICENSE</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- </span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  :  libraries@haskell.org</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   :  internal</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability :  non-portable</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Types for specifying how text encoding/decoding fails</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-----------------------------------------------------------------------------</span></span><span class="mpre">

module GHC.IO.Encoding.Failure (
    CodingFailureMode(..), codingFailureModeSuffix,
    isSurrogate,
    recoverDecode, recoverEncode
  ) where

import GHC.IO
import GHC.IO.Buffer
import GHC.IO.Exception

import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 28, srcSpanStartColumn = 8, srcSpanEndLine = 28, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Base&quot;"><span class="mpre">GHC.Base</span></span><span class="mpre">
import GHC.Char
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 30, srcSpanStartColumn = 8, srcSpanEndLine = 30, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Word&quot;"><span class="mpre">GHC.Word</span></span><span class="mpre">
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 31, srcSpanStartColumn = 8, srcSpanEndLine = 31, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Show&quot;"><span class="mpre">GHC.Show</span></span><span class="mpre">
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 32, srcSpanStartColumn = 8, srcSpanEndLine = 32, srcSpanEndColumn = 15}, srcInfoPoints = []}) &quot;GHC.Num&quot;"><span class="mpre">GHC.Num</span></span><span class="mpre">
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 33, srcSpanStartColumn = 8, srcSpanEndLine = 33, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Real&quot;"><span class="mpre">GHC.Real</span></span><span class="mpre"> ( fromIntegral )

</span><span class="hl_comment"><span class="mpre">--import System.Posix.Internals</span></span><span class="mpre">

import Data.Maybe


</span><span class="hl_comment"><span class="mpre">-- | The &#39;CodingFailureMode&#39; is used to construct &#39;TextEncoding&#39;s, and</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- specifies how they handle illegal sequences.</span></span><span class="mpre">
data </span><a name="loc_42_6_42_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_6_42_23&#39;)"><span class="hl_tycondecl"><span class="mpre">CodingFailureMode</span></span></a><span class="mpre">
  = </span><a name="loc_43_5_43_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_43_5_43_25&#39;)"><span class="hl_condecl"><span class="mpre">ErrorOnCodingFailure</span></span></a><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- ^ Throw an error when an illegal sequence is encountered</span></span><span class="mpre">
  | </span><a name="loc_45_5_45_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_5_45_24&#39;)"><span class="hl_condecl"><span class="mpre">IgnoreCodingFailure</span></span></a><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- ^ Attempt to ignore and recover if an illegal sequence is</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- encountered</span></span><span class="mpre">
  | </span><a name="loc_48_5_48_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_5_48_31&#39;)"><span class="hl_condecl"><span class="mpre">TransliterateCodingFailure</span></span></a><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- ^ Replace with the closest visual match upon an illegal</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- sequence</span></span><span class="mpre">
  | </span><a name="loc_51_5_51_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_5_51_21&#39;)"><span class="hl_condecl"><span class="mpre">RoundtripFailure</span></span></a><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- ^ Use the private-use escape mechanism to attempt to allow</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- illegal sequences to be roundtripped.</span></span><span class="mpre">
  </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 54, srcSpanStartColumn = 3, srcSpanEndLine = 54, srcSpanEndColumn = 18}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 54, srcSpanStartColumn = 3, srcSpanEndLine = 54, srcSpanEndColumn = 11},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSp"><span class="mpre">deriving (Show)</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- This will only work properly for those encodings which are</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- strict supersets of ASCII in the sense that valid ASCII data</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- is also valid in that encoding. This is not true for</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- e.g. UTF-16, because ASCII characters must be padded to two</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- bytes to retain their meaning.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Note [Roundtripping]</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ~~~~~~~~~~~~~~~~~~~~</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Roundtripping is based on the ideas of PEP383.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- We used to use the range of private-use characters from 0xEF80 to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- 0xEFFF designated for &quot;encoding hacks&quot; by the ConScript Unicode Registery</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to encode these characters.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- However, people didn&#39;t like this because it means we don&#39;t get</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- guaranteed roundtripping for byte sequences that look like a UTF-8</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- encoded codepoint 0xEFxx.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- So now like PEP383 we use lone surrogate codepoints 0xDCxx to escape</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- undecodable bytes, even though that may confuse Unicode processing</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- software written in Haskell. This guarantees roundtripping because</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- unicode input that includes lone surrogate codepoints is invalid by</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- definition.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- When we used private-use characters there was a technical problem when it</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- came to encoding back to bytes using iconv. The iconv code will not fail when</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- it tries to encode a private-use character (as it would if trying to encode</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- a surrogate), which means that we won&#39;t get a chance to replace it</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- with the byte we originally escaped.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- To work around this, when filling the buffer to be encoded (in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- writeBlocks/withEncodedCString/newEncodedCString), we replaced the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- private-use characters with lone surrogates again! Likewise, when</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- reading from a buffer (unpack/unpack_nl/peekEncodedCString) we have</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to do the inverse process.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The user of String would never see these lone surrogates, but it</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ensures that iconv will throw an error when encountering them.  We</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- use lone surrogates in the range 0xDC00 to 0xDCFF for this purpose.</span></span><span class="mpre">

</span><a href="#loc_97_1_97_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_1_97_24&#39;)"><span class="mpre">codingFailureModeSuffix</span></a><span class="mpre"> :: </span><a href="#loc_42_6_42_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_6_42_23&#39;)"><span class="hl_tyconref"><span class="mpre">CodingFailureMode</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">
</span><a name="loc_97_1_97_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_1_97_24&#39;)"><span class="hl_fundecl"><span class="mpre">codingFailureModeSuffix</span></span></a><span class="mpre"> </span><a href="#loc_43_5_43_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_43_5_43_25&#39;)"><span class="hl_conref"><span class="mpre">ErrorOnCodingFailure</span></span></a><span class="mpre">       = </span><span class="hl_string"><span class="mpre">&quot;&quot;</span></span><span class="mpre">
</span><a href="#loc_97_1_97_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_1_97_24&#39;)"><span class="hl_fundecl"><span class="mpre">codingFailureModeSuffix</span></span></a><span class="mpre"> </span><a href="#loc_45_5_45_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_5_45_24&#39;)"><span class="hl_conref"><span class="mpre">IgnoreCodingFailure</span></span></a><span class="mpre">        = </span><span class="hl_string"><span class="mpre">&quot;//IGNORE&quot;</span></span><span class="mpre">
</span><a href="#loc_97_1_97_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_1_97_24&#39;)"><span class="hl_fundecl"><span class="mpre">codingFailureModeSuffix</span></span></a><span class="mpre"> </span><a href="#loc_48_5_48_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_5_48_31&#39;)"><span class="hl_conref"><span class="mpre">TransliterateCodingFailure</span></span></a><span class="mpre"> = </span><span class="hl_string"><span class="mpre">&quot;//TRANSLIT&quot;</span></span><span class="mpre">
</span><a href="#loc_97_1_97_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_97_1_97_24&#39;)"><span class="hl_fundecl"><span class="mpre">codingFailureModeSuffix</span></span></a><span class="mpre"> </span><a href="#loc_51_5_51_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_5_51_21&#39;)"><span class="hl_conref"><span class="mpre">RoundtripFailure</span></span></a><span class="mpre">           = </span><span class="hl_string"><span class="mpre">&quot;//ROUNDTRIP&quot;</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | In transliterate mode, we use this character when decoding</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- unknown bytes.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This is the defined Unicode replacement character:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &lt;http://www.fileformat.info/info/unicode/char/0fffd/index.htm&gt;</span></span><span class="mpre">
</span><a href="#loc_108_1_108_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_108_1_108_20&#39;)"><span class="mpre">unrepresentableChar</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">
</span><a name="loc_108_1_108_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_108_1_108_20&#39;)"><span class="hl_vardecl"><span class="mpre">unrepresentableChar</span></span></a><span class="mpre"> = </span><span class="hl_char"><span class="mpre">&#39;\xFFFD&#39;</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- It is extraordinarily important that this series of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- predicates/transformers gets inlined, because they tend to be used</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- in inner loops related to text encoding. In particular,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- surrogatifyRoundtripCharacter must be inlined (see #5536)</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Some characters are actually &quot;surrogate&quot; codepoints defined for</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- use in UTF-16. We need to signal an invalid character if we detect</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- them when encoding a sequence of &#39;Char&#39;s into &#39;Word8&#39;s because they</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- won&#39;t give valid Unicode.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- We may also need to signal an invalid character if we detect them</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- when encoding a sequence of &#39;Char&#39;s into &#39;Word8&#39;s because the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;RoundtripFailure&#39; mode creates these to round-trip bytes through</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- our internal UTF-16 encoding.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_126_1_126_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_1_126_12&#39;)"><span class="mpre">isSurrogate</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_126_1_126_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_1_126_12&#39;)"><span class="mpre">isSurrogate</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
</span><a name="loc_126_1_126_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_1_126_12&#39;)"><span class="hl_fundecl"><span class="mpre">isSurrogate</span></span></a><span class="mpre"> </span><a name="loc_126_13_126_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_13_126_14&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre"> = (</span><span class="hl_num"><span class="mpre">0xD800</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_128_9_128_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_128_9_128_10&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_128_9_128_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_128_9_128_10&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xDBFF</span></span><span class="mpre">)
             </span><span class="hl_infix"><span class="mpre">||</span></span><span class="mpre"> (</span><span class="hl_num"><span class="mpre">0xDC00</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_128_9_128_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_128_9_128_10&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_128_9_128_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_128_9_128_10&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xDFFF</span></span><span class="mpre">)
  where </span><a name="loc_128_9_128_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_128_9_128_10&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">ord</span></span><span class="mpre"> </span><a href="#loc_126_13_126_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_13_126_14&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Bytes (in Buffer Word8) --&gt; lone surrogates (in Buffer CharBufElem)</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_133_1_133_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_1_133_36&#39;)"><span class="mpre">escapeToRoundtripCharacterSurrogate</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_133_1_133_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_1_133_36&#39;)"><span class="mpre">escapeToRoundtripCharacterSurrogate</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">
</span><a name="loc_133_1_133_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_1_133_36&#39;)"><span class="hl_fundecl"><span class="mpre">escapeToRoundtripCharacterSurrogate</span></span></a><span class="mpre"> </span><a name="loc_133_37_133_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_37_133_38&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">
  | </span><a href="#loc_133_37_133_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_37_133_38&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">128</span></span><span class="mpre">   = </span><a href="GHC.Char.html#loc_11_1_11_4" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Char.html#loc_11_1_11_4&#39;)"><span class="hl_varref"><span class="mpre">chr</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_133_37_133_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_37_133_38&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">)
      </span><span class="hl_comment"><span class="mpre">-- Disallow &#39;smuggling&#39; of ASCII bytes. For roundtripping to</span></span><span class="mpre">
      </span><span class="hl_comment"><span class="mpre">-- work, this assumes encoding is ASCII-superset.</span></span><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = </span><a href="GHC.Char.html#loc_11_1_11_4" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Char.html#loc_11_1_11_4&#39;)"><span class="hl_varref"><span class="mpre">chr</span></span></a><span class="mpre"> (</span><span class="hl_num"><span class="mpre">0xDC00</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_133_37_133_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_37_133_38&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- Lone surrogates (in Buffer CharBufElem) --&gt; bytes (in Buffer Word8)</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_142_1_142_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_1_142_36&#39;)"><span class="mpre">unescapeRoundtripCharacterSurrogate</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_142_1_142_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_1_142_36&#39;)"><span class="mpre">unescapeRoundtripCharacterSurrogate</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre"> -&gt; </span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="hl_tyconref"><span class="mpre">Maybe</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">
</span><a name="loc_142_1_142_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_1_142_36&#39;)"><span class="hl_fundecl"><span class="mpre">unescapeRoundtripCharacterSurrogate</span></span></a><span class="mpre"> </span><a name="loc_142_37_142_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_37_142_38&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre">
    | </span><span class="hl_num"><span class="mpre">0xDC80</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_145_9_145_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_9_145_10&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_145_9_145_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_9_145_10&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xDD00</span></span><span class="mpre"> = </span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_145_9_145_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_9_145_10&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">) </span><span class="hl_comment"><span class="mpre">-- Discard high byte</span></span><span class="mpre">
    | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                 = </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre">
  where </span><a name="loc_145_9_145_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_9_145_10&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">ord</span></span><span class="mpre"> </span><a href="#loc_142_37_142_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_37_142_38&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre">

</span><a href="#loc_149_1_149_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_1_149_14&#39;)"><span class="mpre">recoverDecode</span></a><span class="mpre"> :: </span><a href="#loc_42_6_42_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_6_42_23&#39;)"><span class="hl_tyconref"><span class="mpre">CodingFailureMode</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.IO.Buffer.html#loc_180_6_180_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_180_6_180_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre"> -&gt; </span><a href="GHC.IO.Buffer.html#loc_180_6_180_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_180_6_180_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">
              -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="GHC.IO.Buffer.html#loc_180_6_180_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_180_6_180_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">, </span><a href="GHC.IO.Buffer.html#loc_180_6_180_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_180_6_180_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">)
</span><a name="loc_149_1_149_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_1_149_14&#39;)"><span class="hl_fundecl"><span class="mpre">recoverDecode</span></span></a><span class="mpre"> </span><a name="loc_149_15_149_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_15_149_18&#39;)"><span class="hl_vardecl"><span class="mpre">cfm</span></span></a><span class="mpre"> </span><span class="hl_specname"><span class="mpre">input</span></span><span class="mpre">@</span><span class="warning" data-warning="PatPRec (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 149, srcSpanStartColumn = 25, srcSpanEndLine = 149, srcSpanEndColumn = 65}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 149, srcSpanStartColumn = 31, srcSpanEndLine = 149, srcSpanEndColumn = 32},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, src"><span class="mpre">Buffer{  bufRaw=iraw, bufL=ir, bufR=_  }</span></span><span class="mpre">
                  </span><a name="loc_150_19_150_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_19_150_25&#39;)"><span class="hl_specname"><span class="mpre">output</span></span></a><span class="mpre">@</span><span class="warning" data-warning="PatPRec (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 150, srcSpanStartColumn = 26, srcSpanEndLine = 150, srcSpanEndColumn = 65}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 150, srcSpanStartColumn = 32, srcSpanEndLine = 150, srcSpanEndColumn = 33},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, src"><span class="mpre">Buffer{ bufRaw=oraw, bufL=_,  bufR=ow }</span></span><span class="mpre"> = do
 </span><span class="hl_comment"><span class="mpre">--puts $ &quot;recoverDecode &quot; ++ show ir</span></span><span class="mpre">
 case </span><a href="#loc_149_15_149_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_15_149_18&#39;)"><span class="hl_varref"><span class="mpre">cfm</span></span></a><span class="mpre"> of
  </span><a href="#loc_43_5_43_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_43_5_43_25&#39;)"><span class="hl_conref"><span class="mpre">ErrorOnCodingFailure</span></span></a><span class="mpre">       -&gt; </span><a href="#loc_197_1_197_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_197_1_197_18&#39;)"><span class="hl_varref"><span class="mpre">ioe_decodingError</span></span></a><span class="mpre">
  </span><a href="#loc_45_5_45_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_5_45_24&#39;)"><span class="hl_conref"><span class="mpre">IgnoreCodingFailure</span></span></a><span class="mpre">        -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 154, srcSpanStartColumn = 41, srcSpanEndLine = 154, srcSpanEndColumn = 60}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 154, srcSpanStartColumn = 47, srcSpanEndLine = 154, srcSpanEndColumn = 48},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;"><span class="mpre">input { bufL=ir+1 }</span></span><span class="mpre">, </span><a href="#loc_150_19_150_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_19_150_25&#39;)"><span class="hl_varref"><span class="mpre">output</span></span></a><span class="mpre">)
  </span><a href="#loc_48_5_48_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_5_48_31&#39;)"><span class="hl_conref"><span class="mpre">TransliterateCodingFailure</span></span></a><span class="mpre"> -&gt; do
      </span><span class="hl_vardecl"><span class="mpre">ow&#39;</span></span><span class="mpre"> &lt;- </span><a href="GHC.IO.Buffer.html#loc_123_1_123_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_123_1_123_13&#39;)"><span class="hl_varref"><span class="mpre">writeCharBuf</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">oraw</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">ow</span></span><span class="mpre"> </span><a href="#loc_108_1_108_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_108_1_108_20&#39;)"><span class="hl_varref"><span class="mpre">unrepresentableChar</span></span></a><span class="mpre">
      </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 157, srcSpanStartColumn = 15, srcSpanEndLine = 157, srcSpanEndColumn = 34}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 157, srcSpanStartColumn = 21, srcSpanEndLine = 157, srcSpanEndColumn = 22},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;"><span class="mpre">input { bufL=ir+1 }</span></span><span class="mpre">, </span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 157, srcSpanStartColumn = 36, srcSpanEndLine = 157, srcSpanEndColumn = 55}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 157, srcSpanStartColumn = 43, srcSpanEndLine = 157, srcSpanEndColumn = 44},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;"><span class="mpre">output { bufR=ow&#39; }</span></span><span class="mpre">)
  </span><a href="#loc_51_5_51_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_5_51_21&#39;)"><span class="hl_conref"><span class="mpre">RoundtripFailure</span></span></a><span class="mpre">           -&gt; do
      </span><a name="loc_159_7_159_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_7_159_8&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IO.Buffer.html#loc_99_1_99_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_99_1_99_13&#39;)"><span class="hl_varref"><span class="mpre">readWord8Buf</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">iraw</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">ir</span></span><span class="mpre">
      </span><span class="hl_vardecl"><span class="mpre">ow&#39;</span></span><span class="mpre"> &lt;- </span><a href="GHC.IO.Buffer.html#loc_123_1_123_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_123_1_123_13&#39;)"><span class="hl_varref"><span class="mpre">writeCharBuf</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">oraw</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">ow</span></span><span class="mpre"> (</span><a href="#loc_133_1_133_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_1_133_36&#39;)"><span class="hl_varref"><span class="mpre">escapeToRoundtripCharacterSurrogate</span></span></a><span class="mpre"> </span><a href="#loc_159_7_159_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_7_159_8&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">)
      </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 161, srcSpanStartColumn = 15, srcSpanEndLine = 161, srcSpanEndColumn = 34}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 161, srcSpanStartColumn = 21, srcSpanEndLine = 161, srcSpanEndColumn = 22},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;"><span class="mpre">input { bufL=ir+1 }</span></span><span class="mpre">, </span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 161, srcSpanStartColumn = 36, srcSpanEndLine = 161, srcSpanEndColumn = 55}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 161, srcSpanStartColumn = 43, srcSpanEndLine = 161, srcSpanEndColumn = 44},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;"><span class="mpre">output { bufR=ow&#39; }</span></span><span class="mpre">)

</span><a href="#loc_165_1_165_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_1_165_14&#39;)"><span class="mpre">recoverEncode</span></a><span class="mpre"> :: </span><a href="#loc_42_6_42_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_6_42_23&#39;)"><span class="hl_tyconref"><span class="mpre">CodingFailureMode</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.IO.Buffer.html#loc_180_6_180_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_180_6_180_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre"> -&gt; </span><a href="GHC.IO.Buffer.html#loc_180_6_180_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_180_6_180_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">
              -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="GHC.IO.Buffer.html#loc_180_6_180_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_180_6_180_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">, </span><a href="GHC.IO.Buffer.html#loc_180_6_180_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_180_6_180_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)
</span><a name="loc_165_1_165_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_1_165_14&#39;)"><span class="hl_fundecl"><span class="mpre">recoverEncode</span></span></a><span class="mpre"> </span><a name="loc_165_15_165_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_15_165_18&#39;)"><span class="hl_vardecl"><span class="mpre">cfm</span></span></a><span class="mpre"> </span><a name="loc_165_19_165_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_19_165_24&#39;)"><span class="hl_specname"><span class="mpre">input</span></span></a><span class="mpre">@</span><span class="warning" data-warning="PatPRec (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 165, srcSpanStartColumn = 25, srcSpanEndLine = 165, srcSpanEndColumn = 65}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 165, srcSpanStartColumn = 31, srcSpanEndLine = 165, srcSpanEndColumn = 32},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, src"><span class="mpre">Buffer{  bufRaw=iraw, bufL=ir, bufR=_  }</span></span><span class="mpre">
                  </span><a name="loc_166_19_166_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_19_166_25&#39;)"><span class="hl_specname"><span class="mpre">output</span></span></a><span class="mpre">@</span><span class="warning" data-warning="PatPRec (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 166, srcSpanStartColumn = 26, srcSpanEndLine = 166, srcSpanEndColumn = 65}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 166, srcSpanStartColumn = 32, srcSpanEndLine = 166, srcSpanEndColumn = 33},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, src"><span class="mpre">Buffer{ bufRaw=oraw, bufL=_,  bufR=ow }</span></span><span class="mpre"> = do
  (</span><a name="loc_167_4_167_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_4_167_5&#39;)"><span class="hl_vardecl"><span class="mpre">c</span></span></a><span class="mpre">,</span><span class="hl_vardecl"><span class="mpre">ir&#39;</span></span><span class="mpre">) &lt;- </span><a href="GHC.IO.Buffer.html#loc_119_1_119_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_119_1_119_12&#39;)"><span class="hl_varref"><span class="mpre">readCharBuf</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">iraw</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">ir</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">--puts $ &quot;recoverEncode &quot; ++ show ir ++ &quot; &quot; ++ show ir&#39;</span></span><span class="mpre">
  case </span><a href="#loc_165_15_165_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_15_165_18&#39;)"><span class="hl_varref"><span class="mpre">cfm</span></span></a><span class="mpre"> of
    </span><a href="#loc_45_5_45_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_5_45_24&#39;)"><span class="hl_conref"><span class="mpre">IgnoreCodingFailure</span></span></a><span class="mpre">        -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 170, srcSpanStartColumn = 43, srcSpanEndLine = 170, srcSpanEndColumn = 61}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 170, srcSpanStartColumn = 49, srcSpanEndLine = 170, srcSpanEndColumn = 50},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;"><span class="mpre">input { bufL=ir&#39; }</span></span><span class="mpre">, </span><a href="#loc_166_19_166_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_19_166_25&#39;)"><span class="hl_varref"><span class="mpre">output</span></span></a><span class="mpre">)
    </span><a href="#loc_48_5_48_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_5_48_31&#39;)"><span class="hl_conref"><span class="mpre">TransliterateCodingFailure</span></span></a><span class="mpre"> -&gt; do
        if </span><a href="#loc_167_4_167_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_4_167_5&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_char"><span class="mpre">&#39;?&#39;</span></span><span class="mpre">
         then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 173, srcSpanStartColumn = 23, srcSpanEndLine = 173, srcSpanEndColumn = 41}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 173, srcSpanStartColumn = 29, srcSpanEndLine = 173, srcSpanEndColumn = 30},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;"><span class="mpre">input { bufL=ir&#39; }</span></span><span class="mpre">, </span><a href="#loc_166_19_166_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_19_166_25&#39;)"><span class="hl_varref"><span class="mpre">output</span></span></a><span class="mpre">)
         else do
          </span><span class="hl_comment"><span class="mpre">-- XXX: evil hack! To implement transliteration, we just</span></span><span class="mpre">
          </span><span class="hl_comment"><span class="mpre">-- poke an ASCII ? into the input buffer and tell the caller</span></span><span class="mpre">
          </span><span class="hl_comment"><span class="mpre">-- to try and decode again. This is *probably* safe given</span></span><span class="mpre">
          </span><span class="hl_comment"><span class="mpre">-- current uses of TextEncoding.</span></span><span class="mpre">
          </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
          </span><span class="hl_comment"><span class="mpre">-- The &quot;if&quot; test above ensures we skip if the encoding fails</span></span><span class="mpre">
          </span><span class="hl_comment"><span class="mpre">-- to deal with the ?, though this should never happen in</span></span><span class="mpre">
          </span><span class="hl_comment"><span class="mpre">-- practice as all encodings are in fact capable of</span></span><span class="mpre">
          </span><span class="hl_comment"><span class="mpre">-- reperesenting all ASCII characters.</span></span><span class="mpre">
          </span><span class="hl_vardecl"><span class="mpre">_ir&#39;</span></span><span class="mpre"> &lt;- </span><a href="GHC.IO.Buffer.html#loc_123_1_123_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_123_1_123_13&#39;)"><span class="hl_varref"><span class="mpre">writeCharBuf</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">iraw</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">ir</span></span><span class="mpre"> </span><span class="hl_char"><span class="mpre">&#39;?&#39;</span></span><span class="mpre">
          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_165_19_165_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_19_165_24&#39;)"><span class="hl_varref"><span class="mpre">input</span></span></a><span class="mpre">, </span><a href="#loc_166_19_166_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_19_166_25&#39;)"><span class="hl_varref"><span class="mpre">output</span></span></a><span class="mpre">)
        
        </span><span class="hl_comment"><span class="mpre">-- This implementation does not work because e.g. UTF-16</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- requires 2 bytes to encode a simple ASCII value</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--writeWord8Buf oraw ow unrepresentableByte</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--return (input { bufL=ir&#39; }, output { bufR=ow+1 })</span></span><span class="mpre">
    </span><a href="#loc_51_5_51_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_5_51_21&#39;)"><span class="hl_conref"><span class="mpre">RoundtripFailure</span></span></a><span class="mpre"> | </span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> </span><a name="loc_191_29_191_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_29_191_30&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_142_1_142_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_1_142_36&#39;)"><span class="hl_varref"><span class="mpre">unescapeRoundtripCharacterSurrogate</span></span></a><span class="mpre"> </span><a href="#loc_167_4_167_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_4_167_5&#39;)"><span class="hl_varref"><span class="mpre">c</span></span></a><span class="mpre"> -&gt; do
        </span><a href="GHC.IO.Buffer.html#loc_102_1_102_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_102_1_102_14&#39;)"><span class="hl_varref"><span class="mpre">writeWord8Buf</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">oraw</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">ow</span></span><span class="mpre"> </span><a href="#loc_191_29_191_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_29_191_30&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 193, srcSpanStartColumn = 17, srcSpanEndLine = 193, srcSpanEndColumn = 35}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 193, srcSpanStartColumn = 23, srcSpanEndLine = 193, srcSpanEndColumn = 24},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;"><span class="mpre">input { bufL=ir&#39; }</span></span><span class="mpre">, </span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 193, srcSpanStartColumn = 37, srcSpanEndLine = 193, srcSpanEndColumn = 57}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;, srcSpanStartLine = 193, srcSpanStartColumn = 44, srcSpanEndLine = 193, srcSpanEndColumn = 45},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/IO/Encoding/Failure.hs&quot;"><span class="mpre">output { bufR=ow+1 }</span></span><span class="mpre">)
    _                          -&gt; </span><a href="#loc_202_1_202_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_202_1_202_18&#39;)"><span class="hl_varref"><span class="mpre">ioe_encodingError</span></span></a><span class="mpre">

</span><a href="#loc_197_1_197_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_197_1_197_18&#39;)"><span class="mpre">ioe_decodingError</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_197_1_197_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_197_1_197_18&#39;)"><span class="hl_vardecl"><span class="mpre">ioe_decodingError</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Exception.html#loc_217_1_217_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Exception.html#loc_217_1_217_12&#39;)"><span class="hl_varref"><span class="mpre">ioException</span></span></a><span class="mpre">
    (</span><span class="hl_conref"><span class="mpre">IOError</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre"> </span><a href="GHC.IO.Exception.html#loc_272_5_272_20" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Exception.html#loc_272_5_272_20&#39;)"><span class="hl_conref"><span class="mpre">InvalidArgument</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;recoverDecode&quot;</span></span><span class="mpre">
        </span><span class="hl_string"><span class="mpre">&quot;invalid byte sequence&quot;</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre">)

</span><a href="#loc_202_1_202_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_202_1_202_18&#39;)"><span class="mpre">ioe_encodingError</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_202_1_202_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_202_1_202_18&#39;)"><span class="hl_vardecl"><span class="mpre">ioe_encodingError</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Exception.html#loc_217_1_217_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Exception.html#loc_217_1_217_12&#39;)"><span class="hl_varref"><span class="mpre">ioException</span></span></a><span class="mpre">
    (</span><span class="hl_conref"><span class="mpre">IOError</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre"> </span><a href="GHC.IO.Exception.html#loc_272_5_272_20" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Exception.html#loc_272_5_272_20&#39;)"><span class="hl_conref"><span class="mpre">InvalidArgument</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;recoverEncode&quot;</span></span><span class="mpre">
        </span><span class="hl_string"><span class="mpre">&quot;invalid character&quot;</span></span><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre"> </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre">)

</span></div></body></html>