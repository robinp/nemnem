<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : Network.TLS.Record.Engage</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD-style</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Vincent Hanquez &lt;vincent@snarc.org&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : unknown</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Engage a record into the Record layer.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The record is compressed, added some integrity field, then encrypted.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Network.TLS.Record.Engage
        ( engageRecord
        ) where

import Control.Monad.State

import Network.TLS.Cap
import Network.TLS.Record.State
import Network.TLS.Record.Types
import Network.TLS.Cipher
import Network.TLS.Compression
import Network.TLS.Util
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Record/Engage.hs&quot;, srcSpanStartLine = 23, srcSpanStartColumn = 8, srcSpanEndLine = 23, srcSpanEndColumn = 23}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre"> (ByteString)
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Record/Engage.hs&quot;, srcSpanStartLine = 24, srcSpanStartColumn = 18, srcSpanEndLine = 24, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre"> as B

</span><a href="#loc_27_1_27_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_27_1_27_13&#39;)"><span class="mpre">engageRecord</span></a><span class="mpre"> :: </span><a href="Network.TLS.Record.Types.html#loc_47_6_47_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_47_6_47_12&#39;)"><span class="hl_tyconref"><span class="mpre">Record</span></span></a><span class="mpre"> </span><a href="Network.TLS.Record.Types.html#loc_51_6_51_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_51_6_51_15&#39;)"><span class="hl_tyconref"><span class="mpre">Plaintext</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Record.State.html#loc_57_9_57_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_57_9_57_16&#39;)"><span class="hl_tyconref"><span class="mpre">RecordM</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Record.Types.html#loc_47_6_47_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_47_6_47_12&#39;)"><span class="hl_tyconref"><span class="mpre">Record</span></span></a><span class="mpre"> </span><a href="Network.TLS.Record.Types.html#loc_53_6_53_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_53_6_53_16&#39;)"><span class="hl_tyconref"><span class="mpre">Ciphertext</span></span></a><span class="mpre">)
</span><a name="loc_27_1_27_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_27_1_27_13&#39;)"><span class="hl_vardecl"><span class="mpre">engageRecord</span></span></a><span class="mpre"> = </span><a href="#loc_30_1_30_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_1_30_15&#39;)"><span class="hl_varref"><span class="mpre">compressRecord</span></span></a><span class="mpre"> </span><a href="Control.Monad.html#loc_180_3_180_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_180_3_180_6&#39;)"><span class="hl_infix"><span class="mpre">&gt;=&gt;</span></span></a><span class="mpre"> </span><a href="#loc_39_1_39_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_1_39_14&#39;)"><span class="hl_varref"><span class="mpre">encryptRecord</span></span></a><span class="mpre">

</span><a href="#loc_30_1_30_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_1_30_15&#39;)"><span class="mpre">compressRecord</span></a><span class="mpre"> :: </span><a href="Network.TLS.Record.Types.html#loc_47_6_47_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_47_6_47_12&#39;)"><span class="hl_tyconref"><span class="mpre">Record</span></span></a><span class="mpre"> </span><a href="Network.TLS.Record.Types.html#loc_51_6_51_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_51_6_51_15&#39;)"><span class="hl_tyconref"><span class="mpre">Plaintext</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Record.State.html#loc_57_9_57_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_57_9_57_16&#39;)"><span class="hl_tyconref"><span class="mpre">RecordM</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Record.Types.html#loc_47_6_47_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_47_6_47_12&#39;)"><span class="hl_tyconref"><span class="mpre">Record</span></span></a><span class="mpre"> </span><a href="Network.TLS.Record.Types.html#loc_52_6_52_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_52_6_52_16&#39;)"><span class="hl_tyconref"><span class="mpre">Compressed</span></span></a><span class="mpre">)
</span><a name="loc_30_1_30_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_1_30_15&#39;)"><span class="hl_fundecl"><span class="mpre">compressRecord</span></span></a><span class="mpre"> </span><a name="loc_30_16_30_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_16_30_22&#39;)"><span class="hl_vardecl"><span class="mpre">record</span></span></a><span class="mpre"> =
    </span><a href="Network.TLS.Record.Types.html#loc_65_1_65_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_65_1_65_17&#39;)"><span class="hl_varref"><span class="mpre">onRecordFragment</span></span></a><span class="mpre"> </span><a href="#loc_30_16_30_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_16_30_22&#39;)"><span class="hl_varref"><span class="mpre">record</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Record.Types.html#loc_72_1_72_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_72_1_72_17&#39;)"><span class="hl_varref"><span class="mpre">fragmentCompress</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_31_51_31_56" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_31_51_31_56&#39;)"><span class="hl_vardecl"><span class="mpre">bytes</span></span></a><span class="mpre"> -&gt; do
        </span><a href="Network.TLS.Record.State.html#loc_111_1_111_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_111_1_111_16&#39;)"><span class="hl_varref"><span class="mpre">withCompression</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Compression.html#loc_47_1_47_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Compression.html#loc_47_1_47_19&#39;)"><span class="hl_varref"><span class="mpre">compressionDeflate</span></span></a><span class="mpre"> </span><a href="#loc_31_51_31_56" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_31_51_31_56&#39;)"><span class="hl_varref"><span class="mpre">bytes</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">{-
 - when Tx Encrypted is set, we pass the data through encryptContent, otherwise
 - we just return the packet
 -}</span></span><span class="mpre">
</span><a href="#loc_39_1_39_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_1_39_14&#39;)"><span class="mpre">encryptRecord</span></a><span class="mpre"> :: </span><a href="Network.TLS.Record.Types.html#loc_47_6_47_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_47_6_47_12&#39;)"><span class="hl_tyconref"><span class="mpre">Record</span></span></a><span class="mpre"> </span><a href="Network.TLS.Record.Types.html#loc_52_6_52_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_52_6_52_16&#39;)"><span class="hl_tyconref"><span class="mpre">Compressed</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Record.State.html#loc_57_9_57_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_57_9_57_16&#39;)"><span class="hl_tyconref"><span class="mpre">RecordM</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Record.Types.html#loc_47_6_47_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_47_6_47_12&#39;)"><span class="hl_tyconref"><span class="mpre">Record</span></span></a><span class="mpre"> </span><a href="Network.TLS.Record.Types.html#loc_53_6_53_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_53_6_53_16&#39;)"><span class="hl_tyconref"><span class="mpre">Ciphertext</span></span></a><span class="mpre">)
</span><a name="loc_39_1_39_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_1_39_14&#39;)"><span class="hl_fundecl"><span class="mpre">encryptRecord</span></span></a><span class="mpre"> </span><a name="loc_39_15_39_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_15_39_21&#39;)"><span class="hl_vardecl"><span class="mpre">record</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Record.Types.html#loc_65_1_65_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_65_1_65_17&#39;)"><span class="hl_varref"><span class="mpre">onRecordFragment</span></span></a><span class="mpre"> </span><a href="#loc_39_15_39_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_15_39_21&#39;)"><span class="hl_varref"><span class="mpre">record</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Record.Types.html#loc_76_1_76_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_76_1_76_15&#39;)"><span class="hl_varref"><span class="mpre">fragmentCipher</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_39_68_39_73" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_68_39_73&#39;)"><span class="hl_vardecl"><span class="mpre">bytes</span></span></a><span class="mpre"> -&gt; do
    </span><a name="loc_40_5_40_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_40_5_40_7&#39;)"><span class="hl_vardecl"><span class="mpre">st</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">get</span></span><span class="mpre">
    case </span><a href="Network.TLS.Record.State.html#loc_51_7_51_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_51_7_51_15&#39;)"><span class="hl_varref"><span class="mpre">stCipher</span></span></a><span class="mpre"> </span><a href="#loc_40_5_40_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_40_5_40_7&#39;)"><span class="hl_varref"><span class="mpre">st</span></span></a><span class="mpre"> of
        </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_39_68_39_73" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_68_39_73&#39;)"><span class="hl_varref"><span class="mpre">bytes</span></span></a><span class="mpre">
        _       -&gt; </span><a href="#loc_46_1_46_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_15&#39;)"><span class="hl_varref"><span class="mpre">encryptContent</span></span></a><span class="mpre"> </span><a href="#loc_39_15_39_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_15_39_21&#39;)"><span class="hl_varref"><span class="mpre">record</span></span></a><span class="mpre"> </span><a href="#loc_39_68_39_73" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_68_39_73&#39;)"><span class="hl_varref"><span class="mpre">bytes</span></span></a><span class="mpre">

</span><a href="#loc_46_1_46_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_15&#39;)"><span class="mpre">encryptContent</span></a><span class="mpre"> :: </span><a href="Network.TLS.Record.Types.html#loc_47_6_47_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_47_6_47_12&#39;)"><span class="hl_tyconref"><span class="mpre">Record</span></span></a><span class="mpre"> </span><a href="Network.TLS.Record.Types.html#loc_52_6_52_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_52_6_52_16&#39;)"><span class="hl_tyconref"><span class="mpre">Compressed</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre"> -&gt; </span><a href="Network.TLS.Record.State.html#loc_57_9_57_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_57_9_57_16&#39;)"><span class="hl_tyconref"><span class="mpre">RecordM</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">
</span><a name="loc_46_1_46_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_15&#39;)"><span class="hl_fundecl"><span class="mpre">encryptContent</span></span></a><span class="mpre"> </span><a name="loc_46_16_46_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_16_46_22&#39;)"><span class="hl_vardecl"><span class="mpre">record</span></span></a><span class="mpre"> </span><a name="loc_46_23_46_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_23_46_30&#39;)"><span class="hl_vardecl"><span class="mpre">content</span></span></a><span class="mpre"> = do
    </span><a name="loc_47_5_47_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_5_47_11&#39;)"><span class="hl_vardecl"><span class="mpre">digest</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Record.State.html#loc_130_1_130_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_130_1_130_11&#39;)"><span class="hl_varref"><span class="mpre">makeDigest</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Record.Types.html#loc_96_1_96_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.Types.html#loc_96_1_96_15&#39;)"><span class="hl_varref"><span class="mpre">recordToHeader</span></span></a><span class="mpre"> </span><a href="#loc_46_16_46_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_16_46_22&#39;)"><span class="hl_varref"><span class="mpre">record</span></span></a><span class="mpre">) </span><a href="#loc_46_23_46_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_23_46_30&#39;)"><span class="hl_varref"><span class="mpre">content</span></span></a><span class="mpre">
    </span><a href="#loc_51_1_51_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_1_51_12&#39;)"><span class="hl_varref"><span class="mpre">encryptData</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">B.concat</span></span><span class="mpre"> [</span><a href="#loc_46_23_46_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_23_46_30&#39;)"><span class="hl_varref"><span class="mpre">content</span></span></a><span class="mpre">, </span><a href="#loc_47_5_47_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_5_47_11&#39;)"><span class="hl_varref"><span class="mpre">digest</span></span></a><span class="mpre">]

</span><a href="#loc_51_1_51_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_1_51_12&#39;)"><span class="mpre">encryptData</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre"> -&gt; </span><a href="Network.TLS.Record.State.html#loc_57_9_57_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_57_9_57_16&#39;)"><span class="hl_tyconref"><span class="mpre">RecordM</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ByteString</span></span><span class="mpre">
</span><a name="loc_51_1_51_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_1_51_12&#39;)"><span class="hl_fundecl"><span class="mpre">encryptData</span></span></a><span class="mpre"> </span><a name="loc_51_13_51_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_13_51_20&#39;)"><span class="hl_vardecl"><span class="mpre">content</span></span></a><span class="mpre"> = do
    </span><a name="loc_52_5_52_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_5_52_11&#39;)"><span class="hl_vardecl"><span class="mpre">tstate</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">get</span></span><span class="mpre">
    </span><a name="loc_53_5_53_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_5_53_8&#39;)"><span class="hl_vardecl"><span class="mpre">ver</span></span></a><span class="mpre">    &lt;- </span><a href="Network.TLS.Record.State.html#loc_79_1_79_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_79_1_79_17&#39;)"><span class="hl_varref"><span class="mpre">getRecordVersion</span></span></a><span class="mpre">

    let </span><a name="loc_55_9_55_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_9_55_15&#39;)"><span class="hl_vardecl"><span class="mpre">cipher</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Util.html#loc_53_1_53_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Util.html#loc_53_1_53_9&#39;)"><span class="hl_varref"><span class="mpre">fromJust</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;cipher&quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Record.State.html#loc_51_7_51_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_51_7_51_15&#39;)"><span class="hl_varref"><span class="mpre">stCipher</span></span></a><span class="mpre"> </span><a href="#loc_52_5_52_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_5_52_11&#39;)"><span class="hl_varref"><span class="mpre">tstate</span></span></a><span class="mpre">
    let </span><a name="loc_56_9_56_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_56_9_56_13&#39;)"><span class="hl_vardecl"><span class="mpre">bulk</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Cipher.html#loc_86_7_86_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_86_7_86_17&#39;)"><span class="hl_varref"><span class="mpre">cipherBulk</span></span></a><span class="mpre"> </span><a href="#loc_55_9_55_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_9_55_15&#39;)"><span class="hl_varref"><span class="mpre">cipher</span></span></a><span class="mpre">
    let </span><a name="loc_57_9_57_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_57_9_57_12&#39;)"><span class="hl_vardecl"><span class="mpre">cst</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Record.State.html#loc_53_7_53_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_53_7_53_19&#39;)"><span class="hl_varref"><span class="mpre">stCryptState</span></span></a><span class="mpre"> </span><a href="#loc_52_5_52_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_52_5_52_11&#39;)"><span class="hl_varref"><span class="mpre">tstate</span></span></a><span class="mpre">

    let </span><a name="loc_59_9_59_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_59_9_59_17&#39;)"><span class="hl_vardecl"><span class="mpre">writekey</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Record.State.html#loc_41_7_41_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_41_7_41_13&#39;)"><span class="hl_varref"><span class="mpre">cstKey</span></span></a><span class="mpre"> </span><a href="#loc_57_9_57_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_57_9_57_12&#39;)"><span class="hl_varref"><span class="mpre">cst</span></span></a><span class="mpre">

    case </span><a href="Network.TLS.Cipher.html#loc_58_7_58_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_58_7_58_12&#39;)"><span class="hl_varref"><span class="mpre">bulkF</span></span></a><span class="mpre"> </span><a href="#loc_56_9_56_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_56_9_56_13&#39;)"><span class="hl_varref"><span class="mpre">bulk</span></span></a><span class="mpre"> of
        </span><a href="Network.TLS.Cipher.html#loc_34_7_34_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_34_7_34_17&#39;)"><span class="hl_conref"><span class="mpre">BulkBlockF</span></span></a><span class="mpre"> </span><a name="loc_62_20_62_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_20_62_27&#39;)"><span class="hl_vardecl"><span class="mpre">encrypt</span></span></a><span class="mpre"> _ -&gt; do
            let </span><a name="loc_63_17_63_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_17_63_26&#39;)"><span class="hl_vardecl"><span class="mpre">blockSize</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Cipher.html#loc_57_7_57_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_57_7_57_20&#39;)"><span class="hl_varref"><span class="mpre">bulkBlockSize</span></span></a><span class="mpre"> </span><a href="#loc_56_9_56_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_56_9_56_13&#39;)"><span class="hl_varref"><span class="mpre">bulk</span></span></a><span class="mpre">
            let </span><a name="loc_64_17_64_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_17_64_24&#39;)"><span class="hl_vardecl"><span class="mpre">msg_len</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">B.length</span></span><span class="mpre"> </span><a href="#loc_51_13_51_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_13_51_20&#39;)"><span class="hl_varref"><span class="mpre">content</span></span></a><span class="mpre">
            let </span><a name="loc_65_17_65_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_17_65_24&#39;)"><span class="hl_vardecl"><span class="mpre">padding</span></span></a><span class="mpre"> = if </span><a href="#loc_63_17_63_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_17_63_26&#39;)"><span class="hl_varref"><span class="mpre">blockSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
                    then
                            let </span><a name="loc_67_33_67_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_67_33_67_40&#39;)"><span class="hl_vardecl"><span class="mpre">padbyte</span></span></a><span class="mpre"> = </span><a href="#loc_63_17_63_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_17_63_26&#39;)"><span class="hl_varref"><span class="mpre">blockSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> (</span><a href="#loc_64_17_64_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_17_64_24&#39;)"><span class="hl_varref"><span class="mpre">msg_len</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`mod`</span></span><span class="mpre"> </span><a href="#loc_63_17_63_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_17_63_26&#39;)"><span class="hl_varref"><span class="mpre">blockSize</span></span></a><span class="mpre">) in
                            let </span><a name="loc_68_33_68_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_33_68_41&#39;)"><span class="hl_vardecl"><span class="mpre">padbyte&#39;</span></span></a><span class="mpre"> = if </span><a href="#loc_67_33_67_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_67_33_67_40&#39;)"><span class="hl_varref"><span class="mpre">padbyte</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> then </span><a href="#loc_63_17_63_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_17_63_26&#39;)"><span class="hl_varref"><span class="mpre">blockSize</span></span></a><span class="mpre"> else </span><a href="#loc_67_33_67_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_67_33_67_40&#39;)"><span class="hl_varref"><span class="mpre">padbyte</span></span></a><span class="mpre"> in
                            </span><span class="hl_varref"><span class="mpre">B.replicate</span></span><span class="mpre"> </span><a href="#loc_68_33_68_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_33_68_41&#39;)"><span class="hl_varref"><span class="mpre">padbyte&#39;</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> (</span><a href="#loc_68_33_68_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_33_68_41&#39;)"><span class="hl_varref"><span class="mpre">padbyte&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">))
                    else
                            </span><span class="hl_varref"><span class="mpre">B.empty</span></span><span class="mpre">

            let </span><a name="loc_73_17_73_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_17_73_18&#39;)"><span class="hl_vardecl"><span class="mpre">e</span></span></a><span class="mpre"> = </span><a href="#loc_62_20_62_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_20_62_27&#39;)"><span class="hl_varref"><span class="mpre">encrypt</span></span></a><span class="mpre"> </span><a href="#loc_59_9_59_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_59_9_59_17&#39;)"><span class="hl_varref"><span class="mpre">writekey</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Record.State.html#loc_42_7_42_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_42_7_42_12&#39;)"><span class="hl_varref"><span class="mpre">cstIV</span></span></a><span class="mpre"> </span><a href="#loc_57_9_57_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_57_9_57_12&#39;)"><span class="hl_varref"><span class="mpre">cst</span></span></a><span class="mpre">) (</span><span class="hl_varref"><span class="mpre">B.concat</span></span><span class="mpre"> [ </span><a href="#loc_51_13_51_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_13_51_20&#39;)"><span class="hl_varref"><span class="mpre">content</span></span></a><span class="mpre">, </span><a href="#loc_65_17_65_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_17_65_24&#39;)"><span class="hl_varref"><span class="mpre">padding</span></span></a><span class="mpre"> ])
            if </span><a href="Network.TLS.Cap.html#loc_19_1_19_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cap.html#loc_19_1_19_19&#39;)"><span class="hl_varref"><span class="mpre">hasExplicitBlockIV</span></span></a><span class="mpre"> </span><a href="#loc_53_5_53_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_5_53_8&#39;)"><span class="hl_varref"><span class="mpre">ver</span></span></a><span class="mpre">
                    then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">B.concat</span></span><span class="mpre"> [</span><a href="Network.TLS.Record.State.html#loc_42_7_42_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_42_7_42_12&#39;)"><span class="hl_varref"><span class="mpre">cstIV</span></span></a><span class="mpre"> </span><a href="#loc_57_9_57_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_57_9_57_12&#39;)"><span class="hl_varref"><span class="mpre">cst</span></span></a><span class="mpre">,</span><a href="#loc_73_17_73_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_17_73_18&#39;)"><span class="hl_varref"><span class="mpre">e</span></span></a><span class="mpre">]
                    else do
                            let </span><span class="hl_vardecl"><span class="mpre">newiv</span></span><span class="mpre"> = </span><a href="Network.TLS.Util.html#loc_53_1_53_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Util.html#loc_53_1_53_9&#39;)"><span class="hl_varref"><span class="mpre">fromJust</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;new iv&quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Util.html#loc_28_1_28_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Util.html#loc_28_1_28_9&#39;)"><span class="hl_varref"><span class="mpre">takelast</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Cipher.html#loc_56_7_56_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_56_7_56_17&#39;)"><span class="hl_varref"><span class="mpre">bulkIVSize</span></span></a><span class="mpre"> </span><a href="#loc_56_9_56_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_56_9_56_13&#39;)"><span class="hl_varref"><span class="mpre">bulk</span></span></a><span class="mpre">) </span><a href="#loc_73_17_73_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_17_73_18&#39;)"><span class="hl_varref"><span class="mpre">e</span></span></a><span class="mpre">
                            </span><span class="hl_varref"><span class="mpre">put</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Record/Engage.hs&quot;, srcSpanStartLine = 78, srcSpanStartColumn = 35, srcSpanEndLine = 78, srcSpanEndColumn = 82}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Record/Engage.hs&quot;, srcSpanStartLine = 78, srcSpanStartColumn = 42, srcSpanEndLine = 78, srcSpanEndColumn = 43},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Record/Engage.hs&quot;, srcSp"><span class="mpre">tstate { stCryptState = cst { cstIV = newiv } }</span></span><span class="mpre">
                            </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_73_17_73_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_17_73_18&#39;)"><span class="hl_varref"><span class="mpre">e</span></span></a><span class="mpre">
        </span><a href="Network.TLS.Cipher.html#loc_36_7_36_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_36_7_36_18&#39;)"><span class="hl_conref"><span class="mpre">BulkStreamF</span></span></a><span class="mpre"> </span><a name="loc_80_21_80_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_21_80_26&#39;)"><span class="hl_vardecl"><span class="mpre">initF</span></span></a><span class="mpre"> </span><a name="loc_80_27_80_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_27_80_35&#39;)"><span class="hl_vardecl"><span class="mpre">encryptF</span></span></a><span class="mpre"> _ -&gt; do
            let </span><a name="loc_81_17_81_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_17_81_19&#39;)"><span class="hl_vardecl"><span class="mpre">iv</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Record.State.html#loc_42_7_42_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Record.State.html#loc_42_7_42_12&#39;)"><span class="hl_varref"><span class="mpre">cstIV</span></span></a><span class="mpre"> </span><a href="#loc_57_9_57_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_57_9_57_12&#39;)"><span class="hl_varref"><span class="mpre">cst</span></span></a><span class="mpre">
            let (</span><a name="loc_82_18_82_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_18_82_19&#39;)"><span class="hl_vardecl"><span class="mpre">e</span></span></a><span class="mpre">, </span><span class="hl_vardecl"><span class="mpre">newiv</span></span><span class="mpre">) = </span><a href="#loc_80_27_80_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_27_80_35&#39;)"><span class="hl_varref"><span class="mpre">encryptF</span></span></a><span class="mpre"> (if </span><a href="#loc_81_17_81_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_17_81_19&#39;)"><span class="hl_varref"><span class="mpre">iv</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">/=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">B.empty</span></span><span class="mpre"> then </span><a href="#loc_81_17_81_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_17_81_19&#39;)"><span class="hl_varref"><span class="mpre">iv</span></span></a><span class="mpre"> else </span><a href="#loc_80_21_80_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_21_80_26&#39;)"><span class="hl_varref"><span class="mpre">initF</span></span></a><span class="mpre"> </span><a href="#loc_59_9_59_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_59_9_59_17&#39;)"><span class="hl_varref"><span class="mpre">writekey</span></span></a><span class="mpre">) </span><a href="#loc_51_13_51_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_13_51_20&#39;)"><span class="hl_varref"><span class="mpre">content</span></span></a><span class="mpre">
            </span><span class="hl_varref"><span class="mpre">put</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Record/Engage.hs&quot;, srcSpanStartLine = 83, srcSpanStartColumn = 19, srcSpanEndLine = 83, srcSpanEndColumn = 66}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Record/Engage.hs&quot;, srcSpanStartLine = 83, srcSpanStartColumn = 26, srcSpanEndLine = 83, srcSpanEndColumn = 27},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Record/Engage.hs&quot;, srcSp"><span class="mpre">tstate { stCryptState = cst { cstIV = newiv } }</span></span><span class="mpre">
            </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_82_18_82_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_18_82_19&#39;)"><span class="hl_varref"><span class="mpre">e</span></span></a><span class="mpre">
</span></div></body></html>