<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE Trustworthy #-}
{-# LANGUAGE NoImplicitPrelude #-}

module GHC.Conc.Signal
        ( Signal
        , HandlerFun
        , setHandler
        , runHandlers
        ) where

import Control.Concurrent.MVar (</span><a href="GHC.MVar.html#loc_39_6_39_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_39_6_39_10&#39;)"><span class="mpre">MVar</span></a><span class="mpre">, </span><a href="GHC.MVar.html#loc_70_1_70_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_70_1_70_8&#39;)"><span class="mpre">newMVar</span></a><span class="mpre">, </span><a href="Control.Concurrent.MVar.html#loc_185_1_185_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.MVar.html#loc_185_1_185_9&#39;)"><span class="mpre">withMVar</span></a><span class="mpre">)
import Data.Dynamic (</span><a href="Data.Dynamic.html#loc_70_6_70_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Dynamic.html#loc_70_6_70_13&#39;)"><span class="mpre">Dynamic</span></a><span class="mpre">)
import Data.Maybe (</span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="mpre">Maybe</span></a><span class="mpre">(..))
import Foreign.C.Types (CInt)
import Foreign.ForeignPtr (ForeignPtr)
import Foreign.StablePtr (castPtrToStablePtr, castStablePtrToPtr,
                          deRefStablePtr, freeStablePtr, newStablePtr)
import Foreign.Ptr (Ptr, castPtr)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 19, srcSpanStartColumn = 8, srcSpanEndLine = 19, srcSpanEndColumn = 15}, srcInfoPoints = []}) &quot;GHC.Arr&quot;"><span class="mpre">GHC.Arr</span></span><span class="mpre"> (inRange)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 20, srcSpanStartColumn = 8, srcSpanEndLine = 20, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Base&quot;"><span class="mpre">GHC.Base</span></span><span class="mpre">
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 21, srcSpanStartColumn = 8, srcSpanEndLine = 21, srcSpanEndColumn = 21}, srcInfoPoints = []}) &quot;GHC.Conc.Sync&quot;"><span class="mpre">GHC.Conc.Sync</span></span><span class="mpre"> (forkIO)
import GHC.IO (</span><a href="GHC.IO.html#loc_426_1_426_6" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_426_1_426_6&#39;)"><span class="mpre">mask_</span></a><span class="mpre">, </span><a href="GHC.IO.html#loc_165_1_165_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_165_1_165_16&#39;)"><span class="mpre">unsafePerformIO</span></a><span class="mpre">)
import GHC.IOArray (</span><a href="GHC.IOArray.html#loc_42_9_42_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_42_9_42_16&#39;)"><a href="GHC.IOArray.html#loc_42_23_42_30" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_42_23_42_30&#39;)"><span class="mpre">IOArray</span></a></a><span class="mpre">, </span><a href="GHC.IOArray.html#loc_73_1_73_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_73_1_73_14&#39;)"><span class="mpre">boundsIOArray</span></a><span class="mpre">, </span><a href="GHC.IOArray.html#loc_51_1_51_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_51_1_51_11&#39;)"><span class="mpre">newIOArray</span></a><span class="mpre">,
                    </span><a href="GHC.IOArray.html#loc_56_1_56_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_56_1_56_18&#39;)"><span class="mpre">unsafeReadIOArray</span></a><span class="mpre">, </span><a href="GHC.IOArray.html#loc_61_1_61_19" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_61_1_61_19&#39;)"><span class="mpre">unsafeWriteIOArray</span></a><span class="mpre">)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 25, srcSpanStartColumn = 8, srcSpanEndLine = 25, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Real&quot;"><span class="mpre">GHC.Real</span></span><span class="mpre"> (fromIntegral)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 26, srcSpanStartColumn = 8, srcSpanEndLine = 26, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Word&quot;"><span class="mpre">GHC.Word</span></span><span class="mpre"> (Word8)

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Signal handling</span></span><span class="mpre">

</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 31, srcSpanStartColumn = 1, srcSpanEndLine = 31, srcSpanEndColumn = 19}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 31, srcSpanStartColumn = 1, srcSpanEndLine = 31, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 31, srcSpan"><span class="mpre">type Signal = CInt</span></span><span class="mpre">

</span><a href="#loc_34_1_34_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_34_1_34_7&#39;)"><span class="mpre">maxSig</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_34_1_34_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_34_1_34_7&#39;)"><span class="hl_vardecl"><span class="mpre">maxSig</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">64</span></span><span class="mpre">

</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 36, srcSpanStartColumn = 1, srcSpanEndLine = 36, srcSpanEndColumn = 44}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 36, srcSpanStartColumn = 1, srcSpanEndLine = 36, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 36, srcSpan"><span class="mpre">type HandlerFun = ForeignPtr Word8 -&gt; IO ()</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Lock used to protect concurrent access to signal_handlers.  Symptom</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- of this race condition is GHC bug #1922, although that bug was on</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Windows a similar bug also exists on Unix.</span></span><span class="mpre">
</span><a href="#loc_42_1_42_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_1_42_16&#39;)"><span class="mpre">signal_handlers</span></a><span class="mpre"> :: </span><a href="GHC.MVar.html#loc_39_6_39_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_39_6_39_10&#39;)"><span class="hl_tyconref"><span class="mpre">MVar</span></span></a><span class="mpre"> (</span><a href="GHC.IOArray.html#loc_42_9_42_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_42_9_42_16&#39;)"><span class="hl_tyconref"><span class="mpre">IOArray</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> (</span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="hl_tyconref"><span class="mpre">Maybe</span></span></a><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">HandlerFun</span></span><span class="mpre">,</span><a href="Data.Dynamic.html#loc_70_6_70_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Dynamic.html#loc_70_6_70_13&#39;)"><span class="hl_tyconref"><span class="mpre">Dynamic</span></span></a><span class="mpre">)))
</span><a name="loc_42_1_42_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_1_42_16&#39;)"><span class="hl_vardecl"><span class="mpre">signal_handlers</span></span></a><span class="mpre"> = </span><a href="GHC.IO.html#loc_165_1_165_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_165_1_165_16&#39;)"><span class="hl_varref"><span class="mpre">unsafePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
  </span><a name="loc_43_3_43_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_43_3_43_6&#39;)"><span class="hl_vardecl"><span class="mpre">arr</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IOArray.html#loc_51_1_51_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_51_1_51_11&#39;)"><span class="hl_varref"><span class="mpre">newIOArray</span></span></a><span class="mpre"> (</span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">, </span><a href="#loc_34_1_34_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_34_1_34_7&#39;)"><span class="hl_varref"><span class="mpre">maxSig</span></span></a><span class="mpre">) </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre">
  </span><a name="loc_44_3_44_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_44_3_44_4&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.MVar.html#loc_70_1_70_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_70_1_70_8&#39;)"><span class="hl_varref"><span class="mpre">newMVar</span></span></a><span class="mpre"> </span><a href="#loc_43_3_43_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_43_3_43_6&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre">
  </span><a href="#loc_82_1_82_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_10&#39;)"><span class="hl_varref"><span class="mpre">sharedCAF</span></span></a><span class="mpre"> </span><a href="#loc_44_3_44_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_44_3_44_4&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">getOrSetGHCConcSignalSignalHandlerStore</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# NOINLINE </span><a href="#loc_42_1_42_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_1_42_16&#39;)"><span class="mpre">signal_handlers</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="warning" data-warning="DeclForImp (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 48, srcSpanStartColumn = 1, srcSpanEndLine = 49, srcSpanEndColumn = 65}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 48, srcSpanStartColumn = 1, srcSpanEndLine = 48, srcSpanEndColumn = 8},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/base-4.7.0.0/GHC/Conc/Signal.hs&quot;, srcSpanStartLine = 48, srcSpanSt"><span class="mpre">foreign import ccall unsafe &quot;getOrSetGHCConcSignalSignalHandlerStore&quot;
  getOrSetGHCConcSignalSignalHandlerStore :: Ptr a -&gt; IO (Ptr a)</span></span><span class="mpre">

</span><a href="#loc_53_1_53_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_1_53_11&#39;)"><span class="mpre">setHandler</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Signal</span></span><span class="mpre"> -&gt; </span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="hl_tyconref"><span class="mpre">Maybe</span></span></a><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">HandlerFun</span></span><span class="mpre">, </span><a href="Data.Dynamic.html#loc_70_6_70_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Dynamic.html#loc_70_6_70_13&#39;)"><span class="hl_tyconref"><span class="mpre">Dynamic</span></span></a><span class="mpre">)
           -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="Data.Maybe.html#loc_49_7_49_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_7_49_12&#39;)"><span class="hl_tyconref"><span class="mpre">Maybe</span></span></a><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">HandlerFun</span></span><span class="mpre">, </span><a href="Data.Dynamic.html#loc_70_6_70_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Dynamic.html#loc_70_6_70_13&#39;)"><span class="hl_tyconref"><span class="mpre">Dynamic</span></span></a><span class="mpre">))
</span><a name="loc_53_1_53_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_1_53_11&#39;)"><span class="hl_fundecl"><span class="mpre">setHandler</span></span></a><span class="mpre"> </span><a name="loc_53_12_53_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_12_53_15&#39;)"><span class="hl_vardecl"><span class="mpre">sig</span></span></a><span class="mpre"> </span><a name="loc_53_16_53_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_16_53_23&#39;)"><span class="hl_vardecl"><span class="mpre">handler</span></span></a><span class="mpre"> = do
  let </span><a name="loc_54_7_54_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_7_54_10&#39;)"><span class="hl_vardecl"><span class="mpre">int</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_53_12_53_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_12_53_15&#39;)"><span class="hl_varref"><span class="mpre">sig</span></span></a><span class="mpre">
  </span><a href="Control.Concurrent.MVar.html#loc_185_1_185_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.MVar.html#loc_185_1_185_9&#39;)"><span class="hl_varref"><span class="mpre">withMVar</span></span></a><span class="mpre"> </span><a href="#loc_42_1_42_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_1_42_16&#39;)"><span class="hl_varref"><span class="mpre">signal_handlers</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_55_31_55_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_31_55_34&#39;)"><span class="hl_vardecl"><span class="mpre">arr</span></span></a><span class="mpre"> -&gt;
    if </span><span class="hl_varref"><span class="mpre">not</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">inRange</span></span><span class="mpre"> (</span><a href="GHC.IOArray.html#loc_73_1_73_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_73_1_73_14&#39;)"><span class="hl_varref"><span class="mpre">boundsIOArray</span></span></a><span class="mpre"> </span><a href="#loc_55_31_55_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_31_55_34&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre">) </span><a href="#loc_54_7_54_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_7_54_10&#39;)"><span class="hl_varref"><span class="mpre">int</span></span></a><span class="mpre">)
      then </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;GHC.Conc.setHandler: signal out of range&quot;</span></span><span class="mpre">
      else do </span><a name="loc_58_15_58_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_15_58_18&#39;)"><span class="hl_vardecl"><span class="mpre">old</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IOArray.html#loc_56_1_56_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_56_1_56_18&#39;)"><span class="hl_varref"><span class="mpre">unsafeReadIOArray</span></span></a><span class="mpre"> </span><a href="#loc_55_31_55_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_31_55_34&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a href="#loc_54_7_54_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_7_54_10&#39;)"><span class="hl_varref"><span class="mpre">int</span></span></a><span class="mpre">
              </span><a href="GHC.IOArray.html#loc_61_1_61_19" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_61_1_61_19&#39;)"><span class="hl_varref"><span class="mpre">unsafeWriteIOArray</span></span></a><span class="mpre"> </span><a href="#loc_55_31_55_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_31_55_34&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a href="#loc_54_7_54_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_7_54_10&#39;)"><span class="hl_varref"><span class="mpre">int</span></span></a><span class="mpre"> </span><a href="#loc_53_16_53_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_16_53_23&#39;)"><span class="hl_varref"><span class="mpre">handler</span></span></a><span class="mpre">
              </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_58_15_58_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_15_58_18&#39;)"><span class="hl_varref"><span class="mpre">old</span></span></a><span class="mpre">

</span><a href="#loc_63_1_63_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_1_63_12&#39;)"><span class="mpre">runHandlers</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">ForeignPtr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Signal</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_63_1_63_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_1_63_12&#39;)"><span class="hl_fundecl"><span class="mpre">runHandlers</span></span></a><span class="mpre"> </span><a name="loc_63_13_63_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_13_63_19&#39;)"><span class="hl_vardecl"><span class="mpre">p_info</span></span></a><span class="mpre"> </span><a name="loc_63_20_63_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_20_63_23&#39;)"><span class="hl_vardecl"><span class="mpre">sig</span></span></a><span class="mpre"> = do
  let </span><a name="loc_64_7_64_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_7_64_10&#39;)"><span class="hl_vardecl"><span class="mpre">int</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_63_20_63_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_20_63_23&#39;)"><span class="hl_varref"><span class="mpre">sig</span></span></a><span class="mpre">
  </span><a href="Control.Concurrent.MVar.html#loc_185_1_185_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.MVar.html#loc_185_1_185_9&#39;)"><span class="hl_varref"><span class="mpre">withMVar</span></span></a><span class="mpre"> </span><a href="#loc_42_1_42_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_1_42_16&#39;)"><span class="hl_varref"><span class="mpre">signal_handlers</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_65_31_65_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_31_65_34&#39;)"><span class="hl_vardecl"><span class="mpre">arr</span></span></a><span class="mpre"> -&gt;
    if </span><span class="hl_varref"><span class="mpre">not</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">inRange</span></span><span class="mpre"> (</span><a href="GHC.IOArray.html#loc_73_1_73_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_73_1_73_14&#39;)"><span class="hl_varref"><span class="mpre">boundsIOArray</span></span></a><span class="mpre"> </span><a href="#loc_65_31_65_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_31_65_34&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre">) </span><a href="#loc_64_7_64_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_7_64_10&#39;)"><span class="hl_varref"><span class="mpre">int</span></span></a><span class="mpre">)
      then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
      else do </span><a name="loc_68_15_68_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_15_68_22&#39;)"><span class="hl_vardecl"><span class="mpre">handler</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IOArray.html#loc_56_1_56_18" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IOArray.html#loc_56_1_56_18&#39;)"><span class="hl_varref"><span class="mpre">unsafeReadIOArray</span></span></a><span class="mpre"> </span><a href="#loc_65_31_65_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_65_31_65_34&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a href="#loc_64_7_64_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_7_64_10&#39;)"><span class="hl_varref"><span class="mpre">int</span></span></a><span class="mpre">
              case </span><a href="#loc_68_15_68_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_68_15_68_22&#39;)"><span class="hl_varref"><span class="mpre">handler</span></span></a><span class="mpre"> of
                </span><a href="Data.Maybe.html#loc_49_19_49_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_19_49_26&#39;)"><span class="hl_conref"><span class="mpre">Nothing</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
                </span><a href="Data.Maybe.html#loc_49_29_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_49_29_49_33&#39;)"><span class="hl_conref"><span class="mpre">Just</span></span></a><span class="mpre"> (</span><a name="loc_71_23_71_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_23_71_24&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre">,_)  -&gt; do _ &lt;- </span><span class="hl_varref"><span class="mpre">forkIO</span></span><span class="mpre"> (</span><a href="#loc_71_23_71_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_23_71_24&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_63_13_63_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_63_13_63_19&#39;)"><span class="hl_varref"><span class="mpre">p_info</span></span></a><span class="mpre">)
                                  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Machinery needed to ensure that we only have one copy of certain</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- CAFs in this module even when the base package is present twice, as</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- it is when base is dynamically loaded into GHCi.  The RTS keeps</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- track of the single true value of the CAF, so even when the CAFs in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the dynamically-loaded base package are reverted, nothing bad</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- happens.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_82_1_82_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_10&#39;)"><span class="mpre">sharedCAF</span></a><span class="mpre"> :: </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_82_1_82_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_10&#39;)"><span class="hl_fundecl"><span class="mpre">sharedCAF</span></span></a><span class="mpre"> </span><a name="loc_82_11_82_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_11_82_12&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> </span><a name="loc_82_13_82_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_13_82_23&#39;)"><span class="hl_vardecl"><span class="mpre">get_or_set</span></span></a><span class="mpre"> =
  </span><a href="GHC.IO.html#loc_426_1_426_6" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_426_1_426_6&#39;)"><span class="hl_varref"><span class="mpre">mask_</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
    </span><a name="loc_84_5_84_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_5_84_15&#39;)"><span class="hl_vardecl"><span class="mpre">stable_ref</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newStablePtr</span></span><span class="mpre"> </span><a href="#loc_82_11_82_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_11_82_12&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">
    let </span><a name="loc_85_9_85_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_9_85_12&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castStablePtrToPtr</span></span><span class="mpre"> </span><a href="#loc_84_5_84_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_5_84_15&#39;)"><span class="hl_varref"><span class="mpre">stable_ref</span></span></a><span class="mpre">)
    </span><a name="loc_86_5_86_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_5_86_9&#39;)"><span class="hl_vardecl"><span class="mpre">ref2</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_82_13_82_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_13_82_23&#39;)"><span class="hl_varref"><span class="mpre">get_or_set</span></span></a><span class="mpre"> </span><a href="#loc_85_9_85_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_9_85_12&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre">
    if </span><a href="#loc_85_9_85_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_9_85_12&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_86_5_86_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_5_86_9&#39;)"><span class="hl_varref"><span class="mpre">ref2</span></span></a><span class="mpre">
      then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_82_11_82_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_11_82_12&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">
      else do </span><span class="hl_varref"><span class="mpre">freeStablePtr</span></span><span class="mpre"> </span><a href="#loc_84_5_84_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_5_84_15&#39;)"><span class="hl_varref"><span class="mpre">stable_ref</span></span></a><span class="mpre">
              </span><span class="hl_varref"><span class="mpre">deRefStablePtr</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtrToStablePtr</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_86_5_86_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_5_86_9&#39;)"><span class="hl_varref"><span class="mpre">ref2</span></span></a><span class="mpre">))

</span></div></body></html>