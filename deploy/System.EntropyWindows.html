<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE CPP, ForeignFunctionInterface, BangPatterns, ScopedTypeVariables #-}
</span><span class="hl_comment"><span class="mpre">{-|
 Maintainer: Thomas.DuBuisson@gmail.com
 Stability: beta
 Portability: portable

 Obtain entropy from system sources or x86 RDRAND when available.
-}</span></span><span class="mpre">

module System.EntropyWindows
        ( CryptHandle
        , openHandle
        , hGetEntropy
        , closeHandle
        ) where

import Control.Monad (</span><a href="Control.Monad.html#loc_274_1_274_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_274_1_274_6&#39;)"><span class="mpre">liftM</span></a><span class="mpre">, </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="mpre">when</span></a><span class="mpre">)
import System.IO.Error (</span><a href="System.IO.Error.html#loc_115_1_115_10" onmouseover="nemnem.highlightLocalToRemote(&#39;System.IO.Error.html#loc_115_1_115_10&#39;)"><span class="mpre">mkIOError</span></a><span class="mpre">, </span><a href="System.IO.Error.html#loc_198_1_198_13" onmouseover="nemnem.highlightLocalToRemote(&#39;System.IO.Error.html#loc_198_1_198_13&#39;)"><span class="mpre">eofErrorType</span></a><span class="mpre">, </span><a href="System.IO.Error.html#loc_289_1_289_18" onmouseover="nemnem.highlightLocalToRemote(&#39;System.IO.Error.html#loc_289_1_289_18&#39;)"><span class="mpre">ioeSetErrorString</span></a><span class="mpre">)
import Foreign (allocaBytes)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStartLine = 20, srcSpanStartColumn = 8, srcSpanEndLine = 20, srcSpanEndColumn = 23}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre"> as B
import Data.ByteString.Internal as BI
import Data.Int (</span><a href="GHC.Int.html#loc_376_30_376_35" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Int.html#loc_376_30_376_35&#39;)"><span class="mpre">Int32</span></a><span class="mpre">)
import Data.Word (Word32, Word8)
import Foreign.C.String (CString, </span><a href="Foreign.C.String.html#loc_176_1_176_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.C.String.html#loc_176_1_176_12&#39;)"><span class="mpre">withCString</span></a><span class="mpre">)
import Foreign.C.Types
import Foreign.Ptr (Ptr, nullPtr, castPtr)
import Foreign.Marshal.Alloc (</span><a href="Foreign.Marshal.Alloc.html#loc_107_1_107_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Alloc.html#loc_107_1_107_7&#39;)"><span class="mpre">alloca</span></a><span class="mpre">)
import Foreign.Marshal.Utils (</span><a href="Foreign.Marshal.Utils.html#loc_103_1_103_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_103_1_103_7&#39;)"><span class="mpre">toBool</span></a><span class="mpre">)
import Foreign.Storable (peek)

</span><span class="hl_comment"><span class="mpre">{- C example for windows rng - taken from a blog, can&#39;t recall which one but thank you!
        #include &lt;Windows.h&gt;
        #include &lt;Wincrypt.h&gt;
        ...
        //
        // DISCLAIMER: Don&#39;t forget to check your error codes!!
        // I am not checking as to make the example simple...
        //
        HCRYPTPROV hCryptCtx = NULL;
        BYTE randomArray[128];

        CryptAcquireContext(&amp;hCryptCtx, NULL, MS_DEF_PROV, PROV_RSA_FULL, CRYPT_VERIFYCONTEXT);
        CryptGenRandom(hCryptCtx, 128, randomArray);
        CryptReleaseContext(hCryptCtx, 0);
-}</span></span><span class="mpre">


#ifdef HAVE_RDRAND
</span><span class="warning" data-warning="DeclForImp (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStartLine = 49, srcSpanStartColumn = 1, srcSpanEndLine = 50, srcSpanEndColumn = 31}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStartLine = 49, srcSpanStartColumn = 1, srcSpanEndLine = 49, srcSpanEndColumn = 8},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStar"><span class="mpre">foreign import ccall unsafe &quot;cpu_has_rdrand&quot;
   c_cpu_has_rdrand :: IO CInt</span></span><span class="mpre">

</span><span class="warning" data-warning="DeclForImp (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStartLine = 52, srcSpanStartColumn = 1, srcSpanEndLine = 53, srcSpanEndColumn = 53}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStartLine = 52, srcSpanStartColumn = 1, srcSpanEndLine = 52, srcSpanEndColumn = 8},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStar"><span class="mpre">foreign import ccall unsafe &quot;get_rand_bytes&quot;
  c_get_rand_bytes :: Ptr CUChar -&gt; CSize -&gt; IO CInt</span></span><span class="mpre">

</span><a href="#loc_56_1_56_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_56_1_56_13&#39;)"><span class="mpre">cpuHasRdRand</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">
</span><a name="loc_56_1_56_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_56_1_56_13&#39;)"><span class="hl_vardecl"><span class="mpre">cpuHasRdRand</span></span></a><span class="mpre"> = (</span><span class="hl_infix"><span class="mpre">/=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">`fmap`</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">c_cpu_has_rdrand</span></span><span class="mpre">
#endif

data </span><a name="loc_59_6_59_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_59_6_59_17&#39;)"><span class="hl_tycondecl"><span class="mpre">CryptHandle</span></span></a><span class="mpre">
    = </span><a name="loc_60_7_60_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_60_7_60_9&#39;)"><span class="hl_condecl"><span class="mpre">CH</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word32</span></span><span class="mpre">
#ifdef HAVE_RDRAND
    | </span><a name="loc_62_7_62_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_7_62_16&#39;)"><span class="hl_condecl"><span class="mpre">UseRdRand</span></span></a><span class="mpre">
#endif

</span><span class="hl_comment"><span class="mpre">-- Define the constants we need from WinCrypt.h </span></span><span class="mpre">
</span><a href="#loc_67_1_67_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_67_1_67_10&#39;)"><span class="mpre">msDefProv</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre">
</span><a name="loc_67_1_67_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_67_1_67_10&#39;)"><span class="hl_vardecl"><span class="mpre">msDefProv</span></span></a><span class="mpre"> = </span><span class="hl_string"><span class="mpre">&quot;Microsoft Base Cryptographic Provider v1.0&quot;</span></span><span class="mpre">
</span><a href="#loc_69_1_69_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_1_69_12&#39;)"><span class="mpre">provRSAFull</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Word32</span></span><span class="mpre">
</span><a name="loc_69_1_69_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_1_69_12&#39;)"><span class="hl_vardecl"><span class="mpre">provRSAFull</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">
</span><a href="#loc_71_1_71_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_1_71_19&#39;)"><span class="mpre">cryptVerifyContext</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Word32</span></span><span class="mpre">
</span><a name="loc_71_1_71_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_1_71_19&#39;)"><span class="hl_vardecl"><span class="mpre">cryptVerifyContext</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xF0000000</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Declare the required CryptoAPI imports </span></span><span class="mpre">
</span><span class="warning" data-warning="DeclForImp (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStartLine = 74, srcSpanStartColumn = 1, srcSpanEndLine = 75, srcSpanEndColumn = 89}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStartLine = 74, srcSpanStartColumn = 1, srcSpanEndLine = 74, srcSpanEndColumn = 8},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStar"><span class="mpre">foreign import stdcall unsafe &quot;CryptAcquireContextA&quot;
   c_cryptAcquireCtx :: Ptr Word32 -&gt; CString -&gt; CString -&gt; Word32 -&gt; Word32 -&gt; IO Int32</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclForImp (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStartLine = 76, srcSpanStartColumn = 1, srcSpanEndLine = 77, srcSpanEndColumn = 65}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStartLine = 76, srcSpanStartColumn = 1, srcSpanEndLine = 76, srcSpanEndColumn = 8},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStar"><span class="mpre">foreign import stdcall unsafe &quot;CryptGenRandom&quot;
   c_cryptGenRandom :: Word32 -&gt; Word32 -&gt; Ptr Word8 -&gt; IO Int32</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclForImp (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStartLine = 78, srcSpanStartColumn = 1, srcSpanEndLine = 79, srcSpanEndColumn = 53}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStartLine = 78, srcSpanStartColumn = 1, srcSpanEndLine = 78, srcSpanEndColumn = 8},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/entropy-0.3.2/System/EntropyWindows.hs&quot;, srcSpanStar"><span class="mpre">foreign import stdcall unsafe &quot;CryptReleaseContext&quot;
   c_cryptReleaseCtx :: Word32 -&gt; Word32 -&gt; IO Int32</span></span><span class="mpre">

</span><a href="#loc_82_1_82_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_16&#39;)"><span class="mpre">cryptAcquireCtx</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word32</span></span><span class="mpre">
</span><a name="loc_82_1_82_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_16&#39;)"><span class="hl_vardecl"><span class="mpre">cryptAcquireCtx</span></span></a><span class="mpre"> =
   </span><a href="Foreign.Marshal.Alloc.html#loc_107_1_107_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Alloc.html#loc_107_1_107_7&#39;)"><span class="hl_varref"><span class="mpre">alloca</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_83_14_83_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_14_83_23&#39;)"><span class="hl_vardecl"><span class="mpre">handlePtr</span></span></a><span class="mpre"> -&gt; 
      </span><a href="Foreign.C.String.html#loc_176_1_176_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.C.String.html#loc_176_1_176_12&#39;)"><span class="hl_varref"><span class="mpre">withCString</span></span></a><span class="mpre"> </span><a href="#loc_67_1_67_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_67_1_67_10&#39;)"><span class="hl_varref"><span class="mpre">msDefProv</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_84_32_84_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_32_84_40&#39;)"><span class="hl_vardecl"><span class="mpre">provName</span></span></a><span class="mpre"> -&gt; do
         </span><a name="loc_85_10_85_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_10_85_14&#39;)"><span class="hl_vardecl"><span class="mpre">stat</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">c_cryptAcquireCtx</span></span><span class="mpre"> </span><a href="#loc_83_14_83_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_14_83_23&#39;)"><span class="hl_varref"><span class="mpre">handlePtr</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">nullPtr</span></span><span class="mpre"> </span><a href="#loc_84_32_84_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_32_84_40&#39;)"><span class="hl_varref"><span class="mpre">provName</span></span></a><span class="mpre"> </span><a href="#loc_69_1_69_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_1_69_12&#39;)"><span class="hl_varref"><span class="mpre">provRSAFull</span></span></a><span class="mpre"> </span><a href="#loc_71_1_71_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_1_71_19&#39;)"><span class="hl_varref"><span class="mpre">cryptVerifyContext</span></span></a><span class="mpre">
         if (</span><a href="Foreign.Marshal.Utils.html#loc_103_1_103_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_103_1_103_7&#39;)"><span class="hl_varref"><span class="mpre">toBool</span></span></a><span class="mpre"> </span><a href="#loc_85_10_85_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_10_85_14&#39;)"><span class="hl_varref"><span class="mpre">stat</span></span></a><span class="mpre">)
            then </span><span class="hl_varref"><span class="mpre">peek</span></span><span class="mpre"> </span><a href="#loc_83_14_83_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_14_83_23&#39;)"><span class="hl_varref"><span class="mpre">handlePtr</span></span></a><span class="mpre">
            else </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;c_cryptAcquireCtx&quot;</span></span><span class="mpre">

</span><a href="#loc_91_1_91_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_1_91_15&#39;)"><span class="mpre">cryptGenRandom</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Word32</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">B.ByteString</span></span><span class="mpre">
</span><a name="loc_91_1_91_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_1_91_15&#39;)"><span class="hl_fundecl"><span class="mpre">cryptGenRandom</span></span></a><span class="mpre"> </span><a name="loc_91_16_91_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_16_91_17&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre"> </span><a name="loc_91_18_91_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_18_91_19&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre"> = 
   </span><a href="Data.ByteString.Internal.html#loc_434_1_434_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_434_1_434_7&#39;)"><span class="hl_varref"><span class="mpre">BI.create</span></span></a><span class="mpre"> </span><a href="#loc_91_18_91_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_18_91_19&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_92_19_92_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_19_92_27&#39;)"><span class="hl_vardecl"><span class="mpre">c_buffer</span></span></a><span class="mpre"> -&gt; do
      </span><a name="loc_93_7_93_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_7_93_11&#39;)"><span class="hl_vardecl"><span class="mpre">stat</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">c_cryptGenRandom</span></span><span class="mpre"> </span><a href="#loc_91_16_91_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_16_91_17&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_91_18_91_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_18_91_19&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre">) </span><a href="#loc_92_19_92_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_19_92_27&#39;)"><span class="hl_varref"><span class="mpre">c_buffer</span></span></a><span class="mpre">
      if (</span><a href="Foreign.Marshal.Utils.html#loc_103_1_103_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_103_1_103_7&#39;)"><span class="hl_varref"><span class="mpre">toBool</span></span></a><span class="mpre"> </span><a href="#loc_93_7_93_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_7_93_11&#39;)"><span class="hl_varref"><span class="mpre">stat</span></span></a><span class="mpre">)
         then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
         else </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;c_cryptGenRandom&quot;</span></span><span class="mpre">

</span><a href="#loc_99_1_99_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_1_99_16&#39;)"><span class="mpre">cryptReleaseCtx</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Word32</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_99_1_99_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_1_99_16&#39;)"><span class="hl_fundecl"><span class="mpre">cryptReleaseCtx</span></span></a><span class="mpre"> </span><a name="loc_99_17_99_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_17_99_18&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre"> = do
   </span><a name="loc_100_4_100_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_100_4_100_8&#39;)"><span class="hl_vardecl"><span class="mpre">stat</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">c_cryptReleaseCtx</span></span><span class="mpre"> </span><a href="#loc_99_17_99_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_17_99_18&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
   if (</span><a href="Foreign.Marshal.Utils.html#loc_103_1_103_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_103_1_103_7&#39;)"><span class="hl_varref"><span class="mpre">toBool</span></span></a><span class="mpre"> </span><a href="#loc_100_4_100_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_100_4_100_8&#39;)"><span class="hl_varref"><span class="mpre">stat</span></span></a><span class="mpre">)
      then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
      else </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;c_cryptReleaseCtx&quot;</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- |Open a handle from which random data can be read</span></span><span class="mpre">
</span><a href="#loc_107_1_107_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_107_1_107_11&#39;)"><span class="mpre">openHandle</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_59_6_59_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_59_6_59_17&#39;)"><span class="hl_tyconref"><span class="mpre">CryptHandle</span></span></a><span class="mpre">
</span><a name="loc_107_1_107_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_107_1_107_11&#39;)"><span class="hl_vardecl"><span class="mpre">openHandle</span></span></a><span class="mpre"> = do
#ifdef HAVE_RDRAND
    </span><a name="loc_109_5_109_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_109_5_109_6&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_56_1_56_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_56_1_56_13&#39;)"><span class="hl_varref"><span class="mpre">cpuHasRdRand</span></span></a><span class="mpre">
    if </span><a href="#loc_109_5_109_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_109_5_109_6&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> then </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_62_7_62_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_7_62_16&#39;)"><span class="hl_conref"><span class="mpre">UseRdRand</span></span></a><span class="mpre">
         else do
#endif
                  </span><a href="Control.Monad.html#loc_274_1_274_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_274_1_274_6&#39;)"><span class="hl_varref"><span class="mpre">liftM</span></span></a><span class="mpre"> </span><a href="#loc_60_7_60_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_60_7_60_9&#39;)"><span class="hl_conref"><span class="mpre">CH</span></span></a><span class="mpre"> </span><a href="#loc_82_1_82_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_16&#39;)"><span class="hl_varref"><span class="mpre">cryptAcquireCtx</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- |Close the `CryptHandle`</span></span><span class="mpre">
</span><a href="#loc_117_1_117_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_1_117_12&#39;)"><span class="mpre">closeHandle</span></a><span class="mpre"> :: </span><a href="#loc_59_6_59_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_59_6_59_17&#39;)"><span class="hl_tyconref"><span class="mpre">CryptHandle</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_117_1_117_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_1_117_12&#39;)"><span class="hl_fundecl"><span class="mpre">closeHandle</span></span></a><span class="mpre"> (</span><a href="#loc_60_7_60_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_60_7_60_9&#39;)"><span class="hl_conref"><span class="mpre">CH</span></span></a><span class="mpre"> </span><a name="loc_117_17_117_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_17_117_18&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre">) = </span><a href="#loc_99_1_99_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_1_99_16&#39;)"><span class="hl_varref"><span class="mpre">cryptReleaseCtx</span></span></a><span class="mpre"> </span><a href="#loc_117_17_117_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_17_117_18&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- |Read from `CryptHandle`</span></span><span class="mpre">
</span><a href="#loc_121_1_121_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_1_121_12&#39;)"><span class="mpre">hGetEntropy</span></a><span class="mpre"> :: </span><a href="#loc_59_6_59_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_59_6_59_17&#39;)"><span class="hl_tyconref"><span class="mpre">CryptHandle</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">B.ByteString</span></span><span class="mpre"> 
</span><a name="loc_121_1_121_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_1_121_12&#39;)"><span class="hl_fundecl"><span class="mpre">hGetEntropy</span></span></a><span class="mpre"> (</span><a href="#loc_60_7_60_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_60_7_60_9&#39;)"><span class="hl_conref"><span class="mpre">CH</span></span></a><span class="mpre"> </span><a name="loc_121_17_121_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_17_121_18&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre">) </span><a name="loc_121_20_121_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_20_121_21&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> = </span><a href="#loc_91_1_91_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_1_91_15&#39;)"><span class="hl_varref"><span class="mpre">cryptGenRandom</span></span></a><span class="mpre"> </span><a href="#loc_121_17_121_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_17_121_18&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> </span><a href="#loc_121_20_121_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_20_121_21&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">
#ifdef HAVE_RDRAND
</span><a href="#loc_121_1_121_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_1_121_12&#39;)"><span class="hl_fundecl"><span class="mpre">hGetEntropy</span></span></a><span class="mpre"> </span><a href="#loc_62_7_62_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_7_62_16&#39;)"><span class="hl_conref"><span class="mpre">UseRdRand</span></span></a><span class="mpre"> </span><a name="loc_123_23_123_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_123_23_123_24&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> =
    </span><a href="Data.ByteString.Internal.html#loc_434_1_434_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_434_1_434_7&#39;)"><span class="hl_varref"><span class="mpre">BI.create</span></span></a><span class="mpre"> </span><a href="#loc_123_23_123_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_123_23_123_24&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_124_20_124_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_124_20_124_23&#39;)"><span class="hl_vardecl"><span class="mpre">ptr</span></span></a><span class="mpre"> -&gt;  do
                </span><a name="loc_125_17_125_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_17_125_18&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">c_get_rand_bytes</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_124_20_124_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_124_20_124_23&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre">) (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_123_23_123_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_123_23_123_24&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">)
                </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><a href="#loc_125_17_125_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_17_125_18&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">/=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">)
                     (</span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;RDRand failed to gather entropy&quot;</span></span><span class="mpre">)
#endif
</span></div></body></html>