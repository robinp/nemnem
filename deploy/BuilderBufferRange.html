<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE CPP, BangPatterns #-}
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : BuilderBufferRange</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   : (c) 2010 Simon Meier</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD3-style (see LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- </span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Simon Meier &lt;iridcode@gmail.com&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : tested on GHC only</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Benchmark the benefit of using a packed representation for the buffer range.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module BuilderBufferRange where


import Foreign
import Data.Monoid
import Control.Monad (</span><a href="Control.Monad.html#loc_270_1_270_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_270_1_270_7&#39;)"><span class="mpre">unless</span></a><span class="mpre">)
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/benchmarks/BuilderBufferRange.hs&quot;, srcSpanStartLine = 19, srcSpanStartColumn = 18, srcSpanEndLine = 19, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre">      as S
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/benchmarks/BuilderBufferRange.hs&quot;, srcSpanStartLine = 20, srcSpanStartColumn = 18, srcSpanEndLine = 20, srcSpanEndColumn = 38}, srcInfoPoints = []}) &quot;Data.ByteString.Lazy&quot;"><span class="mpre">Data.ByteString.Lazy</span></span><span class="mpre"> as L

#ifdef BYTESTRING_IN_BASE
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/benchmarks/BuilderBufferRange.hs&quot;, srcSpanStartLine = 23, srcSpanStartColumn = 8, srcSpanEndLine = 23, srcSpanEndColumn = 28}, srcInfoPoints = []}) &quot;Data.ByteString.Base&quot;"><span class="mpre">Data.ByteString.Base</span></span><span class="mpre"> (inlinePerformIO)
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/benchmarks/BuilderBufferRange.hs&quot;, srcSpanStartLine = 24, srcSpanStartColumn = 18, srcSpanEndLine = 24, srcSpanEndColumn = 38}, srcInfoPoints = []}) &quot;Data.ByteString.Base&quot;"><span class="mpre">Data.ByteString.Base</span></span><span class="mpre"> as S
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/benchmarks/BuilderBufferRange.hs&quot;, srcSpanStartLine = 25, srcSpanStartColumn = 18, srcSpanEndLine = 25, srcSpanEndColumn = 43}, srcInfoPoints = []}) &quot;Data.ByteString.Lazy.Base&quot;"><span class="mpre">Data.ByteString.Lazy.Base</span></span><span class="mpre"> as L </span><span class="hl_comment"><span class="mpre">-- FIXME: is this the right module for access to &#39;Chunks&#39;?</span></span><span class="mpre">
#else
import Data.ByteString.Internal (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="mpre">inlinePerformIO</span></a><span class="mpre">)
import qualified Data.ByteString.Internal as S
import qualified Data.ByteString.Lazy.Internal as L
#endif

import qualified Blaze.ByteString.Builder.Internal as B
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/benchmarks/BuilderBufferRange.hs&quot;, srcSpanStartLine = 33, srcSpanStartColumn = 8, srcSpanEndLine = 33, srcSpanEndColumn = 38}, srcInfoPoints = []}) &quot;Blaze.ByteString.Builder.Write&quot;"><span class="mpre">Blaze.ByteString.Builder.Write</span></span><span class="mpre">
import Blaze.ByteString.Builder.Word

import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/benchmarks/BuilderBufferRange.hs&quot;, srcSpanStartLine = 36, srcSpanStartColumn = 8, srcSpanEndLine = 36, srcSpanEndColumn = 22}, srcInfoPoints = []}) &quot;Criterion.Main&quot;"><span class="mpre">Criterion.Main</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Benchmarks</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><a href="#loc_43_1_43_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_43_1_43_5&#39;)"><span class="mpre">main</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_43_1_43_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_43_1_43_5&#39;)"><span class="hl_vardecl"><span class="mpre">main</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">defaultMain</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">concat</span></span><span class="mpre">
    [ </span><a href="#loc_58_5_58_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_5_58_14&#39;)"><span class="hl_varref"><span class="mpre">benchmark</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;putBuilder&quot;</span></span><span class="mpre">
        (</span><a href="#loc_129_1_129_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_1_129_11&#39;)"><span class="hl_varref"><span class="mpre">putBuilder</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="hl_varref"><span class="mpre">mconcat</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Word.html#loc_269_1_269_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Word.html#loc_269_1_269_10&#39;)"><span class="hl_varref"><span class="mpre">fromWord8</span></span></a><span class="mpre">)
        (</span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="hl_varref"><span class="mpre">mconcat</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Word.html#loc_269_1_269_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Word.html#loc_269_1_269_10&#39;)"><span class="hl_varref"><span class="mpre">fromWord8</span></span></a><span class="mpre">)
        </span><a href="#loc_66_1_66_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_66_1_66_7&#39;)"><span class="hl_varref"><span class="mpre">word8s</span></span></a><span class="mpre">
    , </span><a href="#loc_58_5_58_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_5_58_14&#39;)"><span class="hl_varref"><span class="mpre">benchmark</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;fromWriteSingleton&quot;</span></span><span class="mpre">
        (</span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="hl_varref"><span class="mpre">mconcat</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre">  </span><a href="#loc_148_1_148_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_1_148_9&#39;)"><span class="hl_varref"><span class="mpre">putWord8</span></span></a><span class="mpre">)
        (</span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="hl_varref"><span class="mpre">mconcat</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Word.html#loc_269_1_269_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Word.html#loc_269_1_269_10&#39;)"><span class="hl_varref"><span class="mpre">fromWord8</span></span></a><span class="mpre">)
        </span><a href="#loc_66_1_66_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_66_1_66_7&#39;)"><span class="hl_varref"><span class="mpre">word8s</span></span></a><span class="mpre">
    , </span><a href="#loc_58_5_58_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_5_58_14&#39;)"><span class="hl_varref"><span class="mpre">benchmark</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;fromWrite&quot;</span></span><span class="mpre">
        (</span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="hl_varref"><span class="mpre">mconcat</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> (</span><a href="#loc_101_1_101_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_1_101_9&#39;)"><span class="hl_varref"><span class="mpre">putWrite</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Word.html#loc_117_1_117_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Word.html#loc_117_1_117_11&#39;)"><span class="hl_varref"><span class="mpre">writeWord8</span></span></a><span class="mpre">))
        (</span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="hl_varref"><span class="mpre">mconcat</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromWrite</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Word.html#loc_117_1_117_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Word.html#loc_117_1_117_11&#39;)"><span class="hl_varref"><span class="mpre">writeWord8</span></span></a><span class="mpre">))
        </span><a href="#loc_66_1_66_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_66_1_66_7&#39;)"><span class="hl_varref"><span class="mpre">word8s</span></span></a><span class="mpre">
    ]
  where
    </span><a name="loc_58_5_58_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_5_58_14&#39;)"><span class="hl_fundecl"><span class="mpre">benchmark</span></span></a><span class="mpre"> </span><a name="loc_58_15_58_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_15_58_19&#39;)"><span class="hl_vardecl"><span class="mpre">name</span></span></a><span class="mpre"> </span><a name="loc_58_20_58_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_20_58_24&#39;)"><span class="hl_vardecl"><span class="mpre">putF</span></span></a><span class="mpre"> </span><a name="loc_58_25_58_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_25_58_33&#39;)"><span class="hl_vardecl"><span class="mpre">builderF</span></span></a><span class="mpre"> </span><a name="loc_58_34_58_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_34_58_35&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> =
        [ </span><span class="hl_varref"><span class="mpre">bench</span></span><span class="mpre"> (</span><a href="#loc_58_15_58_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_15_58_19&#39;)"><span class="hl_varref"><span class="mpre">name</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot; Put&quot;</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
            </span><span class="hl_varref"><span class="mpre">whnf</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">L.length</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_364_1_364_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_17&#39;)"><span class="hl_varref"><span class="mpre">toLazyByteString</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_58_20_58_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_20_58_24&#39;)"><span class="hl_varref"><span class="mpre">putF</span></span></a><span class="mpre">) </span><a href="#loc_58_34_58_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_34_58_35&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
        , </span><span class="hl_varref"><span class="mpre">bench</span></span><span class="mpre"> (</span><a href="#loc_58_15_58_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_15_58_19&#39;)"><span class="hl_varref"><span class="mpre">name</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot; Builder&quot;</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
            </span><span class="hl_varref"><span class="mpre">whnf</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">L.length</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.html#loc_269_1_269_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.html#loc_269_1_269_17&#39;)"><span class="hl_varref"><span class="mpre">B.toLazyByteString</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_58_25_58_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_25_58_33&#39;)"><span class="hl_varref"><span class="mpre">builderF</span></span></a><span class="mpre">) </span><a href="#loc_58_34_58_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_34_58_35&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
        ]

</span><a href="#loc_66_1_66_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_66_1_66_7&#39;)"><span class="mpre">word8s</span></a><span class="mpre"> :: [</span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">]
</span><a name="loc_66_1_66_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_66_1_66_7&#39;)"><span class="hl_vardecl"><span class="mpre">word8s</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">take</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">100000</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">cycle</span></span><span class="mpre"> </span><span class="warning" data-warning="ExpEnumFrom (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/benchmarks/BuilderBufferRange.hs&quot;, srcSpanStartLine = 66, srcSpanStartColumn = 30, srcSpanEndLine = 66, srcSpanEndColumn = 35}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/benchmarks/BuilderBufferRange.hs&quot;, srcSpanStartLine = 66, srcSpanStartColumn = 30, srcSpanEndLine = 66, srcSpanEndColumn = 31},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0"><span class="mpre">[0..]</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# NOINLINE </span><a href="#loc_66_1_66_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_66_1_66_7&#39;)"><span class="mpre">word8s</span></a><span class="mpre"> #-}</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The Builder type</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

data </span><a name="loc_74_6_74_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_6_74_17&#39;)"><span class="hl_tycondecl"><span class="mpre">BufferRange</span></span></a><span class="mpre"> = </span><a name="loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_condecl"><span class="mpre">BR</span></span></a><span class="mpre"> {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">) 
                      {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)

newtype </span><a name="loc_77_9_77_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_9_77_12&#39;)"><span class="hl_tycondecl"><span class="mpre">Put</span></span></a><span class="mpre"> = </span><a name="loc_77_15_77_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_15_77_18&#39;)"><span class="hl_condecl"><span class="mpre">Put</span></span></a><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">PutStep</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">PutStep</span></span><span class="mpre">)

data </span><a name="loc_79_6_79_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_79_6_79_15&#39;)"><span class="hl_tycondecl"><span class="mpre">PutSignal</span></span></a><span class="mpre"> =
    </span><a name="loc_80_5_80_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_5_80_9&#39;)"><span class="hl_condecl"><span class="mpre">Done</span></span></a><span class="mpre"> {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)
  | </span><a name="loc_81_5_81_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_5_81_15&#39;)"><span class="hl_condecl"><span class="mpre">BufferFull</span></span></a><span class="mpre">
      {-# UNPACK #-} !</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
      {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)
                     !</span><span class="hl_tyconref"><span class="mpre">PutStep</span></span><span class="mpre">
  | </span><a name="loc_85_5_85_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_5_85_17&#39;)"><span class="hl_condecl"><span class="mpre">ModifyChunks</span></span></a><span class="mpre">
      {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">) 
                     !(</span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">) 
                     !</span><span class="hl_tyconref"><span class="mpre">PutStep</span></span><span class="mpre">

</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/benchmarks/BuilderBufferRange.hs&quot;, srcSpanStartLine = 90, srcSpanStartColumn = 1, srcSpanEndLine = 90, srcSpanEndColumn = 44}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/benchmarks/BuilderBufferRange.hs&quot;, srcSpanStartLine = 90, srcSpanStartColumn = 1, srcSpanEndLine = 90, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3."><span class="mpre">type PutStep =  BufferRange -&gt; IO PutSignal</span></span><span class="mpre">

instance </span><a href="Data.Monoid.html#loc_79_7_79_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_79_7_79_13&#39;)"><span class="hl_classref"><span class="mpre">Monoid</span></span></a><span class="mpre"> </span><a href="#loc_77_9_77_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_9_77_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> where
  </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_vardecl"><span class="mpre">mempty</span></span></a><span class="mpre"> = </span><a href="#loc_77_15_77_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_15_77_18&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">id</span></span><span class="mpre">
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="mpre">mempty</span></a><span class="mpre"> #-}</span></span><span class="mpre">
  (</span><a href="#loc_77_15_77_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_15_77_18&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_95_8_95_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_8_95_10&#39;)"><span class="hl_vardecl"><span class="mpre">p1</span></span></a><span class="mpre">) </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_fundecl"><span class="mpre">`mappend`</span></span></a><span class="mpre"> (</span><a href="#loc_77_15_77_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_15_77_18&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_95_27_95_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_27_95_29&#39;)"><span class="hl_vardecl"><span class="mpre">p2</span></span></a><span class="mpre">) = </span><a href="#loc_77_15_77_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_15_77_18&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_95_8_95_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_8_95_10&#39;)"><span class="hl_varref"><span class="mpre">p1</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_95_27_95_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_27_95_29&#39;)"><span class="hl_varref"><span class="mpre">p2</span></span></a><span class="mpre">
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="mpre">mappend</span></a><span class="mpre"> #-}</span></span><span class="mpre">
  </span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="hl_vardecl"><span class="mpre">mconcat</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">foldr</span></span><span class="mpre"> </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_varref"><span class="mpre">mappend</span></span></a><span class="mpre"> </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre">
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="mpre">mconcat</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><a href="#loc_101_1_101_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_1_101_9&#39;)"><span class="mpre">putWrite</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Write</span></span><span class="mpre"> -&gt; </span><a href="#loc_77_9_77_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_9_77_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre">
</span><a name="loc_101_1_101_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_1_101_9&#39;)"><span class="hl_fundecl"><span class="mpre">putWrite</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Write</span></span><span class="mpre"> </span><a name="loc_101_17_101_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_17_101_21&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre"> </span><a name="loc_101_22_101_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_22_101_24&#39;)"><span class="hl_vardecl"><span class="mpre">io</span></span></a><span class="mpre">) =
    </span><a href="#loc_77_15_77_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_15_77_18&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a href="#loc_104_5_104_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_5_104_9&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre">
  where
    </span><a name="loc_104_5_104_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_5_104_9&#39;)"><span class="hl_fundecl"><span class="mpre">step</span></span></a><span class="mpre"> </span><a name="loc_104_10_104_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_10_104_11&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> (</span><a href="#loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_conref"><span class="mpre">BR</span></span></a><span class="mpre"> </span><a name="loc_104_16_104_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_16_104_18&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> </span><a name="loc_104_19_104_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_19_104_21&#39;)"><span class="hl_vardecl"><span class="mpre">pe</span></span></a><span class="mpre">)
      | </span><a href="#loc_104_16_104_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_16_104_18&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_101_17_101_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_17_101_21&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_104_19_104_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_19_104_21&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre"> = do
          </span><a href="#loc_101_22_101_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_22_101_24&#39;)"><span class="hl_varref"><span class="mpre">io</span></span></a><span class="mpre"> </span><a href="#loc_104_16_104_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_16_104_18&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">
          let !</span><a name="loc_107_16_107_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_107_16_107_19&#39;)"><span class="hl_vardecl"><span class="mpre">br&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_conref"><span class="mpre">BR</span></span></a><span class="mpre"> (</span><a href="#loc_104_16_104_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_16_104_18&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_101_17_101_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_17_101_21&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">) </span><a href="#loc_104_19_104_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_19_104_21&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre">
          </span><a href="#loc_104_10_104_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_10_104_11&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_107_16_107_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_107_16_107_19&#39;)"><span class="hl_varref"><span class="mpre">br&#39;</span></span></a><span class="mpre">
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_81_5_81_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_5_81_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre"> </span><a href="#loc_101_17_101_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_17_101_21&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre"> </span><a href="#loc_104_16_104_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_16_104_18&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> (</span><a href="#loc_104_5_104_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_5_104_9&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_104_10_104_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_10_104_11&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_101_1_101_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_1_101_9&#39;)"><span class="mpre">putWrite</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><a href="#loc_113_1_113_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_18&#39;)"><span class="mpre">putWriteSingleton</span></a><span class="mpre"> :: (</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Write</span></span><span class="mpre">) -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><a href="#loc_77_9_77_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_9_77_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre">
</span><a name="loc_113_1_113_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_18&#39;)"><span class="hl_fundecl"><span class="mpre">putWriteSingleton</span></span></a><span class="mpre"> </span><a name="loc_113_19_113_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_19_113_24&#39;)"><span class="hl_vardecl"><span class="mpre">write</span></span></a><span class="mpre"> = 
    </span><a href="#loc_116_5_116_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_116_5_116_10&#39;)"><span class="hl_varref"><span class="mpre">mkPut</span></span></a><span class="mpre">
  where
    </span><a name="loc_116_5_116_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_116_5_116_10&#39;)"><span class="hl_fundecl"><span class="mpre">mkPut</span></span></a><span class="mpre"> </span><a name="loc_116_11_116_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_116_11_116_12&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> = </span><a href="#loc_77_15_77_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_15_77_18&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a href="#loc_118_9_118_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_9_118_13&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre">
      where
        </span><a name="loc_118_9_118_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_9_118_13&#39;)"><span class="hl_fundecl"><span class="mpre">step</span></span></a><span class="mpre"> </span><a name="loc_118_14_118_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_14_118_15&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> (</span><a href="#loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_conref"><span class="mpre">BR</span></span></a><span class="mpre"> </span><a name="loc_118_20_118_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_20_118_22&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> </span><a name="loc_118_23_118_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_23_118_25&#39;)"><span class="hl_vardecl"><span class="mpre">pe</span></span></a><span class="mpre">)
          | </span><a href="#loc_118_20_118_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_20_118_22&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_125_19_125_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_19_125_23&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_118_23_118_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_23_118_25&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre"> = do
              </span><a href="#loc_125_24_125_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_24_125_26&#39;)"><span class="hl_varref"><span class="mpre">io</span></span></a><span class="mpre"> </span><a href="#loc_118_20_118_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_20_118_22&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">
              let !</span><a name="loc_121_20_121_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_20_121_23&#39;)"><span class="hl_vardecl"><span class="mpre">br&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_conref"><span class="mpre">BR</span></span></a><span class="mpre"> (</span><a href="#loc_118_20_118_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_20_118_22&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_125_19_125_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_19_125_23&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">) </span><a href="#loc_118_23_118_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_23_118_25&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre">
              </span><a href="#loc_118_14_118_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_14_118_15&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_121_20_121_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_20_121_23&#39;)"><span class="hl_varref"><span class="mpre">br&#39;</span></span></a><span class="mpre">
          | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">               = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_81_5_81_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_5_81_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre"> </span><a href="#loc_125_19_125_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_19_125_23&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre"> </span><a href="#loc_118_20_118_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_20_118_22&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> (</span><a href="#loc_118_9_118_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_9_118_13&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_118_14_118_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_14_118_15&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">)
          where
            </span><span class="hl_conref"><span class="mpre">Write</span></span><span class="mpre"> </span><a name="loc_125_19_125_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_19_125_23&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre"> </span><a name="loc_125_24_125_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_24_125_26&#39;)"><span class="hl_vardecl"><span class="mpre">io</span></span></a><span class="mpre"> = </span><a href="#loc_113_19_113_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_19_113_24&#39;)"><span class="hl_varref"><span class="mpre">write</span></span></a><span class="mpre"> </span><a href="#loc_116_11_116_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_116_11_116_12&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_113_1_113_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_18&#39;)"><span class="mpre">putWriteSingleton</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><a href="#loc_129_1_129_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_1_129_11&#39;)"><span class="mpre">putBuilder</span></a><span class="mpre"> :: </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">B.Builder</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_77_9_77_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_9_77_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre">
</span><a name="loc_129_1_129_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_1_129_11&#39;)"><span class="hl_fundecl"><span class="mpre">putBuilder</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">B.Builder</span></span><span class="mpre"> </span><a name="loc_129_23_129_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_23_129_24&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">) = 
    </span><a href="#loc_77_15_77_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_15_77_18&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a href="#loc_134_5_134_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_5_134_9&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre">
  where
    </span><a name="loc_132_5_132_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_132_5_132_14&#39;)"><span class="hl_fundecl"><span class="mpre">finalStep</span></span></a><span class="mpre"> _ </span><a name="loc_132_17_132_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_132_17_132_19&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">B.Done</span></span><span class="mpre"> </span><a href="#loc_132_17_132_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_132_17_132_19&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">

    </span><a name="loc_134_5_134_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_5_134_9&#39;)"><span class="hl_fundecl"><span class="mpre">step</span></span></a><span class="mpre"> </span><a name="loc_134_10_134_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_10_134_11&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> = </span><a href="#loc_136_9_136_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_9_136_11&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_129_23_129_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_23_129_24&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><a href="#loc_132_5_132_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_132_5_132_14&#39;)"><span class="hl_varref"><span class="mpre">finalStep</span></span></a><span class="mpre">)
      where
        </span><a name="loc_136_9_136_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_9_136_11&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> </span><a name="loc_136_12_136_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_12_136_21&#39;)"><span class="hl_vardecl"><span class="mpre">buildStep</span></span></a><span class="mpre"> (</span><a href="#loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_conref"><span class="mpre">BR</span></span></a><span class="mpre"> </span><a name="loc_136_26_136_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_26_136_28&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> </span><a name="loc_136_29_136_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_29_136_31&#39;)"><span class="hl_vardecl"><span class="mpre">pe</span></span></a><span class="mpre">) = do
          </span><a name="loc_137_11_137_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_11_137_17&#39;)"><span class="hl_vardecl"><span class="mpre">signal</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_136_12_136_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_12_136_21&#39;)"><span class="hl_varref"><span class="mpre">buildStep</span></span></a><span class="mpre"> </span><a href="#loc_136_26_136_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_26_136_28&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><a href="#loc_136_29_136_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_29_136_31&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre">
          case </span><a href="#loc_137_11_137_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_11_137_17&#39;)"><span class="hl_varref"><span class="mpre">signal</span></span></a><span class="mpre"> of
            </span><span class="hl_conref"><span class="mpre">B.Done</span></span><span class="mpre"> </span><a name="loc_139_20_139_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_20_139_23&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> -&gt; do
              let !</span><a name="loc_140_20_140_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_140_20_140_23&#39;)"><span class="hl_vardecl"><span class="mpre">br&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_conref"><span class="mpre">BR</span></span></a><span class="mpre"> </span><a href="#loc_139_20_139_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_20_139_23&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a href="#loc_136_29_136_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_29_136_31&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre">
              </span><a href="#loc_134_10_134_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_10_134_11&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_140_20_140_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_140_20_140_23&#39;)"><span class="hl_varref"><span class="mpre">br&#39;</span></span></a><span class="mpre">
            </span><span class="hl_conref"><span class="mpre">B.BufferFull</span></span><span class="mpre"> </span><a name="loc_142_26_142_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_26_142_33&#39;)"><span class="hl_vardecl"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a name="loc_142_34_142_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_34_142_37&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a name="loc_142_38_142_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_38_142_51&#39;)"><span class="hl_vardecl"><span class="mpre">nextBuildStep</span></span></a><span class="mpre"> -&gt; 
              </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_81_5_81_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_5_81_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre"> </span><a href="#loc_142_26_142_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_26_142_33&#39;)"><span class="hl_varref"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a href="#loc_142_34_142_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_34_142_37&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> (</span><a href="#loc_136_9_136_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_9_136_11&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_142_38_142_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_38_142_51&#39;)"><span class="hl_varref"><span class="mpre">nextBuildStep</span></span></a><span class="mpre">)
            </span><span class="hl_conref"><span class="mpre">B.ModifyChunks</span></span><span class="mpre"> _ _ _ -&gt; 
              </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;putBuilder: ModifyChunks not implemented&quot;</span></span><span class="mpre">

</span><a href="#loc_148_1_148_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_1_148_9&#39;)"><span class="mpre">putWord8</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre"> -&gt; </span><a href="#loc_77_9_77_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_9_77_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre">
</span><a name="loc_148_1_148_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_1_148_9&#39;)"><span class="hl_vardecl"><span class="mpre">putWord8</span></span></a><span class="mpre"> = </span><a href="#loc_113_1_113_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_18&#39;)"><span class="hl_varref"><span class="mpre">putWriteSingleton</span></span></a><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Word.html#loc_117_1_117_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Word.html#loc_117_1_117_11&#39;)"><span class="hl_varref"><span class="mpre">writeWord8</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">{-
  m &gt;&gt;= f  = GetC $ \done empty pe -&gt;
      runGetC m (\pr&#39; x -&gt; runGetC (f x) done empty pe pr&#39;) 
                (\m&#39; -&gt; empty (m&#39; &gt;&gt;= f))
                pe


newtype GetC r a = GetC {
    runGetC ::
      (Ptr Word8 -&gt; a -&gt; IO r) -&gt;   -- done
      (GetC r a -&gt; IO r     )  -&gt;   -- empty buffer
      Ptr Word8                -&gt;   -- end of buffer
      Ptr Word8                -&gt;   -- next byte to read
      IO r
  }

instance Functor (GetC r) where
  fmap f g = GetC $ \done empty -&gt;
      runGetC g (\pr&#39; x -&gt; done pr&#39; (f x)) 
                (\g&#39;    -&gt; empty (fmap f g&#39;))

instance Monad (GetC r) where
  return x = GetC $ \done _ _ pr -&gt; done pr x
  m &gt;&gt;= f  = GetC $ \done empty pe -&gt;
      runGetC m (\pr&#39; x -&gt; runGetC (f x) done empty pe pr&#39;) 
                (\m&#39; -&gt; empty (m&#39; &gt;&gt;= f))
                pe

-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Internal global constants.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Default size (~32kb) for the buffer that becomes a chunk of the output</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- stream once it is filled.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_188_1_188_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_1_188_18&#39;)"><span class="mpre">defaultBufferSize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_188_1_188_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_1_188_18&#39;)"><span class="hl_vardecl"><span class="mpre">defaultBufferSize</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">32</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1024</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><a href="#loc_189_11_189_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_11_189_19&#39;)"><span class="hl_varref"><span class="mpre">overhead</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- Copied from Data.ByteString.Lazy.</span></span><span class="mpre">
    where </span><a name="loc_189_11_189_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_11_189_19&#39;)"><span class="hl_vardecl"><span class="mpre">overhead</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">sizeOf</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">undefined</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | The minimal length (~4kb) a buffer must have before filling it and</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- outputting it as a chunk of the output stream. </span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This size determines when a buffer is spilled after a &#39;flush&#39; or a direct</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- bytestring insertion. It is also the size of the first chunk generated by</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;toLazyByteString&#39;.</span></span><span class="mpre">
</span><a href="#loc_198_1_198_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_1_198_25&#39;)"><span class="mpre">defaultMinimalBufferSize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_198_1_198_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_1_198_25&#39;)"><span class="hl_vardecl"><span class="mpre">defaultMinimalBufferSize</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">4</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1024</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><a href="#loc_199_11_199_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_199_11_199_19&#39;)"><span class="hl_varref"><span class="mpre">overhead</span></span></a><span class="mpre">
    where </span><a name="loc_199_11_199_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_199_11_199_19&#39;)"><span class="hl_vardecl"><span class="mpre">overhead</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">sizeOf</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">undefined</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | The default length (64) for the first buffer to be allocated when</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- converting a &#39;Builder&#39; to a lazy bytestring. </span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- See &#39;toLazyByteStringWith&#39; for further explanation.</span></span><span class="mpre">
</span><a href="#loc_206_1_206_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_1_206_23&#39;)"><span class="mpre">defaultFirstBufferSize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_206_1_206_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_1_206_23&#39;)"><span class="hl_vardecl"><span class="mpre">defaultFirstBufferSize</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">64</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The maximal number of bytes for that copying is cheaper than direct</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- insertion into the output stream. This takes into account the fragmentation</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- that may occur in the output buffer due to the early &#39;flush&#39; implied by the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- direct bytestring insertion.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @&#39;defaultMaximalCopySize&#39; = 2 * &#39;defaultMinimalBufferSize&#39;@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_216_1_216_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_1_216_23&#39;)"><span class="mpre">defaultMaximalCopySize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_216_1_216_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_1_216_23&#39;)"><span class="hl_vardecl"><span class="mpre">defaultMaximalCopySize</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><a href="#loc_198_1_198_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_1_198_25&#39;)"><span class="hl_varref"><span class="mpre">defaultMinimalBufferSize</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Flushing and running a Builder</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | Output all data written in the current buffer and start a new chunk.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The use uf this function depends on how the resulting bytestrings are</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- consumed. &#39;flush&#39; is possibly not very useful in non-interactive scenarios.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- However, it is kept for compatibility with the builder provided by</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Data.Binary.Builder.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- When using &#39;toLazyByteString&#39; to extract a lazy &#39;L.ByteString&#39; from a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;Builder&#39;, this means that a new chunk will be started in the resulting lazy</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;L.ByteString&#39;. The remaining part of the buffer is spilled, if the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- reamining free space is smaller than the minimal desired buffer size.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">{-
flush :: Builder
flush = Builder $ \k pf _ -&gt; return $ ModifyChunks pf id k
-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run a &#39;Builder&#39; with the given buffer sizes.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Use this function for integrating the &#39;Builder&#39; type with other libraries</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- that generate lazy bytestrings.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that the builders should guarantee that on average the desired chunk</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- size is attained. Builders may decide to start a new buffer and not</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- completely fill the existing buffer, if this is faster. However, they should</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- not spill too much of the buffer, if they cannot compensate for it.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- A call @toLazyByteStringWith bufSize minBufSize firstBufSize@ will generate</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- a lazy bytestring according to the following strategy. First, we allocate</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- a buffer of size @firstBufSize@ and start filling it. If it overflows, we</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- allocate a buffer of size @minBufSize@ and copy the first buffer to it in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- order to avoid generating a too small chunk. Finally, every next buffer will</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- be of size @bufSize@. This, slow startup strategy is required to achieve</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- good speed for short (&lt;200 bytes) resulting bytestrings, as for them the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- allocation cost is of a large buffer cannot be compensated. Moreover, this</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- strategy also allows us to avoid spilling too much memory for short</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- resulting bytestrings.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that setting @firstBufSize &gt;= minBufSize@ implies that the first buffer</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- is no longer copied but allocated and filled directly. Hence, setting</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @firstBufSize = bufSize@ means that all chunks will use an underlying buffer</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- of size @bufSize@. This is recommended, if you know that you always output</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- more than @minBufSize@ bytes.</span></span><span class="mpre">
</span><a href="#loc_278_1_278_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_1_278_21&#39;)"><span class="mpre">toLazyByteStringWith</span></a><span class="mpre"> 
    :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">           </span><span class="hl_comment"><span class="mpre">-- ^ Buffer size (upper-bounds the resulting chunk size).</span></span><span class="mpre">
    -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">           </span><span class="hl_comment"><span class="mpre">-- ^ Minimal free buffer space for continuing filling</span></span><span class="mpre">
                     </span><span class="hl_comment"><span class="mpre">-- the same buffer after a &#39;flush&#39; or a direct bytestring</span></span><span class="mpre">
                     </span><span class="hl_comment"><span class="mpre">-- insertion. This corresponds to the minimal desired</span></span><span class="mpre">
                     </span><span class="hl_comment"><span class="mpre">-- chunk size.</span></span><span class="mpre">
    -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">           </span><span class="hl_comment"><span class="mpre">-- ^ Size of the first buffer to be used and copied for</span></span><span class="mpre">
                     </span><span class="hl_comment"><span class="mpre">-- larger resulting sequences</span></span><span class="mpre">
    -&gt; </span><a href="#loc_77_9_77_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_9_77_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre">           </span><span class="hl_comment"><span class="mpre">-- ^ Builder to run.</span></span><span class="mpre">
    -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- ^ Lazy bytestring to output after the builder is</span></span><span class="mpre">
                     </span><span class="hl_comment"><span class="mpre">-- finished.</span></span><span class="mpre">
    -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- ^ Resulting lazy bytestring</span></span><span class="mpre">
</span><a name="loc_278_1_278_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_1_278_21&#39;)"><span class="hl_fundecl"><span class="mpre">toLazyByteStringWith</span></span></a><span class="mpre"> </span><a name="loc_278_22_278_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_22_278_29&#39;)"><span class="hl_vardecl"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a name="loc_278_30_278_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_30_278_40&#39;)"><span class="hl_vardecl"><span class="mpre">minBufSize</span></span></a><span class="mpre"> </span><a name="loc_278_41_278_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_41_278_53&#39;)"><span class="hl_vardecl"><span class="mpre">firstBufSize</span></span></a><span class="mpre"> (</span><a href="#loc_77_15_77_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_15_77_18&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_278_59_278_60" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_59_278_60&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">) </span><a name="loc_278_62_278_63" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_62_278_63&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> = 
    </span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_286_5_286_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_286_5_286_20&#39;)"><span class="hl_varref"><span class="mpre">fillFirstBuffer</span></span></a><span class="mpre"> (</span><a href="#loc_278_59_278_60" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_59_278_60&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><a href="#loc_281_5_281_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_281_5_281_14&#39;)"><span class="hl_varref"><span class="mpre">finalStep</span></span></a><span class="mpre">)
  where
    </span><a name="loc_281_5_281_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_281_5_281_14&#39;)"><span class="hl_fundecl"><span class="mpre">finalStep</span></span></a><span class="mpre"> (</span><a href="#loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_conref"><span class="mpre">BR</span></span></a><span class="mpre"> </span><a name="loc_281_19_281_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_281_19_281_21&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_80_5_80_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_5_80_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a href="#loc_281_19_281_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_281_19_281_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- fill a first very small buffer, if we need more space then copy it</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- to the new buffer of size &#39;minBufSize&#39;. This way we don&#39;t pay the</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- allocation cost of the big &#39;bufSize&#39; buffer, when outputting only</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- small sequences.</span></span><span class="mpre">
    </span><a name="loc_286_5_286_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_286_5_286_20&#39;)"><span class="hl_fundecl"><span class="mpre">fillFirstBuffer</span></span></a><span class="mpre"> !</span><a name="loc_286_22_286_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_286_22_286_27&#39;)"><span class="hl_vardecl"><span class="mpre">step0</span></span></a><span class="mpre">
      | </span><a href="#loc_278_30_278_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_30_278_40&#39;)"><span class="hl_varref"><span class="mpre">minBufSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_278_41_278_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_41_278_53&#39;)"><span class="hl_varref"><span class="mpre">firstBufSize</span></span></a><span class="mpre"> = </span><a href="#loc_316_5_316_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_5_316_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> </span><a href="#loc_278_41_278_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_41_278_53&#39;)"><span class="hl_varref"><span class="mpre">firstBufSize</span></span></a><span class="mpre"> </span><a href="#loc_286_22_286_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_286_22_286_27&#39;)"><span class="hl_varref"><span class="mpre">step0</span></span></a><span class="mpre">
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                  = do
          </span><a name="loc_289_11_289_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_11_289_16&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> &lt;- </span><a href="Data.ByteString.Internal.html#loc_489_1_489_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_489_1_489_17&#39;)"><span class="hl_varref"><span class="mpre">S.mallocByteString</span></span></a><span class="mpre"> </span><a href="#loc_278_41_278_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_41_278_53&#39;)"><span class="hl_varref"><span class="mpre">firstBufSize</span></span></a><span class="mpre">
          </span><span class="hl_varref"><span class="mpre">withForeignPtr</span></span><span class="mpre"> </span><a href="#loc_289_11_289_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_11_289_16&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_290_35_290_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_35_290_37&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> -&gt; do
              let !</span><a name="loc_291_20_291_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_291_20_291_22&#39;)"><span class="hl_vardecl"><span class="mpre">br</span></span></a><span class="mpre">      = </span><a href="#loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_conref"><span class="mpre">BR</span></span></a><span class="mpre"> </span><a href="#loc_290_35_290_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_35_290_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> (</span><a href="#loc_290_35_290_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_35_290_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_278_41_278_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_41_278_53&#39;)"><span class="hl_varref"><span class="mpre">firstBufSize</span></span></a><span class="mpre">)
                  </span><a name="loc_292_19_292_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_292_19_292_23&#39;)"><span class="hl_fundecl"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a name="loc_292_24_292_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_292_24_292_27&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> = </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_289_11_289_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_11_289_16&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> (</span><a href="#loc_292_24_292_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_292_24_292_27&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_290_35_290_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_35_290_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">)
                  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_292_19_292_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_292_19_292_23&#39;)"><span class="mpre">mkbs</span></a><span class="mpre"> #-}</span></span><span class="mpre">
              </span><a name="loc_294_15_294_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_294_15_294_19&#39;)"><span class="hl_vardecl"><span class="mpre">next</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_286_22_286_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_286_22_286_27&#39;)"><span class="hl_varref"><span class="mpre">step0</span></span></a><span class="mpre"> </span><a href="#loc_291_20_291_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_291_20_291_22&#39;)"><span class="hl_varref"><span class="mpre">br</span></span></a><span class="mpre">
              case </span><a href="#loc_294_15_294_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_294_15_294_19&#39;)"><span class="hl_varref"><span class="mpre">next</span></span></a><span class="mpre"> of
                  </span><a href="#loc_80_5_80_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_5_80_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a name="loc_296_24_296_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_296_24_296_27&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre">
                    | </span><a href="#loc_296_24_296_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_296_24_296_27&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_290_35_290_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_35_290_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_278_62_278_63" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_62_278_63&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
                    | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_292_19_292_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_292_19_292_23&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_296_24_296_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_296_24_296_27&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">) </span><a href="#loc_278_62_278_63" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_62_278_63&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">

                  </span><a href="#loc_81_5_81_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_5_81_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre"> </span><a name="loc_300_30_300_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_30_300_37&#39;)"><span class="hl_vardecl"><span class="mpre">newSize</span></span></a><span class="mpre"> </span><a name="loc_300_38_300_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_38_300_41&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a name="loc_300_42_300_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_42_300_50&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre">  -&gt; do
                      let !</span><a name="loc_301_28_301_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_28_301_29&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">  = </span><a href="#loc_300_38_300_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_38_300_41&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_290_35_290_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_35_290_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">
                      </span><a href="#loc_316_5_316_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_5_316_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">max</span></span><span class="mpre"> (</span><a href="#loc_301_28_301_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_28_301_29&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><a href="#loc_300_30_300_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_30_300_37&#39;)"><span class="hl_varref"><span class="mpre">newSize</span></span></a><span class="mpre">) </span><a href="#loc_278_30_278_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_30_278_40&#39;)"><span class="hl_varref"><span class="mpre">minBufSize</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
                          \(</span><a href="#loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_conref"><span class="mpre">BR</span></span></a><span class="mpre"> </span><a name="loc_303_32_303_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_303_32_303_37&#39;)"><span class="hl_vardecl"><span class="mpre">pfNew</span></span></a><span class="mpre"> </span><a name="loc_303_38_303_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_303_38_303_43&#39;)"><span class="hl_vardecl"><span class="mpre">peNew</span></span></a><span class="mpre">) -&gt; do
                              </span><span class="hl_varref"><span class="mpre">copyBytes</span></span><span class="mpre"> </span><a href="#loc_303_32_303_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_303_32_303_37&#39;)"><span class="hl_varref"><span class="mpre">pfNew</span></span></a><span class="mpre"> </span><a href="#loc_290_35_290_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_35_290_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><a href="#loc_301_28_301_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_28_301_29&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">
                              let !</span><a name="loc_305_36_305_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_305_36_305_41&#39;)"><span class="hl_vardecl"><span class="mpre">brNew</span></span></a><span class="mpre"> = </span><a href="#loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_conref"><span class="mpre">BR</span></span></a><span class="mpre"> (</span><a href="#loc_303_32_303_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_303_32_303_37&#39;)"><span class="hl_varref"><span class="mpre">pfNew</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_301_28_301_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_301_28_301_29&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">) </span><a href="#loc_303_38_303_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_303_38_303_43&#39;)"><span class="hl_varref"><span class="mpre">peNew</span></span></a><span class="mpre">
                              </span><a href="#loc_300_42_300_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_300_42_300_50&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre"> </span><a href="#loc_305_36_305_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_305_36_305_41&#39;)"><span class="hl_varref"><span class="mpre">brNew</span></span></a><span class="mpre">
                      
                  </span><a href="#loc_85_5_85_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_5_85_17&#39;)"><span class="hl_conref"><span class="mpre">ModifyChunks</span></span></a><span class="mpre"> </span><a name="loc_308_32_308_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_32_308_35&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a name="loc_308_36_308_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_36_308_39&#39;)"><span class="hl_vardecl"><span class="mpre">bsk</span></span></a><span class="mpre"> </span><a name="loc_308_40_308_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_40_308_48&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre"> 
                      | </span><a href="#loc_308_32_308_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_32_308_35&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_290_35_290_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_290_35_290_37&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> -&gt;
                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_308_36_308_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_36_308_39&#39;)"><span class="hl_varref"><span class="mpre">bsk</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_316_5_316_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_5_316_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> </span><a href="#loc_278_22_278_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_22_278_29&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a href="#loc_308_40_308_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_40_308_48&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">)
                      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> -&gt;
                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_292_19_292_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_292_19_292_23&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_308_32_308_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_32_308_35&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">)
                              (</span><a href="#loc_308_36_308_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_36_308_39&#39;)"><span class="hl_varref"><span class="mpre">bsk</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_316_5_316_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_5_316_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> </span><a href="#loc_278_22_278_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_22_278_29&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a href="#loc_308_40_308_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_308_40_308_48&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">))
                    
    </span><span class="hl_comment"><span class="mpre">-- allocate and fill a new buffer</span></span><span class="mpre">
    </span><a name="loc_316_5_316_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_5_316_18&#39;)"><span class="hl_fundecl"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> !</span><a name="loc_316_20_316_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_20_316_24&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre"> !</span><a name="loc_316_26_316_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_26_316_31&#39;)"><span class="hl_vardecl"><span class="mpre">step0</span></span></a><span class="mpre"> = do
        </span><a name="loc_317_9_317_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_9_317_14&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> &lt;- </span><a href="Data.ByteString.Internal.html#loc_489_1_489_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_489_1_489_17&#39;)"><span class="hl_varref"><span class="mpre">S.mallocByteString</span></span></a><span class="mpre"> </span><a href="#loc_316_20_316_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_20_316_24&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">withForeignPtr</span></span><span class="mpre"> </span><a href="#loc_317_9_317_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_9_317_14&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_320_9_320_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_9_320_19&#39;)"><span class="hl_varref"><span class="mpre">fillBuffer</span></span></a><span class="mpre"> </span><a href="#loc_317_9_317_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_9_317_14&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">
      where
        </span><a name="loc_320_9_320_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_9_320_19&#39;)"><span class="hl_fundecl"><span class="mpre">fillBuffer</span></span></a><span class="mpre"> </span><a name="loc_320_20_320_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_20_320_25&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> !</span><a name="loc_320_27_320_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_27_320_31&#39;)"><span class="hl_vardecl"><span class="mpre">pbuf</span></span></a><span class="mpre"> = </span><a href="#loc_323_13_323_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_13_323_17&#39;)"><span class="hl_varref"><span class="mpre">fill</span></span></a><span class="mpre"> </span><a href="#loc_320_27_320_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_27_320_31&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre"> </span><a href="#loc_316_26_316_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_26_316_31&#39;)"><span class="hl_varref"><span class="mpre">step0</span></span></a><span class="mpre">
          where
            !</span><a name="loc_322_14_322_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_14_322_16&#39;)"><span class="hl_vardecl"><span class="mpre">pe</span></span></a><span class="mpre"> = </span><a href="#loc_320_27_320_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_27_320_31&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_316_20_316_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_20_316_24&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">
            </span><a name="loc_323_13_323_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_13_323_17&#39;)"><span class="hl_fundecl"><span class="mpre">fill</span></span></a><span class="mpre"> !</span><a name="loc_323_19_323_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_19_323_21&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> !</span><a name="loc_323_23_323_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_23_323_27&#39;)"><span class="hl_vardecl"><span class="mpre">step</span></span></a><span class="mpre"> = do
                let !</span><a name="loc_324_22_324_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_324_22_324_24&#39;)"><span class="hl_vardecl"><span class="mpre">br</span></span></a><span class="mpre"> = </span><a href="#loc_74_20_74_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_20_74_22&#39;)"><span class="hl_conref"><span class="mpre">BR</span></span></a><span class="mpre"> </span><a href="#loc_323_19_323_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_19_323_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><a href="#loc_322_14_322_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_14_322_16&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre">
                </span><a name="loc_325_17_325_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_325_17_325_21&#39;)"><span class="hl_vardecl"><span class="mpre">next</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_323_23_323_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_23_323_27&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_324_22_324_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_324_22_324_24&#39;)"><span class="hl_varref"><span class="mpre">br</span></span></a><span class="mpre">
                let </span><a name="loc_326_21_326_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_326_21_326_25&#39;)"><span class="hl_fundecl"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a name="loc_326_26_326_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_326_26_326_29&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> = </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_320_20_320_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_20_320_25&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> (</span><a href="#loc_323_19_323_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_19_323_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_320_27_320_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_320_27_320_31&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre">) (</span><a href="#loc_326_26_326_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_326_26_326_29&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_323_19_323_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_19_323_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">)
                    </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_326_21_326_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_326_21_326_25&#39;)"><span class="mpre">mkbs</span></a><span class="mpre"> #-}</span></span><span class="mpre">
                case </span><a href="#loc_325_17_325_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_325_17_325_21&#39;)"><span class="hl_varref"><span class="mpre">next</span></span></a><span class="mpre"> of
                    </span><a href="#loc_80_5_80_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_5_80_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a name="loc_329_26_329_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_329_26_329_29&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre">
                      | </span><a href="#loc_329_26_329_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_329_26_329_29&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_323_19_323_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_19_323_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_278_62_278_63" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_62_278_63&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
                      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_326_21_326_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_326_21_326_25&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_329_26_329_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_329_26_329_29&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">) </span><a href="#loc_278_62_278_63" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_62_278_63&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">

                    </span><a href="#loc_81_5_81_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_5_81_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre"> </span><a name="loc_333_32_333_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_32_333_39&#39;)"><span class="hl_vardecl"><span class="mpre">newSize</span></span></a><span class="mpre"> </span><a name="loc_333_40_333_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_40_333_43&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a name="loc_333_44_333_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_44_333_52&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre"> -&gt;
                        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_326_21_326_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_326_21_326_25&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_333_40_333_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_40_333_43&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">)
                            (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> 
                                </span><a href="#loc_316_5_316_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_5_316_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">max</span></span><span class="mpre"> </span><a href="#loc_333_32_333_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_32_333_39&#39;)"><span class="hl_varref"><span class="mpre">newSize</span></span></a><span class="mpre"> </span><a href="#loc_278_22_278_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_22_278_29&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre">) </span><a href="#loc_333_44_333_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_44_333_52&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">)
                        
                    </span><a href="#loc_85_5_85_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_5_85_17&#39;)"><span class="hl_conref"><span class="mpre">ModifyChunks</span></span></a><span class="mpre">  </span><a name="loc_338_35_338_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_35_338_38&#39;)"><span class="hl_vardecl"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a name="loc_338_39_338_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_39_338_42&#39;)"><span class="hl_vardecl"><span class="mpre">bsk</span></span></a><span class="mpre"> </span><a name="loc_338_43_338_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_43_338_51&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre">
                      | </span><a href="#loc_338_35_338_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_35_338_38&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_323_19_323_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_19_323_21&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre">                      -&gt;
                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_338_39_338_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_39_338_42&#39;)"><span class="hl_varref"><span class="mpre">bsk</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_323_13_323_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_13_323_17&#39;)"><span class="hl_varref"><span class="mpre">fill</span></span></a><span class="mpre"> </span><a href="#loc_338_35_338_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_35_338_38&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a href="#loc_338_43_338_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_43_338_51&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">)
                      | </span><a href="#loc_278_30_278_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_30_278_40&#39;)"><span class="hl_varref"><span class="mpre">minBufSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><a href="#loc_322_14_322_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_322_14_322_16&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_338_35_338_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_35_338_38&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> -&gt;
                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_326_21_326_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_326_21_326_25&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_338_35_338_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_35_338_38&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">)
                              (</span><a href="#loc_338_39_338_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_39_338_42&#39;)"><span class="hl_varref"><span class="mpre">bsk</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_323_13_323_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_323_13_323_17&#39;)"><span class="hl_varref"><span class="mpre">fill</span></span></a><span class="mpre"> </span><a href="#loc_338_35_338_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_35_338_38&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre"> </span><a href="#loc_338_43_338_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_43_338_51&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">))
                      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                      -&gt;
                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><a href="#loc_326_21_326_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_326_21_326_25&#39;)"><span class="hl_varref"><span class="mpre">mkbs</span></span></a><span class="mpre"> </span><a href="#loc_338_35_338_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_35_338_38&#39;)"><span class="hl_varref"><span class="mpre">pf&#39;</span></span></a><span class="mpre">)
                              (</span><a href="#loc_338_39_338_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_39_338_42&#39;)"><span class="hl_varref"><span class="mpre">bsk</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_316_5_316_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_316_5_316_18&#39;)"><span class="hl_varref"><span class="mpre">fillNewBuffer</span></span></a><span class="mpre"> </span><a href="#loc_278_22_278_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_22_278_29&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a href="#loc_338_43_338_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_338_43_338_51&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">))


</span><span class="hl_comment"><span class="mpre">-- | Extract the lazy &#39;L.ByteString&#39; from the builder by running it with default</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- buffer sizes. Use this function, if you do not have any special</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- considerations with respect to buffer sizes.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @ &#39;toLazyByteString&#39; b = &#39;toLazyByteStringWith&#39; &#39;defaultBufferSize&#39; &#39;defaultMinimalBufferSize&#39; &#39;defaultFirstBufferSize&#39; b L.empty@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that @&#39;toLazyByteString&#39;@ is a &#39;Monoid&#39; homomorphism.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; toLazyByteString mempty          == mempty</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; toLazyByteString (x `mappend` y) == toLazyByteString x `mappend` toLazyByteString y</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- However, in the second equation, the left-hand-side is generally faster to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- execute.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_364_1_364_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_17&#39;)"><span class="mpre">toLazyByteString</span></a><span class="mpre"> :: </span><a href="#loc_77_9_77_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_9_77_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
</span><a name="loc_364_1_364_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_17&#39;)"><span class="hl_fundecl"><span class="mpre">toLazyByteString</span></span></a><span class="mpre"> </span><a name="loc_364_18_364_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_18_364_19&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> = </span><a href="#loc_278_1_278_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_278_1_278_21&#39;)"><span class="hl_varref"><span class="mpre">toLazyByteStringWith</span></span></a><span class="mpre"> 
    </span><a href="#loc_188_1_188_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_1_188_18&#39;)"><span class="hl_varref"><span class="mpre">defaultBufferSize</span></span></a><span class="mpre"> </span><a href="#loc_198_1_198_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_1_198_25&#39;)"><span class="hl_varref"><span class="mpre">defaultMinimalBufferSize</span></span></a><span class="mpre"> </span><a href="#loc_206_1_206_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_206_1_206_23&#39;)"><span class="hl_varref"><span class="mpre">defaultFirstBufferSize</span></span></a><span class="mpre"> </span><a href="#loc_364_18_364_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_18_364_19&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">L.empty</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_364_1_364_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_17&#39;)"><span class="mpre">toLazyByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">{-
-- | Pack the chunks of a lazy bytestring into a single strict bytestring.
packChunks :: L.ByteString -&gt; S.ByteString
packChunks lbs = do
    S.unsafeCreate (fromIntegral $ L.length lbs) (copyChunks lbs)
  where
    copyChunks !L.Empty                         !_pf = return ()
    copyChunks !(L.Chunk (S.PS fpbuf o l) lbs&#39;) !pf  = do
        withForeignPtr fpbuf $ \pbuf -&gt;
            copyBytes pf (pbuf `plusPtr` o) l
        copyChunks lbs&#39; (pf `plusPtr` l)

-- | Run the builder to construct a strict bytestring containing the sequence
-- of bytes denoted by the builder. This is done by first serializing to a lazy bytestring and then packing its
-- chunks to a appropriately sized strict bytestring.
--
-- &gt; toByteString = packChunks . toLazyByteString
--
-- Note that @&#39;toByteString&#39;@ is a &#39;Monoid&#39; homomorphism.
--
-- &gt; toByteString mempty          == mempty
-- &gt; toByteString (x `mappend` y) == toByteString x `mappend` toByteString y
--
-- However, in the second equation, the left-hand-side is generally faster to
-- execute.
--
toByteString :: Builder -&gt; S.ByteString
toByteString = packChunks . toLazyByteString


-- | @toByteStringIOWith bufSize io b@ runs the builder @b@ with a buffer of
-- at least the size @bufSize@ and executes the &#39;IO&#39; action @io@ whenever the
-- buffer is full.
--
-- Compared to &#39;toLazyByteStringWith&#39; this function requires less allocation,
-- as the output buffer is only allocated once at the start of the
-- serialization and whenever something bigger than the current buffer size has
-- to be copied into the buffer, which should happen very seldomly for the
-- default buffer size of 32kb. Hence, the pressure on the garbage collector is
-- reduced, which can be an advantage when building long sequences of bytes.
--
toByteStringIOWith :: Int                      -- ^ Buffer size (upper bounds
                                               -- the number of bytes forced
                                               -- per call to the &#39;IO&#39; action).
                   -&gt; (S.ByteString -&gt; IO ())  -- ^ &#39;IO&#39; action to execute per
                                               -- full buffer, which is
                                               -- referenced by a strict
                                               -- &#39;S.ByteString&#39;.
                   -&gt; Builder                  -- ^ &#39;Builder&#39; to run.
                   -&gt; IO ()                    -- ^ Resulting &#39;IO&#39; action.
toByteStringIOWith bufSize io (Builder b) = 
    fillNewBuffer bufSize (b finalStep)
  where
    finalStep pf _ = return $ Done pf

    fillNewBuffer !size !step0 = do
        S.mallocByteString size &gt;&gt;= fillBuffer
      where
        fillBuffer fpbuf = fill step0
          where
            -- safe because the constructed ByteString references the foreign
            -- pointer AFTER its buffer was filled.
            pf = unsafeForeignPtrToPtr fpbuf
            fill !step = do
                next &lt;- step pf (pf `plusPtr` size)
                case next of
                    Done pf&#39; -&gt;
                        unless (pf&#39; == pf) (io $  S.PS fpbuf 0 (pf&#39; `minusPtr` pf))

                    BufferFull newSize pf&#39; nextStep  -&gt; do
                        io $ S.PS fpbuf 0 (pf&#39; `minusPtr` pf)
                        if bufSize &lt; newSize
                          then fillNewBuffer newSize nextStep
                          else fill nextStep
                        
                    ModifyChunks  pf&#39; bsk nextStep  -&gt; do
                        unless (pf&#39; == pf) (io $  S.PS fpbuf 0 (pf&#39; `minusPtr` pf))
                        -- was: mapM_ io $ L.toChunks (bsk L.empty)
                        L.foldrChunks (\bs -&gt; (io bs &gt;&gt;)) (return ()) (bsk L.empty)
                        fill nextStep

-- | Run the builder with a &#39;defaultBufferSize&#39;d buffer and execute the given
-- &#39;IO&#39; action whenever the buffer is full or gets flushed.
--
-- @ &#39;toByteStringIO&#39; = &#39;toByteStringIOWith&#39; &#39;defaultBufferSize&#39;@
--
-- This is a &#39;Monoid&#39; homomorphism in the following sense.
--
-- &gt; toByteStringIO io mempty          == return ()
-- &gt; toByteStringIO io (x `mappend` y) == toByteStringIO io x &gt;&gt; toByteStringIO io y
--
toByteStringIO :: (S.ByteString -&gt; IO ()) -&gt; Builder -&gt; IO ()
toByteStringIO = toByteStringIOWith defaultBufferSize
{-# INLINE toByteStringIO #-}

-}</span></span><span class="mpre">
</span></div></body></html>