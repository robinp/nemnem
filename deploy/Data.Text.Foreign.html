<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE BangPatterns, CPP, GeneralizedNewtypeDeriving #-}
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : Data.Text.Foreign</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   : (c) 2009, 2010 Bryan O&#39;Sullivan</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD-style</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : bos@serpentine.com</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : GHC</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Support for using &#39;Text&#39; data with native code via the Haskell</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- foreign function interface.</span></span><span class="mpre">

module Data.Text.Foreign
    (
    </span><span class="hl_comment"><span class="mpre">-- * Interoperability with native code</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- $interop</span></span><span class="mpre">
      I16
    </span><span class="hl_comment"><span class="mpre">-- * Safe conversion functions</span></span><span class="mpre">
    , fromPtr
    , useAsPtr
    , asForeignPtr
    </span><span class="hl_comment"><span class="mpre">-- ** Encoding as UTF-8</span></span><span class="mpre">
    , peekCStringLen
    , withCStringLen
    </span><span class="hl_comment"><span class="mpre">-- * Unsafe conversion code</span></span><span class="mpre">
    , lengthWord16
    , unsafeCopyToPtr
    </span><span class="hl_comment"><span class="mpre">-- * Low-level manipulation</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- $lowlevel</span></span><span class="mpre">
    , dropWord16
    , takeWord16
    ) where

#if defined(ASSERTS)
import Control.Exception (assert)
#endif
#if __GLASGOW_HASKELL__ &gt;= 702
import Control.Monad.ST.Unsafe (</span><a href="GHC.IO.html#loc_100_1_100_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_100_1_100_13&#39;)"><span class="mpre">unsafeIOToST</span></a><span class="mpre">)
#else
import Control.Monad.ST (unsafeIOToST)
#endif
import Data.ByteString.Unsafe (</span><a href="Data.ByteString.Unsafe.html#loc_232_1_232_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Unsafe.html#loc_232_1_232_21&#39;)"><span class="mpre">unsafePackCStringLen</span></a><span class="mpre">, </span><a href="Data.ByteString.Unsafe.html#loc_311_1_311_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Unsafe.html#loc_311_1_311_22&#39;)"><span class="mpre">unsafeUseAsCStringLen</span></a><span class="mpre">)
import Data.Text.Encoding (</span><a href="Data.Text.Encoding.html#loc_307_1_307_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Encoding.html#loc_307_1_307_11&#39;)"><span class="mpre">decodeUtf8</span></a><span class="mpre">, </span><a href="Data.Text.Encoding.html#loc_386_1_386_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Encoding.html#loc_386_1_386_11&#39;)"><span class="mpre">encodeUtf8</span></a><span class="mpre">)
import Data.Text.Internal (</span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="mpre">Text</span></a><span class="mpre">(..), </span><a href="Data.Text.Internal.html#loc_72_1_72_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_72_1_72_6&#39;)"><span class="mpre">empty</span></a><span class="mpre">)
import Data.Text.Unsafe (</span><a href="Data.Text.Unsafe.html#loc_112_1_112_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Unsafe.html#loc_112_1_112_13&#39;)"><span class="mpre">lengthWord16</span></a><span class="mpre">)
import Data.Word (Word16)
import Foreign.C.String (CStringLen)
import Foreign.ForeignPtr (ForeignPtr, </span><a href="Foreign.ForeignPtr.Imp.html#loc_109_1_109_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_109_1_109_22&#39;)"><span class="mpre">mallocForeignPtrArray</span></a><span class="mpre">, </span><a href="Foreign.ForeignPtr.Imp.html#loc_88_1_88_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_88_1_88_15&#39;)"><span class="mpre">withForeignPtr</span></a><span class="mpre">)
import Foreign.Marshal.Alloc (</span><a href="Foreign.Marshal.Alloc.html#loc_121_1_121_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Alloc.html#loc_121_1_121_12&#39;)"><span class="mpre">allocaBytes</span></a><span class="mpre">)
import Foreign.Ptr (Ptr, castPtr, plusPtr)
import Foreign.Storable (peek, poke)
import qualified Data.Text.Array as A

</span><span class="hl_comment"><span class="mpre">-- $interop</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The &#39;Text&#39; type is implemented using arrays that are not guaranteed</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to have a fixed address in the Haskell heap. All communication with</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- native code must thus occur by copying data back and forth.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The &#39;Text&#39; type&#39;s internal representation is UTF-16, using the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- platform&#39;s native endianness.  This makes copied data suitable for</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- use with native libraries that use a similar representation, such</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- as ICU.  To interoperate with native libraries that use different</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- internal representations, such as UTF-8 or UTF-32, consider using</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the functions in the &#39;Data.Text.Encoding&#39; module.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A type representing a number of UTF-16 code units.</span></span><span class="mpre">
newtype </span><a name="loc_69_9_69_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_9_69_12&#39;)"><span class="hl_tycondecl"><span class="mpre">I16</span></span></a><span class="mpre"> = </span><a name="loc_69_15_69_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_15_69_18&#39;)"><span class="hl_condecl"><span class="mpre">I16</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
    </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/text-1.1.1.3/Data/Text/Foreign.hs&quot;, srcSpanStartLine = 70, srcSpanStartColumn = 5, srcSpanEndLine = 70, srcSpanEndColumn = 71}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/text-1.1.1.3/Data/Text/Foreign.hs&quot;, srcSpanStartLine = 70, srcSpanStartColumn = 5, srcSpanEndLine = 70, srcSpanEndColumn = 13},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/text-1.1.1.3/Data/Text/Foreign.hs&quot;, srcSpanStartLine = 70, "><span class="mpre">deriving (Bounded, Enum, Eq, Integral, Num, Ord, Read, Real, Show)</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(n)/ Create a new &#39;Text&#39; from a &#39;Ptr&#39; &#39;Word16&#39; by copying the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- contents of the array.</span></span><span class="mpre">
</span><a href="#loc_77_1_77_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_1_77_8&#39;)"><span class="mpre">fromPtr</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word16</span></span><span class="mpre">           </span><span class="hl_comment"><span class="mpre">-- ^ source array</span></span><span class="mpre">
        -&gt; </span><a href="#loc_69_9_69_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_9_69_12&#39;)"><span class="hl_tyconref"><span class="mpre">I16</span></span></a><span class="mpre">                  </span><span class="hl_comment"><span class="mpre">-- ^ length of source array (in &#39;Word16&#39; units)</span></span><span class="mpre">
        -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">Text</span></span></a><span class="mpre">
</span><a name="loc_77_1_77_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_1_77_8&#39;)"><span class="hl_fundecl"><span class="mpre">fromPtr</span></span></a><span class="mpre"> _   (</span><a href="#loc_69_15_69_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_15_69_18&#39;)"><span class="hl_conref"><span class="mpre">I16</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">)   = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="Data.Text.Internal.html#loc_72_1_72_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_72_1_72_6&#39;)"><span class="hl_varref"><span class="mpre">empty</span></span></a><span class="mpre">
</span><a href="#loc_77_1_77_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_1_77_8&#39;)"><span class="hl_fundecl"><span class="mpre">fromPtr</span></span></a><span class="mpre"> </span><a name="loc_78_9_78_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_9_78_12&#39;)"><span class="hl_vardecl"><span class="mpre">ptr</span></span></a><span class="mpre"> (</span><a href="#loc_69_15_69_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_15_69_18&#39;)"><span class="hl_conref"><span class="mpre">I16</span></span></a><span class="mpre"> </span><a name="loc_78_18_78_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_18_78_21&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre">) =
#if defined(ASSERTS)
    </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre"> (</span><a href="#loc_78_18_78_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_18_78_21&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
#endif
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><a href="Data.Text.Internal.html#loc_50_13_50_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_13_50_17&#39;)"><span class="hl_conref"><span class="mpre">Text</span></span></a><span class="mpre"> </span><a href="#loc_84_5_84_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_5_84_8&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><a href="#loc_78_18_78_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_18_78_21&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">
  where
    </span><a name="loc_84_5_84_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_5_84_8&#39;)"><span class="hl_vardecl"><span class="mpre">arr</span></span></a><span class="mpre"> = </span><a href="Data.Text.Array.html#loc_177_1_177_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_177_1_177_4&#39;)"><span class="hl_varref"><span class="mpre">A.run</span></span></a><span class="mpre"> (</span><a href="Data.Text.Array.html#loc_115_1_115_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_115_1_115_4&#39;)"><span class="hl_varref"><span class="mpre">A.new</span></span></a><span class="mpre"> </span><a href="#loc_78_18_78_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_18_78_21&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_85_5_85_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_5_85_9&#39;)"><span class="hl_varref"><span class="mpre">copy</span></span></a><span class="mpre">)
    </span><a name="loc_85_5_85_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_5_85_9&#39;)"><span class="hl_fundecl"><span class="mpre">copy</span></span></a><span class="mpre"> </span><a name="loc_85_10_85_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_10_85_14&#39;)"><span class="hl_vardecl"><span class="mpre">marr</span></span></a><span class="mpre"> = </span><a href="#loc_87_9_87_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_9_87_13&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> </span><a href="#loc_78_9_78_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_9_78_12&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">
      where
        </span><a name="loc_87_9_87_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_9_87_13&#39;)"><span class="hl_fundecl"><span class="mpre">loop</span></span></a><span class="mpre"> !</span><a name="loc_87_15_87_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_15_87_16&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> !</span><a name="loc_87_18_87_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_18_87_19&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre"> | </span><a href="#loc_87_18_87_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_18_87_19&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_78_18_78_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_18_78_21&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_85_10_85_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_10_85_14&#39;)"><span class="hl_varref"><span class="mpre">marr</span></span></a><span class="mpre">
                   | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = do
          </span><a href="Data.Text.Array.html#loc_158_1_158_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_158_1_158_12&#39;)"><span class="hl_varref"><span class="mpre">A.unsafeWrite</span></span></a><span class="mpre"> </span><a href="#loc_85_10_85_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_10_85_14&#39;)"><span class="hl_varref"><span class="mpre">marr</span></span></a><span class="mpre"> </span><a href="#loc_87_18_87_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_18_87_19&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">=&lt;&lt;</span></span><span class="mpre"> </span><a href="GHC.IO.html#loc_100_1_100_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_100_1_100_13&#39;)"><span class="hl_varref"><span class="mpre">unsafeIOToST</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">peek</span></span><span class="mpre"> </span><a href="#loc_87_15_87_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_15_87_16&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">)
          </span><a href="#loc_87_9_87_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_9_87_13&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> (</span><a href="#loc_87_15_87_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_15_87_16&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre">) (</span><a href="#loc_87_18_87_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_18_87_19&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- $lowlevel</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Foreign functions that use UTF-16 internally may return indices in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- units of &#39;Word16&#39; instead of characters.  These functions may</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- safely be used with such indices, as they will adjust offsets if</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- necessary to preserve the validity of a Unicode string.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(1)/ Return the prefix of the &#39;Text&#39; of @n@ &#39;Word16&#39; units in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- length.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- If @n@ would cause the &#39;Text&#39; to end inside a surrogate pair, the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- end of the prefix will be advanced by one additional &#39;Word16&#39; unit</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to maintain its validity.</span></span><span class="mpre">
</span><a href="#loc_106_1_106_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_1_106_11&#39;)"><span class="mpre">takeWord16</span></a><span class="mpre"> :: </span><a href="#loc_69_9_69_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_9_69_12&#39;)"><span class="hl_tyconref"><span class="mpre">I16</span></span></a><span class="mpre"> -&gt; </span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">Text</span></span></a><span class="mpre"> -&gt; </span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">Text</span></span></a><span class="mpre">
</span><a name="loc_106_1_106_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_1_106_11&#39;)"><span class="hl_fundecl"><span class="mpre">takeWord16</span></span></a><span class="mpre"> (</span><a href="#loc_69_15_69_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_15_69_18&#39;)"><span class="hl_conref"><span class="mpre">I16</span></span></a><span class="mpre"> </span><a name="loc_106_17_106_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_17_106_18&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre">) </span><a name="loc_106_20_106_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_20_106_21&#39;)"><span class="hl_specname"><span class="mpre">t</span></span></a><span class="mpre">@(</span><a href="Data.Text.Internal.html#loc_50_13_50_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_13_50_17&#39;)"><span class="hl_conref"><span class="mpre">Text</span></span></a><span class="mpre"> </span><a name="loc_106_28_106_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_28_106_31&#39;)"><span class="hl_vardecl"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a name="loc_106_32_106_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_32_106_35&#39;)"><span class="hl_vardecl"><span class="mpre">off</span></span></a><span class="mpre"> </span><a name="loc_106_36_106_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_36_106_39&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre">)
    | </span><a href="#loc_106_17_106_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_17_106_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">               = </span><a href="Data.Text.Internal.html#loc_72_1_72_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_72_1_72_6&#39;)"><span class="hl_varref"><span class="mpre">empty</span></span></a><span class="mpre">
    | </span><a href="#loc_106_17_106_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_17_106_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;=</span></span><span class="mpre"> </span><a href="#loc_106_36_106_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_36_106_39&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">||</span></span><span class="mpre"> </span><a href="#loc_111_5_111_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_5_111_6&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;=</span></span><span class="mpre"> </span><a href="#loc_106_36_106_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_36_106_39&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> = </span><a href="#loc_106_20_106_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_20_106_21&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre">
    | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">            = </span><a href="Data.Text.Internal.html#loc_50_13_50_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_13_50_17&#39;)"><span class="hl_conref"><span class="mpre">Text</span></span></a><span class="mpre"> </span><a href="#loc_106_28_106_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_28_106_31&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a href="#loc_106_32_106_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_32_106_35&#39;)"><span class="hl_varref"><span class="mpre">off</span></span></a><span class="mpre"> </span><a href="#loc_111_5_111_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_5_111_6&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre">
  where
    </span><a name="loc_111_5_111_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_5_111_6&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre"> | </span><a href="#loc_113_5_113_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_5_113_6&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xDB00</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">||</span></span><span class="mpre"> </span><a href="#loc_113_5_113_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_5_113_6&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xD8FF</span></span><span class="mpre"> = </span><a href="#loc_106_17_106_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_17_106_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                = </span><a href="#loc_106_17_106_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_17_106_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">
    </span><a name="loc_113_5_113_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_5_113_6&#39;)"><span class="hl_vardecl"><span class="mpre">w</span></span></a><span class="mpre"> = </span><a href="Data.Text.Array.html#loc_150_1_150_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_150_1_150_12&#39;)"><span class="hl_varref"><span class="mpre">A.unsafeIndex</span></span></a><span class="mpre"> </span><a href="#loc_106_28_106_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_28_106_31&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> (</span><a href="#loc_106_32_106_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_32_106_35&#39;)"><span class="hl_varref"><span class="mpre">off</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_106_17_106_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_17_106_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | /O(1)/ Return the suffix of the &#39;Text&#39;, with @n@ &#39;Word16&#39; units</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- dropped from its beginning.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- If @n@ would cause the &#39;Text&#39; to begin inside a surrogate pair, the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- beginning of the suffix will be advanced by one additional &#39;Word16&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- unit to maintain its validity.</span></span><span class="mpre">
</span><a href="#loc_122_1_122_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_11&#39;)"><span class="mpre">dropWord16</span></a><span class="mpre"> :: </span><a href="#loc_69_9_69_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_9_69_12&#39;)"><span class="hl_tyconref"><span class="mpre">I16</span></span></a><span class="mpre"> -&gt; </span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">Text</span></span></a><span class="mpre"> -&gt; </span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">Text</span></span></a><span class="mpre">
</span><a name="loc_122_1_122_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_1_122_11&#39;)"><span class="hl_fundecl"><span class="mpre">dropWord16</span></span></a><span class="mpre"> (</span><a href="#loc_69_15_69_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_15_69_18&#39;)"><span class="hl_conref"><span class="mpre">I16</span></span></a><span class="mpre"> </span><a name="loc_122_17_122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_17_122_18&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre">) </span><a name="loc_122_20_122_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_20_122_21&#39;)"><span class="hl_specname"><span class="mpre">t</span></span></a><span class="mpre">@(</span><a href="Data.Text.Internal.html#loc_50_13_50_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_13_50_17&#39;)"><span class="hl_conref"><span class="mpre">Text</span></span></a><span class="mpre"> </span><a name="loc_122_28_122_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_28_122_31&#39;)"><span class="hl_vardecl"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a name="loc_122_32_122_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_32_122_35&#39;)"><span class="hl_vardecl"><span class="mpre">off</span></span></a><span class="mpre"> </span><a name="loc_122_36_122_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_36_122_39&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre">)
    | </span><a href="#loc_122_17_122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_17_122_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">               = </span><a href="#loc_122_20_122_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_20_122_21&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre">
    | </span><a href="#loc_122_17_122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_17_122_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;=</span></span><span class="mpre"> </span><a href="#loc_122_36_122_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_36_122_39&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">||</span></span><span class="mpre"> </span><a href="#loc_127_5_127_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_5_127_6&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;=</span></span><span class="mpre"> </span><a href="#loc_122_36_122_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_36_122_39&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> = </span><a href="Data.Text.Internal.html#loc_72_1_72_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_72_1_72_6&#39;)"><span class="hl_varref"><span class="mpre">empty</span></span></a><span class="mpre">
    | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">            = </span><a href="Data.Text.Internal.html#loc_50_13_50_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_13_50_17&#39;)"><span class="hl_conref"><span class="mpre">Text</span></span></a><span class="mpre"> </span><a href="#loc_122_28_122_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_28_122_31&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> (</span><a href="#loc_122_32_122_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_32_122_35&#39;)"><span class="hl_varref"><span class="mpre">off</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_127_5_127_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_5_127_6&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre">) (</span><a href="#loc_122_36_122_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_36_122_39&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><a href="#loc_127_5_127_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_5_127_6&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre">)
  where
    </span><a name="loc_127_5_127_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_5_127_6&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre"> | </span><a href="#loc_129_5_129_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_5_129_6&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xD800</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">||</span></span><span class="mpre"> </span><a href="#loc_129_5_129_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_5_129_6&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0xDBFF</span></span><span class="mpre"> = </span><a href="#loc_122_17_122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_17_122_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                = </span><a href="#loc_122_17_122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_17_122_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">
    </span><a name="loc_129_5_129_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_5_129_6&#39;)"><span class="hl_vardecl"><span class="mpre">w</span></span></a><span class="mpre"> = </span><a href="Data.Text.Array.html#loc_150_1_150_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_150_1_150_12&#39;)"><span class="hl_varref"><span class="mpre">A.unsafeIndex</span></span></a><span class="mpre"> </span><a href="#loc_122_28_122_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_28_122_31&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> (</span><a href="#loc_122_32_122_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_32_122_35&#39;)"><span class="hl_varref"><span class="mpre">off</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_122_17_122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_17_122_18&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | /O(n)/ Copy a &#39;Text&#39; to an array.  The array is assumed to be big</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- enough to hold the contents of the entire &#39;Text&#39;.</span></span><span class="mpre">
</span><a href="#loc_134_1_134_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_1_134_16&#39;)"><span class="mpre">unsafeCopyToPtr</span></a><span class="mpre"> :: </span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">Text</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word16</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_134_1_134_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_1_134_16&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeCopyToPtr</span></span></a><span class="mpre"> (</span><a href="Data.Text.Internal.html#loc_50_13_50_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_13_50_17&#39;)"><span class="hl_conref"><span class="mpre">Text</span></span></a><span class="mpre"> </span><a name="loc_134_23_134_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_23_134_26&#39;)"><span class="hl_vardecl"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a name="loc_134_27_134_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_27_134_30&#39;)"><span class="hl_vardecl"><span class="mpre">off</span></span></a><span class="mpre"> </span><a name="loc_134_31_134_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_31_134_34&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre">) </span><a name="loc_134_36_134_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_36_134_39&#39;)"><span class="hl_vardecl"><span class="mpre">ptr</span></span></a><span class="mpre"> = </span><a href="#loc_137_5_137_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_5_137_9&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> </span><a href="#loc_134_36_134_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_36_134_39&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre"> </span><a href="#loc_134_27_134_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_27_134_30&#39;)"><span class="hl_varref"><span class="mpre">off</span></span></a><span class="mpre">
  where
    </span><a name="loc_136_5_136_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_5_136_8&#39;)"><span class="hl_vardecl"><span class="mpre">end</span></span></a><span class="mpre"> = </span><a href="#loc_134_27_134_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_27_134_30&#39;)"><span class="hl_varref"><span class="mpre">off</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><a href="#loc_134_31_134_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_31_134_34&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">
    </span><a name="loc_137_5_137_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_5_137_9&#39;)"><span class="hl_fundecl"><span class="mpre">loop</span></span></a><span class="mpre"> !</span><a name="loc_137_11_137_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_11_137_12&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> !</span><a name="loc_137_14_137_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_14_137_15&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre"> | </span><a href="#loc_137_14_137_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_14_137_15&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_136_5_136_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_5_136_8&#39;)"><span class="hl_varref"><span class="mpre">end</span></span></a><span class="mpre">  = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
               | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = do
      </span><span class="hl_varref"><span class="mpre">poke</span></span><span class="mpre"> </span><a href="#loc_137_11_137_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_11_137_12&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> (</span><a href="Data.Text.Array.html#loc_150_1_150_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Array.html#loc_150_1_150_12&#39;)"><span class="hl_varref"><span class="mpre">A.unsafeIndex</span></span></a><span class="mpre"> </span><a href="#loc_134_23_134_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_23_134_26&#39;)"><span class="hl_varref"><span class="mpre">arr</span></span></a><span class="mpre"> </span><a href="#loc_137_14_137_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_14_137_15&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre">)
      </span><a href="#loc_137_5_137_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_5_137_9&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre"> (</span><a href="#loc_137_11_137_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_11_137_12&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre">) (</span><a href="#loc_137_14_137_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_14_137_15&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | /O(n)/ Perform an action on a temporary, mutable copy of a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;Text&#39;.  The copy is freed as soon as the action returns.</span></span><span class="mpre">
</span><a href="#loc_145_1_145_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_1_145_9&#39;)"><span class="mpre">useAsPtr</span></a><span class="mpre"> :: </span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">Text</span></span></a><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word16</span></span><span class="mpre"> -&gt; </span><a href="#loc_69_9_69_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_9_69_12&#39;)"><span class="hl_tyconref"><span class="mpre">I16</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_145_1_145_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_1_145_9&#39;)"><span class="hl_fundecl"><span class="mpre">useAsPtr</span></span></a><span class="mpre"> </span><a name="loc_145_10_145_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_10_145_11&#39;)"><span class="hl_specname"><span class="mpre">t</span></span></a><span class="mpre">@(</span><a href="Data.Text.Internal.html#loc_50_13_50_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_13_50_17&#39;)"><span class="hl_conref"><span class="mpre">Text</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_arr</span></span><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_off</span></span><span class="mpre"> </span><a name="loc_145_28_145_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_28_145_31&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre">) </span><a name="loc_145_33_145_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_33_145_39&#39;)"><span class="hl_vardecl"><span class="mpre">action</span></span></a><span class="mpre"> =
    </span><a href="Foreign.Marshal.Alloc.html#loc_121_1_121_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Alloc.html#loc_121_1_121_12&#39;)"><span class="hl_varref"><span class="mpre">allocaBytes</span></span></a><span class="mpre"> (</span><a href="#loc_145_28_145_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_28_145_31&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_146_30_146_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_30_146_33&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre"> -&gt; do
      </span><a href="#loc_134_1_134_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_1_134_16&#39;)"><span class="hl_varref"><span class="mpre">unsafeCopyToPtr</span></span></a><span class="mpre"> </span><a href="#loc_145_10_145_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_10_145_11&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre"> </span><a href="#loc_146_30_146_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_30_146_33&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">
      </span><a href="#loc_145_33_145_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_33_145_39&#39;)"><span class="hl_varref"><span class="mpre">action</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_146_30_146_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_30_146_33&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">) (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_145_28_145_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_28_145_31&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | /O(n)/ Make a mutable copy of a &#39;Text&#39;.</span></span><span class="mpre">
</span><a href="#loc_152_1_152_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_1_152_13&#39;)"><span class="mpre">asForeignPtr</span></a><span class="mpre"> :: </span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">Text</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">ForeignPtr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word16</span></span><span class="mpre">, </span><a href="#loc_69_9_69_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_9_69_12&#39;)"><span class="hl_tyconref"><span class="mpre">I16</span></span></a><span class="mpre">)
</span><a name="loc_152_1_152_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_1_152_13&#39;)"><span class="hl_fundecl"><span class="mpre">asForeignPtr</span></span></a><span class="mpre"> </span><a name="loc_152_14_152_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_14_152_15&#39;)"><span class="hl_specname"><span class="mpre">t</span></span></a><span class="mpre">@(</span><a href="Data.Text.Internal.html#loc_50_13_50_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_13_50_17&#39;)"><span class="hl_conref"><span class="mpre">Text</span></span></a><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_arr</span></span><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">_off</span></span><span class="mpre"> </span><a name="loc_152_32_152_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_32_152_35&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre">) = do
  </span><a name="loc_153_3_153_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_3_153_5&#39;)"><span class="hl_vardecl"><span class="mpre">fp</span></span></a><span class="mpre"> &lt;- </span><a href="Foreign.ForeignPtr.Imp.html#loc_109_1_109_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_109_1_109_22&#39;)"><span class="hl_varref"><span class="mpre">mallocForeignPtrArray</span></span></a><span class="mpre"> </span><a href="#loc_152_32_152_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_32_152_35&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">
  </span><a href="Foreign.ForeignPtr.Imp.html#loc_88_1_88_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_88_1_88_15&#39;)"><span class="hl_varref"><span class="mpre">withForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_153_3_153_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_3_153_5&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_134_1_134_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_1_134_16&#39;)"><span class="hl_varref"><span class="mpre">unsafeCopyToPtr</span></span></a><span class="mpre"> </span><a href="#loc_152_14_152_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_14_152_15&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_153_3_153_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_3_153_5&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre">, </span><a href="#loc_69_15_69_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_15_69_18&#39;)"><span class="hl_conref"><span class="mpre">I16</span></span></a><span class="mpre"> </span><a href="#loc_152_32_152_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_32_152_35&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | /O(n)/ Decode a C string with explicit length, which is assumed</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to have been encoded as UTF-8. If decoding fails, a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;UnicodeException&#39; is thrown.</span></span><span class="mpre">
</span><a href="#loc_161_1_161_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_1_161_15&#39;)"><span class="mpre">peekCStringLen</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">Text</span></span></a><span class="mpre">
</span><a name="loc_161_1_161_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_1_161_15&#39;)"><span class="hl_fundecl"><span class="mpre">peekCStringLen</span></span></a><span class="mpre"> </span><a name="loc_161_16_161_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_16_161_18&#39;)"><span class="hl_vardecl"><span class="mpre">cs</span></span></a><span class="mpre"> = do
  </span><a name="loc_162_3_162_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_3_162_5&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> &lt;- </span><a href="Data.ByteString.Unsafe.html#loc_232_1_232_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Unsafe.html#loc_232_1_232_21&#39;)"><span class="hl_varref"><span class="mpre">unsafePackCStringLen</span></span></a><span class="mpre"> </span><a href="#loc_161_16_161_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_16_161_18&#39;)"><span class="hl_varref"><span class="mpre">cs</span></span></a><span class="mpre">
  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><a href="Data.Text.Encoding.html#loc_307_1_307_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Encoding.html#loc_307_1_307_11&#39;)"><span class="hl_varref"><span class="mpre">decodeUtf8</span></span></a><span class="mpre"> </span><a href="#loc_162_3_162_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_3_162_5&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Marshal a &#39;Text&#39; into a C string encoded as UTF-8 in temporary</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- storage, with explicit length information. The encoded string may</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- contain NUL bytes, and is not followed by a trailing NUL byte.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The temporary storage is freed when the subcomputation terminates</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- (either normally or via an exception), so the pointer to the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- temporary storage must /not/ be used after this function returns.</span></span><span class="mpre">
</span><a href="#loc_173_1_173_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_1_173_15&#39;)"><span class="mpre">withCStringLen</span></a><span class="mpre"> :: </span><a href="Data.Text.Internal.html#loc_50_6_50_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Internal.html#loc_50_6_50_10&#39;)"><span class="hl_tyconref"><span class="mpre">Text</span></span></a><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_173_1_173_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_1_173_15&#39;)"><span class="hl_fundecl"><span class="mpre">withCStringLen</span></span></a><span class="mpre"> </span><a name="loc_173_16_173_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_16_173_17&#39;)"><span class="hl_vardecl"><span class="mpre">t</span></span></a><span class="mpre"> </span><a name="loc_173_18_173_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_18_173_21&#39;)"><span class="hl_vardecl"><span class="mpre">act</span></span></a><span class="mpre"> = </span><a href="Data.ByteString.Unsafe.html#loc_311_1_311_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Unsafe.html#loc_311_1_311_22&#39;)"><span class="hl_varref"><span class="mpre">unsafeUseAsCStringLen</span></span></a><span class="mpre"> (</span><a href="Data.Text.Encoding.html#loc_386_1_386_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Text.Encoding.html#loc_386_1_386_11&#39;)"><span class="hl_varref"><span class="mpre">encodeUtf8</span></span></a><span class="mpre"> </span><a href="#loc_173_16_173_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_16_173_17&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre">) </span><a href="#loc_173_18_173_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_18_173_21&#39;)"><span class="hl_varref"><span class="mpre">act</span></span></a><span class="mpre">
</span></div></body></html>