<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE ScopedTypeVariables, CPP, BangPatterns, RankNTypes #-}
#if __GLASGOW_HASKELL__ &gt;= 701
{-# LANGUAGE Unsafe #-}
#endif
{-# OPTIONS_HADDOCK hide #-}
</span><span class="hl_comment"><span class="mpre">-- | Copyright : (c) 2010 - 2011 Simon Meier</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD3-style (see LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Simon Meier &lt;iridcode@gmail.com&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : unstable, private</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : GHC</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- *Warning:* this module is internal. If you find that you need it then please</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- contact the maintainers and explain what you are trying to do and discuss</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- what you would need in the public API. It is important that you do this as</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the module may not be exposed at all in future releases.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Core types and functions for the &#39;Builder&#39; monoid and its generalization,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the &#39;Put&#39; monad.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The design of the &#39;Builder&#39; monoid is optimized such that</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   1. buffers of arbitrary size can be filled as efficiently as possible and</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   2. sequencing of &#39;Builder&#39;s is as cheap as possible.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- We achieve (1) by completely handing over control over writing to the buffer</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to the &#39;BuildStep&#39; implementing the &#39;Builder&#39;. This &#39;BuildStep&#39; is just told</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the start and the end of the buffer (represented as a &#39;BufferRange&#39;). Then,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the &#39;BuildStep&#39; can write to as big a prefix of this &#39;BufferRange&#39; in any</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- way it desires. If the &#39;BuildStep&#39; is done, the &#39;BufferRange&#39; is full, or a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- long sequence of bytes should be inserted directly, then the &#39;BuildStep&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- signals this to its caller using a &#39;BuildSignal&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- We achieve (2) by requiring that every &#39;Builder&#39; is implemented by a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;BuildStep&#39; that takes a continuation &#39;BuildStep&#39;, which it calls with the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- updated &#39;BufferRange&#39; after it is done. Therefore, only two pointers have</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to be passed in a function call to implement concatenation of &#39;Builder&#39;s.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Moreover, many &#39;Builder&#39;s are completely inlined, which enables the compiler</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to sequence them without a function call and with no boxing at all.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This design gives the implementation of a &#39;Builder&#39; full access to the &#39;IO&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- monad. Therefore, utmost care has to be taken to not overwrite anything</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- outside the given &#39;BufferRange&#39;s. Moreover, further care has to be taken to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ensure that &#39;Builder&#39;s and &#39;Put&#39;s are referentially transparent. See the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- comments of the &#39;builder&#39; and &#39;put&#39; functions for further information.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that there are /no safety belts/ at all, when implementing a &#39;Builder&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- using an &#39;IO&#39; action: you are writing code that might enable the next</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- buffer-overflow attack on a Haskell server!</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Data.ByteString.Builder.Internal (
  </span><span class="hl_comment"><span class="mpre">-- * Buffer management</span></span><span class="mpre">
    Buffer(..)
  , BufferRange(..)
  , newBuffer
  , bufferSize
  , byteStringFromBuffer

  , ChunkIOStream(..)
  , buildStepToCIOS
  , ciosUnitToLazyByteString
  , ciosToLazyByteString

  </span><span class="hl_comment"><span class="mpre">-- * Build signals and steps</span></span><span class="mpre">
  , BuildSignal
  , BuildStep
  , finalBuildStep

  , done
  , bufferFull
  , insertChunk

  , fillWithBuildStep

  </span><span class="hl_comment"><span class="mpre">-- * The Builder monoid</span></span><span class="mpre">
  , Builder
  , builder
  , runBuilder
  , runBuilderWith

  </span><span class="hl_comment"><span class="mpre">-- ** Primitive combinators</span></span><span class="mpre">
  , empty
  , append
  , flush
  , ensureFree
  </span><span class="hl_comment"><span class="mpre">-- , sizedChunksInsert</span></span><span class="mpre">

  , byteStringCopy
  , byteStringInsert
  , byteStringThreshold

  , lazyByteStringCopy
  , lazyByteStringInsert
  , lazyByteStringThreshold
  
  , shortByteString

  , maximalCopySize
  , byteString
  , lazyByteString

  </span><span class="hl_comment"><span class="mpre">-- ** Execution</span></span><span class="mpre">
  , toLazyByteStringWith
  , AllocationStrategy
  , safeStrategy
  , untrimmedStrategy
  , customStrategy
  , L.smallChunkSize
  , L.defaultChunkSize
  , L.chunkOverhead

  </span><span class="hl_comment"><span class="mpre">-- * The Put monad</span></span><span class="mpre">
  , Put
  , put
  , runPut

  </span><span class="hl_comment"><span class="mpre">-- ** Execution</span></span><span class="mpre">
  , putToLazyByteString
  , putToLazyByteStringWith
  , hPut

  </span><span class="hl_comment"><span class="mpre">-- ** Conversion to and from Builders</span></span><span class="mpre">
  , putBuilder
  , fromPut

  </span><span class="hl_comment"><span class="mpre">-- -- ** Lifting IO actions</span></span><span class="mpre">
  </span><span class="hl_comment"><span class="mpre">-- , putLiftIO</span></span><span class="mpre">

) where

import           Control.Arrow (</span><a href="Control.Arrow.html#loc_96_5_96_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Arrow.html#loc_96_5_96_11&#39;)"><span class="mpre">second</span></a><span class="mpre">)
import           Control.Applicative (</span><a href="Control.Applicative.html#loc_113_20_113_31" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_113_20_113_31&#39;)"><span class="mpre">Applicative</span></a><span class="mpre">(..), </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="mpre">(&lt;$&gt;)</span></a><span class="mpre">)
</span><span class="hl_comment"><span class="mpre">-- import           Control.Exception (return)</span></span><span class="mpre">

import           Data.Monoid
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Internal.hs&quot;, srcSpanStartLine = 136, srcSpanStartColumn = 18, srcSpanEndLine = 136, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre">               as S
import qualified Data.ByteString.Internal      as S
import qualified Data.ByteString.Lazy.Internal as L
import qualified Data.ByteString.Short.Internal as Sh

#if __GLASGOW_HASKELL__ &gt;= 611
import qualified GHC.IO.Buffer as IO (</span><a href="GHC.IO.Buffer.html#loc_180_6_180_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_180_6_180_12&#39;)"><span class="mpre">Buffer</span></a><span class="mpre">(..), </span><a href="GHC.IO.Buffer.html#loc_244_1_244_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_244_1_244_14&#39;)"><span class="mpre">newByteBuffer</span></a><span class="mpre">)
import           GHC.IO.Handle.Internals (</span><a href="GHC.IO.Handle.Internals.html#loc_225_1_225_19" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Internals.html#loc_225_1_225_19&#39;)"><span class="mpre">wantWritableHandle</span></a><span class="mpre">, </span><a href="GHC.IO.Handle.Internals.html#loc_490_1_490_17" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Internals.html#loc_490_1_490_17&#39;)"><span class="mpre">flushWriteBuffer</span></a><span class="mpre">)
import           GHC.IO.Handle.Types (</span><a href="GHC.IO.Handle.Types.html#loc_124_6_124_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Types.html#loc_124_6_124_14&#39;)"><span class="mpre">Handle__</span></a><span class="mpre">, </span><a href="GHC.IO.Handle.Types.html#loc_129_7_129_19" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Types.html#loc_129_7_129_19&#39;)"><span class="mpre">haByteBuffer</span></a><span class="mpre">, </span><a href="GHC.IO.Handle.Types.html#loc_130_7_130_19" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Types.html#loc_130_7_130_19&#39;)"><span class="mpre">haBufferMode</span></a><span class="mpre">)
import           System.IO (</span><a href="GHC.IO.Handle.html#loc_293_1_293_7" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.html#loc_293_1_293_7&#39;)"><span class="mpre">hFlush</span></a><span class="mpre">, </span><a href="GHC.IO.Handle.Types.html#loc_246_6_246_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Types.html#loc_246_6_246_16&#39;)"><span class="mpre">BufferMode</span></a><span class="mpre">(..))
import           Data.IORef
#else
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Internal.hs&quot;, srcSpanStartLine = 148, srcSpanStartColumn = 18, srcSpanEndLine = 148, srcSpanEndColumn = 38}, srcInfoPoints = []}) &quot;Data.ByteString.Lazy&quot;"><span class="mpre">Data.ByteString.Lazy</span></span><span class="mpre"> as L
#endif
import           System.IO (</span><a href="GHC.IO.Handle.Types.html#loc_100_6_100_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Types.html#loc_100_6_100_12&#39;)"><span class="mpre">Handle</span></a><span class="mpre">)

#if MIN_VERSION_base(4,4,0)
#if MIN_VERSION_base(4,7,0)
import           Foreign
#else
import           Foreign hiding (unsafeForeignPtrToPtr)
#endif
import           Foreign.ForeignPtr.Unsafe (unsafeForeignPtrToPtr)
import           System.IO.Unsafe (</span><a href="GHC.IO.html#loc_182_1_182_23" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_182_1_182_23&#39;)"><span class="mpre">unsafeDupablePerformIO</span></a><span class="mpre">)
#else
import           Foreign
import           GHC.IO (</span><a href="GHC.IO.html#loc_182_1_182_23" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_182_1_182_23&#39;)"><span class="mpre">unsafeDupablePerformIO</span></a><span class="mpre">)
#endif

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Buffers</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- | A range of bytes in a buffer represented by the pointer to the first byte</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- of the range and the pointer to the first byte /after/ the range.</span></span><span class="mpre">
data </span><a name="loc_170_6_170_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_6_170_17&#39;)"><span class="hl_tycondecl"><span class="mpre">BufferRange</span></span></a><span class="mpre"> = </span><a name="loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_condecl"><span class="mpre">BufferRange</span></span></a><span class="mpre"> {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)  </span><span class="hl_comment"><span class="mpre">-- First byte of range</span></span><span class="mpre">
                               {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)  </span><span class="hl_comment"><span class="mpre">-- First byte /after/ range</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A &#39;Buffer&#39; together with the &#39;BufferRange&#39; of free bytes. The filled</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- space starts at offset 0 and ends at the first free byte.</span></span><span class="mpre">
data </span><a name="loc_175_6_175_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_6_175_12&#39;)"><span class="hl_tycondecl"><span class="mpre">Buffer</span></span></a><span class="mpre"> = </span><a name="loc_175_15_175_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_15_175_21&#39;)"><span class="hl_condecl"><span class="mpre">Buffer</span></span></a><span class="mpre"> {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">ForeignPtr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)
                     {-# UNPACK #-} !</span><a href="#loc_170_6_170_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_6_170_17&#39;)"><span class="hl_tyconref"><span class="mpre">BufferRange</span></span></a><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | Combined size of the filled and free space in the buffer.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_182_1_182_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_1_182_11&#39;)"><span class="mpre">bufferSize</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_182_1_182_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_1_182_11&#39;)"><span class="mpre">bufferSize</span></a><span class="mpre"> :: </span><a href="#loc_175_6_175_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_6_175_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_182_1_182_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_1_182_11&#39;)"><span class="hl_fundecl"><span class="mpre">bufferSize</span></span></a><span class="mpre"> (</span><a href="#loc_175_15_175_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_15_175_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_182_20_182_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_20_182_25&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> (</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> _ </span><a name="loc_182_41_182_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_41_182_44&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">)) =
    </span><a href="#loc_182_41_182_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_41_182_44&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_182_20_182_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_20_182_25&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Allocate a new buffer of the given size.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_188_1_188_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_1_188_10&#39;)"><span class="mpre">newBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_188_1_188_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_1_188_10&#39;)"><span class="mpre">newBuffer</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_175_6_175_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_6_175_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">
</span><a name="loc_188_1_188_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_1_188_10&#39;)"><span class="hl_fundecl"><span class="mpre">newBuffer</span></span></a><span class="mpre"> </span><a name="loc_188_11_188_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_11_188_15&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre"> = do
    </span><a name="loc_189_5_189_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_5_189_10&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> &lt;- </span><a href="Data.ByteString.Internal.html#loc_489_1_489_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_489_1_489_17&#39;)"><span class="hl_varref"><span class="mpre">S.mallocByteString</span></span></a><span class="mpre"> </span><a href="#loc_188_11_188_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_11_188_15&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">
    let </span><a name="loc_190_9_190_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_190_9_190_13&#39;)"><span class="hl_vardecl"><span class="mpre">pbuf</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_189_5_189_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_5_189_10&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><a href="#loc_175_15_175_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_15_175_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_189_5_189_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_5_189_10&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> (</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a href="#loc_190_9_190_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_190_9_190_13&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre"> (</span><a href="#loc_190_9_190_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_190_9_190_13&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_188_11_188_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_11_188_15&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">))

</span><span class="hl_comment"><span class="mpre">-- | Convert the filled part of a &#39;Buffer&#39; to a strict &#39;S.ByteString&#39;.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_196_1_196_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_1_196_21&#39;)"><span class="mpre">byteStringFromBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_196_1_196_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_1_196_21&#39;)"><span class="mpre">byteStringFromBuffer</span></a><span class="mpre"> :: </span><a href="#loc_175_6_175_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_6_175_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
</span><a name="loc_196_1_196_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_1_196_21&#39;)"><span class="hl_fundecl"><span class="mpre">byteStringFromBuffer</span></span></a><span class="mpre"> (</span><a href="#loc_175_15_175_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_15_175_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_196_30_196_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_30_196_35&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> (</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a name="loc_196_49_196_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_49_196_51&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _)) =
    </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_196_30_196_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_30_196_35&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> (</span><a href="#loc_196_49_196_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_49_196_51&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_196_30_196_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_30_196_35&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">--- | Prepend the filled part of a &#39;Buffer&#39; to a lazy &#39;L.ByteString&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--- trimming it if necessary.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_204_1_204_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_1_204_23&#39;)"><span class="mpre">trimmedChunkFromBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_204_1_204_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_1_204_23&#39;)"><span class="mpre">trimmedChunkFromBuffer</span></a><span class="mpre"> :: </span><a href="#loc_984_6_984_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_6_984_24&#39;)"><span class="hl_tyconref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_175_6_175_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_6_175_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">
                       -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
</span><a name="loc_204_1_204_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_1_204_23&#39;)"><span class="hl_fundecl"><span class="mpre">trimmedChunkFromBuffer</span></span></a><span class="mpre"> (</span><a href="#loc_984_27_984_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_27_984_45&#39;)"><span class="hl_conref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre"> _ _ </span><a name="loc_204_48_204_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_48_204_52&#39;)"><span class="hl_vardecl"><span class="mpre">trim</span></span></a><span class="mpre">) </span><a name="loc_204_54_204_57" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_54_204_57&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre"> </span><a name="loc_204_58_204_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_58_204_59&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">S.null</span></span><span class="mpre"> </span><a href="#loc_209_5_209_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_209_5_209_7&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">                           = </span><a href="#loc_204_58_204_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_58_204_59&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
  | </span><a href="#loc_204_48_204_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_48_204_52&#39;)"><span class="hl_varref"><span class="mpre">trim</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">S.length</span></span><span class="mpre"> </span><a href="#loc_209_5_209_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_209_5_209_7&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">) (</span><a href="#loc_182_1_182_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_1_182_11&#39;)"><span class="hl_varref"><span class="mpre">bufferSize</span></span></a><span class="mpre"> </span><a href="#loc_204_54_204_57" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_54_204_57&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">) = </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">S.copy</span></span><span class="mpre"> </span><a href="#loc_209_5_209_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_209_5_209_7&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">) </span><a href="#loc_204_58_204_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_58_204_59&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                           = </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> </span><a href="#loc_209_5_209_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_209_5_209_7&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">          </span><a href="#loc_204_58_204_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_58_204_59&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
  where
    </span><a name="loc_209_5_209_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_209_5_209_7&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> = </span><a href="#loc_196_1_196_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_1_196_21&#39;)"><span class="hl_varref"><span class="mpre">byteStringFromBuffer</span></span></a><span class="mpre"> </span><a href="#loc_204_54_204_57" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_54_204_57&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Chunked IO Stream</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A stream of chunks that are constructed in the &#39;IO&#39; monad.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This datatype serves as the common interface for the buffer-by-buffer</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- execution of a &#39;BuildStep&#39; by &#39;buildStepToCIOS&#39;. Typical users of this</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- interface are &#39;ciosToLazyByteString&#39; or iteratee-style libraries like</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @enumerator@.</span></span><span class="mpre">
data </span><a name="loc_221_6_221_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_6_221_19&#39;)"><span class="hl_tycondecl"><span class="mpre">ChunkIOStream</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> =
       </span><a name="loc_222_8_222_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_8_222_16&#39;)"><span class="hl_condecl"><span class="mpre">Finished</span></span></a><span class="mpre"> </span><a href="#loc_175_6_175_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_6_175_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- ^ The partially filled last buffer together with the result.</span></span><span class="mpre">
     | </span><a name="loc_224_8_224_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_8_224_14&#39;)"><span class="hl_condecl"><span class="mpre">Yield1</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="#loc_221_6_221_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_6_221_19&#39;)"><span class="hl_tyconref"><span class="mpre">ChunkIOStream</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">))
       </span><span class="hl_comment"><span class="mpre">-- ^ Yield a /non-empty/ strict &#39;S.ByteString&#39;.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A smart constructor for yielding one chunk that ignores the chunk if</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- it is empty.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_231_1_231_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_7&#39;)"><span class="mpre">yield1</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_231_1_231_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_7&#39;)"><span class="mpre">yield1</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="#loc_221_6_221_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_6_221_19&#39;)"><span class="hl_tyconref"><span class="mpre">ChunkIOStream</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="#loc_221_6_221_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_6_221_19&#39;)"><span class="hl_tyconref"><span class="mpre">ChunkIOStream</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_231_1_231_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_7&#39;)"><span class="hl_fundecl"><span class="mpre">yield1</span></span></a><span class="mpre"> </span><a name="loc_231_8_231_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_8_231_10&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_231_11_231_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_11_231_15&#39;)"><span class="hl_vardecl"><span class="mpre">cios</span></span></a><span class="mpre"> | </span><span class="hl_varref"><span class="mpre">S.null</span></span><span class="mpre"> </span><a href="#loc_231_8_231_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_8_231_10&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> = </span><a href="#loc_231_11_231_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_11_231_15&#39;)"><span class="hl_varref"><span class="mpre">cios</span></span></a><span class="mpre">
               | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_224_8_224_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_8_224_14&#39;)"><span class="hl_conref"><span class="mpre">Yield1</span></span></a><span class="mpre"> </span><a href="#loc_231_8_231_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_8_231_10&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="#loc_231_11_231_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_11_231_15&#39;)"><span class="hl_varref"><span class="mpre">cios</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Convert a @&#39;ChunkIOStream&#39; ()@ to a lazy &#39;L.ByteString&#39; using</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;unsafeDupablePerformIO&#39;.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_239_1_239_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_1_239_25&#39;)"><span class="mpre">ciosUnitToLazyByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_239_1_239_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_1_239_25&#39;)"><span class="mpre">ciosUnitToLazyByteString</span></a><span class="mpre"> :: </span><a href="#loc_984_6_984_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_6_984_24&#39;)"><span class="hl_tyconref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre">
                         -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_221_6_221_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_6_221_19&#39;)"><span class="hl_tyconref"><span class="mpre">ChunkIOStream</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre"> -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
</span><a name="loc_239_1_239_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_1_239_25&#39;)"><span class="hl_fundecl"><span class="mpre">ciosUnitToLazyByteString</span></span></a><span class="mpre"> </span><a name="loc_239_26_239_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_26_239_34&#39;)"><span class="hl_vardecl"><span class="mpre">strategy</span></span></a><span class="mpre"> </span><a name="loc_239_35_239_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_35_239_36&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> = </span><a href="#loc_241_5_241_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_5_241_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre">
  where
    </span><a name="loc_241_5_241_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_5_241_7&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_222_8_222_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_8_222_16&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre"> </span><a name="loc_241_18_241_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_18_241_21&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre"> _) = </span><a href="#loc_204_1_204_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_1_204_23&#39;)"><span class="hl_varref"><span class="mpre">trimmedChunkFromBuffer</span></span></a><span class="mpre"> </span><a href="#loc_239_26_239_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_26_239_34&#39;)"><span class="hl_varref"><span class="mpre">strategy</span></span></a><span class="mpre"> </span><a href="#loc_241_18_241_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_18_241_21&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> </span><a href="#loc_239_35_239_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_35_239_36&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
    </span><a href="#loc_241_5_241_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_5_241_7&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_224_8_224_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_8_224_14&#39;)"><span class="hl_conref"><span class="mpre">Yield1</span></span></a><span class="mpre"> </span><a name="loc_242_16_242_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_16_242_18&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_242_19_242_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_19_242_21&#39;)"><span class="hl_vardecl"><span class="mpre">io</span></span></a><span class="mpre">)   = </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> </span><a href="#loc_242_16_242_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_16_242_18&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="GHC.IO.html#loc_182_1_182_23" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_182_1_182_23&#39;)"><span class="hl_varref"><span class="mpre">unsafeDupablePerformIO</span></span></a><span class="mpre"> (</span><a href="#loc_241_5_241_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_5_241_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><a href="#loc_242_19_242_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_19_242_21&#39;)"><span class="hl_varref"><span class="mpre">io</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Convert a &#39;ChunkIOStream&#39; to a lazy tuple of the result and the written</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;L.ByteString&#39; using &#39;unsafeDupablePerformIO&#39;.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_251_1_251_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_251_1_251_21&#39;)"><span class="mpre">ciosToLazyByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_251_1_251_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_251_1_251_21&#39;)"><span class="mpre">ciosToLazyByteString</span></a><span class="mpre"> :: </span><a href="#loc_984_6_984_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_6_984_24&#39;)"><span class="hl_tyconref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre">
                     -&gt; (</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">, </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">))
                     -&gt; </span><a href="#loc_221_6_221_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_6_221_19&#39;)"><span class="hl_tyconref"><span class="mpre">ChunkIOStream</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
                     -&gt; (</span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">, </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">)
</span><a name="loc_251_1_251_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_251_1_251_21&#39;)"><span class="hl_fundecl"><span class="mpre">ciosToLazyByteString</span></span></a><span class="mpre"> </span><a name="loc_251_22_251_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_251_22_251_30&#39;)"><span class="hl_vardecl"><span class="mpre">strategy</span></span></a><span class="mpre"> </span><a name="loc_251_31_251_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_251_31_251_32&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> =
    </span><a href="#loc_254_5_254_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_5_254_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre">
  where
    </span><a name="loc_254_5_254_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_5_254_7&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_222_8_222_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_8_222_16&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre"> </span><a name="loc_254_18_254_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_18_254_21&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre"> </span><a name="loc_254_22_254_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_22_254_23&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre">) =
        </span><a href="Control.Arrow.html#loc_96_5_96_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Arrow.html#loc_96_5_96_11&#39;)"><span class="hl_varref"><span class="mpre">second</span></span></a><span class="mpre"> (</span><a href="#loc_204_1_204_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_1_204_23&#39;)"><span class="hl_varref"><span class="mpre">trimmedChunkFromBuffer</span></span></a><span class="mpre"> </span><a href="#loc_251_22_251_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_251_22_251_30&#39;)"><span class="hl_varref"><span class="mpre">strategy</span></span></a><span class="mpre"> </span><a href="#loc_254_18_254_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_18_254_21&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_251_31_251_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_251_31_251_32&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_254_22_254_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_22_254_23&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
    </span><a href="#loc_254_5_254_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_5_254_7&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_224_8_224_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_8_224_14&#39;)"><span class="hl_conref"><span class="mpre">Yield1</span></span></a><span class="mpre"> </span><a name="loc_256_16_256_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_256_16_256_18&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_256_19_256_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_256_19_256_21&#39;)"><span class="hl_vardecl"><span class="mpre">io</span></span></a><span class="mpre">)   = </span><a href="Control.Arrow.html#loc_96_5_96_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Arrow.html#loc_96_5_96_11&#39;)"><span class="hl_varref"><span class="mpre">second</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Lazy.Internal.html#loc_82_27_82_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_27_82_32&#39;)"><span class="hl_conref"><span class="mpre">L.Chunk</span></span></a><span class="mpre"> </span><a href="#loc_256_16_256_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_256_16_256_18&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="GHC.IO.html#loc_182_1_182_23" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_182_1_182_23&#39;)"><span class="hl_varref"><span class="mpre">unsafeDupablePerformIO</span></span></a><span class="mpre"> (</span><a href="#loc_254_5_254_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_254_5_254_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><a href="#loc_256_19_256_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_256_19_256_21&#39;)"><span class="hl_varref"><span class="mpre">io</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Build signals</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | &#39;BuildStep&#39;s may be called *multiple times* and they must not rise an</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- async. exception.</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Internal.hs&quot;, srcSpanStartLine = 264, srcSpanStartColumn = 1, srcSpanEndLine = 264, srcSpanEndColumn = 53}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Internal.hs&quot;, srcSpanStartLine = 264, srcSpanStartColumn = 1, srcSpanEndLine = 264, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0"><span class="mpre">type BuildStep a = BufferRange -&gt; IO (BuildSignal a)</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | &#39;BuildSignal&#39;s abstract signals to the caller of a &#39;BuildStep&#39;. There are</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- three signals: &#39;done&#39;, &#39;bufferFull&#39;, or &#39;insertChunks signals</span></span><span class="mpre">
data </span><a name="loc_268_6_268_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_6_268_17&#39;)"><span class="hl_tycondecl"><span class="mpre">BuildSignal</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> =
    </span><a name="loc_269_5_269_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_5_269_9&#39;)"><span class="hl_condecl"><span class="mpre">Done</span></span></a><span class="mpre"> {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">) </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
  | </span><a name="loc_270_5_270_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_270_5_270_15&#39;)"><span class="hl_condecl"><span class="mpre">BufferFull</span></span></a><span class="mpre">
      {-# UNPACK #-} !</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
      {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)
                     (</span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
  | </span><a name="loc_274_5_274_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_5_274_16&#39;)"><span class="hl_condecl"><span class="mpre">InsertChunk</span></span></a><span class="mpre">
      {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)
                     </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
                     (</span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Signal that the current &#39;BuildStep&#39; is done and has computed a value.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_284_1_284_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_1_284_5&#39;)"><span class="mpre">done</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_284_1_284_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_1_284_5&#39;)"><span class="mpre">done</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">      </span><span class="hl_comment"><span class="mpre">-- ^ Next free byte in current &#39;BufferRange&#39;</span></span><span class="mpre">
     -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">              </span><span class="hl_comment"><span class="mpre">-- ^ Computed value</span></span><span class="mpre">
     -&gt; </span><a href="#loc_268_6_268_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_6_268_17&#39;)"><span class="hl_tyconref"><span class="mpre">BuildSignal</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_284_1_284_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_284_1_284_5&#39;)"><span class="hl_vardecl"><span class="mpre">done</span></span></a><span class="mpre"> = </span><a href="#loc_269_5_269_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_5_269_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Signal that the current buffer is full.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_298_1_298_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_298_1_298_11&#39;)"><span class="mpre">bufferFull</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_298_1_298_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_298_1_298_11&#39;)"><span class="mpre">bufferFull</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
           </span><span class="hl_comment"><span class="mpre">-- ^ Minimal size of next &#39;BufferRange&#39;.</span></span><span class="mpre">
           -&gt; </span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">
           </span><span class="hl_comment"><span class="mpre">-- ^ Next free byte in current &#39;BufferRange&#39;.</span></span><span class="mpre">
           -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
           </span><span class="hl_comment"><span class="mpre">-- ^ &#39;BuildStep&#39; to run on the next &#39;BufferRange&#39;. This &#39;BuildStep&#39;</span></span><span class="mpre">
           </span><span class="hl_comment"><span class="mpre">-- may assume that it is called with a &#39;BufferRange&#39; of at least the</span></span><span class="mpre">
           </span><span class="hl_comment"><span class="mpre">-- required minimal size; i.e., the caller of this &#39;BuildStep&#39; must</span></span><span class="mpre">
           </span><span class="hl_comment"><span class="mpre">-- guarantee this.</span></span><span class="mpre">
           -&gt; </span><a href="#loc_268_6_268_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_6_268_17&#39;)"><span class="hl_tyconref"><span class="mpre">BuildSignal</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_298_1_298_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_298_1_298_11&#39;)"><span class="hl_vardecl"><span class="mpre">bufferFull</span></span></a><span class="mpre"> = </span><a href="#loc_270_5_270_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_270_5_270_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | Signal that a &#39;S.ByteString&#39; chunk should be inserted directly.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_310_1_310_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_1_310_12&#39;)"><span class="mpre">insertChunk</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_310_1_310_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_1_310_12&#39;)"><span class="mpre">insertChunk</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- ^ Next free byte in current &#39;BufferRange&#39;</span></span><span class="mpre">
            -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- ^ Chunk to insert.</span></span><span class="mpre">
            -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- ^ &#39;BuildStep&#39; to run on next &#39;BufferRange&#39;</span></span><span class="mpre">
            -&gt; </span><a href="#loc_268_6_268_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_6_268_17&#39;)"><span class="hl_tyconref"><span class="mpre">BuildSignal</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_310_1_310_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_1_310_12&#39;)"><span class="hl_fundecl"><span class="mpre">insertChunk</span></span></a><span class="mpre"> </span><a name="loc_310_13_310_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_13_310_15&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_310_16_310_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_16_310_18&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> = </span><a href="#loc_274_5_274_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_5_274_16&#39;)"><span class="hl_conref"><span class="mpre">InsertChunk</span></span></a><span class="mpre"> </span><a href="#loc_310_13_310_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_13_310_15&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_310_16_310_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_16_310_18&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | Fill a &#39;BufferRange&#39; using a &#39;BuildStep&#39;.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_328_1_328_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_1_328_18&#39;)"><span class="mpre">fillWithBuildStep</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_328_1_328_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_1_328_18&#39;)"><span class="mpre">fillWithBuildStep</span></a><span class="mpre">
    :: </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- ^ Build step to use for filling the &#39;BufferRange&#39;.</span></span><span class="mpre">
    -&gt; (</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">)
    </span><span class="hl_comment"><span class="mpre">-- ^ Handling the &#39;done&#39; signal</span></span><span class="mpre">
    -&gt; (</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">)
    </span><span class="hl_comment"><span class="mpre">-- ^ Handling the &#39;bufferFull&#39; signal</span></span><span class="mpre">
    -&gt; (</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">)
    </span><span class="hl_comment"><span class="mpre">-- ^ Handling the &#39;insertChunk&#39; signal</span></span><span class="mpre">
    -&gt; </span><a href="#loc_170_6_170_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_6_170_17&#39;)"><span class="hl_tyconref"><span class="mpre">BufferRange</span></span></a><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- ^ Buffer range to fill.</span></span><span class="mpre">
    -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- ^ Value computed while filling this &#39;BufferRange&#39;.</span></span><span class="mpre">
</span><a name="loc_328_1_328_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_1_328_18&#39;)"><span class="hl_fundecl"><span class="mpre">fillWithBuildStep</span></span></a><span class="mpre"> </span><a name="loc_328_19_328_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_19_328_23&#39;)"><span class="hl_vardecl"><span class="mpre">step</span></span></a><span class="mpre"> </span><a name="loc_328_24_328_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_24_328_29&#39;)"><span class="hl_vardecl"><span class="mpre">fDone</span></span></a><span class="mpre"> </span><a name="loc_328_30_328_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_30_328_35&#39;)"><span class="hl_vardecl"><span class="mpre">fFull</span></span></a><span class="mpre"> </span><a name="loc_328_36_328_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_36_328_42&#39;)"><span class="hl_vardecl"><span class="mpre">fChunk</span></span></a><span class="mpre"> !</span><a name="loc_328_44_328_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_44_328_46&#39;)"><span class="hl_vardecl"><span class="mpre">br</span></span></a><span class="mpre"> = do
    </span><a name="loc_329_5_329_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_329_5_329_11&#39;)"><span class="hl_vardecl"><span class="mpre">signal</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_328_19_328_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_19_328_23&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_328_44_328_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_44_328_46&#39;)"><span class="hl_varref"><span class="mpre">br</span></span></a><span class="mpre">
    case </span><a href="#loc_329_5_329_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_329_5_329_11&#39;)"><span class="hl_varref"><span class="mpre">signal</span></span></a><span class="mpre"> of
        </span><a href="#loc_269_5_269_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_5_269_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a name="loc_331_14_331_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_14_331_16&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_331_17_331_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_17_331_18&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre">                      -&gt; </span><a href="#loc_328_24_328_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_24_328_29&#39;)"><span class="hl_varref"><span class="mpre">fDone</span></span></a><span class="mpre"> </span><a href="#loc_331_14_331_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_14_331_16&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_331_17_331_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_17_331_18&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
        </span><a href="#loc_270_5_270_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_270_5_270_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre"> </span><a name="loc_332_20_332_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_332_20_332_27&#39;)"><span class="hl_vardecl"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a name="loc_332_28_332_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_332_28_332_30&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_332_31_332_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_332_31_332_39&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_328_30_328_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_30_328_35&#39;)"><span class="hl_varref"><span class="mpre">fFull</span></span></a><span class="mpre"> </span><a href="#loc_332_28_332_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_332_28_332_30&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_332_20_332_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_332_20_332_27&#39;)"><span class="hl_varref"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a href="#loc_332_31_332_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_332_31_332_39&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">
        </span><a href="#loc_274_5_274_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_5_274_16&#39;)"><span class="hl_conref"><span class="mpre">InsertChunk</span></span></a><span class="mpre"> </span><a name="loc_333_21_333_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_21_333_23&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_333_24_333_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_24_333_26&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_333_27_333_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_27_333_35&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre">     -&gt; </span><a href="#loc_328_36_328_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_36_328_42&#39;)"><span class="hl_varref"><span class="mpre">fChunk</span></span></a><span class="mpre"> </span><a href="#loc_333_21_333_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_21_333_23&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_333_24_333_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_24_333_26&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="#loc_333_27_333_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_333_27_333_35&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">


</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The &#39;Builder&#39; monoid</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | &#39;Builder&#39;s denote sequences of bytes.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- They are &#39;Monoid&#39;s where</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;mempty&#39; is the zero-length sequence and</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;mappend&#39; is concatenation, which runs in /O(1)/.</span></span><span class="mpre">
newtype </span><a name="loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tycondecl"><span class="mpre">Builder</span></span></a><span class="mpre"> = </span><a name="loc_344_19_344_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_19_344_26&#39;)"><span class="hl_condecl"><span class="mpre">Builder</span></span></a><span class="mpre"> (forall </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">. </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Construct a &#39;Builder&#39;. In contrast to &#39;BuildStep&#39;s, &#39;Builder&#39;s are</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- referentially transparent.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_364_1_364_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_8&#39;)"><span class="mpre">builder</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_364_1_364_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_8&#39;)"><span class="mpre">builder</span></a><span class="mpre"> :: (forall </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">. </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">)
        </span><span class="hl_comment"><span class="mpre">-- ^ A function that fills a &#39;BufferRange&#39;, calls the continuation with</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- the updated &#39;BufferRange&#39; once its done, and signals its caller how</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- to proceed using &#39;done&#39;, &#39;bufferFull&#39;, or &#39;insertChunk&#39;.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- This function must be referentially transparent; i.e., calling it</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- multiple times with equally sized &#39;BufferRange&#39;s must result in the</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- same sequence of bytes being written. If you need mutable state,</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- then you must allocate it anew upon each call of this function.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- Moroever, this function must call the continuation once its done.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- Otherwise, concatenation of &#39;Builder&#39;s does not work. Finally, this</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- function must write to all bytes that it claims it has written.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- Otherwise, the resulting &#39;Builder&#39; is not guaranteed to be</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- referentially transparent and sensitive data might leak.</span></span><span class="mpre">
        -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_364_1_364_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_8&#39;)"><span class="hl_vardecl"><span class="mpre">builder</span></span></a><span class="mpre"> = </span><a href="#loc_344_19_344_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_19_344_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The final build step that returns the &#39;done&#39; signal.</span></span><span class="mpre">
</span><a href="#loc_368_1_368_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_1_368_15&#39;)"><span class="mpre">finalBuildStep</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_368_1_368_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_1_368_15&#39;)"><span class="hl_fundecl"><span class="mpre">finalBuildStep</span></span></a><span class="mpre"> !(</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a name="loc_368_30_368_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_30_368_32&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_269_5_269_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_5_269_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a href="#loc_368_30_368_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_30_368_32&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run a &#39;Builder&#39; with the &#39;finalBuildStep&#39;.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_375_1_375_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_375_1_375_11&#39;)"><span class="mpre">runBuilder</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_375_1_375_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_375_1_375_11&#39;)"><span class="mpre">runBuilder</span></a><span class="mpre"> :: </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">      </span><span class="hl_comment"><span class="mpre">-- ^ &#39;Builder&#39; to run</span></span><span class="mpre">
           -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ &#39;BuildStep&#39; that writes the byte stream of this</span></span><span class="mpre">
                           </span><span class="hl_comment"><span class="mpre">-- &#39;Builder&#39; and signals &#39;done&#39; upon completion.</span></span><span class="mpre">
</span><a name="loc_375_1_375_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_375_1_375_11&#39;)"><span class="hl_fundecl"><span class="mpre">runBuilder</span></span></a><span class="mpre"> </span><a name="loc_375_12_375_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_375_12_375_13&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> = </span><a href="#loc_382_1_382_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_382_1_382_15&#39;)"><span class="hl_varref"><span class="mpre">runBuilderWith</span></span></a><span class="mpre"> </span><a href="#loc_375_12_375_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_375_12_375_13&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><a href="#loc_368_1_368_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_368_1_368_15&#39;)"><span class="hl_varref"><span class="mpre">finalBuildStep</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run a &#39;Builder&#39;.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_382_1_382_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_382_1_382_15&#39;)"><span class="mpre">runBuilderWith</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_382_1_382_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_382_1_382_15&#39;)"><span class="mpre">runBuilderWith</span></a><span class="mpre"> :: </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">      </span><span class="hl_comment"><span class="mpre">-- ^ &#39;Builder&#39; to run</span></span><span class="mpre">
               -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ Continuation &#39;BuildStep&#39;</span></span><span class="mpre">
               -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_382_1_382_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_382_1_382_15&#39;)"><span class="hl_fundecl"><span class="mpre">runBuilderWith</span></span></a><span class="mpre"> (</span><a href="#loc_344_19_344_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_19_344_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><a name="loc_382_25_382_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_382_25_382_26&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">) = </span><a href="#loc_382_25_382_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_382_25_382_26&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The &#39;Builder&#39; denoting a zero-length sequence of bytes. This function is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- only exported for use in rewriting rules. Use &#39;mempty&#39; otherwise.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE[1] </span><a href="#loc_388_1_388_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_388_1_388_6&#39;)"><span class="mpre">empty</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_388_1_388_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_388_1_388_6&#39;)"><span class="mpre">empty</span></a><span class="mpre"> :: </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_388_1_388_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_388_1_388_6&#39;)"><span class="hl_vardecl"><span class="mpre">empty</span></span></a><span class="mpre"> = </span><a href="#loc_344_19_344_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_19_344_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">id</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Concatenate two &#39;Builder&#39;s. This function is only exported for use in rewriting</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- rules. Use &#39;mappend&#39; otherwise.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE[1] </span><a href="#loc_394_1_394_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_394_1_394_7&#39;)"><span class="mpre">append</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_394_1_394_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_394_1_394_7&#39;)"><span class="mpre">append</span></a><span class="mpre"> :: </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_394_1_394_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_394_1_394_7&#39;)"><span class="hl_fundecl"><span class="mpre">append</span></span></a><span class="mpre"> (</span><a href="#loc_344_19_344_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_19_344_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><a name="loc_394_17_394_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_394_17_394_19&#39;)"><span class="hl_vardecl"><span class="mpre">b1</span></span></a><span class="mpre">) (</span><a href="#loc_344_19_344_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_19_344_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><a name="loc_394_30_394_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_394_30_394_32&#39;)"><span class="hl_vardecl"><span class="mpre">b2</span></span></a><span class="mpre">) = </span><a href="#loc_344_19_344_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_19_344_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_394_17_394_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_394_17_394_19&#39;)"><span class="hl_varref"><span class="mpre">b1</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_394_30_394_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_394_30_394_32&#39;)"><span class="hl_varref"><span class="mpre">b2</span></span></a><span class="mpre">

instance </span><a href="Data.Monoid.html#loc_79_7_79_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_79_7_79_13&#39;)"><span class="hl_classref"><span class="mpre">Monoid</span></span></a><span class="mpre"> </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> where
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="mpre">mempty</span></a><span class="mpre"> #-}</span></span><span class="mpre">
  </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_vardecl"><span class="mpre">mempty</span></span></a><span class="mpre"> = </span><a href="#loc_388_1_388_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_388_1_388_6&#39;)"><span class="hl_varref"><span class="mpre">empty</span></span></a><span class="mpre">
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="mpre">mappend</span></a><span class="mpre"> #-}</span></span><span class="mpre">
  </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_vardecl"><span class="mpre">mappend</span></span></a><span class="mpre"> = </span><a href="#loc_394_1_394_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_394_1_394_7&#39;)"><span class="hl_varref"><span class="mpre">append</span></span></a><span class="mpre">
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="mpre">mconcat</span></a><span class="mpre"> #-}</span></span><span class="mpre">
  </span><a href="Data.Monoid.html#loc_84_9_84_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_84_9_84_16&#39;)"><span class="hl_vardecl"><span class="mpre">mconcat</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">foldr</span></span><span class="mpre"> </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_varref"><span class="mpre">mappend</span></span></a><span class="mpre"> </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Flush the current buffer. This introduces a chunk boundary.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_407_1_407_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_407_1_407_6&#39;)"><span class="mpre">flush</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_407_1_407_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_407_1_407_6&#39;)"><span class="mpre">flush</span></a><span class="mpre"> :: </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_407_1_407_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_407_1_407_6&#39;)"><span class="hl_vardecl"><span class="mpre">flush</span></span></a><span class="mpre"> = </span><a href="#loc_364_1_364_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_8&#39;)"><span class="hl_varref"><span class="mpre">builder</span></span></a><span class="mpre"> </span><a href="#loc_409_5_409_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_409_5_409_9&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre">
  where
    </span><a name="loc_409_5_409_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_409_5_409_9&#39;)"><span class="hl_fundecl"><span class="mpre">step</span></span></a><span class="mpre"> </span><a name="loc_409_10_409_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_409_10_409_11&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> !(</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a name="loc_409_26_409_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_409_26_409_28&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_310_1_310_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_1_310_12&#39;)"><span class="hl_varref"><span class="mpre">insertChunk</span></span></a><span class="mpre"> </span><a href="#loc_409_26_409_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_409_26_409_28&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">S.empty</span></span><span class="mpre"> </span><a href="#loc_409_10_409_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_409_10_409_11&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">


</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Put</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A &#39;Put&#39; action denotes a computation of a value that writes a stream of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- bytes as a side-effect. &#39;Put&#39;s are strict in their side-effect; i.e., the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- stream of bytes will always be written before the computed value is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- returned.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;Put&#39;s are a generalization of &#39;Builder&#39;s. The typical use case is the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- implementation of an encoding that might fail (e.g., an interface to the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;zlib&#39; compression library or the conversion from Base64 encoded data to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- 8-bit data). For a &#39;Builder&#39;, the only way to handle and report such a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- failure is ignore it or call &#39;error&#39;.  In contrast, &#39;Put&#39; actions are</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- expressive enough to allow reportng and handling such a failure in a pure</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- fashion.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @&#39;Put&#39; ()@ actions are isomorphic to &#39;Builder&#39;s. The functions &#39;putBuilder&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- and &#39;fromPut&#39; convert between these two types. Where possible, you should</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- use &#39;Builder&#39;s, as sequencing them is slightly cheaper than sequencing</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;Put&#39;s because they do not carry around a computed value.</span></span><span class="mpre">
newtype </span><a name="loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tycondecl"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> = </span><a name="loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_condecl"><span class="mpre">Put</span></span></a><span class="mpre"> { </span><a name="loc_433_23_433_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_23_433_28&#39;)"><span class="hl_fielddecl"><span class="mpre">unPut</span></span></a><span class="mpre"> :: forall </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">. (</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre"> }

</span><span class="hl_comment"><span class="mpre">-- | Construct a &#39;Put&#39; action. In contrast to &#39;BuildStep&#39;s, &#39;Put&#39;s are</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- referentially transparent in the sense that sequencing the same &#39;Put&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- multiple times yields every time the same value with the same side-effect.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_456_1_456_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_456_1_456_4&#39;)"><span class="mpre">put</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_456_1_456_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_456_1_456_4&#39;)"><span class="mpre">put</span></a><span class="mpre"> :: (forall </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">. (</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">r</span></span><span class="mpre">)
       </span><span class="hl_comment"><span class="mpre">-- ^ A function that fills a &#39;BufferRange&#39;, calls the continuation with</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- the updated &#39;BufferRange&#39; and its computed value once its done, and</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- signals its caller how to proceed using &#39;done&#39;, &#39;bufferFull&#39;, or</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- &#39;insertChunk&#39; signals.</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- This function must be referentially transparent; i.e., calling it</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- multiple times with equally sized &#39;BufferRange&#39;s must result in the</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- same sequence of bytes being written and the same value being</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- computed. If you need mutable state, then you must allocate it anew</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- upon each call of this function. Moroever, this function must call</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- the continuation once its done. Otherwise, monadic sequencing of</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- &#39;Put&#39;s does not work. Finally, this function must write to all bytes</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- that it claims it has written. Otherwise, the resulting &#39;Put&#39; is</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- not guaranteed to be referentially transparent and sensitive data</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- might leak.</span></span><span class="mpre">
       -&gt; </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_456_1_456_4" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_456_1_456_4&#39;)"><span class="hl_vardecl"><span class="mpre">put</span></span></a><span class="mpre"> = </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run a &#39;Put&#39;.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_464_1_464_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_1_464_7&#39;)"><span class="mpre">runPut</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_464_1_464_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_1_464_7&#39;)"><span class="mpre">runPut</span></a><span class="mpre"> :: </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">       </span><span class="hl_comment"><span class="mpre">-- ^ Put to run</span></span><span class="mpre">
       -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ &#39;BuildStep&#39; that first writes the byte stream of</span></span><span class="mpre">
                      </span><span class="hl_comment"><span class="mpre">-- this &#39;Put&#39; and then yields the computed value using</span></span><span class="mpre">
                      </span><span class="hl_comment"><span class="mpre">-- the &#39;done&#39; signal.</span></span><span class="mpre">
</span><a name="loc_464_1_464_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_1_464_7&#39;)"><span class="hl_fundecl"><span class="mpre">runPut</span></span></a><span class="mpre"> (</span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_464_13_464_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_13_464_14&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre">) = </span><a href="#loc_464_13_464_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_13_464_14&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_464_23_464_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_23_464_24&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> (</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a name="loc_464_38_464_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_38_464_40&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _) -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_269_5_269_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_269_5_269_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a href="#loc_464_38_464_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_38_464_40&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_464_23_464_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_23_464_24&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">

instance </span><span class="hl_classref"><span class="mpre">Functor</span></span><span class="mpre"> </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> where
  </span><span class="hl_fundecl"><span class="mpre">fmap</span></span><span class="mpre"> </span><a name="loc_467_8_467_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_467_8_467_9&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> </span><a name="loc_467_10_467_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_467_10_467_11&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> = </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_467_21_467_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_467_21_467_22&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_433_23_433_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_23_433_28&#39;)"><span class="hl_varref"><span class="mpre">unPut</span></span></a><span class="mpre"> </span><a href="#loc_467_10_467_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_467_10_467_11&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> (\</span><a name="loc_467_36_467_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_467_36_467_37&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_467_21_467_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_467_21_467_22&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> (</span><a href="#loc_467_8_467_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_467_8_467_9&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_467_36_467_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_467_36_467_37&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">))
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE fmap #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Synonym for &#39;&lt;*&#39; from &#39;Applicative&#39;; used in rewriting rules.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE[1] </span><a href="#loc_473_1_473_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_1_473_5&#39;)"><span class="mpre">ap_l</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_473_1_473_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_1_473_5&#39;)"><span class="mpre">ap_l</span></a><span class="mpre"> :: </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre"> -&gt; </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_473_1_473_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_1_473_5&#39;)"><span class="hl_fundecl"><span class="mpre">ap_l</span></span></a><span class="mpre"> (</span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_473_11_473_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_11_473_12&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre">) (</span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_473_19_473_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_19_473_20&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">) = </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_473_31_473_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_31_473_32&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_473_11_473_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_11_473_12&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre"> (\</span><a name="loc_473_40_473_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_40_473_42&#39;)"><span class="hl_vardecl"><span class="mpre">a&#39;</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_473_19_473_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_19_473_20&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> (\_ -&gt; </span><a href="#loc_473_31_473_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_31_473_32&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_473_40_473_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_40_473_42&#39;)"><span class="hl_varref"><span class="mpre">a&#39;</span></span></a><span class="mpre">))

</span><span class="hl_comment"><span class="mpre">-- | Synonym for &#39;*&gt;&#39; from &#39;Applicative&#39; and &#39;&gt;&gt;&#39; from &#39;Monad&#39;; used in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- rewriting rules.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE[1] </span><a href="#loc_479_1_479_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_479_1_479_5&#39;)"><span class="mpre">ap_r</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_479_1_479_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_479_1_479_5&#39;)"><span class="mpre">ap_r</span></a><span class="mpre"> :: </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre"> -&gt; </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">
</span><a name="loc_479_1_479_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_479_1_479_5&#39;)"><span class="hl_fundecl"><span class="mpre">ap_r</span></span></a><span class="mpre"> (</span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_479_11_479_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_479_11_479_12&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre">) (</span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_479_19_479_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_479_19_479_20&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">) = </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_479_31_479_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_479_31_479_32&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_479_11_479_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_479_11_479_12&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre"> (\_ -&gt; </span><a href="#loc_479_19_479_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_479_19_479_20&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><a href="#loc_479_31_479_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_479_31_479_32&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">)

instance </span><a href="Control.Applicative.html#loc_113_20_113_31" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_113_20_113_31&#39;)"><span class="hl_classref"><span class="mpre">Applicative</span></span></a><span class="mpre"> </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> where
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Control.Applicative.html#loc_115_5_115_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_115_5_115_9&#39;)"><span class="mpre">pure</span></a><span class="mpre"> #-}</span></span><span class="mpre">
  </span><a href="Control.Applicative.html#loc_115_5_115_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_115_5_115_9&#39;)"><span class="hl_fundecl"><span class="mpre">pure</span></span></a><span class="mpre"> </span><a name="loc_483_8_483_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_483_8_483_9&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> = </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_483_19_483_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_483_19_483_20&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_483_19_483_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_483_19_483_20&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_483_8_483_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_483_8_483_9&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Control.Applicative.html#loc_118_5_118_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_118_5_118_10&#39;)"><span class="mpre">(&lt;*&gt;)</span></a><span class="mpre"> #-}</span></span><span class="mpre">
  </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_485_7_485_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_485_7_485_8&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="Control.Applicative.html#loc_118_5_118_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_118_5_118_10&#39;)"><span class="hl_fundecl"><span class="mpre">&lt;*&gt;</span></span></a><span class="mpre"> </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_485_17_485_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_485_17_485_18&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> = </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_485_28_485_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_485_28_485_29&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_485_7_485_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_485_7_485_8&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> (\</span><a name="loc_485_37_485_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_485_37_485_39&#39;)"><span class="hl_vardecl"><span class="mpre">f&#39;</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_485_17_485_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_485_17_485_18&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre"> (\</span><a name="loc_485_47_485_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_485_47_485_49&#39;)"><span class="hl_vardecl"><span class="mpre">a&#39;</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_485_28_485_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_485_28_485_29&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> (</span><a href="#loc_485_37_485_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_485_37_485_39&#39;)"><span class="hl_varref"><span class="mpre">f&#39;</span></span></a><span class="mpre"> </span><a href="#loc_485_47_485_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_485_47_485_49&#39;)"><span class="hl_varref"><span class="mpre">a&#39;</span></span></a><span class="mpre">)))
#if MIN_VERSION_base(4,2,0)
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Control.Applicative.html#loc_125_5_125_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_125_5_125_9&#39;)"><span class="mpre">(&lt;*)</span></a><span class="mpre"> #-}</span></span><span class="mpre">
  </span><a href="Control.Applicative.html#loc_125_5_125_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_125_5_125_9&#39;)"><span class="hl_vardecl"><span class="mpre">(&lt;*)</span></span></a><span class="mpre"> = </span><a href="#loc_473_1_473_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_473_1_473_5&#39;)"><span class="hl_varref"><span class="mpre">ap_l</span></span></a><span class="mpre">
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="Control.Applicative.html#loc_121_5_121_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_121_5_121_9&#39;)"><span class="mpre">(*&gt;)</span></a><span class="mpre"> #-}</span></span><span class="mpre">
  </span><a href="Control.Applicative.html#loc_121_5_121_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_121_5_121_9&#39;)"><span class="hl_vardecl"><span class="mpre">(*&gt;)</span></span></a><span class="mpre"> = </span><a href="#loc_479_1_479_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_479_1_479_5&#39;)"><span class="hl_varref"><span class="mpre">ap_r</span></span></a><span class="mpre">
#endif

instance </span><span class="hl_classref"><span class="mpre">Monad</span></span><span class="mpre"> </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> where
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE return #-}</span></span><span class="mpre">
  </span><span class="hl_fundecl"><span class="mpre">return</span></span><span class="mpre"> </span><a name="loc_495_10_495_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_495_10_495_11&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> = </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_495_21_495_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_495_21_495_22&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_495_21_495_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_495_21_495_22&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_495_10_495_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_495_10_495_11&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE (&gt;&gt;=) #-}</span></span><span class="mpre">
  </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_497_7_497_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_497_7_497_8&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre"> </span><span class="hl_fundecl"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a name="loc_497_13_497_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_497_13_497_14&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_497_24_497_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_497_24_497_25&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_497_7_497_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_497_7_497_8&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> (\</span><a name="loc_497_33_497_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_497_33_497_35&#39;)"><span class="hl_vardecl"><span class="mpre">m&#39;</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_433_23_433_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_23_433_28&#39;)"><span class="hl_varref"><span class="mpre">unPut</span></span></a><span class="mpre"> (</span><a href="#loc_497_13_497_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_497_13_497_14&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_497_33_497_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_497_33_497_35&#39;)"><span class="hl_varref"><span class="mpre">m&#39;</span></span></a><span class="mpre">) </span><a href="#loc_497_24_497_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_497_24_497_25&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">)
  </span><span class="hl_pragma"><span class="mpre">{-# INLINE (&gt;&gt;) #-}</span></span><span class="mpre">
  </span><span class="hl_vardecl"><span class="mpre">(&gt;&gt;)</span></span><span class="mpre"> = </span><a href="#loc_479_1_479_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_479_1_479_5&#39;)"><span class="hl_varref"><span class="mpre">ap_r</span></span></a><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- Conversion between Put and Builder</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run a &#39;Builder&#39; as a side-effect of a @&#39;Put&#39; ()@ action.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE[1] </span><a href="#loc_508_1_508_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_508_1_508_11&#39;)"><span class="mpre">putBuilder</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_508_1_508_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_508_1_508_11&#39;)"><span class="mpre">putBuilder</span></a><span class="mpre"> :: </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_508_1_508_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_508_1_508_11&#39;)"><span class="hl_fundecl"><span class="mpre">putBuilder</span></span></a><span class="mpre"> (</span><a href="#loc_344_19_344_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_19_344_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><a name="loc_508_21_508_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_508_21_508_22&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">) = </span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_508_33_508_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_508_33_508_34&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_508_21_508_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_508_21_508_22&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> (</span><a href="#loc_508_33_508_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_508_33_508_34&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Convert a @&#39;Put&#39; ()@ action to a &#39;Builder&#39;.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_513_1_513_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_513_1_513_8&#39;)"><span class="mpre">fromPut</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_513_1_513_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_513_1_513_8&#39;)"><span class="mpre">fromPut</span></a><span class="mpre"> :: </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_513_1_513_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_513_1_513_8&#39;)"><span class="hl_fundecl"><span class="mpre">fromPut</span></span></a><span class="mpre"> (</span><a href="#loc_433_17_433_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_17_433_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_513_14_513_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_513_14_513_15&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre">) = </span><a href="#loc_344_19_344_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_19_344_26&#39;)"><span class="hl_conref"><span class="mpre">Builder</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_513_30_513_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_513_30_513_31&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_513_14_513_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_513_14_513_15&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> (\_ -&gt; </span><a href="#loc_513_30_513_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_513_30_513_31&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- We rewrite consecutive uses of &#39;putBuilder&#39; such that the append of the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- involved &#39;Builder&#39;s is used. This can significantly improve performance,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- when the bound-checks of the concatenated builders are fused.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- ap_l rules</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# RULES

&quot;ap_l/putBuilder&quot; forall b1 b2.
       ap_l (putBuilder b1) (putBuilder b2)
     = putBuilder (append b1 b2)

&quot;ap_l/putBuilder/assoc_r&quot; forall b1 b2 (p :: Put a).
       ap_l (putBuilder b1) (ap_l (putBuilder b2) p)
     = ap_l (putBuilder (append b1 b2)) p

&quot;ap_l/putBuilder/assoc_l&quot; forall (p :: Put a) b1 b2.
       ap_l (ap_l p (putBuilder b1)) (putBuilder b2)
     = ap_l p (putBuilder (append b1 b2))
 #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- ap_r rules</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# RULES

&quot;ap_r/putBuilder&quot; forall b1 b2.
       ap_r (putBuilder b1) (putBuilder b2)
     = putBuilder (append b1 b2)

&quot;ap_r/putBuilder/assoc_r&quot; forall b1 b2 (p :: Put a).
       ap_r (putBuilder b1) (ap_r (putBuilder b2) p)
     = ap_r (putBuilder (append b1 b2)) p

&quot;ap_r/putBuilder/assoc_l&quot; forall (p :: Put a) b1 b2.
       ap_r (ap_r p (putBuilder b1)) (putBuilder b2)
     = ap_r p (putBuilder (append b1 b2))

 #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- combined ap_l/ap_r rules</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# RULES

&quot;ap_l/ap_r/putBuilder/assoc_r&quot; forall b1 b2 (p :: Put a).
       ap_l (putBuilder b1) (ap_r (putBuilder b2) p)
     = ap_l (putBuilder (append b1 b2)) p

&quot;ap_r/ap_l/putBuilder/assoc_r&quot; forall b1 b2 (p :: Put a).
       ap_r (putBuilder b1) (ap_l (putBuilder b2) p)
     = ap_l (putBuilder (append b1 b2)) p

&quot;ap_l/ap_r/putBuilder/assoc_l&quot; forall (p :: Put a) b1 b2.
       ap_l (ap_r p (putBuilder b1)) (putBuilder b2)
     = ap_r p (putBuilder (append b1 b2))

&quot;ap_r/ap_l/putBuilder/assoc_l&quot; forall (p :: Put a) b1 b2.
       ap_r (ap_l p (putBuilder b1)) (putBuilder b2)
     = ap_r p (putBuilder (append b1 b2))

 #-}</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- Lifting IO actions</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">---------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">{-
-- | Lift an &#39;IO&#39; action to a &#39;Put&#39; action.
{-# INLINE putLiftIO #-}
putLiftIO :: IO a -&gt; Put a
putLiftIO io = put $ \k br -&gt; io &gt;&gt;= (`k` br)
-}</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Executing a Put directly on a buffered Handle</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run a &#39;Put&#39; action redirecting the produced output to a &#39;Handle&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The output is buffered using the &#39;Handle&#39;s associated buffer. If this</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- buffer is too small to execute one step of the &#39;Put&#39; action, then</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- it is replaced with a large enough buffer.</span></span><span class="mpre">
</span><a href="#loc_596_1_596_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_596_1_596_5&#39;)"><span class="mpre">hPut</span></a><span class="mpre"> :: forall </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">. </span><a href="GHC.IO.Handle.Types.html#loc_100_6_100_12" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Types.html#loc_100_6_100_12&#39;)"><span class="hl_tyconref"><span class="mpre">Handle</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
#if __GLASGOW_HASKELL__ &gt;= 611
</span><a name="loc_596_1_596_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_596_1_596_5&#39;)"><span class="hl_fundecl"><span class="mpre">hPut</span></span></a><span class="mpre"> </span><a name="loc_596_6_596_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_596_6_596_7&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre"> </span><a name="loc_596_8_596_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_596_8_596_9&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> = do
    </span><a href="#loc_600_5_600_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_5_600_15&#39;)"><span class="hl_varref"><span class="mpre">fillHandle</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> (</span><a href="#loc_464_1_464_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_1_464_7&#39;)"><span class="hl_varref"><span class="mpre">runPut</span></span></a><span class="mpre"> </span><a href="#loc_596_8_596_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_596_8_596_9&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">)
  where
    </span><a href="#loc_600_5_600_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_5_600_15&#39;)"><span class="mpre">fillHandle</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
    </span><a name="loc_600_5_600_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_5_600_15&#39;)"><span class="hl_fundecl"><span class="mpre">fillHandle</span></span></a><span class="mpre"> !</span><a name="loc_600_17_600_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_17_600_24&#39;)"><span class="hl_vardecl"><span class="mpre">minFree</span></span></a><span class="mpre"> </span><a name="loc_600_25_600_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_25_600_29&#39;)"><span class="hl_vardecl"><span class="mpre">step</span></span></a><span class="mpre"> = do
        </span><a name="loc_601_9_601_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_601_9_601_13&#39;)"><span class="hl_vardecl"><span class="mpre">next</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IO.Handle.Internals.html#loc_225_1_225_19" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Internals.html#loc_225_1_225_19&#39;)"><span class="hl_varref"><span class="mpre">wantWritableHandle</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;hPut&quot;</span></span><span class="mpre"> </span><a href="#loc_596_6_596_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_596_6_596_7&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> </span><a href="#loc_627_9_627_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_627_9_627_20&#39;)"><span class="hl_varref"><span class="mpre">fillHandle_</span></span></a><span class="mpre">
        </span><a href="#loc_601_9_601_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_601_9_601_13&#39;)"><span class="hl_varref"><span class="mpre">next</span></span></a><span class="mpre">
      where
        </span><span class="hl_comment"><span class="mpre">-- | We need to return an inner IO action that is executed outside</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- the lock taken on the Handle for two reasons:</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--   1. GHC.IO.Handle.Internals mentions in &quot;Note [async]&quot; that</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      we should never do any side-effecting operations before</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      an interuptible operation that may raise an async. exception</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      as long as we are inside &#39;wantWritableHandle&#39; and the like.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      We possibly run the interuptible &#39;flushWriteBuffer&#39; right at</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      the start of &#39;fillHandle&#39;, hence entering it a second time is</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      not safe, as it could lead to a &#39;BuildStep&#39; being run twice.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      FIXME (SM): Adapt this function or at least its documentation,</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      as it is OK to run a &#39;BuildStep&#39; twice. We dropped this</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      requirement in favor of being able to use</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      &#39;unsafeDupablePerformIO&#39; and the speed improvement that it</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      brings.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--   2. We use the &#39;S.hPut&#39; function to also write to the handle.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      This function tries to take the same lock taken by</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      &#39;wantWritableHandle&#39;. Therefore, we cannot call &#39;S.hPut&#39;</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--      inside &#39;wantWritableHandle&#39;.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
        </span><a href="#loc_627_9_627_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_627_9_627_20&#39;)"><span class="mpre">fillHandle_</span></a><span class="mpre"> :: </span><a href="GHC.IO.Handle.Types.html#loc_124_6_124_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Types.html#loc_124_6_124_14&#39;)"><span class="hl_tyconref"><span class="mpre">Handle__</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
        </span><a name="loc_627_9_627_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_627_9_627_20&#39;)"><span class="hl_fundecl"><span class="mpre">fillHandle_</span></span></a><span class="mpre"> </span><a name="loc_627_21_627_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_627_21_627_23&#39;)"><span class="hl_vardecl"><span class="mpre">h_</span></span></a><span class="mpre"> = do
            </span><a href="#loc_634_13_634_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_634_13_634_22&#39;)"><span class="hl_varref"><span class="mpre">makeSpace</span></span></a><span class="mpre">  </span><span class="hl_infix"><span class="mpre">=&lt;&lt;</span></span><span class="mpre"> </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_631_13_631_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_631_13_631_19&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre">
            </span><a href="#loc_649_13_649_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_649_13_649_23&#39;)"><span class="hl_varref"><span class="mpre">fillBuffer</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">=&lt;&lt;</span></span><span class="mpre"> </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_631_13_631_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_631_13_631_19&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre">
          where
            </span><a name="loc_631_13_631_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_631_13_631_19&#39;)"><span class="hl_vardecl"><span class="mpre">refBuf</span></span></a><span class="mpre">        = </span><a href="GHC.IO.Handle.Types.html#loc_129_7_129_19" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Types.html#loc_129_7_129_19&#39;)"><span class="hl_varref"><span class="mpre">haByteBuffer</span></span></a><span class="mpre"> </span><a href="#loc_627_21_627_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_627_21_627_23&#39;)"><span class="hl_varref"><span class="mpre">h_</span></span></a><span class="mpre">
            </span><a name="loc_632_13_632_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_632_13_632_22&#39;)"><span class="hl_fundecl"><span class="mpre">freeSpace</span></span></a><span class="mpre"> </span><a name="loc_632_23_632_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_632_23_632_26&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Buffer.html#loc_184_9_184_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_184_9_184_16&#39;)"><span class="hl_varref"><span class="mpre">IO.bufSize</span></span></a><span class="mpre"> </span><a href="#loc_632_23_632_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_632_23_632_26&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_186_9_186_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_186_9_186_13&#39;)"><span class="hl_varref"><span class="mpre">IO.bufR</span></span></a><span class="mpre"> </span><a href="#loc_632_23_632_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_632_23_632_26&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">

            </span><a name="loc_634_13_634_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_634_13_634_22&#39;)"><span class="hl_fundecl"><span class="mpre">makeSpace</span></span></a><span class="mpre"> </span><a name="loc_634_23_634_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_634_23_634_26&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre">
              | </span><a href="GHC.IO.Buffer.html#loc_184_9_184_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_184_9_184_16&#39;)"><span class="hl_varref"><span class="mpre">IO.bufSize</span></span></a><span class="mpre"> </span><a href="#loc_634_23_634_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_634_23_634_26&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><a href="#loc_600_17_600_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_17_600_24&#39;)"><span class="hl_varref"><span class="mpre">minFree</span></span></a><span class="mpre"> = do
                  </span><a href="GHC.IO.Handle.Internals.html#loc_490_1_490_17" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Internals.html#loc_490_1_490_17&#39;)"><span class="hl_varref"><span class="mpre">flushWriteBuffer</span></span></a><span class="mpre"> </span><a href="#loc_627_21_627_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_627_21_627_23&#39;)"><span class="hl_varref"><span class="mpre">h_</span></span></a><span class="mpre">
                  </span><a name="loc_637_19_637_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_637_19_637_20&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IO.Buffer.html#loc_183_9_183_17" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_183_9_183_17&#39;)"><span class="hl_varref"><span class="mpre">IO.bufState</span></span></a><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_631_13_631_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_631_13_631_19&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre">
                  </span><a href="GHC.IO.Buffer.html#loc_244_1_244_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_244_1_244_14&#39;)"><span class="hl_varref"><span class="mpre">IO.newByteBuffer</span></span></a><span class="mpre"> </span><a href="#loc_600_17_600_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_17_600_24&#39;)"><span class="hl_varref"><span class="mpre">minFree</span></span></a><span class="mpre"> </span><a href="#loc_637_19_637_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_637_19_637_20&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_631_13_631_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_631_13_631_19&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre">

              | </span><a href="#loc_632_13_632_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_632_13_632_22&#39;)"><span class="hl_varref"><span class="mpre">freeSpace</span></span></a><span class="mpre"> </span><a href="#loc_634_23_634_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_634_23_634_26&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><a href="#loc_600_17_600_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_17_600_24&#39;)"><span class="hl_varref"><span class="mpre">minFree</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Handle.Internals.html#loc_490_1_490_17" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Internals.html#loc_490_1_490_17&#39;)"><span class="hl_varref"><span class="mpre">flushWriteBuffer</span></span></a><span class="mpre"> </span><a href="#loc_627_21_627_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_627_21_627_23&#39;)"><span class="hl_varref"><span class="mpre">h_</span></span></a><span class="mpre">
              | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">               =
#if __GLASGOW_HASKELL__ &gt;= 613
                                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
#else
                                          </span><span class="hl_comment"><span class="mpre">-- required for ghc-6.12</span></span><span class="mpre">
                                          </span><a href="GHC.IO.Handle.Internals.html#loc_490_1_490_17" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Internals.html#loc_490_1_490_17&#39;)"><span class="hl_varref"><span class="mpre">flushWriteBuffer</span></span></a><span class="mpre"> </span><a href="#loc_627_21_627_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_627_21_627_23&#39;)"><span class="hl_varref"><span class="mpre">h_</span></span></a><span class="mpre">
#endif

            </span><a name="loc_649_13_649_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_649_13_649_23&#39;)"><span class="hl_fundecl"><span class="mpre">fillBuffer</span></span></a><span class="mpre"> </span><a name="loc_649_24_649_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_649_24_649_27&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre">
              | </span><a href="#loc_632_13_632_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_632_13_632_22&#39;)"><span class="hl_varref"><span class="mpre">freeSpace</span></span></a><span class="mpre"> </span><a href="#loc_649_24_649_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_649_24_649_27&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><a href="#loc_600_17_600_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_17_600_24&#39;)"><span class="hl_varref"><span class="mpre">minFree</span></span></a><span class="mpre"> =
                  </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">unlines</span></span><span class="mpre">
                    [ </span><span class="hl_string"><span class="mpre">&quot;Data.ByteString.Builder.Internal.hPut: internal error.&quot;</span></span><span class="mpre">
                    , </span><span class="hl_string"><span class="mpre">&quot;  Not enough space after flush.&quot;</span></span><span class="mpre">
                    , </span><span class="hl_string"><span class="mpre">&quot;    required: &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_600_17_600_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_17_600_24&#39;)"><span class="hl_varref"><span class="mpre">minFree</span></span></a><span class="mpre">
                    , </span><span class="hl_string"><span class="mpre">&quot;    free: &quot;</span></span><span class="mpre">     </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> (</span><a href="#loc_632_13_632_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_632_13_632_22&#39;)"><span class="hl_varref"><span class="mpre">freeSpace</span></span></a><span class="mpre"> </span><a href="#loc_649_24_649_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_649_24_649_27&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">)
                    ]
              | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = do
                  let !</span><a name="loc_658_24_658_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_658_24_658_26&#39;)"><span class="hl_vardecl"><span class="mpre">br</span></span></a><span class="mpre"> = </span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a href="#loc_665_17_665_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_665_17_665_19&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> (</span><a href="#loc_664_17_664_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_664_17_664_21&#39;)"><span class="hl_varref"><span class="mpre">pBuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_184_9_184_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_184_9_184_16&#39;)"><span class="hl_varref"><span class="mpre">IO.bufSize</span></span></a><span class="mpre"> </span><a href="#loc_649_24_649_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_649_24_649_27&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">)
                  </span><a name="loc_659_19_659_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_659_19_659_22&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_328_1_328_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_1_328_18&#39;)"><span class="hl_varref"><span class="mpre">fillWithBuildStep</span></span></a><span class="mpre"> </span><a href="#loc_600_25_600_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_25_600_29&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_673_17_673_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_673_17_673_22&#39;)"><span class="hl_varref"><span class="mpre">doneH</span></span></a><span class="mpre"> </span><a href="#loc_684_17_684_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_684_17_684_22&#39;)"><span class="hl_varref"><span class="mpre">fullH</span></span></a><span class="mpre"> </span><a href="#loc_691_17_691_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_691_17_691_29&#39;)"><span class="hl_varref"><span class="mpre">insertChunkH</span></span></a><span class="mpre"> </span><a href="#loc_658_24_658_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_658_24_658_26&#39;)"><span class="hl_varref"><span class="mpre">br</span></span></a><span class="mpre">
                  </span><a href="Foreign.ForeignPtr.html#loc_74_1_74_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.html#loc_74_1_74_16&#39;)"><span class="hl_varref"><span class="mpre">touchForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_663_17_663_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_663_17_663_22&#39;)"><span class="hl_varref"><span class="mpre">fpBuf</span></span></a><span class="mpre">
                  </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_659_19_659_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_659_19_659_22&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">
              where
                </span><a name="loc_663_17_663_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_663_17_663_22&#39;)"><span class="hl_vardecl"><span class="mpre">fpBuf</span></span></a><span class="mpre"> = </span><a href="GHC.IO.Buffer.html#loc_182_9_182_15" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_182_9_182_15&#39;)"><span class="hl_varref"><span class="mpre">IO.bufRaw</span></span></a><span class="mpre"> </span><a href="#loc_649_24_649_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_649_24_649_27&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">
                </span><a name="loc_664_17_664_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_664_17_664_21&#39;)"><span class="hl_vardecl"><span class="mpre">pBuf</span></span></a><span class="mpre">  = </span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_663_17_663_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_663_17_663_22&#39;)"><span class="hl_varref"><span class="mpre">fpBuf</span></span></a><span class="mpre">
                </span><a name="loc_665_17_665_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_665_17_665_19&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre">    = </span><a href="#loc_664_17_664_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_664_17_664_21&#39;)"><span class="hl_varref"><span class="mpre">pBuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="GHC.IO.Buffer.html#loc_186_9_186_13" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Buffer.html#loc_186_9_186_13&#39;)"><span class="hl_varref"><span class="mpre">IO.bufR</span></span></a><span class="mpre"> </span><a href="#loc_649_24_649_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_649_24_649_27&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">

                </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_668_17_668_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_668_17_668_27&#39;)"><span class="mpre">updateBufR</span></a><span class="mpre"> #-}</span></span><span class="mpre">
                </span><a name="loc_668_17_668_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_668_17_668_27&#39;)"><span class="hl_fundecl"><span class="mpre">updateBufR</span></span></a><span class="mpre"> </span><a name="loc_668_28_668_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_668_28_668_31&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> = do
                    let !</span><span class="hl_vardecl"><span class="mpre">off&#39;</span></span><span class="mpre"> = </span><a href="#loc_668_28_668_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_668_28_668_31&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_664_17_664_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_664_17_664_21&#39;)"><span class="hl_varref"><span class="mpre">pBuf</span></span></a><span class="mpre">
                        !</span><a name="loc_670_26_670_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_670_26_670_30&#39;)"><span class="hl_vardecl"><span class="mpre">buf&#39;</span></span></a><span class="mpre"> = </span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Internal.hs&quot;, srcSpanStartLine = 670, srcSpanStartColumn = 33, srcSpanEndLine = 670, srcSpanEndColumn = 53}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Internal.hs&quot;, srcSpanStartLine = 670, srcSpanStartColumn = 37, srcSpanEndLine = 670, srcSpanEndColumn = 38},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestri"><span class="mpre">buf {IO.bufR = off&#39;}</span></span><span class="mpre">
                    </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_631_13_631_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_631_13_631_19&#39;)"><span class="hl_varref"><span class="mpre">refBuf</span></span></a><span class="mpre"> </span><a href="#loc_670_26_670_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_670_26_670_30&#39;)"><span class="hl_varref"><span class="mpre">buf&#39;</span></span></a><span class="mpre">

                </span><a name="loc_673_17_673_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_673_17_673_22&#39;)"><span class="hl_fundecl"><span class="mpre">doneH</span></span></a><span class="mpre"> </span><a name="loc_673_23_673_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_673_23_673_26&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_673_27_673_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_673_27_673_28&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> = do
                    </span><a href="#loc_668_17_668_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_668_17_668_27&#39;)"><span class="hl_varref"><span class="mpre">updateBufR</span></span></a><span class="mpre"> </span><a href="#loc_673_23_673_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_673_23_673_26&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- We must flush if this Handle is set to NoBuffering.</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- If it is set to LineBuffering, be conservative and</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- flush anyway (we didn&#39;t check for newlines in the data).</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- Flushing must happen outside this &#39;wantWriteableHandle&#39;</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- due to the possible async. exception.</span></span><span class="mpre">
                    case </span><a href="GHC.IO.Handle.Types.html#loc_130_7_130_19" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.Types.html#loc_130_7_130_19&#39;)"><span class="hl_varref"><span class="mpre">haBufferMode</span></span></a><span class="mpre"> </span><a href="#loc_627_21_627_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_627_21_627_23&#39;)"><span class="hl_varref"><span class="mpre">h_</span></span></a><span class="mpre"> of
                        </span><span class="hl_conref"><span class="mpre">BlockBuffering</span></span><span class="mpre"> _      -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_673_27_673_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_673_27_673_28&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
                        </span><span class="hl_vardecl"><span class="mpre">_line_or_no_buffering</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="GHC.IO.Handle.html#loc_293_1_293_7" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.Handle.html#loc_293_1_293_7&#39;)"><span class="hl_varref"><span class="mpre">hFlush</span></span></a><span class="mpre"> </span><a href="#loc_596_6_596_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_596_6_596_7&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_673_27_673_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_673_27_673_28&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">

                </span><a name="loc_684_17_684_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_684_17_684_22&#39;)"><span class="hl_fundecl"><span class="mpre">fullH</span></span></a><span class="mpre"> </span><a name="loc_684_23_684_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_684_23_684_26&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_684_27_684_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_684_27_684_34&#39;)"><span class="hl_vardecl"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a name="loc_684_35_684_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_684_35_684_43&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre"> = do
                    </span><a href="#loc_668_17_668_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_668_17_668_27&#39;)"><span class="hl_varref"><span class="mpre">updateBufR</span></span></a><span class="mpre"> </span><a href="#loc_684_23_684_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_684_23_684_26&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre">
                    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_600_5_600_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_5_600_15&#39;)"><span class="hl_varref"><span class="mpre">fillHandle</span></span></a><span class="mpre"> </span><a href="#loc_684_27_684_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_684_27_684_34&#39;)"><span class="hl_varref"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a href="#loc_684_35_684_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_684_35_684_43&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- &#39;fillHandle&#39; will flush the buffer (provided there is</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- really less than &#39;minSize&#39; space left) before executing</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- the &#39;nextStep&#39;.</span></span><span class="mpre">

                </span><a name="loc_691_17_691_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_691_17_691_29&#39;)"><span class="hl_fundecl"><span class="mpre">insertChunkH</span></span></a><span class="mpre"> </span><a name="loc_691_30_691_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_691_30_691_33&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_691_34_691_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_691_34_691_36&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_691_37_691_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_691_37_691_45&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre"> = do
                    </span><a href="#loc_668_17_668_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_668_17_668_27&#39;)"><span class="hl_varref"><span class="mpre">updateBufR</span></span></a><span class="mpre"> </span><a href="#loc_691_30_691_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_691_30_691_33&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre">
                    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
                        </span><span class="hl_varref"><span class="mpre">S.hPut</span></span><span class="mpre"> </span><a href="#loc_596_6_596_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_596_6_596_7&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> </span><a href="#loc_691_34_691_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_691_34_691_36&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
                        </span><a href="#loc_600_5_600_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_600_5_600_15&#39;)"><span class="hl_varref"><span class="mpre">fillHandle</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> </span><a href="#loc_691_37_691_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_691_37_691_45&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">
#else
</span><a href="#loc_596_1_596_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_596_1_596_5&#39;)"><span class="hl_fundecl"><span class="mpre">hPut</span></span></a><span class="mpre"> </span><a name="loc_697_6_697_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_697_6_697_7&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre"> </span><a name="loc_697_8_697_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_697_8_697_9&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> =
    </span><a href="#loc_702_5_702_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_702_5_702_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">=&lt;&lt;</span></span><span class="mpre"> </span><a href="#loc_1094_1_1094_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_1_1094_16&#39;)"><span class="hl_varref"><span class="mpre">buildStepToCIOS</span></span></a><span class="mpre"> </span><a href="#loc_700_5_700_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_700_5_700_13&#39;)"><span class="hl_varref"><span class="mpre">strategy</span></span></a><span class="mpre"> (</span><a href="#loc_464_1_464_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_1_464_7&#39;)"><span class="hl_varref"><span class="mpre">runPut</span></span></a><span class="mpre"> </span><a href="#loc_697_8_697_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_697_8_697_9&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">)
  where
    </span><a name="loc_700_5_700_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_700_5_700_13&#39;)"><span class="hl_vardecl"><span class="mpre">strategy</span></span></a><span class="mpre"> = </span><a href="#loc_1021_1_1021_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1021_1_1021_18&#39;)"><span class="hl_varref"><span class="mpre">untrimmedStrategy</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_213_1_213_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_213_1_213_15&#39;)"><span class="hl_varref"><span class="mpre">L.smallChunkSize</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_208_1_208_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_208_1_208_17&#39;)"><span class="hl_varref"><span class="mpre">L.defaultChunkSize</span></span></a><span class="mpre">

    </span><a name="loc_702_5_702_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_702_5_702_7&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_222_8_222_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_8_222_16&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre"> </span><a name="loc_702_18_702_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_702_18_702_21&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre"> </span><a name="loc_702_22_702_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_702_22_702_23&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">S.hPut</span></span><span class="mpre"> </span><a href="#loc_697_6_697_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_697_6_697_7&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> (</span><a href="#loc_196_1_196_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_196_1_196_21&#39;)"><span class="hl_varref"><span class="mpre">byteStringFromBuffer</span></span></a><span class="mpre"> </span><a href="#loc_702_18_702_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_702_18_702_21&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_702_22_702_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_702_22_702_23&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
    </span><a href="#loc_702_5_702_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_702_5_702_7&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> (</span><a href="#loc_224_8_224_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_8_224_14&#39;)"><span class="hl_conref"><span class="mpre">Yield1</span></span></a><span class="mpre"> </span><a name="loc_703_16_703_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_703_16_703_18&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_703_19_703_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_703_19_703_21&#39;)"><span class="hl_vardecl"><span class="mpre">io</span></span></a><span class="mpre">)   = </span><span class="hl_varref"><span class="mpre">S.hPut</span></span><span class="mpre"> </span><a href="#loc_697_6_697_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_697_6_697_7&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> </span><a href="#loc_703_16_703_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_703_16_703_18&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><a href="#loc_703_19_703_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_703_19_703_21&#39;)"><span class="hl_varref"><span class="mpre">io</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_702_5_702_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_702_5_702_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre">
#endif

</span><span class="hl_comment"><span class="mpre">-- | Execute a &#39;Put&#39; and return the computed result and the bytes</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- written during the computation as a lazy &#39;L.ByteString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function is strict in the computed result and lazy in the writing of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the bytes. For example, given</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--infinitePut = sequence_ (repeat (putBuilder (word8 1))) &gt;&gt; return 0</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- evaluating the expression</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--fst $ putToLazyByteString infinitePut</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- does not terminate, while evaluating the expression</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--L.head $ snd $ putToLazyByteString infinitePut</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- does terminate and yields the value @1 :: Word8@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- An illustrative example for these strictness properties is the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- implementation of Base64 decoding (&lt;http://en.wikipedia.org/wiki/Base64&gt;).</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--type DecodingState = ...</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--decodeBase64 :: &#39;S.ByteString&#39; -&gt; DecodingState -&gt; &#39;Put&#39; (Maybe DecodingState)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--decodeBase64 = ...</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The above function takes a strict &#39;S.ByteString&#39; supposed to represent</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Base64 encoded data and the current decoding state.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- It writes the decoded bytes as the side-effect of the &#39;Put&#39; and returns the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- new decoding state, if the decoding of all data in the &#39;S.ByteString&#39; was</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- successful. The checking if the strict &#39;S.ByteString&#39; represents Base64</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- encoded data and the actual decoding are fused. This makes the common case,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- where all data represents Base64 encoded data, more efficient. It also</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- implies that all data must be decoded before the final decoding</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- state can be returned. &#39;Put&#39;s are intended for implementing such fused</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- checking and decoding/encoding, which is reflected in their strictness</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- properties.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# NOINLINE </span><a href="#loc_756_1_756_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_756_1_756_20&#39;)"><span class="mpre">putToLazyByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_756_1_756_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_756_1_756_20&#39;)"><span class="mpre">putToLazyByteString</span></a><span class="mpre">
    :: </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">              </span><span class="hl_comment"><span class="mpre">-- ^ &#39;Put&#39; to execute</span></span><span class="mpre">
    -&gt; (</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">, </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">)  </span><span class="hl_comment"><span class="mpre">-- ^ Result and lazy &#39;L.ByteString&#39;</span></span><span class="mpre">
                          </span><span class="hl_comment"><span class="mpre">-- written as its side-effect</span></span><span class="mpre">
</span><a name="loc_756_1_756_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_756_1_756_20&#39;)"><span class="hl_vardecl"><span class="mpre">putToLazyByteString</span></span></a><span class="mpre"> = </span><a href="#loc_779_1_779_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_779_1_779_24&#39;)"><span class="hl_varref"><span class="mpre">putToLazyByteStringWith</span></span></a><span class="mpre">
    (</span><a href="#loc_1038_1_1038_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1038_1_1038_13&#39;)"><span class="hl_varref"><span class="mpre">safeStrategy</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_213_1_213_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_213_1_213_15&#39;)"><span class="hl_varref"><span class="mpre">L.smallChunkSize</span></span></a><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_208_1_208_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_208_1_208_17&#39;)"><span class="hl_varref"><span class="mpre">L.defaultChunkSize</span></span></a><span class="mpre">) (\</span><a name="loc_757_58_757_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_757_58_757_59&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> -&gt; (</span><a href="#loc_757_58_757_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_757_58_757_59&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">, </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_19_82_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_19_82_24&#39;)"><span class="hl_conref"><span class="mpre">L.Empty</span></span></a><span class="mpre">))


</span><span class="hl_comment"><span class="mpre">-- | Execute a &#39;Put&#39; with a buffer-allocation strategy and a continuation. For</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- example, &#39;putToLazyByteString&#39; is implemented as follows.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--putToLazyByteString = &#39;putToLazyByteStringWith&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--    (&#39;safeStrategy&#39; &#39;L.smallChunkSize&#39; &#39;L.defaultChunkSize&#39;) (\x -&gt; (x, L.empty))</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_779_1_779_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_779_1_779_24&#39;)"><span class="mpre">putToLazyByteStringWith</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_779_1_779_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_779_1_779_24&#39;)"><span class="mpre">putToLazyByteStringWith</span></a><span class="mpre">
    :: </span><a href="#loc_984_6_984_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_6_984_24&#39;)"><span class="hl_tyconref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- ^ Buffer allocation strategy to use</span></span><span class="mpre">
    -&gt; (</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">, </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">))
       </span><span class="hl_comment"><span class="mpre">-- ^ Continuation to use for computing the final result and the tail of</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- its side-effect (the written bytes).</span></span><span class="mpre">
    -&gt; </span><a href="#loc_433_9_433_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_433_9_433_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- ^ &#39;Put&#39; to execute</span></span><span class="mpre">
    -&gt; (</span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">, </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">)
       </span><span class="hl_comment"><span class="mpre">-- ^ Resulting lazy &#39;L.ByteString&#39;</span></span><span class="mpre">
</span><a name="loc_779_1_779_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_779_1_779_24&#39;)"><span class="hl_fundecl"><span class="mpre">putToLazyByteStringWith</span></span></a><span class="mpre"> </span><a name="loc_779_25_779_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_779_25_779_33&#39;)"><span class="hl_vardecl"><span class="mpre">strategy</span></span></a><span class="mpre"> </span><a name="loc_779_34_779_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_779_34_779_35&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> </span><a name="loc_779_36_779_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_779_36_779_37&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> =
    </span><a href="#loc_251_1_251_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_251_1_251_21&#39;)"><span class="hl_varref"><span class="mpre">ciosToLazyByteString</span></span></a><span class="mpre"> </span><a href="#loc_779_25_779_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_779_25_779_33&#39;)"><span class="hl_varref"><span class="mpre">strategy</span></span></a><span class="mpre"> </span><a href="#loc_779_34_779_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_779_34_779_35&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="GHC.IO.html#loc_182_1_182_23" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_182_1_182_23&#39;)"><span class="hl_varref"><span class="mpre">unsafeDupablePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
        </span><a href="#loc_1094_1_1094_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_1_1094_16&#39;)"><span class="hl_varref"><span class="mpre">buildStepToCIOS</span></span></a><span class="mpre"> </span><a href="#loc_779_25_779_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_779_25_779_33&#39;)"><span class="hl_varref"><span class="mpre">strategy</span></span></a><span class="mpre"> (</span><a href="#loc_464_1_464_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_464_1_464_7&#39;)"><span class="hl_varref"><span class="mpre">runPut</span></span></a><span class="mpre"> </span><a href="#loc_779_36_779_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_779_36_779_37&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">)



</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ByteString insertion / controlling chunk boundaries</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Raw memory</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Ensure that there are at least &#39;n&#39; free bytes for the following &#39;Builder&#39;.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_795_1_795_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_795_1_795_11&#39;)"><span class="mpre">ensureFree</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_795_1_795_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_795_1_795_11&#39;)"><span class="mpre">ensureFree</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_795_1_795_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_795_1_795_11&#39;)"><span class="hl_fundecl"><span class="mpre">ensureFree</span></span></a><span class="mpre"> </span><a name="loc_795_12_795_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_795_12_795_19&#39;)"><span class="hl_vardecl"><span class="mpre">minFree</span></span></a><span class="mpre"> =
    </span><a href="#loc_364_1_364_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_8&#39;)"><span class="hl_varref"><span class="mpre">builder</span></span></a><span class="mpre"> </span><a href="#loc_798_5_798_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_5_798_9&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre">
  where
    </span><a name="loc_798_5_798_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_5_798_9&#39;)"><span class="hl_fundecl"><span class="mpre">step</span></span></a><span class="mpre"> </span><a name="loc_798_10_798_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_10_798_11&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> </span><a name="loc_798_12_798_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_12_798_14&#39;)"><span class="hl_specname"><span class="mpre">br</span></span></a><span class="mpre">@(</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a name="loc_798_28_798_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_28_798_30&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_798_31_798_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_31_798_34&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">)
      | </span><a href="#loc_798_31_798_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_31_798_34&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_798_28_798_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_28_798_30&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><a href="#loc_795_12_795_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_795_12_795_19&#39;)"><span class="hl_varref"><span class="mpre">minFree</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_298_1_298_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_298_1_298_11&#39;)"><span class="hl_varref"><span class="mpre">bufferFull</span></span></a><span class="mpre"> </span><a href="#loc_795_12_795_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_795_12_795_19&#39;)"><span class="hl_varref"><span class="mpre">minFree</span></span></a><span class="mpre"> </span><a href="#loc_798_28_798_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_28_798_30&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_798_10_798_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_10_798_11&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                   = </span><a href="#loc_798_10_798_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_10_798_11&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_798_12_798_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_798_12_798_14&#39;)"><span class="hl_varref"><span class="mpre">br</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Copy the bytes from a &#39;BufferRange&#39; into the output stream.</span></span><span class="mpre">
</span><a href="#loc_805_1_805_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_805_1_805_21&#39;)"><span class="mpre">wrappedBytesCopyStep</span></a><span class="mpre"> :: </span><a href="#loc_170_6_170_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_6_170_17&#39;)"><span class="hl_tyconref"><span class="mpre">BufferRange</span></span></a><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- ^ Input &#39;BufferRange&#39;.</span></span><span class="mpre">
                     -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_805_1_805_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_805_1_805_21&#39;)"><span class="hl_fundecl"><span class="mpre">wrappedBytesCopyStep</span></span></a><span class="mpre"> !(</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a name="loc_805_36_805_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_805_36_805_39&#39;)"><span class="hl_vardecl"><span class="mpre">ip0</span></span></a><span class="mpre"> </span><a name="loc_805_40_805_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_805_40_805_43&#39;)"><span class="hl_vardecl"><span class="mpre">ipe</span></span></a><span class="mpre">) </span><a name="loc_805_45_805_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_805_45_805_46&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> =
    </span><a href="#loc_808_5_808_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_5_808_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_805_36_805_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_805_36_805_39&#39;)"><span class="hl_varref"><span class="mpre">ip0</span></span></a><span class="mpre">
  where
    </span><a name="loc_808_5_808_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_5_808_7&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> !</span><a name="loc_808_9_808_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_9_808_11&#39;)"><span class="hl_vardecl"><span class="mpre">ip</span></span></a><span class="mpre"> !(</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a name="loc_808_26_808_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_26_808_28&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_808_29_808_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_29_808_32&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">)
      | </span><a href="#loc_819_9_819_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_819_9_819_21&#39;)"><span class="hl_varref"><span class="mpre">inpRemaining</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_818_9_818_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_818_9_818_21&#39;)"><span class="hl_varref"><span class="mpre">outRemaining</span></span></a><span class="mpre"> = do
          </span><span class="hl_varref"><span class="mpre">copyBytes</span></span><span class="mpre"> </span><a href="#loc_808_26_808_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_26_808_28&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_808_9_808_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_9_808_11&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><a href="#loc_819_9_819_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_819_9_819_21&#39;)"><span class="hl_varref"><span class="mpre">inpRemaining</span></span></a><span class="mpre">
          let !</span><a name="loc_811_16_811_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_811_16_811_19&#39;)"><span class="hl_vardecl"><span class="mpre">br&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> (</span><a href="#loc_808_26_808_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_26_808_28&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_819_9_819_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_819_9_819_21&#39;)"><span class="hl_varref"><span class="mpre">inpRemaining</span></span></a><span class="mpre">) </span><a href="#loc_808_29_808_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_29_808_32&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">
          </span><a href="#loc_805_45_805_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_805_45_805_46&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_811_16_811_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_811_16_811_19&#39;)"><span class="hl_varref"><span class="mpre">br&#39;</span></span></a><span class="mpre">
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = do
          </span><span class="hl_varref"><span class="mpre">copyBytes</span></span><span class="mpre"> </span><a href="#loc_808_26_808_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_26_808_28&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_808_9_808_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_9_808_11&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><a href="#loc_818_9_818_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_818_9_818_21&#39;)"><span class="hl_varref"><span class="mpre">outRemaining</span></span></a><span class="mpre">
          let !</span><a name="loc_815_16_815_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_815_16_815_19&#39;)"><span class="hl_vardecl"><span class="mpre">ip&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_808_9_808_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_9_808_11&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_818_9_818_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_818_9_818_21&#39;)"><span class="hl_varref"><span class="mpre">outRemaining</span></span></a><span class="mpre">
          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_298_1_298_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_298_1_298_11&#39;)"><span class="hl_varref"><span class="mpre">bufferFull</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> </span><a href="#loc_808_29_808_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_29_808_32&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> (</span><a href="#loc_808_5_808_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_5_808_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_815_16_815_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_815_16_815_19&#39;)"><span class="hl_varref"><span class="mpre">ip&#39;</span></span></a><span class="mpre">)
      where
        </span><a name="loc_818_9_818_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_818_9_818_21&#39;)"><span class="hl_vardecl"><span class="mpre">outRemaining</span></span></a><span class="mpre"> = </span><a href="#loc_808_29_808_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_29_808_32&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_808_26_808_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_26_808_28&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre">
        </span><a name="loc_819_9_819_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_819_9_819_21&#39;)"><span class="hl_vardecl"><span class="mpre">inpRemaining</span></span></a><span class="mpre"> = </span><a href="#loc_805_40_805_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_805_40_805_43&#39;)"><span class="hl_varref"><span class="mpre">ipe</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_808_9_808_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_808_9_808_11&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- Strict ByteStrings</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | Construct a &#39;Builder&#39; that copies the strict &#39;S.ByteString&#39;s, if it is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- smaller than the treshold, and inserts it directly otherwise.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- For example, @byteStringThreshold 1024@ copies strict &#39;S.ByteString&#39;s whose size</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- is less or equal to 1kb, and inserts them directly otherwise. This implies</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- that the average chunk-size of the generated lazy &#39;L.ByteString&#39; may be as</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- low as 513 bytes, as there could always be just a single byte between the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- directly inserted 1025 byte, strict &#39;S.ByteString&#39;s.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_837_1_837_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_837_1_837_20&#39;)"><span class="mpre">byteStringThreshold</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_837_1_837_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_837_1_837_20&#39;)"><span class="mpre">byteStringThreshold</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_837_1_837_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_837_1_837_20&#39;)"><span class="hl_fundecl"><span class="mpre">byteStringThreshold</span></span></a><span class="mpre"> </span><a name="loc_837_21_837_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_837_21_837_32&#39;)"><span class="hl_vardecl"><span class="mpre">maxCopySize</span></span></a><span class="mpre"> =
    \</span><a name="loc_838_6_838_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_838_6_838_8&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_364_1_364_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_8&#39;)"><span class="hl_varref"><span class="mpre">builder</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_840_5_840_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_5_840_9&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_838_6_838_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_838_6_838_8&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
  where
    </span><a name="loc_840_5_840_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_5_840_9&#39;)"><span class="hl_fundecl"><span class="mpre">step</span></span></a><span class="mpre"> !</span><a name="loc_840_11_840_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_11_840_13&#39;)"><span class="hl_specname"><span class="mpre">bs</span></span></a><span class="mpre">@(</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> _ _ </span><a name="loc_840_24_840_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_24_840_27&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre">) !</span><a name="loc_840_30_840_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_30_840_31&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> </span><a name="loc_840_32_840_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_32_840_34&#39;)"><span class="hl_specname"><span class="mpre">br</span></span></a><span class="mpre">@(</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> !</span><a name="loc_840_49_840_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_49_840_51&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _)
      | </span><a href="#loc_840_24_840_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_24_840_27&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_837_21_837_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_837_21_837_32&#39;)"><span class="hl_varref"><span class="mpre">maxCopySize</span></span></a><span class="mpre"> = </span><a href="#loc_856_1_856_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_1_856_19&#39;)"><span class="hl_varref"><span class="mpre">byteStringCopyStep</span></span></a><span class="mpre"> </span><a href="#loc_840_11_840_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_11_840_13&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="#loc_840_30_840_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_30_840_31&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_840_32_840_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_32_840_34&#39;)"><span class="hl_varref"><span class="mpre">br</span></span></a><span class="mpre">
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">          = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_310_1_310_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_1_310_12&#39;)"><span class="hl_varref"><span class="mpre">insertChunk</span></span></a><span class="mpre"> </span><a href="#loc_840_49_840_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_49_840_51&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_840_11_840_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_11_840_13&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="#loc_840_30_840_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_840_30_840_31&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Construct a &#39;Builder&#39; that copies the strict &#39;S.ByteString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Use this function to create &#39;Builder&#39;s from smallish (@&lt;= 4kb@)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;S.ByteString&#39;s or if you need to guarantee that the &#39;S.ByteString&#39; is not</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- shared with the chunks generated by the &#39;Builder&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_852_1_852_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_852_1_852_15&#39;)"><span class="mpre">byteStringCopy</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_852_1_852_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_852_1_852_15&#39;)"><span class="mpre">byteStringCopy</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_852_1_852_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_852_1_852_15&#39;)"><span class="hl_vardecl"><span class="mpre">byteStringCopy</span></span></a><span class="mpre"> = \</span><a name="loc_852_19_852_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_852_19_852_21&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_364_1_364_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_8&#39;)"><span class="hl_varref"><span class="mpre">builder</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_856_1_856_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_1_856_19&#39;)"><span class="hl_varref"><span class="mpre">byteStringCopyStep</span></span></a><span class="mpre"> </span><a href="#loc_852_19_852_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_852_19_852_21&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">

</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_856_1_856_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_1_856_19&#39;)"><span class="mpre">byteStringCopyStep</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_856_1_856_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_1_856_19&#39;)"><span class="mpre">byteStringCopyStep</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_856_1_856_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_1_856_19&#39;)"><span class="hl_fundecl"><span class="mpre">byteStringCopyStep</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a name="loc_856_26_856_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_26_856_29&#39;)"><span class="hl_vardecl"><span class="mpre">ifp</span></span></a><span class="mpre"> </span><a name="loc_856_30_856_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_30_856_34&#39;)"><span class="hl_vardecl"><span class="mpre">ioff</span></span></a><span class="mpre"> </span><a name="loc_856_35_856_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_35_856_40&#39;)"><span class="hl_vardecl"><span class="mpre">isize</span></span></a><span class="mpre">) !</span><a name="loc_856_43_856_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_43_856_45&#39;)"><span class="hl_vardecl"><span class="mpre">k0</span></span></a><span class="mpre"> </span><a name="loc_856_46_856_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_46_856_49&#39;)"><span class="hl_specname"><span class="mpre">br0</span></span></a><span class="mpre">@(</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a name="loc_856_63_856_65" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_63_856_65&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_856_66_856_69" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_66_856_69&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">)
    </span><span class="hl_comment"><span class="mpre">-- Ensure that the common case is not recursive and therefore yields</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- better code.</span></span><span class="mpre">
    | </span><a href="#loc_864_5_864_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_864_5_864_8&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_856_66_856_69" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_66_856_69&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> = do </span><span class="hl_varref"><span class="mpre">copyBytes</span></span><span class="mpre"> </span><a href="#loc_856_63_856_65" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_63_856_65&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_865_5_865_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_865_5_865_7&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><a href="#loc_856_35_856_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_35_856_40&#39;)"><span class="hl_varref"><span class="mpre">isize</span></span></a><span class="mpre">
                      </span><a href="Foreign.ForeignPtr.html#loc_74_1_74_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.html#loc_74_1_74_16&#39;)"><span class="hl_varref"><span class="mpre">touchForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_856_26_856_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_26_856_29&#39;)"><span class="hl_varref"><span class="mpre">ifp</span></span></a><span class="mpre">
                      </span><a href="#loc_856_43_856_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_43_856_45&#39;)"><span class="hl_varref"><span class="mpre">k0</span></span></a><span class="mpre"> (</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a href="#loc_864_5_864_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_864_5_864_8&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a href="#loc_856_66_856_69" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_66_856_69&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">)
    | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">  = do </span><a href="#loc_805_1_805_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_805_1_805_21&#39;)"><span class="hl_varref"><span class="mpre">wrappedBytesCopyStep</span></span></a><span class="mpre"> (</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a href="#loc_865_5_865_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_865_5_865_7&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><a href="#loc_866_5_866_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_866_5_866_8&#39;)"><span class="hl_varref"><span class="mpre">ipe</span></span></a><span class="mpre">) </span><a href="#loc_867_5_867_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_867_5_867_6&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_856_46_856_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_46_856_49&#39;)"><span class="hl_varref"><span class="mpre">br0</span></span></a><span class="mpre">
  where
    </span><a name="loc_864_5_864_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_864_5_864_8&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre">  = </span><a href="#loc_856_63_856_65" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_63_856_65&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_856_35_856_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_35_856_40&#39;)"><span class="hl_varref"><span class="mpre">isize</span></span></a><span class="mpre">
    </span><a name="loc_865_5_865_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_865_5_865_7&#39;)"><span class="hl_vardecl"><span class="mpre">ip</span></span></a><span class="mpre">   = </span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_856_26_856_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_26_856_29&#39;)"><span class="hl_varref"><span class="mpre">ifp</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_856_30_856_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_30_856_34&#39;)"><span class="hl_varref"><span class="mpre">ioff</span></span></a><span class="mpre">
    </span><a name="loc_866_5_866_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_866_5_866_8&#39;)"><span class="hl_vardecl"><span class="mpre">ipe</span></span></a><span class="mpre">  = </span><a href="#loc_865_5_865_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_865_5_865_7&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_856_35_856_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_35_856_40&#39;)"><span class="hl_varref"><span class="mpre">isize</span></span></a><span class="mpre">
    </span><a name="loc_867_5_867_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_867_5_867_6&#39;)"><span class="hl_fundecl"><span class="mpre">k</span></span></a><span class="mpre"> </span><a name="loc_867_7_867_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_867_7_867_9&#39;)"><span class="hl_vardecl"><span class="mpre">br</span></span></a><span class="mpre"> = do </span><a href="Foreign.ForeignPtr.html#loc_74_1_74_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.html#loc_74_1_74_16&#39;)"><span class="hl_varref"><span class="mpre">touchForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_856_26_856_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_26_856_29&#39;)"><span class="hl_varref"><span class="mpre">ifp</span></span></a><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- input consumed: OK to release here</span></span><span class="mpre">
              </span><a href="#loc_856_43_856_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_856_43_856_45&#39;)"><span class="hl_varref"><span class="mpre">k0</span></span></a><span class="mpre"> </span><a href="#loc_867_7_867_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_867_7_867_9&#39;)"><span class="hl_varref"><span class="mpre">br</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Construct a &#39;Builder&#39; that always inserts the strict &#39;S.ByteString&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- directly as a chunk.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This implies flushing the output buffer, even if it contains just</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- a single byte. You should therefore use &#39;byteStringInsert&#39; only for large</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- (@&gt; 8kb@) &#39;S.ByteString&#39;s. Otherwise, the generated chunks are too</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- fragmented to be processed efficiently afterwards.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_880_1_880_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_880_1_880_17&#39;)"><span class="mpre">byteStringInsert</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_880_1_880_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_880_1_880_17&#39;)"><span class="mpre">byteStringInsert</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_880_1_880_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_880_1_880_17&#39;)"><span class="hl_vardecl"><span class="mpre">byteStringInsert</span></span></a><span class="mpre"> =
    \</span><a name="loc_881_6_881_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_881_6_881_8&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_364_1_364_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_8&#39;)"><span class="hl_varref"><span class="mpre">builder</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_881_23_881_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_881_23_881_24&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> (</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a name="loc_881_38_881_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_881_38_881_40&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _) -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_310_1_310_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_1_310_12&#39;)"><span class="hl_varref"><span class="mpre">insertChunk</span></span></a><span class="mpre"> </span><a href="#loc_881_38_881_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_881_38_881_40&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_881_6_881_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_881_6_881_8&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="#loc_881_23_881_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_881_23_881_24&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- Short bytestrings</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Construct a &#39;Builder&#39; that copies the &#39;SH.ShortByteString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_890_1_890_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_890_1_890_16&#39;)"><span class="mpre">shortByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_890_1_890_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_890_1_890_16&#39;)"><span class="mpre">shortByteString</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Short.Internal.html#loc_109_6_109_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Short.Internal.html#loc_109_6_109_21&#39;)"><span class="hl_tyconref"><span class="mpre">Sh.ShortByteString</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_890_1_890_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_890_1_890_16&#39;)"><span class="hl_vardecl"><span class="mpre">shortByteString</span></span></a><span class="mpre"> = \</span><a name="loc_890_20_890_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_890_20_890_23&#39;)"><span class="hl_vardecl"><span class="mpre">sbs</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_364_1_364_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_364_1_364_8&#39;)"><span class="hl_varref"><span class="mpre">builder</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_896_1_896_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_896_1_896_24&#39;)"><span class="hl_varref"><span class="mpre">shortByteStringCopyStep</span></span></a><span class="mpre"> </span><a href="#loc_890_20_890_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_890_20_890_23&#39;)"><span class="hl_varref"><span class="mpre">sbs</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Copy the bytes from a &#39;SH.ShortByteString&#39; into the output stream.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_896_1_896_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_896_1_896_24&#39;)"><span class="mpre">shortByteStringCopyStep</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_896_1_896_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_896_1_896_24&#39;)"><span class="mpre">shortByteStringCopyStep</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Short.Internal.html#loc_109_6_109_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Short.Internal.html#loc_109_6_109_21&#39;)"><span class="hl_tyconref"><span class="mpre">Sh.ShortByteString</span></span></a><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- ^ Input &#39;SH.ShortByteString&#39;.</span></span><span class="mpre">
                        -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_896_1_896_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_896_1_896_24&#39;)"><span class="hl_fundecl"><span class="mpre">shortByteStringCopyStep</span></span></a><span class="mpre"> !</span><a name="loc_896_26_896_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_896_26_896_29&#39;)"><span class="hl_vardecl"><span class="mpre">sbs</span></span></a><span class="mpre"> </span><a name="loc_896_30_896_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_896_30_896_31&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> =
    </span><a href="#loc_899_5_899_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_5_899_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> (</span><a href="Data.ByteString.Short.Internal.html#loc_170_1_170_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Short.Internal.html#loc_170_1_170_7&#39;)"><span class="hl_varref"><span class="mpre">Sh.length</span></span></a><span class="mpre"> </span><a href="#loc_896_26_896_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_896_26_896_29&#39;)"><span class="hl_varref"><span class="mpre">sbs</span></span></a><span class="mpre">)
  where
    </span><a name="loc_899_5_899_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_5_899_7&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> !</span><a name="loc_899_9_899_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_9_899_11&#39;)"><span class="hl_vardecl"><span class="mpre">ip</span></span></a><span class="mpre"> !</span><a name="loc_899_13_899_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_13_899_16&#39;)"><span class="hl_vardecl"><span class="mpre">ipe</span></span></a><span class="mpre"> !(</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a name="loc_899_31_899_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_31_899_33&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_899_34_899_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_34_899_37&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">)
      | </span><a href="#loc_910_9_910_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_910_9_910_21&#39;)"><span class="hl_varref"><span class="mpre">inpRemaining</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_909_9_909_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_909_9_909_21&#39;)"><span class="hl_varref"><span class="mpre">outRemaining</span></span></a><span class="mpre"> = do
          </span><a href="Data.ByteString.Short.Internal.html#loc_416_1_416_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Short.Internal.html#loc_416_1_416_10&#39;)"><span class="hl_varref"><span class="mpre">Sh.copyToPtr</span></span></a><span class="mpre"> </span><a href="#loc_896_26_896_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_896_26_896_29&#39;)"><span class="hl_varref"><span class="mpre">sbs</span></span></a><span class="mpre"> </span><a href="#loc_899_9_899_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_9_899_11&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><a href="#loc_899_31_899_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_31_899_33&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_910_9_910_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_910_9_910_21&#39;)"><span class="hl_varref"><span class="mpre">inpRemaining</span></span></a><span class="mpre">
          let !</span><a name="loc_902_16_902_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_902_16_902_19&#39;)"><span class="hl_vardecl"><span class="mpre">br&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> (</span><a href="#loc_899_31_899_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_31_899_33&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_910_9_910_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_910_9_910_21&#39;)"><span class="hl_varref"><span class="mpre">inpRemaining</span></span></a><span class="mpre">) </span><a href="#loc_899_34_899_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_34_899_37&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">
          </span><a href="#loc_896_30_896_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_896_30_896_31&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_902_16_902_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_902_16_902_19&#39;)"><span class="hl_varref"><span class="mpre">br&#39;</span></span></a><span class="mpre">
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = do
          </span><a href="Data.ByteString.Short.Internal.html#loc_416_1_416_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Short.Internal.html#loc_416_1_416_10&#39;)"><span class="hl_varref"><span class="mpre">Sh.copyToPtr</span></span></a><span class="mpre"> </span><a href="#loc_896_26_896_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_896_26_896_29&#39;)"><span class="hl_varref"><span class="mpre">sbs</span></span></a><span class="mpre"> </span><a href="#loc_899_9_899_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_9_899_11&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><a href="#loc_899_31_899_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_31_899_33&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_909_9_909_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_909_9_909_21&#39;)"><span class="hl_varref"><span class="mpre">outRemaining</span></span></a><span class="mpre">
          let !</span><a name="loc_906_16_906_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_906_16_906_19&#39;)"><span class="hl_vardecl"><span class="mpre">ip&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_899_9_899_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_9_899_11&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><a href="#loc_909_9_909_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_909_9_909_21&#39;)"><span class="hl_varref"><span class="mpre">outRemaining</span></span></a><span class="mpre">
          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_298_1_298_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_298_1_298_11&#39;)"><span class="hl_varref"><span class="mpre">bufferFull</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> </span><a href="#loc_899_34_899_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_34_899_37&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> (</span><a href="#loc_899_5_899_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_5_899_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_906_16_906_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_906_16_906_19&#39;)"><span class="hl_varref"><span class="mpre">ip&#39;</span></span></a><span class="mpre"> </span><a href="#loc_899_13_899_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_13_899_16&#39;)"><span class="hl_varref"><span class="mpre">ipe</span></span></a><span class="mpre">)
      where
        </span><a name="loc_909_9_909_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_909_9_909_21&#39;)"><span class="hl_vardecl"><span class="mpre">outRemaining</span></span></a><span class="mpre"> = </span><a href="#loc_899_34_899_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_34_899_37&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_899_31_899_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_31_899_33&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre">
        </span><a name="loc_910_9_910_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_910_9_910_21&#39;)"><span class="hl_vardecl"><span class="mpre">inpRemaining</span></span></a><span class="mpre"> = </span><a href="#loc_899_13_899_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_13_899_16&#39;)"><span class="hl_varref"><span class="mpre">ipe</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">-</span></span><span class="mpre"> </span><a href="#loc_899_9_899_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_899_9_899_11&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- Lazy bytestrings</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Construct a &#39;Builder&#39; that uses the thresholding strategy of &#39;byteStringThreshold&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- for each chunk of the lazy &#39;L.ByteString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_921_1_921_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_921_1_921_24&#39;)"><span class="mpre">lazyByteStringThreshold</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_921_1_921_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_921_1_921_24&#39;)"><span class="mpre">lazyByteStringThreshold</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_921_1_921_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_921_1_921_24&#39;)"><span class="hl_fundecl"><span class="mpre">lazyByteStringThreshold</span></span></a><span class="mpre"> </span><a name="loc_921_25_921_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_921_25_921_36&#39;)"><span class="hl_vardecl"><span class="mpre">maxCopySize</span></span></a><span class="mpre"> =
    </span><a href="Data.ByteString.Lazy.Internal.html#loc_179_1_179_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_179_1_179_12&#39;)"><span class="hl_varref"><span class="mpre">L.foldrChunks</span></span></a><span class="mpre"> (\</span><a name="loc_922_21_922_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_922_21_922_23&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_922_24_922_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_922_24_922_25&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_837_1_837_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_837_1_837_20&#39;)"><span class="hl_varref"><span class="mpre">byteStringThreshold</span></span></a><span class="mpre"> </span><a href="#loc_921_25_921_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_921_25_921_36&#39;)"><span class="hl_varref"><span class="mpre">maxCopySize</span></span></a><span class="mpre"> </span><a href="#loc_922_21_922_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_922_21_922_23&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_infix"><span class="mpre">`mappend`</span></span></a><span class="mpre"> </span><a href="#loc_922_24_922_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_922_24_922_25&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">) </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- TODO: We could do better here. Currently, Large, Small, Large, leads to</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- an unnecessary copy of the &#39;Small&#39; chunk.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Construct a &#39;Builder&#39; that copies the lazy &#39;L.ByteString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_930_1_930_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_930_1_930_19&#39;)"><span class="mpre">lazyByteStringCopy</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_930_1_930_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_930_1_930_19&#39;)"><span class="mpre">lazyByteStringCopy</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_930_1_930_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_930_1_930_19&#39;)"><span class="hl_vardecl"><span class="mpre">lazyByteStringCopy</span></span></a><span class="mpre"> =
    </span><a href="Data.ByteString.Lazy.Internal.html#loc_179_1_179_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_179_1_179_12&#39;)"><span class="hl_varref"><span class="mpre">L.foldrChunks</span></span></a><span class="mpre"> (\</span><a name="loc_931_21_931_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_931_21_931_23&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_931_24_931_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_931_24_931_25&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_852_1_852_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_852_1_852_15&#39;)"><span class="hl_varref"><span class="mpre">byteStringCopy</span></span></a><span class="mpre"> </span><a href="#loc_931_21_931_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_931_21_931_23&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_infix"><span class="mpre">`mappend`</span></span></a><span class="mpre"> </span><a href="#loc_931_24_931_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_931_24_931_25&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">) </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Construct a &#39;Builder&#39; that inserts all chunks of the lazy &#39;L.ByteString&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- directly.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_938_1_938_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_938_1_938_21&#39;)"><span class="mpre">lazyByteStringInsert</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_938_1_938_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_938_1_938_21&#39;)"><span class="mpre">lazyByteStringInsert</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_938_1_938_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_938_1_938_21&#39;)"><span class="hl_vardecl"><span class="mpre">lazyByteStringInsert</span></span></a><span class="mpre"> =
    </span><a href="Data.ByteString.Lazy.Internal.html#loc_179_1_179_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_179_1_179_12&#39;)"><span class="hl_varref"><span class="mpre">L.foldrChunks</span></span></a><span class="mpre"> (\</span><a name="loc_939_21_939_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_939_21_939_23&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_939_24_939_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_939_24_939_25&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_880_1_880_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_880_1_880_17&#39;)"><span class="hl_varref"><span class="mpre">byteStringInsert</span></span></a><span class="mpre"> </span><a href="#loc_939_21_939_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_939_21_939_23&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_infix"><span class="mpre">`mappend`</span></span></a><span class="mpre"> </span><a href="#loc_939_24_939_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_939_24_939_25&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">) </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Create a &#39;Builder&#39; denoting the same sequence of bytes as a strict</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;S.ByteString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The &#39;Builder&#39; inserts large &#39;S.ByteString&#39;s directly, but copies small ones</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to ensure that the generated chunks are large on average.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_948_1_948_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_948_1_948_11&#39;)"><span class="mpre">byteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_948_1_948_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_948_1_948_11&#39;)"><span class="mpre">byteString</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_948_1_948_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_948_1_948_11&#39;)"><span class="hl_vardecl"><span class="mpre">byteString</span></span></a><span class="mpre"> = </span><a href="#loc_837_1_837_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_837_1_837_20&#39;)"><span class="hl_varref"><span class="mpre">byteStringThreshold</span></span></a><span class="mpre"> </span><a href="#loc_969_1_969_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_969_1_969_16&#39;)"><span class="hl_varref"><span class="mpre">maximalCopySize</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Create a &#39;Builder&#39; denoting the same sequence of bytes as a lazy</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;S.ByteString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The &#39;Builder&#39; inserts large chunks of the lazy &#39;L.ByteString&#39; directly,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- but copies small ones to ensure that the generated chunks are large on</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- average.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_958_1_958_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_958_1_958_15&#39;)"><span class="mpre">lazyByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_958_1_958_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_958_1_958_15&#39;)"><span class="mpre">lazyByteString</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_958_1_958_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_958_1_958_15&#39;)"><span class="hl_vardecl"><span class="mpre">lazyByteString</span></span></a><span class="mpre"> = </span><a href="#loc_921_1_921_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_921_1_921_24&#39;)"><span class="hl_varref"><span class="mpre">lazyByteStringThreshold</span></span></a><span class="mpre"> </span><a href="#loc_969_1_969_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_969_1_969_16&#39;)"><span class="hl_varref"><span class="mpre">maximalCopySize</span></span></a><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- FIXME: also insert the small chunk for [large,small,large] directly.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Perhaps it makes even sense to concatenate the small chunks in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- [large,small,small,small,large] and insert them directly afterwards to avoid</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- unnecessary buffer spilling. Hmm, but that uncontrollably increases latency</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- =&gt; no good!</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The maximal size of a &#39;S.ByteString&#39; that is copied.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @2 * &#39;L.smallChunkSize&#39;@ to guarantee that on average a chunk is of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;L.smallChunkSize&#39;.</span></span><span class="mpre">
</span><a href="#loc_969_1_969_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_969_1_969_16&#39;)"><span class="mpre">maximalCopySize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_969_1_969_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_969_1_969_16&#39;)"><span class="hl_vardecl"><span class="mpre">maximalCopySize</span></span></a><span class="mpre"> = </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><a href="Data.ByteString.Lazy.Internal.html#loc_213_1_213_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_213_1_213_15&#39;)"><span class="hl_varref"><span class="mpre">L.smallChunkSize</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Builder execution</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A buffer allocation strategy for executing &#39;Builder&#39;s.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- The strategy</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; &#39;AllocationStrategy&#39; firstBufSize bufSize trim</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- states that the first buffer is of size @firstBufSize@, all following buffers</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- are of size @bufSize@, and a buffer of size @n@ filled with @k@ bytes should</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- be trimmed iff @trim k n@ is &#39;True&#39;.</span></span><span class="mpre">
data </span><a name="loc_984_6_984_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_6_984_24&#39;)"><span class="hl_tycondecl"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre"> = </span><a name="loc_984_27_984_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_27_984_45&#39;)"><span class="hl_condecl"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre">
         (</span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> (</span><a href="#loc_175_6_175_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_6_175_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">, </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_175_6_175_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_6_175_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">)
         {-# UNPACK #-} !</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
         (</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Create a custom allocation strategy. See the code for &#39;safeStrategy&#39; and</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;untrimmedStrategy&#39; for examples.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_1005_1_1005_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1005_1_1005_15&#39;)"><span class="mpre">customStrategy</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_1005_1_1005_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1005_1_1005_15&#39;)"><span class="mpre">customStrategy</span></a><span class="mpre">
  :: (</span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> (</span><a href="#loc_175_6_175_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_6_175_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">, </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_175_6_175_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_6_175_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">)
     </span><span class="hl_comment"><span class="mpre">-- ^ Buffer allocation function. If &#39;Nothing&#39; is given, then a new first</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- buffer should be allocated. If @&#39;Just&#39; (oldBuf, minSize)@ is given,</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- then a buffer with minimal size &#39;minSize&#39; must be returned. The</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- strategy may reuse the &#39;oldBuffer&#39;, if it can guarantee that this</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- referentially transparent and &#39;oldBuffer&#39; is large enough.</span></span><span class="mpre">
  -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- ^ Default buffer size.</span></span><span class="mpre">
  -&gt; (</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre">)
     </span><span class="hl_comment"><span class="mpre">-- ^ A predicate @trim used allocated@ returning &#39;True&#39;, if the buffer</span></span><span class="mpre">
     </span><span class="hl_comment"><span class="mpre">-- should be trimmed before it is returned.</span></span><span class="mpre">
  -&gt; </span><a href="#loc_984_6_984_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_6_984_24&#39;)"><span class="hl_tyconref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre">
</span><a name="loc_1005_1_1005_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1005_1_1005_15&#39;)"><span class="hl_vardecl"><span class="mpre">customStrategy</span></span></a><span class="mpre"> = </span><a href="#loc_984_27_984_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_27_984_45&#39;)"><span class="hl_conref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Sanitize a buffer size; i.e., make it at least the size of an &#39;Int&#39;.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_1010_1_1010_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1010_1_1010_9&#39;)"><span class="mpre">sanitize</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_1010_1_1010_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1010_1_1010_9&#39;)"><span class="mpre">sanitize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_1010_1_1010_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1010_1_1010_9&#39;)"><span class="hl_vardecl"><span class="mpre">sanitize</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">max</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">sizeOf</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">undefined</span></span><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">))

</span><span class="hl_comment"><span class="mpre">-- | Use this strategy for generating lazy &#39;L.ByteString&#39;s whose chunks are</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- discarded right after they are generated. For example, if you just generate</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- them to write them to a network socket.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_1021_1_1021_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1021_1_1021_18&#39;)"><span class="mpre">untrimmedStrategy</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_1021_1_1021_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1021_1_1021_18&#39;)"><span class="mpre">untrimmedStrategy</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ Size of the first buffer</span></span><span class="mpre">
                  -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ Size of successive buffers</span></span><span class="mpre">
                  -&gt; </span><a href="#loc_984_6_984_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_6_984_24&#39;)"><span class="hl_tyconref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre">
                  </span><span class="hl_comment"><span class="mpre">-- ^ An allocation strategy that does not trim any of the</span></span><span class="mpre">
                  </span><span class="hl_comment"><span class="mpre">-- filled buffers before converting it to a chunk</span></span><span class="mpre">
</span><a name="loc_1021_1_1021_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1021_1_1021_18&#39;)"><span class="hl_fundecl"><span class="mpre">untrimmedStrategy</span></span></a><span class="mpre"> </span><a name="loc_1021_19_1021_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1021_19_1021_28&#39;)"><span class="hl_vardecl"><span class="mpre">firstSize</span></span></a><span class="mpre"> </span><a name="loc_1021_29_1021_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1021_29_1021_36&#39;)"><span class="hl_vardecl"><span class="mpre">bufSize</span></span></a><span class="mpre"> =
    </span><a href="#loc_984_27_984_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_27_984_45&#39;)"><span class="hl_conref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre"> </span><a href="#loc_1025_5_1025_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1025_5_1025_15&#39;)"><span class="hl_varref"><span class="mpre">nextBuffer</span></span></a><span class="mpre"> (</span><a href="#loc_1010_1_1010_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1010_1_1010_9&#39;)"><span class="hl_varref"><span class="mpre">sanitize</span></span></a><span class="mpre"> </span><a href="#loc_1021_29_1021_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1021_29_1021_36&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre">) (\_ _ -&gt; </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">)
  where
    </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_1025_5_1025_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1025_5_1025_15&#39;)"><span class="mpre">nextBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">
    </span><a name="loc_1025_5_1025_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1025_5_1025_15&#39;)"><span class="hl_fundecl"><span class="mpre">nextBuffer</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">             = </span><a href="#loc_188_1_188_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_1_188_10&#39;)"><span class="hl_varref"><span class="mpre">newBuffer</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_1010_1_1010_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1010_1_1010_9&#39;)"><span class="hl_varref"><span class="mpre">sanitize</span></span></a><span class="mpre"> </span><a href="#loc_1021_19_1021_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1021_19_1021_28&#39;)"><span class="hl_varref"><span class="mpre">firstSize</span></span></a><span class="mpre">
    </span><a href="#loc_1025_5_1025_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1025_5_1025_15&#39;)"><span class="hl_fundecl"><span class="mpre">nextBuffer</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (_, </span><a name="loc_1026_26_1026_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1026_26_1026_33&#39;)"><span class="hl_vardecl"><span class="mpre">minSize</span></span></a><span class="mpre">)) = </span><a href="#loc_188_1_188_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_1_188_10&#39;)"><span class="hl_varref"><span class="mpre">newBuffer</span></span></a><span class="mpre"> </span><a href="#loc_1026_26_1026_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1026_26_1026_33&#39;)"><span class="hl_varref"><span class="mpre">minSize</span></span></a><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | Use this strategy for generating lazy &#39;L.ByteString&#39;s whose chunks are</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- likely to survive one garbage collection. This strategy trims buffers</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- that are filled less than half in order to avoid spilling too much memory.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_1038_1_1038_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1038_1_1038_13&#39;)"><span class="mpre">safeStrategy</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_1038_1_1038_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1038_1_1038_13&#39;)"><span class="mpre">safeStrategy</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- ^ Size of first buffer</span></span><span class="mpre">
             -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- ^ Size of successive buffers</span></span><span class="mpre">
             -&gt; </span><a href="#loc_984_6_984_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_6_984_24&#39;)"><span class="hl_tyconref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre">
             </span><span class="hl_comment"><span class="mpre">-- ^ An allocation strategy that guarantees that at least half</span></span><span class="mpre">
             </span><span class="hl_comment"><span class="mpre">-- of the allocated memory is used for live data</span></span><span class="mpre">
</span><a name="loc_1038_1_1038_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1038_1_1038_13&#39;)"><span class="hl_fundecl"><span class="mpre">safeStrategy</span></span></a><span class="mpre"> </span><a name="loc_1038_14_1038_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1038_14_1038_23&#39;)"><span class="hl_vardecl"><span class="mpre">firstSize</span></span></a><span class="mpre"> </span><a name="loc_1038_24_1038_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1038_24_1038_31&#39;)"><span class="hl_vardecl"><span class="mpre">bufSize</span></span></a><span class="mpre"> =
    </span><a href="#loc_984_27_984_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_27_984_45&#39;)"><span class="hl_conref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre"> </span><a href="#loc_1043_5_1043_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1043_5_1043_15&#39;)"><span class="hl_varref"><span class="mpre">nextBuffer</span></span></a><span class="mpre"> (</span><a href="#loc_1010_1_1010_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1010_1_1010_9&#39;)"><span class="hl_varref"><span class="mpre">sanitize</span></span></a><span class="mpre"> </span><a href="#loc_1038_24_1038_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1038_24_1038_31&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre">) </span><a href="#loc_1041_5_1041_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1041_5_1041_9&#39;)"><span class="hl_varref"><span class="mpre">trim</span></span></a><span class="mpre">
  where
    </span><a name="loc_1041_5_1041_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1041_5_1041_9&#39;)"><span class="hl_fundecl"><span class="mpre">trim</span></span></a><span class="mpre"> </span><a name="loc_1041_10_1041_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1041_10_1041_14&#39;)"><span class="hl_vardecl"><span class="mpre">used</span></span></a><span class="mpre"> </span><a name="loc_1041_15_1041_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1041_15_1041_19&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre">                 = </span><span class="hl_num"><span class="mpre">2</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">*</span></span><span class="mpre"> </span><a href="#loc_1041_10_1041_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1041_10_1041_14&#39;)"><span class="hl_varref"><span class="mpre">used</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><a href="#loc_1041_15_1041_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1041_15_1041_19&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">
    </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_1043_5_1043_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1043_5_1043_15&#39;)"><span class="mpre">nextBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">
    </span><a name="loc_1043_5_1043_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1043_5_1043_15&#39;)"><span class="hl_fundecl"><span class="mpre">nextBuffer</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">             = </span><a href="#loc_188_1_188_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_1_188_10&#39;)"><span class="hl_varref"><span class="mpre">newBuffer</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_1010_1_1010_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1010_1_1010_9&#39;)"><span class="hl_varref"><span class="mpre">sanitize</span></span></a><span class="mpre"> </span><a href="#loc_1038_14_1038_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1038_14_1038_23&#39;)"><span class="hl_varref"><span class="mpre">firstSize</span></span></a><span class="mpre">
    </span><a href="#loc_1043_5_1043_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1043_5_1043_15&#39;)"><span class="hl_fundecl"><span class="mpre">nextBuffer</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (_, </span><a name="loc_1044_26_1044_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1044_26_1044_33&#39;)"><span class="hl_vardecl"><span class="mpre">minSize</span></span></a><span class="mpre">)) = </span><a href="#loc_188_1_188_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_188_1_188_10&#39;)"><span class="hl_varref"><span class="mpre">newBuffer</span></span></a><span class="mpre"> </span><a href="#loc_1044_26_1044_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1044_26_1044_33&#39;)"><span class="hl_varref"><span class="mpre">minSize</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /Heavy inlining./ Execute a &#39;Builder&#39; with custom execution parameters.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function is inlined despite its heavy code-size to allow fusing with</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the allocation strategy. For example, the default &#39;Builder&#39; execution</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- function &#39;toLazyByteString&#39; is defined as follows.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- {-\# NOINLINE toLazyByteString \#-}</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- toLazyByteString =</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   toLazyByteStringWith (&#39;safeStrategy&#39; &#39;L.smallChunkSize&#39; &#39;L.defaultChunkSize&#39;) L.empty</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- where @L.empty@ is the zero-length lazy &#39;L.ByteString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- In most cases, the parameters used by &#39;toLazyByteString&#39; give good</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- performance. A sub-performing case of &#39;toLazyByteString&#39; is executing short</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- (&lt;128 bytes) &#39;Builder&#39;s. In this case, the allocation overhead for the first</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- 4kb buffer and the trimming cost dominate the cost of executing the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;Builder&#39;. You can avoid this problem using</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt;toLazyByteStringWith (safeStrategy 128 smallChunkSize) L.empty</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This reduces the allocation and trimming overhead, as all generated</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;L.ByteString&#39;s fit into the first buffer and there is no trimming</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- required, if more than 64 bytes and less than 128 bytes are written.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_1083_1_1083_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1083_1_1083_21&#39;)"><span class="mpre">toLazyByteStringWith</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_1083_1_1083_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1083_1_1083_21&#39;)"><span class="mpre">toLazyByteStringWith</span></a><span class="mpre">
    :: </span><a href="#loc_984_6_984_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_6_984_24&#39;)"><span class="hl_tyconref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- ^ Buffer allocation strategy to use</span></span><span class="mpre">
    -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- ^ Lazy &#39;L.ByteString&#39; to use as the tail of the generated lazy</span></span><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- &#39;L.ByteString&#39;</span></span><span class="mpre">
    -&gt; </span><a href="#loc_344_9_344_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_344_9_344_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- ^ &#39;Builder&#39; to execute</span></span><span class="mpre">
    -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre">
       </span><span class="hl_comment"><span class="mpre">-- ^ Resulting lazy &#39;L.ByteString&#39;</span></span><span class="mpre">
</span><a name="loc_1083_1_1083_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1083_1_1083_21&#39;)"><span class="hl_fundecl"><span class="mpre">toLazyByteStringWith</span></span></a><span class="mpre"> </span><a name="loc_1083_22_1083_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1083_22_1083_30&#39;)"><span class="hl_vardecl"><span class="mpre">strategy</span></span></a><span class="mpre"> </span><a name="loc_1083_31_1083_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1083_31_1083_32&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> </span><a name="loc_1083_33_1083_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1083_33_1083_34&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> =
    </span><a href="#loc_239_1_239_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_1_239_25&#39;)"><span class="hl_varref"><span class="mpre">ciosUnitToLazyByteString</span></span></a><span class="mpre"> </span><a href="#loc_1083_22_1083_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1083_22_1083_30&#39;)"><span class="hl_varref"><span class="mpre">strategy</span></span></a><span class="mpre"> </span><a href="#loc_1083_31_1083_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1083_31_1083_32&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="GHC.IO.html#loc_182_1_182_23" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_182_1_182_23&#39;)"><span class="hl_varref"><span class="mpre">unsafeDupablePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
        </span><a href="#loc_1094_1_1094_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_1_1094_16&#39;)"><span class="hl_varref"><span class="mpre">buildStepToCIOS</span></span></a><span class="mpre"> </span><a href="#loc_1083_22_1083_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1083_22_1083_30&#39;)"><span class="hl_varref"><span class="mpre">strategy</span></span></a><span class="mpre"> (</span><a href="#loc_375_1_375_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_375_1_375_11&#39;)"><span class="hl_varref"><span class="mpre">runBuilder</span></span></a><span class="mpre"> </span><a href="#loc_1083_33_1083_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1083_33_1083_34&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Convert a &#39;BuildStep&#39; to a &#39;ChunkIOStream&#39; stream by executing it on</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;Buffer&#39;s allocated according to the given &#39;AllocationStrategy&#39;.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_1094_1_1094_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_1_1094_16&#39;)"><span class="mpre">buildStepToCIOS</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_1094_1_1094_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_1_1094_16&#39;)"><span class="mpre">buildStepToCIOS</span></a><span class="mpre">
    :: </span><a href="#loc_984_6_984_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_6_984_24&#39;)"><span class="hl_tyconref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre">          </span><span class="hl_comment"><span class="mpre">-- ^ Buffer allocation strategy to use</span></span><span class="mpre">
    -&gt; </span><span class="hl_tyconref"><span class="mpre">BuildStep</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">                 </span><span class="hl_comment"><span class="mpre">-- ^ &#39;BuildStep&#39; to execute</span></span><span class="mpre">
    -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="#loc_221_6_221_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_6_221_19&#39;)"><span class="hl_tyconref"><span class="mpre">ChunkIOStream</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_1094_1_1094_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_1_1094_16&#39;)"><span class="hl_fundecl"><span class="mpre">buildStepToCIOS</span></span></a><span class="mpre"> !(</span><a href="#loc_984_27_984_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_984_27_984_45&#39;)"><span class="hl_conref"><span class="mpre">AllocationStrategy</span></span></a><span class="mpre"> </span><a name="loc_1094_38_1094_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_38_1094_48&#39;)"><span class="hl_vardecl"><span class="mpre">nextBuffer</span></span></a><span class="mpre"> </span><a name="loc_1094_49_1094_56" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_49_1094_56&#39;)"><span class="hl_vardecl"><span class="mpre">bufSize</span></span></a><span class="mpre"> </span><a name="loc_1094_57_1094_61" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_57_1094_61&#39;)"><span class="hl_vardecl"><span class="mpre">trim</span></span></a><span class="mpre">) =
    \</span><a name="loc_1095_6_1095_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1095_6_1095_10&#39;)"><span class="hl_vardecl"><span class="mpre">step</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_1094_38_1094_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_38_1094_48&#39;)"><span class="hl_varref"><span class="mpre">nextBuffer</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_1097_5_1097_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_5_1097_9&#39;)"><span class="hl_varref"><span class="mpre">fill</span></span></a><span class="mpre"> </span><a href="#loc_1095_6_1095_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1095_6_1095_10&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre">
  where
    </span><a name="loc_1097_5_1097_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_5_1097_9&#39;)"><span class="hl_fundecl"><span class="mpre">fill</span></span></a><span class="mpre"> !</span><a name="loc_1097_11_1097_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_11_1097_15&#39;)"><span class="hl_vardecl"><span class="mpre">step</span></span></a><span class="mpre"> !</span><a name="loc_1097_17_1097_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_17_1097_20&#39;)"><span class="hl_specname"><span class="mpre">buf</span></span></a><span class="mpre">@(</span><a href="#loc_175_15_175_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_15_175_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_1097_29_1097_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_29_1097_34&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a name="loc_1097_35_1097_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_35_1097_37&#39;)"><span class="hl_specname"><span class="mpre">br</span></span></a><span class="mpre">@(</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> _ </span><a name="loc_1097_53_1097_55" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_53_1097_55&#39;)"><span class="hl_vardecl"><span class="mpre">pe</span></span></a><span class="mpre">)) = do
        </span><a name="loc_1098_9_1098_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1098_9_1098_12&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_328_1_328_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_328_1_328_18&#39;)"><span class="hl_varref"><span class="mpre">fillWithBuildStep</span></span></a><span class="mpre"> </span><a href="#loc_1097_11_1097_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_11_1097_15&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_1104_9_1104_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1104_9_1104_14&#39;)"><span class="hl_varref"><span class="mpre">doneH</span></span></a><span class="mpre"> </span><a href="#loc_1107_9_1107_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1107_9_1107_14&#39;)"><span class="hl_varref"><span class="mpre">fullH</span></span></a><span class="mpre"> </span><a href="#loc_1111_9_1111_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1111_9_1111_21&#39;)"><span class="hl_varref"><span class="mpre">insertChunkH</span></span></a><span class="mpre"> </span><a href="#loc_1097_35_1097_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_35_1097_37&#39;)"><span class="hl_varref"><span class="mpre">br</span></span></a><span class="mpre">
        </span><a href="Foreign.ForeignPtr.html#loc_74_1_74_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.html#loc_74_1_74_16&#39;)"><span class="hl_varref"><span class="mpre">touchForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_1097_29_1097_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_29_1097_34&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_1098_9_1098_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1098_9_1098_12&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">
      where
        </span><a name="loc_1102_9_1102_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1102_9_1102_13&#39;)"><span class="hl_vardecl"><span class="mpre">pbuf</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_1097_29_1097_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_29_1097_34&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">

        </span><a name="loc_1104_9_1104_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1104_9_1104_14&#39;)"><span class="hl_fundecl"><span class="mpre">doneH</span></span></a><span class="mpre"> </span><a name="loc_1104_15_1104_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1104_15_1104_18&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_1104_19_1104_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1104_19_1104_20&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
            </span><a href="#loc_222_8_222_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_8_222_16&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre"> (</span><a href="#loc_175_15_175_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_15_175_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_1097_29_1097_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_29_1097_34&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> (</span><a href="#loc_170_20_170_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_20_170_31&#39;)"><span class="hl_conref"><span class="mpre">BufferRange</span></span></a><span class="mpre"> </span><a href="#loc_1104_15_1104_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1104_15_1104_18&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a href="#loc_1097_53_1097_55" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_53_1097_55&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre">)) </span><a href="#loc_1104_19_1104_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1104_19_1104_20&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">

        </span><a name="loc_1107_9_1107_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1107_9_1107_14&#39;)"><span class="hl_fundecl"><span class="mpre">fullH</span></span></a><span class="mpre"> </span><a name="loc_1107_15_1107_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1107_15_1107_18&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_1107_19_1107_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1107_19_1107_26&#39;)"><span class="hl_vardecl"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a name="loc_1107_27_1107_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1107_27_1107_35&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre"> =
            </span><a href="#loc_1122_9_1122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1122_9_1122_18&#39;)"><span class="hl_varref"><span class="mpre">wrapChunk</span></span></a><span class="mpre"> </span><a href="#loc_1107_15_1107_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1107_15_1107_18&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">const</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
                </span><a href="#loc_1094_38_1094_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_38_1094_48&#39;)"><span class="hl_varref"><span class="mpre">nextBuffer</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a href="#loc_1097_17_1097_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_17_1097_20&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">, </span><span class="hl_varref"><span class="mpre">max</span></span><span class="mpre"> </span><a href="#loc_1107_19_1107_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1107_19_1107_26&#39;)"><span class="hl_varref"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a href="#loc_1094_49_1094_56" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_49_1094_56&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre">)) </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_1097_5_1097_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_5_1097_9&#39;)"><span class="hl_varref"><span class="mpre">fill</span></span></a><span class="mpre"> </span><a href="#loc_1107_27_1107_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1107_27_1107_35&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">

        </span><a name="loc_1111_9_1111_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1111_9_1111_21&#39;)"><span class="hl_fundecl"><span class="mpre">insertChunkH</span></span></a><span class="mpre"> </span><a name="loc_1111_22_1111_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1111_22_1111_25&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_1111_26_1111_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1111_26_1111_28&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_1111_29_1111_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1111_29_1111_37&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre"> =
            </span><a href="#loc_1122_9_1122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1122_9_1122_18&#39;)"><span class="hl_varref"><span class="mpre">wrapChunk</span></span></a><span class="mpre"> </span><a href="#loc_1111_22_1111_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1111_22_1111_25&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_1112_30_1112_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1112_30_1112_37&#39;)"><span class="hl_vardecl"><span class="mpre">isEmpty</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_231_1_231_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_7&#39;)"><span class="hl_varref"><span class="mpre">yield1</span></span></a><span class="mpre"> </span><a href="#loc_1111_26_1111_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1111_26_1111_28&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
                </span><span class="hl_comment"><span class="mpre">-- Checking for empty case avoids allocating &#39;n-1&#39; empty</span></span><span class="mpre">
                </span><span class="hl_comment"><span class="mpre">-- buffers for &#39;n&#39; insertChunkH right after each other.</span></span><span class="mpre">
                if </span><a href="#loc_1112_30_1112_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1112_30_1112_37&#39;)"><span class="hl_varref"><span class="mpre">isEmpty</span></span></a><span class="mpre">
                  then </span><a href="#loc_1097_5_1097_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_5_1097_9&#39;)"><span class="hl_varref"><span class="mpre">fill</span></span></a><span class="mpre"> </span><a href="#loc_1111_29_1111_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1111_29_1111_37&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre"> </span><a href="#loc_1097_17_1097_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_17_1097_20&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">
                  else do </span><a name="loc_1117_27_1117_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1117_27_1117_31&#39;)"><span class="hl_vardecl"><span class="mpre">buf&#39;</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_1094_38_1094_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_38_1094_48&#39;)"><span class="hl_varref"><span class="mpre">nextBuffer</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a href="#loc_1097_17_1097_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_17_1097_20&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">, </span><a href="#loc_1094_49_1094_56" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_49_1094_56&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre">))
                          </span><a href="#loc_1097_5_1097_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_5_1097_9&#39;)"><span class="hl_varref"><span class="mpre">fill</span></span></a><span class="mpre"> </span><a href="#loc_1111_29_1111_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1111_29_1111_37&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre"> </span><a href="#loc_1117_27_1117_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1117_27_1117_31&#39;)"><span class="hl_varref"><span class="mpre">buf&#39;</span></span></a><span class="mpre">

        </span><span class="hl_comment"><span class="mpre">-- Wrap and yield a chunk, trimming it if necesary</span></span><span class="mpre">
        </span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_1122_9_1122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1122_9_1122_18&#39;)"><span class="mpre">wrapChunk</span></a><span class="mpre"> #-}</span></span><span class="mpre">
        </span><a name="loc_1122_9_1122_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1122_9_1122_18&#39;)"><span class="hl_fundecl"><span class="mpre">wrapChunk</span></span></a><span class="mpre"> !</span><a name="loc_1122_20_1122_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1122_20_1122_23&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_1122_24_1122_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1122_24_1122_30&#39;)"><span class="hl_vardecl"><span class="mpre">mkCIOS</span></span></a><span class="mpre">
          | </span><a href="#loc_1132_13_1132_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1132_13_1132_22&#39;)"><span class="hl_varref"><span class="mpre">chunkSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">      = </span><a href="#loc_1122_24_1122_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1122_24_1122_30&#39;)"><span class="hl_varref"><span class="mpre">mkCIOS</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">
          | </span><a href="#loc_1094_57_1094_61" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1094_57_1094_61&#39;)"><span class="hl_varref"><span class="mpre">trim</span></span></a><span class="mpre"> </span><a href="#loc_1132_13_1132_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1132_13_1132_22&#39;)"><span class="hl_varref"><span class="mpre">chunkSize</span></span></a><span class="mpre"> </span><a href="#loc_1133_13_1133_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1133_13_1133_17&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre"> = do
              </span><a name="loc_1125_15_1125_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1125_15_1125_17&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> &lt;- </span><a href="Data.ByteString.Internal.html#loc_434_1_434_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_434_1_434_7&#39;)"><span class="hl_varref"><span class="mpre">S.create</span></span></a><span class="mpre"> </span><a href="#loc_1132_13_1132_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1132_13_1132_22&#39;)"><span class="hl_varref"><span class="mpre">chunkSize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_1125_43_1125_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1125_43_1125_48&#39;)"><span class="hl_vardecl"><span class="mpre">pbuf&#39;</span></span></a><span class="mpre"> -&gt;
                        </span><span class="hl_varref"><span class="mpre">copyBytes</span></span><span class="mpre"> </span><a href="#loc_1125_43_1125_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1125_43_1125_48&#39;)"><span class="hl_varref"><span class="mpre">pbuf&#39;</span></span></a><span class="mpre"> </span><a href="#loc_1102_9_1102_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1102_9_1102_13&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre"> </span><a href="#loc_1132_13_1132_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1132_13_1132_22&#39;)"><span class="hl_varref"><span class="mpre">chunkSize</span></span></a><span class="mpre">
              </span><span class="hl_comment"><span class="mpre">-- FIXME: We could reuse the trimmed buffer here.</span></span><span class="mpre">
              </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_224_8_224_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_8_224_14&#39;)"><span class="hl_conref"><span class="mpre">Yield1</span></span></a><span class="mpre"> </span><a href="#loc_1125_15_1125_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1125_15_1125_17&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> (</span><a href="#loc_1122_24_1122_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1122_24_1122_30&#39;)"><span class="hl_varref"><span class="mpre">mkCIOS</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">)
          | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">            =
              </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_224_8_224_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_224_8_224_14&#39;)"><span class="hl_conref"><span class="mpre">Yield1</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_1097_29_1097_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_29_1097_34&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><a href="#loc_1132_13_1132_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1132_13_1132_22&#39;)"><span class="hl_varref"><span class="mpre">chunkSize</span></span></a><span class="mpre">) (</span><a href="#loc_1122_24_1122_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1122_24_1122_30&#39;)"><span class="hl_varref"><span class="mpre">mkCIOS</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">)
          where
            </span><a name="loc_1132_13_1132_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1132_13_1132_22&#39;)"><span class="hl_vardecl"><span class="mpre">chunkSize</span></span></a><span class="mpre"> = </span><a href="#loc_1122_20_1122_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1122_20_1122_23&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_1102_9_1102_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1102_9_1102_13&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre">
            </span><a name="loc_1133_13_1133_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1133_13_1133_17&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre">      = </span><a href="#loc_1097_53_1097_55" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1097_53_1097_55&#39;)"><span class="hl_varref"><span class="mpre">pe</span></span></a><span class="mpre">  </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_1102_9_1102_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_1102_9_1102_13&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre">
</span></div></body></html>