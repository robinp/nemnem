<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE CPP #-}
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   : (c) 2011 Simon Meier</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD3-style (see LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Simon Meier &lt;iridcode@gmail.com&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : GHC</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Hexadecimal encoding of nibbles (4-bit) and octets (8-bit) as ASCII</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- characters.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- The current implementation is based on a table based encoding inspired by</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the code in the &#39;base64-bytestring&#39; library by Bryan O&#39;Sullivan. In our</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- benchmarks on a 32-bit machine it turned out to be the fastest</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- implementation option.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Data.ByteString.Builder.Prim.Internal.Base16 (
    EncodingTable
  , lowerTable
  , encode8_as_16h
  ) where

import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Prim/Internal/Base16.hs&quot;, srcSpanStartLine = 24, srcSpanStartColumn = 18, srcSpanEndLine = 24, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre">          as S
import qualified Data.ByteString.Internal as S

#if MIN_VERSION_base(4,4,0)
#if MIN_VERSION_base(4,7,0)
import           Foreign
#else
import           Foreign hiding (unsafePerformIO, unsafeForeignPtrToPtr)
#endif
import           Foreign.ForeignPtr.Unsafe (unsafeForeignPtrToPtr)
import           System.IO.Unsafe (</span><a href="GHC.IO.html#loc_165_1_165_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_165_1_165_16&#39;)"><span class="mpre">unsafePerformIO</span></a><span class="mpre">)
#else
import           Foreign
#endif

</span><span class="hl_comment"><span class="mpre">-- Creating the encoding table</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- TODO: Use table from C implementation.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | An encoding table for Base16 encoding.</span></span><span class="mpre">
newtype </span><a name="loc_45_9_45_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_9_45_22&#39;)"><span class="hl_tycondecl"><span class="mpre">EncodingTable</span></span></a><span class="mpre"> = </span><a name="loc_45_25_45_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_25_45_38&#39;)"><span class="hl_condecl"><span class="mpre">EncodingTable</span></span></a><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">ForeignPtr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)

</span><a href="#loc_48_1_48_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_1_48_14&#39;)"><span class="mpre">tableFromList</span></a><span class="mpre"> :: [</span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">] -&gt; </span><a href="#loc_45_9_45_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_9_45_22&#39;)"><span class="hl_tyconref"><span class="mpre">EncodingTable</span></span></a><span class="mpre">
</span><a name="loc_48_1_48_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_1_48_14&#39;)"><span class="hl_fundecl"><span class="mpre">tableFromList</span></span></a><span class="mpre"> </span><a name="loc_48_15_48_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_15_48_17&#39;)"><span class="hl_vardecl"><span class="mpre">xs</span></span></a><span class="mpre"> = case </span><span class="hl_varref"><span class="mpre">S.pack</span></span><span class="mpre"> </span><a href="#loc_48_15_48_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_15_48_17&#39;)"><span class="hl_varref"><span class="mpre">xs</span></span></a><span class="mpre"> of </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a name="loc_48_43_48_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_43_48_45&#39;)"><span class="hl_vardecl"><span class="mpre">fp</span></span></a><span class="mpre"> _ _ -&gt; </span><a href="#loc_45_25_45_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_25_45_38&#39;)"><span class="hl_conref"><span class="mpre">EncodingTable</span></span></a><span class="mpre"> </span><a href="#loc_48_43_48_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_43_48_45&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre">

</span><a href="#loc_51_1_51_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_1_51_12&#39;)"><span class="mpre">unsafeIndex</span></a><span class="mpre"> :: </span><a href="#loc_45_9_45_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_9_45_22&#39;)"><span class="hl_tyconref"><span class="mpre">EncodingTable</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">
</span><a name="loc_51_1_51_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_1_51_12&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeIndex</span></span></a><span class="mpre"> (</span><a href="#loc_45_25_45_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_25_45_38&#39;)"><span class="hl_conref"><span class="mpre">EncodingTable</span></span></a><span class="mpre"> </span><a name="loc_51_28_51_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_28_51_33&#39;)"><span class="hl_vardecl"><span class="mpre">table</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">peekElemOff</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_51_28_51_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_28_51_33&#39;)"><span class="hl_varref"><span class="mpre">table</span></span></a><span class="mpre">)

</span><a href="#loc_54_1_54_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_1_54_20&#39;)"><span class="mpre">base16EncodingTable</span></a><span class="mpre"> :: </span><a href="#loc_45_9_45_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_9_45_22&#39;)"><span class="hl_tyconref"><span class="mpre">EncodingTable</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_45_9_45_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_9_45_22&#39;)"><span class="hl_tyconref"><span class="mpre">EncodingTable</span></span></a><span class="mpre">
</span><a name="loc_54_1_54_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_1_54_20&#39;)"><span class="hl_fundecl"><span class="mpre">base16EncodingTable</span></span></a><span class="mpre"> </span><a name="loc_54_21_54_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_21_54_29&#39;)"><span class="hl_vardecl"><span class="mpre">alphabet</span></span></a><span class="mpre"> = do
    </span><a name="loc_55_5_55_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_5_55_7&#39;)"><span class="hl_vardecl"><span class="mpre">xs</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">sequence</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">concat</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> [ [</span><a href="#loc_58_5_58_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_5_58_7&#39;)"><span class="hl_varref"><span class="mpre">ix</span></span></a><span class="mpre"> </span><a href="#loc_55_48_55_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_48_55_49&#39;)"><span class="hl_varref"><span class="mpre">j</span></span></a><span class="mpre">, </span><a href="#loc_58_5_58_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_5_58_7&#39;)"><span class="hl_varref"><span class="mpre">ix</span></span></a><span class="mpre"> </span><a href="#loc_55_62_55_63" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_62_55_63&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">] | </span><a name="loc_55_48_55_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_48_55_49&#39;)"><span class="hl_vardecl"><span class="mpre">j</span></span></a><span class="mpre"> &lt;- </span><span class="warning" data-warning="ExpEnumFromTo (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Prim/Internal/Base16.hs&quot;, srcSpanStartLine = 55, srcSpanStartColumn = 53, srcSpanEndLine = 55, srcSpanEndColumn = 60}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Prim/Internal/Base16.hs&quot;, srcSpanStartLine = 55, srcSpanStartColumn = 53, srcSpanEndLine = 55, srcSpanEndColumn = 54},SrcSpan {srcSpanFilename = &quot;/home/vagrant"><span class="mpre">[0..15]</span></span><span class="mpre">, </span><a name="loc_55_62_55_63" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_62_55_63&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> &lt;- </span><span class="warning" data-warning="ExpEnumFromTo (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Prim/Internal/Base16.hs&quot;, srcSpanStartLine = 55, srcSpanStartColumn = 67, srcSpanEndLine = 55, srcSpanEndColumn = 74}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Prim/Internal/Base16.hs&quot;, srcSpanStartLine = 55, srcSpanStartColumn = 67, srcSpanEndLine = 55, srcSpanEndColumn = 68},SrcSpan {srcSpanFilename = &quot;/home/vagrant"><span class="mpre">[0..15]</span></span><span class="mpre"> ]
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_48_1_48_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_1_48_14&#39;)"><span class="hl_varref"><span class="mpre">tableFromList</span></span></a><span class="mpre"> </span><a href="#loc_55_5_55_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_5_55_7&#39;)"><span class="hl_varref"><span class="mpre">xs</span></span></a><span class="mpre">
  where
    </span><a name="loc_58_5_58_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_58_5_58_7&#39;)"><span class="hl_vardecl"><span class="mpre">ix</span></span></a><span class="mpre"> = </span><a href="#loc_51_1_51_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_1_51_12&#39;)"><span class="hl_varref"><span class="mpre">unsafeIndex</span></span></a><span class="mpre"> </span><a href="#loc_54_21_54_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_21_54_29&#39;)"><span class="hl_varref"><span class="mpre">alphabet</span></span></a><span class="mpre">

</span><span class="hl_pragma"><span class="mpre">{-# NOINLINE </span><a href="#loc_62_1_62_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_1_62_14&#39;)"><span class="mpre">lowerAlphabet</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_62_1_62_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_1_62_14&#39;)"><span class="mpre">lowerAlphabet</span></a><span class="mpre"> :: </span><a href="#loc_45_9_45_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_9_45_22&#39;)"><span class="hl_tyconref"><span class="mpre">EncodingTable</span></span></a><span class="mpre">
</span><a name="loc_62_1_62_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_1_62_14&#39;)"><span class="hl_vardecl"><span class="mpre">lowerAlphabet</span></span></a><span class="mpre"> =
    </span><a href="#loc_48_1_48_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_48_1_48_14&#39;)"><span class="hl_varref"><span class="mpre">tableFromList</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">fromEnum</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="warning" data-warning="ExpEnumFromTo (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Prim/Internal/Base16.hs&quot;, srcSpanStartLine = 63, srcSpanStartColumn = 53, srcSpanEndLine = 63, srcSpanEndColumn = 63}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Prim/Internal/Base16.hs&quot;, srcSpanStartLine = 63, srcSpanStartColumn = 53, srcSpanEndLine = 63, srcSpanEndColumn = 54},SrcSpan {srcSpanFilename = &quot;/home/vagrant"><span class="mpre">[&#39;0&#39;..&#39;9&#39;]</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="warning" data-warning="ExpEnumFromTo (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Prim/Internal/Base16.hs&quot;, srcSpanStartLine = 63, srcSpanStartColumn = 67, srcSpanEndLine = 63, srcSpanEndColumn = 77}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Builder/Prim/Internal/Base16.hs&quot;, srcSpanStartLine = 63, srcSpanStartColumn = 67, srcSpanEndLine = 63, srcSpanEndColumn = 68},SrcSpan {srcSpanFilename = &quot;/home/vagrant"><span class="mpre">[&#39;a&#39;..&#39;f&#39;]</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The encoding table for hexadecimal values with lower-case characters;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- e.g., deadbeef.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# NOINLINE </span><a href="#loc_69_1_69_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_1_69_11&#39;)"><span class="mpre">lowerTable</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_69_1_69_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_1_69_11&#39;)"><span class="mpre">lowerTable</span></a><span class="mpre"> :: </span><a href="#loc_45_9_45_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_9_45_22&#39;)"><span class="hl_tyconref"><span class="mpre">EncodingTable</span></span></a><span class="mpre">
</span><a name="loc_69_1_69_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_69_1_69_11&#39;)"><span class="hl_vardecl"><span class="mpre">lowerTable</span></span></a><span class="mpre"> = </span><a href="GHC.IO.html#loc_165_1_165_16" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_165_1_165_16&#39;)"><span class="hl_varref"><span class="mpre">unsafePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_54_1_54_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_1_54_20&#39;)"><span class="hl_varref"><span class="mpre">base16EncodingTable</span></span></a><span class="mpre"> </span><a href="#loc_62_1_62_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_62_1_62_14&#39;)"><span class="hl_varref"><span class="mpre">lowerAlphabet</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Encode an octet as 16bit word comprising both encoded nibbles ordered</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- according to the host endianness. Writing these 16bit to memory will write</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the nibbles in the correct order (i.e. big-endian).</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_76_1_76_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_1_76_15&#39;)"><span class="mpre">encode8_as_16h</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_76_1_76_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_1_76_15&#39;)"><span class="mpre">encode8_as_16h</span></a><span class="mpre"> :: </span><a href="#loc_45_9_45_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_9_45_22&#39;)"><span class="hl_tyconref"><span class="mpre">EncodingTable</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word16</span></span><span class="mpre">
</span><a name="loc_76_1_76_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_1_76_15&#39;)"><span class="hl_fundecl"><span class="mpre">encode8_as_16h</span></span></a><span class="mpre"> (</span><a href="#loc_45_25_45_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_45_25_45_38&#39;)"><span class="hl_conref"><span class="mpre">EncodingTable</span></span></a><span class="mpre"> </span><a name="loc_76_31_76_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_31_76_36&#39;)"><span class="hl_vardecl"><span class="mpre">table</span></span></a><span class="mpre">) =
    </span><span class="hl_varref"><span class="mpre">peekElemOff</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_76_31_76_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_31_76_36&#39;)"><span class="hl_varref"><span class="mpre">table</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre">
</span></div></body></html>