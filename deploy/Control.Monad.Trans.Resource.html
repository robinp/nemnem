<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE FlexibleContexts #-}
{-# LANGUAGE FlexibleInstances #-}
{-# LANGUAGE MultiParamTypeClasses #-}
{-# LANGUAGE UndecidableInstances #-}
{-# LANGUAGE TypeFamilies #-}
{-# LANGUAGE RankNTypes #-}
{-# LANGUAGE CPP #-}
{-# LANGUAGE DeriveDataTypeable #-}
{-# LANGUAGE ImpredicativeTypes #-}
#if __GLASGOW_HASKELL__ &gt;= 704
{-# LANGUAGE ConstraintKinds #-}
#endif
</span><span class="hl_comment"><span class="mpre">-- | Allocate resources which are guaranteed to be released.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- For more information, see &lt;http://www.yesodweb.com/book/conduits&gt;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- One point to note: all register cleanup actions live in the @IO@ monad, not</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the main monad. This allows both more efficient code, and for monads to be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- transformed.</span></span><span class="mpre">
module Control.Monad.Trans.Resource
    ( </span><span class="hl_comment"><span class="mpre">-- * Data types</span></span><span class="mpre">
      ResourceT
    , ResIO
    , ReleaseKey
      </span><span class="hl_comment"><span class="mpre">-- * Unwrap</span></span><span class="mpre">
    , runResourceT
      </span><span class="hl_comment"><span class="mpre">-- * Special actions</span></span><span class="mpre">
    , resourceForkIO
      </span><span class="hl_comment"><span class="mpre">-- * Monad transformation</span></span><span class="mpre">
    , transResourceT
    , joinResourceT
      </span><span class="hl_comment"><span class="mpre">-- * Registering/releasing</span></span><span class="mpre">
    , allocate
    , register
    , release
    , unprotect
    , resourceMask
      </span><span class="hl_comment"><span class="mpre">-- * Type class/associated types</span></span><span class="mpre">
    , MonadResource (..)
    , MonadResourceBase
      </span><span class="hl_comment"><span class="mpre">-- ** Low-level</span></span><span class="mpre">
    , InvalidAccess (..)
      </span><span class="hl_comment"><span class="mpre">-- * Re-exports</span></span><span class="mpre">
    , MonadBaseControl
      </span><span class="hl_comment"><span class="mpre">-- * Internal state</span></span><span class="mpre">
      </span><span class="hl_comment"><span class="mpre">-- $internalState</span></span><span class="mpre">
    , InternalState
    , getInternalState
    , runInternalState
    , withInternalState
    , createInternalState
    , closeInternalState
      </span><span class="hl_comment"><span class="mpre">-- * Backwards compatibility</span></span><span class="mpre">
    , ExceptionT (..)
    , runExceptionT
    , runExceptionT_
    , runException
    , runException_
    , MonadThrow (..)
    , monadThrow
    ) where

import qualified Data.IntMap as IntMap
import Control.Exception (SomeException, throw)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 65, srcSpanStartColumn = 8, srcSpanEndLine = 65, srcSpanEndColumn = 35}, srcInfoPoints = []}) &quot;Control.Monad.Trans.Control&quot;"><span class="mpre">Control.Monad.Trans.Control</span></span><span class="mpre">
    ( MonadBaseControl (..), liftBaseDiscard, control )
import qualified Data.IORef as I
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 68, srcSpanStartColumn = 8, srcSpanEndLine = 68, srcSpanEndColumn = 26}, srcInfoPoints = []}) &quot;Control.Monad.Base&quot;"><span class="mpre">Control.Monad.Base</span></span><span class="mpre"> (MonadBase, liftBase)
import Control.Applicative (</span><a href="Control.Applicative.html#loc_113_20_113_31" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Applicative.html#loc_113_20_113_31&#39;)"><span class="mpre">Applicative</span></a><span class="mpre"> (..))
import Control.Monad.IO.Class (</span><a href="Control.Monad.IO.Class.html#loc_30_20_30_27" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_30_20_30_27&#39;)"><span class="mpre">MonadIO</span></a><span class="mpre"> (..))
import Control.Monad (</span><a href="Control.Monad.html#loc_274_1_274_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_274_1_274_6&#39;)"><span class="mpre">liftM</span></a><span class="mpre">)
import qualified Control.Exception as E
import Data.Monoid (</span><a href="Data.Monoid.html#loc_79_7_79_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_79_7_79_13&#39;)"><span class="mpre">Monoid</span></a><span class="mpre">)
import qualified Control.Exception.Lifted as L

import Control.Monad.Trans.Identity ( </span><a href="Control.Monad.Trans.Identity.html#loc_37_9_37_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.Identity.html#loc_37_9_37_18&#39;)"><span class="mpre">IdentityT</span></a><span class="mpre">)
import Control.Monad.Trans.List     ( </span><a href="Control.Monad.Trans.List.html#loc_38_9_38_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.List.html#loc_38_9_38_14&#39;)"><span class="mpre">ListT</span></a><span class="mpre">    )
import Control.Monad.Trans.Maybe    ( </span><a href="Control.Monad.Trans.Maybe.html#loc_57_9_57_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.Maybe.html#loc_57_9_57_15&#39;)"><span class="mpre">MaybeT</span></a><span class="mpre">   )
import Control.Monad.Trans.Error    ( </span><a href="Control.Monad.Trans.Error.html#loc_155_9_155_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.Error.html#loc_155_9_155_15&#39;)"><span class="mpre">ErrorT</span></a><span class="mpre">, </span><a href="Control.Monad.Trans.Error.html#loc_83_7_83_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.Error.html#loc_83_7_83_12&#39;)"><span class="mpre">Error</span></a><span class="mpre">)
import Control.Monad.Trans.Reader   ( </span><a href="Control.Monad.Trans.Reader.html#loc_92_9_92_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.Reader.html#loc_92_9_92_16&#39;)"><span class="mpre">ReaderT</span></a><span class="mpre">  )
import Control.Monad.Trans.State    ( </span><a href="Control.Monad.Trans.State.Lazy.html#loc_142_9_142_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.State.Lazy.html#loc_142_9_142_15&#39;)"><span class="mpre">StateT</span></a><span class="mpre">   )
import Control.Monad.Trans.Writer   ( </span><a href="Control.Monad.Trans.Writer.Lazy.html#loc_97_9_97_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.Writer.Lazy.html#loc_97_9_97_16&#39;)"><span class="mpre">WriterT</span></a><span class="mpre">  )
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 83, srcSpanStartColumn = 8, srcSpanEndLine = 83, srcSpanEndColumn = 45}, srcInfoPoints = []}) &quot;Control.Monad.Trans.Resource.Internal&quot;"><span class="mpre">Control.Monad.Trans.Resource.Internal</span></span><span class="mpre">
import Control.Monad.Trans.RWS      ( </span><a href="Control.Monad.Trans.RWS.Lazy.html#loc_118_9_118_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.RWS.Lazy.html#loc_118_9_118_13&#39;)"><span class="mpre">RWST</span></a><span class="mpre">     )

import qualified Control.Monad.Trans.RWS.Strict    as Strict ( </span><a href="Control.Monad.Trans.RWS.Strict.html#loc_118_9_118_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.RWS.Strict.html#loc_118_9_118_13&#39;)"><span class="mpre">RWST</span></a><span class="mpre">   )
import qualified Control.Monad.Trans.State.Strict  as Strict ( </span><a href="Control.Monad.Trans.State.Strict.html#loc_139_9_139_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.State.Strict.html#loc_139_9_139_15&#39;)"><span class="mpre">StateT</span></a><span class="mpre"> )
import qualified Control.Monad.Trans.Writer.Strict as Strict ( </span><a href="Control.Monad.Trans.Writer.Strict.html#loc_100_9_100_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Trans.Writer.Strict.html#loc_100_9_100_16&#39;)"><span class="mpre">WriterT</span></a><span class="mpre"> )
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 89, srcSpanStartColumn = 8, srcSpanEndLine = 89, srcSpanEndColumn = 26}, srcInfoPoints = []}) &quot;Control.Concurrent&quot;"><span class="mpre">Control.Concurrent</span></span><span class="mpre"> (ThreadId, forkIO)

import Control.Monad.ST (ST)

import qualified Control.Monad.ST.Lazy as Lazy

import Data.Functor.Identity (</span><a href="Data.Functor.Identity.html#loc_35_9_35_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.Identity.html#loc_35_9_35_17&#39;)"><span class="mpre">Identity</span></a><span class="mpre">, </span><a href="Data.Functor.Identity.html#loc_35_33_35_44" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.Identity.html#loc_35_33_35_44&#39;)"><span class="mpre">runIdentity</span></a><span class="mpre">)
import Control.Monad.Morph
import Control.Monad.Catch (</span><a href="Control.Monad.Catch.html#loc_116_18_116_28" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Catch.html#loc_116_18_116_28&#39;)"><span class="mpre">MonadThrow</span></a><span class="mpre">, </span><a href="Control.Monad.Catch.html#loc_124_3_124_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Catch.html#loc_124_3_124_9&#39;)"><span class="mpre">throwM</span></a><span class="mpre">)
import Control.Monad.Catch.Pure (</span><a href="Control.Monad.Catch.Pure.html#loc_91_9_91_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Catch.Pure.html#loc_91_9_91_15&#39;)"><span class="mpre">CatchT</span></a><span class="mpre">, </span><a href="Control.Monad.Catch.Pure.html#loc_91_31_91_40" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Catch.Pure.html#loc_91_31_91_40&#39;)"><span class="mpre">runCatchT</span></a><span class="mpre">)
import Data.Acquire.Internal (</span><a href="Data.Acquire.Internal.html#loc_26_6_26_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Acquire.Internal.html#loc_26_6_26_17&#39;)"><span class="mpre">ReleaseType</span></a><span class="mpre"> (..))



</span><span class="hl_comment"><span class="mpre">-- | Register some action that will be called precisely once, either when</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;runResourceT&#39; is called, or when the &#39;ReleaseKey&#39; is passed to &#39;release&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.3.0</span></span><span class="mpre">
</span><a href="#loc_108_1_108_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_108_1_108_9&#39;)"><span class="mpre">register</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 107, srcSpanStartColumn = 13, srcSpanEndLine = 107, srcSpanEndColumn = 31}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 107, srcSpanStartColumn = 29, srcSpanEndLine = 107, srcSpanEndColumn = 31}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">MonadResource m =&gt;</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ReleaseKey</span></span><span class="mpre">
</span><a name="loc_108_1_108_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_108_1_108_9&#39;)"><span class="hl_vardecl"><span class="mpre">register</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">liftResourceT</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_156_1_156_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_1_156_12&#39;)"><span class="hl_varref"><span class="mpre">registerRIO</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Call a release action early, and deregister it from the list of cleanup</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- actions to be performed.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.3.0</span></span><span class="mpre">
</span><a href="#loc_115_1_115_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_1_115_8&#39;)"><span class="mpre">release</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 114, srcSpanStartColumn = 12, srcSpanEndLine = 114, srcSpanEndColumn = 24}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 114, srcSpanStartColumn = 22, srcSpanEndLine = 114, srcSpanEndColumn = 24}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">MonadIO m =&gt;</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ReleaseKey</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_115_1_115_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_1_115_8&#39;)"><span class="hl_fundecl"><span class="mpre">release</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">ReleaseKey</span></span><span class="mpre"> </span><a name="loc_115_21_115_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_21_115_27&#39;)"><span class="hl_vardecl"><span class="mpre">istate</span></span></a><span class="mpre"> </span><a name="loc_115_28_115_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_28_115_30&#39;)"><span class="hl_vardecl"><span class="mpre">rk</span></span></a><span class="mpre">) = </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_172_1_172_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_1_172_9&#39;)"><span class="hl_varref"><span class="mpre">release&#39;</span></span></a><span class="mpre"> </span><a href="#loc_115_21_115_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_21_115_27&#39;)"><span class="hl_varref"><span class="mpre">istate</span></span></a><span class="mpre"> </span><a href="#loc_115_28_115_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_28_115_30&#39;)"><span class="hl_varref"><span class="mpre">rk</span></span></a><span class="mpre">  
    (</span><span class="hl_varref"><span class="mpre">maybe</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">) </span><span class="hl_varref"><span class="mpre">id</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Unprotect resource from cleanup actions, this allowes you to send</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- resource into another resourcet process and reregister it there.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- It returns an release action that should be run in order to clean </span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- resource or Nothing in case if resource is already freed.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.4.5</span></span><span class="mpre">
</span><a href="#loc_125_1_125_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_1_125_10&#39;)"><span class="mpre">unprotect</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 124, srcSpanStartColumn = 14, srcSpanEndLine = 124, srcSpanEndColumn = 26}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 124, srcSpanStartColumn = 24, srcSpanEndLine = 124, srcSpanEndColumn = 26}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">MonadIO m =&gt;</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ReleaseKey</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">))
</span><a name="loc_125_1_125_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_1_125_10&#39;)"><span class="hl_fundecl"><span class="mpre">unprotect</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">ReleaseKey</span></span><span class="mpre"> </span><a name="loc_125_23_125_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_23_125_29&#39;)"><span class="hl_vardecl"><span class="mpre">istate</span></span></a><span class="mpre"> </span><a name="loc_125_30_125_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_30_125_32&#39;)"><span class="hl_vardecl"><span class="mpre">rk</span></span></a><span class="mpre">) = </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_172_1_172_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_1_172_9&#39;)"><span class="hl_varref"><span class="mpre">release&#39;</span></span></a><span class="mpre"> </span><a href="#loc_125_23_125_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_23_125_29&#39;)"><span class="hl_varref"><span class="mpre">istate</span></span></a><span class="mpre"> </span><a href="#loc_125_30_125_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_125_30_125_32&#39;)"><span class="hl_varref"><span class="mpre">rk</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Perform some allocation, and automatically register a cleanup action.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This is almost identical to calling the allocation and then</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @register@ing the release action, but this properly handles masking of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- asynchronous exceptions.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.3.0</span></span><span class="mpre">
</span><a href="#loc_138_1_138_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_1_138_9&#39;)"><span class="mpre">allocate</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 134, srcSpanStartColumn = 13, srcSpanEndLine = 135, srcSpanEndColumn = 12}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 135, srcSpanStartColumn = 10, srcSpanEndLine = 135, srcSpanEndColumn = 12}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">MonadResource m
         =&gt;</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ allocate</span></span><span class="mpre">
         -&gt; (</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">) </span><span class="hl_comment"><span class="mpre">-- ^ free resource</span></span><span class="mpre">
         -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">ReleaseKey</span></span><span class="mpre">, </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_138_1_138_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_1_138_9&#39;)"><span class="hl_fundecl"><span class="mpre">allocate</span></span></a><span class="mpre"> </span><a name="loc_138_10_138_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_10_138_11&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">liftResourceT</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_150_1_150_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_1_150_12&#39;)"><span class="hl_varref"><span class="mpre">allocateRIO</span></span></a><span class="mpre"> </span><a href="#loc_138_10_138_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_138_10_138_11&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Perform asynchronous exception masking.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This is more general then @Control.Exception.mask@, yet more efficient</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- than @Control.Exception.Lifted.mask@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.3.0</span></span><span class="mpre">
</span><a href="#loc_147_1_147_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_1_147_13&#39;)"><span class="mpre">resourceMask</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 146, srcSpanStartColumn = 17, srcSpanEndLine = 146, srcSpanEndColumn = 35}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 146, srcSpanStartColumn = 33, srcSpanEndLine = 146, srcSpanEndColumn = 35}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">MonadResource m =&gt;</span></span><span class="mpre"> ((forall </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">. </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">) -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">
</span><a name="loc_147_1_147_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_1_147_13&#39;)"><span class="hl_vardecl"><span class="mpre">resourceMask</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">liftResourceT</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_159_1_159_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_1_159_16&#39;)"><span class="hl_varref"><span class="mpre">resourceMaskRIO</span></span></a><span class="mpre">

</span><a href="#loc_150_1_150_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_1_150_12&#39;)"><span class="mpre">allocateRIO</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; (</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">ReleaseKey</span></span><span class="mpre">, </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_150_1_150_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_1_150_12&#39;)"><span class="hl_fundecl"><span class="mpre">allocateRIO</span></span></a><span class="mpre"> </span><a name="loc_150_13_150_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_13_150_20&#39;)"><span class="hl_vardecl"><span class="mpre">acquire</span></span></a><span class="mpre"> </span><a name="loc_150_21_150_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_21_150_24&#39;)"><span class="hl_vardecl"><span class="mpre">rel</span></span></a><span class="mpre"> = </span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_150_40_150_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_40_150_46&#39;)"><span class="hl_vardecl"><span class="mpre">istate</span></span></a><span class="mpre"> -&gt; </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="GHC.IO.html#loc_428_1_428_5" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_428_1_428_5&#39;)"><span class="hl_varref"><span class="mpre">E.mask</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_150_69_150_76" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_69_150_76&#39;)"><span class="hl_vardecl"><span class="mpre">restore</span></span></a><span class="mpre"> -&gt; do
    </span><a name="loc_151_5_151_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_5_151_6&#39;)"><span class="hl_vardecl"><span class="mpre">a</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_150_69_150_76" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_69_150_76&#39;)"><span class="hl_varref"><span class="mpre">restore</span></span></a><span class="mpre"> </span><a href="#loc_150_13_150_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_13_150_20&#39;)"><span class="hl_varref"><span class="mpre">acquire</span></span></a><span class="mpre">
    </span><a name="loc_152_5_152_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_5_152_8&#39;)"><span class="hl_vardecl"><span class="mpre">key</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">register&#39;</span></span><span class="mpre"> </span><a href="#loc_150_40_150_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_40_150_46&#39;)"><span class="hl_varref"><span class="mpre">istate</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_150_21_150_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_150_21_150_24&#39;)"><span class="hl_varref"><span class="mpre">rel</span></span></a><span class="mpre"> </span><a href="#loc_151_5_151_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_5_151_6&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_152_5_152_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_152_5_152_8&#39;)"><span class="hl_varref"><span class="mpre">key</span></span></a><span class="mpre">, </span><a href="#loc_151_5_151_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_151_5_151_6&#39;)"><span class="hl_varref"><span class="mpre">a</span></span></a><span class="mpre">)

</span><a href="#loc_156_1_156_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_1_156_12&#39;)"><span class="mpre">registerRIO</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ReleaseKey</span></span><span class="mpre">
</span><a name="loc_156_1_156_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_1_156_12&#39;)"><span class="hl_fundecl"><span class="mpre">registerRIO</span></span></a><span class="mpre"> </span><a name="loc_156_13_156_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_13_156_16&#39;)"><span class="hl_vardecl"><span class="mpre">rel</span></span></a><span class="mpre"> = </span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_156_32_156_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_32_156_38&#39;)"><span class="hl_vardecl"><span class="mpre">istate</span></span></a><span class="mpre"> -&gt; </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">register&#39;</span></span><span class="mpre"> </span><a href="#loc_156_32_156_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_32_156_38&#39;)"><span class="hl_varref"><span class="mpre">istate</span></span></a><span class="mpre"> </span><a href="#loc_156_13_156_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_13_156_16&#39;)"><span class="hl_varref"><span class="mpre">rel</span></span></a><span class="mpre">

</span><a href="#loc_159_1_159_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_1_159_16&#39;)"><span class="mpre">resourceMaskRIO</span></a><span class="mpre"> :: ((forall </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">. </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">b</span></span><span class="mpre">
</span><a name="loc_159_1_159_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_1_159_16&#39;)"><span class="hl_fundecl"><span class="mpre">resourceMaskRIO</span></span></a><span class="mpre"> </span><a name="loc_159_17_159_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_17_159_18&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = </span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_159_34_159_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_34_159_40&#39;)"><span class="hl_vardecl"><span class="mpre">istate</span></span></a><span class="mpre"> -&gt; </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="GHC.IO.html#loc_428_1_428_5" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_428_1_428_5&#39;)"><span class="hl_varref"><span class="mpre">E.mask</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_159_63_159_70" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_63_159_70&#39;)"><span class="hl_vardecl"><span class="mpre">restore</span></span></a><span class="mpre"> -&gt;
    let </span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><a name="loc_160_19_160_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_160_19_160_21&#39;)"><span class="hl_vardecl"><span class="mpre">f&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_159_17_159_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_17_159_18&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> (</span><a href="#loc_164_5_164_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_5_164_7&#39;)"><span class="hl_varref"><span class="mpre">go</span></span></a><span class="mpre"> </span><a href="#loc_159_63_159_70" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_63_159_70&#39;)"><span class="hl_varref"><span class="mpre">restore</span></span></a><span class="mpre">)
     in </span><a href="#loc_160_19_160_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_160_19_160_21&#39;)"><span class="hl_varref"><span class="mpre">f&#39;</span></span></a><span class="mpre"> </span><a href="#loc_159_34_159_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_159_34_159_40&#39;)"><span class="hl_varref"><span class="mpre">istate</span></span></a><span class="mpre">
  where
    </span><a href="#loc_164_5_164_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_5_164_7&#39;)"><span class="mpre">go</span></a><span class="mpre"> :: (forall </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">. </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; (forall </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">. </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
    </span><a name="loc_164_5_164_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_5_164_7&#39;)"><span class="hl_fundecl"><span class="mpre">go</span></span></a><span class="mpre"> </span><a name="loc_164_8_164_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_8_164_9&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><a name="loc_164_21_164_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_21_164_22&#39;)"><span class="hl_vardecl"><span class="mpre">g</span></span></a><span class="mpre">) = </span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> (\</span><a name="loc_164_38_164_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_38_164_39&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_164_8_164_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_8_164_9&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> (</span><a href="#loc_164_21_164_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_21_164_22&#39;)"><span class="hl_varref"><span class="mpre">g</span></span></a><span class="mpre"> </span><a href="#loc_164_38_164_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_38_164_39&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre">))



</span><a href="#loc_172_1_172_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_1_172_9&#39;)"><span class="mpre">release&#39;</span></a><span class="mpre"> :: </span><a href="GHC.IORef.html#loc_34_9_34_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_34_9_34_14&#39;)"><span class="hl_tyconref"><span class="mpre">I.IORef</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ReleaseMap</span></span><span class="mpre">
         -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
         -&gt; (</span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
         -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_172_1_172_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_1_172_9&#39;)"><span class="hl_fundecl"><span class="mpre">release&#39;</span></span></a><span class="mpre"> </span><a name="loc_172_10_172_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_10_172_16&#39;)"><span class="hl_vardecl"><span class="mpre">istate</span></span></a><span class="mpre"> </span><a name="loc_172_17_172_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_17_172_20&#39;)"><span class="hl_vardecl"><span class="mpre">key</span></span></a><span class="mpre"> </span><a name="loc_172_21_172_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_21_172_24&#39;)"><span class="hl_vardecl"><span class="mpre">act</span></span></a><span class="mpre"> = </span><a href="GHC.IO.html#loc_426_1_426_6" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_426_1_426_6&#39;)"><span class="hl_varref"><span class="mpre">E.mask_</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
    </span><a name="loc_173_5_173_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_5_173_12&#39;)"><span class="hl_vardecl"><span class="mpre">maction</span></span></a><span class="mpre"> &lt;- </span><a href="Data.IORef.html#loc_101_1_101_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.IORef.html#loc_101_1_101_18&#39;)"><span class="hl_varref"><span class="mpre">I.atomicModifyIORef</span></span></a><span class="mpre"> </span><a href="#loc_172_10_172_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_10_172_16&#39;)"><span class="hl_varref"><span class="mpre">istate</span></span></a><span class="mpre"> </span><a href="#loc_176_5_176_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_5_176_17&#39;)"><span class="hl_varref"><span class="mpre">lookupAction</span></span></a><span class="mpre">
    </span><a href="#loc_172_21_172_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_21_172_24&#39;)"><span class="hl_varref"><span class="mpre">act</span></span></a><span class="mpre"> </span><a href="#loc_173_5_173_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_173_5_173_12&#39;)"><span class="hl_varref"><span class="mpre">maction</span></span></a><span class="mpre">
  where
    </span><a name="loc_176_5_176_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_5_176_17&#39;)"><span class="hl_fundecl"><span class="mpre">lookupAction</span></span></a><span class="mpre"> </span><a name="loc_176_18_176_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_18_176_20&#39;)"><span class="hl_specname"><span class="mpre">rm</span></span></a><span class="mpre">@(</span><span class="hl_conref"><span class="mpre">ReleaseMap</span></span><span class="mpre"> </span><a name="loc_176_33_176_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_33_176_37&#39;)"><span class="hl_vardecl"><span class="mpre">next</span></span></a><span class="mpre"> </span><a name="loc_176_38_176_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_38_176_40&#39;)"><span class="hl_vardecl"><span class="mpre">rf</span></span></a><span class="mpre"> </span><a name="loc_176_41_176_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_41_176_42&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre">) =
        case </span><span class="hl_varref"><span class="mpre">IntMap.lookup</span></span><span class="mpre"> </span><a href="#loc_172_17_172_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_17_172_20&#39;)"><span class="hl_varref"><span class="mpre">key</span></span></a><span class="mpre"> </span><a href="#loc_176_41_176_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_41_176_42&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> of
            </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; (</span><a href="#loc_176_18_176_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_18_176_20&#39;)"><span class="hl_varref"><span class="mpre">rm</span></span></a><span class="mpre">, </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">)
            </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_179_18_179_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_179_18_179_24&#39;)"><span class="hl_vardecl"><span class="mpre">action</span></span></a><span class="mpre"> -&gt;
                ( </span><span class="hl_conref"><span class="mpre">ReleaseMap</span></span><span class="mpre"> </span><a href="#loc_176_33_176_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_33_176_37&#39;)"><span class="hl_varref"><span class="mpre">next</span></span></a><span class="mpre"> </span><a href="#loc_176_38_176_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_38_176_40&#39;)"><span class="hl_varref"><span class="mpre">rf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">IntMap.delete</span></span><span class="mpre"> </span><a href="#loc_172_17_172_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_17_172_20&#39;)"><span class="hl_varref"><span class="mpre">key</span></span></a><span class="mpre"> </span><a href="#loc_176_41_176_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_41_176_42&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre">
                , </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a href="#loc_179_18_179_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_179_18_179_24&#39;)"><span class="hl_varref"><span class="mpre">action</span></span></a><span class="mpre"> </span><a href="Data.Acquire.Internal.html#loc_26_20_26_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Acquire.Internal.html#loc_26_20_26_32&#39;)"><span class="hl_conref"><span class="mpre">ReleaseEarly</span></span></a><span class="mpre">)
                )
    </span><span class="hl_comment"><span class="mpre">-- We tried to call release, but since the state is already closed, we</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- can assume that the release action was already called. Previously,</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- this threw an exception, though given that @release@ can be called</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- from outside the context of a @ResourceT@ starting with version</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- 0.4.4, it&#39;s no longer a library misuse or a library bug.</span></span><span class="mpre">
    </span><a href="#loc_176_5_176_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_176_5_176_17&#39;)"><span class="hl_fundecl"><span class="mpre">lookupAction</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">ReleaseMapClosed</span></span><span class="mpre"> = (</span><span class="hl_conref"><span class="mpre">ReleaseMapClosed</span></span><span class="mpre">, </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">)



</span><span class="hl_comment"><span class="mpre">-- | Unwrap a &#39;ResourceT&#39; transformer, and call all registered release actions.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that there is some reference counting involved due to &#39;resourceForkIO&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- If multiple threads are sharing the same collection of resources, only the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- last call to @runResourceT@ will deallocate the resources.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.3.0</span></span><span class="mpre">
</span><a href="#loc_200_1_200_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_1_200_13&#39;)"><span class="mpre">runResourceT</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 199, srcSpanStartColumn = 17, srcSpanEndLine = 199, srcSpanEndColumn = 41}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 199, srcSpanStartColumn = 39, srcSpanEndLine = 199, srcSpanEndColumn = 41}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">MonadBaseControl IO m =&gt;</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_200_1_200_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_1_200_13&#39;)"><span class="hl_fundecl"><span class="mpre">runResourceT</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><a name="loc_200_25_200_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_25_200_26&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">control</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_200_41_200_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_41_200_44&#39;)"><span class="hl_vardecl"><span class="mpre">run</span></span></a><span class="mpre"> -&gt; do
    </span><a name="loc_201_5_201_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_5_201_11&#39;)"><span class="hl_vardecl"><span class="mpre">istate</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_331_1_331_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_1_331_20&#39;)"><span class="hl_varref"><span class="mpre">createInternalState</span></span></a><span class="mpre">
    </span><a href="GHC.IO.html#loc_428_1_428_5" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_428_1_428_5&#39;)"><span class="hl_varref"><span class="mpre">E.mask</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_202_15_202_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_202_15_202_22&#39;)"><span class="hl_vardecl"><span class="mpre">restore</span></span></a><span class="mpre"> -&gt; do
        </span><a name="loc_203_9_203_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_9_203_12&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_202_15_202_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_202_15_202_22&#39;)"><span class="hl_varref"><span class="mpre">restore</span></span></a><span class="mpre"> (</span><a href="#loc_200_41_200_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_41_200_44&#39;)"><span class="hl_varref"><span class="mpre">run</span></span></a><span class="mpre"> (</span><a href="#loc_200_25_200_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_25_200_26&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre"> </span><a href="#loc_201_5_201_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_5_201_11&#39;)"><span class="hl_varref"><span class="mpre">istate</span></span></a><span class="mpre">)) </span><a href="Control.Exception.Base.html#loc_229_1_229_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_229_1_229_12&#39;)"><span class="hl_infix"><span class="mpre">`E.onException`</span></span></a><span class="mpre">
            </span><span class="hl_varref"><span class="mpre">stateCleanup</span></span><span class="mpre"> </span><a href="Data.Acquire.Internal.html#loc_28_20_28_36" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Acquire.Internal.html#loc_28_20_28_36&#39;)"><span class="hl_conref"><span class="mpre">ReleaseException</span></span></a><span class="mpre"> </span><a href="#loc_201_5_201_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_5_201_11&#39;)"><span class="hl_varref"><span class="mpre">istate</span></span></a><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">stateCleanup</span></span><span class="mpre"> </span><a href="Data.Acquire.Internal.html#loc_27_20_27_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Acquire.Internal.html#loc_27_20_27_33&#39;)"><span class="hl_conref"><span class="mpre">ReleaseNormal</span></span></a><span class="mpre"> </span><a href="#loc_201_5_201_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_5_201_11&#39;)"><span class="hl_varref"><span class="mpre">istate</span></span></a><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_203_9_203_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_9_203_12&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">

</span><a href="#loc_214_1_214_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_9&#39;)"><span class="mpre">bracket_</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 208, srcSpanStartColumn = 13, srcSpanEndLine = 209, srcSpanEndColumn = 12}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 209, srcSpanStartColumn = 10, srcSpanEndLine = 209, srcSpanEndColumn = 12}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">MonadBaseControl IO m
         =&gt;</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ allocate</span></span><span class="mpre">
         -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ normal cleanup</span></span><span class="mpre">
         -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ exceptional cleanup</span></span><span class="mpre">
         -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
         -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_214_1_214_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_9&#39;)"><span class="hl_fundecl"><span class="mpre">bracket_</span></span></a><span class="mpre"> </span><a name="loc_214_10_214_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_10_214_15&#39;)"><span class="hl_vardecl"><span class="mpre">alloc</span></span></a><span class="mpre"> </span><a name="loc_214_16_214_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_16_214_29&#39;)"><span class="hl_vardecl"><span class="mpre">cleanupNormal</span></span></a><span class="mpre"> </span><a name="loc_214_30_214_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_30_214_40&#39;)"><span class="hl_vardecl"><span class="mpre">cleanupExc</span></span></a><span class="mpre"> </span><a name="loc_214_41_214_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_41_214_47&#39;)"><span class="hl_vardecl"><span class="mpre">inside</span></span></a><span class="mpre"> =
    </span><span class="hl_varref"><span class="mpre">control</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_215_16_215_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_16_215_19&#39;)"><span class="hl_vardecl"><span class="mpre">run</span></span></a><span class="mpre"> -&gt; </span><a href="GHC.IO.html#loc_428_1_428_5" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_428_1_428_5&#39;)"><span class="hl_varref"><span class="mpre">E.mask</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_215_33_215_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_33_215_40&#39;)"><span class="hl_vardecl"><span class="mpre">restore</span></span></a><span class="mpre"> -&gt; do
        </span><a href="#loc_214_10_214_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_10_214_15&#39;)"><span class="hl_varref"><span class="mpre">alloc</span></span></a><span class="mpre">
        </span><a name="loc_217_9_217_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_9_217_12&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_215_33_215_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_33_215_40&#39;)"><span class="hl_varref"><span class="mpre">restore</span></span></a><span class="mpre"> (</span><a href="#loc_215_16_215_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_16_215_19&#39;)"><span class="hl_varref"><span class="mpre">run</span></span></a><span class="mpre"> </span><a href="#loc_214_41_214_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_41_214_47&#39;)"><span class="hl_varref"><span class="mpre">inside</span></span></a><span class="mpre">) </span><a href="Control.Exception.Base.html#loc_229_1_229_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_229_1_229_12&#39;)"><span class="hl_infix"><span class="mpre">`E.onException`</span></span></a><span class="mpre"> </span><a href="#loc_214_30_214_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_30_214_40&#39;)"><span class="hl_varref"><span class="mpre">cleanupExc</span></span></a><span class="mpre">
        </span><a href="#loc_214_16_214_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_16_214_29&#39;)"><span class="hl_varref"><span class="mpre">cleanupNormal</span></span></a><span class="mpre">
        </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_217_9_217_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_9_217_12&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">

</span><a href="#loc_222_1_222_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_1_222_8&#39;)"><span class="mpre">finally</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 221, srcSpanStartColumn = 12, srcSpanEndLine = 221, srcSpanEndColumn = 36}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 221, srcSpanStartColumn = 34, srcSpanEndLine = 221, srcSpanEndColumn = 36}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">MonadBaseControl IO m =&gt;</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_222_1_222_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_1_222_8&#39;)"><span class="hl_fundecl"><span class="mpre">finally</span></span></a><span class="mpre"> </span><a name="loc_222_9_222_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_9_222_15&#39;)"><span class="hl_vardecl"><span class="mpre">action</span></span></a><span class="mpre"> </span><a name="loc_222_16_222_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_16_222_23&#39;)"><span class="hl_vardecl"><span class="mpre">cleanup</span></span></a><span class="mpre"> =
    </span><span class="hl_varref"><span class="mpre">control</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_223_16_223_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_16_223_19&#39;)"><span class="hl_vardecl"><span class="mpre">run</span></span></a><span class="mpre"> -&gt; </span><a href="Control.Exception.Base.html#loc_273_3_273_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_273_3_273_12&#39;)"><span class="hl_varref"><span class="mpre">E.finally</span></span></a><span class="mpre"> (</span><a href="#loc_223_16_223_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_223_16_223_19&#39;)"><span class="hl_varref"><span class="mpre">run</span></span></a><span class="mpre"> </span><a href="#loc_222_9_222_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_9_222_15&#39;)"><span class="hl_varref"><span class="mpre">action</span></span></a><span class="mpre">) </span><a href="#loc_222_16_222_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_222_16_222_23&#39;)"><span class="hl_varref"><span class="mpre">cleanup</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | This function mirrors @join@ at the transformer level: it will collapse</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- two levels of @ResourceT@ into a single @ResourceT@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.4.6</span></span><span class="mpre">
</span><a href="#loc_231_1_231_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_14&#39;)"><span class="mpre">joinResourceT</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre">) </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
              -&gt; </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_231_1_231_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_1_231_14&#39;)"><span class="hl_fundecl"><span class="mpre">joinResourceT</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><a name="loc_231_26_231_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_26_231_27&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre">) = </span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_231_44_231_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_44_231_45&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">unResourceT</span></span><span class="mpre"> (</span><a href="#loc_231_26_231_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_26_231_27&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_231_44_231_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_44_231_45&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">) </span><a href="#loc_231_44_231_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_44_231_45&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | For backwards compatibility.</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 234, srcSpanStartColumn = 1, srcSpanEndLine = 234, srcSpanEndColumn = 25}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 234, srcSpanStartColumn = 1, srcSpanEndLine = 234, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Contro"><span class="mpre">type ExceptionT = CatchT</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | For backwards compatibility.</span></span><span class="mpre">
</span><a href="#loc_238_1_238_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_238_1_238_14&#39;)"><span class="mpre">runExceptionT</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">ExceptionT</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Either</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">SomeException</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_238_1_238_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_238_1_238_14&#39;)"><span class="hl_vardecl"><span class="mpre">runExceptionT</span></span></a><span class="mpre"> = </span><a href="Control.Monad.Catch.Pure.html#loc_91_31_91_40" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Catch.Pure.html#loc_91_31_91_40&#39;)"><span class="hl_varref"><span class="mpre">runCatchT</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Same as &#39;runExceptionT&#39;, but immediately &#39;E.throw&#39; any exception returned.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.3.0</span></span><span class="mpre">
</span><a href="#loc_244_1_244_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_244_1_244_15&#39;)"><span class="mpre">runExceptionT_</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 243, srcSpanStartColumn = 19, srcSpanEndLine = 243, srcSpanEndColumn = 29}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 243, srcSpanStartColumn = 27, srcSpanEndLine = 243, srcSpanEndColumn = 29}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">Monad m =&gt;</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ExceptionT</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_244_1_244_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_244_1_244_15&#39;)"><span class="hl_vardecl"><span class="mpre">runExceptionT_</span></span></a><span class="mpre"> = </span><a href="Control.Monad.html#loc_274_1_274_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_274_1_274_6&#39;)"><span class="hl_varref"><span class="mpre">liftM</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">either</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">E.throw</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">id</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_238_1_238_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_238_1_238_14&#39;)"><span class="hl_varref"><span class="mpre">runExceptionT</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run an @ExceptionT Identity@ stack.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.4.2</span></span><span class="mpre">
</span><a href="#loc_250_1_250_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_250_1_250_13&#39;)"><span class="mpre">runException</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">ExceptionT</span></span><span class="mpre"> </span><a href="Data.Functor.Identity.html#loc_35_9_35_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.Identity.html#loc_35_9_35_17&#39;)"><span class="hl_tyconref"><span class="mpre">Identity</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Either</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">SomeException</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_250_1_250_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_250_1_250_13&#39;)"><span class="hl_vardecl"><span class="mpre">runException</span></span></a><span class="mpre"> = </span><a href="Data.Functor.Identity.html#loc_35_33_35_44" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.Identity.html#loc_35_33_35_44&#39;)"><span class="hl_varref"><span class="mpre">runIdentity</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_238_1_238_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_238_1_238_14&#39;)"><span class="hl_varref"><span class="mpre">runExceptionT</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run an @ExceptionT Identity@ stack, but immediately &#39;E.throw&#39; any exception returned.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.4.2</span></span><span class="mpre">
</span><a href="#loc_256_1_256_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_256_1_256_14&#39;)"><span class="mpre">runException_</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">ExceptionT</span></span><span class="mpre"> </span><a href="Data.Functor.Identity.html#loc_35_9_35_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.Identity.html#loc_35_9_35_17&#39;)"><span class="hl_tyconref"><span class="mpre">Identity</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_256_1_256_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_256_1_256_14&#39;)"><span class="hl_vardecl"><span class="mpre">runException_</span></span></a><span class="mpre"> = </span><a href="Data.Functor.Identity.html#loc_35_33_35_44" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.Identity.html#loc_35_33_35_44&#39;)"><span class="hl_varref"><span class="mpre">runIdentity</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="#loc_244_1_244_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_244_1_244_15&#39;)"><span class="hl_varref"><span class="mpre">runExceptionT_</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Introduce a reference-counting scheme to allow a resource context to be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- shared by multiple threads. Once the last thread exits, all remaining</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- resources will be released.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that abuse of this function will greatly delay the deallocation of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- registered resources. This function should be used with care. A general</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- guideline:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- If you are allocating a resource that should be shared by multiple threads,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- and will be held for a long time, you should allocate it at the beginning of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- a new @ResourceT@ block and then call @resourceForkIO@ from there.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.3.0</span></span><span class="mpre">
</span><a href="#loc_272_1_272_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_1_272_15&#39;)"><span class="mpre">resourceForkIO</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 271, srcSpanStartColumn = 19, srcSpanEndLine = 271, srcSpanEndColumn = 43}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 271, srcSpanStartColumn = 41, srcSpanEndLine = 271, srcSpanEndColumn = 43}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">MonadBaseControl IO m =&gt;</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ThreadId</span></span><span class="mpre">
</span><a name="loc_272_1_272_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_1_272_15&#39;)"><span class="hl_fundecl"><span class="mpre">resourceForkIO</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><a name="loc_272_27_272_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_27_272_28&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre">) = </span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_272_45_272_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_45_272_46&#39;)"><span class="hl_vardecl"><span class="mpre">r</span></span></a><span class="mpre"> -&gt; </span><a href="Control.Exception.Lifted.html#loc_268_1_268_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Lifted.html#loc_268_1_268_5&#39;)"><span class="hl_varref"><span class="mpre">L.mask</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_272_60_272_67" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_60_272_67&#39;)"><span class="hl_vardecl"><span class="mpre">restore</span></span></a><span class="mpre"> -&gt;
    </span><span class="hl_comment"><span class="mpre">-- We need to make sure the counter is incremented before this call</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- returns. Otherwise, the parent thread may call runResourceT before</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- the child thread increments, and all resources will be freed</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- before the child gets called.</span></span><span class="mpre">
    </span><a href="#loc_214_1_214_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_9&#39;)"><span class="hl_varref"><span class="mpre">bracket_</span></span></a><span class="mpre">
        (</span><span class="hl_varref"><span class="mpre">stateAlloc</span></span><span class="mpre"> </span><a href="#loc_272_45_272_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_45_272_46&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">)
        (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">)
        (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">)
        (</span><span class="hl_varref"><span class="mpre">liftBaseDiscard</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">forkIO</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_214_1_214_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_9&#39;)"><span class="hl_varref"><span class="mpre">bracket_</span></span></a><span class="mpre">
            (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">)
            (</span><span class="hl_varref"><span class="mpre">stateCleanup</span></span><span class="mpre"> </span><a href="Data.Acquire.Internal.html#loc_27_20_27_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Acquire.Internal.html#loc_27_20_27_33&#39;)"><span class="hl_conref"><span class="mpre">ReleaseNormal</span></span></a><span class="mpre"> </span><a href="#loc_272_45_272_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_45_272_46&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">)
            (</span><span class="hl_varref"><span class="mpre">stateCleanup</span></span><span class="mpre"> </span><a href="Data.Acquire.Internal.html#loc_28_20_28_36" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Acquire.Internal.html#loc_28_20_28_36&#39;)"><span class="hl_conref"><span class="mpre">ReleaseException</span></span></a><span class="mpre"> </span><a href="#loc_272_45_272_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_45_272_46&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">)
            (</span><a href="#loc_272_60_272_67" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_60_272_67&#39;)"><span class="hl_varref"><span class="mpre">restore</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_272_27_272_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_27_272_28&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_272_45_272_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_272_45_272_46&#39;)"><span class="hl_varref"><span class="mpre">r</span></span></a><span class="mpre">))



</span><span class="hl_comment"><span class="mpre">-- | A @Monad@ which can be used as a base for a @ResourceT@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- A @ResourceT@ has some restrictions on its base monad:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * @runResourceT@ requires an instance of @MonadBaseControl IO@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * @MonadResource@ requires an instance of @MonadThrow@, @MonadIO@, and @Applicative@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- While any instance of @MonadBaseControl IO@ should be an instance of the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- other classes, this is not guaranteed by the type system (e.g., you may have</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- a transformer in your stack with does not implement @MonadThrow@). Ideally,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- we would like to simply create an alias for the five type classes listed,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- but this is not possible with GHC currently.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Instead, this typeclass acts as a proxy for the other five. Its only purpose</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- is to make your type signatures shorter.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that earlier versions of @conduit@ had a typeclass @ResourceIO@. This</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- fulfills much the same role.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.3.2</span></span><span class="mpre">
#if __GLASGOW_HASKELL__ &gt;= 704
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 310, srcSpanStartColumn = 1, srcSpanEndLine = 310, srcSpanEndColumn = 107}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 310, srcSpanStartColumn = 1, srcSpanEndLine = 310, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Contr"><span class="mpre">type MonadResourceBase m = (MonadBaseControl IO m, MonadThrow m, MonadBase IO m, MonadIO m, Applicative m)</span></span><span class="mpre">
#else
class </span><span class="warning" data-warning="ClassDecl ContextCxTuple (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 312, srcSpanStartColumn = 7, srcSpanEndLine = 312, srcSpanEndColumn = 73}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 312, srcSpanStartColumn = 7, srcSpanEndLine = 312, srcSpanEndColumn = 8},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control"><span class="mpre">(MonadBaseControl IO m, MonadThrow m, MonadIO m, Applicative m) =&gt;</span></span><span class="mpre"> </span><a name="loc_312_74_312_91" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_312_74_312_91&#39;)"><span class="hl_classdecl"><span class="mpre">MonadResourceBase</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre">
instance </span><span class="warning" data-warning="InstDecl ContextCxTuple (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 313, srcSpanStartColumn = 10, srcSpanEndLine = 313, srcSpanEndColumn = 76}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 313, srcSpanStartColumn = 10, srcSpanEndLine = 313, srcSpanEndColumn = 11},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Cont"><span class="mpre">(MonadBaseControl IO m, MonadThrow m, MonadIO m, Applicative m) =&gt;</span></span><span class="mpre"> </span><a href="#loc_312_74_312_91" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_312_74_312_91&#39;)"><span class="hl_classref"><span class="mpre">MonadResourceBase</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre">
#endif

</span><span class="hl_comment"><span class="mpre">-- $internalState</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- A @ResourceT@ internally is a modified @ReaderT@ monad transformer holding</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- onto a mutable reference to all of the release actions still remaining to be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- performed. If you are building up a custom application monad, it may be more</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- efficient to embed this @ReaderT@ functionality directly in your own monad</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- instead of wrapping around @ResourceT@ itself. This section provides you the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- means of doing so.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Create a new internal state. This state must be closed with</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @closeInternalState@. It is your responsibility to ensure exception safety.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Caveat emptor!</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.4.9</span></span><span class="mpre">
</span><a href="#loc_331_1_331_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_1_331_20&#39;)"><span class="mpre">createInternalState</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 330, srcSpanStartColumn = 24, srcSpanEndLine = 330, srcSpanEndColumn = 41}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 330, srcSpanStartColumn = 39, srcSpanEndLine = 330, srcSpanEndColumn = 41}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">MonadBase IO m =&gt;</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">InternalState</span></span><span class="mpre">
</span><a name="loc_331_1_331_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_331_1_331_20&#39;)"><span class="hl_vardecl"><span class="mpre">createInternalState</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">liftBase</span></span><span class="mpre">
                    </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="GHC.IORef.html#loc_42_1_42_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_42_1_42_9&#39;)"><span class="hl_varref"><span class="mpre">I.newIORef</span></span></a><span class="mpre">
                    </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">ReleaseMap</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">maxBound</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">minBound</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">) </span><span class="hl_varref"><span class="mpre">IntMap.empty</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Close an internal state created by @createInternalState@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.4.9</span></span><span class="mpre">
</span><a href="#loc_339_1_339_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_1_339_19&#39;)"><span class="mpre">closeInternalState</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 338, srcSpanStartColumn = 23, srcSpanEndLine = 338, srcSpanEndColumn = 40}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 338, srcSpanStartColumn = 38, srcSpanEndLine = 338, srcSpanEndColumn = 40}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">MonadBase IO m =&gt;</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">InternalState</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_339_1_339_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_1_339_19&#39;)"><span class="hl_vardecl"><span class="mpre">closeInternalState</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">liftBase</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">stateCleanup</span></span><span class="mpre"> </span><a href="Data.Acquire.Internal.html#loc_27_20_27_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Acquire.Internal.html#loc_27_20_27_33&#39;)"><span class="hl_conref"><span class="mpre">ReleaseNormal</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Get the internal state of the current @ResourceT@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.4.6</span></span><span class="mpre">
</span><a href="#loc_345_1_345_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_345_1_345_17&#39;)"><span class="mpre">getInternalState</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 344, srcSpanStartColumn = 21, srcSpanEndLine = 344, srcSpanEndColumn = 31}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 344, srcSpanStartColumn = 29, srcSpanEndLine = 344, srcSpanEndColumn = 31}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/va"><span class="mpre">Monad m =&gt;</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">InternalState</span></span><span class="mpre">
</span><a name="loc_345_1_345_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_345_1_345_17&#39;)"><span class="hl_vardecl"><span class="mpre">getInternalState</span></span></a><span class="mpre"> = </span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The internal state held by a @ResourceT@ transformer.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.4.6</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 350, srcSpanStartColumn = 1, srcSpanEndLine = 350, srcSpanEndColumn = 40}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 350, srcSpanStartColumn = 1, srcSpanEndLine = 350, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Contro"><span class="mpre">type InternalState = I.IORef ReleaseMap</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Unwrap a @ResourceT@ using the given @InternalState@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.4.6</span></span><span class="mpre">
</span><a href="#loc_356_1_356_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_356_1_356_17&#39;)"><span class="mpre">runInternalState</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">InternalState</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_356_1_356_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_356_1_356_17&#39;)"><span class="hl_vardecl"><span class="mpre">runInternalState</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">unResourceT</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Run an action in the underlying monad, providing it the @InternalState@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Since 0.4.6</span></span><span class="mpre">
</span><a href="#loc_362_1_362_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_362_1_362_18&#39;)"><span class="mpre">withInternalState</span></a><span class="mpre"> :: (</span><span class="hl_tyconref"><span class="mpre">InternalState</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">ResourceT</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_362_1_362_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_362_1_362_18&#39;)"><span class="hl_vardecl"><span class="mpre">withInternalState</span></span></a><span class="mpre"> = </span><span class="hl_conref"><span class="mpre">ResourceT</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Backwards compatibility</span></span><span class="mpre">
</span><a href="#loc_366_1_366_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_366_1_366_11&#39;)"><span class="mpre">monadThrow</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxTuple (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 365, srcSpanStartColumn = 15, srcSpanEndLine = 365, srcSpanEndColumn = 47}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Control/Monad/Trans/Resource.hs&quot;, srcSpanStartLine = 365, srcSpanStartColumn = 15, srcSpanEndLine = 365, srcSpanEndColumn = 16},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/resourcet-1.1.2.2/Cont"><span class="mpre">(E.Exception e, MonadThrow m) =&gt;</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">e</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_366_1_366_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_366_1_366_11&#39;)"><span class="hl_vardecl"><span class="mpre">monadThrow</span></span></a><span class="mpre"> = </span><a href="Control.Monad.Catch.html#loc_124_3_124_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.Catch.html#loc_124_3_124_9&#39;)"><span class="hl_varref"><span class="mpre">throwM</span></span></a><span class="mpre">
</span></div></body></html>