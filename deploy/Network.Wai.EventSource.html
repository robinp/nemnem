<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE OverloadedStrings #-}
</span><span class="hl_comment"><span class="mpre">{-|
    A WAI adapter to the HTML5 Server-Sent Events API.
-}</span></span><span class="mpre">
module Network.Wai.EventSource (
    ServerEvent(..),
    eventSourceAppChan,
    eventSourceAppIO
    ) where

import           Blaze.ByteString.Builder (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="mpre">Builder</span></a><span class="mpre">)
import           Data.Function (</span><a href="Data.Function.html#loc_32_1_32_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Function.html#loc_32_1_32_4&#39;)"><span class="mpre">fix</span></a><span class="mpre">)
import           Control.Concurrent.Chan (</span><a href="Control.Concurrent.Chan.html#loc_51_6_51_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.Chan.html#loc_51_6_51_10&#39;)"><span class="mpre">Chan</span></a><span class="mpre">, </span><a href="Control.Concurrent.Chan.html#loc_127_1_127_8" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.Chan.html#loc_127_1_127_8&#39;)"><span class="mpre">dupChan</span></a><span class="mpre">, </span><a href="Control.Concurrent.Chan.html#loc_103_1_103_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.Chan.html#loc_103_1_103_9&#39;)"><span class="mpre">readChan</span></a><span class="mpre">)
import           Control.Monad.IO.Class (</span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="mpre">liftIO</span></a><span class="mpre">)
import           Network.HTTP.Types (</span><a href="Network.HTTP.Types.Status.html#loc_193_1_193_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.HTTP.Types.Status.html#loc_193_1_193_10&#39;)"><span class="mpre">status200</span></a><span class="mpre">)
import           Network.Wai (Application, </span><a href="Network.Wai.Internal.html#loc_74_6_74_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Internal.html#loc_74_6_74_14&#39;)"><span class="mpre">Response</span></a><span class="mpre">, </span><a href="Network.Wai.html#loc_158_1_158_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.html#loc_158_1_158_15&#39;)"><span class="mpre">responseStream</span></a><span class="mpre">)

import Network.Wai.EventSource.EventStream

</span><span class="hl_comment"><span class="mpre">-- | Make a new WAI EventSource application reading events from</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the given channel.</span></span><span class="mpre">
</span><a href="#loc_23_1_23_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_23_1_23_19&#39;)"><span class="mpre">eventSourceAppChan</span></a><span class="mpre"> :: </span><a href="Control.Concurrent.Chan.html#loc_51_6_51_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.Chan.html#loc_51_6_51_10&#39;)"><span class="hl_tyconref"><span class="mpre">Chan</span></span></a><span class="mpre"> </span><a href="Network.Wai.EventSource.EventStream.html#loc_21_6_21_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.EventSource.EventStream.html#loc_21_6_21_17&#39;)"><span class="hl_tyconref"><span class="mpre">ServerEvent</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Application</span></span><span class="mpre">
</span><a name="loc_23_1_23_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_23_1_23_19&#39;)"><span class="hl_fundecl"><span class="mpre">eventSourceAppChan</span></span></a><span class="mpre"> </span><a name="loc_23_20_23_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_23_20_23_24&#39;)"><span class="hl_vardecl"><span class="mpre">chan</span></span></a><span class="mpre"> </span><a name="loc_23_25_23_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_23_25_23_28&#39;)"><span class="hl_vardecl"><span class="mpre">req</span></span></a><span class="mpre"> </span><a name="loc_23_29_23_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_23_29_23_41&#39;)"><span class="hl_vardecl"><span class="mpre">sendResponse</span></span></a><span class="mpre"> = do
    </span><a name="loc_24_5_24_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_24_5_24_10&#39;)"><span class="hl_vardecl"><span class="mpre">chan&#39;</span></span></a><span class="mpre"> &lt;- </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Control.Concurrent.Chan.html#loc_127_1_127_8" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.Chan.html#loc_127_1_127_8&#39;)"><span class="hl_varref"><span class="mpre">dupChan</span></span></a><span class="mpre"> </span><a href="#loc_23_20_23_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_23_20_23_24&#39;)"><span class="hl_varref"><span class="mpre">chan</span></span></a><span class="mpre">
    </span><a href="#loc_30_1_30_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_1_30_17&#39;)"><span class="hl_varref"><span class="mpre">eventSourceAppIO</span></span></a><span class="mpre"> (</span><a href="Control.Concurrent.Chan.html#loc_103_1_103_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.Chan.html#loc_103_1_103_9&#39;)"><span class="hl_varref"><span class="mpre">readChan</span></span></a><span class="mpre"> </span><a href="#loc_24_5_24_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_24_5_24_10&#39;)"><span class="hl_varref"><span class="mpre">chan&#39;</span></span></a><span class="mpre">) </span><a href="#loc_23_25_23_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_23_25_23_28&#39;)"><span class="hl_varref"><span class="mpre">req</span></span></a><span class="mpre"> </span><a href="#loc_23_29_23_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_23_29_23_41&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Make a new WAI EventSource application reading events from</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the given IO action.</span></span><span class="mpre">
</span><a href="#loc_30_1_30_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_1_30_17&#39;)"><span class="mpre">eventSourceAppIO</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Network.Wai.EventSource.EventStream.html#loc_21_6_21_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.EventSource.EventStream.html#loc_21_6_21_17&#39;)"><span class="hl_tyconref"><span class="mpre">ServerEvent</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Application</span></span><span class="mpre">
</span><a name="loc_30_1_30_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_1_30_17&#39;)"><span class="hl_fundecl"><span class="mpre">eventSourceAppIO</span></span></a><span class="mpre"> </span><a name="loc_30_18_30_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_18_30_21&#39;)"><span class="hl_vardecl"><span class="mpre">src</span></span></a><span class="mpre"> _ </span><a name="loc_30_24_30_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_24_30_36&#39;)"><span class="hl_vardecl"><span class="mpre">sendResponse</span></span></a><span class="mpre"> =
    </span><a href="#loc_30_24_30_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_24_30_36&#39;)"><span class="hl_varref"><span class="mpre">sendResponse</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.Wai.html#loc_158_1_158_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.html#loc_158_1_158_15&#39;)"><span class="hl_varref"><span class="mpre">responseStream</span></span></a><span class="mpre">
        </span><a href="Network.HTTP.Types.Status.html#loc_193_1_193_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.HTTP.Types.Status.html#loc_193_1_193_10&#39;)"><span class="hl_varref"><span class="mpre">status200</span></span></a><span class="mpre">
        [(</span><span class="hl_string"><span class="mpre">&quot;Content-Type&quot;</span></span><span class="mpre">, </span><span class="hl_string"><span class="mpre">&quot;text/event-stream&quot;</span></span><span class="mpre">)]
        </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_34_12_34_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_34_12_34_21&#39;)"><span class="hl_vardecl"><span class="mpre">sendChunk</span></span></a><span class="mpre"> </span><a name="loc_34_22_34_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_34_22_34_27&#39;)"><span class="hl_vardecl"><span class="mpre">flush</span></span></a><span class="mpre"> -&gt; </span><a href="Data.Function.html#loc_32_1_32_4" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Function.html#loc_32_1_32_4&#39;)"><span class="hl_varref"><span class="mpre">fix</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_34_38_34_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_34_38_34_42&#39;)"><span class="hl_vardecl"><span class="mpre">loop</span></span></a><span class="mpre"> -&gt; do
            </span><a name="loc_35_13_35_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_13_35_15&#39;)"><span class="hl_vardecl"><span class="mpre">se</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_30_18_30_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_30_18_30_21&#39;)"><span class="hl_varref"><span class="mpre">src</span></span></a><span class="mpre">
            case </span><a href="Network.Wai.EventSource.EventStream.html#loc_66_1_66_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.EventSource.EventStream.html#loc_66_1_66_15&#39;)"><span class="hl_varref"><span class="mpre">eventToBuilder</span></span></a><span class="mpre"> </span><a href="#loc_35_13_35_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_13_35_15&#39;)"><span class="hl_varref"><span class="mpre">se</span></span></a><span class="mpre"> of
                </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
                </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_38_22_38_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_22_38_23&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre">  -&gt; </span><a href="#loc_34_12_34_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_34_12_34_21&#39;)"><span class="hl_varref"><span class="mpre">sendChunk</span></span></a><span class="mpre"> </span><a href="#loc_38_22_38_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_22_38_23&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><a href="#loc_34_22_34_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_34_22_34_27&#39;)"><span class="hl_varref"><span class="mpre">flush</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;</span></span><span class="mpre"> </span><a href="#loc_34_38_34_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_34_38_34_42&#39;)"><span class="hl_varref"><span class="mpre">loop</span></span></a><span class="mpre">
</span></div></body></html>