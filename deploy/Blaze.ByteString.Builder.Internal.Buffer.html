<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE CPP, BangPatterns, Rank2Types #-}

#ifdef USE_MONO_PAT_BINDS
{-# LANGUAGE MonoPatBinds #-}
#endif

</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : Blaze.ByteString.Builder.Internal.Buffer</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   : (c) 2010 Simon Meier</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD3-style (see LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Simon Meier &lt;iridcode@gmail.com&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : tested on GHC only</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Execution of the &#39;Put&#39; monad and hence also &#39;Builder&#39;s with respect to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- buffers.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Blaze.ByteString.Builder.Internal.Buffer (
  </span><span class="hl_comment"><span class="mpre">-- * Buffers</span></span><span class="mpre">
    Buffer (..)

  </span><span class="hl_comment"><span class="mpre">-- ** Status information</span></span><span class="mpre">
  , freeSize
  , sliceSize
  , bufferSize

  </span><span class="hl_comment"><span class="mpre">-- ** Creation and modification</span></span><span class="mpre">
  , allocBuffer
  , reuseBuffer
  , nextSlice
  , updateEndOfSlice
  , execBuildStep

  </span><span class="hl_comment"><span class="mpre">-- ** Conversion to bytestings</span></span><span class="mpre">
  , unsafeFreezeBuffer
  , unsafeFreezeNonEmptyBuffer

  </span><span class="hl_comment"><span class="mpre">-- * Buffer allocation strategies</span></span><span class="mpre">
  , BufferAllocStrategy
  , allNewBuffersStrategy
  , reuseBufferStrategy

  </span><span class="hl_comment"><span class="mpre">-- * Executing puts respect to some monad</span></span><span class="mpre">
  , runPut
  ) where

#ifdef HAS_FOREIGN_UNSAFE_MODULE
import Foreign                   (Word8, ForeignPtr, Ptr, plusPtr, minusPtr)
import Foreign.ForeignPtr.Unsafe (unsafeForeignPtrToPtr)
#else
import Foreign                   (unsafeForeignPtrToPtr, Word8, ForeignPtr, Ptr, plusPtr, minusPtr)
#endif

import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/Internal/Buffer.hs&quot;, srcSpanStartLine = 55, srcSpanStartColumn = 18, srcSpanEndLine = 55, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre">      as S

#ifdef BYTESTRING_IN_BASE
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/Internal/Buffer.hs&quot;, srcSpanStartLine = 58, srcSpanStartColumn = 18, srcSpanEndLine = 58, srcSpanEndColumn = 38}, srcInfoPoints = []}) &quot;Data.ByteString.Base&quot;"><span class="mpre">Data.ByteString.Base</span></span><span class="mpre"> as S
#else
import qualified Data.ByteString.Internal as S
#endif

import Blaze.ByteString.Builder.Internal.Types
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Buffers</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A buffer @Buffer fpbuf p0 op ope@ describes a buffer with the underlying</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- byte array @fpbuf..ope@, the currently written slice @p0..op@ and the free</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- space @op..ope@.</span></span><span class="mpre">
data </span><a name="loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tycondecl"><span class="mpre">Buffer</span></span></a><span class="mpre"> = </span><a name="loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_condecl"><span class="mpre">Buffer</span></span></a><span class="mpre"> {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">ForeignPtr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">) </span><span class="hl_comment"><span class="mpre">-- underlying pinned array</span></span><span class="mpre">
                     {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)        </span><span class="hl_comment"><span class="mpre">-- beginning of slice</span></span><span class="mpre">
                     {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)        </span><span class="hl_comment"><span class="mpre">-- next free byte</span></span><span class="mpre">
                     {-# UNPACK #-} !(</span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">)        </span><span class="hl_comment"><span class="mpre">-- first byte after buffer</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The size of the free space of the buffer.</span></span><span class="mpre">
</span><a href="#loc_78_1_78_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_1_78_9&#39;)"><span class="mpre">freeSize</span></a><span class="mpre"> :: </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_78_1_78_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_1_78_9&#39;)"><span class="hl_fundecl"><span class="mpre">freeSize</span></span></a><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> _ _ </span><a name="loc_78_22_78_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_22_78_24&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_78_25_78_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_25_78_28&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">) = </span><a href="#loc_78_25_78_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_25_78_28&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_78_22_78_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_22_78_24&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The size of the written slice in the buffer.</span></span><span class="mpre">
</span><a href="#loc_82_1_82_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_10&#39;)"><span class="mpre">sliceSize</span></a><span class="mpre"> :: </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_82_1_82_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_10&#39;)"><span class="hl_fundecl"><span class="mpre">sliceSize</span></span></a><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> _ </span><a name="loc_82_21_82_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_21_82_23&#39;)"><span class="hl_vardecl"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a name="loc_82_24_82_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_24_82_26&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _) = </span><a href="#loc_82_24_82_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_24_82_26&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_82_21_82_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_21_82_23&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The size of the whole byte array underlying the buffer.</span></span><span class="mpre">
</span><a href="#loc_86_1_86_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_1_86_11&#39;)"><span class="mpre">bufferSize</span></a><span class="mpre"> :: </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">
</span><a name="loc_86_1_86_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_1_86_11&#39;)"><span class="hl_fundecl"><span class="mpre">bufferSize</span></span></a><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_86_20_86_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_20_86_25&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> _ _ </span><a name="loc_86_30_86_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_30_86_33&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">) =
    </span><a href="#loc_86_30_86_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_30_86_33&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_86_20_86_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_20_86_25&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | @allocBuffer size@ allocates a new buffer of size @size@.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_92_1_92_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_1_92_12&#39;)"><span class="mpre">allocBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_92_1_92_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_1_92_12&#39;)"><span class="mpre">allocBuffer</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">
</span><a name="loc_92_1_92_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_1_92_12&#39;)"><span class="hl_fundecl"><span class="mpre">allocBuffer</span></span></a><span class="mpre"> </span><a name="loc_92_13_92_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_13_92_17&#39;)"><span class="hl_vardecl"><span class="mpre">size</span></span></a><span class="mpre"> = do
    </span><a name="loc_93_5_93_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_5_93_10&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> &lt;- </span><a href="Data.ByteString.Internal.html#loc_489_1_489_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_489_1_489_17&#39;)"><span class="hl_varref"><span class="mpre">S.mallocByteString</span></span></a><span class="mpre"> </span><a href="#loc_92_13_92_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_13_92_17&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">
    let !</span><a name="loc_94_10_94_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_10_94_14&#39;)"><span class="hl_vardecl"><span class="mpre">pbuf</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_93_5_93_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_5_93_10&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_93_5_93_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_93_5_93_10&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a href="#loc_94_10_94_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_10_94_14&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre"> </span><a href="#loc_94_10_94_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_10_94_14&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre"> (</span><a href="#loc_94_10_94_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_10_94_14&#39;)"><span class="hl_varref"><span class="mpre">pbuf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_92_13_92_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_13_92_17&#39;)"><span class="hl_varref"><span class="mpre">size</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Resets the beginning of the next slice and the next free byte such that</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the whole buffer can be filled again.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_101_1_101_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_1_101_12&#39;)"><span class="mpre">reuseBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_101_1_101_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_1_101_12&#39;)"><span class="mpre">reuseBuffer</span></a><span class="mpre"> :: </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">
</span><a name="loc_101_1_101_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_1_101_12&#39;)"><span class="hl_fundecl"><span class="mpre">reuseBuffer</span></span></a><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_101_21_101_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_21_101_26&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> _ _ </span><a name="loc_101_31_101_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_31_101_34&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">) = </span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_101_21_101_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_21_101_26&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a href="#loc_103_5_103_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_5_103_7&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a href="#loc_103_5_103_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_5_103_7&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a href="#loc_101_31_101_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_31_101_34&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">
  where
    </span><a name="loc_103_5_103_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_5_103_7&#39;)"><span class="hl_vardecl"><span class="mpre">p0</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_101_21_101_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_21_101_26&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Convert the buffer to a bytestring. This operation is unsafe in the sense</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- that created bytestring shares the underlying byte array with the buffer.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Hence, depending on the later use of this buffer (e.g., if it gets reset and</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- filled again) referential transparency may be lost.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_111_1_111_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_1_111_19&#39;)"><span class="mpre">unsafeFreezeBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_111_1_111_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_1_111_19&#39;)"><span class="mpre">unsafeFreezeBuffer</span></a><span class="mpre"> :: </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
</span><a name="loc_111_1_111_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_1_111_19&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeFreezeBuffer</span></span></a><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_111_28_111_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_28_111_33&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a name="loc_111_34_111_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_34_111_36&#39;)"><span class="hl_vardecl"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a name="loc_111_37_111_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_37_111_39&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _) =
    </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a href="#loc_111_28_111_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_28_111_33&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> (</span><a href="#loc_111_34_111_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_34_111_36&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span><span class="mpre"> </span><a href="#loc_111_28_111_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_28_111_33&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre">) (</span><a href="#loc_111_37_111_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_37_111_39&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_111_34_111_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_34_111_36&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Convert a buffer to a non-empty bytestring. See &#39;unsafeFreezeBuffer&#39; for</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the explanation of why this operation may be unsafe.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_118_1_118_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_1_118_27&#39;)"><span class="mpre">unsafeFreezeNonEmptyBuffer</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_118_1_118_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_1_118_27&#39;)"><span class="mpre">unsafeFreezeNonEmptyBuffer</span></a><span class="mpre"> :: </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
</span><a name="loc_118_1_118_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_1_118_27&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeFreezeNonEmptyBuffer</span></span></a><span class="mpre"> </span><a name="loc_118_28_118_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_28_118_31&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre">
  | </span><a href="#loc_82_1_82_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_10&#39;)"><span class="hl_varref"><span class="mpre">sliceSize</span></span></a><span class="mpre"> </span><a href="#loc_118_28_118_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_28_118_31&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> = </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">          = </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_111_1_111_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_1_111_19&#39;)"><span class="hl_varref"><span class="mpre">unsafeFreezeBuffer</span></span></a><span class="mpre"> </span><a href="#loc_118_28_118_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_28_118_31&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Update the end of slice pointer.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_127_1_127_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_17&#39;)"><span class="mpre">updateEndOfSlice</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_127_1_127_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_17&#39;)"><span class="mpre">updateEndOfSlice</span></a><span class="mpre"> :: </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">    </span><span class="hl_comment"><span class="mpre">-- Old buffer</span></span><span class="mpre">
                 -&gt; </span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- New end of slice</span></span><span class="mpre">
                 -&gt; </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">    </span><span class="hl_comment"><span class="mpre">-- Updated buffer</span></span><span class="mpre">
</span><a name="loc_127_1_127_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_17&#39;)"><span class="hl_fundecl"><span class="mpre">updateEndOfSlice</span></span></a><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_127_26_127_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_26_127_31&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a name="loc_127_32_127_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_32_127_34&#39;)"><span class="hl_vardecl"><span class="mpre">p0</span></span></a><span class="mpre"> _ </span><a name="loc_127_37_127_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_37_127_40&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">) </span><a name="loc_127_42_127_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_42_127_45&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_127_26_127_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_26_127_31&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a href="#loc_127_32_127_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_32_127_34&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a href="#loc_127_42_127_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_42_127_45&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a href="#loc_127_37_127_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_37_127_40&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Execute a build step on the given buffer.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_134_1_134_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_1_134_14&#39;)"><span class="mpre">execBuildStep</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_134_1_134_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_1_134_14&#39;)"><span class="mpre">execBuildStep</span></a><span class="mpre"> :: </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_48_9_48_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_48_9_48_18&#39;)"><span class="hl_tyconref"><span class="mpre">BuildStep</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
              -&gt; </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">
              -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_37_6_37_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_37_6_37_17&#39;)"><span class="hl_tyconref"><span class="mpre">BuildSignal</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
</span><a name="loc_134_1_134_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_1_134_14&#39;)"><span class="hl_fundecl"><span class="mpre">execBuildStep</span></span></a><span class="mpre"> </span><a name="loc_134_15_134_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_15_134_19&#39;)"><span class="hl_vardecl"><span class="mpre">step</span></span></a><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> _ _ </span><a name="loc_134_32_134_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_32_134_34&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_134_35_134_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_35_134_38&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">) = </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29&#39;)"><span class="hl_varref"><span class="mpre">runBuildStep</span></span></a><span class="mpre"> </span><a href="#loc_134_15_134_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_15_134_19&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> </span><a href="#loc_134_32_134_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_32_134_34&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_134_35_134_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_134_35_134_38&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Move the beginning of the slice to the next free byte such that the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- remaining free space of the buffer can be filled further. This operation</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- is safe and can be used to fill the remaining part of the buffer after a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- direct insertion of a bytestring or a flush.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_142_1_142_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_1_142_10&#39;)"><span class="mpre">nextSlice</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_142_1_142_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_1_142_10&#39;)"><span class="mpre">nextSlice</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">
</span><a name="loc_142_1_142_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_1_142_10&#39;)"><span class="hl_fundecl"><span class="mpre">nextSlice</span></span></a><span class="mpre"> </span><a name="loc_142_11_142_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_11_142_18&#39;)"><span class="hl_vardecl"><span class="mpre">minSize</span></span></a><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_142_27_142_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_27_142_32&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> _ </span><a name="loc_142_35_142_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_35_142_37&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_142_38_142_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_38_142_41&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">)
  | </span><a href="#loc_142_38_142_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_38_142_41&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_142_35_142_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_35_142_37&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_142_11_142_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_11_142_18&#39;)"><span class="hl_varref"><span class="mpre">minSize</span></span></a><span class="mpre"> = </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
  | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                    = </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_142_27_142_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_27_142_32&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a href="#loc_142_35_142_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_35_142_37&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_142_35_142_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_35_142_37&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_142_38_142_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_38_142_41&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Buffer allocation strategies</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A buffer allocation strategy @(buf0, nextBuf)@ specifies the initial</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- buffer to use and how to compute a new buffer @nextBuf minSize buf@ with at</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- least size @minSize@ from a filled buffer @buf@. The double nesting of the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @IO@ monad helps to ensure that the reference to the filled buffer @buf@ is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- lost as soon as possible, but the new buffer doesn&#39;t have to be allocated</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- too early.</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/Internal/Buffer.hs&quot;, srcSpanStartLine = 156, srcSpanStartColumn = 1, srcSpanEndLine = 156, srcSpanEndColumn = 72}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/Internal/Buffer.hs&quot;, srcSpanStartLine = 156, srcSpanStartColumn = 1, srcSpanEndLine = 156, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemn"><span class="mpre">type BufferAllocStrategy = (IO Buffer, Int -&gt; Buffer -&gt; IO (IO Buffer))</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The simplest buffer allocation strategy: whenever a buffer is requested,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- allocate a new one that is big enough for the next build step to execute.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- NOTE that this allocation strategy may spill quite some memory upon direct</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- insertion of a bytestring by the builder. Thats no problem for garbage</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- collection, but it may lead to unreasonably high memory consumption in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- special circumstances.</span></span><span class="mpre">
</span><a href="#loc_167_1_167_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_1_167_22&#39;)"><span class="mpre">allNewBuffersStrategy</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">                 </span><span class="hl_comment"><span class="mpre">-- Minimal buffer size.</span></span><span class="mpre">
                      -&gt; </span><span class="hl_tyconref"><span class="mpre">BufferAllocStrategy</span></span><span class="mpre">
</span><a name="loc_167_1_167_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_1_167_22&#39;)"><span class="hl_fundecl"><span class="mpre">allNewBuffersStrategy</span></span></a><span class="mpre"> </span><a name="loc_167_23_167_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_23_167_30&#39;)"><span class="hl_vardecl"><span class="mpre">bufSize</span></span></a><span class="mpre"> =
    ( </span><a href="#loc_92_1_92_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_1_92_12&#39;)"><span class="hl_varref"><span class="mpre">allocBuffer</span></span></a><span class="mpre"> </span><a href="#loc_167_23_167_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_23_167_30&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre">
    , \</span><a name="loc_169_8_169_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_8_169_15&#39;)"><span class="hl_vardecl"><span class="mpre">reqSize</span></span></a><span class="mpre"> _ -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_92_1_92_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_1_92_12&#39;)"><span class="hl_varref"><span class="mpre">allocBuffer</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">max</span></span><span class="mpre"> </span><a href="#loc_169_8_169_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_169_8_169_15&#39;)"><span class="hl_varref"><span class="mpre">reqSize</span></span></a><span class="mpre"> </span><a href="#loc_167_23_167_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_23_167_30&#39;)"><span class="hl_varref"><span class="mpre">bufSize</span></span></a><span class="mpre">)) )

</span><span class="hl_comment"><span class="mpre">-- | An unsafe, but possibly more efficient buffer allocation strategy:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- reuse the buffer, if it is big enough for the next build step to execute.</span></span><span class="mpre">
</span><a href="#loc_175_1_175_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_1_175_20&#39;)"><span class="mpre">reuseBufferStrategy</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">
                    -&gt; </span><span class="hl_tyconref"><span class="mpre">BufferAllocStrategy</span></span><span class="mpre">
</span><a name="loc_175_1_175_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_1_175_20&#39;)"><span class="hl_fundecl"><span class="mpre">reuseBufferStrategy</span></span></a><span class="mpre"> </span><a name="loc_175_21_175_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_21_175_25&#39;)"><span class="hl_vardecl"><span class="mpre">buf0</span></span></a><span class="mpre"> =
    (</span><a href="#loc_175_21_175_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_21_175_25&#39;)"><span class="hl_varref"><span class="mpre">buf0</span></span></a><span class="mpre">, </span><a href="#loc_178_5_178_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_5_178_19&#39;)"><span class="hl_varref"><span class="mpre">tryReuseBuffer</span></span></a><span class="mpre">)
  where
    </span><a name="loc_178_5_178_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_5_178_19&#39;)"><span class="hl_fundecl"><span class="mpre">tryReuseBuffer</span></span></a><span class="mpre"> </span><a name="loc_178_20_178_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_20_178_27&#39;)"><span class="hl_vardecl"><span class="mpre">reqSize</span></span></a><span class="mpre"> </span><a name="loc_178_28_178_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_28_178_31&#39;)"><span class="hl_vardecl"><span class="mpre">buf</span></span></a><span class="mpre">
      | </span><a href="#loc_86_1_86_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_1_86_11&#39;)"><span class="hl_varref"><span class="mpre">bufferSize</span></span></a><span class="mpre"> </span><a href="#loc_178_28_178_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_28_178_31&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;=</span></span><span class="mpre"> </span><a href="#loc_178_20_178_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_20_178_27&#39;)"><span class="hl_varref"><span class="mpre">reqSize</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_101_1_101_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_1_101_12&#39;)"><span class="hl_varref"><span class="mpre">reuseBuffer</span></span></a><span class="mpre"> </span><a href="#loc_178_28_178_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_28_178_31&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">)
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                 = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_92_1_92_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_1_92_12&#39;)"><span class="hl_varref"><span class="mpre">allocBuffer</span></span></a><span class="mpre"> </span><a href="#loc_178_20_178_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_178_20_178_27&#39;)"><span class="hl_varref"><span class="mpre">reqSize</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Executing puts on a buffer</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | Execute a put on a buffer.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- TODO: Generalize over buffer allocation strategy.</span></span><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_198_1_198_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_1_198_7&#39;)"><span class="mpre">runPut</span></a><span class="mpre"> #-}</span></span><span class="mpre">
</span><a href="#loc_198_1_198_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_1_198_7&#39;)"><span class="mpre">runPut</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/Internal/Buffer.hs&quot;, srcSpanStartLine = 191, srcSpanStartColumn = 11, srcSpanEndLine = 192, srcSpanEndColumn = 10}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/Internal/Buffer.hs&quot;, srcSpanStartLine = 192, srcSpanStartColumn = 8, srcSpanEndLine = 192, srcSpanEndColumn = 10}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSp"><span class="mpre">Monad m
       =&gt;</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_37_6_37_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_37_6_37_17&#39;)"><span class="hl_tyconref"><span class="mpre">BuildSignal</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_37_6_37_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_37_6_37_17&#39;)"><span class="hl_tyconref"><span class="mpre">BuildSignal</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)) </span><span class="hl_comment"><span class="mpre">-- lifting of buildsteps</span></span><span class="mpre">
       -&gt; (</span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">) </span><span class="hl_comment"><span class="mpre">-- output function for a guaranteedly non-empty buffer, the returned buffer will be filled next</span></span><span class="mpre">
       -&gt; (</span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">)    </span><span class="hl_comment"><span class="mpre">-- output function for guaranteedly non-empty bytestrings, that are inserted directly into the stream</span></span><span class="mpre">
       -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_81_9_81_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_81_9_81_12&#39;)"><span class="hl_tyconref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">                     </span><span class="hl_comment"><span class="mpre">-- put to execute</span></span><span class="mpre">
       -&gt; </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">                    </span><span class="hl_comment"><span class="mpre">-- initial buffer to be used</span></span><span class="mpre">
       -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> (</span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">, </span><a href="#loc_71_6_71_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_6_71_12&#39;)"><span class="hl_tyconref"><span class="mpre">Buffer</span></span></a><span class="mpre">)             </span><span class="hl_comment"><span class="mpre">-- result of put and remaining buffer</span></span><span class="mpre">
</span><a name="loc_198_1_198_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_1_198_7&#39;)"><span class="hl_fundecl"><span class="mpre">runPut</span></span></a><span class="mpre"> </span><a name="loc_198_8_198_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_8_198_14&#39;)"><span class="hl_vardecl"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><a name="loc_198_15_198_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_15_198_24&#39;)"><span class="hl_vardecl"><span class="mpre">outputBuf</span></span></a><span class="mpre"> </span><a name="loc_198_25_198_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_25_198_33&#39;)"><span class="hl_vardecl"><span class="mpre">outputBS</span></span></a><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_81_17_81_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_81_17_81_20&#39;)"><span class="hl_conref"><span class="mpre">Put</span></span></a><span class="mpre"> </span><a name="loc_198_39_198_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_39_198_42&#39;)"><span class="hl_vardecl"><span class="mpre">put</span></span></a><span class="mpre">) =
    </span><a href="#loc_203_5_203_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_5_203_12&#39;)"><span class="hl_varref"><span class="mpre">runStep</span></span></a><span class="mpre"> (</span><a href="#loc_198_39_198_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_39_198_42&#39;)"><span class="hl_varref"><span class="mpre">put</span></span></a><span class="mpre"> (</span><a href="#loc_201_5_201_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_5_201_14&#39;)"><span class="hl_varref"><span class="mpre">finalStep</span></span></a><span class="mpre">))
  where
    </span><a name="loc_201_5_201_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_5_201_14&#39;)"><span class="hl_fundecl"><span class="mpre">finalStep</span></span></a><span class="mpre"> </span><a name="loc_201_15_201_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_15_201_16&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> = </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_63_1_63_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_63_1_63_10&#39;)"><span class="hl_varref"><span class="mpre">buildStep</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \(</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> </span><a name="loc_201_42_201_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_42_201_44&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _) -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a href="#loc_201_42_201_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_42_201_44&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_201_15_201_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_201_15_201_16&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">

    </span><a name="loc_203_5_203_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_5_203_12&#39;)"><span class="hl_fundecl"><span class="mpre">runStep</span></span></a><span class="mpre"> </span><a name="loc_203_13_203_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_13_203_17&#39;)"><span class="hl_vardecl"><span class="mpre">step</span></span></a><span class="mpre"> </span><a name="loc_203_18_203_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_18_203_21&#39;)"><span class="hl_specname"><span class="mpre">buf</span></span></a><span class="mpre">@(</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a name="loc_203_30_203_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_30_203_35&#39;)"><span class="hl_vardecl"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a name="loc_203_36_203_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_36_203_38&#39;)"><span class="hl_vardecl"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a name="loc_203_39_203_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_39_203_41&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_203_42_203_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_42_203_45&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">) = do
        let !</span><a name="loc_204_14_204_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_14_204_16&#39;)"><span class="hl_vardecl"><span class="mpre">br</span></span></a><span class="mpre"> = </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_17_35_25&#39;)"><span class="hl_conref"><span class="mpre">BufRange</span></span></a><span class="mpre"> </span><a href="#loc_203_39_203_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_39_203_41&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_203_42_203_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_42_203_45&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">
        </span><a name="loc_205_9_205_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_9_205_15&#39;)"><span class="hl_vardecl"><span class="mpre">signal</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_198_8_198_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_8_198_14&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_49_17_49_29&#39;)"><span class="hl_varref"><span class="mpre">runBuildStep</span></span></a><span class="mpre"> </span><a href="#loc_203_13_203_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_13_203_17&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_204_14_204_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_14_204_16&#39;)"><span class="hl_varref"><span class="mpre">br</span></span></a><span class="mpre">
        case </span><a href="#loc_205_9_205_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_205_9_205_15&#39;)"><span class="hl_varref"><span class="mpre">signal</span></span></a><span class="mpre"> of
            </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_38_5_38_9&#39;)"><span class="hl_conref"><span class="mpre">Done</span></span></a><span class="mpre"> </span><a name="loc_207_18_207_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_207_18_207_21&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_207_22_207_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_207_22_207_23&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> -&gt;         </span><span class="hl_comment"><span class="mpre">-- put completed, buffer partially runSteped</span></span><span class="mpre">
                </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_207_22_207_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_207_22_207_23&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">, </span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_203_30_203_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_30_203_35&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a href="#loc_203_36_203_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_36_203_38&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a href="#loc_207_18_207_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_207_18_207_21&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a href="#loc_203_42_203_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_42_203_45&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">)

            </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_39_5_39_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_39_5_39_15&#39;)"><span class="hl_conref"><span class="mpre">BufferFull</span></span></a><span class="mpre"> </span><a name="loc_210_24_210_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_24_210_31&#39;)"><span class="hl_vardecl"><span class="mpre">minSize</span></span></a><span class="mpre"> </span><a name="loc_210_32_210_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_32_210_35&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_210_36_210_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_36_210_44&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre"> -&gt; do
                </span><a name="loc_211_17_211_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_17_211_21&#39;)"><span class="hl_vardecl"><span class="mpre">buf&#39;</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_198_15_198_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_15_198_24&#39;)"><span class="hl_varref"><span class="mpre">outputBuf</span></span></a><span class="mpre"> </span><a href="#loc_210_24_210_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_24_210_31&#39;)"><span class="hl_varref"><span class="mpre">minSize</span></span></a><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_203_30_203_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_30_203_35&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a href="#loc_203_36_203_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_36_203_38&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a href="#loc_210_32_210_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_32_210_35&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a href="#loc_203_42_203_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_42_203_45&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">)
                </span><a href="#loc_203_5_203_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_5_203_12&#39;)"><span class="hl_varref"><span class="mpre">runStep</span></span></a><span class="mpre"> </span><a href="#loc_210_36_210_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_210_36_210_44&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre"> </span><a href="#loc_211_17_211_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_17_211_21&#39;)"><span class="hl_varref"><span class="mpre">buf&#39;</span></span></a><span class="mpre">

            </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_43_5_43_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_43_5_43_21&#39;)"><span class="hl_conref"><span class="mpre">InsertByteString</span></span></a><span class="mpre"> </span><a name="loc_214_30_214_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_30_214_33&#39;)"><span class="hl_vardecl"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a name="loc_214_34_214_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_34_214_36&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_214_37_214_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_37_214_45&#39;)"><span class="hl_vardecl"><span class="mpre">nextStep</span></span></a><span class="mpre">
              | </span><span class="hl_varref"><span class="mpre">S.null</span></span><span class="mpre"> </span><a href="#loc_214_34_214_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_34_214_36&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> -&gt;   </span><span class="hl_comment"><span class="mpre">-- flushing of buffer required</span></span><span class="mpre">
                  </span><a href="#loc_198_15_198_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_15_198_24&#39;)"><span class="hl_varref"><span class="mpre">outputBuf</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_203_30_203_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_30_203_35&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a href="#loc_203_36_203_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_36_203_38&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a href="#loc_214_30_214_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_30_214_33&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a href="#loc_203_42_203_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_42_203_45&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_203_5_203_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_5_203_12&#39;)"><span class="hl_varref"><span class="mpre">runStep</span></span></a><span class="mpre"> </span><a href="#loc_214_37_214_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_37_214_45&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre">
              | </span><a href="#loc_203_36_203_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_36_203_38&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="#loc_214_30_214_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_30_214_33&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> -&gt; do </span><span class="hl_comment"><span class="mpre">-- no bytes written: just insert bytestring</span></span><span class="mpre">
                  </span><a href="#loc_198_25_198_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_25_198_33&#39;)"><span class="hl_varref"><span class="mpre">outputBS</span></span></a><span class="mpre"> </span><a href="#loc_214_34_214_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_34_214_36&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
                  </span><a href="#loc_203_5_203_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_5_203_12&#39;)"><span class="hl_varref"><span class="mpre">runStep</span></span></a><span class="mpre"> </span><a href="#loc_214_37_214_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_37_214_45&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre"> </span><a href="#loc_203_18_203_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_18_203_21&#39;)"><span class="hl_varref"><span class="mpre">buf</span></span></a><span class="mpre">
              | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> -&gt; do   </span><span class="hl_comment"><span class="mpre">-- bytes written, insert buffer and bytestring</span></span><span class="mpre">
                  </span><a name="loc_221_19_221_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_19_221_23&#39;)"><span class="hl_vardecl"><span class="mpre">buf&#39;</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_198_15_198_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_15_198_24&#39;)"><span class="hl_varref"><span class="mpre">outputBuf</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> (</span><a href="#loc_71_15_71_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_71_15_71_21&#39;)"><span class="hl_conref"><span class="mpre">Buffer</span></span></a><span class="mpre"> </span><a href="#loc_203_30_203_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_30_203_35&#39;)"><span class="hl_varref"><span class="mpre">fpbuf</span></span></a><span class="mpre"> </span><a href="#loc_203_36_203_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_36_203_38&#39;)"><span class="hl_varref"><span class="mpre">p0</span></span></a><span class="mpre"> </span><a href="#loc_214_30_214_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_30_214_33&#39;)"><span class="hl_varref"><span class="mpre">op&#39;</span></span></a><span class="mpre"> </span><a href="#loc_203_42_203_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_42_203_45&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">)
                  </span><a href="#loc_198_25_198_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_198_25_198_33&#39;)"><span class="hl_varref"><span class="mpre">outputBS</span></span></a><span class="mpre"> </span><a href="#loc_214_34_214_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_34_214_36&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
                  </span><a href="#loc_203_5_203_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_5_203_12&#39;)"><span class="hl_varref"><span class="mpre">runStep</span></span></a><span class="mpre"> </span><a href="#loc_214_37_214_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_37_214_45&#39;)"><span class="hl_varref"><span class="mpre">nextStep</span></span></a><span class="mpre"> </span><a href="#loc_221_19_221_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_221_19_221_23&#39;)"><span class="hl_varref"><span class="mpre">buf&#39;</span></span></a><span class="mpre">
</span></div></body></html>