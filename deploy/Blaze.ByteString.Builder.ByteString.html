<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE CPP, BangPatterns, OverloadedStrings #-}

#ifdef USE_MONO_PAT_BINDS
{-# LANGUAGE MonoPatBinds #-}
#endif

{-# OPTIONS_GHC -fno-warn-unused-imports #-}

</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : Blaze.ByteString.Builder.ByteString</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   : (c) 2010 Jasper Van der Jeugt &amp; Simon Meier</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD3-style (see LICENSE)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Simon Meier &lt;iridcode@gmail.com&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : tested on GHC only</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;Write&#39;s and &#39;Builder&#39;s for strict and lazy bytestrings.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- We assume the following qualified imports in order to differentiate between</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- strict and lazy bytestrings in the code examples.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; import qualified Data.ByteString      as S</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; import qualified Data.ByteString.Lazy as L</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Blaze.ByteString.Builder.ByteString
    (
    </span><span class="hl_comment"><span class="mpre">-- * Strict bytestrings</span></span><span class="mpre">
      writeByteString
    , fromByteString
    , fromByteStringWith
    , copyByteString
    , insertByteString

    </span><span class="hl_comment"><span class="mpre">-- * Lazy bytestrings</span></span><span class="mpre">
    , fromLazyByteString
    , fromLazyByteStringWith
    , copyLazyByteString
    , insertLazyByteString

    ) where

import           Blaze.ByteString.Builder.Internal hiding (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_60_1_60_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_60_1_60_17&#39;)"><span class="mpre">insertByteString</span></a><span class="mpre">)
import qualified Blaze.ByteString.Builder.Internal as I   (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_60_1_60_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_60_1_60_17&#39;)"><span class="mpre">insertByteString</span></a><span class="mpre">)

#ifdef HAS_FOREIGN_UNSAFE_MODULE
import Foreign                   (withForeignPtr, touchForeignPtr, </span><a href="Foreign.Marshal.Utils.html#loc_154_1_154_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_154_1_154_10&#39;)"><span class="mpre">copyBytes</span></a><span class="mpre">, plusPtr, minusPtr)
import Foreign.ForeignPtr.Unsafe (</span><a href="GHC.ForeignPtr.html#loc_420_1_420_22" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.ForeignPtr.html#loc_420_1_420_22&#39;)"><span class="mpre">unsafeForeignPtrToPtr</span></a><span class="mpre">)
#else
import Foreign                   (unsafeForeignPtrToPtr, withForeignPtr, touchForeignPtr, </span><a href="Foreign.Marshal.Utils.html#loc_154_1_154_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_154_1_154_10&#39;)"><span class="mpre">copyBytes</span></a><span class="mpre">, plusPtr, minusPtr)
#endif

import Data.Monoid

import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/ByteString.hs&quot;, srcSpanStartLine = 55, srcSpanStartColumn = 18, srcSpanEndLine = 55, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre">      as S
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/ByteString.hs&quot;, srcSpanStartLine = 56, srcSpanStartColumn = 18, srcSpanEndLine = 56, srcSpanEndColumn = 38}, srcInfoPoints = []}) &quot;Data.ByteString.Lazy&quot;"><span class="mpre">Data.ByteString.Lazy</span></span><span class="mpre"> as L

#ifdef BYTESTRING_IN_BASE
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/ByteString.hs&quot;, srcSpanStartLine = 59, srcSpanStartColumn = 18, srcSpanEndLine = 59, srcSpanEndColumn = 38}, srcInfoPoints = []}) &quot;Data.ByteString.Base&quot;"><span class="mpre">Data.ByteString.Base</span></span><span class="mpre"> as S
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/blaze-builder-0.3.3.2/Blaze/ByteString/Builder/ByteString.hs&quot;, srcSpanStartLine = 60, srcSpanStartColumn = 18, srcSpanEndLine = 60, srcSpanEndColumn = 43}, srcInfoPoints = []}) &quot;Data.ByteString.Lazy.Base&quot;"><span class="mpre">Data.ByteString.Lazy.Base</span></span><span class="mpre"> as L </span><span class="hl_comment"><span class="mpre">-- FIXME: check if this is the right module</span></span><span class="mpre">
#else
import qualified Data.ByteString.Internal      as S
import qualified Data.ByteString.Lazy.Internal as L
#endif


</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Strict ByteStrings</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Write a strict &#39;S.ByteString&#39; to a buffer.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_74_1_74_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_1_74_16&#39;)"><span class="mpre">writeByteString</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Write.html#loc_98_6_98_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Write.html#loc_98_6_98_11&#39;)"><span class="hl_tyconref"><span class="mpre">Write</span></span></a><span class="mpre">
</span><a name="loc_74_1_74_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_1_74_16&#39;)"><span class="hl_fundecl"><span class="mpre">writeByteString</span></span></a><span class="mpre"> </span><a name="loc_74_17_74_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_17_74_19&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> = </span><a href="Blaze.ByteString.Builder.Internal.Write.html#loc_163_1_163_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Write.html#loc_163_1_163_11&#39;)"><span class="hl_varref"><span class="mpre">exactWrite</span></span></a><span class="mpre"> </span><a href="#loc_76_13_76_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_13_76_14&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre"> </span><a href="#loc_77_3_77_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_3_77_5&#39;)"><span class="hl_varref"><span class="mpre">io</span></span></a><span class="mpre">
  where
  (</span><a name="loc_76_4_76_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_4_76_8&#39;)"><span class="hl_vardecl"><span class="mpre">fptr</span></span></a><span class="mpre">, </span><a name="loc_76_10_76_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_10_76_11&#39;)"><span class="hl_vardecl"><span class="mpre">o</span></span></a><span class="mpre">, </span><a name="loc_76_13_76_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_13_76_14&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) = </span><a href="Data.ByteString.Internal.html#loc_405_1_405_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_405_1_405_13&#39;)"><span class="hl_varref"><span class="mpre">S.toForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_74_17_74_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_17_74_19&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
  </span><a name="loc_77_3_77_5" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_3_77_5&#39;)"><span class="hl_fundecl"><span class="mpre">io</span></span></a><span class="mpre"> </span><a name="loc_77_6_77_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_6_77_8&#39;)"><span class="hl_vardecl"><span class="mpre">pf</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">withForeignPtr</span></span><span class="mpre"> </span><a href="#loc_76_4_76_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_4_76_8&#39;)"><span class="hl_varref"><span class="mpre">fptr</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_77_34_77_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_34_77_35&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> -&gt; </span><a href="Foreign.Marshal.Utils.html#loc_154_1_154_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_154_1_154_10&#39;)"><span class="hl_varref"><span class="mpre">copyBytes</span></span></a><span class="mpre"> </span><a href="#loc_77_6_77_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_6_77_8&#39;)"><span class="hl_varref"><span class="mpre">pf</span></span></a><span class="mpre"> (</span><a href="#loc_77_34_77_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_77_34_77_35&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_76_10_76_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_10_76_11&#39;)"><span class="hl_varref"><span class="mpre">o</span></span></a><span class="mpre">) </span><a href="#loc_76_13_76_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_76_13_76_14&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_74_1_74_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_1_74_16&#39;)"><span class="mpre">writeByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Smart serialization of a strict bytestring.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @&#39;fromByteString&#39; = &#39;fromByteStringWith&#39; &#39;defaultMaximalCopySize&#39;@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Use this function to serialize strict bytestrings. It guarantees an</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- average chunk size of 4kb, which has been shown to be a reasonable size in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- benchmarks. Note that the check whether to copy or to insert is (almost)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- free as the builder performance is mostly memory-bound.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- If you statically know that copying or inserting the strict bytestring is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- always the best choice, then you can use the &#39;copyByteString&#39; or</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;insertByteString&#39; functions.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_94_1_94_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_1_94_15&#39;)"><span class="mpre">fromByteString</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_94_1_94_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_1_94_15&#39;)"><span class="hl_vardecl"><span class="mpre">fromByteString</span></span></a><span class="mpre"> = </span><a href="#loc_112_1_112_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_19&#39;)"><span class="hl_varref"><span class="mpre">fromByteStringWith</span></span></a><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.html#loc_112_1_112_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.html#loc_112_1_112_23&#39;)"><span class="hl_varref"><span class="mpre">defaultMaximalCopySize</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_94_1_94_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_1_94_15&#39;)"><span class="mpre">fromByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | @fromByteStringWith maximalCopySize bs@ serializes the strict bytestring</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @bs@ according to the following rules.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   [@S.length bs &lt;= maximalCopySize@:] @bs@ is copied to the output buffer.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   [@S.length bs &gt;  maximalCopySize@:] @bs@ the output buffer is flushed and</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   @bs@ is inserted directly as separate chunk in the output stream.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- These rules guarantee that average chunk size in the output stream is at</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- least half the @maximalCopySize@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_112_1_112_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_19&#39;)"><span class="mpre">fromByteStringWith</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">          </span><span class="hl_comment"><span class="mpre">-- ^ Maximal number of bytes to copy.</span></span><span class="mpre">
                   -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ Strict &#39;S.ByteString&#39; to serialize.</span></span><span class="mpre">
                   -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">      </span><span class="hl_comment"><span class="mpre">-- ^ Resulting &#39;Builder&#39;.</span></span><span class="mpre">
</span><a name="loc_112_1_112_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_19&#39;)"><span class="hl_fundecl"><span class="mpre">fromByteStringWith</span></span></a><span class="mpre"> </span><a name="loc_112_20_112_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_20_112_31&#39;)"><span class="hl_vardecl"><span class="mpre">maxCopySize</span></span></a><span class="mpre"> =
    \</span><a name="loc_113_6_113_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_6_113_8&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_124_1_124_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_124_1_124_18&#39;)"><span class="hl_varref"><span class="mpre">fromBuildStepCont</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_115_5_115_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_5_115_9&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_113_6_113_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_6_113_8&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
  where
    </span><a name="loc_115_5_115_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_5_115_9&#39;)"><span class="hl_fundecl"><span class="mpre">step</span></span></a><span class="mpre"> !</span><a name="loc_115_11_115_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_11_115_13&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> !</span><a name="loc_115_15_115_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_15_115_16&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> </span><a name="loc_115_17_115_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_17_115_19&#39;)"><span class="hl_specname"><span class="mpre">br</span></span></a><span class="mpre">@(</span><span class="hl_conref"><span class="mpre">BufRange</span></span><span class="mpre"> !</span><a name="loc_115_31_115_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_31_115_33&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _)
      | </span><a href="#loc_112_20_112_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_20_112_31&#39;)"><span class="hl_varref"><span class="mpre">maxCopySize</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">S.length</span></span><span class="mpre"> </span><a href="#loc_115_11_115_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_11_115_13&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_60_1_60_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_60_1_60_17&#39;)"><span class="hl_varref"><span class="mpre">I.insertByteString</span></span></a><span class="mpre"> </span><a href="#loc_115_31_115_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_31_115_33&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_115_11_115_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_11_115_13&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="#loc_115_15_115_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_15_115_16&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                 = </span><a href="#loc_133_1_133_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_1_133_19&#39;)"><span class="hl_varref"><span class="mpre">copyByteStringStep</span></span></a><span class="mpre"> </span><a href="#loc_115_11_115_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_11_115_13&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="#loc_115_15_115_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_15_115_16&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_115_17_115_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_115_17_115_19&#39;)"><span class="hl_varref"><span class="mpre">br</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_112_1_112_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_19&#39;)"><span class="mpre">fromByteStringWith</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | @copyByteString bs@ serialize the strict bytestring @bs@ by copying it to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the output buffer.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Use this function to serialize strict bytestrings that are statically known</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to be smallish (@&lt;= 4kb@).</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_127_1_127_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_15&#39;)"><span class="mpre">copyByteString</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_127_1_127_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_15&#39;)"><span class="hl_vardecl"><span class="mpre">copyByteString</span></span></a><span class="mpre"> = \</span><a name="loc_127_19_127_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_19_127_21&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_124_1_124_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_124_1_124_18&#39;)"><span class="hl_varref"><span class="mpre">fromBuildStepCont</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_133_1_133_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_1_133_19&#39;)"><span class="hl_varref"><span class="mpre">copyByteStringStep</span></span></a><span class="mpre"> </span><a href="#loc_127_19_127_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_19_127_21&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_127_1_127_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_15&#39;)"><span class="mpre">copyByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><a href="#loc_133_1_133_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_1_133_19&#39;)"><span class="mpre">copyByteStringStep</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre">
                   -&gt; (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_6_35_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_6_35_14&#39;)"><span class="hl_tyconref"><span class="mpre">BufRange</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_37_6_37_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_37_6_37_17&#39;)"><span class="hl_tyconref"><span class="mpre">BuildSignal</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">))
                   -&gt; (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_35_6_35_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_35_6_35_14&#39;)"><span class="hl_tyconref"><span class="mpre">BufRange</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_37_6_37_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_37_6_37_17&#39;)"><span class="hl_tyconref"><span class="mpre">BuildSignal</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">))
</span><a name="loc_133_1_133_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_1_133_19&#39;)"><span class="hl_fundecl"><span class="mpre">copyByteStringStep</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">S.PS</span></span></a><span class="mpre"> </span><a name="loc_133_26_133_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_26_133_29&#39;)"><span class="hl_vardecl"><span class="mpre">ifp</span></span></a><span class="mpre"> </span><a name="loc_133_30_133_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_30_133_34&#39;)"><span class="hl_vardecl"><span class="mpre">ioff</span></span></a><span class="mpre"> </span><a name="loc_133_35_133_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_35_133_40&#39;)"><span class="hl_vardecl"><span class="mpre">isize</span></span></a><span class="mpre">) !</span><a name="loc_133_43_133_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_43_133_44&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> =
    </span><a href="#loc_137_5_137_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_5_137_9&#39;)"><span class="hl_varref"><span class="mpre">goBS</span></span></a><span class="mpre"> (</span><a href="GHC.ForeignPtr.html#loc_420_1_420_22" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.ForeignPtr.html#loc_420_1_420_22&#39;)"><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span></a><span class="mpre"> </span><a href="#loc_133_26_133_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_26_133_29&#39;)"><span class="hl_varref"><span class="mpre">ifp</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_133_30_133_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_30_133_34&#39;)"><span class="hl_varref"><span class="mpre">ioff</span></span></a><span class="mpre">)
  where
    !</span><a name="loc_136_6_136_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_6_136_9&#39;)"><span class="hl_vardecl"><span class="mpre">ipe</span></span></a><span class="mpre"> = </span><a href="GHC.ForeignPtr.html#loc_420_1_420_22" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.ForeignPtr.html#loc_420_1_420_22&#39;)"><span class="hl_varref"><span class="mpre">unsafeForeignPtrToPtr</span></span></a><span class="mpre"> </span><a href="#loc_133_26_133_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_26_133_29&#39;)"><span class="hl_varref"><span class="mpre">ifp</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> (</span><a href="#loc_133_30_133_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_30_133_34&#39;)"><span class="hl_varref"><span class="mpre">ioff</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">+</span></span><span class="mpre"> </span><a href="#loc_133_35_133_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_35_133_40&#39;)"><span class="hl_varref"><span class="mpre">isize</span></span></a><span class="mpre">)
    </span><a name="loc_137_5_137_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_5_137_9&#39;)"><span class="hl_fundecl"><span class="mpre">goBS</span></span></a><span class="mpre"> !</span><a name="loc_137_11_137_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_11_137_13&#39;)"><span class="hl_vardecl"><span class="mpre">ip</span></span></a><span class="mpre"> !(</span><span class="hl_conref"><span class="mpre">BufRange</span></span><span class="mpre"> </span><a name="loc_137_25_137_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_25_137_27&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> </span><a name="loc_137_28_137_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_28_137_31&#39;)"><span class="hl_vardecl"><span class="mpre">ope</span></span></a><span class="mpre">)
      | </span><a href="#loc_149_9_149_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_9_149_21&#39;)"><span class="hl_varref"><span class="mpre">inpRemaining</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_148_9_148_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_9_148_21&#39;)"><span class="hl_varref"><span class="mpre">outRemaining</span></span></a><span class="mpre"> = do
          </span><a href="Foreign.Marshal.Utils.html#loc_154_1_154_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_154_1_154_10&#39;)"><span class="hl_varref"><span class="mpre">copyBytes</span></span></a><span class="mpre"> </span><a href="#loc_137_25_137_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_25_137_27&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_137_11_137_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_11_137_13&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><a href="#loc_149_9_149_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_9_149_21&#39;)"><span class="hl_varref"><span class="mpre">inpRemaining</span></span></a><span class="mpre">
          </span><span class="hl_varref"><span class="mpre">touchForeignPtr</span></span><span class="mpre"> </span><a href="#loc_133_26_133_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_26_133_29&#39;)"><span class="hl_varref"><span class="mpre">ifp</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- input consumed: OK to release from here</span></span><span class="mpre">
          let !</span><a name="loc_141_16_141_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_141_16_141_19&#39;)"><span class="hl_vardecl"><span class="mpre">br&#39;</span></span></a><span class="mpre"> = </span><span class="hl_conref"><span class="mpre">BufRange</span></span><span class="mpre"> (</span><a href="#loc_137_25_137_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_25_137_27&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_149_9_149_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_9_149_21&#39;)"><span class="hl_varref"><span class="mpre">inpRemaining</span></span></a><span class="mpre">) </span><a href="#loc_137_28_137_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_28_137_31&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre">
          </span><a href="#loc_133_43_133_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_43_133_44&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre"> </span><a href="#loc_141_16_141_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_141_16_141_19&#39;)"><span class="hl_varref"><span class="mpre">br&#39;</span></span></a><span class="mpre">
      | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre"> = do
          </span><a href="Foreign.Marshal.Utils.html#loc_154_1_154_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Marshal.Utils.html#loc_154_1_154_10&#39;)"><span class="hl_varref"><span class="mpre">copyBytes</span></span></a><span class="mpre"> </span><a href="#loc_137_25_137_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_25_137_27&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_137_11_137_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_11_137_13&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><a href="#loc_148_9_148_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_9_148_21&#39;)"><span class="hl_varref"><span class="mpre">outRemaining</span></span></a><span class="mpre">
          let !</span><a name="loc_145_16_145_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_16_145_19&#39;)"><span class="hl_vardecl"><span class="mpre">ip&#39;</span></span></a><span class="mpre"> = </span><a href="#loc_137_11_137_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_11_137_13&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_148_9_148_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_9_148_21&#39;)"><span class="hl_varref"><span class="mpre">outRemaining</span></span></a><span class="mpre">
          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_57_1_57_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_57_1_57_11&#39;)"><span class="hl_varref"><span class="mpre">bufferFull</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre"> </span><a href="#loc_137_28_137_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_28_137_31&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> (</span><a href="#loc_137_5_137_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_5_137_9&#39;)"><span class="hl_varref"><span class="mpre">goBS</span></span></a><span class="mpre"> </span><a href="#loc_145_16_145_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_145_16_145_19&#39;)"><span class="hl_varref"><span class="mpre">ip&#39;</span></span></a><span class="mpre">)
      where
        </span><a name="loc_148_9_148_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_9_148_21&#39;)"><span class="hl_vardecl"><span class="mpre">outRemaining</span></span></a><span class="mpre"> = </span><a href="#loc_137_28_137_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_28_137_31&#39;)"><span class="hl_varref"><span class="mpre">ope</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_137_25_137_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_25_137_27&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre">
        </span><a name="loc_149_9_149_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_9_149_21&#39;)"><span class="hl_vardecl"><span class="mpre">inpRemaining</span></span></a><span class="mpre"> = </span><a href="#loc_136_6_136_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_6_136_9&#39;)"><span class="hl_varref"><span class="mpre">ipe</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`minusPtr`</span></span><span class="mpre"> </span><a href="#loc_137_11_137_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_11_137_13&#39;)"><span class="hl_varref"><span class="mpre">ip</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_133_1_133_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_133_1_133_19&#39;)"><span class="mpre">copyByteStringStep</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | @insertByteString bs@ serializes the strict bytestring @bs@ by inserting</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- it directly as a chunk of the output stream.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Note that this implies flushing the output buffer; even if it contains just</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- a single byte. Hence, you should use this operation only for large (@&gt; 8kb@)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- bytestrings, as otherwise the resulting output stream may be too fragmented</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to be processed efficiently.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_161_1_161_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_1_161_17&#39;)"><span class="mpre">insertByteString</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">S.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_161_1_161_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_1_161_17&#39;)"><span class="hl_vardecl"><span class="mpre">insertByteString</span></span></a><span class="mpre"> =
    \</span><a name="loc_162_6_162_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_6_162_8&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_124_1_124_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_124_1_124_18&#39;)"><span class="hl_varref"><span class="mpre">fromBuildStepCont</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_164_5_164_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_5_164_9&#39;)"><span class="hl_varref"><span class="mpre">step</span></span></a><span class="mpre"> </span><a href="#loc_162_6_162_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_6_162_8&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre">
  where
    </span><a name="loc_164_5_164_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_5_164_9&#39;)"><span class="hl_fundecl"><span class="mpre">step</span></span></a><span class="mpre"> !</span><a name="loc_164_11_164_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_11_164_13&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> !</span><a name="loc_164_15_164_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_15_164_16&#39;)"><span class="hl_vardecl"><span class="mpre">k</span></span></a><span class="mpre"> !(</span><span class="hl_conref"><span class="mpre">BufRange</span></span><span class="mpre"> </span><a name="loc_164_28_164_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_28_164_30&#39;)"><span class="hl_vardecl"><span class="mpre">op</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_60_1_60_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_60_1_60_17&#39;)"><span class="hl_varref"><span class="mpre">I.insertByteString</span></span></a><span class="mpre"> </span><a href="#loc_164_28_164_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_28_164_30&#39;)"><span class="hl_varref"><span class="mpre">op</span></span></a><span class="mpre"> </span><a href="#loc_164_11_164_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_11_164_13&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="#loc_164_15_164_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_15_164_16&#39;)"><span class="hl_varref"><span class="mpre">k</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_161_1_161_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_1_161_17&#39;)"><span class="mpre">insertByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- Lazy bytestrings</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(n)/. Smart serialization of a lazy bytestring.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @&#39;fromLazyByteString&#39; = &#39;fromLazyByteStringWith&#39; &#39;defaultMaximalCopySize&#39;@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Use this function to serialize lazy bytestrings. It guarantees an average</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- chunk size of 4kb, which has been shown to be a reasonable size in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- benchmarks. Note that the check whether to copy or to insert is (almost)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- free as the builder performance is mostly memory-bound.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- If you statically know that copying or inserting /all/ chunks of the lazy</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- bytestring is always the best choice, then you can use the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;copyLazyByteString&#39; or &#39;insertLazyByteString&#39; functions.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_185_1_185_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_185_1_185_19&#39;)"><span class="mpre">fromLazyByteString</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_185_1_185_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_185_1_185_19&#39;)"><span class="hl_vardecl"><span class="mpre">fromLazyByteString</span></span></a><span class="mpre"> = </span><a href="#loc_203_1_203_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_1_203_23&#39;)"><span class="hl_varref"><span class="mpre">fromLazyByteStringWith</span></span></a><span class="mpre"> </span><a href="Blaze.ByteString.Builder.Internal.html#loc_112_1_112_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.html#loc_112_1_112_23&#39;)"><span class="hl_varref"><span class="mpre">defaultMaximalCopySize</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_185_1_185_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_185_1_185_19&#39;)"><span class="mpre">fromLazyByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(n)/. Serialize a lazy bytestring chunk-wise according to the same rules</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- as in &#39;fromByteStringWith&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Semantically, it holds that</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt;   fromLazyByteStringWith maxCopySize</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &gt; = mconcat . map (fromByteStringWith maxCopySize) . L.toChunks</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- However, the left-hand-side is much more efficient, as it moves the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- end-of-buffer pointer out of the inner loop and provides the compiler with</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- more strictness information.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_203_1_203_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_1_203_23&#39;)"><span class="mpre">fromLazyByteStringWith</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre">          </span><span class="hl_comment"><span class="mpre">-- ^ Maximal number of bytes to copy.</span></span><span class="mpre">
                       -&gt; </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ Lazy &#39;L.ByteString&#39; to serialize.</span></span><span class="mpre">
                       -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">      </span><span class="hl_comment"><span class="mpre">-- ^ Resulting &#39;Builder&#39;.</span></span><span class="mpre">
</span><a name="loc_203_1_203_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_1_203_23&#39;)"><span class="hl_fundecl"><span class="mpre">fromLazyByteStringWith</span></span></a><span class="mpre"> </span><a name="loc_203_24_203_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_24_203_35&#39;)"><span class="hl_vardecl"><span class="mpre">maxCopySize</span></span></a><span class="mpre"> =
  </span><a href="Data.ByteString.Lazy.Internal.html#loc_179_1_179_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_179_1_179_12&#39;)"><span class="hl_varref"><span class="mpre">L.foldrChunks</span></span></a><span class="mpre"> (\</span><a name="loc_204_19_204_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_19_204_21&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_204_22_204_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_22_204_23&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_112_1_112_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_19&#39;)"><span class="hl_varref"><span class="mpre">fromByteStringWith</span></span></a><span class="mpre"> </span><a href="#loc_203_24_203_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_24_203_35&#39;)"><span class="hl_varref"><span class="mpre">maxCopySize</span></span></a><span class="mpre"> </span><a href="#loc_204_19_204_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_19_204_21&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_infix"><span class="mpre">`mappend`</span></span></a><span class="mpre"> </span><a href="#loc_204_22_204_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_204_22_204_23&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">) </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_203_1_203_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_203_1_203_23&#39;)"><span class="mpre">fromLazyByteStringWith</span></a><span class="mpre"> #-}</span></span><span class="mpre">


</span><span class="hl_comment"><span class="mpre">-- | /O(n)/. Serialize a lazy bytestring by copying /all/ chunks sequentially</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to the output buffer.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- See &#39;copyByteString&#39; for usage considerations.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_214_1_214_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_19&#39;)"><span class="mpre">copyLazyByteString</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_214_1_214_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_19&#39;)"><span class="hl_vardecl"><span class="mpre">copyLazyByteString</span></span></a><span class="mpre"> =
  </span><a href="Data.ByteString.Lazy.Internal.html#loc_179_1_179_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_179_1_179_12&#39;)"><span class="hl_varref"><span class="mpre">L.foldrChunks</span></span></a><span class="mpre"> (\</span><a name="loc_215_19_215_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_19_215_21&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_215_22_215_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_22_215_23&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_127_1_127_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_15&#39;)"><span class="hl_varref"><span class="mpre">copyByteString</span></span></a><span class="mpre"> </span><a href="#loc_215_19_215_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_19_215_21&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_infix"><span class="mpre">`mappend`</span></span></a><span class="mpre"> </span><a href="#loc_215_22_215_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_215_22_215_23&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">) </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_214_1_214_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_214_1_214_19&#39;)"><span class="mpre">copyLazyByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(n)/. Serialize a lazy bytestring by inserting /all/ its chunks directly</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- into the output stream.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- See &#39;insertByteString&#39; for usage considerations.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- For library developers, see the &#39;ModifyChunks&#39; build signal, if you</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- need an /O(1)/ lazy bytestring insert based on difference lists.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_227_1_227_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_227_1_227_21&#39;)"><span class="mpre">insertLazyByteString</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Lazy.Internal.html#loc_82_6_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_82_6_82_16&#39;)"><span class="hl_tyconref"><span class="mpre">L.ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Blaze.ByteString.Builder.Internal.Types.html#loc_69_9_69_16&#39;)"><span class="hl_tyconref"><span class="mpre">Builder</span></span></a><span class="mpre">
</span><a name="loc_227_1_227_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_227_1_227_21&#39;)"><span class="hl_vardecl"><span class="mpre">insertLazyByteString</span></span></a><span class="mpre"> =
  </span><a href="Data.ByteString.Lazy.Internal.html#loc_179_1_179_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Lazy.Internal.html#loc_179_1_179_12&#39;)"><span class="hl_varref"><span class="mpre">L.foldrChunks</span></span></a><span class="mpre"> (\</span><a name="loc_228_19_228_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_19_228_21&#39;)"><span class="hl_vardecl"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a name="loc_228_22_228_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_22_228_23&#39;)"><span class="hl_vardecl"><span class="mpre">b</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_161_1_161_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_1_161_17&#39;)"><span class="hl_varref"><span class="mpre">insertByteString</span></span></a><span class="mpre"> </span><a href="#loc_228_19_228_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_19_228_21&#39;)"><span class="hl_varref"><span class="mpre">bs</span></span></a><span class="mpre"> </span><a href="Data.Monoid.html#loc_82_9_82_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_82_9_82_16&#39;)"><span class="hl_infix"><span class="mpre">`mappend`</span></span></a><span class="mpre"> </span><a href="#loc_228_22_228_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_22_228_23&#39;)"><span class="hl_varref"><span class="mpre">b</span></span></a><span class="mpre">) </span><a href="Data.Monoid.html#loc_80_9_80_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Monoid.html#loc_80_9_80_15&#39;)"><span class="hl_varref"><span class="mpre">mempty</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_227_1_227_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_227_1_227_21&#39;)"><span class="mpre">insertLazyByteString</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span></div></body></html>