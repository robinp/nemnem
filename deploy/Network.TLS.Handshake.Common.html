<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE DeriveDataTypeable, OverloadedStrings #-}
module Network.TLS.Handshake.Common
    ( handshakeFailed
    , errorToAlert
    , unexpected
    , newSession
    , handshakeTerminate
    </span><span class="hl_comment"><span class="mpre">-- * sending packets</span></span><span class="mpre">
    , sendChangeCipherAndFinish
    </span><span class="hl_comment"><span class="mpre">-- * receiving packets</span></span><span class="mpre">
    , recvChangeCipherAndFinish
    , RecvState(..)
    , runRecvState
    , recvPacketHandshake
    , onRecvStateHandshake
    ) where

import Control.Concurrent.MVar

import Network.TLS.Parameters
import Network.TLS.Context.Internal
import Network.TLS.Session
import Network.TLS.Struct
import Network.TLS.IO
import Network.TLS.State hiding (</span><a href="Network.TLS.State.html#loc_186_1_186_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_186_1_186_22&#39;)"><span class="mpre">getNegotiatedProtocol</span></a><span class="mpre">)
import Network.TLS.Handshake.Process
import Network.TLS.Handshake.State
import Network.TLS.Record.State
import Network.TLS.Measurement
import Network.TLS.Types
import Network.TLS.Cipher
import Network.TLS.Util
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Handshake/Common.hs&quot;, srcSpanStartLine = 33, srcSpanStartColumn = 8, srcSpanEndLine = 33, srcSpanEndColumn = 29}, srcInfoPoints = []}) &quot;Data.ByteString.Char8&quot;"><span class="mpre">Data.ByteString.Char8</span></span><span class="mpre"> ()

import Control.Monad.State
import Control.Exception (</span><a href="GHC.IO.html#loc_304_1_304_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_304_1_304_8&#39;)"><span class="mpre">throwIO</span></a><span class="mpre">)

</span><a href="#loc_39_1_39_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_1_39_16&#39;)"><span class="mpre">handshakeFailed</span></a><span class="mpre"> :: </span><a href="Network.TLS.Struct.html#loc_121_6_121_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_121_6_121_14&#39;)"><span class="hl_tyconref"><span class="mpre">TLSError</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_39_1_39_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_1_39_16&#39;)"><span class="hl_fundecl"><span class="mpre">handshakeFailed</span></span></a><span class="mpre"> </span><a name="loc_39_17_39_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_17_39_20&#39;)"><span class="hl_vardecl"><span class="mpre">err</span></span></a><span class="mpre"> = </span><a href="GHC.IO.html#loc_304_1_304_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_304_1_304_8&#39;)"><span class="hl_varref"><span class="mpre">throwIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_143_7_143_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_143_7_143_22&#39;)"><span class="hl_conref"><span class="mpre">HandshakeFailed</span></span></a><span class="mpre"> </span><a href="#loc_39_17_39_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_17_39_20&#39;)"><span class="hl_varref"><span class="mpre">err</span></span></a><span class="mpre">

</span><a href="#loc_42_1_42_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_1_42_13&#39;)"><span class="mpre">errorToAlert</span></a><span class="mpre"> :: </span><a href="Network.TLS.Struct.html#loc_121_6_121_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_121_6_121_14&#39;)"><span class="hl_tyconref"><span class="mpre">TLSError</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Struct.html#loc_150_6_150_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_150_6_150_12&#39;)"><span class="hl_tyconref"><span class="mpre">Packet</span></span></a><span class="mpre">
</span><a name="loc_42_1_42_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_1_42_13&#39;)"><span class="hl_fundecl"><span class="mpre">errorToAlert</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_123_7_123_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_123_7_123_21&#39;)"><span class="hl_conref"><span class="mpre">Error_Protocol</span></span></a><span class="mpre"> (_, _, </span><a name="loc_42_37_42_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_37_42_39&#39;)"><span class="hl_vardecl"><span class="mpre">ad</span></span></a><span class="mpre">)) = </span><a href="Network.TLS.Struct.html#loc_152_7_152_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_152_7_152_12&#39;)"><span class="hl_conref"><span class="mpre">Alert</span></span></a><span class="mpre"> [(</span><a href="Network.TLS.Struct.html#loc_178_7_178_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_178_7_178_23&#39;)"><span class="hl_conref"><span class="mpre">AlertLevel_Fatal</span></span></a><span class="mpre">, </span><a href="#loc_42_37_42_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_37_42_39&#39;)"><span class="hl_varref"><span class="mpre">ad</span></span></a><span class="mpre">)]
</span><a href="#loc_42_1_42_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_42_1_42_13&#39;)"><span class="hl_fundecl"><span class="mpre">errorToAlert</span></span></a><span class="mpre"> _                           = </span><a href="Network.TLS.Struct.html#loc_152_7_152_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_152_7_152_12&#39;)"><span class="hl_conref"><span class="mpre">Alert</span></span></a><span class="mpre"> [(</span><a href="Network.TLS.Struct.html#loc_178_7_178_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_178_7_178_23&#39;)"><span class="hl_conref"><span class="mpre">AlertLevel_Fatal</span></span></a><span class="mpre">, </span><a href="Network.TLS.Struct.html#loc_202_7_202_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_202_7_202_20&#39;)"><span class="hl_conref"><span class="mpre">InternalError</span></span></a><span class="mpre">)]

</span><a href="#loc_46_1_46_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_11&#39;)"><span class="mpre">unexpected</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> [</span><span class="hl_tyconref"><span class="mpre">Char</span></span><span class="mpre">] -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_46_1_46_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_11&#39;)"><span class="hl_fundecl"><span class="mpre">unexpected</span></span></a><span class="mpre"> </span><a name="loc_46_12_46_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_12_46_15&#39;)"><span class="hl_vardecl"><span class="mpre">msg</span></span></a><span class="mpre"> </span><a name="loc_46_16_46_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_16_46_24&#39;)"><span class="hl_vardecl"><span class="mpre">expected</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_128_7_128_30" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_128_7_128_30&#39;)"><span class="hl_conref"><span class="mpre">Error_Packet_unexpected</span></span></a><span class="mpre"> </span><a href="#loc_46_12_46_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_12_46_15&#39;)"><span class="hl_varref"><span class="mpre">msg</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">maybe</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;&quot;</span></span><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot; expected: &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre">) </span><a href="#loc_46_16_46_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_16_46_24&#39;)"><span class="hl_varref"><span class="mpre">expected</span></span></a><span class="mpre">)

</span><a href="#loc_49_1_49_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_49_1_49_11&#39;)"><span class="mpre">newSession</span></a><span class="mpre"> :: </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_161_9_161_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_161_9_161_16&#39;)"><span class="hl_tyconref"><span class="mpre">Session</span></span></a><span class="mpre">
</span><a name="loc_49_1_49_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_49_1_49_11&#39;)"><span class="hl_fundecl"><span class="mpre">newSession</span></span></a><span class="mpre"> </span><a name="loc_49_12_49_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_49_12_49_15&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre">
    | </span><a href="Network.TLS.Parameters.html#loc_124_7_124_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_124_7_124_23&#39;)"><span class="hl_varref"><span class="mpre">supportedSession</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_87_7_87_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_87_7_87_19&#39;)"><span class="hl_varref"><span class="mpre">ctxSupported</span></span></a><span class="mpre"> </span><a href="#loc_49_12_49_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_49_12_49_15&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Context.Internal.html#loc_211_1_211_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_211_1_211_12&#39;)"><span class="hl_varref"><span class="mpre">getStateRNG</span></span></a><span class="mpre"> </span><a href="#loc_49_12_49_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_49_12_49_15&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">32</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_161_19_161_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_161_19_161_26&#39;)"><span class="hl_conref"><span class="mpre">Session</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre">
    | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                           = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_161_19_161_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_161_19_161_26&#39;)"><span class="hl_conref"><span class="mpre">Session</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | when a new handshake is done, wrap up &amp; clean up.</span></span><span class="mpre">
</span><a href="#loc_55_1_55_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_1_55_19&#39;)"><span class="mpre">handshakeTerminate</span></a><span class="mpre"> :: </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_55_1_55_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_1_55_19&#39;)"><span class="hl_fundecl"><span class="mpre">handshakeTerminate</span></span></a><span class="mpre"> </span><a name="loc_55_20_55_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_20_55_23&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> = do
    </span><a name="loc_56_5_56_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_56_5_56_12&#39;)"><span class="hl_vardecl"><span class="mpre">session</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_55_20_55_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_20_55_23&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.State.html#loc_150_1_150_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_150_1_150_11&#39;)"><span class="hl_varref"><span class="mpre">getSession</span></span></a><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- only callback the session established if we have a session</span></span><span class="mpre">
    case </span><a href="#loc_56_5_56_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_56_5_56_12&#39;)"><span class="hl_varref"><span class="mpre">session</span></span></a><span class="mpre"> of
        </span><a href="Network.TLS.Struct.html#loc_161_19_161_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_161_19_161_26&#39;)"><span class="hl_conref"><span class="mpre">Session</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_59_23_59_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_59_23_59_32&#39;)"><span class="hl_vardecl"><span class="mpre">sessionId</span></span></a><span class="mpre">) -&gt; do
            </span><a name="loc_60_13_60_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_60_13_60_24&#39;)"><span class="hl_vardecl"><span class="mpre">sessionData</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_117_1_117_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_1_117_15&#39;)"><span class="hl_varref"><span class="mpre">getSessionData</span></span></a><span class="mpre"> </span><a href="#loc_55_20_55_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_20_55_23&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
            </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Session.html#loc_20_7_20_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Session.html#loc_20_7_20_23&#39;)"><span class="hl_varref"><span class="mpre">sessionEstablish</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Parameters.html#loc_147_7_147_27" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_147_7_147_27&#39;)"><span class="hl_varref"><span class="mpre">sharedSessionManager</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_88_7_88_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_88_7_88_16&#39;)"><span class="hl_varref"><span class="mpre">ctxShared</span></span></a><span class="mpre"> </span><a href="#loc_55_20_55_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_20_55_23&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">) </span><a href="#loc_59_23_59_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_59_23_59_32&#39;)"><span class="hl_varref"><span class="mpre">sessionId</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Util.html#loc_53_1_53_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Util.html#loc_53_1_53_9&#39;)"><span class="hl_varref"><span class="mpre">fromJust</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;session-data&quot;</span></span><span class="mpre"> </span><a href="#loc_60_13_60_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_60_13_60_24&#39;)"><span class="hl_varref"><span class="mpre">sessionData</span></span></a><span class="mpre">)
        _ -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- forget all handshake data now and reset bytes counters.</span></span><span class="mpre">
    </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Control.Concurrent.MVar.html#loc_216_1_216_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Concurrent.MVar.html#loc_216_1_216_12&#39;)"><span class="hl_varref"><span class="mpre">modifyMVar_</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Context.Internal.html#loc_100_7_100_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_100_7_100_19&#39;)"><span class="hl_varref"><span class="mpre">ctxHandshake</span></span></a><span class="mpre"> </span><a href="#loc_55_20_55_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_20_55_23&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">) (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">const</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">)
    </span><a href="Network.TLS.Context.Internal.html#loc_111_1_111_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_111_1_111_14&#39;)"><span class="hl_varref"><span class="mpre">updateMeasure</span></span></a><span class="mpre"> </span><a href="#loc_55_20_55_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_20_55_23&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.Measurement.html#loc_42_1_42_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Measurement.html#loc_42_1_42_19&#39;)"><span class="hl_varref"><span class="mpre">resetBytesCounters</span></span></a><span class="mpre">
    </span><span class="hl_comment"><span class="mpre">-- mark the secure connection up and running.</span></span><span class="mpre">
    </span><a href="Network.TLS.Context.Internal.html#loc_161_1_161_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_161_1_161_15&#39;)"><span class="hl_varref"><span class="mpre">setEstablished</span></span></a><span class="mpre"> </span><a href="#loc_55_20_55_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_55_20_55_23&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">

</span><a href="#loc_74_1_74_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_1_74_26&#39;)"><span class="mpre">sendChangeCipherAndFinish</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">   </span><span class="hl_comment"><span class="mpre">-- ^ message possibly sent between ChangeCipherSpec and Finished.</span></span><span class="mpre">
                          -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre">
                          -&gt; </span><a href="Network.TLS.Types.html#loc_44_6_44_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_44_6_44_10&#39;)"><span class="hl_tyconref"><span class="mpre">Role</span></span></a><span class="mpre">
                          -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_74_1_74_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_1_74_26&#39;)"><span class="hl_fundecl"><span class="mpre">sendChangeCipherAndFinish</span></span></a><span class="mpre"> </span><a name="loc_74_27_74_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_27_74_38&#39;)"><span class="hl_vardecl"><span class="mpre">betweenCall</span></span></a><span class="mpre"> </span><a name="loc_74_39_74_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_39_74_42&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a name="loc_74_43_74_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_43_74_47&#39;)"><span class="hl_vardecl"><span class="mpre">role</span></span></a><span class="mpre"> = do
    </span><a href="Network.TLS.IO.html#loc_106_1_106_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.IO.html#loc_106_1_106_11&#39;)"><span class="hl_varref"><span class="mpre">sendPacket</span></span></a><span class="mpre"> </span><a href="#loc_74_39_74_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_39_74_42&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_153_7_153_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_153_7_153_23&#39;)"><span class="hl_conref"><span class="mpre">ChangeCipherSpec</span></span></a><span class="mpre">
    </span><a href="#loc_74_27_74_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_27_74_38&#39;)"><span class="hl_varref"><span class="mpre">betweenCall</span></span></a><span class="mpre">
    </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_119_1_119_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_119_1_119_13&#39;)"><span class="hl_varref"><span class="mpre">contextFlush</span></span></a><span class="mpre"> </span><a href="#loc_74_39_74_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_39_74_42&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
    </span><a name="loc_78_5_78_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_5_78_7&#39;)"><span class="hl_vardecl"><span class="mpre">cf</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_74_39_74_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_39_74_42&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.State.html#loc_165_1_165_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_165_1_165_11&#39;)"><span class="hl_varref"><span class="mpre">getVersion</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> \</span><a name="loc_78_43_78_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_43_78_46&#39;)"><span class="hl_vardecl"><span class="mpre">ver</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_74_39_74_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_39_74_42&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_178_1_178_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_178_1_178_19&#39;)"><span class="hl_varref"><span class="mpre">getHandshakeDigest</span></span></a><span class="mpre"> </span><a href="#loc_78_43_78_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_43_78_46&#39;)"><span class="hl_varref"><span class="mpre">ver</span></span></a><span class="mpre"> </span><a href="#loc_74_43_74_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_43_74_47&#39;)"><span class="hl_varref"><span class="mpre">role</span></span></a><span class="mpre">
    </span><a href="Network.TLS.IO.html#loc_106_1_106_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.IO.html#loc_106_1_106_11&#39;)"><span class="hl_varref"><span class="mpre">sendPacket</span></span></a><span class="mpre"> </span><a href="#loc_74_39_74_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_39_74_42&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_151_7_151_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_151_7_151_16&#39;)"><span class="hl_conref"><span class="mpre">Handshake</span></span></a><span class="mpre"> [</span><a href="Network.TLS.Struct.html#loc_262_7_262_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_262_7_262_15&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre"> </span><a href="#loc_78_5_78_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_78_5_78_7&#39;)"><span class="hl_varref"><span class="mpre">cf</span></span></a><span class="mpre">])
    </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_119_1_119_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_119_1_119_13&#39;)"><span class="hl_varref"><span class="mpre">contextFlush</span></span></a><span class="mpre"> </span><a href="#loc_74_39_74_42" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_39_74_42&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">

</span><a href="#loc_83_1_83_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_1_83_26&#39;)"><span class="mpre">recvChangeCipherAndFinish</span></a><span class="mpre"> :: </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_83_1_83_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_1_83_26&#39;)"><span class="hl_fundecl"><span class="mpre">recvChangeCipherAndFinish</span></span></a><span class="mpre"> </span><a name="loc_83_27_83_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_27_83_30&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> = </span><a href="#loc_112_1_112_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_13&#39;)"><span class="hl_varref"><span class="mpre">runRecvState</span></span></a><span class="mpre"> </span><a href="#loc_83_27_83_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_27_83_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="#loc_90_7_90_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_7_90_20&#39;)"><span class="hl_conref"><span class="mpre">RecvStateNext</span></span></a><span class="mpre"> </span><a href="#loc_84_9_84_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_9_84_27&#39;)"><span class="hl_varref"><span class="mpre">expectChangeCipher</span></span></a><span class="mpre">)
  where </span><a name="loc_84_9_84_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_9_84_27&#39;)"><span class="hl_fundecl"><span class="mpre">expectChangeCipher</span></span></a><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_153_7_153_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_153_7_153_23&#39;)"><span class="hl_conref"><span class="mpre">ChangeCipherSpec</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_91_7_91_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_7_91_25&#39;)"><span class="hl_conref"><span class="mpre">RecvStateHandshake</span></span></a><span class="mpre"> </span><a href="#loc_86_9_86_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_21&#39;)"><span class="hl_varref"><span class="mpre">expectFinish</span></span></a><span class="mpre">
        </span><a href="#loc_84_9_84_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_9_84_27&#39;)"><span class="hl_fundecl"><span class="mpre">expectChangeCipher</span></span></a><span class="mpre"> </span><a name="loc_85_28_85_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_28_85_29&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre">                = </span><a href="#loc_46_1_46_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_11&#39;)"><span class="hl_varref"><span class="mpre">unexpected</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_85_28_85_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_28_85_29&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">) (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;change cipher&quot;</span></span><span class="mpre">)
        </span><a name="loc_86_9_86_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_21&#39;)"><span class="hl_fundecl"><span class="mpre">expectFinish</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_262_7_262_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_262_7_262_15&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_92_7_92_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_7_92_20&#39;)"><span class="hl_conref"><span class="mpre">RecvStateDone</span></span></a><span class="mpre">
        </span><a href="#loc_86_9_86_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_21&#39;)"><span class="hl_fundecl"><span class="mpre">expectFinish</span></span></a><span class="mpre"> </span><a name="loc_87_22_87_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_22_87_23&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre">            = </span><a href="#loc_46_1_46_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_11&#39;)"><span class="hl_varref"><span class="mpre">unexpected</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_87_22_87_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_22_87_23&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">) (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;Handshake Finished&quot;</span></span><span class="mpre">)

data </span><a name="loc_89_6_89_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_6_89_15&#39;)"><span class="hl_tycondecl"><span class="mpre">RecvState</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> =
      </span><a name="loc_90_7_90_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_7_90_20&#39;)"><span class="hl_condecl"><span class="mpre">RecvStateNext</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_150_6_150_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_150_6_150_12&#39;)"><span class="hl_tyconref"><span class="mpre">Packet</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> (</span><a href="#loc_89_6_89_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_6_89_15&#39;)"><span class="hl_tyconref"><span class="mpre">RecvState</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre">))
    | </span><a name="loc_91_7_91_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_7_91_25&#39;)"><span class="hl_condecl"><span class="mpre">RecvStateHandshake</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_252_6_252_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_252_6_252_15&#39;)"><span class="hl_tyconref"><span class="mpre">Handshake</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> (</span><a href="#loc_89_6_89_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_6_89_15&#39;)"><span class="hl_tyconref"><span class="mpre">RecvState</span></span></a><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre">))
    | </span><a name="loc_92_7_92_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_7_92_20&#39;)"><span class="hl_condecl"><span class="mpre">RecvStateDone</span></span></a><span class="mpre">

</span><a href="#loc_95_1_95_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_1_95_20&#39;)"><span class="mpre">recvPacketHandshake</span></a><span class="mpre"> :: </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> [</span><a href="Network.TLS.Struct.html#loc_252_6_252_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_252_6_252_15&#39;)"><span class="hl_tyconref"><span class="mpre">Handshake</span></span></a><span class="mpre">]
</span><a name="loc_95_1_95_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_1_95_20&#39;)"><span class="hl_fundecl"><span class="mpre">recvPacketHandshake</span></span></a><span class="mpre"> </span><a name="loc_95_21_95_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_21_95_24&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> = do
    </span><a name="loc_96_5_96_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_96_5_96_9&#39;)"><span class="hl_vardecl"><span class="mpre">pkts</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.IO.html#loc_86_1_86_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.IO.html#loc_86_1_86_11&#39;)"><span class="hl_varref"><span class="mpre">recvPacket</span></span></a><span class="mpre"> </span><a href="#loc_95_21_95_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_21_95_24&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
    case </span><a href="#loc_96_5_96_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_96_5_96_9&#39;)"><span class="hl_varref"><span class="mpre">pkts</span></span></a><span class="mpre"> of
        </span><span class="hl_conref"><span class="mpre">Right</span></span><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_151_7_151_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_151_7_151_16&#39;)"><span class="hl_conref"><span class="mpre">Handshake</span></span></a><span class="mpre"> </span><a name="loc_98_26_98_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_26_98_27&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_98_26_98_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_98_26_98_27&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">
        </span><span class="hl_conref"><span class="mpre">Right</span></span><span class="mpre"> </span><a name="loc_99_15_99_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_15_99_16&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre">             -&gt; </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;unexpected type received. expecting handshake and got: &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_99_15_99_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_15_99_16&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">)
        </span><span class="hl_conref"><span class="mpre">Left</span></span><span class="mpre"> </span><a name="loc_100_14_100_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_100_14_100_17&#39;)"><span class="hl_vardecl"><span class="mpre">err</span></span></a><span class="mpre">            -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><a href="#loc_100_14_100_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_100_14_100_17&#39;)"><span class="hl_varref"><span class="mpre">err</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | process a list of handshakes message in the recv state machine.</span></span><span class="mpre">
</span><a href="#loc_104_1_104_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_1_104_21&#39;)"><span class="mpre">onRecvStateHandshake</span></a><span class="mpre"> :: </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_89_6_89_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_6_89_15&#39;)"><span class="hl_tyconref"><span class="mpre">RecvState</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> -&gt; [</span><a href="Network.TLS.Struct.html#loc_252_6_252_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_252_6_252_15&#39;)"><span class="hl_tyconref"><span class="mpre">Handshake</span></span></a><span class="mpre">] -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><a href="#loc_89_6_89_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_6_89_15&#39;)"><span class="hl_tyconref"><span class="mpre">RecvState</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre">)
</span><a name="loc_104_1_104_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_1_104_21&#39;)"><span class="hl_fundecl"><span class="mpre">onRecvStateHandshake</span></span></a><span class="mpre"> _   </span><a name="loc_104_26_104_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_26_104_35&#39;)"><span class="hl_vardecl"><span class="mpre">recvState</span></span></a><span class="mpre"> [] = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_104_26_104_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_26_104_35&#39;)"><span class="hl_varref"><span class="mpre">recvState</span></span></a><span class="mpre">
</span><a href="#loc_104_1_104_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_1_104_21&#39;)"><span class="hl_fundecl"><span class="mpre">onRecvStateHandshake</span></span></a><span class="mpre"> </span><a name="loc_105_22_105_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_22_105_25&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="#loc_91_7_91_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_7_91_25&#39;)"><span class="hl_conref"><span class="mpre">RecvStateHandshake</span></span></a><span class="mpre"> </span><a name="loc_105_46_105_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_46_105_47&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre">) (</span><a name="loc_105_50_105_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_50_105_51&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_105_52_105_54" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_52_105_54&#39;)"><span class="hl_vardecl"><span class="mpre">xs</span></span></a><span class="mpre">) = do
    </span><a name="loc_106_5_106_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_5_106_11&#39;)"><span class="hl_vardecl"><span class="mpre">nstate</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_105_46_105_47" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_46_105_47&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_105_50_105_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_50_105_51&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
    </span><a href="Network.TLS.Handshake.Process.html#loc_34_1_34_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Process.html#loc_34_1_34_17&#39;)"><span class="hl_varref"><span class="mpre">processHandshake</span></span></a><span class="mpre"> </span><a href="#loc_105_22_105_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_22_105_25&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_105_50_105_51" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_50_105_51&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">
    </span><a href="#loc_104_1_104_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_1_104_21&#39;)"><span class="hl_varref"><span class="mpre">onRecvStateHandshake</span></span></a><span class="mpre"> </span><a href="#loc_105_22_105_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_22_105_25&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_106_5_106_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_5_106_11&#39;)"><span class="hl_varref"><span class="mpre">nstate</span></span></a><span class="mpre"> </span><a href="#loc_105_52_105_54" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_52_105_54&#39;)"><span class="hl_varref"><span class="mpre">xs</span></span></a><span class="mpre">
</span><a href="#loc_104_1_104_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_1_104_21&#39;)"><span class="hl_fundecl"><span class="mpre">onRecvStateHandshake</span></span></a><span class="mpre"> _ _ _   = </span><a href="#loc_46_1_46_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_46_1_46_11&#39;)"><span class="hl_varref"><span class="mpre">unexpected</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;spurious handshake&quot;</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">

</span><a href="#loc_112_1_112_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_13&#39;)"><span class="mpre">runRecvState</span></a><span class="mpre"> :: </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_89_6_89_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_89_6_89_15&#39;)"><span class="hl_tyconref"><span class="mpre">RecvState</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_112_1_112_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_13&#39;)"><span class="hl_fundecl"><span class="mpre">runRecvState</span></span></a><span class="mpre"> _   (</span><a href="#loc_92_7_92_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_7_92_20&#39;)"><span class="hl_conref"><span class="mpre">RecvStateDone</span></span></a><span class="mpre">)   = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
</span><a href="#loc_112_1_112_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_13&#39;)"><span class="hl_fundecl"><span class="mpre">runRecvState</span></span></a><span class="mpre"> </span><a name="loc_113_14_113_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_14_113_17&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="#loc_90_7_90_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_7_90_20&#39;)"><span class="hl_conref"><span class="mpre">RecvStateNext</span></span></a><span class="mpre"> </span><a name="loc_113_33_113_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_33_113_34&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre">) = </span><a href="Network.TLS.IO.html#loc_86_1_86_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.IO.html#loc_86_1_86_11&#39;)"><span class="hl_varref"><span class="mpre">recvPacket</span></span></a><span class="mpre"> </span><a href="#loc_113_14_113_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_14_113_17&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">either</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><a href="#loc_113_33_113_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_33_113_34&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_112_1_112_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_13&#39;)"><span class="hl_varref"><span class="mpre">runRecvState</span></span></a><span class="mpre"> </span><a href="#loc_113_14_113_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_14_113_17&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
</span><a href="#loc_112_1_112_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_13&#39;)"><span class="hl_fundecl"><span class="mpre">runRecvState</span></span></a><span class="mpre"> </span><a name="loc_114_14_114_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_14_114_17&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a name="loc_114_18_114_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_18_114_26&#39;)"><span class="hl_vardecl"><span class="mpre">iniState</span></span></a><span class="mpre">          = </span><a href="#loc_95_1_95_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_95_1_95_20&#39;)"><span class="hl_varref"><span class="mpre">recvPacketHandshake</span></span></a><span class="mpre"> </span><a href="#loc_114_14_114_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_14_114_17&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_104_1_104_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_1_104_21&#39;)"><span class="hl_varref"><span class="mpre">onRecvStateHandshake</span></span></a><span class="mpre"> </span><a href="#loc_114_14_114_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_14_114_17&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_114_18_114_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_18_114_26&#39;)"><span class="hl_varref"><span class="mpre">iniState</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_112_1_112_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_13&#39;)"><span class="hl_varref"><span class="mpre">runRecvState</span></span></a><span class="mpre"> </span><a href="#loc_114_14_114_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_114_14_114_17&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">

</span><a href="#loc_117_1_117_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_1_117_15&#39;)"><span class="mpre">getSessionData</span></a><span class="mpre"> :: </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_31_6_31_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_31_6_31_17&#39;)"><span class="hl_tyconref"><span class="mpre">SessionData</span></span></a><span class="mpre">)
</span><a name="loc_117_1_117_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_1_117_15&#39;)"><span class="hl_fundecl"><span class="mpre">getSessionData</span></span></a><span class="mpre"> </span><a name="loc_117_16_117_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_16_117_19&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> = do
    </span><span class="hl_vardecl"><span class="mpre">ver</span></span><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_117_16_117_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_16_117_19&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.State.html#loc_165_1_165_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_165_1_165_11&#39;)"><span class="hl_varref"><span class="mpre">getVersion</span></span></a><span class="mpre">
    </span><a name="loc_119_5_119_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_5_119_8&#39;)"><span class="hl_vardecl"><span class="mpre">mms</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_117_16_117_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_16_117_19&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Control.Monad.State.Class.html#loc_95_1_95_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.State.Class.html#loc_95_1_95_5&#39;)"><span class="hl_varref"><span class="mpre">gets</span></span></a><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_66_7_66_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_66_7_66_22&#39;)"><span class="hl_varref"><span class="mpre">hstMasterSecret</span></span></a><span class="mpre">)
    </span><span class="hl_vardecl"><span class="mpre">tx</span></span><span class="mpre">  &lt;- </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="GHC.MVar.html#loc_116_1_116_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.MVar.html#loc_116_1_116_9&#39;)"><span class="hl_varref"><span class="mpre">readMVar</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Context.Internal.html#loc_98_7_98_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_98_7_98_17&#39;)"><span class="hl_varref"><span class="mpre">ctxTxState</span></span></a><span class="mpre"> </span><a href="#loc_117_16_117_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_117_16_117_19&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">)
    case </span><a href="#loc_119_5_119_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_5_119_8&#39;)"><span class="hl_varref"><span class="mpre">mms</span></span></a><span class="mpre"> of
        </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
        </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_vardecl"><span class="mpre">ms</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="warning" data-warning="ExpRecConstr (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Handshake/Common.hs&quot;, srcSpanStartLine = 123, srcSpanStartColumn = 36, srcSpanEndLine = 127, srcSpanEndColumn = 26}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Handshake/Common.hs&quot;, srcSpanStartLine = 124, srcSpanStartColumn = 25, srcSpanEndLine = 124, srcSpanEndColumn = 26},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Handshake/Comm"><span class="mpre">SessionData
                        { sessionVersion = ver
                        , sessionCipher  = cipherID $ fromJust &quot;cipher&quot; $ stCipher tx
                        , sessionSecret  = ms
                        }</span></span><span class="mpre">
</span></div></body></html>