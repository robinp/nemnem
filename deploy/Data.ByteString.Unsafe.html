<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="static/nemnem.css"><script src="static/jquery-2.0.3.min.js"></script><script src="static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE CPP #-}
#if __GLASGOW_HASKELL__
{-# LANGUAGE MagicHash #-}
#endif

</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : Data.ByteString.Unsafe</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Copyright   : (c) Don Stewart 2006-2008</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--               (c) Duncan Coutts 2006-2011</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD-style</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : dons00@gmail.com, duncan@community.haskell.org</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : provisional</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : non-portable</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- A module containing unsafe &#39;ByteString&#39; operations.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- While these functions have a stable API and you may use these functions in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- applications, do carefully consider the documented pre-conditions;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- incorrect use can break referential transparency or worse.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Data.ByteString.Unsafe (

        </span><span class="hl_comment"><span class="mpre">-- * Unchecked access</span></span><span class="mpre">
        unsafeHead,             </span><span class="hl_comment"><span class="mpre">-- :: ByteString -&gt; Word8</span></span><span class="mpre">
        unsafeTail,             </span><span class="hl_comment"><span class="mpre">-- :: ByteString -&gt; ByteString</span></span><span class="mpre">
        unsafeInit,             </span><span class="hl_comment"><span class="mpre">-- :: ByteString -&gt; ByteString</span></span><span class="mpre">
        unsafeLast,             </span><span class="hl_comment"><span class="mpre">-- :: ByteString -&gt; Word8</span></span><span class="mpre">
        unsafeIndex,            </span><span class="hl_comment"><span class="mpre">-- :: ByteString -&gt; Int -&gt; Word8</span></span><span class="mpre">
        unsafeTake,             </span><span class="hl_comment"><span class="mpre">-- :: Int -&gt; ByteString -&gt; ByteString</span></span><span class="mpre">
        unsafeDrop,             </span><span class="hl_comment"><span class="mpre">-- :: Int -&gt; ByteString -&gt; ByteString</span></span><span class="mpre">

        </span><span class="hl_comment"><span class="mpre">-- * Low level interaction with CStrings</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- ** Using ByteStrings with functions for CStrings</span></span><span class="mpre">
        unsafeUseAsCString,     </span><span class="hl_comment"><span class="mpre">-- :: ByteString -&gt; (CString -&gt; IO a) -&gt; IO a</span></span><span class="mpre">
        unsafeUseAsCStringLen,  </span><span class="hl_comment"><span class="mpre">-- :: ByteString -&gt; (CStringLen -&gt; IO a) -&gt; IO a</span></span><span class="mpre">

        </span><span class="hl_comment"><span class="mpre">-- ** Converting CStrings to ByteStrings</span></span><span class="mpre">
        unsafePackCString,      </span><span class="hl_comment"><span class="mpre">-- :: CString -&gt; IO ByteString</span></span><span class="mpre">
        unsafePackCStringLen,   </span><span class="hl_comment"><span class="mpre">-- :: CStringLen -&gt; IO ByteString</span></span><span class="mpre">
        unsafePackMallocCString,</span><span class="hl_comment"><span class="mpre">-- :: CString -&gt; IO ByteString</span></span><span class="mpre">
        unsafePackMallocCStringLen, </span><span class="hl_comment"><span class="mpre">-- :: CStringLen -&gt; IO ByteString</span></span><span class="mpre">

#if defined(__GLASGOW_HASKELL__)
        unsafePackAddress,          </span><span class="hl_comment"><span class="mpre">-- :: Addr# -&gt; IO ByteString</span></span><span class="mpre">
        unsafePackAddressLen,       </span><span class="hl_comment"><span class="mpre">-- :: Int -&gt; Addr# -&gt; IO ByteString</span></span><span class="mpre">
        unsafePackCStringFinalizer, </span><span class="hl_comment"><span class="mpre">-- :: Ptr Word8 -&gt; Int -&gt; IO () -&gt; IO ByteString</span></span><span class="mpre">
        unsafeFinalize,             </span><span class="hl_comment"><span class="mpre">-- :: ByteString -&gt; IO ()</span></span><span class="mpre">
#endif

  ) where

import Data.ByteString.Internal

import Foreign.ForeignPtr       (newForeignPtr_, </span><a href="Foreign.ForeignPtr.Imp.html#loc_63_1_63_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_63_1_63_14&#39;)"><span class="mpre">newForeignPtr</span></a><span class="mpre">, </span><a href="Foreign.ForeignPtr.Imp.html#loc_88_1_88_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_88_1_88_15&#39;)"><span class="mpre">withForeignPtr</span></a><span class="mpre">)
import Foreign.Ptr              (Ptr, plusPtr, castPtr)

import Foreign.Storable         (Storable(..))
import Foreign.C.String         (CString, CStringLen)

#ifndef __NHC__
import Control.Exception        (assert)
#endif

import Data.Word                (Word8)

#if defined(__GLASGOW_HASKELL__)
import qualified Foreign.ForeignPtr as FC (finalizeForeignPtr)
import qualified Foreign.Concurrent as FC (</span><a href="Foreign.Concurrent.html#loc_44_1_44_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Concurrent.html#loc_44_1_44_14&#39;)"><span class="mpre">newForeignPtr</span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">--import Data.Generics            (Data(..), Typeable(..))</span></span><span class="mpre">

import GHC.Prim                 (</span><a href="GHC.Prim.html#loc_2279_6_2279_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Prim.html#loc_2279_6_2279_11&#39;)"><span class="mpre">Addr#</span></a><span class="mpre">)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/bytestring-0.10.4.0/Data/ByteString/Unsafe.hs&quot;, srcSpanStartLine = 73, srcSpanStartColumn = 8, srcSpanEndLine = 73, srcSpanEndColumn = 15}, srcInfoPoints = []}) &quot;GHC.Ptr&quot;"><span class="mpre">GHC.Ptr</span></span><span class="mpre">                  (Ptr(..))
#endif

</span><span class="hl_comment"><span class="mpre">-- An alternative to Control.Exception (assert) for nhc98</span></span><span class="mpre">
#ifdef __NHC__
#define assert        assertS &quot;__FILE__ : __LINE__&quot;
</span><a href="#loc_80_1_80_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_1_80_8&#39;)"><span class="mpre">assertS</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">String</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Bool</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_80_1_80_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_1_80_8&#39;)"><span class="hl_fundecl"><span class="mpre">assertS</span></span></a><span class="mpre"> _ </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">  = </span><span class="hl_varref"><span class="mpre">id</span></span><span class="mpre">
</span><a href="#loc_80_1_80_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_80_1_80_8&#39;)"><span class="hl_fundecl"><span class="mpre">assertS</span></span></a><span class="mpre"> </span><a name="loc_81_9_81_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_9_81_10&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;assertion failed at &quot;</span></span><span class="hl_infix"><span class="mpre">++</span></span><a href="#loc_81_9_81_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_81_9_81_10&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">)
#endif

</span><span class="hl_comment"><span class="mpre">-- -----------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Useful macros, until we have bang patterns</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">

#define STRICT1(f) f a | a `seq` False = undefined
#define STRICT2(f) f a b | a `seq` b `seq` False = undefined
#define STRICT3(f) f a b c | a `seq` b `seq` c `seq` False = undefined
#define STRICT4(f) f a b c d | a `seq` b `seq` c `seq` d `seq` False = undefined
#define STRICT5(f) f a b c d e | a `seq` b `seq` c `seq` d `seq` e `seq` False = undefined

</span><span class="hl_comment"><span class="mpre">-- ---------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Extensions to the basic interface</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A variety of &#39;head&#39; for non-empty ByteStrings. &#39;unsafeHead&#39; omits the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- check for the empty case, so there is an obligation on the programmer</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to provide a proof that the ByteString is non-empty.</span></span><span class="mpre">
</span><a href="#loc_104_1_104_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_1_104_11&#39;)"><span class="mpre">unsafeHead</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">
</span><a name="loc_104_1_104_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_1_104_11&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeHead</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a name="loc_104_16_104_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_16_104_17&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> </span><a name="loc_104_18_104_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_18_104_19&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_104_20_104_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_20_104_21&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre"> (</span><a href="#loc_104_20_104_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_20_104_21&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
    </span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Foreign.ForeignPtr.Imp.html#loc_88_1_88_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_88_1_88_15&#39;)"><span class="hl_varref"><span class="mpre">withForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_104_16_104_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_16_104_17&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_105_43_105_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_43_105_44&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">peekByteOff</span></span><span class="mpre"> </span><a href="#loc_105_43_105_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_105_43_105_44&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> </span><a href="#loc_104_18_104_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_18_104_19&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_104_1_104_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_1_104_11&#39;)"><span class="mpre">unsafeHead</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A variety of &#39;tail&#39; for non-empty ByteStrings. &#39;unsafeTail&#39; omits the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- check for the empty case. As with &#39;unsafeHead&#39;, the programmer must</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- provide a separate proof that the ByteString is non-empty.</span></span><span class="mpre">
</span><a href="#loc_112_1_112_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_11&#39;)"><span class="mpre">unsafeTail</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre">
</span><a name="loc_112_1_112_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_11&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeTail</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a name="loc_112_16_112_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_16_112_18&#39;)"><span class="hl_vardecl"><span class="mpre">ps</span></span></a><span class="mpre"> </span><a name="loc_112_19_112_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_19_112_20&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_112_21_112_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_21_112_22&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre"> (</span><a href="#loc_112_21_112_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_21_112_22&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a href="#loc_112_16_112_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_16_112_18&#39;)"><span class="hl_varref"><span class="mpre">ps</span></span></a><span class="mpre"> (</span><a href="#loc_112_19_112_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_19_112_20&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">) (</span><a href="#loc_112_21_112_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_21_112_22&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_112_1_112_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_1_112_11&#39;)"><span class="mpre">unsafeTail</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A variety of &#39;init&#39; for non-empty ByteStrings. &#39;unsafeInit&#39; omits the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- check for the empty case. As with &#39;unsafeHead&#39;, the programmer must</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- provide a separate proof that the ByteString is non-empty.</span></span><span class="mpre">
</span><a href="#loc_119_1_119_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_11&#39;)"><span class="mpre">unsafeInit</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre">
</span><a name="loc_119_1_119_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_11&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeInit</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a name="loc_119_16_119_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_16_119_18&#39;)"><span class="hl_vardecl"><span class="mpre">ps</span></span></a><span class="mpre"> </span><a name="loc_119_19_119_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_19_119_20&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_119_21_119_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_21_119_22&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre"> (</span><a href="#loc_119_21_119_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_21_119_22&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a href="#loc_119_16_119_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_16_119_18&#39;)"><span class="hl_varref"><span class="mpre">ps</span></span></a><span class="mpre"> </span><a href="#loc_119_19_119_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_19_119_20&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> (</span><a href="#loc_119_21_119_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_21_119_22&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_119_1_119_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_11&#39;)"><span class="mpre">unsafeInit</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A variety of &#39;last&#39; for non-empty ByteStrings. &#39;unsafeLast&#39; omits the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- check for the empty case. As with &#39;unsafeHead&#39;, the programmer must</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- provide a separate proof that the ByteString is non-empty.</span></span><span class="mpre">
</span><a href="#loc_126_1_126_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_1_126_11&#39;)"><span class="mpre">unsafeLast</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">
</span><a name="loc_126_1_126_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_1_126_11&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeLast</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a name="loc_126_16_126_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_16_126_17&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> </span><a name="loc_126_18_126_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_18_126_19&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_126_20_126_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_20_126_21&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre"> (</span><a href="#loc_126_20_126_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_20_126_21&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
    </span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Foreign.ForeignPtr.Imp.html#loc_88_1_88_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_88_1_88_15&#39;)"><span class="hl_varref"><span class="mpre">withForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_126_16_126_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_16_126_17&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_127_43_127_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_43_127_44&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">peekByteOff</span></span><span class="mpre"> </span><a href="#loc_127_43_127_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_43_127_44&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> (</span><a href="#loc_126_18_126_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_18_126_19&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_126_20_126_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_20_126_21&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><span class="hl_num"><span class="mpre">1</span></span><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_126_1_126_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_126_1_126_11&#39;)"><span class="mpre">unsafeLast</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Unsafe &#39;ByteString&#39; index (subscript) operator, starting from 0, returning a &#39;Word8&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This omits the bounds check, which means there is an accompanying</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- obligation on the programmer to ensure the bounds are checked in some</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- other way.</span></span><span class="mpre">
</span><a href="#loc_135_1_135_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_1_135_12&#39;)"><span class="mpre">unsafeIndex</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre">
</span><a name="loc_135_1_135_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_1_135_12&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeIndex</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a name="loc_135_17_135_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_17_135_18&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> </span><a name="loc_135_19_135_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_19_135_20&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_135_21_135_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_21_135_22&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) </span><a name="loc_135_24_135_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_24_135_25&#39;)"><span class="hl_vardecl"><span class="mpre">i</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre"> (</span><a href="#loc_135_24_135_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_24_135_25&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;=</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_135_24_135_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_24_135_25&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><a href="#loc_135_21_135_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_21_135_22&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
    </span><a href="Data.ByteString.Internal.html#loc_592_1_592_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_592_1_592_16&#39;)"><span class="hl_varref"><span class="mpre">inlinePerformIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Foreign.ForeignPtr.Imp.html#loc_88_1_88_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_88_1_88_15&#39;)"><span class="hl_varref"><span class="mpre">withForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_135_17_135_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_17_135_18&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_136_43_136_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_43_136_44&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">peekByteOff</span></span><span class="mpre"> </span><a href="#loc_136_43_136_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_136_43_136_44&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> (</span><a href="#loc_135_19_135_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_19_135_20&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_135_24_135_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_24_135_25&#39;)"><span class="hl_varref"><span class="mpre">i</span></span></a><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_135_1_135_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_135_1_135_12&#39;)"><span class="mpre">unsafeIndex</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A variety of &#39;take&#39; which omits the checks on @n@ so there is an</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- obligation on the programmer to provide a proof that @0 &lt;= n &lt;= &#39;length&#39; xs@.</span></span><span class="mpre">
</span><a href="#loc_142_1_142_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_1_142_11&#39;)"><span class="mpre">unsafeTake</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre">
</span><a name="loc_142_1_142_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_1_142_11&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeTake</span></span></a><span class="mpre"> </span><a name="loc_142_12_142_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_12_142_13&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a name="loc_142_18_142_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_18_142_19&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> </span><a name="loc_142_20_142_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_20_142_21&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_142_22_142_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_22_142_23&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre"> (</span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_142_12_142_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_12_142_13&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_142_12_142_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_12_142_13&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_142_22_142_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_22_142_23&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a href="#loc_142_18_142_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_18_142_19&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> </span><a href="#loc_142_20_142_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_20_142_21&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> </span><a href="#loc_142_12_142_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_12_142_13&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_142_1_142_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_142_1_142_11&#39;)"><span class="mpre">unsafeTake</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A variety of &#39;drop&#39; which omits the checks on @n@ so there is an</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- obligation on the programmer to provide a proof that @0 &lt;= n &lt;= &#39;length&#39; xs@.</span></span><span class="mpre">
</span><a href="#loc_148_1_148_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_1_148_11&#39;)"><span class="mpre">unsafeDrop</span></a><span class="mpre">  :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre"> -&gt; </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre">
</span><a name="loc_148_1_148_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_1_148_11&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeDrop</span></span></a><span class="mpre"> </span><a name="loc_148_12_148_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_12_148_13&#39;)"><span class="hl_vardecl"><span class="mpre">n</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a name="loc_148_18_148_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_18_148_19&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> </span><a name="loc_148_20_148_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_20_148_21&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_148_22_148_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_22_148_23&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) = </span><span class="hl_varref"><span class="mpre">assert</span></span><span class="mpre"> (</span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_148_12_148_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_12_148_13&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&amp;&amp;</span></span><span class="mpre"> </span><a href="#loc_148_12_148_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_12_148_13&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;=</span></span><span class="mpre"> </span><a href="#loc_148_22_148_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_22_148_23&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a href="#loc_148_18_148_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_18_148_19&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre"> (</span><a href="#loc_148_20_148_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_20_148_21&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="hl_infix"><span class="mpre">+</span></span><a href="#loc_148_12_148_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_12_148_13&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">) (</span><a href="#loc_148_22_148_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_22_148_23&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="hl_infix"><span class="mpre">-</span></span><a href="#loc_148_12_148_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_12_148_13&#39;)"><span class="hl_varref"><span class="mpre">n</span></span></a><span class="mpre">)
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_148_1_148_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_148_1_148_11&#39;)"><span class="mpre">unsafeDrop</span></a><span class="mpre"> #-}</span></span><span class="mpre">


#if defined(__GLASGOW_HASKELL__)
</span><span class="hl_comment"><span class="mpre">-- | /O(1)/ &#39;unsafePackAddressLen&#39; provides constant-time construction of</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;ByteString&#39;s, which is ideal for string literals. It packs a sequence</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- of bytes into a @ByteString@, given a raw &#39;Addr#&#39; to the string, and</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- the length of the string.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function is /unsafe/ in two ways:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * the length argument is assumed to be correct. If the length</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- argument is incorrect, it is possible to overstep the end of the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- byte array.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * if the underying Addr# is later modified, this change will be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- reflected in resulting @ByteString@, breaking referential</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- transparency.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- If in doubt, don&#39;t use this function.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_171_1_171_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_171_1_171_21&#39;)"><span class="mpre">unsafePackAddressLen</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><a href="GHC.Prim.html#loc_2279_6_2279_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Prim.html#loc_2279_6_2279_11&#39;)"><span class="hl_tyconref"><span class="mpre">Addr#</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre">
</span><a name="loc_171_1_171_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_171_1_171_21&#39;)"><span class="hl_fundecl"><span class="mpre">unsafePackAddressLen</span></span></a><span class="mpre"> </span><a name="loc_171_22_171_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_171_22_171_25&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre"> </span><a name="loc_171_26_171_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_171_26_171_31&#39;)"><span class="hl_vardecl"><span class="mpre">addr#</span></span></a><span class="mpre"> = do
    </span><a name="loc_172_5_172_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_5_172_6&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newForeignPtr_</span></span><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><a href="#loc_171_26_171_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_171_26_171_31&#39;)"><span class="hl_varref"><span class="mpre">addr#</span></span></a><span class="mpre">)
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a href="#loc_172_5_172_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_5_172_6&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><a href="#loc_171_22_171_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_171_22_171_25&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">
</span><span class="hl_pragma"><span class="mpre">{-# INLINE </span><a href="#loc_171_1_171_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_171_1_171_21&#39;)"><span class="mpre">unsafePackAddressLen</span></a><span class="mpre"> #-}</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(1)/ Construct a &#39;ByteString&#39; given a Ptr Word8 to a buffer, a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- length, and an IO action representing a finalizer. This function is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- not available on Hugs.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function is /unsafe/, it is possible to break referential</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- transparency by modifying the underlying buffer pointed to by the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- first argument. Any changes to the original buffer will be reflected</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- in the resulting @ByteString@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_186_1_186_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_1_186_27&#39;)"><span class="mpre">unsafePackCStringFinalizer</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Ptr</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Word8</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre">
</span><a name="loc_186_1_186_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_1_186_27&#39;)"><span class="hl_fundecl"><span class="mpre">unsafePackCStringFinalizer</span></span></a><span class="mpre"> </span><a name="loc_186_28_186_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_28_186_29&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> </span><a name="loc_186_30_186_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_30_186_31&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre"> </span><a name="loc_186_32_186_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_32_186_33&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = do
    </span><a name="loc_187_5_187_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_187_5_187_7&#39;)"><span class="hl_vardecl"><span class="mpre">fp</span></span></a><span class="mpre"> &lt;- </span><a href="Foreign.Concurrent.html#loc_44_1_44_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.Concurrent.html#loc_44_1_44_14&#39;)"><span class="hl_varref"><span class="mpre">FC.newForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_186_28_186_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_28_186_29&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> </span><a href="#loc_186_32_186_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_32_186_33&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a href="#loc_187_5_187_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_187_5_187_7&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><a href="#loc_186_30_186_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_30_186_31&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Explicitly run the finaliser associated with a &#39;ByteString&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- References to this value after finalisation may generate invalid memory</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- references.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function is /unsafe/, as there may be other</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- &#39;ByteStrings&#39; referring to the same underlying pages. If you use</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- this, you need to have a proof of some kind that all &#39;ByteString&#39;s</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- ever generated from the underlying byte array are no longer live.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_200_1_200_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_1_200_15&#39;)"><span class="mpre">unsafeFinalize</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_200_1_200_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_1_200_15&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeFinalize</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a name="loc_200_20_200_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_20_200_21&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> _ _) = </span><span class="hl_varref"><span class="mpre">FC.finalizeForeignPtr</span></span><span class="mpre"> </span><a href="#loc_200_20_200_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_200_20_200_21&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">

#endif

</span><span class="hl_comment"><span class="mpre">------------------------------------------------------------------------</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Packing CStrings into ByteStrings</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(n)/ Build a @ByteString@ from a @CString@. This value will have /no/</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- finalizer associated to it, and will not be garbage collected by</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Haskell. The ByteString length is calculated using /strlen(3)/,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- and thus the complexity is a /O(n)/.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function is /unsafe/. If the @CString@ is later modified, this</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- change will be reflected in the resulting @ByteString@, breaking</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- referential transparency.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_217_1_217_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_1_217_18&#39;)"><span class="mpre">unsafePackCString</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre">
</span><a name="loc_217_1_217_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_1_217_18&#39;)"><span class="hl_fundecl"><span class="mpre">unsafePackCString</span></span></a><span class="mpre"> </span><a name="loc_217_19_217_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_19_217_23&#39;)"><span class="hl_vardecl"><span class="mpre">cstr</span></span></a><span class="mpre"> = do
    </span><a name="loc_218_5_218_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_5_218_7&#39;)"><span class="hl_vardecl"><span class="mpre">fp</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newForeignPtr_</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_217_19_217_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_19_217_23&#39;)"><span class="hl_varref"><span class="mpre">cstr</span></span></a><span class="mpre">)
    </span><a name="loc_219_5_219_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_5_219_6&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">c_strlen</span></span><span class="mpre"> </span><a href="#loc_217_19_217_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_217_19_217_23&#39;)"><span class="hl_varref"><span class="mpre">cstr</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a href="#loc_218_5_218_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_218_5_218_7&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_219_5_219_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_219_5_219_6&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | /O(1)/ Build a @ByteString@ from a @CStringLen@. This value will</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- have /no/ finalizer associated with it, and will not be garbage</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- collected by Haskell. This operation has /O(1)/ complexity as we</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- already know the final size, so no /strlen(3)/ is required.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This funtion is /unsafe/. If the original @CStringLen@ is later</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- modified, this change will be reflected in the resulting @ByteString@,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- breaking referential transparency.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_232_1_232_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_232_1_232_21&#39;)"><span class="mpre">unsafePackCStringLen</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre">
</span><a name="loc_232_1_232_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_232_1_232_21&#39;)"><span class="hl_fundecl"><span class="mpre">unsafePackCStringLen</span></span></a><span class="mpre"> (</span><a name="loc_232_23_232_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_232_23_232_26&#39;)"><span class="hl_vardecl"><span class="mpre">ptr</span></span></a><span class="mpre">,</span><a name="loc_232_27_232_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_232_27_232_30&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre">) = do
    </span><a name="loc_233_5_233_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_233_5_233_7&#39;)"><span class="hl_vardecl"><span class="mpre">fp</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">newForeignPtr_</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_232_23_232_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_232_23_232_26&#39;)"><span class="hl_varref"><span class="mpre">ptr</span></span></a><span class="mpre">)
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a href="#loc_233_5_233_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_233_5_233_7&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_232_27_232_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_232_27_232_30&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | /O(n)/ Build a @ByteString@ from a malloced @CString@. This value will</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- have a @free(3)@ finalizer associated to it.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This funtion is /unsafe/. If the original @CString@ is later</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- modified, this change will be reflected in the resulting @ByteString@,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- breaking referential transparency.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function is also unsafe if you call its finalizer twice,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- which will result in a /double free/ error, or if you pass it</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- a CString not allocated with &#39;malloc&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_248_1_248_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_1_248_24&#39;)"><span class="mpre">unsafePackMallocCString</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre">
</span><a name="loc_248_1_248_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_1_248_24&#39;)"><span class="hl_fundecl"><span class="mpre">unsafePackMallocCString</span></span></a><span class="mpre"> </span><a name="loc_248_25_248_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_25_248_29&#39;)"><span class="hl_vardecl"><span class="mpre">cstr</span></span></a><span class="mpre"> = do
    </span><a name="loc_249_5_249_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_5_249_7&#39;)"><span class="hl_vardecl"><span class="mpre">fp</span></span></a><span class="mpre"> &lt;- </span><a href="Foreign.ForeignPtr.Imp.html#loc_63_1_63_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_63_1_63_14&#39;)"><span class="hl_varref"><span class="mpre">newForeignPtr</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">c_free_finalizer</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_248_25_248_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_25_248_29&#39;)"><span class="hl_varref"><span class="mpre">cstr</span></span></a><span class="mpre">)
    </span><a name="loc_250_5_250_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_250_5_250_8&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">c_strlen</span></span><span class="mpre"> </span><a href="#loc_248_25_248_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_25_248_29&#39;)"><span class="hl_varref"><span class="mpre">cstr</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a href="#loc_249_5_249_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_249_5_249_7&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fromIntegral</span></span><span class="mpre"> </span><a href="#loc_250_5_250_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_250_5_250_8&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | /O(n)/ Build a @ByteString@ from a malloced @CStringLen@. This</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- value will have a @free(3)@ finalizer associated to it.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This funtion is /unsafe/. If the original @CString@ is later</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- modified, this change will be reflected in the resulting @ByteString@,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- breaking referential transparency.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function is also unsafe if you call its finalizer twice,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- which will result in a /double free/ error, or if you pass it</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- a CString not allocated with &#39;malloc&#39;.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_265_1_265_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_1_265_27&#39;)"><span class="mpre">unsafePackMallocCStringLen</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre">
</span><a name="loc_265_1_265_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_1_265_27&#39;)"><span class="hl_fundecl"><span class="mpre">unsafePackMallocCStringLen</span></span></a><span class="mpre"> (</span><a name="loc_265_29_265_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_29_265_33&#39;)"><span class="hl_vardecl"><span class="mpre">cstr</span></span></a><span class="mpre">, </span><a name="loc_265_35_265_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_35_265_38&#39;)"><span class="hl_vardecl"><span class="mpre">len</span></span></a><span class="mpre">) = do
    </span><a name="loc_266_5_266_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_266_5_266_7&#39;)"><span class="hl_vardecl"><span class="mpre">fp</span></span></a><span class="mpre"> &lt;- </span><a href="Foreign.ForeignPtr.Imp.html#loc_63_1_63_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_63_1_63_14&#39;)"><span class="hl_varref"><span class="mpre">newForeignPtr</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">c_free_finalizer</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_265_29_265_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_29_265_33&#39;)"><span class="hl_varref"><span class="mpre">cstr</span></span></a><span class="mpre">)
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$!</span></span><span class="mpre"> </span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a href="#loc_266_5_266_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_266_5_266_7&#39;)"><span class="hl_varref"><span class="mpre">fp</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">0</span></span><span class="mpre"> </span><a href="#loc_265_35_265_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_265_35_265_38&#39;)"><span class="hl_varref"><span class="mpre">len</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- ---------------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | /O(1) construction/ Use a @ByteString@ with a function requiring a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @CString@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function does zero copying, and merely unwraps a @ByteString@ to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- appear as a @CString@. It is /unsafe/ in two ways:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * After calling this function the @CString@ shares the underlying</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- byte buffer with the original @ByteString@. Thus modifying the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @CString@, either in C, or using poke, will cause the contents of the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @ByteString@ to change, breaking referential transparency. Other</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @ByteStrings@ created by sharing (such as those produced via &#39;take&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- or &#39;drop&#39;) will also reflect these changes. Modifying the @CString@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- will break referential transparency. To avoid this, use</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @useAsCString@, which makes a copy of the original @ByteString@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * @CStrings@ are often passed to functions that require them to be</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- null-terminated. If the original @ByteString@ wasn&#39;t null terminated,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- neither will the @CString@ be. It is the programmers responsibility</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- to guarantee that the @ByteString@ is indeed null terminated. If in</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- doubt, use @useAsCString@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_293_1_293_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_1_293_19&#39;)"><span class="mpre">unsafeUseAsCString</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">CString</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_293_1_293_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_1_293_19&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeUseAsCString</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a name="loc_293_24_293_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_24_293_26&#39;)"><span class="hl_vardecl"><span class="mpre">ps</span></span></a><span class="mpre"> </span><a name="loc_293_27_293_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_27_293_28&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> _) </span><a name="loc_293_32_293_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_32_293_34&#39;)"><span class="hl_vardecl"><span class="mpre">ac</span></span></a><span class="mpre"> = </span><a href="Foreign.ForeignPtr.Imp.html#loc_88_1_88_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_88_1_88_15&#39;)"><span class="hl_varref"><span class="mpre">withForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_293_24_293_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_24_293_26&#39;)"><span class="hl_varref"><span class="mpre">ps</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_293_58_293_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_58_293_59&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_293_32_293_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_32_293_34&#39;)"><span class="hl_varref"><span class="mpre">ac</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_293_58_293_59" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_58_293_59&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_293_27_293_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_27_293_28&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | /O(1) construction/ Use a @ByteString@ with a function requiring a</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @CStringLen@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This function does zero copying, and merely unwraps a @ByteString@ to</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- appear as a @CStringLen@. It is /unsafe/:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * After calling this function the @CStringLen@ shares the underlying</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- byte buffer with the original @ByteString@. Thus modifying the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @CStringLen@, either in C, or using poke, will cause the contents of the</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @ByteString@ to change, breaking referential transparency. Other</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @ByteStrings@ created by sharing (such as those produced via &#39;take&#39;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- or &#39;drop&#39;) will also reflect these changes. Modifying the @CStringLen@</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- will break referential transparency. To avoid this, use</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- @useAsCStringLen@, which makes a copy of the original @ByteString@.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_311_1_311_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_1_311_22&#39;)"><span class="mpre">unsafeUseAsCStringLen</span></a><span class="mpre"> :: </span><a href="Data.ByteString.Internal.html#loc_193_6_193_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_6_193_16&#39;)"><span class="hl_tyconref"><span class="mpre">ByteString</span></span></a><span class="mpre"> -&gt; (</span><span class="hl_tyconref"><span class="mpre">CStringLen</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_311_1_311_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_1_311_22&#39;)"><span class="hl_fundecl"><span class="mpre">unsafeUseAsCStringLen</span></span></a><span class="mpre"> (</span><a href="Data.ByteString.Internal.html#loc_193_19_193_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.ByteString.Internal.html#loc_193_19_193_21&#39;)"><span class="hl_conref"><span class="mpre">PS</span></span></a><span class="mpre"> </span><a name="loc_311_27_311_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_27_311_29&#39;)"><span class="hl_vardecl"><span class="mpre">ps</span></span></a><span class="mpre"> </span><a name="loc_311_30_311_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_30_311_31&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> </span><a name="loc_311_32_311_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_32_311_33&#39;)"><span class="hl_vardecl"><span class="mpre">l</span></span></a><span class="mpre">) </span><a name="loc_311_35_311_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_35_311_36&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = </span><a href="Foreign.ForeignPtr.Imp.html#loc_88_1_88_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Foreign.ForeignPtr.Imp.html#loc_88_1_88_15&#39;)"><span class="hl_varref"><span class="mpre">withForeignPtr</span></span></a><span class="mpre"> </span><a href="#loc_311_27_311_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_27_311_29&#39;)"><span class="hl_varref"><span class="mpre">ps</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_311_60_311_61" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_60_311_61&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_311_35_311_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_35_311_36&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">castPtr</span></span><span class="mpre"> </span><a href="#loc_311_60_311_61" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_60_311_61&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">`plusPtr`</span></span><span class="mpre"> </span><a href="#loc_311_30_311_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_30_311_31&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre">,</span><a href="#loc_311_32_311_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_311_32_311_33&#39;)"><span class="hl_varref"><span class="mpre">l</span></span></a><span class="mpre">)
</span></div></body></html>