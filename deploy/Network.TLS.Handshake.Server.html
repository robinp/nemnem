<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE DeriveDataTypeable, OverloadedStrings #-}
</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Module      : Network.TLS.Handshake.Server</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- License     : BSD-style</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Maintainer  : Vincent Hanquez &lt;vincent@snarc.org&gt;</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Stability   : experimental</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Portability : unknown</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
module Network.TLS.Handshake.Server
    ( handshakeServer
    , handshakeServerWith
    ) where

import Network.TLS.Parameters
import Network.TLS.Context.Internal
import Network.TLS.Session
import Network.TLS.Struct
import Network.TLS.Cipher
import Network.TLS.Compression
import Network.TLS.Credentials
import Network.TLS.Extension
import Network.TLS.Util (</span><a href="Network.TLS.Util.html#loc_81_1_81_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Util.html#loc_81_1_81_15&#39;)"><span class="mpre">catchException</span></a><span class="mpre">, </span><a href="Network.TLS.Util.html#loc_53_1_53_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Util.html#loc_53_1_53_9&#39;)"><span class="mpre">fromJust</span></a><span class="mpre">)
import Network.TLS.IO
import Network.TLS.Types
import Network.TLS.State hiding (</span><a href="Network.TLS.State.html#loc_186_1_186_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_186_1_186_22&#39;)"><span class="mpre">getNegotiatedProtocol</span></a><span class="mpre">)
import Network.TLS.Handshake.State
import Network.TLS.Handshake.Process
import Network.TLS.Handshake.Key
import Network.TLS.Measurement
import Data.Maybe (</span><a href="Data.Maybe.html#loc_80_1_80_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_80_1_80_7&#39;)"><span class="mpre">isJust</span></a><span class="mpre">)
import Data.List (</span><a href="Data.List.html#loc_412_1_412_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.List.html#loc_412_1_412_10&#39;)"><span class="mpre">intersect</span></a><span class="mpre">, </span><a href="Data.List.html#loc_810_1_810_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.List.html#loc_810_1_810_7&#39;)"><span class="mpre">sortBy</span></a><span class="mpre">)
import qualified </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Handshake/Server.hs&quot;, srcSpanStartLine = 32, srcSpanStartColumn = 18, srcSpanEndLine = 32, srcSpanEndColumn = 33}, srcInfoPoints = []}) &quot;Data.ByteString&quot;"><span class="mpre">Data.ByteString</span></span><span class="mpre"> as B
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Handshake/Server.hs&quot;, srcSpanStartLine = 33, srcSpanStartColumn = 8, srcSpanEndLine = 33, srcSpanEndColumn = 29}, srcInfoPoints = []}) &quot;Data.ByteString.Char8&quot;"><span class="mpre">Data.ByteString.Char8</span></span><span class="mpre"> ()

import Control.Applicative (</span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="mpre">(&lt;$&gt;)</span></a><span class="mpre">)
import Control.Monad.State

import Network.TLS.Handshake.Signature
import Network.TLS.Handshake.Common
import Network.TLS.Handshake.Certificate
import Network.TLS.X509

</span><span class="hl_comment"><span class="mpre">-- Put the server context in handshake mode.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Expect to receive as first packet a client hello handshake message</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This is just a helper to pop the next message from the recv layer,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- and call handshakeServerWith.</span></span><span class="mpre">
</span><a href="#loc_50_1_50_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_1_50_16&#39;)"><span class="mpre">handshakeServer</span></a><span class="mpre"> :: </span><span class="warning" data-warning="ContextCxSingle (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Handshake/Server.hs&quot;, srcSpanStartLine = 49, srcSpanStartColumn = 20, srcSpanEndLine = 49, srcSpanEndColumn = 32}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Handshake/Server.hs&quot;, srcSpanStartLine = 49, srcSpanStartColumn = 30, srcSpanEndLine = 49, srcSpanEndColumn = 32}]}) (ClassA (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tl"><span class="mpre">MonadIO m =&gt;</span></span><span class="mpre"> </span><a href="Network.TLS.Parameters.html#loc_76_6_76_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_76_6_76_18&#39;)"><span class="hl_tyconref"><span class="mpre">ServerParams</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyvar"><span class="mpre">m</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_50_1_50_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_1_50_16&#39;)"><span class="hl_fundecl"><span class="mpre">handshakeServer</span></span></a><span class="mpre"> </span><a name="loc_50_17_50_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_17_50_24&#39;)"><span class="hl_vardecl"><span class="mpre">sparams</span></span></a><span class="mpre"> </span><a name="loc_50_25_50_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_25_50_28&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> = </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
    </span><a name="loc_51_5_51_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_5_51_8&#39;)"><span class="hl_vardecl"><span class="mpre">hss</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Handshake.Common.html#loc_95_1_95_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_95_1_95_20&#39;)"><span class="hl_varref"><span class="mpre">recvPacketHandshake</span></span></a><span class="mpre"> </span><a href="#loc_50_25_50_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_25_50_28&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
    case </span><a href="#loc_51_5_51_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_5_51_8&#39;)"><span class="hl_varref"><span class="mpre">hss</span></span></a><span class="mpre"> of
        [</span><a name="loc_53_10_53_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_10_53_12&#39;)"><span class="hl_vardecl"><span class="mpre">ch</span></span></a><span class="mpre">] -&gt; </span><a href="#loc_82_1_82_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_20&#39;)"><span class="hl_varref"><span class="mpre">handshakeServerWith</span></span></a><span class="mpre"> </span><a href="#loc_50_17_50_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_17_50_24&#39;)"><span class="hl_varref"><span class="mpre">sparams</span></span></a><span class="mpre"> </span><a href="#loc_50_25_50_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_25_50_28&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_53_10_53_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_53_10_53_12&#39;)"><span class="hl_varref"><span class="mpre">ch</span></span></a><span class="mpre">
        _    -&gt; </span><span class="hl_varref"><span class="mpre">fail</span></span><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;unexpected handshake received, excepting client hello and received &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_51_5_51_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_51_5_51_8&#39;)"><span class="hl_varref"><span class="mpre">hss</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Put the server context in handshake mode.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- Expect a client hello message as parameter.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- This is useful when the client hello has been already poped from the recv layer to inspect the packet.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- When the function returns, a new handshake has been succesfully negociated.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- On any error, a HandshakeFailed exception is raised.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- handshake protocol (&lt;- receiving, -&gt; sending, [] optional):</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--    (no session)           (session resumption)</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- client hello       &lt;- client hello</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      -&gt; server hello       -&gt; server hello</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      -&gt; [certificate]</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      -&gt; [server key xchg]</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      -&gt; [cert request]</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      -&gt; hello done</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- [certificate]</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- client key xchg</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- [cert verify]</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- change cipher      -&gt; change cipher</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- [NPN]</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- finish             -&gt; finish</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      -&gt; change cipher      &lt;- change cipher</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      -&gt; finish             &lt;- finish</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_82_1_82_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_20&#39;)"><span class="mpre">handshakeServerWith</span></a><span class="mpre"> :: </span><a href="Network.TLS.Parameters.html#loc_76_6_76_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_76_6_76_18&#39;)"><span class="hl_tyconref"><span class="mpre">ServerParams</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Struct.html#loc_252_6_252_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_252_6_252_15&#39;)"><span class="hl_tyconref"><span class="mpre">Handshake</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_82_1_82_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_20&#39;)"><span class="hl_fundecl"><span class="mpre">handshakeServerWith</span></span></a><span class="mpre"> </span><a name="loc_82_21_82_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_21_82_28&#39;)"><span class="hl_vardecl"><span class="mpre">sparams</span></span></a><span class="mpre"> </span><a name="loc_82_29_82_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_29_82_32&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a name="loc_82_33_82_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_33_82_44&#39;)"><span class="hl_specname"><span class="mpre">clientHello</span></span></a><span class="mpre">@(</span><a href="Network.TLS.Struct.html#loc_253_7_253_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_253_7_253_18&#39;)"><span class="hl_conref"><span class="mpre">ClientHello</span></span></a><span class="mpre"> </span><a name="loc_82_58_82_71" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_58_82_71&#39;)"><span class="hl_vardecl"><span class="mpre">clientVersion</span></span></a><span class="mpre"> _ </span><a name="loc_82_74_82_87" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_74_82_87&#39;)"><span class="hl_vardecl"><span class="mpre">clientSession</span></span></a><span class="mpre"> </span><a name="loc_82_88_82_95" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_88_82_95&#39;)"><span class="hl_vardecl"><span class="mpre">ciphers</span></span></a><span class="mpre"> </span><a name="loc_82_96_82_108" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_96_82_108&#39;)"><span class="hl_vardecl"><span class="mpre">compressions</span></span></a><span class="mpre"> </span><a name="loc_82_109_82_113" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_109_82_113&#39;)"><span class="hl_vardecl"><span class="mpre">exts</span></span></a><span class="mpre"> _) = do
    </span><span class="hl_comment"><span class="mpre">-- check if policy allow this new handshake to happens</span></span><span class="mpre">
    </span><a name="loc_84_5_84_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_5_84_24&#39;)"><span class="hl_vardecl"><span class="mpre">handshakeAuthorized</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_116_1_116_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_116_1_116_12&#39;)"><span class="hl_varref"><span class="mpre">withMeasure</span></span></a><span class="mpre"> </span><a href="#loc_82_29_82_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_29_82_32&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Parameters.html#loc_228_7_228_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_228_7_228_21&#39;)"><span class="hl_varref"><span class="mpre">onNewHandshake</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Parameters.html#loc_90_7_90_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_90_7_90_18&#39;)"><span class="hl_varref"><span class="mpre">serverHooks</span></span></a><span class="mpre"> </span><a href="#loc_82_21_82_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_21_82_28&#39;)"><span class="hl_varref"><span class="mpre">sparams</span></span></a><span class="mpre">)
    </span><a href="Control.Monad.html#loc_270_1_270_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_270_1_270_7&#39;)"><span class="hl_varref"><span class="mpre">unless</span></span></a><span class="mpre"> </span><a href="#loc_84_5_84_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_84_5_84_24&#39;)"><span class="hl_varref"><span class="mpre">handshakeAuthorized</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_125_7_125_28" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_125_7_125_28&#39;)"><span class="hl_conref"><span class="mpre">Error_HandshakePolicy</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;server: handshake denied&quot;</span></span><span class="mpre">)
    </span><a href="Network.TLS.Context.Internal.html#loc_111_1_111_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_111_1_111_14&#39;)"><span class="hl_varref"><span class="mpre">updateMeasure</span></span></a><span class="mpre"> </span><a href="#loc_82_29_82_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_29_82_32&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.Measurement.html#loc_45_1_45_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Measurement.html#loc_45_1_45_22&#39;)"><span class="hl_varref"><span class="mpre">incrementNbHandshakes</span></span></a><span class="mpre">

    </span><span class="hl_comment"><span class="mpre">-- Handle Client hello</span></span><span class="mpre">
    </span><a href="Network.TLS.Handshake.Process.html#loc_34_1_34_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Process.html#loc_34_1_34_17&#39;)"><span class="hl_varref"><span class="mpre">processHandshake</span></span></a><span class="mpre"> </span><a href="#loc_82_29_82_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_29_82_32&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_82_33_82_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_33_82_44&#39;)"><span class="hl_varref"><span class="mpre">clientHello</span></span></a><span class="mpre">

    </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><a href="#loc_82_58_82_71" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_58_82_71&#39;)"><span class="hl_varref"><span class="mpre">clientVersion</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_25_16_25_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_25_16_25_20&#39;)"><span class="hl_conref"><span class="mpre">SSL2</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_123_7_123_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_123_7_123_21&#39;)"><span class="hl_conref"><span class="mpre">Error_Protocol</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;ssl2 is not supported&quot;</span></span><span class="mpre">, </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">, </span><a href="Network.TLS.Struct.html#loc_200_7_200_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_200_7_200_22&#39;)"><span class="hl_conref"><span class="mpre">ProtocolVersion</span></span></a><span class="mpre">)
    </span><a name="loc_92_5_92_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_5_92_18&#39;)"><span class="hl_vardecl"><span class="mpre">chosenVersion</span></span></a><span class="mpre"> &lt;- case </span><a href="#loc_367_1_367_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_1_367_23&#39;)"><span class="hl_varref"><span class="mpre">findHighestVersionFrom</span></span></a><span class="mpre"> </span><a href="#loc_82_58_82_71" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_58_82_71&#39;)"><span class="hl_varref"><span class="mpre">clientVersion</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Parameters.html#loc_113_7_113_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_113_7_113_24&#39;)"><span class="hl_varref"><span class="mpre">supportedVersions</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_87_7_87_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_87_7_87_19&#39;)"><span class="hl_varref"><span class="mpre">ctxSupported</span></span></a><span class="mpre"> </span><a href="#loc_82_29_82_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_29_82_32&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">) of
                        </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_123_7_123_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_123_7_123_21&#39;)"><span class="hl_conref"><span class="mpre">Error_Protocol</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;client version &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_82_58_82_71" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_58_82_71&#39;)"><span class="hl_varref"><span class="mpre">clientVersion</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot; is not supported&quot;</span></span><span class="mpre">, </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">, </span><a href="Network.TLS.Struct.html#loc_200_7_200_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_200_7_200_22&#39;)"><span class="hl_conref"><span class="mpre">ProtocolVersion</span></span></a><span class="mpre">)
                        </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_94_30_94_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_30_94_31&#39;)"><span class="hl_vardecl"><span class="mpre">v</span></span></a><span class="mpre">  -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_94_30_94_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_94_30_94_31&#39;)"><span class="hl_varref"><span class="mpre">v</span></span></a><span class="mpre">

    </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><a href="#loc_118_9_118_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_9_118_24&#39;)"><span class="hl_varref"><span class="mpre">commonCipherIDs</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">==</span></span><span class="mpre"> []) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
        </span><a href="Network.TLS.Struct.html#loc_123_7_123_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_123_7_123_21&#39;)"><span class="hl_conref"><span class="mpre">Error_Protocol</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;no cipher in common with the client&quot;</span></span><span class="mpre">, </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">, </span><a href="Network.TLS.Struct.html#loc_188_7_188_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_188_7_188_23&#39;)"><span class="hl_conref"><span class="mpre">HandshakeFailure</span></span></a><span class="mpre">)
    </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">null</span></span><span class="mpre"> </span><a href="#loc_120_9_120_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_9_120_27&#39;)"><span class="hl_varref"><span class="mpre">commonCompressions</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre">
        </span><a href="Network.TLS.Struct.html#loc_123_7_123_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_123_7_123_21&#39;)"><span class="hl_conref"><span class="mpre">Error_Protocol</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;no compression in common with the client&quot;</span></span><span class="mpre">, </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">, </span><a href="Network.TLS.Struct.html#loc_188_7_188_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_188_7_188_23&#39;)"><span class="hl_conref"><span class="mpre">HandshakeFailure</span></span></a><span class="mpre">)

    let </span><a name="loc_101_9_101_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_9_101_31&#39;)"><span class="hl_vardecl"><span class="mpre">ciphersFilteredVersion</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">filter</span></span><span class="mpre"> (</span><a href="Network.TLS.Cipher.html#loc_98_1_98_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_98_1_98_24&#39;)"><span class="hl_varref"><span class="mpre">cipherAllowedForVersion</span></span></a><span class="mpre"> </span><a href="#loc_92_5_92_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_5_92_18&#39;)"><span class="hl_varref"><span class="mpre">chosenVersion</span></span></a><span class="mpre">) </span><a href="#loc_119_9_119_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_9_119_22&#39;)"><span class="hl_varref"><span class="mpre">commonCiphers</span></span></a><span class="mpre">
        </span><a name="loc_102_9_102_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_9_102_19&#39;)"><span class="hl_vardecl"><span class="mpre">usedCipher</span></span></a><span class="mpre"> = (</span><a href="Network.TLS.Parameters.html#loc_223_7_223_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_223_7_223_23&#39;)"><span class="hl_varref"><span class="mpre">onCipherChoosing</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Parameters.html#loc_90_7_90_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_90_7_90_18&#39;)"><span class="hl_varref"><span class="mpre">serverHooks</span></span></a><span class="mpre"> </span><a href="#loc_82_21_82_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_21_82_28&#39;)"><span class="hl_varref"><span class="mpre">sparams</span></span></a><span class="mpre">) </span><a href="#loc_92_5_92_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_5_92_18&#39;)"><span class="hl_varref"><span class="mpre">chosenVersion</span></span></a><span class="mpre"> </span><a href="#loc_101_9_101_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_101_9_101_31&#39;)"><span class="hl_varref"><span class="mpre">ciphersFilteredVersion</span></span></a><span class="mpre">
        </span><a name="loc_103_9_103_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_9_103_14&#39;)"><span class="hl_vardecl"><span class="mpre">creds</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Parameters.html#loc_146_7_146_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_146_7_146_24&#39;)"><span class="hl_varref"><span class="mpre">sharedCredentials</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_88_7_88_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_88_7_88_16&#39;)"><span class="hl_varref"><span class="mpre">ctxShared</span></span></a><span class="mpre"> </span><a href="#loc_82_29_82_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_29_82_32&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
    </span><a name="loc_104_5_104_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_5_104_9&#39;)"><span class="hl_vardecl"><span class="mpre">cred</span></span></a><span class="mpre"> &lt;- case </span><a href="Network.TLS.Cipher.html#loc_87_7_87_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_87_7_87_24&#39;)"><span class="hl_varref"><span class="mpre">cipherKeyExchange</span></span></a><span class="mpre"> </span><a href="#loc_102_9_102_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_9_102_19&#39;)"><span class="hl_varref"><span class="mpre">usedCipher</span></span></a><span class="mpre"> of
                </span><a href="Network.TLS.Cipher.html#loc_41_7_41_28" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_41_7_41_28&#39;)"><span class="hl_conref"><span class="mpre">CipherKeyExchange_RSA</span></span></a><span class="mpre">     -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Credentials.html#loc_69_1_69_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Credentials.html#loc_69_1_69_29&#39;)"><span class="hl_varref"><span class="mpre">credentialsFindForDecrypting</span></span></a><span class="mpre"> </span><a href="#loc_103_9_103_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_9_103_14&#39;)"><span class="hl_varref"><span class="mpre">creds</span></span></a><span class="mpre">
                </span><a href="Network.TLS.Cipher.html#loc_42_7_42_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_42_7_42_32&#39;)"><span class="hl_conref"><span class="mpre">CipherKeyExchange_DH_Anon</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
                </span><a href="Network.TLS.Cipher.html#loc_43_7_43_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_43_7_43_32&#39;)"><span class="hl_conref"><span class="mpre">CipherKeyExchange_DHE_RSA</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Credentials.html#loc_65_1_65_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Credentials.html#loc_65_1_65_26&#39;)"><span class="hl_varref"><span class="mpre">credentialsFindForSigning</span></span></a><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_99_7_99_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_99_7_99_19&#39;)"><span class="hl_conref"><span class="mpre">SignatureRSA</span></span></a><span class="mpre"> </span><a href="#loc_103_9_103_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_9_103_14&#39;)"><span class="hl_varref"><span class="mpre">creds</span></span></a><span class="mpre">
                </span><a href="Network.TLS.Cipher.html#loc_45_7_45_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_45_7_45_32&#39;)"><span class="hl_conref"><span class="mpre">CipherKeyExchange_DHE_DSS</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Credentials.html#loc_65_1_65_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Credentials.html#loc_65_1_65_26&#39;)"><span class="hl_varref"><span class="mpre">credentialsFindForSigning</span></span></a><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_100_7_100_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_100_7_100_19&#39;)"><span class="hl_conref"><span class="mpre">SignatureDSS</span></span></a><span class="mpre"> </span><a href="#loc_103_9_103_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_103_9_103_14&#39;)"><span class="hl_varref"><span class="mpre">creds</span></span></a><span class="mpre">
                _                         -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_123_7_123_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_123_7_123_21&#39;)"><span class="hl_conref"><span class="mpre">Error_Protocol</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;key exchange algorithm not implemented&quot;</span></span><span class="mpre">, </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">, </span><a href="Network.TLS.Struct.html#loc_188_7_188_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_188_7_188_23&#39;)"><span class="hl_conref"><span class="mpre">HandshakeFailure</span></span></a><span class="mpre">)

    </span><a name="loc_111_5_111_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_5_111_22&#39;)"><span class="hl_vardecl"><span class="mpre">resumeSessionData</span></span></a><span class="mpre"> &lt;- case </span><a href="#loc_82_74_82_87" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_74_82_87&#39;)"><span class="hl_varref"><span class="mpre">clientSession</span></span></a><span class="mpre"> of
            (</span><a href="Network.TLS.Struct.html#loc_161_19_161_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_161_19_161_26&#39;)"><span class="hl_conref"><span class="mpre">Session</span></span></a><span class="mpre"> (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_112_28_112_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_28_112_43&#39;)"><span class="hl_vardecl"><span class="mpre">clientSessionId</span></span></a><span class="mpre">)) -&gt; </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Session.html#loc_18_7_18_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Session.html#loc_18_7_18_20&#39;)"><span class="hl_varref"><span class="mpre">sessionResume</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Parameters.html#loc_147_7_147_27" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_147_7_147_27&#39;)"><span class="hl_varref"><span class="mpre">sharedSessionManager</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_88_7_88_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_88_7_88_16&#39;)"><span class="hl_varref"><span class="mpre">ctxShared</span></span></a><span class="mpre"> </span><a href="#loc_82_29_82_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_29_82_32&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">) </span><a href="#loc_112_28_112_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_112_28_112_43&#39;)"><span class="hl_varref"><span class="mpre">clientSessionId</span></span></a><span class="mpre">
            (</span><a href="Network.TLS.Struct.html#loc_161_19_161_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_161_19_161_26&#39;)"><span class="hl_conref"><span class="mpre">Session</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">)                -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">

    </span><a href="#loc_129_1_129_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_1_129_12&#39;)"><span class="hl_varref"><span class="mpre">doHandshake</span></span></a><span class="mpre"> </span><a href="#loc_82_21_82_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_21_82_28&#39;)"><span class="hl_varref"><span class="mpre">sparams</span></span></a><span class="mpre"> </span><a href="#loc_104_5_104_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_104_5_104_9&#39;)"><span class="hl_varref"><span class="mpre">cred</span></span></a><span class="mpre"> </span><a href="#loc_82_29_82_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_29_82_32&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_92_5_92_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_5_92_18&#39;)"><span class="hl_varref"><span class="mpre">chosenVersion</span></span></a><span class="mpre"> </span><a href="#loc_102_9_102_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_102_9_102_19&#39;)"><span class="hl_varref"><span class="mpre">usedCipher</span></span></a><span class="mpre"> </span><a href="#loc_121_9_121_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_9_121_24&#39;)"><span class="hl_varref"><span class="mpre">usedCompression</span></span></a><span class="mpre"> </span><a href="#loc_82_74_82_87" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_74_82_87&#39;)"><span class="hl_varref"><span class="mpre">clientSession</span></span></a><span class="mpre"> </span><a href="#loc_111_5_111_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_111_5_111_22&#39;)"><span class="hl_varref"><span class="mpre">resumeSessionData</span></span></a><span class="mpre"> </span><a href="#loc_82_109_82_113" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_109_82_113&#39;)"><span class="hl_varref"><span class="mpre">exts</span></span></a><span class="mpre">

  where
        </span><a name="loc_118_9_118_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_9_118_24&#39;)"><span class="hl_vardecl"><span class="mpre">commonCipherIDs</span></span></a><span class="mpre">    = </span><a href="Data.List.html#loc_412_1_412_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.List.html#loc_412_1_412_10&#39;)"><span class="hl_varref"><span class="mpre">intersect</span></span></a><span class="mpre"> </span><a href="#loc_82_88_82_95" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_88_82_95&#39;)"><span class="hl_varref"><span class="mpre">ciphers</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><a href="Network.TLS.Cipher.html#loc_83_7_83_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_83_7_83_15&#39;)"><span class="hl_varref"><span class="mpre">cipherID</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_89_7_89_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_89_7_89_17&#39;)"><span class="hl_varref"><span class="mpre">ctxCiphers</span></span></a><span class="mpre"> </span><a href="#loc_82_29_82_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_29_82_32&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">)
        </span><a name="loc_119_9_119_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_9_119_22&#39;)"><span class="hl_vardecl"><span class="mpre">commonCiphers</span></span></a><span class="mpre">      = </span><span class="hl_varref"><span class="mpre">filter</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">flip</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">elem</span></span><span class="mpre"> </span><a href="#loc_118_9_118_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_118_9_118_24&#39;)"><span class="hl_varref"><span class="mpre">commonCipherIDs</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Network.TLS.Cipher.html#loc_83_7_83_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_83_7_83_15&#39;)"><span class="hl_varref"><span class="mpre">cipherID</span></span></a><span class="mpre">) (</span><a href="Network.TLS.Context.Internal.html#loc_89_7_89_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_89_7_89_17&#39;)"><span class="hl_varref"><span class="mpre">ctxCiphers</span></span></a><span class="mpre"> </span><a href="#loc_82_29_82_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_29_82_32&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">)
        </span><a name="loc_120_9_120_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_9_120_27&#39;)"><span class="hl_vardecl"><span class="mpre">commonCompressions</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Compression.html#loc_63_1_63_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Compression.html#loc_63_1_63_23&#39;)"><span class="hl_varref"><span class="mpre">compressionIntersectID</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Parameters.html#loc_117_7_117_28" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_117_7_117_28&#39;)"><span class="hl_varref"><span class="mpre">supportedCompressions</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_87_7_87_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_87_7_87_19&#39;)"><span class="hl_varref"><span class="mpre">ctxSupported</span></span></a><span class="mpre"> </span><a href="#loc_82_29_82_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_29_82_32&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">) </span><a href="#loc_82_96_82_108" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_96_82_108&#39;)"><span class="hl_varref"><span class="mpre">compressions</span></span></a><span class="mpre">
        </span><a name="loc_121_9_121_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_9_121_24&#39;)"><span class="hl_vardecl"><span class="mpre">usedCompression</span></span></a><span class="mpre">    = </span><span class="hl_varref"><span class="mpre">head</span></span><span class="mpre"> </span><a href="#loc_120_9_120_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_9_120_27&#39;)"><span class="hl_varref"><span class="mpre">commonCompressions</span></span></a><span class="mpre">


</span><a href="#loc_82_1_82_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_20&#39;)"><span class="hl_fundecl"><span class="mpre">handshakeServerWith</span></span></a><span class="mpre"> _ _ _ = </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_123_7_123_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_123_7_123_21&#39;)"><span class="hl_conref"><span class="mpre">Error_Protocol</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;unexpected handshake message received in handshakeServerWith&quot;</span></span><span class="mpre">, </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">, </span><a href="Network.TLS.Struct.html#loc_188_7_188_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_188_7_188_23&#39;)"><span class="hl_conref"><span class="mpre">HandshakeFailure</span></span></a><span class="mpre">)

</span><a href="#loc_129_1_129_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_1_129_12&#39;)"><span class="mpre">doHandshake</span></a><span class="mpre"> :: </span><a href="Network.TLS.Parameters.html#loc_76_6_76_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_76_6_76_18&#39;)"><span class="hl_tyconref"><span class="mpre">ServerParams</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">Credential</span></span><span class="mpre"> -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Types.html#loc_25_6_25_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_25_6_25_13&#39;)"><span class="hl_tyconref"><span class="mpre">Version</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Cipher.html#loc_82_6_82_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_82_6_82_12&#39;)"><span class="hl_tyconref"><span class="mpre">Cipher</span></span></a><span class="mpre">
            -&gt; </span><a href="Network.TLS.Compression.html#loc_38_6_38_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Compression.html#loc_38_6_38_17&#39;)"><span class="hl_tyconref"><span class="mpre">Compression</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Struct.html#loc_161_9_161_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_161_9_161_16&#39;)"><span class="hl_tyconref"><span class="mpre">Session</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_31_6_31_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_31_6_31_17&#39;)"><span class="hl_tyconref"><span class="mpre">SessionData</span></span></a><span class="mpre">
            -&gt; [(</span><span class="hl_tyconref"><span class="mpre">ExtensionID</span></span><span class="mpre">, </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)] -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_129_1_129_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_1_129_12&#39;)"><span class="hl_fundecl"><span class="mpre">doHandshake</span></span></a><span class="mpre"> </span><a name="loc_129_13_129_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_13_129_20&#39;)"><span class="hl_vardecl"><span class="mpre">sparams</span></span></a><span class="mpre"> </span><a name="loc_129_21_129_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_21_129_26&#39;)"><span class="hl_vardecl"><span class="mpre">mcred</span></span></a><span class="mpre"> </span><a name="loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a name="loc_129_31_129_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_31_129_44&#39;)"><span class="hl_vardecl"><span class="mpre">chosenVersion</span></span></a><span class="mpre"> </span><a name="loc_129_45_129_55" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_45_129_55&#39;)"><span class="hl_vardecl"><span class="mpre">usedCipher</span></span></a><span class="mpre"> </span><a name="loc_129_56_129_71" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_56_129_71&#39;)"><span class="hl_vardecl"><span class="mpre">usedCompression</span></span></a><span class="mpre"> </span><a name="loc_129_72_129_85" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_72_129_85&#39;)"><span class="hl_vardecl"><span class="mpre">clientSession</span></span></a><span class="mpre"> </span><a name="loc_129_86_129_103" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_86_129_103&#39;)"><span class="hl_vardecl"><span class="mpre">resumeSessionData</span></span></a><span class="mpre"> </span><a name="loc_129_104_129_108" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_104_129_108&#39;)"><span class="hl_vardecl"><span class="mpre">exts</span></span></a><span class="mpre"> = do
    case </span><a href="#loc_129_86_129_103" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_86_129_103&#39;)"><span class="hl_varref"><span class="mpre">resumeSessionData</span></span></a><span class="mpre"> of
        </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; do
            </span><a href="#loc_186_9_186_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_9_186_32&#39;)"><span class="hl_varref"><span class="mpre">handshakeSendServerData</span></span></a><span class="mpre">
            </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_119_1_119_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_119_1_119_13&#39;)"><span class="hl_varref"><span class="mpre">contextFlush</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- Receive client info until client Finished.</span></span><span class="mpre">
            </span><a href="#loc_267_1_267_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_1_267_15&#39;)"><span class="hl_varref"><span class="mpre">recvClientData</span></span></a><span class="mpre"> </span><a href="#loc_129_13_129_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_13_129_20&#39;)"><span class="hl_varref"><span class="mpre">sparams</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
            </span><a href="Network.TLS.Handshake.Common.html#loc_74_1_74_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_74_1_74_26&#39;)"><span class="hl_varref"><span class="mpre">sendChangeCipherAndFinish</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">) </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_44_26_44_36" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_44_26_44_36&#39;)"><span class="hl_conref"><span class="mpre">ServerRole</span></span></a><span class="mpre">
        </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_137_14_137_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_14_137_25&#39;)"><span class="hl_vardecl"><span class="mpre">sessionData</span></span></a><span class="mpre"> -&gt; do
            </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Network.TLS.State.html#loc_147_1_147_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_147_1_147_11&#39;)"><span class="hl_varref"><span class="mpre">setSession</span></span></a><span class="mpre"> </span><a href="#loc_129_72_129_85" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_72_129_85&#39;)"><span class="hl_varref"><span class="mpre">clientSession</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">)
            </span><a name="loc_139_13_139_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_13_139_24&#39;)"><span class="hl_vardecl"><span class="mpre">serverhello</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_153_9_153_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_9_153_24&#39;)"><span class="hl_varref"><span class="mpre">makeServerHello</span></span></a><span class="mpre"> </span><a href="#loc_129_72_129_85" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_72_129_85&#39;)"><span class="hl_varref"><span class="mpre">clientSession</span></span></a><span class="mpre">
            </span><a href="Network.TLS.IO.html#loc_106_1_106_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.IO.html#loc_106_1_106_11&#39;)"><span class="hl_varref"><span class="mpre">sendPacket</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_151_7_151_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_151_7_151_16&#39;)"><span class="hl_conref"><span class="mpre">Handshake</span></span></a><span class="mpre"> [</span><a href="#loc_139_13_139_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_13_139_24&#39;)"><span class="hl_varref"><span class="mpre">serverhello</span></span></a><span class="mpre">]
            </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_204_1_204_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_204_1_204_16&#39;)"><span class="hl_varref"><span class="mpre">setMasterSecret</span></span></a><span class="mpre"> </span><a href="#loc_129_31_129_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_31_129_44&#39;)"><span class="hl_varref"><span class="mpre">chosenVersion</span></span></a><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_44_26_44_36" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_44_26_44_36&#39;)"><span class="hl_conref"><span class="mpre">ServerRole</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_34_7_34_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_34_7_34_20&#39;)"><span class="hl_varref"><span class="mpre">sessionSecret</span></span></a><span class="mpre"> </span><a href="#loc_137_14_137_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_14_137_25&#39;)"><span class="hl_varref"><span class="mpre">sessionData</span></span></a><span class="mpre">
            </span><a href="Network.TLS.Handshake.Common.html#loc_74_1_74_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_74_1_74_26&#39;)"><span class="hl_varref"><span class="mpre">sendChangeCipherAndFinish</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">) </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_44_26_44_36" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_44_26_44_36&#39;)"><span class="hl_conref"><span class="mpre">ServerRole</span></span></a><span class="mpre">
            </span><a href="Network.TLS.Handshake.Common.html#loc_83_1_83_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_83_1_83_26&#39;)"><span class="hl_varref"><span class="mpre">recvChangeCipherAndFinish</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
    </span><a href="Network.TLS.Handshake.Common.html#loc_55_1_55_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_55_1_55_19&#39;)"><span class="hl_varref"><span class="mpre">handshakeTerminate</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
  where
        </span><a name="loc_146_9_146_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_9_146_27&#39;)"><span class="hl_vardecl"><span class="mpre">clientRequestedNPN</span></span></a><span class="mpre"> = </span><a href="Data.Maybe.html#loc_80_1_80_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Maybe.html#loc_80_1_80_7&#39;)"><span class="hl_varref"><span class="mpre">isJust</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">lookup</span></span><span class="mpre"> </span><a href="Network.TLS.Extension.html#loc_46_1_46_36" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Extension.html#loc_46_1_46_36&#39;)"><span class="hl_varref"><span class="mpre">extensionID_NextProtocolNegotiation</span></span></a><span class="mpre"> </span><a href="#loc_129_104_129_108" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_104_129_108&#39;)"><span class="hl_varref"><span class="mpre">exts</span></span></a><span class="mpre">

        </span><span class="hl_comment"><span class="mpre">---</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- When the client sends a certificate, check whether</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- it is acceptable for the application.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">---</span></span><span class="mpre">
        </span><a name="loc_153_9_153_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_9_153_24&#39;)"><span class="hl_fundecl"><span class="mpre">makeServerHello</span></span></a><span class="mpre"> </span><a name="loc_153_25_153_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_25_153_32&#39;)"><span class="hl_vardecl"><span class="mpre">session</span></span></a><span class="mpre"> = do
            </span><a name="loc_154_13_154_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_13_154_18&#39;)"><span class="hl_vardecl"><span class="mpre">srand</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_211_1_211_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_211_1_211_12&#39;)"><span class="hl_varref"><span class="mpre">getStateRNG</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_num"><span class="mpre">32</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_159_24_159_36" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_159_24_159_36&#39;)"><span class="hl_conref"><span class="mpre">ServerRandom</span></span></a><span class="mpre">
            case </span><a href="#loc_129_21_129_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_21_129_26&#39;)"><span class="hl_varref"><span class="mpre">mcred</span></span></a><span class="mpre"> of
                </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (_, </span><a name="loc_156_26_156_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_26_156_33&#39;)"><span class="hl_vardecl"><span class="mpre">privkey</span></span></a><span class="mpre">) -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_126_1_126_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_126_1_126_14&#39;)"><span class="hl_varref"><span class="mpre">setPrivateKey</span></span></a><span class="mpre"> </span><a href="#loc_156_26_156_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_156_26_156_33&#39;)"><span class="hl_varref"><span class="mpre">privkey</span></span></a><span class="mpre">
                _                 -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- return a sensible error</span></span><span class="mpre">

            </span><span class="hl_comment"><span class="mpre">-- in TLS12, we need to check as well the certificates we are sending if they have in the extension</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- the necessary bits set.</span></span><span class="mpre">
            </span><a name="loc_161_13_161_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_13_161_21&#39;)"><span class="hl_vardecl"><span class="mpre">secReneg</span></span></a><span class="mpre">   &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.State.html#loc_174_1_174_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_174_1_174_23&#39;)"><span class="hl_varref"><span class="mpre">getSecureRenegotiation</span></span></a><span class="mpre">
            </span><a name="loc_162_13_162_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_13_162_23&#39;)"><span class="hl_vardecl"><span class="mpre">secRengExt</span></span></a><span class="mpre"> &lt;- if </span><a href="#loc_161_13_161_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_161_13_161_21&#39;)"><span class="hl_varref"><span class="mpre">secReneg</span></span></a><span class="mpre">
                    then do
                            </span><a name="loc_164_29_164_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_29_164_31&#39;)"><span class="hl_vardecl"><span class="mpre">vf</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
                                    </span><a name="loc_165_37_165_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_37_165_40&#39;)"><span class="hl_vardecl"><span class="mpre">cvf</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.State.html#loc_201_1_201_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_201_1_201_16&#39;)"><span class="hl_varref"><span class="mpre">getVerifiedData</span></span></a><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_44_13_44_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_44_13_44_23&#39;)"><span class="hl_conref"><span class="mpre">ClientRole</span></span></a><span class="mpre">
                                    </span><a name="loc_166_37_166_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_37_166_40&#39;)"><span class="hl_vardecl"><span class="mpre">svf</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.State.html#loc_201_1_201_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_201_1_201_16&#39;)"><span class="hl_varref"><span class="mpre">getVerifiedData</span></span></a><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_44_26_44_36" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_44_26_44_36&#39;)"><span class="hl_conref"><span class="mpre">ServerRole</span></span></a><span class="mpre">
                                    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Extension.html#loc_60_5_60_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Extension.html#loc_60_5_60_20&#39;)"><span class="hl_varref"><span class="mpre">extensionEncode</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Extension.html#loc_106_28_106_47" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Extension.html#loc_106_28_106_47&#39;)"><span class="hl_conref"><span class="mpre">SecureRenegotiation</span></span></a><span class="mpre"> </span><a href="#loc_165_37_165_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_165_37_165_40&#39;)"><span class="hl_varref"><span class="mpre">cvf</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a href="#loc_166_37_166_40" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_166_37_166_40&#39;)"><span class="hl_varref"><span class="mpre">svf</span></span></a><span class="mpre">)
                            </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> [ (</span><span class="hl_num"><span class="mpre">0xff01</span></span><span class="mpre">, </span><a href="#loc_164_29_164_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_164_29_164_31&#39;)"><span class="hl_varref"><span class="mpre">vf</span></span></a><span class="mpre">) ]
                    else </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> []
            </span><a name="loc_170_13_170_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_13_170_26&#39;)"><span class="hl_vardecl"><span class="mpre">nextProtocols</span></span></a><span class="mpre"> &lt;-
                if </span><a href="#loc_146_9_146_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_146_9_146_27&#39;)"><span class="hl_varref"><span class="mpre">clientRequestedNPN</span></span></a><span class="mpre">
                    then </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Parameters.html#loc_226_7_226_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_226_7_226_29&#39;)"><span class="hl_varref"><span class="mpre">onSuggestNextProtocols</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Parameters.html#loc_90_7_90_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_90_7_90_18&#39;)"><span class="hl_varref"><span class="mpre">serverHooks</span></span></a><span class="mpre"> </span><a href="#loc_129_13_129_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_13_129_20&#39;)"><span class="hl_varref"><span class="mpre">sparams</span></span></a><span class="mpre">
                    else </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
            </span><a name="loc_174_13_174_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_174_13_174_19&#39;)"><span class="hl_vardecl"><span class="mpre">npnExt</span></span></a><span class="mpre"> &lt;- case </span><a href="#loc_170_13_170_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_170_13_170_26&#39;)"><span class="hl_varref"><span class="mpre">nextProtocols</span></span></a><span class="mpre"> of
                        </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_175_30_175_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_30_175_36&#39;)"><span class="hl_vardecl"><span class="mpre">protos</span></span></a><span class="mpre"> -&gt; do </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do </span><a href="Network.TLS.State.html#loc_177_1_177_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_177_1_177_16&#39;)"><span class="hl_varref"><span class="mpre">setExtensionNPN</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">
                                                               </span><a href="Network.TLS.State.html#loc_189_1_189_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_189_1_189_29&#39;)"><span class="hl_varref"><span class="mpre">setServerNextProtocolSuggest</span></span></a><span class="mpre"> </span><a href="#loc_175_30_175_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_30_175_36&#39;)"><span class="hl_varref"><span class="mpre">protos</span></span></a><span class="mpre">
                                          </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> [ ( </span><a href="Network.TLS.Extension.html#loc_46_1_46_36" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Extension.html#loc_46_1_46_36&#39;)"><span class="hl_varref"><span class="mpre">extensionID_NextProtocolNegotiation</span></span></a><span class="mpre">
                                                   , </span><a href="Network.TLS.Extension.html#loc_60_5_60_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Extension.html#loc_60_5_60_20&#39;)"><span class="hl_varref"><span class="mpre">extensionEncode</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Extension.html#loc_121_32_121_55" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Extension.html#loc_121_32_121_55&#39;)"><span class="hl_conref"><span class="mpre">NextProtocolNegotiation</span></span></a><span class="mpre"> </span><a href="#loc_175_30_175_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_175_30_175_36&#39;)"><span class="hl_varref"><span class="mpre">protos</span></span></a><span class="mpre">) ]
                        </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> []
            let </span><a name="loc_180_17_180_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_17_180_27&#39;)"><span class="hl_vardecl"><span class="mpre">extensions</span></span></a><span class="mpre"> = </span><a href="#loc_162_13_162_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_13_162_23&#39;)"><span class="hl_varref"><span class="mpre">secRengExt</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><a href="#loc_174_13_174_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_174_13_174_19&#39;)"><span class="hl_varref"><span class="mpre">npnExt</span></span></a><span class="mpre">
            </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Network.TLS.State.html#loc_156_1_156_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_156_1_156_11&#39;)"><span class="hl_varref"><span class="mpre">setVersion</span></span></a><span class="mpre"> </span><a href="#loc_129_31_129_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_31_129_44&#39;)"><span class="hl_varref"><span class="mpre">chosenVersion</span></span></a><span class="mpre">)
            </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_253_1_253_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_253_1_253_25&#39;)"><span class="hl_varref"><span class="mpre">setServerHelloParameters</span></span></a><span class="mpre"> </span><a href="#loc_129_31_129_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_31_129_44&#39;)"><span class="hl_varref"><span class="mpre">chosenVersion</span></span></a><span class="mpre"> </span><a href="#loc_154_13_154_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_13_154_18&#39;)"><span class="hl_varref"><span class="mpre">srand</span></span></a><span class="mpre"> </span><a href="#loc_129_45_129_55" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_45_129_55&#39;)"><span class="hl_varref"><span class="mpre">usedCipher</span></span></a><span class="mpre"> </span><a href="#loc_129_56_129_71" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_56_129_71&#39;)"><span class="hl_varref"><span class="mpre">usedCompression</span></span></a><span class="mpre">
            </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_254_7_254_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_254_7_254_18&#39;)"><span class="hl_conref"><span class="mpre">ServerHello</span></span></a><span class="mpre"> </span><a href="#loc_129_31_129_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_31_129_44&#39;)"><span class="hl_varref"><span class="mpre">chosenVersion</span></span></a><span class="mpre"> </span><a href="#loc_154_13_154_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_154_13_154_18&#39;)"><span class="hl_varref"><span class="mpre">srand</span></span></a><span class="mpre"> </span><a href="#loc_153_25_153_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_25_153_32&#39;)"><span class="hl_varref"><span class="mpre">session</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Cipher.html#loc_83_7_83_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_83_7_83_15&#39;)"><span class="hl_varref"><span class="mpre">cipherID</span></span></a><span class="mpre"> </span><a href="#loc_129_45_129_55" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_45_129_55&#39;)"><span class="hl_varref"><span class="mpre">usedCipher</span></span></a><span class="mpre">)
                                               (</span><a href="Network.TLS.Compression.html#loc_42_1_42_14" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Compression.html#loc_42_1_42_14&#39;)"><span class="hl_varref"><span class="mpre">compressionID</span></span></a><span class="mpre"> </span><a href="#loc_129_56_129_71" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_56_129_71&#39;)"><span class="hl_varref"><span class="mpre">usedCompression</span></span></a><span class="mpre">) </span><a href="#loc_180_17_180_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_17_180_27&#39;)"><span class="hl_varref"><span class="mpre">extensions</span></span></a><span class="mpre">

        </span><a name="loc_186_9_186_32" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_186_9_186_32&#39;)"><span class="hl_vardecl"><span class="mpre">handshakeSendServerData</span></span></a><span class="mpre"> = do
            </span><a name="loc_187_13_187_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_187_13_187_26&#39;)"><span class="hl_vardecl"><span class="mpre">serverSession</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Handshake.Common.html#loc_49_1_49_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_49_1_49_11&#39;)"><span class="hl_varref"><span class="mpre">newSession</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">
            </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Network.TLS.State.html#loc_147_1_147_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_147_1_147_11&#39;)"><span class="hl_varref"><span class="mpre">setSession</span></span></a><span class="mpre"> </span><a href="#loc_187_13_187_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_187_13_187_26&#39;)"><span class="hl_varref"><span class="mpre">serverSession</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre">)
            </span><a name="loc_189_13_189_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_13_189_24&#39;)"><span class="hl_vardecl"><span class="mpre">serverhello</span></span></a><span class="mpre">   &lt;- </span><a href="#loc_153_9_153_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_153_9_153_24&#39;)"><span class="hl_varref"><span class="mpre">makeServerHello</span></span></a><span class="mpre"> </span><a href="#loc_187_13_187_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_187_13_187_26&#39;)"><span class="hl_varref"><span class="mpre">serverSession</span></span></a><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- send ServerHello &amp; Certificate &amp; ServerKeyXchg &amp; CertReq</span></span><span class="mpre">
            let </span><a name="loc_191_17_191_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_17_191_24&#39;)"><span class="hl_vardecl"><span class="mpre">certMsg</span></span></a><span class="mpre"> = case </span><a href="#loc_129_21_129_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_21_129_26&#39;)"><span class="hl_varref"><span class="mpre">mcred</span></span></a><span class="mpre"> of
                            </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a name="loc_192_35_192_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_35_192_43&#39;)"><span class="hl_vardecl"><span class="mpre">srvCerts</span></span></a><span class="mpre">, _) -&gt; </span><a href="Network.TLS.Struct.html#loc_255_7_255_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_255_7_255_19&#39;)"><span class="hl_conref"><span class="mpre">Certificates</span></span></a><span class="mpre"> </span><a href="#loc_192_35_192_43" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_192_35_192_43&#39;)"><span class="hl_varref"><span class="mpre">srvCerts</span></span></a><span class="mpre">
                            _                  -&gt; </span><a href="Network.TLS.Struct.html#loc_255_7_255_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_255_7_255_19&#39;)"><span class="hl_conref"><span class="mpre">Certificates</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">CertificateChain</span></span><span class="mpre"> []
            </span><a href="Network.TLS.IO.html#loc_106_1_106_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.IO.html#loc_106_1_106_11&#39;)"><span class="hl_varref"><span class="mpre">sendPacket</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_151_7_151_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_151_7_151_16&#39;)"><span class="hl_conref"><span class="mpre">Handshake</span></span></a><span class="mpre"> [ </span><a href="#loc_189_13_189_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_189_13_189_24&#39;)"><span class="hl_varref"><span class="mpre">serverhello</span></span></a><span class="mpre">, </span><a href="#loc_191_17_191_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_191_17_191_24&#39;)"><span class="hl_varref"><span class="mpre">certMsg</span></span></a><span class="mpre"> ]

            </span><span class="hl_comment"><span class="mpre">-- send server key exchange if needed</span></span><span class="mpre">
            </span><a name="loc_197_13_197_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_197_13_197_16&#39;)"><span class="hl_vardecl"><span class="mpre">skx</span></span></a><span class="mpre"> &lt;- case </span><a href="Network.TLS.Cipher.html#loc_87_7_87_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_87_7_87_24&#39;)"><span class="hl_varref"><span class="mpre">cipherKeyExchange</span></span></a><span class="mpre"> </span><a href="#loc_129_45_129_55" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_45_129_55&#39;)"><span class="hl_varref"><span class="mpre">usedCipher</span></span></a><span class="mpre"> of
                        </span><a href="Network.TLS.Cipher.html#loc_42_7_42_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_42_7_42_32&#39;)"><span class="hl_conref"><span class="mpre">CipherKeyExchange_DH_Anon</span></span></a><span class="mpre"> -&gt; </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><a href="#loc_255_9_255_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_255_9_255_28&#39;)"><span class="hl_varref"><span class="mpre">generateSKX_DH_Anon</span></span></a><span class="mpre">
                        </span><a href="Network.TLS.Cipher.html#loc_43_7_43_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_43_7_43_32&#39;)"><span class="hl_conref"><span class="mpre">CipherKeyExchange_DHE_RSA</span></span></a><span class="mpre"> -&gt; </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><a href="#loc_237_9_237_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_9_237_24&#39;)"><span class="hl_varref"><span class="mpre">generateSKX_DHE</span></span></a><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_99_7_99_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_99_7_99_19&#39;)"><span class="hl_conref"><span class="mpre">SignatureRSA</span></span></a><span class="mpre">
                        </span><a href="Network.TLS.Cipher.html#loc_45_7_45_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Cipher.html#loc_45_7_45_32&#39;)"><span class="hl_conref"><span class="mpre">CipherKeyExchange_DHE_DSS</span></span></a><span class="mpre"> -&gt; </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><a href="#loc_237_9_237_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_9_237_24&#39;)"><span class="hl_varref"><span class="mpre">generateSKX_DHE</span></span></a><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_100_7_100_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_100_7_100_19&#39;)"><span class="hl_conref"><span class="mpre">SignatureDSS</span></span></a><span class="mpre">
                        _                         -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
            </span><span class="hl_varref"><span class="mpre">maybe</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">) (</span><a href="Network.TLS.IO.html#loc_106_1_106_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.IO.html#loc_106_1_106_11&#39;)"><span class="hl_varref"><span class="mpre">sendPacket</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_151_7_151_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_151_7_151_16&#39;)"><span class="hl_conref"><span class="mpre">Handshake</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> (</span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre">[]) </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_259_7_259_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_259_7_259_20&#39;)"><span class="hl_conref"><span class="mpre">ServerKeyXchg</span></span></a><span class="mpre">) </span><a href="#loc_197_13_197_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_197_13_197_16&#39;)"><span class="hl_varref"><span class="mpre">skx</span></span></a><span class="mpre">

            </span><span class="hl_comment"><span class="mpre">-- FIXME we don&#39;t do this on a Anonymous server</span></span><span class="mpre">

            </span><span class="hl_comment"><span class="mpre">-- When configured, send a certificate request</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- with the DNs of all confgure CA</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- certificates.</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
            </span><a href="Control.Monad.html#loc_265_1_265_5" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_265_1_265_5&#39;)"><span class="hl_varref"><span class="mpre">when</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Parameters.html#loc_78_7_78_27" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_78_7_78_27&#39;)"><span class="hl_varref"><span class="mpre">serverWantClientCert</span></span></a><span class="mpre"> </span><a href="#loc_129_13_129_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_13_129_20&#39;)"><span class="hl_varref"><span class="mpre">sparams</span></span></a><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
                </span><a name="loc_211_17_211_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_17_211_28&#39;)"><span class="hl_vardecl"><span class="mpre">usedVersion</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.State.html#loc_165_1_165_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_165_1_165_11&#39;)"><span class="hl_varref"><span class="mpre">getVersion</span></span></a><span class="mpre">
                let </span><a name="loc_212_21_212_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_212_21_212_30&#39;)"><span class="hl_vardecl"><span class="mpre">certTypes</span></span></a><span class="mpre"> = [ </span><a href="Network.TLS.Struct.html#loc_76_7_76_31" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_76_7_76_31&#39;)"><span class="hl_conref"><span class="mpre">CertificateType_RSA_Sign</span></span></a><span class="mpre"> ]
                    </span><a name="loc_213_21_213_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_213_21_213_29&#39;)"><span class="hl_vardecl"><span class="mpre">hashSigs</span></span></a><span class="mpre"> = if </span><a href="#loc_211_17_211_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_211_17_211_28&#39;)"><span class="hl_varref"><span class="mpre">usedVersion</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&lt;</span></span><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_25_46_25_51" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_25_46_25_51&#39;)"><span class="hl_conref"><span class="mpre">TLS12</span></span></a><span class="mpre">
                                   then </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
                                   else </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><a href="Network.TLS.Parameters.html#loc_120_7_120_30" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_120_7_120_30&#39;)"><span class="hl_varref"><span class="mpre">supportedHashSignatures</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_87_7_87_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_87_7_87_19&#39;)"><span class="hl_varref"><span class="mpre">ctxSupported</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre">)
                    </span><a name="loc_216_21_216_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_21_216_25&#39;)"><span class="hl_vardecl"><span class="mpre">creq</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Struct.html#loc_260_7_260_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_260_7_260_18&#39;)"><span class="hl_conref"><span class="mpre">CertRequest</span></span></a><span class="mpre"> </span><a href="#loc_212_21_212_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_212_21_212_30&#39;)"><span class="hl_varref"><span class="mpre">certTypes</span></span></a><span class="mpre"> </span><a href="#loc_213_21_213_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_213_21_213_29&#39;)"><span class="hl_varref"><span class="mpre">hashSigs</span></span></a><span class="mpre">
                               (</span><span class="hl_varref"><span class="mpre">map</span></span><span class="mpre"> </span><a href="#loc_225_9_225_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_225_9_225_22&#39;)"><span class="hl_varref"><span class="mpre">extractCAname</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Parameters.html#loc_83_7_83_27" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_83_7_83_27&#39;)"><span class="hl_varref"><span class="mpre">serverCACertificates</span></span></a><span class="mpre"> </span><a href="#loc_129_13_129_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_13_129_20&#39;)"><span class="hl_varref"><span class="mpre">sparams</span></span></a><span class="mpre">)
                </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_139_1_139_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_139_1_139_15&#39;)"><span class="hl_varref"><span class="mpre">setCertReqSent</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">
                </span><a href="Network.TLS.IO.html#loc_106_1_106_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.IO.html#loc_106_1_106_11&#39;)"><span class="hl_varref"><span class="mpre">sendPacket</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_151_7_151_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_151_7_151_16&#39;)"><span class="hl_conref"><span class="mpre">Handshake</span></span></a><span class="mpre"> [</span><a href="#loc_216_21_216_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_216_21_216_25&#39;)"><span class="hl_varref"><span class="mpre">creq</span></span></a><span class="mpre">])

            </span><span class="hl_comment"><span class="mpre">-- Send HelloDone</span></span><span class="mpre">
            </span><a href="Network.TLS.IO.html#loc_106_1_106_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.IO.html#loc_106_1_106_11&#39;)"><span class="hl_varref"><span class="mpre">sendPacket</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_151_7_151_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_151_7_151_16&#39;)"><span class="hl_conref"><span class="mpre">Handshake</span></span></a><span class="mpre"> [</span><a href="Network.TLS.Struct.html#loc_257_7_257_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_257_7_257_22&#39;)"><span class="hl_conref"><span class="mpre">ServerHelloDone</span></span></a><span class="mpre">])

        </span><a href="#loc_225_9_225_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_225_9_225_22&#39;)"><span class="mpre">extractCAname</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">SignedCertificate</span></span><span class="mpre"> -&gt; </span><a href="Data.X509.DistinguishedName.html#loc_25_9_25_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.X509.DistinguishedName.html#loc_25_9_25_26&#39;)"><span class="hl_tyconref"><span class="mpre">DistinguishedName</span></span></a><span class="mpre">
        </span><a name="loc_225_9_225_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_225_9_225_22&#39;)"><span class="hl_fundecl"><span class="mpre">extractCAname</span></span></a><span class="mpre"> </span><a name="loc_225_23_225_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_225_23_225_27&#39;)"><span class="hl_vardecl"><span class="mpre">cert</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">certSubjectDN</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.X509.html#loc_87_1_87_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.X509.html#loc_87_1_87_15&#39;)"><span class="hl_varref"><span class="mpre">getCertificate</span></span></a><span class="mpre"> </span><a href="#loc_225_23_225_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_225_23_225_27&#39;)"><span class="hl_varref"><span class="mpre">cert</span></span></a><span class="mpre">

        </span><a name="loc_227_9_227_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_227_9_227_18&#39;)"><span class="hl_vardecl"><span class="mpre">setup_DHE</span></span></a><span class="mpre"> = do
            let </span><a name="loc_228_17_228_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_17_228_25&#39;)"><span class="hl_vardecl"><span class="mpre">dhparams</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Util.html#loc_53_1_53_9" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Util.html#loc_53_1_53_9&#39;)"><span class="hl_varref"><span class="mpre">fromJust</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;server DHE Params&quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Parameters.html#loc_87_7_87_22" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_87_7_87_22&#39;)"><span class="hl_varref"><span class="mpre">serverDHEParams</span></span></a><span class="mpre"> </span><a href="#loc_129_13_129_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_13_129_20&#39;)"><span class="hl_varref"><span class="mpre">sparams</span></span></a><span class="mpre">
            (</span><span class="hl_vardecl"><span class="mpre">priv</span></span><span class="mpre">, </span><a name="loc_229_20_229_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_229_20_229_23&#39;)"><span class="hl_vardecl"><span class="mpre">pub</span></span></a><span class="mpre">) &lt;- </span><a href="Network.TLS.Handshake.Key.html#loc_62_1_62_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Key.html#loc_62_1_62_12&#39;)"><span class="hl_varref"><span class="mpre">generateDHE</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_228_17_228_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_17_228_25&#39;)"><span class="hl_varref"><span class="mpre">dhparams</span></span></a><span class="mpre">

            let </span><a name="loc_231_17_231_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_17_231_29&#39;)"><span class="hl_vardecl"><span class="mpre">serverParams</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Struct.html#loc_226_23_226_37" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_226_23_226_37&#39;)"><span class="hl_conref"><span class="mpre">ServerDHParams</span></span></a><span class="mpre"> </span><a href="#loc_228_17_228_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_228_17_228_25&#39;)"><span class="hl_varref"><span class="mpre">dhparams</span></span></a><span class="mpre"> </span><a href="#loc_229_20_229_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_229_20_229_23&#39;)"><span class="hl_varref"><span class="mpre">pub</span></span></a><span class="mpre">

            </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_136_1_136_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_136_1_136_18&#39;)"><span class="hl_varref"><span class="mpre">setServerDHParams</span></span></a><span class="mpre"> </span><a href="#loc_231_17_231_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_17_231_29&#39;)"><span class="hl_varref"><span class="mpre">serverParams</span></span></a><span class="mpre">
            </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Control.Monad.State.Class.html#loc_85_1_85_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.State.Class.html#loc_85_1_85_7&#39;)"><span class="hl_varref"><span class="mpre">modify</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><span class="hl_vardecl"><span class="mpre">hst</span></span><span class="mpre"> -&gt; </span><span class="warning" data-warning="ExpRecUpdate (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Handshake/Server.hs&quot;, srcSpanStartLine = 234, srcSpanStartColumn = 48, srcSpanEndLine = 234, srcSpanEndColumn = 80}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Handshake/Server.hs&quot;, srcSpanStartLine = 234, srcSpanStartColumn = 52, srcSpanEndLine = 234, srcSpanEndColumn = 53},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/tls-1.2.8/Network/TLS/Handshake/Serv"><span class="mpre">hst { hstDHPrivate = Just priv }</span></span><span class="mpre">
            </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_231_17_231_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_231_17_231_29&#39;)"><span class="hl_varref"><span class="mpre">serverParams</span></span></a><span class="mpre">)

        </span><a name="loc_237_9_237_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_9_237_24&#39;)"><span class="hl_fundecl"><span class="mpre">generateSKX_DHE</span></span></a><span class="mpre"> </span><a name="loc_237_25_237_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_25_237_31&#39;)"><span class="hl_vardecl"><span class="mpre">sigAlg</span></span></a><span class="mpre"> = do
            </span><a name="loc_238_13_238_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_238_13_238_25&#39;)"><span class="hl_vardecl"><span class="mpre">serverParams</span></span></a><span class="mpre">  &lt;- </span><a href="#loc_227_9_227_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_227_9_227_18&#39;)"><span class="hl_varref"><span class="mpre">setup_DHE</span></span></a><span class="mpre">
            </span><a name="loc_239_13_239_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_13_239_26&#39;)"><span class="hl_vardecl"><span class="mpre">signatureData</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Handshake.Signature.html#loc_106_1_106_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Signature.html#loc_106_1_106_23&#39;)"><span class="hl_varref"><span class="mpre">generateSignedDHParams</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_238_13_238_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_238_13_238_25&#39;)"><span class="hl_varref"><span class="mpre">serverParams</span></span></a><span class="mpre">

            </span><a name="loc_241_13_241_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_13_241_24&#39;)"><span class="hl_vardecl"><span class="mpre">usedVersion</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.State.html#loc_165_1_165_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_165_1_165_11&#39;)"><span class="hl_varref"><span class="mpre">getVersion</span></span></a><span class="mpre">
            let </span><a name="loc_242_17_242_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_17_242_22&#39;)"><span class="hl_vardecl"><span class="mpre">mhash</span></span></a><span class="mpre"> = case </span><a href="#loc_241_13_241_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_241_13_241_24&#39;)"><span class="hl_varref"><span class="mpre">usedVersion</span></span></a><span class="mpre"> of
                            </span><a href="Network.TLS.Types.html#loc_25_46_25_51" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_25_46_25_51&#39;)"><span class="hl_conref"><span class="mpre">TLS12</span></span></a><span class="mpre"> -&gt; case </span><span class="hl_varref"><span class="mpre">filter</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">(==)</span></span><span class="mpre"> </span><a href="#loc_237_25_237_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_25_237_31&#39;)"><span class="hl_varref"><span class="mpre">sigAlg</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">snd</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Parameters.html#loc_120_7_120_30" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_120_7_120_30&#39;)"><span class="hl_varref"><span class="mpre">supportedHashSignatures</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Context.Internal.html#loc_87_7_87_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_87_7_87_19&#39;)"><span class="hl_varref"><span class="mpre">ctxSupported</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> of
                                          []  -&gt; </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;no hash signature for &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_237_25_237_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_25_237_31&#39;)"><span class="hl_varref"><span class="mpre">sigAlg</span></span></a><span class="mpre">)
                                          </span><a name="loc_245_43_245_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_245_43_245_44&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre">_ -&gt; </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fst</span></span><span class="mpre"> </span><a href="#loc_245_43_245_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_245_43_245_44&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">)
                            _     -&gt; </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
            let </span><a name="loc_247_17_247_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_17_247_26&#39;)"><span class="hl_vardecl"><span class="mpre">hashDescr</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Handshake.Signature.html#loc_62_1_62_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Signature.html#loc_62_1_62_18&#39;)"><span class="hl_varref"><span class="mpre">signatureHashData</span></span></a><span class="mpre"> </span><a href="#loc_237_25_237_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_25_237_31&#39;)"><span class="hl_varref"><span class="mpre">sigAlg</span></span></a><span class="mpre"> </span><a href="#loc_242_17_242_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_17_242_22&#39;)"><span class="hl_varref"><span class="mpre">mhash</span></span></a><span class="mpre">
            </span><a name="loc_248_13_248_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_13_248_19&#39;)"><span class="hl_vardecl"><span class="mpre">signed</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Handshake.Signature.html#loc_77_1_77_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Signature.html#loc_77_1_77_16&#39;)"><span class="hl_varref"><span class="mpre">signatureCreate</span></span></a><span class="mpre"> </span><a href="#loc_129_27_129_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_129_27_129_30&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">fmap</span></span><span class="mpre"> (\</span><a name="loc_248_51_248_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_51_248_52&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre"> -&gt; (</span><a href="#loc_248_51_248_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_51_248_52&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre">, </span><a href="#loc_237_25_237_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_25_237_31&#39;)"><span class="hl_varref"><span class="mpre">sigAlg</span></span></a><span class="mpre">)) </span><a href="#loc_242_17_242_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_242_17_242_22&#39;)"><span class="hl_varref"><span class="mpre">mhash</span></span></a><span class="mpre">) </span><a href="#loc_247_17_247_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_247_17_247_26&#39;)"><span class="hl_varref"><span class="mpre">hashDescr</span></span></a><span class="mpre"> </span><a href="#loc_239_13_239_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_239_13_239_26&#39;)"><span class="hl_varref"><span class="mpre">signatureData</span></span></a><span class="mpre">

            case </span><a href="#loc_237_25_237_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_25_237_31&#39;)"><span class="hl_varref"><span class="mpre">sigAlg</span></span></a><span class="mpre"> of
                </span><a href="Network.TLS.Struct.html#loc_99_7_99_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_99_7_99_19&#39;)"><span class="hl_conref"><span class="mpre">SignatureRSA</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_237_7_237_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_237_7_237_18&#39;)"><span class="hl_conref"><span class="mpre">SKX_DHE_RSA</span></span></a><span class="mpre"> </span><a href="#loc_238_13_238_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_238_13_238_25&#39;)"><span class="hl_varref"><span class="mpre">serverParams</span></span></a><span class="mpre"> </span><a href="#loc_248_13_248_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_13_248_19&#39;)"><span class="hl_varref"><span class="mpre">signed</span></span></a><span class="mpre">
                </span><a href="Network.TLS.Struct.html#loc_100_7_100_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_100_7_100_19&#39;)"><span class="hl_conref"><span class="mpre">SignatureDSS</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_236_7_236_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_236_7_236_18&#39;)"><span class="hl_conref"><span class="mpre">SKX_DHE_DSS</span></span></a><span class="mpre"> </span><a href="#loc_238_13_238_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_238_13_238_25&#39;)"><span class="hl_varref"><span class="mpre">serverParams</span></span></a><span class="mpre"> </span><a href="#loc_248_13_248_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_248_13_248_19&#39;)"><span class="hl_varref"><span class="mpre">signed</span></span></a><span class="mpre">
                _            -&gt; </span><span class="hl_varref"><span class="mpre">error</span></span><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;generate skx_dhe unsupported signature type: &quot;</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">++</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_237_25_237_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_237_25_237_31&#39;)"><span class="hl_varref"><span class="mpre">sigAlg</span></span></a><span class="mpre">)

        </span><a name="loc_255_9_255_28" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_255_9_255_28&#39;)"><span class="hl_vardecl"><span class="mpre">generateSKX_DH_Anon</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Struct.html#loc_235_7_235_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_235_7_235_18&#39;)"><span class="hl_conref"><span class="mpre">SKX_DH_Anon</span></span></a><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><a href="#loc_227_9_227_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_227_9_227_18&#39;)"><span class="hl_varref"><span class="mpre">setup_DHE</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | receive Client data in handshake until the Finished handshake.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- [certificate]</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- client key xchg</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- [cert verify]</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- change cipher</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- [NPN]</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--      &lt;- finish</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><a href="#loc_267_1_267_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_1_267_15&#39;)"><span class="mpre">recvClientData</span></a><span class="mpre"> :: </span><a href="Network.TLS.Parameters.html#loc_76_6_76_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_76_6_76_18&#39;)"><span class="hl_tyconref"><span class="mpre">ServerParams</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_85_6_85_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_85_6_85_13&#39;)"><span class="hl_tyconref"><span class="mpre">Context</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_267_1_267_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_1_267_15&#39;)"><span class="hl_fundecl"><span class="mpre">recvClientData</span></span></a><span class="mpre"> </span><a name="loc_267_16_267_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_16_267_23&#39;)"><span class="hl_vardecl"><span class="mpre">sparams</span></span></a><span class="mpre"> </span><a name="loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_vardecl"><span class="mpre">ctx</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Handshake.Common.html#loc_112_1_112_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_112_1_112_13&#39;)"><span class="hl_varref"><span class="mpre">runRecvState</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Handshake.Common.html#loc_91_7_91_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_91_7_91_25&#39;)"><span class="hl_conref"><span class="mpre">RecvStateHandshake</span></span></a><span class="mpre"> </span><a href="#loc_268_9_268_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_9_268_33&#39;)"><span class="hl_varref"><span class="mpre">processClientCertificate</span></span></a><span class="mpre">)
  where </span><a name="loc_268_9_268_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_9_268_33&#39;)"><span class="hl_fundecl"><span class="mpre">processClientCertificate</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_255_7_255_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_255_7_255_19&#39;)"><span class="hl_conref"><span class="mpre">Certificates</span></span></a><span class="mpre"> </span><a name="loc_268_48_268_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_48_268_53&#39;)"><span class="hl_vardecl"><span class="mpre">certs</span></span></a><span class="mpre">) = do
            </span><span class="hl_comment"><span class="mpre">-- run certificate recv hook</span></span><span class="mpre">
            </span><a href="Network.TLS.Context.Internal.html#loc_155_1_155_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_155_1_155_13&#39;)"><span class="hl_varref"><span class="mpre">ctxWithHooks</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> (\</span><a name="loc_270_32_270_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_270_32_270_37&#39;)"><span class="hl_vardecl"><span class="mpre">hooks</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">hookRecvCertificates</span></span><span class="mpre"> </span><a href="#loc_270_32_270_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_270_32_270_37&#39;)"><span class="hl_varref"><span class="mpre">hooks</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_268_48_268_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_48_268_53&#39;)"><span class="hl_varref"><span class="mpre">certs</span></span></a><span class="mpre">)
            </span><span class="hl_comment"><span class="mpre">-- Call application callback to see whether the</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- certificate chain is acceptable.</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
            </span><a name="loc_274_13_274_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_13_274_18&#39;)"><span class="hl_vardecl"><span class="mpre">usage</span></span></a><span class="mpre"> &lt;- </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Util.html#loc_81_1_81_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Util.html#loc_81_1_81_15&#39;)"><span class="hl_varref"><span class="mpre">catchException</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Parameters.html#loc_208_7_208_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_208_7_208_26&#39;)"><span class="hl_varref"><span class="mpre">onClientCertificate</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Parameters.html#loc_90_7_90_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_90_7_90_18&#39;)"><span class="hl_varref"><span class="mpre">serverHooks</span></span></a><span class="mpre"> </span><a href="#loc_267_16_267_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_16_267_23&#39;)"><span class="hl_varref"><span class="mpre">sparams</span></span></a><span class="mpre">) </span><a href="#loc_268_48_268_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_48_268_53&#39;)"><span class="hl_varref"><span class="mpre">certs</span></span></a><span class="mpre">) </span><a href="Network.TLS.Handshake.Certificate.html#loc_31_1_31_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Certificate.html#loc_31_1_31_18&#39;)"><span class="hl_varref"><span class="mpre">rejectOnException</span></span></a><span class="mpre">
            case </span><a href="#loc_274_13_274_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_274_13_274_18&#39;)"><span class="hl_varref"><span class="mpre">usage</span></span></a><span class="mpre"> of
                </span><a href="Network.TLS.X509.html#loc_49_11_49_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.X509.html#loc_49_11_49_33&#39;)"><span class="hl_conref"><span class="mpre">CertificateUsageAccept</span></span></a><span class="mpre">        -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
                </span><a href="Network.TLS.X509.html#loc_50_11_50_33" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.X509.html#loc_50_11_50_33&#39;)"><span class="hl_conref"><span class="mpre">CertificateUsageReject</span></span></a><span class="mpre"> </span><a name="loc_277_40_277_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_277_40_277_46&#39;)"><span class="hl_vardecl"><span class="mpre">reason</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Handshake.Certificate.html#loc_21_1_21_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Certificate.html#loc_21_1_21_20&#39;)"><span class="hl_varref"><span class="mpre">certificateRejected</span></span></a><span class="mpre"> </span><a href="#loc_277_40_277_46" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_277_40_277_46&#39;)"><span class="hl_varref"><span class="mpre">reason</span></span></a><span class="mpre">

            </span><span class="hl_comment"><span class="mpre">-- Remember cert chain for later use.</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
            </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_151_1_151_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_151_1_151_19&#39;)"><span class="hl_varref"><span class="mpre">setClientCertChain</span></span></a><span class="mpre"> </span><a href="#loc_268_48_268_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_48_268_53&#39;)"><span class="hl_varref"><span class="mpre">certs</span></span></a><span class="mpre">

            </span><span class="hl_comment"><span class="mpre">-- FIXME: We should check whether the certificate</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- matches our request and that we support</span></span><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- verifying with that certificate.</span></span><span class="mpre">

            </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.Common.html#loc_91_7_91_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_91_7_91_25&#39;)"><span class="hl_conref"><span class="mpre">RecvStateHandshake</span></span></a><span class="mpre"> </span><a href="#loc_293_9_293_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_9_293_33&#39;)"><span class="hl_varref"><span class="mpre">processClientKeyExchange</span></span></a><span class="mpre">

        </span><a href="#loc_268_9_268_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_268_9_268_33&#39;)"><span class="hl_fundecl"><span class="mpre">processClientCertificate</span></span></a><span class="mpre"> </span><a name="loc_289_34_289_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_34_289_35&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> = </span><a href="#loc_293_9_293_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_9_293_33&#39;)"><span class="hl_varref"><span class="mpre">processClientKeyExchange</span></span></a><span class="mpre"> </span><a href="#loc_289_34_289_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_289_34_289_35&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">

        </span><span class="hl_comment"><span class="mpre">-- cannot use RecvStateHandshake, as the next message could be a ChangeCipher,</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- so we must process any packet, and in case of handshake call processHandshake manually.</span></span><span class="mpre">
        </span><a name="loc_293_9_293_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_9_293_33&#39;)"><span class="hl_fundecl"><span class="mpre">processClientKeyExchange</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_258_7_258_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_258_7_258_20&#39;)"><span class="hl_conref"><span class="mpre">ClientKeyXchg</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.Common.html#loc_90_7_90_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_90_7_90_20&#39;)"><span class="hl_conref"><span class="mpre">RecvStateNext</span></span></a><span class="mpre"> </span><a href="#loc_299_9_299_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_9_299_33&#39;)"><span class="hl_varref"><span class="mpre">processCertificateVerify</span></span></a><span class="mpre">
        </span><a href="#loc_293_9_293_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_293_9_293_33&#39;)"><span class="hl_fundecl"><span class="mpre">processClientKeyExchange</span></span></a><span class="mpre"> </span><a name="loc_294_34_294_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_294_34_294_35&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre">                 = </span><a href="Network.TLS.Handshake.Common.html#loc_46_1_46_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_46_1_46_11&#39;)"><span class="hl_varref"><span class="mpre">unexpected</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_294_34_294_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_294_34_294_35&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">) (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;client key exchange&quot;</span></span><span class="mpre">)

        </span><span class="hl_comment"><span class="mpre">-- Check whether the client correctly signed the handshake.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">-- If not, ask the application on how to proceed.</span></span><span class="mpre">
        </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
        </span><a name="loc_299_9_299_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_9_299_33&#39;)"><span class="hl_fundecl"><span class="mpre">processCertificateVerify</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_151_7_151_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_151_7_151_16&#39;)"><span class="hl_conref"><span class="mpre">Handshake</span></span></a><span class="mpre"> [</span><a name="loc_299_46_299_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_46_299_48&#39;)"><span class="hl_specname"><span class="mpre">hs</span></span></a><span class="mpre">@(</span><a href="Network.TLS.Struct.html#loc_261_7_261_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_261_7_261_17&#39;)"><span class="hl_conref"><span class="mpre">CertVerify</span></span></a><span class="mpre"> </span><a name="loc_299_61_299_65" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_61_299_65&#39;)"><span class="hl_specname"><span class="mpre">dsig</span></span></a><span class="mpre">@(</span><a href="Network.TLS.Struct.html#loc_109_24_109_39" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_109_24_109_39&#39;)"><span class="hl_conref"><span class="mpre">DigitallySigned</span></span></a><span class="mpre"> </span><a name="loc_299_83_299_92" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_83_299_92&#39;)"><span class="hl_vardecl"><span class="mpre">mbHashSig</span></span></a><span class="mpre"> _))]) = do
            </span><a href="Network.TLS.Handshake.Process.html#loc_34_1_34_17" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Process.html#loc_34_1_34_17&#39;)"><span class="hl_varref"><span class="mpre">processHandshake</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_299_46_299_48" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_46_299_48&#39;)"><span class="hl_varref"><span class="mpre">hs</span></span></a><span class="mpre">

            </span><a href="#loc_358_9_358_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_358_9_358_34&#39;)"><span class="hl_varref"><span class="mpre">checkValidClientCertChain</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;change cipher message expected&quot;</span></span><span class="mpre">

            </span><a name="loc_304_13_304_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_304_13_304_24&#39;)"><span class="hl_vardecl"><span class="mpre">usedVersion</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.State.html#loc_165_1_165_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_165_1_165_11&#39;)"><span class="hl_varref"><span class="mpre">getVersion</span></span></a><span class="mpre">
            </span><span class="hl_comment"><span class="mpre">-- Fetch all handshake messages up to now.</span></span><span class="mpre">
            </span><a name="loc_306_13_306_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_306_13_306_17&#39;)"><span class="hl_vardecl"><span class="mpre">msgs</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">B.concat</span></span><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_169_1_169_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_169_1_169_21&#39;)"><span class="hl_varref"><span class="mpre">getHandshakeMessages</span></span></a><span class="mpre">
            (</span><a name="loc_307_14_307_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_14_307_24&#39;)"><span class="hl_vardecl"><span class="mpre">hashMethod</span></span></a><span class="mpre">, </span><a name="loc_307_26_307_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_26_307_34&#39;)"><span class="hl_vardecl"><span class="mpre">toVerify</span></span></a><span class="mpre">) &lt;- </span><a href="Network.TLS.Handshake.Signature.html#loc_46_1_46_38" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Signature.html#loc_46_1_46_38&#39;)"><span class="hl_varref"><span class="mpre">prepareCertificateVerifySignatureData</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="#loc_304_13_304_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_304_13_304_24&#39;)"><span class="hl_varref"><span class="mpre">usedVersion</span></span></a><span class="mpre"> </span><a href="#loc_299_83_299_92" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_83_299_92&#39;)"><span class="hl_varref"><span class="mpre">mbHashSig</span></span></a><span class="mpre"> </span><a href="#loc_306_13_306_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_306_13_306_17&#39;)"><span class="hl_varref"><span class="mpre">msgs</span></span></a><span class="mpre">

            </span><span class="hl_comment"><span class="mpre">-- Verify the signature.</span></span><span class="mpre">
            </span><a name="loc_310_13_310_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_13_310_18&#39;)"><span class="hl_vardecl"><span class="mpre">verif</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Handshake.Signature.html#loc_98_1_98_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Signature.html#loc_98_1_98_29&#39;)"><span class="hl_varref"><span class="mpre">signatureVerifyWithHashDescr</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_99_7_99_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_99_7_99_19&#39;)"><span class="hl_conref"><span class="mpre">SignatureRSA</span></span></a><span class="mpre"> </span><a href="#loc_307_14_307_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_14_307_24&#39;)"><span class="hl_varref"><span class="mpre">hashMethod</span></span></a><span class="mpre"> </span><a href="#loc_307_26_307_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_307_26_307_34&#39;)"><span class="hl_varref"><span class="mpre">toVerify</span></span></a><span class="mpre"> </span><a href="#loc_299_61_299_65" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_61_299_65&#39;)"><span class="hl_varref"><span class="mpre">dsig</span></span></a><span class="mpre">

            case </span><a href="#loc_310_13_310_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_310_13_310_18&#39;)"><span class="hl_varref"><span class="mpre">verif</span></span></a><span class="mpre"> of
                </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre"> -&gt; do
                    </span><span class="hl_comment"><span class="mpre">-- When verification succeeds, commit the</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- client certificate chain to the context.</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
                    </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_317_26_317_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_26_317_31&#39;)"><span class="hl_vardecl"><span class="mpre">certs</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_154_1_154_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_154_1_154_19&#39;)"><span class="hl_varref"><span class="mpre">getClientCertChain</span></span></a><span class="mpre">
                    </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.State.html#loc_195_1_195_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_195_1_195_26&#39;)"><span class="hl_varref"><span class="mpre">setClientCertificateChain</span></span></a><span class="mpre"> </span><a href="#loc_317_26_317_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_317_26_317_31&#39;)"><span class="hl_varref"><span class="mpre">certs</span></span></a><span class="mpre">
                    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">

                </span><span class="hl_conref"><span class="mpre">False</span></span><span class="mpre"> -&gt; do
                    </span><span class="hl_comment"><span class="mpre">-- Either verification failed because of an</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- invalid format (with an error message), or</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- the signature is wrong.  In either case,</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- ask the application if it wants to</span></span><span class="mpre">
                    </span><span class="hl_comment"><span class="mpre">-- proceed, we will do that.</span></span><span class="mpre">
                    </span><a name="loc_327_21_327_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_327_21_327_24&#39;)"><span class="hl_vardecl"><span class="mpre">res</span></span></a><span class="mpre"> &lt;- </span><a href="Control.Monad.IO.Class.html#loc_32_5_32_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.IO.Class.html#loc_32_5_32_11&#39;)"><span class="hl_varref"><span class="mpre">liftIO</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Parameters.html#loc_214_7_214_29" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_214_7_214_29&#39;)"><span class="hl_varref"><span class="mpre">onUnverifiedClientCert</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Parameters.html#loc_90_7_90_18" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Parameters.html#loc_90_7_90_18&#39;)"><span class="hl_varref"><span class="mpre">serverHooks</span></span></a><span class="mpre"> </span><a href="#loc_267_16_267_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_16_267_23&#39;)"><span class="hl_varref"><span class="mpre">sparams</span></span></a><span class="mpre">)
                    if </span><a href="#loc_327_21_327_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_327_21_327_24&#39;)"><span class="hl_varref"><span class="mpre">res</span></span></a><span class="mpre">
                        then do
                            </span><span class="hl_comment"><span class="mpre">-- When verification fails, but the</span></span><span class="mpre">
                            </span><span class="hl_comment"><span class="mpre">-- application callbacks accepts, we</span></span><span class="mpre">
                            </span><span class="hl_comment"><span class="mpre">-- also commit the client certificate</span></span><span class="mpre">
                            </span><span class="hl_comment"><span class="mpre">-- chain to the context.</span></span><span class="mpre">
                            </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_334_34_334_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_334_34_334_39&#39;)"><span class="hl_vardecl"><span class="mpre">certs</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_154_1_154_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_154_1_154_19&#39;)"><span class="hl_varref"><span class="mpre">getClientCertChain</span></span></a><span class="mpre">
                            </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.State.html#loc_195_1_195_26" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_195_1_195_26&#39;)"><span class="hl_varref"><span class="mpre">setClientCertificateChain</span></span></a><span class="mpre"> </span><a href="#loc_334_34_334_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_334_34_334_39&#39;)"><span class="hl_varref"><span class="mpre">certs</span></span></a><span class="mpre">
                        else </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_123_7_123_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_123_7_123_21&#39;)"><span class="hl_conref"><span class="mpre">Error_Protocol</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;verification failed&quot;</span></span><span class="mpre">, </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">, </span><a href="Network.TLS.Struct.html#loc_189_7_189_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_189_7_189_21&#39;)"><span class="hl_conref"><span class="mpre">BadCertificate</span></span></a><span class="mpre">)
            </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.Common.html#loc_90_7_90_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_90_7_90_20&#39;)"><span class="hl_conref"><span class="mpre">RecvStateNext</span></span></a><span class="mpre"> </span><a href="#loc_347_9_347_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_347_9_347_27&#39;)"><span class="hl_varref"><span class="mpre">expectChangeCipher</span></span></a><span class="mpre">

        </span><a href="#loc_299_9_299_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_299_9_299_33&#39;)"><span class="hl_fundecl"><span class="mpre">processCertificateVerify</span></span></a><span class="mpre"> </span><a name="loc_339_34_339_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_34_339_35&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre"> = do
            </span><a name="loc_340_13_340_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_340_13_340_18&#39;)"><span class="hl_vardecl"><span class="mpre">chain</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_154_1_154_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_154_1_154_19&#39;)"><span class="hl_varref"><span class="mpre">getClientCertChain</span></span></a><span class="mpre">
            case </span><a href="#loc_340_13_340_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_340_13_340_18&#39;)"><span class="hl_varref"><span class="mpre">chain</span></span></a><span class="mpre"> of
                </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_342_22_342_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_342_22_342_24&#39;)"><span class="hl_vardecl"><span class="mpre">cc</span></span></a><span class="mpre"> | </span><a href="Network.TLS.X509.html#loc_33_1_33_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.X509.html#loc_33_1_33_23&#39;)"><span class="hl_varref"><span class="mpre">isNullCertificateChain</span></span></a><span class="mpre"> </span><a href="#loc_342_22_342_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_342_22_342_24&#39;)"><span class="hl_varref"><span class="mpre">cc</span></span></a><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
                        | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                 -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_123_7_123_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_123_7_123_21&#39;)"><span class="hl_conref"><span class="mpre">Error_Protocol</span></span></a><span class="mpre"> (</span><span class="hl_string"><span class="mpre">&quot;cert verify message missing&quot;</span></span><span class="mpre">, </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">, </span><a href="Network.TLS.Struct.html#loc_183_7_183_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_183_7_183_24&#39;)"><span class="hl_conref"><span class="mpre">UnexpectedMessage</span></span></a><span class="mpre">)
                </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">
            </span><a href="#loc_347_9_347_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_347_9_347_27&#39;)"><span class="hl_varref"><span class="mpre">expectChangeCipher</span></span></a><span class="mpre"> </span><a href="#loc_339_34_339_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_339_34_339_35&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">

        </span><a name="loc_347_9_347_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_347_9_347_27&#39;)"><span class="hl_fundecl"><span class="mpre">expectChangeCipher</span></span></a><span class="mpre"> </span><a href="Network.TLS.Struct.html#loc_153_7_153_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_153_7_153_23&#39;)"><span class="hl_conref"><span class="mpre">ChangeCipherSpec</span></span></a><span class="mpre"> = do
            </span><a name="loc_348_13_348_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_348_13_348_16&#39;)"><span class="hl_vardecl"><span class="mpre">npn</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_183_1_183_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_183_1_183_12&#39;)"><span class="hl_varref"><span class="mpre">usingState_</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><a href="Network.TLS.State.html#loc_180_1_180_16" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.State.html#loc_180_1_180_16&#39;)"><span class="hl_varref"><span class="mpre">getExtensionNPN</span></span></a><span class="mpre">
            </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.Common.html#loc_91_7_91_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_91_7_91_25&#39;)"><span class="hl_conref"><span class="mpre">RecvStateHandshake</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> if </span><a href="#loc_348_13_348_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_348_13_348_16&#39;)"><span class="hl_varref"><span class="mpre">npn</span></span></a><span class="mpre"> then </span><a href="#loc_352_9_352_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_9_352_18&#39;)"><span class="hl_varref"><span class="mpre">expectNPN</span></span></a><span class="mpre"> else </span><a href="#loc_355_9_355_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_355_9_355_21&#39;)"><span class="hl_varref"><span class="mpre">expectFinish</span></span></a><span class="mpre">
        </span><a href="#loc_347_9_347_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_347_9_347_27&#39;)"><span class="hl_fundecl"><span class="mpre">expectChangeCipher</span></span></a><span class="mpre"> </span><a name="loc_350_28_350_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_350_28_350_29&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre">                = </span><a href="Network.TLS.Handshake.Common.html#loc_46_1_46_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_46_1_46_11&#39;)"><span class="hl_varref"><span class="mpre">unexpected</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_350_28_350_29" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_350_28_350_29&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">) (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;change cipher&quot;</span></span><span class="mpre">)

        </span><a name="loc_352_9_352_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_9_352_18&#39;)"><span class="hl_fundecl"><span class="mpre">expectNPN</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_263_7_263_32" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_263_7_263_32&#39;)"><span class="hl_conref"><span class="mpre">HsNextProtocolNegotiation</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.Common.html#loc_91_7_91_25" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_91_7_91_25&#39;)"><span class="hl_conref"><span class="mpre">RecvStateHandshake</span></span></a><span class="mpre"> </span><a href="#loc_355_9_355_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_355_9_355_21&#39;)"><span class="hl_varref"><span class="mpre">expectFinish</span></span></a><span class="mpre">
        </span><a href="#loc_352_9_352_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_352_9_352_18&#39;)"><span class="hl_fundecl"><span class="mpre">expectNPN</span></span></a><span class="mpre"> </span><a name="loc_353_19_353_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_353_19_353_20&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre">                             = </span><a href="Network.TLS.Handshake.Common.html#loc_46_1_46_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_46_1_46_11&#39;)"><span class="hl_varref"><span class="mpre">unexpected</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_353_19_353_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_353_19_353_20&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">) (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;Handshake NextProtocolNegotiation&quot;</span></span><span class="mpre">)

        </span><a name="loc_355_9_355_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_355_9_355_21&#39;)"><span class="hl_fundecl"><span class="mpre">expectFinish</span></span></a><span class="mpre"> (</span><a href="Network.TLS.Struct.html#loc_262_7_262_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_262_7_262_15&#39;)"><span class="hl_conref"><span class="mpre">Finished</span></span></a><span class="mpre"> _) = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.Common.html#loc_92_7_92_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_92_7_92_20&#39;)"><span class="hl_conref"><span class="mpre">RecvStateDone</span></span></a><span class="mpre">
        </span><a href="#loc_355_9_355_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_355_9_355_21&#39;)"><span class="hl_fundecl"><span class="mpre">expectFinish</span></span></a><span class="mpre"> </span><a name="loc_356_22_356_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_356_22_356_23&#39;)"><span class="hl_vardecl"><span class="mpre">p</span></span></a><span class="mpre">            = </span><a href="Network.TLS.Handshake.Common.html#loc_46_1_46_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.Common.html#loc_46_1_46_11&#39;)"><span class="hl_varref"><span class="mpre">unexpected</span></span></a><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_356_22_356_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_356_22_356_23&#39;)"><span class="hl_varref"><span class="mpre">p</span></span></a><span class="mpre">) (</span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;Handshake Finished&quot;</span></span><span class="mpre">)

        </span><a name="loc_358_9_358_34" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_358_9_358_34&#39;)"><span class="hl_fundecl"><span class="mpre">checkValidClientCertChain</span></span></a><span class="mpre"> </span><a name="loc_358_35_358_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_358_35_358_38&#39;)"><span class="hl_vardecl"><span class="mpre">msg</span></span></a><span class="mpre"> = do
            </span><a name="loc_359_13_359_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_359_13_359_18&#39;)"><span class="hl_vardecl"><span class="mpre">chain</span></span></a><span class="mpre"> &lt;- </span><a href="Network.TLS.Context.Internal.html#loc_186_1_186_12" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_186_1_186_12&#39;)"><span class="hl_varref"><span class="mpre">usingHState</span></span></a><span class="mpre"> </span><a href="#loc_267_24_267_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_267_24_267_27&#39;)"><span class="hl_varref"><span class="mpre">ctx</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Network.TLS.Handshake.State.html#loc_154_1_154_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Handshake.State.html#loc_154_1_154_19&#39;)"><span class="hl_varref"><span class="mpre">getClientCertChain</span></span></a><span class="mpre">
            let </span><a name="loc_360_17_360_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_360_17_360_27&#39;)"><span class="hl_vardecl"><span class="mpre">throwerror</span></span></a><span class="mpre"> = </span><a href="Network.TLS.Struct.html#loc_123_7_123_21" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_123_7_123_21&#39;)"><span class="hl_conref"><span class="mpre">Error_Protocol</span></span></a><span class="mpre"> (</span><a href="#loc_358_35_358_38" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_358_35_358_38&#39;)"><span class="hl_varref"><span class="mpre">msg</span></span></a><span class="mpre"> , </span><span class="hl_conref"><span class="mpre">True</span></span><span class="mpre">, </span><a href="Network.TLS.Struct.html#loc_183_7_183_24" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Struct.html#loc_183_7_183_24&#39;)"><span class="hl_conref"><span class="mpre">UnexpectedMessage</span></span></a><span class="mpre">)
            case </span><a href="#loc_359_13_359_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_359_13_359_18&#39;)"><span class="hl_varref"><span class="mpre">chain</span></span></a><span class="mpre"> of
                </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><a href="#loc_360_17_360_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_360_17_360_27&#39;)"><span class="hl_varref"><span class="mpre">throwerror</span></span></a><span class="mpre">
                </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a name="loc_363_22_363_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_363_22_363_24&#39;)"><span class="hl_vardecl"><span class="mpre">cc</span></span></a><span class="mpre"> | </span><a href="Network.TLS.X509.html#loc_33_1_33_23" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.X509.html#loc_33_1_33_23&#39;)"><span class="hl_varref"><span class="mpre">isNullCertificateChain</span></span></a><span class="mpre"> </span><a href="#loc_363_22_363_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_363_22_363_24&#39;)"><span class="hl_varref"><span class="mpre">cc</span></span></a><span class="mpre"> -&gt; </span><a href="Network.TLS.Context.Internal.html#loc_167_1_167_10" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Context.Internal.html#loc_167_1_167_10&#39;)"><span class="hl_varref"><span class="mpre">throwCore</span></span></a><span class="mpre"> </span><a href="#loc_360_17_360_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_360_17_360_27&#39;)"><span class="hl_varref"><span class="mpre">throwerror</span></span></a><span class="mpre">
                        | </span><span class="hl_varref"><span class="mpre">otherwise</span></span><span class="mpre">                 -&gt; </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">

</span><a href="#loc_367_1_367_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_1_367_23&#39;)"><span class="mpre">findHighestVersionFrom</span></a><span class="mpre"> :: </span><a href="Network.TLS.Types.html#loc_25_6_25_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_25_6_25_13&#39;)"><span class="hl_tyconref"><span class="mpre">Version</span></span></a><span class="mpre"> -&gt; [</span><a href="Network.TLS.Types.html#loc_25_6_25_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_25_6_25_13&#39;)"><span class="hl_tyconref"><span class="mpre">Version</span></span></a><span class="mpre">] -&gt; </span><span class="hl_tyconref"><span class="mpre">Maybe</span></span><span class="mpre"> </span><a href="Network.TLS.Types.html#loc_25_6_25_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.TLS.Types.html#loc_25_6_25_13&#39;)"><span class="hl_tyconref"><span class="mpre">Version</span></span></a><span class="mpre">
</span><a name="loc_367_1_367_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_1_367_23&#39;)"><span class="hl_fundecl"><span class="mpre">findHighestVersionFrom</span></span></a><span class="mpre"> </span><a name="loc_367_24_367_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_24_367_37&#39;)"><span class="hl_vardecl"><span class="mpre">clientVersion</span></span></a><span class="mpre"> </span><a name="loc_367_38_367_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_38_367_53&#39;)"><span class="hl_vardecl"><span class="mpre">allowedVersions</span></span></a><span class="mpre"> =
    case </span><span class="hl_varref"><span class="mpre">filter</span></span><span class="mpre"> (</span><a href="#loc_367_24_367_37" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_24_367_37&#39;)"><span class="hl_varref"><span class="mpre">clientVersion</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;=</span></span><span class="mpre">) </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">reverse</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Data.List.html#loc_810_1_810_7" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.List.html#loc_810_1_810_7&#39;)"><span class="hl_varref"><span class="mpre">sortBy</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">compare</span></span><span class="mpre"> </span><a href="#loc_367_38_367_53" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_367_38_367_53&#39;)"><span class="hl_varref"><span class="mpre">allowedVersions</span></span></a><span class="mpre"> of
        []  -&gt; </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre">
        </span><a name="loc_370_9_370_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_370_9_370_10&#39;)"><span class="hl_vardecl"><span class="mpre">v</span></span></a><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre">_ -&gt; </span><span class="hl_conref"><span class="mpre">Just</span></span><span class="mpre"> </span><a href="#loc_370_9_370_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_370_9_370_10&#39;)"><span class="hl_varref"><span class="mpre">v</span></span></a><span class="mpre">
</span></div></body></html>