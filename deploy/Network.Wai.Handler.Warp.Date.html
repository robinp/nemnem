<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE CPP #-}

module Network.Wai.Handler.Warp.Date (
    withDateCache
  , getDate
  , DateCache
  , GMTDate
  ) where

import Control.Applicative
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Date.hs&quot;, srcSpanStartLine = 11, srcSpanStartColumn = 8, srcSpanEndLine = 11, srcSpanEndColumn = 26}, srcInfoPoints = []}) &quot;Control.Concurrent&quot;"><span class="mpre">Control.Concurrent</span></span><span class="mpre">
import Control.Exception
import Control.Monad
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Date.hs&quot;, srcSpanStartLine = 14, srcSpanStartColumn = 8, srcSpanEndLine = 14, srcSpanEndColumn = 29}, srcInfoPoints = []}) &quot;Data.ByteString.Char8&quot;"><span class="mpre">Data.ByteString.Char8</span></span><span class="mpre">
import Data.IORef

#if WINDOWS
import Data.Time
import System.Locale
#else
import Network.HTTP.Date
import System.Posix (epochTime)
#endif

</span><span class="hl_comment"><span class="mpre">-- | The type of the Date header value.</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Date.hs&quot;, srcSpanStartLine = 26, srcSpanStartColumn = 1, srcSpanEndLine = 26, srcSpanEndColumn = 26}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Date.hs&quot;, srcSpanStartLine = 26, srcSpanStartColumn = 1, srcSpanEndLine = 26, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/War"><span class="mpre">type GMTDate = ByteString</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | The type of the cache of the Date header value.</span></span><span class="mpre">
data </span><a name="loc_29_6_29_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_6_29_15&#39;)"><span class="hl_tycondecl"><span class="mpre">DateCache</span></span></a><span class="mpre"> = </span><a name="loc_29_18_29_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_18_29_27&#39;)"><span class="hl_condecl"><span class="mpre">DateCache</span></span></a><span class="mpre"> (</span><a href="GHC.IORef.html#loc_34_9_34_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_34_9_34_14&#39;)"><span class="hl_tyconref"><span class="mpre">IORef</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">GMTDate</span></span><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Creating &#39;DateCache&#39; and executing the action.</span></span><span class="mpre">
</span><a href="#loc_33_1_33_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_33_1_33_14&#39;)"><span class="mpre">withDateCache</span></a><span class="mpre"> :: (</span><a href="#loc_29_6_29_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_6_29_15&#39;)"><span class="hl_tyconref"><span class="mpre">DateCache</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">) -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_33_1_33_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_33_1_33_14&#39;)"><span class="hl_fundecl"><span class="mpre">withDateCache</span></span></a><span class="mpre"> </span><a name="loc_33_15_33_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_33_15_33_21&#39;)"><span class="hl_vardecl"><span class="mpre">action</span></span></a><span class="mpre"> = </span><a href="Control.Exception.Base.html#loc_259_1_259_8" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_259_1_259_8&#39;)"><span class="hl_varref"><span class="mpre">bracket</span></span></a><span class="mpre"> </span><a href="#loc_38_1_38_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_1_38_11&#39;)"><span class="hl_varref"><span class="mpre">initialize</span></span></a><span class="mpre">
                               (\(</span><a name="loc_34_35_34_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_34_35_34_36&#39;)"><span class="hl_vardecl"><span class="mpre">t</span></span></a><span class="mpre">,_) -&gt; </span><span class="hl_varref"><span class="mpre">killThread</span></span><span class="mpre"> </span><a href="#loc_34_35_34_36" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_34_35_34_36&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre">)
                               (\(_,</span><a name="loc_35_37_35_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_37_35_39&#39;)"><span class="hl_vardecl"><span class="mpre">dc</span></span></a><span class="mpre">) -&gt; </span><a href="#loc_33_15_33_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_33_15_33_21&#39;)"><span class="hl_varref"><span class="mpre">action</span></span></a><span class="mpre"> </span><a href="#loc_35_37_35_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_35_37_35_39&#39;)"><span class="hl_varref"><span class="mpre">dc</span></span></a><span class="mpre">)

</span><a href="#loc_38_1_38_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_1_38_11&#39;)"><span class="mpre">initialize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">ThreadId</span></span><span class="mpre">, </span><a href="#loc_29_6_29_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_6_29_15&#39;)"><span class="hl_tyconref"><span class="mpre">DateCache</span></span></a><span class="mpre">)
</span><a name="loc_38_1_38_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_38_1_38_11&#39;)"><span class="hl_vardecl"><span class="mpre">initialize</span></span></a><span class="mpre"> = do
    </span><a name="loc_39_5_39_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_5_39_7&#39;)"><span class="hl_vardecl"><span class="mpre">dc</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_29_18_29_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_18_29_27&#39;)"><span class="hl_conref"><span class="mpre">DateCache</span></span></a><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> (</span><a href="#loc_54_1_54_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_1_54_18&#39;)"><span class="hl_varref"><span class="mpre">getCurrentGMTDate</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="GHC.IORef.html#loc_42_1_42_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_42_1_42_9&#39;)"><span class="hl_varref"><span class="mpre">newIORef</span></span></a><span class="mpre">)
    </span><a name="loc_40_5_40_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_40_5_40_6&#39;)"><span class="hl_vardecl"><span class="mpre">t</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">forkIO</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="Control.Monad.html#loc_189_1_189_8" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Monad.html#loc_189_1_189_8&#39;)"><span class="hl_varref"><span class="mpre">forever</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
        </span><span class="hl_varref"><span class="mpre">threadDelay</span></span><span class="mpre"> </span><span class="hl_num"><span class="mpre">1000000</span></span><span class="mpre">
        </span><a href="#loc_50_1_50_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_1_50_7&#39;)"><span class="hl_varref"><span class="mpre">update</span></span></a><span class="mpre"> </span><a href="#loc_39_5_39_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_5_39_7&#39;)"><span class="hl_varref"><span class="mpre">dc</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> (</span><a href="#loc_40_5_40_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_40_5_40_6&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre">, </span><a href="#loc_39_5_39_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_39_5_39_7&#39;)"><span class="hl_varref"><span class="mpre">dc</span></span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">-- | Getting &#39;GMTDate&#39; based on &#39;DateCache&#39;.</span></span><span class="mpre">
</span><a href="#loc_47_1_47_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_1_47_8&#39;)"><span class="mpre">getDate</span></a><span class="mpre"> :: </span><a href="#loc_29_6_29_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_6_29_15&#39;)"><span class="hl_tyconref"><span class="mpre">DateCache</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">GMTDate</span></span><span class="mpre">
</span><a name="loc_47_1_47_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_1_47_8&#39;)"><span class="hl_fundecl"><span class="mpre">getDate</span></span></a><span class="mpre"> (</span><a href="#loc_29_18_29_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_18_29_27&#39;)"><span class="hl_conref"><span class="mpre">DateCache</span></span></a><span class="mpre"> </span><a name="loc_47_20_47_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_20_47_23&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre">) = </span><a href="GHC.IORef.html#loc_46_1_46_10" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_46_1_46_10&#39;)"><span class="hl_varref"><span class="mpre">readIORef</span></span></a><span class="mpre"> </span><a href="#loc_47_20_47_23" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_47_20_47_23&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre">

</span><a href="#loc_50_1_50_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_1_50_7&#39;)"><span class="mpre">update</span></a><span class="mpre"> :: </span><a href="#loc_29_6_29_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_6_29_15&#39;)"><span class="hl_tyconref"><span class="mpre">DateCache</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_50_1_50_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_1_50_7&#39;)"><span class="hl_fundecl"><span class="mpre">update</span></span></a><span class="mpre"> (</span><a href="#loc_29_18_29_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_29_18_29_27&#39;)"><span class="hl_conref"><span class="mpre">DateCache</span></span></a><span class="mpre"> </span><a name="loc_50_19_50_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_19_50_22&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre">) = </span><a href="#loc_54_1_54_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_1_54_18&#39;)"><span class="hl_varref"><span class="mpre">getCurrentGMTDate</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_50_19_50_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_50_19_50_22&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre">

</span><a href="#loc_54_1_54_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_1_54_18&#39;)"><span class="mpre">getCurrentGMTDate</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">GMTDate</span></span><span class="mpre">
#ifdef WINDOWS
</span><a name="loc_54_1_54_18" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_54_1_54_18&#39;)"><span class="hl_vardecl"><span class="mpre">getCurrentGMTDate</span></span></a><span class="mpre"> = </span><a href="#loc_56_5_56_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_56_5_56_15&#39;)"><span class="hl_varref"><span class="mpre">formatDate</span></span></a><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">getCurrentTime</span></span><span class="mpre">
  where
    </span><a name="loc_56_5_56_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_56_5_56_15&#39;)"><span class="hl_vardecl"><span class="mpre">formatDate</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">pack</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Data.Time.Format.html#loc_150_1_150_11" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Time.Format.html#loc_150_1_150_11&#39;)"><span class="hl_varref"><span class="mpre">formatTime</span></span></a><span class="mpre"> </span><a href="System.Locale.html#loc_50_1_50_18" onmouseover="nemnem.highlightLocalToRemote(&#39;System.Locale.html#loc_50_1_50_18&#39;)"><span class="hl_varref"><span class="mpre">defaultTimeLocale</span></span></a><span class="mpre"> </span><span class="hl_string"><span class="mpre">&quot;%a, %d %b %Y %H:%M:%S GMT&quot;</span></span><span class="mpre">
#else
</span><span class="hl_vardecl"><span class="mpre">getCurrentGMTDate</span></span><span class="mpre"> = </span><a href="Network.HTTP.Date.Formatter.html#loc_21_1_21_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.HTTP.Date.Formatter.html#loc_21_1_21_15&#39;)"><span class="hl_varref"><span class="mpre">formatHTTPDate</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><a href="Network.HTTP.Date.Converter.html#loc_18_1_18_20" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.HTTP.Date.Converter.html#loc_18_1_18_20&#39;)"><span class="hl_varref"><span class="mpre">epochTimeToHTTPDate</span></span></a><span class="mpre"> </span><a href="Data.Functor.html#loc_32_1_32_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Functor.html#loc_32_1_32_6&#39;)"><span class="hl_infix"><span class="mpre">&lt;$&gt;</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">epochTime</span></span><span class="mpre">
#endif
</span></div></body></html>