<html><head><title>NemNem</title><link rel="stylesheet" type="text/css" href="/static/nemnem.css"><script src="/static/jquery-2.0.3.min.js"></script><script src="/static/nemnem.js"></script></head><body><div id="code"><span class="mpre">{-# LANGUAGE CPP #-}
{-# LANGUAGE BangPatterns #-}
{-# LANGUAGE DeriveDataTypeable #-}
{-# LANGUAGE UnboxedTuples, MagicHash #-}

</span><span class="hl_comment"><span class="mpre">-- |</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- In order to provide slowloris protection, Warp provides timeout handlers. We</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- follow these rules:</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * A timeout is created when a connection is opened.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * When all request headers are read, the timeout is tickled.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * Every time at least 2048 bytes of the request body are read, the timeout</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   is tickled.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * The timeout is paused while executing user code. This will apply to both</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   the application itself, and a ResponseSource response. The timeout is</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   resumed as soon as we return from user code.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- * Every time data is successfully sent to the client, the timeout is tickled.</span></span><span class="mpre">

module Network.Wai.Handler.Warp.Timeout (
  </span><span class="hl_comment"><span class="mpre">-- * Types</span></span><span class="mpre">
    Manager
  , TimeoutAction
  , Handle
  </span><span class="hl_comment"><span class="mpre">-- * Manager</span></span><span class="mpre">
  , initialize
  , stopManager
  , withManager
  </span><span class="hl_comment"><span class="mpre">-- * Registration</span></span><span class="mpre">
  , register
  , registerKillThread
  </span><span class="hl_comment"><span class="mpre">-- * Control</span></span><span class="mpre">
  , tickle
  , cancel
  , pause
  , resume
  </span><span class="hl_comment"><span class="mpre">-- * Exceptions</span></span><span class="mpre">
  , TimeoutThread (..)
  ) where

#if MIN_VERSION_base(4,6,0)
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Timeout.hs&quot;, srcSpanStartLine = 46, srcSpanStartColumn = 8, srcSpanEndLine = 46, srcSpanEndColumn = 26}, srcInfoPoints = []}) &quot;Control.Concurrent&quot;"><span class="mpre">Control.Concurrent</span></span><span class="mpre"> (mkWeakThreadId, ThreadId)
#else
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Timeout.hs&quot;, srcSpanStartLine = 48, srcSpanStartColumn = 8, srcSpanEndLine = 48, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Conc&quot;"><span class="mpre">GHC.Conc</span></span><span class="mpre"> (ThreadId(..))
import GHC.Exts (</span><a href="GHC.Prim.html#loc_2691_1_2691_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Prim.html#loc_2691_1_2691_8&#39;)"><span class="mpre">mkWeak#</span></a><span class="mpre">)
import GHC.IO (IO (IO))
#endif
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Timeout.hs&quot;, srcSpanStartLine = 52, srcSpanStartColumn = 8, srcSpanEndLine = 52, srcSpanEndColumn = 26}, srcInfoPoints = []}) &quot;Control.Concurrent&quot;"><span class="mpre">Control.Concurrent</span></span><span class="mpre"> (threadDelay, myThreadId)
import qualified Control.Exception as E
import </span><span class="warning" data-warning="Module not foundModuleName (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Timeout.hs&quot;, srcSpanStartLine = 54, srcSpanStartColumn = 8, srcSpanEndLine = 54, srcSpanEndColumn = 16}, srcInfoPoints = []}) &quot;GHC.Weak&quot;"><span class="mpre">GHC.Weak</span></span><span class="mpre"> (Weak (..))
import Network.Wai.Handler.Warp.IORef (</span><a href="GHC.IORef.html#loc_34_9_34_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_34_9_34_14&#39;)"><span class="mpre">IORef</span></a><span class="mpre">)
import qualified Network.Wai.Handler.Warp.IORef as I
import Network.Wai.Handler.Warp.Thread
import System.Mem.Weak (deRefWeak)
import Data.Typeable (</span><a href="Data.Typeable.Internal.html#loc_196_7_196_15" onmouseover="nemnem.highlightLocalToRemote(&#39;Data.Typeable.Internal.html#loc_196_7_196_15&#39;)"><span class="mpre">Typeable</span></a><span class="mpre">)

</span><span class="hl_comment"><span class="mpre">----------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A timeout manager</span></span><span class="mpre">
newtype </span><a name="loc_64_9_64_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_9_64_16&#39;)"><span class="hl_tycondecl"><span class="mpre">Manager</span></span></a><span class="mpre"> = </span><a name="loc_64_19_64_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_19_64_26&#39;)"><span class="hl_condecl"><span class="mpre">Manager</span></span></a><span class="mpre"> (</span><a href="GHC.IORef.html#loc_34_9_34_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_34_9_34_14&#39;)"><span class="hl_tyconref"><span class="mpre">IORef</span></span></a><span class="mpre"> [</span><a href="#loc_70_6_70_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_6_70_12&#39;)"><span class="hl_tyconref"><span class="mpre">Handle</span></span></a><span class="mpre">])

</span><span class="hl_comment"><span class="mpre">-- | An action to be performed on timeout.</span></span><span class="mpre">
</span><span class="warning" data-warning="DeclTypeDecl (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Timeout.hs&quot;, srcSpanStartLine = 67, srcSpanStartColumn = 1, srcSpanEndLine = 67, srcSpanEndColumn = 27}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Timeout.hs&quot;, srcSpanStartLine = 67, srcSpanStartColumn = 1, srcSpanEndLine = 67, srcSpanEndColumn = 5},SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handl"><span class="mpre">type TimeoutAction = IO ()</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | A handle used by &#39;Manager&#39;</span></span><span class="mpre">
data </span><a name="loc_70_6_70_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_6_70_12&#39;)"><span class="hl_tycondecl"><span class="mpre">Handle</span></span></a><span class="mpre"> = </span><a name="loc_70_15_70_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_21&#39;)"><span class="hl_condecl"><span class="mpre">Handle</span></span></a><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">TimeoutAction</span></span><span class="mpre"> (</span><a href="GHC.IORef.html#loc_34_9_34_14" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_34_9_34_14&#39;)"><span class="hl_tyconref"><span class="mpre">IORef</span></span></a><span class="mpre"> </span><a href="#loc_72_6_72_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_6_72_11&#39;)"><span class="hl_tyconref"><span class="mpre">State</span></span></a><span class="mpre">)

data </span><a name="loc_72_6_72_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_6_72_11&#39;)"><span class="hl_tycondecl"><span class="mpre">State</span></span></a><span class="mpre"> = </span><a name="loc_72_14_72_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_14_72_20&#39;)"><span class="hl_condecl"><span class="mpre">Active</span></span></a><span class="mpre">    </span><span class="hl_comment"><span class="mpre">-- Manager turns it to Inactive.</span></span><span class="mpre">
           | </span><a name="loc_73_14_73_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_14_73_22&#39;)"><span class="hl_condecl"><span class="mpre">Inactive</span></span></a><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- Manager removes it with timeout action.</span></span><span class="mpre">
           | </span><a name="loc_74_14_74_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_14_74_20&#39;)"><span class="hl_condecl"><span class="mpre">Paused</span></span></a><span class="mpre">    </span><span class="hl_comment"><span class="mpre">-- Manager does not change it.</span></span><span class="mpre">
           | </span><a name="loc_75_14_75_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_14_75_22&#39;)"><span class="hl_condecl"><span class="mpre">Canceled</span></span></a><span class="mpre">  </span><span class="hl_comment"><span class="mpre">-- Manager removes it without timeout action.</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">----------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Creating timeout manager which works every N micro seconds</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   where N is the first argument.</span></span><span class="mpre">
</span><a href="#loc_82_1_82_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_11&#39;)"><span class="mpre">initialize</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_64_9_64_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_9_64_16&#39;)"><span class="hl_tyconref"><span class="mpre">Manager</span></span></a><span class="mpre">
</span><a name="loc_82_1_82_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_11&#39;)"><span class="hl_fundecl"><span class="mpre">initialize</span></span></a><span class="mpre"> </span><a name="loc_82_12_82_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_12_82_19&#39;)"><span class="hl_vardecl"><span class="mpre">timeout</span></span></a><span class="mpre"> = do
    </span><a name="loc_83_5_83_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_5_83_9&#39;)"><span class="hl_vardecl"><span class="mpre">ref&#39;</span></span></a><span class="mpre"> &lt;- </span><a href="Network.Wai.Handler.Warp.Thread.html#loc_19_1_19_27" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Handler.Warp.Thread.html#loc_19_1_19_27&#39;)"><span class="hl_varref"><span class="mpre">forkIOwithBreakableForever</span></span></a><span class="mpre"> [] </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_83_46_83_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_46_83_49&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre"> -&gt; do
        </span><span class="hl_varref"><span class="mpre">threadDelay</span></span><span class="mpre"> </span><a href="#loc_82_12_82_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_12_82_19&#39;)"><span class="hl_varref"><span class="mpre">timeout</span></span></a><span class="mpre">
        </span><a name="loc_85_9_85_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_9_85_12&#39;)"><span class="hl_vardecl"><span class="mpre">old</span></span></a><span class="mpre"> &lt;- </span><a href="Network.Wai.Handler.Warp.IORef.html#loc_16_1_16_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Handler.Warp.IORef.html#loc_16_1_16_19&#39;)"><span class="hl_varref"><span class="mpre">I.atomicModifyIORef&#39;</span></span></a><span class="mpre"> </span><a href="#loc_83_46_83_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_46_83_49&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre"> (\</span><a name="loc_85_43_85_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_43_85_44&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> -&gt; ([], </span><a href="#loc_85_43_85_44" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_43_85_44&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">))
        </span><a name="loc_86_9_86_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_14&#39;)"><span class="hl_vardecl"><span class="mpre">merge</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_90_5_90_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_5_90_10&#39;)"><span class="hl_varref"><span class="mpre">prune</span></span></a><span class="mpre"> </span><a href="#loc_85_9_85_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_85_9_85_12&#39;)"><span class="hl_varref"><span class="mpre">old</span></span></a><span class="mpre"> </span><span class="hl_varref"><span class="mpre">id</span></span><span class="mpre">
        </span><a href="Network.Wai.Handler.Warp.IORef.html#loc_16_1_16_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Handler.Warp.IORef.html#loc_16_1_16_19&#39;)"><span class="hl_varref"><span class="mpre">I.atomicModifyIORef&#39;</span></span></a><span class="mpre"> </span><a href="#loc_83_46_83_49" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_46_83_49&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre"> (\</span><a name="loc_87_36_87_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_36_87_39&#39;)"><span class="hl_vardecl"><span class="mpre">new</span></span></a><span class="mpre"> -&gt; (</span><a href="#loc_86_9_86_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_86_9_86_14&#39;)"><span class="hl_varref"><span class="mpre">merge</span></span></a><span class="mpre"> </span><a href="#loc_87_36_87_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_87_36_87_39&#39;)"><span class="hl_varref"><span class="mpre">new</span></span></a><span class="mpre">, </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">))
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_64_19_64_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_19_64_26&#39;)"><span class="hl_conref"><span class="mpre">Manager</span></span></a><span class="mpre"> </span><a href="#loc_83_5_83_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_83_5_83_9&#39;)"><span class="hl_varref"><span class="mpre">ref&#39;</span></span></a><span class="mpre">
  where
    </span><a name="loc_90_5_90_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_5_90_10&#39;)"><span class="hl_fundecl"><span class="mpre">prune</span></span></a><span class="mpre"> [] </span><a name="loc_90_14_90_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_14_90_19&#39;)"><span class="hl_vardecl"><span class="mpre">front</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_90_14_90_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_14_90_19&#39;)"><span class="hl_varref"><span class="mpre">front</span></span></a><span class="mpre">
    </span><a href="#loc_90_5_90_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_5_90_10&#39;)"><span class="hl_fundecl"><span class="mpre">prune</span></span></a><span class="mpre"> (</span><a name="loc_91_12_91_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_12_91_13&#39;)"><span class="hl_specname"><span class="mpre">m</span></span></a><span class="mpre">@(</span><a href="#loc_70_15_70_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_21&#39;)"><span class="hl_conref"><span class="mpre">Handle</span></span></a><span class="mpre"> </span><a name="loc_91_22_91_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_22_91_31&#39;)"><span class="hl_vardecl"><span class="mpre">onTimeout</span></span></a><span class="mpre"> </span><a name="loc_91_32_91_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_32_91_39&#39;)"><span class="hl_vardecl"><span class="mpre">iactive</span></span></a><span class="mpre">)</span><span class="hl_infix"><span class="mpre">:</span></span><a name="loc_91_41_91_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_41_91_45&#39;)"><span class="hl_vardecl"><span class="mpre">rest</span></span></a><span class="mpre">) </span><a name="loc_91_47_91_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_47_91_52&#39;)"><span class="hl_vardecl"><span class="mpre">front</span></span></a><span class="mpre"> = do
        </span><a name="loc_92_9_92_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_9_92_14&#39;)"><span class="hl_vardecl"><span class="mpre">state</span></span></a><span class="mpre"> &lt;- </span><a href="Network.Wai.Handler.Warp.IORef.html#loc_16_1_16_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Handler.Warp.IORef.html#loc_16_1_16_19&#39;)"><span class="hl_varref"><span class="mpre">I.atomicModifyIORef&#39;</span></span></a><span class="mpre"> </span><a href="#loc_91_32_91_39" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_32_91_39&#39;)"><span class="hl_varref"><span class="mpre">iactive</span></span></a><span class="mpre"> (\</span><a name="loc_92_49_92_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_49_92_50&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> -&gt; (</span><a href="#loc_99_5_99_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_5_99_15&#39;)"><span class="hl_varref"><span class="mpre">inactivate</span></span></a><span class="mpre"> </span><a href="#loc_92_49_92_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_49_92_50&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">, </span><a href="#loc_92_49_92_50" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_49_92_50&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">))
        case </span><a href="#loc_92_9_92_14" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_92_9_92_14&#39;)"><span class="hl_varref"><span class="mpre">state</span></span></a><span class="mpre"> of
            </span><a href="#loc_73_14_73_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_14_73_22&#39;)"><span class="hl_conref"><span class="mpre">Inactive</span></span></a><span class="mpre"> -&gt; do
                </span><a href="#loc_91_22_91_31" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_22_91_31&#39;)"><span class="hl_varref"><span class="mpre">onTimeout</span></span></a><span class="mpre"> </span><a href="Control.Exception.Base.html#loc_150_1_150_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_150_1_150_6&#39;)"><span class="hl_infix"><span class="mpre">`E.catch`</span></span></a><span class="mpre"> </span><a href="#loc_113_1_113_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_10&#39;)"><span class="hl_varref"><span class="mpre">ignoreAll</span></span></a><span class="mpre">
                </span><a href="#loc_90_5_90_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_5_90_10&#39;)"><span class="hl_varref"><span class="mpre">prune</span></span></a><span class="mpre"> </span><a href="#loc_91_41_91_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_41_91_45&#39;)"><span class="hl_varref"><span class="mpre">rest</span></span></a><span class="mpre"> </span><a href="#loc_91_47_91_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_47_91_52&#39;)"><span class="hl_varref"><span class="mpre">front</span></span></a><span class="mpre">
            </span><a href="#loc_75_14_75_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_14_75_22&#39;)"><span class="hl_conref"><span class="mpre">Canceled</span></span></a><span class="mpre"> -&gt; </span><a href="#loc_90_5_90_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_5_90_10&#39;)"><span class="hl_varref"><span class="mpre">prune</span></span></a><span class="mpre"> </span><a href="#loc_91_41_91_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_41_91_45&#39;)"><span class="hl_varref"><span class="mpre">rest</span></span></a><span class="mpre"> </span><a href="#loc_91_47_91_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_47_91_52&#39;)"><span class="hl_varref"><span class="mpre">front</span></span></a><span class="mpre">
            _        -&gt; </span><a href="#loc_90_5_90_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_90_5_90_10&#39;)"><span class="hl_varref"><span class="mpre">prune</span></span></a><span class="mpre"> </span><a href="#loc_91_41_91_45" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_41_91_45&#39;)"><span class="hl_varref"><span class="mpre">rest</span></span></a><span class="mpre"> (</span><a href="#loc_91_47_91_52" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_47_91_52&#39;)"><span class="hl_varref"><span class="mpre">front</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">.</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">(:)</span></span><span class="mpre"> </span><a href="#loc_91_12_91_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_91_12_91_13&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre">)
    </span><a name="loc_99_5_99_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_5_99_15&#39;)"><span class="hl_fundecl"><span class="mpre">inactivate</span></span></a><span class="mpre"> </span><a href="#loc_72_14_72_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_14_72_20&#39;)"><span class="hl_conref"><span class="mpre">Active</span></span></a><span class="mpre"> = </span><a href="#loc_73_14_73_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_73_14_73_22&#39;)"><span class="hl_conref"><span class="mpre">Inactive</span></span></a><span class="mpre">
    </span><a href="#loc_99_5_99_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_99_5_99_15&#39;)"><span class="hl_fundecl"><span class="mpre">inactivate</span></span></a><span class="mpre"> </span><a name="loc_100_16_100_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_100_16_100_17&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> = </span><a href="#loc_100_16_100_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_100_16_100_17&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">----------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Stopping timeout manager.</span></span><span class="mpre">
</span><a href="#loc_106_1_106_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_1_106_12&#39;)"><span class="mpre">stopManager</span></a><span class="mpre"> :: </span><a href="#loc_64_9_64_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_9_64_16&#39;)"><span class="hl_tyconref"><span class="mpre">Manager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_106_1_106_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_1_106_12&#39;)"><span class="hl_fundecl"><span class="mpre">stopManager</span></span></a><span class="mpre"> (</span><a href="#loc_64_19_64_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_19_64_26&#39;)"><span class="hl_conref"><span class="mpre">Manager</span></span></a><span class="mpre"> </span><a name="loc_106_22_106_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_22_106_25&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre">) = </span><a href="GHC.IO.html#loc_426_1_426_6" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IO.html#loc_426_1_426_6&#39;)"><span class="hl_varref"><span class="mpre">E.mask_</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> do
    !</span><a name="loc_107_6_107_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_107_6_107_13&#39;)"><span class="hl_vardecl"><span class="mpre">handles</span></span></a><span class="mpre"> &lt;- </span><a href="Network.Wai.Handler.Warp.Thread.html#loc_28_1_28_13" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Handler.Warp.Thread.html#loc_28_1_28_13&#39;)"><span class="hl_varref"><span class="mpre">breakForever</span></span></a><span class="mpre"> </span><a href="#loc_106_22_106_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_106_22_106_25&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre">
    </span><span class="hl_varref"><span class="mpre">mapM_</span></span><span class="mpre"> </span><a href="#loc_110_5_110_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_5_110_9&#39;)"><span class="hl_varref"><span class="mpre">fire</span></span></a><span class="mpre"> </span><a href="#loc_107_6_107_13" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_107_6_107_13&#39;)"><span class="hl_varref"><span class="mpre">handles</span></span></a><span class="mpre">
  where
    </span><a name="loc_110_5_110_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_5_110_9&#39;)"><span class="hl_fundecl"><span class="mpre">fire</span></span></a><span class="mpre"> (</span><a href="#loc_70_15_70_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_21&#39;)"><span class="hl_conref"><span class="mpre">Handle</span></span></a><span class="mpre"> </span><a name="loc_110_18_110_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_18_110_27&#39;)"><span class="hl_vardecl"><span class="mpre">onTimeout</span></span></a><span class="mpre"> _) = </span><a href="#loc_110_18_110_27" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_110_18_110_27&#39;)"><span class="hl_varref"><span class="mpre">onTimeout</span></span></a><span class="mpre"> </span><a href="Control.Exception.Base.html#loc_150_1_150_6" onmouseover="nemnem.highlightLocalToRemote(&#39;Control.Exception.Base.html#loc_150_1_150_6&#39;)"><span class="hl_infix"><span class="mpre">`E.catch`</span></span></a><span class="mpre"> </span><a href="#loc_113_1_113_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_10&#39;)"><span class="hl_varref"><span class="mpre">ignoreAll</span></span></a><span class="mpre">

</span><a href="#loc_113_1_113_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_10&#39;)"><span class="mpre">ignoreAll</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">E.SomeException</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_113_1_113_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_113_1_113_10&#39;)"><span class="hl_fundecl"><span class="mpre">ignoreAll</span></span></a><span class="mpre"> _ = </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">----------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Registering a timeout action.</span></span><span class="mpre">
</span><a href="#loc_119_1_119_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_9&#39;)"><span class="mpre">register</span></a><span class="mpre"> :: </span><a href="#loc_64_9_64_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_9_64_16&#39;)"><span class="hl_tyconref"><span class="mpre">Manager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">TimeoutAction</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_70_6_70_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_6_70_12&#39;)"><span class="hl_tyconref"><span class="mpre">Handle</span></span></a><span class="mpre">
</span><a name="loc_119_1_119_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_9&#39;)"><span class="hl_fundecl"><span class="mpre">register</span></span></a><span class="mpre"> (</span><a href="#loc_64_19_64_26" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_19_64_26&#39;)"><span class="hl_conref"><span class="mpre">Manager</span></span></a><span class="mpre"> </span><a name="loc_119_19_119_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_19_119_22&#39;)"><span class="hl_vardecl"><span class="mpre">ref</span></span></a><span class="mpre">) </span><a name="loc_119_24_119_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_24_119_33&#39;)"><span class="hl_vardecl"><span class="mpre">onTimeout</span></span></a><span class="mpre"> = do
    </span><a name="loc_120_5_120_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_5_120_12&#39;)"><span class="hl_vardecl"><span class="mpre">iactive</span></span></a><span class="mpre"> &lt;- </span><a href="GHC.IORef.html#loc_42_1_42_9" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_42_1_42_9&#39;)"><span class="hl_varref"><span class="mpre">I.newIORef</span></span></a><span class="mpre"> </span><a href="#loc_72_14_72_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_14_72_20&#39;)"><span class="hl_conref"><span class="mpre">Active</span></span></a><span class="mpre">
    let </span><a name="loc_121_9_121_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_9_121_10&#39;)"><span class="hl_vardecl"><span class="mpre">h</span></span></a><span class="mpre"> = </span><a href="#loc_70_15_70_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_21&#39;)"><span class="hl_conref"><span class="mpre">Handle</span></span></a><span class="mpre"> </span><a href="#loc_119_24_119_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_24_119_33&#39;)"><span class="hl_varref"><span class="mpre">onTimeout</span></span></a><span class="mpre"> </span><a href="#loc_120_5_120_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_120_5_120_12&#39;)"><span class="hl_varref"><span class="mpre">iactive</span></span></a><span class="mpre">
    </span><a href="Network.Wai.Handler.Warp.IORef.html#loc_16_1_16_19" onmouseover="nemnem.highlightLocalToRemote(&#39;Network.Wai.Handler.Warp.IORef.html#loc_16_1_16_19&#39;)"><span class="hl_varref"><span class="mpre">I.atomicModifyIORef&#39;</span></span></a><span class="mpre"> </span><a href="#loc_119_19_119_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_19_119_22&#39;)"><span class="hl_varref"><span class="mpre">ref</span></span></a><span class="mpre"> (\</span><a name="loc_122_32_122_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_32_122_33&#39;)"><span class="hl_vardecl"><span class="mpre">x</span></span></a><span class="mpre"> -&gt; (</span><a href="#loc_121_9_121_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_9_121_10&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">:</span></span><span class="mpre"> </span><a href="#loc_122_32_122_33" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_122_32_122_33&#39;)"><span class="hl_varref"><span class="mpre">x</span></span></a><span class="mpre">, </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">))
    </span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><a href="#loc_121_9_121_10" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_121_9_121_10&#39;)"><span class="hl_varref"><span class="mpre">h</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Registering a timeout action of killing this thread.</span></span><span class="mpre">
</span><a href="#loc_127_1_127_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_19&#39;)"><span class="mpre">registerKillThread</span></a><span class="mpre"> :: </span><a href="#loc_64_9_64_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_9_64_16&#39;)"><span class="hl_tyconref"><span class="mpre">Manager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><a href="#loc_70_6_70_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_6_70_12&#39;)"><span class="hl_tyconref"><span class="mpre">Handle</span></span></a><span class="mpre">
</span><a name="loc_127_1_127_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_1_127_19&#39;)"><span class="hl_fundecl"><span class="mpre">registerKillThread</span></span></a><span class="mpre"> </span><a name="loc_127_20_127_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_20_127_21&#39;)"><span class="hl_vardecl"><span class="mpre">m</span></span></a><span class="mpre"> = do
    </span><a name="loc_128_5_128_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_128_5_128_9&#39;)"><span class="hl_vardecl"><span class="mpre">wtid</span></span></a><span class="mpre"> &lt;- </span><span class="hl_varref"><span class="mpre">myThreadId</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><a href="#loc_147_1_147_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_1_147_15&#39;)"><span class="hl_varref"><span class="mpre">mkWeakThreadId</span></span></a><span class="mpre">
    </span><a href="#loc_119_1_119_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_119_1_119_9&#39;)"><span class="hl_varref"><span class="mpre">register</span></span></a><span class="mpre"> </span><a href="#loc_127_20_127_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_127_20_127_21&#39;)"><span class="hl_varref"><span class="mpre">m</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> </span><a href="#loc_137_1_137_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_1_137_12&#39;)"><span class="hl_varref"><span class="mpre">killIfExist</span></span></a><span class="mpre"> </span><a href="#loc_128_5_128_9" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_128_5_128_9&#39;)"><span class="hl_varref"><span class="mpre">wtid</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- If ThreadId is hold referred by a strong reference,</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- it leaks even after the thread is killed.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- So, let&#39;s use a weak reference so that CG can throw ThreadId away.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- deRefWeak checks if ThreadId referenced by the weak reference</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">-- exists. If exists, it means that the thread is alive.</span></span><span class="mpre">
</span><a href="#loc_137_1_137_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_1_137_12&#39;)"><span class="mpre">killIfExist</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Weak</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ThreadId</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">TimeoutAction</span></span><span class="mpre">
</span><a name="loc_137_1_137_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_1_137_12&#39;)"><span class="hl_fundecl"><span class="mpre">killIfExist</span></span></a><span class="mpre"> </span><a name="loc_137_13_137_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_13_137_17&#39;)"><span class="hl_vardecl"><span class="mpre">wtid</span></span></a><span class="mpre"> = </span><span class="hl_varref"><span class="mpre">deRefWeak</span></span><span class="mpre"> </span><a href="#loc_137_13_137_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_137_13_137_17&#39;)"><span class="hl_varref"><span class="mpre">wtid</span></span></a><span class="mpre"> </span><span class="hl_infix"><span class="mpre">&gt;&gt;=</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">maybe</span></span><span class="mpre"> (</span><span class="hl_varref"><span class="mpre">return</span></span><span class="mpre"> </span><span class="hl_conref"><span class="mpre">()</span></span><span class="mpre">) (</span><span class="hl_varref"><span class="mpre">flip</span></span><span class="mpre"> </span><span class="hl_varref"><span class="mpre">E.throwTo</span></span><span class="mpre"> </span><a href="#loc_139_22_139_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_22_139_35&#39;)"><span class="hl_conref"><span class="mpre">TimeoutThread</span></span></a><span class="mpre">)

data </span><a name="loc_139_6_139_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_6_139_19&#39;)"><span class="hl_tycondecl"><span class="mpre">TimeoutThread</span></span></a><span class="mpre"> = </span><a name="loc_139_22_139_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_22_139_35&#39;)"><span class="hl_condecl"><span class="mpre">TimeoutThread</span></span></a><span class="mpre">
    </span><span class="warning" data-warning="DataDecl DerivingsDeriving (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Timeout.hs&quot;, srcSpanStartLine = 140, srcSpanStartColumn = 5, srcSpanEndLine = 140, srcSpanEndColumn = 22}, srcInfoPoints = [SrcSpan {srcSpanFilename = &quot;/home/vagrant/nemnem/pull/warp-3.0.0.3/Network/Wai/Handler/Warp/Timeout.hs&quot;, srcSpanStartLine = 140, srcSpanStartColumn = 5, srcSpanEndLine = 140, srcSpanEndColumn = 13}]}) [IHead (SrcSpanInfo {srcInfoSpan = SrcSpan {srcSpanFilename = &quot;/home/vagrant"><span class="mpre">deriving Typeable</span></span><span class="mpre">
instance </span><span class="hl_classref"><span class="mpre">E.Exception</span></span><span class="mpre"> </span><a href="#loc_139_6_139_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_6_139_19&#39;)"><span class="hl_tyconref"><span class="mpre">TimeoutThread</span></span></a><span class="mpre">
instance </span><span class="hl_classref"><span class="mpre">Show</span></span><span class="mpre"> </span><a href="#loc_139_6_139_19" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_6_139_19&#39;)"><span class="hl_tyconref"><span class="mpre">TimeoutThread</span></span></a><span class="mpre"> where
    </span><span class="hl_fundecl"><span class="mpre">show</span></span><span class="mpre"> </span><a href="#loc_139_22_139_35" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_139_22_139_35&#39;)"><span class="hl_conref"><span class="mpre">TimeoutThread</span></span></a><span class="mpre"> = </span><span class="hl_string"><span class="mpre">&quot;Thread killed by Warp&#39;s timeout reaper&quot;</span></span><span class="mpre">

#if !MIN_VERSION_base(4,6,0)
</span><a href="#loc_147_1_147_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_1_147_15&#39;)"><span class="mpre">mkWeakThreadId</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">ThreadId</span></span><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> (</span><span class="hl_tyconref"><span class="mpre">Weak</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">ThreadId</span></span><span class="mpre">)
</span><a name="loc_147_1_147_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_1_147_15&#39;)"><span class="hl_fundecl"><span class="mpre">mkWeakThreadId</span></span></a><span class="mpre"> </span><a name="loc_147_16_147_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_16_147_17&#39;)"><span class="hl_specname"><span class="mpre">t</span></span></a><span class="mpre">@(</span><span class="hl_conref"><span class="mpre">ThreadId</span></span><span class="mpre"> </span><a name="loc_147_28_147_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_28_147_30&#39;)"><span class="hl_vardecl"><span class="mpre">t#</span></span></a><span class="mpre">) = </span><span class="hl_conref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_infix"><span class="mpre">$</span></span><span class="mpre"> \</span><a name="loc_147_40_147_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_40_147_41&#39;)"><span class="hl_vardecl"><span class="mpre">s</span></span></a><span class="mpre"> -&gt;
   case </span><a href="GHC.Prim.html#loc_2691_1_2691_8" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.Prim.html#loc_2691_1_2691_8&#39;)"><span class="hl_varref"><span class="mpre">mkWeak#</span></span></a><span class="mpre"> </span><a href="#loc_147_28_147_30" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_28_147_30&#39;)"><span class="hl_varref"><span class="mpre">t#</span></span></a><span class="mpre"> </span><a href="#loc_147_16_147_17" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_16_147_17&#39;)"><span class="hl_varref"><span class="mpre">t</span></span></a><span class="mpre"> </span><span class="hl_conref"><span class="mpre">Nothing</span></span><span class="mpre"> </span><a href="#loc_147_40_147_41" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_147_40_147_41&#39;)"><span class="hl_varref"><span class="mpre">s</span></span></a><span class="mpre"> of
      (# </span><a name="loc_149_10_149_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_10_149_12&#39;)"><span class="hl_vardecl"><span class="mpre">s1</span></span></a><span class="mpre">, </span><a name="loc_149_14_149_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_14_149_15&#39;)"><span class="hl_vardecl"><span class="mpre">w</span></span></a><span class="mpre"> #) -&gt; (# </span><a href="#loc_149_10_149_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_10_149_12&#39;)"><span class="hl_varref"><span class="mpre">s1</span></span></a><span class="mpre">, </span><span class="hl_conref"><span class="mpre">Weak</span></span><span class="mpre"> </span><a href="#loc_149_14_149_15" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_149_14_149_15&#39;)"><span class="hl_varref"><span class="mpre">w</span></span></a><span class="mpre"> #)
#endif

</span><span class="hl_comment"><span class="mpre">----------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Setting the state to active.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;Manager&#39; turns active to inactive repeatedly.</span></span><span class="mpre">
</span><a href="#loc_157_1_157_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_1_157_7&#39;)"><span class="mpre">tickle</span></a><span class="mpre"> :: </span><a href="#loc_70_6_70_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_6_70_12&#39;)"><span class="hl_tyconref"><span class="mpre">Handle</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_157_1_157_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_1_157_7&#39;)"><span class="hl_fundecl"><span class="mpre">tickle</span></span></a><span class="mpre"> (</span><a href="#loc_70_15_70_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_21&#39;)"><span class="hl_conref"><span class="mpre">Handle</span></span></a><span class="mpre"> _ </span><a name="loc_157_18_157_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_18_157_25&#39;)"><span class="hl_vardecl"><span class="mpre">iactive</span></span></a><span class="mpre">) = </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">I.writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_157_18_157_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_18_157_25&#39;)"><span class="hl_varref"><span class="mpre">iactive</span></span></a><span class="mpre"> </span><a href="#loc_72_14_72_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_72_14_72_20&#39;)"><span class="hl_conref"><span class="mpre">Active</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Setting the state to canceled.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;Manager&#39; eventually removes this without timeout action.</span></span><span class="mpre">
</span><a href="#loc_162_1_162_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_1_162_7&#39;)"><span class="mpre">cancel</span></a><span class="mpre"> :: </span><a href="#loc_70_6_70_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_6_70_12&#39;)"><span class="hl_tyconref"><span class="mpre">Handle</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_162_1_162_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_1_162_7&#39;)"><span class="hl_fundecl"><span class="mpre">cancel</span></span></a><span class="mpre"> (</span><a href="#loc_70_15_70_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_21&#39;)"><span class="hl_conref"><span class="mpre">Handle</span></span></a><span class="mpre"> _ </span><a name="loc_162_18_162_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_18_162_25&#39;)"><span class="hl_vardecl"><span class="mpre">iactive</span></span></a><span class="mpre">) = </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">I.writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_162_18_162_25" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_162_18_162_25&#39;)"><span class="hl_varref"><span class="mpre">iactive</span></span></a><span class="mpre"> </span><a href="#loc_75_14_75_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_75_14_75_22&#39;)"><span class="hl_conref"><span class="mpre">Canceled</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Setting the state to paused.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   &#39;Manager&#39; does not change the value.</span></span><span class="mpre">
</span><a href="#loc_167_1_167_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_1_167_6&#39;)"><span class="mpre">pause</span></a><span class="mpre"> :: </span><a href="#loc_70_6_70_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_6_70_12&#39;)"><span class="hl_tyconref"><span class="mpre">Handle</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_167_1_167_6" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_1_167_6&#39;)"><span class="hl_fundecl"><span class="mpre">pause</span></span></a><span class="mpre"> (</span><a href="#loc_70_15_70_21" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_15_70_21&#39;)"><span class="hl_conref"><span class="mpre">Handle</span></span></a><span class="mpre"> _ </span><a name="loc_167_17_167_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_17_167_24&#39;)"><span class="hl_vardecl"><span class="mpre">iactive</span></span></a><span class="mpre">) = </span><a href="GHC.IORef.html#loc_50_1_50_11" onmouseover="nemnem.highlightLocalToRemote(&#39;GHC.IORef.html#loc_50_1_50_11&#39;)"><span class="hl_varref"><span class="mpre">I.writeIORef</span></span></a><span class="mpre"> </span><a href="#loc_167_17_167_24" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_167_17_167_24&#39;)"><span class="hl_varref"><span class="mpre">iactive</span></span></a><span class="mpre"> </span><a href="#loc_74_14_74_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_74_14_74_20&#39;)"><span class="hl_conref"><span class="mpre">Paused</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Setting the paused state to active.</span></span><span class="mpre">
</span><span class="hl_comment"><span class="mpre">--   This is an alias to &#39;tickle&#39;.</span></span><span class="mpre">
</span><a href="#loc_172_1_172_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_1_172_7&#39;)"><span class="mpre">resume</span></a><span class="mpre"> :: </span><a href="#loc_70_6_70_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_70_6_70_12&#39;)"><span class="hl_tyconref"><span class="mpre">Handle</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyconref"><span class="mpre">()</span></span><span class="mpre">
</span><a name="loc_172_1_172_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_172_1_172_7&#39;)"><span class="hl_vardecl"><span class="mpre">resume</span></span></a><span class="mpre"> = </span><a href="#loc_157_1_157_7" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_157_1_157_7&#39;)"><span class="hl_varref"><span class="mpre">tickle</span></span></a><span class="mpre">

</span><span class="hl_comment"><span class="mpre">----------------------------------------------------------------</span></span><span class="mpre">

</span><span class="hl_comment"><span class="mpre">-- | Call the inner function with a timeout manager.</span></span><span class="mpre">
</span><a href="#loc_180_1_180_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_1_180_12&#39;)"><span class="mpre">withManager</span></a><span class="mpre"> :: </span><span class="hl_tyconref"><span class="mpre">Int</span></span><span class="mpre"> </span><span class="hl_comment"><span class="mpre">-- ^ timeout in microseconds</span></span><span class="mpre">
            -&gt; (</span><a href="#loc_64_9_64_16" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_64_9_64_16&#39;)"><span class="hl_tyconref"><span class="mpre">Manager</span></span></a><span class="mpre"> -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">)
            -&gt; </span><span class="hl_tyconref"><span class="mpre">IO</span></span><span class="mpre"> </span><span class="hl_tyvar"><span class="mpre">a</span></span><span class="mpre">
</span><a name="loc_180_1_180_12" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_1_180_12&#39;)"><span class="hl_fundecl"><span class="mpre">withManager</span></span></a><span class="mpre"> </span><a name="loc_180_13_180_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_13_180_20&#39;)"><span class="hl_vardecl"><span class="mpre">timeout</span></span></a><span class="mpre"> </span><a name="loc_180_21_180_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_21_180_22&#39;)"><span class="hl_vardecl"><span class="mpre">f</span></span></a><span class="mpre"> = do
    </span><span class="hl_comment"><span class="mpre">-- FIXME when stopManager is available, use it</span></span><span class="mpre">
    </span><a name="loc_182_5_182_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_5_182_8&#39;)"><span class="hl_vardecl"><span class="mpre">man</span></span></a><span class="mpre"> &lt;- </span><a href="#loc_82_1_82_11" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_82_1_82_11&#39;)"><span class="hl_varref"><span class="mpre">initialize</span></span></a><span class="mpre"> </span><a href="#loc_180_13_180_20" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_13_180_20&#39;)"><span class="hl_varref"><span class="mpre">timeout</span></span></a><span class="mpre">
    </span><a href="#loc_180_21_180_22" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_180_21_180_22&#39;)"><span class="hl_varref"><span class="mpre">f</span></span></a><span class="mpre"> </span><a href="#loc_182_5_182_8" onmouseover="nemnem.highlightLocalToLocal(&#39;loc_182_5_182_8&#39;)"><span class="hl_varref"><span class="mpre">man</span></span></a><span class="mpre">
</span></div></body></html>